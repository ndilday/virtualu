<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OSE.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>OSE.CPP</h1><a href="OSE_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">// Filename    : OSE.CPP</span>
00002 <span class="comment">// Description : Sound Effect Controller</span>
00003 <span class="comment">// Owner       : Gilbert</span>
00004 
00005 <span class="preprocessor">#include &lt;<a class="code" href="OSE_8H.html">OSE.H</a>&gt;</span>
00006 <span class="preprocessor">#include &lt;OAUDIO.H&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="OGAMESET_8H.html">OGAMESET.H</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;OMISC.H&gt;</span>
00009 <span class="preprocessor">#include &lt;OCONFIG.H&gt;</span>
00010 
<a name="l00011"></a><a class="code" href="OSE_8CPP.html#a0">00011</a> <span class="preprocessor">#define MIN_AUDIO_VOL 10</span>
00012 <span class="preprocessor"></span>
00013 <span class="comment">// ------ Begin Function SERequest::add_request -------//</span>
<a name="l00014"></a><a class="code" href="structSERequest.html#a0">00014</a> <span class="keywordtype">void</span> <a class="code" href="structSERequest.html#a0">SERequest::add_request</a>(<a class="code" href="classRelVolume.html">RelVolume</a> relVolume) {
00015     <span class="keywordflow">if</span>( <a class="code" href="structSERequest.html#m2">req_used</a> &lt; <a class="code" href="OSE_8H.html#a1">MAX_SE_STORE</a>) {
00016         <a class="code" href="structSERequest.html#m3">play_vol</a>[<a class="code" href="structSERequest.html#m2">req_used</a>] = relVolume;
00017         <a class="code" href="structSERequest.html#m2">req_used</a>++;
00018     }
00019     <span class="keywordflow">else</span> {
00020         <span class="comment">// not enough space, remove the min volume one.</span>
00021         <a class="code" href="classRelVolume.html">RelVolume</a> minVolume = relVolume;
00022         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="OSE_8H.html#a1">MAX_SE_STORE</a>; ++i) {
00023             <span class="keywordflow">if</span>( <a class="code" href="structSERequest.html#m3">play_vol</a>[i].<a class="code" href="classRelVolume.html#m0">rel_vol</a> &lt; minVolume.<a class="code" href="classRelVolume.html#m0">rel_vol</a>) {
00024                 <a class="code" href="classRelVolume.html">RelVolume</a> temp;
00025                 <span class="comment">// swap volume[i] and minVolume</span>
00026                 temp = <a class="code" href="structSERequest.html#m3">play_vol</a>[i];
00027                 <a class="code" href="structSERequest.html#m3">play_vol</a>[i] = minVolume;
00028                 minVolume = temp;
00029             }
00030         }
00031     }
00032 }
00033 
00034 <span class="comment">// ------ End Function SERequest::add_request -------//</span>
00035 
00036 <span class="comment">// ------ Begin Function SERequest::max_entry -------//</span>
<a name="l00037"></a><a class="code" href="structSERequest.html#a1">00037</a> <span class="keywordtype">int</span> <a class="code" href="structSERequest.html#a1">SERequest::max_entry</a>() {
00038     <a class="code" href="ALL_8H.html#a0">err_when</a>( <a class="code" href="structSERequest.html#m2">req_used</a> &lt;= 0);
00039 
00040     <span class="keywordtype">int</span> maxEntry = 0;
00041     <a class="code" href="classRelVolume.html">RelVolume</a> *maxVolume = &amp;<a class="code" href="structSERequest.html#m3">play_vol</a>[maxEntry];
00042     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 1; i &lt; <a class="code" href="structSERequest.html#m2">req_used</a>; ++i) {
00043         <span class="keywordflow">if</span>( maxVolume-&gt;<a class="code" href="classRelVolume.html#m0">rel_vol</a> &lt; play_vol[i].<a class="code" href="classRelVolume.html#m0">rel_vol</a>) {
00044             maxVolume = &amp;play_vol[i];
00045             maxEntry = i;
00046         }
00047     }
00048 
00049     <span class="keywordflow">return</span> maxEntry;
00050 }
00051 
00052 <span class="comment">// ------ End Function SERequest::max_entry -------//</span>
00053 
00054 <span class="comment">// ------ Begin Function SERequest::remove_request -------//</span>
<a name="l00055"></a><a class="code" href="structSERequest.html#a2">00055</a> <span class="keywordtype">void</span> <a class="code" href="structSERequest.html#a2">SERequest::remove_request</a>(<span class="keywordtype">int</span> slot) {
00056     <span class="keywordflow">if</span>( slot &gt;= <a class="code" href="structSERequest.html#m2">req_used</a> || slot &lt; 0)
00057         <span class="keywordflow">return</span>;
00058 
00059     <span class="comment">// ---- move element after slot -----/</span>
00060     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = slot+1; i &lt; <a class="code" href="structSERequest.html#m2">req_used</a>; ++i) {
00061         <a class="code" href="structSERequest.html#m3">play_vol</a>[i-1] = <a class="code" href="structSERequest.html#m3">play_vol</a>[i];
00062     }
00063     <a class="code" href="structSERequest.html#m2">req_used</a>--;
00064 }
00065 
00066 <span class="comment">// ------ End Function SERequest::remove_request -------//</span>
00067 
00068 <span class="comment">// ------ Begin Function SERequest::clear_request -------//</span>
<a name="l00069"></a><a class="code" href="structSERequest.html#a3">00069</a> <span class="keywordtype">void</span> <a class="code" href="structSERequest.html#a3">SERequest::clear_request</a>() {
00070     <a class="code" href="structSERequest.html#m2">req_used</a> = 0;
00071 }
00072 
00073 <span class="comment">// ------ End Function SERequest::clear_request -------//</span>
00074 
00075 <span class="comment">// ------ Begin Function SECtrl::SECtrl -------//</span>
<a name="l00076"></a><a class="code" href="classSECtrl.html#a0">00076</a> <a class="code" href="classSECtrl.html#a0">SECtrl::SECtrl</a>(<a class="code" href="classAudio.html">Audio</a> *audioPtr) : audio_ptr(audioPtr), res_supp(audioPtr-&gt;wav_res) {
00077     <a class="code" href="classSECtrl.html#m0">init_flag</a> = 0;
00078     <a class="code" href="classSECtrl.html#m1">audio_flag</a> = 0;
00079     req_pool = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00080     last_cycle = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00081     <a class="code" href="classSECtrl.html#m2">max_sound_effect</a> = 0;
00082     <a class="code" href="classSECtrl.html#m3">max_supp_effect</a> = 0;
00083     <a class="code" href="classSECtrl.html#m4">total_effect</a> = 0;
00084     biased_se = 0;
00085 }
00086 
00087 <span class="comment">// ------ End Function SECtrl::SECtrl -------//</span>
00088 
00089 <span class="comment">// ------ Begin Function SECtrl::~SECtrl ------//</span>
<a name="l00090"></a><a class="code" href="classSECtrl.html#a1">00090</a> <a class="code" href="classSECtrl.html#a1">SECtrl::~SECtrl</a>() {
00091     <a class="code" href="classSECtrl.html#a3">deinit</a>();
00092 }
00093 
00094 <span class="comment">// ------ End Function SECtrl::~SECtrl ------//</span>
00095 
00096 <span class="comment">// ------ Begin Function SECtrl::init -------//</span>
<a name="l00097"></a><a class="code" href="classSECtrl.html#a2">00097</a> <span class="keywordtype">void</span> <a class="code" href="classSECtrl.html#a2">SECtrl::init</a>() {
00098     <a class="code" href="classSECtrl.html#a3">deinit</a>();
00099 
00100     <a class="code" href="classSECtrl.html#m1">audio_flag</a> = <a class="code" href="classSECtrl.html#m5">audio_ptr</a>-&gt;<a class="code" href="classAudio.html#m2">wav_init_flag</a>;
00101     <span class="keywordflow">if</span>( !<a class="code" href="classSECtrl.html#m1">audio_flag</a> ) {
00102         <a class="code" href="classSECtrl.html#m0">init_flag</a> = 1;
00103         <span class="keywordflow">return</span>;
00104     }
00105 
00106     <span class="comment">//----- open wave resource file -------//</span>
00107 
00108     <a class="code" href="classString.html">String</a> str;
00109 
00110     str  = <a class="code" href="Gamedef_8h.html#a4">DIR_RES</a>;
00111     str += <span class="stringliteral">"A_WAVE1.RES"</span>;
00112 
00113     <a class="code" href="classSECtrl.html#m6">res_wave</a>.<a class="code" href="classResourceIdx.html#a3">init</a>(str,1);                           <span class="comment">// 1-read all into buffer</span>
00114 
00115     <span class="comment">//------- load database information --------//</span>
00116 
00117     load_info();
00118 
00119     <span class="comment">// ----- clear last_cycle array and wave_ptr --------//</span>
00120     <a class="code" href="classSECtrl.html#m0">init_flag</a> = 1;
00121     <a class="code" href="classSECtrl.html#a7">clear</a>();
00122 }
00123 
00124 <span class="comment">// ------ End Function SECtrl::init -------//</span>
00125 
00126 <span class="comment">// ------ Begin Function SECtrl::deinit -------//</span>
<a name="l00127"></a><a class="code" href="classSECtrl.html#a3">00127</a> <span class="keywordtype">void</span> <a class="code" href="classSECtrl.html#a3">SECtrl::deinit</a>() {
00128     <span class="keywordflow">if</span>( init_flag ) {
00129         <a class="code" href="classSECtrl.html#m0">init_flag</a> = 0;
00130         <span class="keywordflow">if</span>( audio_flag ) {
00131             <a class="code" href="ALL_8H.html#a8">mem_del</a>(req_pool);
00132             <a class="code" href="ALL_8H.html#a8">mem_del</a>(last_cycle);
00133         }
00134     }
00135 }
00136 
00137 <span class="comment">// ------ End Function SECtrl::deinit -------//</span>
00138 
00139 <span class="comment">// ------ Begin Function SECtrl::load_info -------//</span>
00140 <span class="keywordtype">void</span> SECtrl::load_info() {
00141     <span class="keywordtype">int</span> count = <a class="code" href="classSECtrl.html#m2">max_sound_effect</a> = <a class="code" href="classSECtrl.html#m6">res_wave</a>.<a class="code" href="classResourceIdx.html#m6">rec_count</a>;
00142     <span class="keywordtype">int</span> suppCount = <a class="code" href="classSECtrl.html#m3">max_supp_effect</a> = <a class="code" href="classSECtrl.html#m7">res_supp</a>.<a class="code" href="classResourceIdx.html#m6">rec_count</a>;
00143     <a class="code" href="classSECtrl.html#m4">total_effect</a> = <a class="code" href="classSECtrl.html#m2">max_sound_effect</a> + <a class="code" href="classSECtrl.html#m3">max_supp_effect</a>;
00144 
00145     req_pool = (<a class="code" href="structSERequest.html">SERequest</a> *)<a class="code" href="ALL_8H.html#a5">mem_add</a>(<a class="code" href="classSECtrl.html#m4">total_effect</a> * <span class="keyword">sizeof</span>(<a class="code" href="structSERequest.html">SERequest</a>) );
00146     last_cycle = (<span class="keywordtype">char</span> *)<a class="code" href="ALL_8H.html#a5">mem_add</a>(<a class="code" href="classSECtrl.html#m4">total_effect</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
00147 
00148     <span class="keywordflow">for</span>(<span class="keywordtype">short</span> j=0; j &lt; count; ++j) {
00149         req_pool[j].<a class="code" href="structSERequest.html#m1">resx_id</a> = j+1;
00150         req_pool[j].<a class="code" href="structSERequest.html#m0">wave_ptr</a> = <a class="code" href="classSECtrl.html#m6">res_wave</a>.<a class="code" href="classResourceIdx.html#a11">get_data</a>(j+1);<span class="comment">// wave data pointer</span>
00151         last_cycle[j] = 0;
00152     }
00153 
00154     <span class="keywordflow">for</span>(<span class="keywordtype">short</span> k=0; k &lt; suppCount; ++k, ++j) {
00155         req_pool[j].<a class="code" href="structSERequest.html#m1">resx_id</a> = k+1;
00156         req_pool[j].<a class="code" href="structSERequest.html#m0">wave_ptr</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00157         last_cycle[j] = 0;
00158     }
00159 }
00160 
00161 <span class="comment">// ------ End Function SECtrl::load_info -------//</span>
00162 
00163 <span class="comment">// ------ Begin Function SECtrl::clear -------//</span>
<a name="l00164"></a><a class="code" href="classSECtrl.html#a7">00164</a> <span class="keywordtype">void</span> <a class="code" href="classSECtrl.html#a7">SECtrl::clear</a>() {
00165     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> j = 0; j &lt; <a class="code" href="classSECtrl.html#m4">total_effect</a>; ++j) {
00166         req_pool[j].<a class="code" href="structSERequest.html#a3">clear_request</a>();
00167     }
00168 }
00169 
00170 <span class="comment">// ------ End Function SECtrl::clear -------//</span>
00171 
00172 <span class="comment">// ------ Begin Function SECtrl::request -------//</span>
00173 <span class="comment">//</span>
00174 <span class="comment">// Request to sound an effect</span>
00175 <span class="comment">//</span>
00176 <span class="comment">// &lt;int&gt; soundEffect        the id of the sound effect, return from SECtrl::search_effect_id</span>
00177 <span class="comment">// &lt;long&gt; vol               volume (0 - 100 max loudness)</span>
00178 <span class="comment">// &lt;long&gt; pan               pan (-10000 = full left; 10000 = full right)</span>
00179 <span class="comment">// note the request is abolished if vol is 0 or soundEffect is 0</span>
00180 <span class="comment">//</span>
<a name="l00181"></a><a class="code" href="classSECtrl.html#a4">00181</a> <span class="keywordtype">void</span> <a class="code" href="classSECtrl.html#a4">SECtrl::request</a>(<span class="keywordtype">int</span> soundEffect, <a class="code" href="classRelVolume.html">RelVolume</a> relVolume) {
00182     <span class="keywordflow">if</span>( !<a class="code" href="classSECtrl.html#m1">audio_flag</a> || !config.sound_effect_flag)
00183         <span class="keywordflow">return</span>;                                       <span class="comment">// skip if audio cannot init wave device</span>
00184     <a class="code" href="ALL_8H.html#a0">err_when</a>( soundEffect &lt; 0 || soundEffect &gt; <a class="code" href="classSECtrl.html#m4">total_effect</a>);
00185     <span class="keywordflow">if</span>( relVolume.<a class="code" href="classRelVolume.html#m0">rel_vol</a> &gt;= <a class="code" href="OSE_8CPP.html#a0">MIN_AUDIO_VOL</a> &amp;&amp; soundEffect)
00186         req_pool[soundEffect-1].<a class="code" href="structSERequest.html#a0">add_request</a>(relVolume);
00187 }
00188 
<a name="l00189"></a><a class="code" href="classSECtrl.html#a5">00189</a> <span class="keywordtype">void</span> <a class="code" href="classSECtrl.html#a4">SECtrl::request</a>(<span class="keywordtype">char</span> *soundName, <a class="code" href="classRelVolume.html">RelVolume</a> relVolume) {
00190     <span class="keywordflow">if</span>( !<a class="code" href="classSECtrl.html#m1">audio_flag</a> || !config.sound_effect_flag)
00191         <span class="keywordflow">return</span>;                                       <span class="comment">// skip if audio cannot init wave device</span>
00192     <span class="keywordtype">int</span> soundEffect = <a class="code" href="classSECtrl.html#a9">search_effect_id</a>(soundName);
00193     <a class="code" href="ALL_8H.html#a0">err_when</a>( soundEffect &lt; 0 || soundEffect &gt; <a class="code" href="classSECtrl.html#m4">total_effect</a>);
00194     <span class="keywordflow">if</span>( relVolume.<a class="code" href="classRelVolume.html#m0">rel_vol</a> &gt;= <a class="code" href="OSE_8CPP.html#a0">MIN_AUDIO_VOL</a> &amp;&amp; soundEffect)
00195         req_pool[soundEffect-1].<a class="code" href="structSERequest.html#a0">add_request</a>(relVolume);
00196 }
00197 
00198 <span class="comment">// ------ End Function SECtrl::request -------//</span>
00199 
00200 <span class="comment">// ------ Begin Function SECtrl::flush -------//</span>
<a name="l00201"></a><a class="code" href="classSECtrl.html#a6">00201</a> <span class="keywordtype">void</span> <a class="code" href="classSECtrl.html#a6">SECtrl::flush</a>() {
00202     <a class="code" href="ALL_8H.html#a0">err_when</a>(!<a class="code" href="classSECtrl.html#m0">init_flag</a>);
00203     <span class="comment">// ##### begin Gilbert 11/11 ######//</span>
00204     <span class="comment">// err_when(!audio_ptr-&gt;init_flag);</span>
00205     <span class="comment">// ##### end Gilbert 11/11 ######//</span>
00206     <span class="keywordflow">if</span>( !<a class="code" href="classSECtrl.html#m1">audio_flag</a> || !config.sound_effect_flag) {
00207         <a class="code" href="classSECtrl.html#a7">clear</a>();
00208         <span class="keywordflow">return</span>;                                       <span class="comment">// skip if audio cannot init wave device</span>
00209     }
00210     <span class="keywordtype">int</span> chCount = <a class="code" href="classSECtrl.html#m5">audio_ptr</a>-&gt;<a class="code" href="classAudio.html#a9">get_free_wav_ch</a>();
00211     <span class="keywordtype">int</span> reqCount = 0, reqSum = 0;
00212     <span class="keywordtype">int</span> i,j,k;
00213     <a class="code" href="structSERequest.html">SERequest</a> *seRequest;
00214 
00215     k = 0;
00216     cached_size = 0;
00217     <span class="keywordflow">for</span>( j = 0, seRequest=req_pool; j &lt; <a class="code" href="classSECtrl.html#m4">total_effect</a> ; ++j, ++seRequest) {
00218         <span class="keywordflow">if</span>( seRequest-&gt;<a class="code" href="structSERequest.html#m2">req_used</a> &gt; 0) {
00219             reqCount++;
00220             reqSum += seRequest-&gt;<a class="code" href="structSERequest.html#m2">req_used</a>;
00221         }
00222 
00223         <span class="comment">// cached sound effect</span>
00224         <span class="keywordflow">if</span>( (seRequest-&gt;<a class="code" href="structSERequest.html#m2">req_used</a> &gt; 0 || last_cycle[j]) &amp;&amp; cached_size &lt; <a class="code" href="OSE_8H.html#a0">MAX_SE_CACHED</a> ) {
00225             cached_index[cached_size++] = j;
00226         }
00227     }
00228 
00229     <span class="keywordflow">if</span>( reqSum &lt;= chCount ) {
00230         <span class="comment">// --------- enough for all requests --------//</span>
00231         <span class="comment">// for( j = 0, seRequest=req_pool; j &lt; total_effect; ++j, ++seRequest)</span>
00232         <span class="keywordflow">for</span>( k = 0; k &lt; cached_size; ++k) {
00233             j = cached_index[k]; seRequest = req_pool + j;
00234 
00235             last_cycle[j] = 0;
00236             <span class="keywordflow">for</span>( i = seRequest-&gt;<a class="code" href="structSERequest.html#m2">req_used</a>-1; i &gt;= 0; --i) {
00237                 <span class="keywordflow">if</span>( seRequest-&gt;<a class="code" href="structSERequest.html#m0">wave_ptr</a>) {
00238                     <a class="code" href="classSECtrl.html#m5">audio_ptr</a>-&gt;<a class="code" href="classAudio.html#a8">play_resided_wav</a>( seRequest-&gt;<a class="code" href="structSERequest.html#m0">wave_ptr</a>,
00239                                                  seRequest-&gt;<a class="code" href="structSERequest.html#m3">play_vol</a>[i]);
00240                 }
00241                 <span class="keywordflow">else</span> {
00242                     <a class="code" href="classSECtrl.html#m5">audio_ptr</a>-&gt;<a class="code" href="classAudio.html#a6">play_wav</a>( seRequest-&gt;<a class="code" href="structSERequest.html#m1">resx_id</a>,
00243                                          seRequest-&gt;<a class="code" href="structSERequest.html#m3">play_vol</a>[i]);
00244                 }
00245                 last_cycle[j]++;
00246                 chCount--;
00247             }
00248         }
00249         reqSum = 0;
00250         reqCount = 0;
00251     }
00252     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( reqCount &lt;= chCount ) {
00253         <span class="comment">// --------- one channel for one sound effect --------//</span>
00254         <span class="keywordflow">for</span>( k = 0; k &lt; cached_size; ++k) {
00255             j = cached_index[k]; seRequest = req_pool + j;
00256             last_cycle[j] = 0;
00257             <span class="keywordflow">if</span>( seRequest-&gt;<a class="code" href="structSERequest.html#m2">req_used</a> &gt; 0) {
00258                 i = seRequest-&gt;<a class="code" href="structSERequest.html#a1">max_entry</a>();
00259                 <span class="keywordflow">if</span>( seRequest-&gt;<a class="code" href="structSERequest.html#m0">wave_ptr</a>) {
00260                     <a class="code" href="classSECtrl.html#m5">audio_ptr</a>-&gt;<a class="code" href="classAudio.html#a8">play_resided_wav</a>( seRequest-&gt;<a class="code" href="structSERequest.html#m0">wave_ptr</a>,
00261                                                  seRequest-&gt;<a class="code" href="structSERequest.html#m3">play_vol</a>[i]);
00262                 }
00263                 <span class="keywordflow">else</span> {
00264                     <a class="code" href="classSECtrl.html#m5">audio_ptr</a>-&gt;<a class="code" href="classAudio.html#a6">play_wav</a>( seRequest-&gt;<a class="code" href="structSERequest.html#m1">resx_id</a>,
00265                                          seRequest-&gt;<a class="code" href="structSERequest.html#m3">play_vol</a>[i]);
00266                 }
00267                 last_cycle[j]++;
00268             }
00269         }
00270     }
00271     <span class="keywordflow">else</span> {
00272         <span class="comment">// -------- not enough for each sound effect ------//</span>
00273 
00274         <span class="comment">// ------- one channel for one sound effect --------//</span>
00275         <span class="keywordflow">for</span>( k = 0; k &lt; cached_size &amp;&amp; biased_se &gt; cached_index[k]; ++k);
00276         <span class="keywordflow">if</span>( k &gt;= cached_size)
00277             k = 0;
00278 
00279         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> c = 0; chCount &gt; 0 &amp;&amp; c &lt; cached_size; ++c) {
00280             <span class="keywordflow">if</span>( ++k &gt;= cached_size)
00281                 k = 0;
00282             j = cached_index[k]; seRequest = req_pool + j;
00283             <span class="keywordflow">if</span>( seRequest-&gt;<a class="code" href="structSERequest.html#m2">req_used</a> &gt; 0 &amp;&amp; !last_cycle[j]) {
00284                 i = seRequest-&gt;<a class="code" href="structSERequest.html#a1">max_entry</a>();
00285                 <span class="keywordflow">if</span>( seRequest-&gt;<a class="code" href="structSERequest.html#m0">wave_ptr</a> ) {
00286                     <a class="code" href="classSECtrl.html#m5">audio_ptr</a>-&gt;<a class="code" href="classAudio.html#a8">play_resided_wav</a>( seRequest-&gt;<a class="code" href="structSERequest.html#m0">wave_ptr</a>,
00287                                                  seRequest-&gt;<a class="code" href="structSERequest.html#m3">play_vol</a>[i]);
00288                 }
00289                 <span class="keywordflow">else</span> {
00290                     <a class="code" href="classSECtrl.html#m5">audio_ptr</a>-&gt;<a class="code" href="classAudio.html#a6">play_wav</a>( seRequest-&gt;<a class="code" href="structSERequest.html#m1">resx_id</a>,
00291                                          seRequest-&gt;<a class="code" href="structSERequest.html#m3">play_vol</a>[i]);
00292                 }
00293                 last_cycle[j]++;
00294                 chCount--;
00295                 biased_se = j;
00296             }
00297             <span class="keywordflow">else</span> {
00298                 last_cycle[j] = 0;
00299             }
00300         }
00301     }
00302 
00303     <a class="code" href="classSECtrl.html#a7">clear</a>();
00304 }
00305 
00306 <span class="comment">// ------ End Function SECtrl::flush -------//</span>
00307 
00308 <span class="comment">// ------ Begin Function SECtrl::get_effect_name -------//</span>
00309 <span class="comment">//</span>
00310 <span class="comment">// return the name of the sound effect</span>
00311 <span class="comment">// int j           the id of the sound effect</span>
00312 <span class="comment">//</span>
<a name="l00313"></a><a class="code" href="classSECtrl.html#a8">00313</a> <span class="keywordtype">char</span> *<a class="code" href="classSECtrl.html#a8">SECtrl::get_effect_name</a>(<span class="keywordtype">int</span> j) {
00314     <a class="code" href="ALL_8H.html#a0">err_when</a>(!<a class="code" href="classSECtrl.html#m0">init_flag</a>);
00315     <a class="code" href="ALL_8H.html#a0">err_when</a>( j &lt; 1 || j &gt; <a class="code" href="classSECtrl.html#m4">total_effect</a> );
00316     <span class="keywordflow">if</span>( j &gt; <a class="code" href="classSECtrl.html#m2">max_sound_effect</a> )
00317         <span class="keywordflow">return</span> <a class="code" href="classSECtrl.html#m7">res_supp</a>.<a class="code" href="classResourceIdx.html#a12">data_name</a>(j - <a class="code" href="classSECtrl.html#m2">max_sound_effect</a>);
00318     <span class="keywordflow">else</span>
00319         <span class="keywordflow">return</span> <a class="code" href="classSECtrl.html#m6">res_wave</a>.<a class="code" href="classResourceIdx.html#a12">data_name</a>(j);
00320 }
00321 
00322 <span class="comment">// ------ End Function SECtrl::get_effect_name -------//</span>
00323 
00324 <span class="comment">// ------ Begin Function SECtrl::search_effect_id -------//</span>
00325 <span class="comment">//</span>
00326 <span class="comment">// find the sound effect id of an sound effect</span>
00327 <span class="comment">//</span>
00328 <span class="comment">// &lt;char *&gt; effectName      the name of the effect name</span>
00329 <span class="comment">//</span>
<a name="l00330"></a><a class="code" href="classSECtrl.html#a9">00330</a> <span class="keywordtype">int</span> <a class="code" href="classSECtrl.html#a9">SECtrl::search_effect_id</a>(<span class="keywordtype">char</span> *effectName) {
00331     <a class="code" href="ALL_8H.html#a0">err_when</a>(!<a class="code" href="classSECtrl.html#m0">init_flag</a>);
00332     <span class="keywordflow">if</span>( !<a class="code" href="classSECtrl.html#m1">audio_flag</a> )
00333         <span class="keywordflow">return</span> 0;                                     <span class="comment">// skip if audio cannot init wave device</span>
00334 
00335     <span class="keywordtype">int</span> idx = <a class="code" href="classSECtrl.html#m6">res_wave</a>.<a class="code" href="classResourceIdx.html#a10">get_index</a>(effectName);
00336     <span class="keywordflow">if</span>( idx )
00337         <span class="keywordflow">return</span> idx;
00338 
00339     idx = <a class="code" href="classSECtrl.html#m7">res_supp</a>.<a class="code" href="classResourceIdx.html#a10">get_index</a>(effectName);
00340     <span class="keywordflow">if</span>( idx )
00341         <span class="keywordflow">return</span> idx + <a class="code" href="classSECtrl.html#m2">max_sound_effect</a>;
00342 
00343     <span class="keywordflow">return</span> 0;
00344 }
00345 
00346 <span class="comment">// ------ End Function SECtrl::search_effect_id -------//</span>
00347 
00348 <span class="comment">// ------ Begin Function SECtrl::search_effect_id -------//</span>
00349 <span class="comment">//</span>
00350 <span class="comment">// find the sound effect id of an sound effect</span>
00351 <span class="comment">//</span>
00352 <span class="comment">// &lt;char *&gt; effectName      the name of the effect name</span>
00353 <span class="comment">// &lt;int&gt; len                the size of the effectName</span>
00354 <span class="comment">//</span>
<a name="l00355"></a><a class="code" href="classSECtrl.html#a10">00355</a> <span class="keywordtype">int</span> <a class="code" href="classSECtrl.html#a9">SECtrl::search_effect_id</a>(<span class="keywordtype">char</span> *effectName, <span class="keywordtype">int</span> len) {
00356     <a class="code" href="ALL_8H.html#a0">err_when</a>(!<a class="code" href="classSECtrl.html#m0">init_flag</a>);
00357     <span class="keywordflow">if</span>( !<a class="code" href="classSECtrl.html#m1">audio_flag</a>)
00358         <span class="keywordflow">return</span> 0;                                     <span class="comment">// skip if audio cannot init wave device</span>
00359 
00360     <span class="keywordtype">char</span> tmpStr[16];
00361     <a class="code" href="ALL_8H.html#a0">err_when</a>(len &gt;= 16);
00362     memcpy(tmpStr, effectName, len);
00363     tmpStr[len] = <span class="charliteral">'\0'</span>;
00364     m.rtrim(tmpStr);
00365 
00366     <span class="keywordtype">int</span> idx = <a class="code" href="classSECtrl.html#m6">res_wave</a>.<a class="code" href="classResourceIdx.html#a10">get_index</a>(tmpStr);
00367     <span class="keywordflow">if</span>( idx )
00368         <span class="keywordflow">return</span> idx;
00369 
00370     idx = <a class="code" href="classSECtrl.html#m7">res_supp</a>.<a class="code" href="classResourceIdx.html#a10">get_index</a>(tmpStr);
00371     <span class="keywordflow">if</span>( idx )
00372         <span class="keywordflow">return</span> idx + <a class="code" href="classSECtrl.html#m2">max_sound_effect</a>;
00373 
00374     <span class="keywordflow">return</span> 0;
00375 
00376 }
00377 
00378 <span class="comment">// ------ End Function SECtrl::search_effect_id -------//</span>
00379 
00380 <span class="comment">/*</span>
00381 <span class="comment">// ------ Begin Function SECtrl::sound_volume --------//</span>
00382 <span class="comment">//</span>
00383 <span class="comment">// calculate the volume from a location</span>
00384 <span class="comment">//</span>
00385 <span class="comment">// &lt;short&gt; locX, locY  - location x, y relative to the center of screen</span>
00386 <span class="comment">// [short] limit       - volume is zero if dist &gt; limit</span>
00387 <span class="comment">// [short] drop        - volume is dropped (linearly) to zero when dist = drop</span>
00388 <span class="comment">//                     drop &gt; limit</span>
00389 <span class="comment">//</span>
00390 <span class="comment"></span>
00391 <span class="comment">const default_vol_limit = 20;</span>
00392 <span class="comment">const default_vol_drop = 100;</span>
00393 <span class="comment">long SECtrl::sound_volume(short locX, short locY)</span>
00394 <span class="comment">{</span>
00395 <span class="comment">short dist = max( locX &gt;= 0? locX : -locX, locY &gt;= 0? locY:-locY);</span>
00396 <span class="comment">err_when( default_vol_drop &lt;= default_vol_limit);</span>
00397 <span class="comment"></span>
00398 <span class="comment">if( dist &gt; default_vol_limit)</span>
00399 <span class="comment">return 0;</span>
00400 <span class="comment">else</span>
00401 <span class="comment">return 90 - dist * 90 / default_vol_drop;</span>
00402 <span class="comment">}</span>
00403 <span class="comment"></span>
00404 <span class="comment">long SECtrl::sound_volume(short locX, short locY, short limit, short drop)</span>
00405 <span class="comment">{</span>
00406 <span class="comment">short dist = max( locX &gt;= 0? locX : -locX, locY &gt;= 0? locY:-locY);</span>
00407 <span class="comment">err_when( drop &lt;= limit);</span>
00408 <span class="comment"></span>
00409 <span class="comment">if( dist &gt; limit)</span>
00410 <span class="comment">return 0;</span>
00411 <span class="comment">else</span>
00412 <span class="comment">return 90 - dist * 90 / drop;</span>
00413 <span class="comment">}</span>
00414 <span class="comment">// ------ End Function SECtrl::sound_volume --------//</span>
00415 <span class="comment"></span>
00416 <span class="comment">// ------ Begin Function SECtrl::sound_pan --------//</span>
00417 <span class="comment">//</span>
00418 <span class="comment">// calculate the pan setting of a location</span>
00419 <span class="comment">//</span>
00420 <span class="comment">// short locX, locY  - location x, y relative to the center of screen</span>
00421 <span class="comment">// short drop        - panning is set to extreme value when abs(locX) &gt;= drop</span>
00422 <span class="comment">//</span>
00423 <span class="comment"></span>
00424 <span class="comment">const default_pan_drop = 100;</span>
00425 <span class="comment">long SECtrl::sound_pan(short locX, short locY)</span>
00426 <span class="comment">{</span>
00427 <span class="comment">if( locX &gt;= default_pan_drop )</span>
00428 <span class="comment">return 10000;</span>
00429 <span class="comment">if( locX &lt;= -default_pan_drop )</span>
00430 <span class="comment">return -10000;</span>
00431 <span class="comment">return 10000 / default_pan_drop * locX;</span>
00432 <span class="comment">}</span>
00433 <span class="comment"></span>
00434 <span class="comment">long SECtrl::sound_pan(short locX, short locY, short drop)</span>
00435 <span class="comment">{</span>
00436 <span class="comment">if( locX &gt;= drop )</span>
00437 <span class="comment">return 10000;</span>
00438 <span class="comment">if( locX &lt;= -drop )</span>
00439 <span class="comment">return -10000;</span>
00440 <span class="comment">return 10000 * locX / drop;</span>
00441 <span class="comment">}</span>
00442 <span class="comment">// ------ End Function SECtrl::sound_pan --------//</span>
00443 <span class="comment">*/</span>
00444 
00445 <span class="comment">// ------- Begin Function SECtrl::immediate_sound ------------//</span>
<a name="l00446"></a><a class="code" href="classSECtrl.html#a11">00446</a> <span class="keywordtype">int</span> <a class="code" href="classSECtrl.html#a11">SECtrl::immediate_sound</a>(<span class="keywordtype">char</span> *soundName, <a class="code" href="classRelVolume.html">RelVolume</a> relVolume) {
00447     <span class="keywordflow">if</span>( !config.sound_effect_flag )
00448         <span class="keywordflow">return</span> 0;
00449 
00450     <span class="keywordtype">int</span> effectId = <a class="code" href="classSECtrl.html#a9">search_effect_id</a>(soundName);
00451     <span class="keywordflow">if</span>( effectId ) {
00452         <a class="code" href="structSERequest.html">SERequest</a> *seRequest = req_pool + effectId-1;
00453         <span class="keywordflow">if</span>( seRequest-&gt;<a class="code" href="structSERequest.html#m0">wave_ptr</a> )
00454             <span class="keywordflow">return</span> <a class="code" href="classSECtrl.html#m5">audio_ptr</a>-&gt;<a class="code" href="classAudio.html#a8">play_resided_wav</a>( seRequest-&gt;<a class="code" href="structSERequest.html#m0">wave_ptr</a>, relVolume);
00455         <span class="keywordflow">else</span>
00456             <span class="keywordflow">return</span> <a class="code" href="classSECtrl.html#m5">audio_ptr</a>-&gt;<a class="code" href="classAudio.html#a6">play_wav</a>( seRequest-&gt;<a class="code" href="structSERequest.html#m1">resx_id</a>, relVolume);
00457     }
00458     <span class="keywordflow">return</span> 0;
00459 }
00460 
00461 <span class="comment">// ------- End Function SECtrl::immediate_sound ------------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:22 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
