<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Ogrpdyr.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Ogrpdyr.cpp</h1><a href="Ogrpdyr_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OGRPDYR.CPP</span>
00002 <span class="comment">//Description : Object GraphDoubleBarYear</span>
00003 <span class="comment">//Owner                 : Kevin(Ho)</span>
00004 
00005 <span class="comment">// The data is updated at 1st Sep of each year.</span>
00006 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="COLOR_8H.html">COLOR.H</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;OFINANCE.H&gt;</span>
00009 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00012 <span class="preprocessor">#include &lt;OFONT.H&gt;</span>
00013 <span class="preprocessor">#include &lt;OMOUSE.H&gt;</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="OGRPHYR_8H.html">OGRPHYR.H</a>&gt;</span>
00015 <span class="preprocessor">#include &lt;<a class="code" href="OGRPDYR_8H.html">OGRPDYR.H</a>&gt;</span>
00016 <span class="preprocessor">#include &lt;OIFACE.H&gt;</span>
00017 <span class="preprocessor">#include &lt;math.h&gt;</span>
00018 
00019 <span class="comment">//--------- Define macro constant -----------//</span>
00020 
<a name="l00021"></a><a class="code" href="Ogrpdyr_8cpp.html#a0">00021</a> <span class="preprocessor">#define MAX_LEN_LABEL "00,000,000"</span>
00022 <span class="preprocessor"></span>
00023 <span class="keyword">static</span> <span class="keywordtype">int</span> default_series_color[] = {
00024     <a class="code" href="COLOR_8H.html#a21">V_BLUE</a>,
00025     <a class="code" href="COLOR_8H.html#a20">V_GREEN</a>,
00026     <a class="code" href="COLOR_8H.html#a19">V_RED</a>,
00027     <a class="code" href="COLOR_8H.html#a25">V_YELLOW</a>,
00028     <a class="code" href="COLOR_8H.html#a22">V_VIOLET</a>,
00029     <a class="code" href="COLOR_8H.html#a23">V_BROWN</a>,
00030     <a class="code" href="COLOR_8H.html#a18">V_ORANGE</a>,
00031     <a class="code" href="COLOR_8H.html#a24">V_PINK</a>,
00032     <a class="code" href="COLOR_8H.html#a15">V_BLACK</a>,
00033     <a class="code" href="COLOR_8H.html#a17">V_WHITE</a>,
00034 };                                                <span class="comment">// 10 default series colors</span>
00035 
00036 <span class="keyword">enum</span> {  <a class="code" href="Ogrpdyr_8cpp.html#a7a2">DEFAULT_SERIES_COLOR_NUM</a> = 10 };
00037 
00038 <span class="keyword">enum</span> {
00039     <a class="code" href="Ogrpdyr_8cpp.html#a8a3">LEGEND_SIZE</a> = 11,
00040     <a class="code" href="Ogrpdyr_8cpp.html#a8a4">LEGEND_X_SPACING</a> = 12,
00041     <a class="code" href="Ogrpdyr_8cpp.html#a8a5">LEGEND_Y_SPACING</a> = 2,
00042 };
00043 
00044 <span class="keyword">enum</span> {  <a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a> = 2         };
00045 
00046 <span class="comment">//-------------- Define static vars ------------//</span>
00047 
00048 <span class="comment">//static char paint_flag = 0;</span>
00049 
00050 <span class="comment">//-------- Begin of function GraphDoubleBarYear::GraphDoubleBarYear ----//</span>
<a name="l00052"></a><a class="code" href="classGraphDoubleBarYear.html#a0">00052</a> <span class="comment">GraphDoubleBarYear::GraphDoubleBarYear() {</span>
00053     init_flag = 0;
00054     graph_bitmap = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00055 }
00056 
00057 <span class="comment">//---------- End of function GraphDoubleBarYear::GraphDoubleBarYear ----//</span>
00058 
00059 <span class="comment">//-------- Begin of function GraphDoubleBarYear::~GraphDoubleBarYear -----//</span>
<a name="l00061"></a><a class="code" href="classGraphDoubleBarYear.html#a1">00061</a> <span class="comment">GraphDoubleBarYear::~GraphDoubleBarYear() {</span>
00062     deinit();
00063 }
00064 
00065 <span class="comment">//---------- End of function GraphDoubleBarYear::~GraphDoubleBarYear -----//</span>
00066 
00067 <span class="comment">//-------- Begin of function GraphDoubleBarYear::init --------//</span>
00101 <span class="comment">void GraphDoubleBarYear::init(int x1, int y1, int x2, int y2,</span>
00102                               <span class="keywordtype">int</span> seriesNum, <span class="keywordtype">int</span> *dataNum,
00103                               <span class="keywordtype">void</span> *dataArray, <span class="keywordtype">char</span> dataTypeFlag,
00104                               <span class="keywordtype">int</span> thisYearIndicator,
00105                               <span class="keywordtype">char</span> *xLabel, <span class="keywordtype">char</span> *yLabel,
00106                               <span class="keywordtype">char</span> **legendArray, <span class="keywordtype">char</span> transparentFlag,
00107                               <span class="keywordtype">char</span> orientationFlag, <span class="keywordtype">char</span> valueFlag,
00108                               <span class="keywordtype">int</span> numFormat, <span class="keywordtype">int</span> *seriesColor, <span class="keywordtype">int</span> axisColor) {
00109     <a class="code" href="ALL_8H.html#a0">err_when</a>(seriesNum &gt; <a class="code" href="Ogrpdyr_8cpp.html#a7a2">DEFAULT_SERIES_COLOR_NUM</a> &amp;&amp; !seriesColor);
00110     <a class="code" href="ALL_8H.html#a0">err_when</a>(seriesNum &lt;= 0);
00111 
00112     graph_width = x2 - x1 - 6;
00113 
00114     <a class="code" href="ALL_8H.html#a0">err_when</a>(graph_width &lt; 0);
00115 
00116     graph_x1 = x1;
00117     graph_y1 = y1;
00118     graph_x2 = x2;
00119     graph_y2 = y2;
00120     series_num = seriesNum;
00121     data_num = dataNum;
00122     data_array = dataArray;
00123     data_type_flag = dataTypeFlag;
00124 
00125     x_label = xLabel;
00126     y_label = yLabel;
00127     legend_array = legendArray;
00128 
00129     transparent_flag = transparentFlag;
00130     orientation_flag = orientationFlag;
00131     value_flag = valueFlag;
00132     num_format = numFormat;
00133 
00134     series_color = seriesColor ? seriesColor : default_series_color;
00135     axis_color = axisColor;
00136 
00137     init_flag = 1;
00138     this_year_indicator = thisYearIndicator;
00139     y_label_max_len = font_chartsm.text_width(<a class="code" href="Ogrpdyr_8cpp.html#a0">MAX_LEN_LABEL</a>);
00140     set_font(&amp;font_chartsm);
00141 }
00142 
00143 <span class="comment">//------------- End of function GraphDoubleBarYear::init -----------//</span>
00144 
00145 <span class="comment">//-------- Begin of function GraphDoubleBarYear::deinit ------------//</span>
<a name="l00147"></a><a class="code" href="classGraphDoubleBarYear.html#a7">00147</a> <span class="comment">void GraphDoubleBarYear::deinit() {</span>
00148     <span class="keywordflow">if</span> (graph_bitmap) {
00149         <a class="code" href="ALL_8H.html#a8">mem_del</a>(graph_bitmap);
00150         graph_bitmap = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00151     }
00152 
00153     init_flag = 0;
00154 }
00155 
00156 <span class="comment">//------------- End of function GraphDoubleBarYear::deinit ---------//</span>
00157 
00158 <span class="comment">//-------- Begin of function GraphDoubleBarYear::set_font ------------//</span>
<a name="l00160"></a><a class="code" href="classGraphDoubleBarYear.html#a10">00160</a> <span class="comment">void GraphDoubleBarYear::set_font(Font *fontPtr) {</span>
00161     <span class="keywordflow">if</span> (!init_flag)
00162         <span class="keywordflow">return</span>;
00163 
00164     font_ptr = fontPtr;
00165 
00166     calc_pos();
00167 }
00168 
00169 <span class="comment">//------------- End of function GraphDoubleBarYear::set_font ---------//</span>
00170 
00171 <span class="comment">//-------- Begin of function GraphDoubleBarYear::calc_pos ------------//</span>
<a name="l00176"></a><a class="code" href="classGraphDoubleBarYear.html#a11">00176</a> <span class="comment">void GraphDoubleBarYear::calc_pos() {</span>
00177     <span class="keywordflow">if</span> (legend_array) {
00178         <span class="keywordtype">short</span> textWidth = 0, textHeight = font_ptr-&gt;max_font_height;
00179 
00180         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00181             <span class="keywordflow">if</span> (font_ptr-&gt;text_width(legend_array[i]) &gt; textWidth)
00182                 textWidth = font_ptr-&gt;text_width(legend_array[i]);
00183         }
00184 
00185         <a class="code" href="ALL_8H.html#a0">err_when</a>(textWidth + <a class="code" href="Ogrpdyr_8cpp.html#a8a4">LEGEND_X_SPACING</a> * 2 &gt; graph_width);
00186 
00187         legend_x_num = (graph_width - <a class="code" href="Ogrpdyr_8cpp.html#a8a4">LEGEND_X_SPACING</a>*2) / (textWidth + <a class="code" href="Ogrpdyr_8cpp.html#a8a4">LEGEND_X_SPACING</a>*2);
00188         legend_y_num = (series_num / legend_x_num) + ((series_num % legend_x_num) ? 1 : 0);
00189 
00190         graph_height = graph_y2 - graph_y1 - legend_y_num * (textHeight + <a class="code" href="Ogrpdyr_8cpp.html#a8a5">LEGEND_Y_SPACING</a>) - 6;
00191 
00192         <a class="code" href="ALL_8H.html#a0">err_when</a>(graph_height &lt;= 0);
00193 
00194         legend_width = (graph_width - <a class="code" href="Ogrpdyr_8cpp.html#a8a4">LEGEND_X_SPACING</a>*2) / legend_x_num;
00195         legend_height = textHeight + <a class="code" href="Ogrpdyr_8cpp.html#a8a5">LEGEND_Y_SPACING</a>;
00196     }
00197     <span class="keywordflow">else</span> {
00198         legend_width = legend_height = legend_x_num = legend_y_num = 0;
00199         graph_height = graph_y2 - graph_y1 - 6;
00200     }
00201 
00202     <span class="keywordtype">short</span> YLabelWidth = y_label ? (orientation_flag ? font_ptr-&gt;max_font_height : font_ptr-&gt;text_width(y_label)) : -<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>;
00203     <span class="keywordtype">short</span> XLabelHeight = x_label ? (font_ptr-&gt;max_font_height) : -<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>;
00204     series_x1 = graph_x1 + 4 + <a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>*4 + YLabelWidth + y_label_max_len;
00205     series_y1 = graph_y1 + 4 + <a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>*6;
00206     series_x2 = graph_x2 - 4 - <a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>*16;
00207     series_y2 = graph_y1 + graph_height - <a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>*3 - (font_ptr-&gt;max_font_height);
00208 }
00209 
00210 <span class="comment">//------------ End of function GraphDoubleBarYear::calc_pos ---------//</span>
00211 
00212 <span class="comment">//-------- Begin of function GraphDoubleBarYear::paint --------------//</span>
<a name="l00214"></a><a class="code" href="classGraphDoubleBarYear.html#a8">00214</a> <span class="comment">void GraphDoubleBarYear::paint() {</span>
00215     <span class="keywordflow">if</span> (transparent_flag) {
00216         user_interface.brighten(graph_x1+4, graph_y1+4, graph_x2-2, graph_y2-2);
00217         <span class="keywordflow">if</span> (legend_array)
00218             draw_legend();
00219         draw_axis_label();
00220         graph_bitmap = vga_back.save_area(graph_x1+4, graph_y1+4, graph_x2-2, graph_y2-2, graph_bitmap);
00221     }
00222 
00223     <span class="comment">//  paint_flag = 1;</span>
00224     refresh();
00225 }
00226 
00227 <span class="comment">//------------- End of function GraphDoubleBarYear::paint -----------//</span>
00228 
00229 <span class="comment">//-------- Begin of function GraphDoubleBarYear::refresh ------------//</span>
<a name="l00231"></a><a class="code" href="classGraphDoubleBarYear.html#a9">00231</a> <span class="comment">void GraphDoubleBarYear::refresh() {</span>
00232     <span class="keywordflow">if</span> (transparent_flag) {
00233         user_interface.rect(graph_x1, graph_y1, graph_x2, graph_y2, 1);
00234         vga_back.rest_area(graph_bitmap, 0, 0);
00235     }
00236     <span class="keywordflow">else</span> {
00237         user_interface.bar(graph_x1, graph_y1, graph_x2, graph_y2);
00238         user_interface.panel(graph_x1+3, graph_y1+3, graph_x2-4, graph_y2-4);
00239     }
00240     <span class="keywordflow">if</span> (legend_array)
00241         draw_legend();
00242     draw_scale();
00243     draw_series();
00244 
00245     <span class="comment">//  if (!paint_flag)</span>
00246     <span class="comment">//          vga.blt_buf(graph_x1, graph_y1, graph_x2+2, graph_y2+2);</span>
00247     <span class="comment">//  else</span>
00248     <span class="comment">//          paint_flag = 0;</span>
00249 }
00250 
00251 <span class="comment">//------------- End of function GraphDoubleBarYear::refresh ---------//</span>
00252 
00253 <span class="comment">//---------- Begin of function GraphDoubleBarYear::draw_legend ------------//</span>
<a name="l00255"></a><a class="code" href="classGraphDoubleBarYear.html#b0">00255</a> <span class="comment">void GraphDoubleBarYear::draw_legend() {</span>
00256     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00257         <span class="keywordtype">short</span> legendX = graph_x1 + 4 + (i % legend_x_num) * legend_width + <a class="code" href="Ogrpdyr_8cpp.html#a8a4">LEGEND_X_SPACING</a>;
00258         <span class="keywordtype">short</span> legendY = graph_y1 + 4 + graph_height + (i / legend_x_num) * legend_height;
00259         user_interface.bar( legendX+<a class="code" href="Ogrpdyr_8cpp.html#a8a4">LEGEND_X_SPACING</a>, legendY+<a class="code" href="Ogrpdyr_8cpp.html#a8a5">LEGEND_Y_SPACING</a>,
00260                             legendX+<a class="code" href="Ogrpdyr_8cpp.html#a8a4">LEGEND_X_SPACING</a>+<a class="code" href="Ogrpdyr_8cpp.html#a8a3">LEGEND_SIZE</a>, legendY+<a class="code" href="Ogrpdyr_8cpp.html#a8a5">LEGEND_Y_SPACING</a>+<a class="code" href="Ogrpdyr_8cpp.html#a8a3">LEGEND_SIZE</a>,
00261                             series_color[i] );
00262         font_ptr-&gt;put( legendX+<a class="code" href="Ogrpdyr_8cpp.html#a8a4">LEGEND_X_SPACING</a>*2+<a class="code" href="Ogrpdyr_8cpp.html#a8a3">LEGEND_SIZE</a>, legendY+<a class="code" href="Ogrpdyr_8cpp.html#a8a5">LEGEND_Y_SPACING</a>, legend_array[i] );
00263     }
00264 }
00265 
00266 <span class="comment">//------------ End of function GraphDoubleBarYear::draw_legend ------------//</span>
00267 
00268 <span class="comment">//---------- Begin of function GraphDoubleBarYear::draw_axis_label --------//</span>
<a name="l00270"></a><a class="code" href="classGraphDoubleBarYear.html#b1">00270</a> <span class="comment">void GraphDoubleBarYear::draw_axis_label() {</span>
00271     <span class="keywordtype">short</span> textHeight = font_ptr-&gt;max_font_height;
00272 
00273     <span class="keywordflow">if</span> (x_label) {
00274         font_ptr-&gt;center_put( series_x1, series_y2+<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>*2+textHeight,
00275                               series_x2, graph_y1+graph_height-<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>, x_label );
00276     }
00277 
00278     <span class="keywordflow">if</span> (y_label) {
00279         <span class="keywordtype">short</span> textWidth = font_ptr-&gt;text_width(y_label) + 1;
00280 
00281         <span class="keywordflow">if</span> (orientation_flag) {
00282             <span class="keywordtype">short</span> *fontBuf = (<span class="keywordtype">short</span> *) sys.common_data_buf;
00283             <a class="code" href="ALL_8H.html#a0">err_when</a>(textWidth * textHeight * <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>) &gt; <a class="code" href="Osys_8h.html#a40a2">COMMON_DATA_BUF_SIZE</a>);
00284 
00285             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; textWidth * textHeight; i++)
00286                 *fontBuf++ = transparent_code_w;
00287 
00288             font_ptr-&gt;put_to_bufferW(fontBuf = (<span class="keywordtype">short</span> *) sys.common_data_buf, textWidth * <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>), 0, 0, y_label);
00289 
00290             <span class="keywordtype">short</span> xStart = graph_x1 + 4 + <a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a> * 2;
00291             <span class="keywordtype">short</span> yStart = (series_y1 + series_y2 - textWidth) / 2;
00292 
00293             <span class="keywordflow">for</span> (<span class="keywordtype">short</span> x = 0; x &lt; textHeight; x++) {
00294                 <span class="keywordflow">for</span> (<span class="keywordtype">short</span> y = textWidth - 1; y &gt;= 0; y--, fontBuf++) {
00295                     <span class="keywordflow">if</span> (*fontBuf != transparent_code_w)
00296                         *vga_back.buf_ptr(xStart+x, yStart+y) = *fontBuf;
00297                 }
00298             }
00299         }
00300         <span class="keywordflow">else</span> {
00301             font_ptr-&gt;center_put( graph_x1+4+<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>*2, series_y1,
00302                                   graph_x1+4+<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>*2+textWidth, series_y2, y_label);
00303         }
00304     }
00305 }
00306 
00307 <span class="comment">//------------ End of function GraphDoubleBarYear::draw_axis_label --------//</span>
00308 
00309 <span class="comment">//---------- Begin of function GraphDoubleBarYear::find_scale -------------//</span>
<a name="l00311"></a><a class="code" href="classGraphDoubleBarYear.html#b2">00311</a> <span class="comment">void GraphDoubleBarYear::find_scale() {</span>
00312     <span class="keywordtype">double</span> data, maxVal = 0.0,minVal = 0.0;
00313 
00314     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num * *data_num; i++) {
00315         <span class="keywordflow">switch</span> (data_type_flag) {
00316         <span class="keywordflow">case</span> DATA_DOUBLE:
00317             data = ((<span class="keywordtype">double</span>*)data_array)[i];
00318             <span class="keywordflow">break</span>;
00319         <span class="keywordflow">case</span> DATA_FLOAT:
00320             data = double(((<span class="keywordtype">float</span>*)data_array)[i]);
00321             <span class="keywordflow">break</span>;
00322         <span class="keywordflow">case</span> DATA_INT:
00323             data = double(((<span class="keywordtype">int</span>*)data_array)[i]);
00324             <span class="keywordflow">break</span>;
00325         <span class="keywordflow">case</span> DATA_LONG:
00326             data = double(((<span class="keywordtype">long</span>*)data_array)[i]);
00327             <span class="keywordflow">break</span>;
00328         }
00329         <span class="keywordflow">if</span> (data &gt; maxVal)
00330             maxVal = data;
00331         <span class="keywordflow">if</span> (data &lt; minVal)
00332             minVal = data;
00333     }
00334 
00335     <span class="keywordflow">if</span>(maxVal&gt;1.0)
00336         max_scale = maxVal;
00337     <span class="keywordflow">else</span>
00338         max_scale = 1;
00339 
00340     <span class="keywordflow">if</span> (minVal&lt;0)
00341         min_scale = minVal;
00342     <span class="keywordflow">else</span>
00343         min_scale = 0;
00344 
00345 }
00346 
00347 <span class="comment">//------------ End of function GraphDoubleBarYear::find_scale -------------//</span>
00348 
00349 <span class="comment">//---------- Begin of function GraphDoubleBarYear::draw_scale -------------//</span>
<a name="l00351"></a><a class="code" href="classGraphDoubleBarYear.html#b3">00351</a> <span class="comment">void GraphDoubleBarYear::draw_scale() {</span>
00352     find_scale();
00353 
00354     <span class="comment">//------ Draw y-axis -------//</span>
00355     vga_back.bar(series_x1, series_y1-<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>*2, series_x1+1, series_y2+<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>, axis_color);
00356 
00357     xAxisPos=(short)(series_y1+(series_y2-series_y1)*(max_scale)/(max_scale-min_scale));
00358 
00359     posScaleNum = (xAxisPos-series_y1-font_ptr-&gt;max_font_height) / (font_ptr-&gt;max_font_height*3/2);
00360     <span class="keywordflow">if</span> ( posScaleNum &gt; 0 )
00361         posScaleNum = short(pow(2,floor(log10(<span class="keywordtype">double</span>(posScaleNum))/log10(2.0))));
00362     <span class="keywordflow">else</span>
00363         posScaleNum = 0;
00364     negScaleNum = (series_y2-xAxisPos-font_ptr-&gt;max_font_height) / (font_ptr-&gt;max_font_height*3/2);
00365     <span class="keywordflow">if</span> ( negScaleNum &gt; 0 )
00366         negScaleNum = short(pow(2,ceil(log10(<span class="keywordtype">double</span>(negScaleNum))/log10(2.0))));
00367     <span class="keywordflow">else</span>
00368         negScaleNum = 0;
00369 
00370 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00371 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( posScaleNum + negScaleNum &lt;= 0) {
00372         posScaleNum = 1;
00373         negScaleNum = 0;
00374     }
00375 <span class="preprocessor">#endif</span>
00376 <span class="preprocessor"></span>
00377     <span class="keywordtype">short</span> posScaleStep;
00378     <span class="keywordtype">short</span> negScaleStep;
00379 
00380     <span class="keywordflow">if</span>(posScaleNum&lt;1) {
00381         posScaleStep = 0;
00382         posScaleInc = 0;
00383     }
00384     <span class="keywordflow">else</span> {
00385         posScaleStep  = (xAxisPos-series_y1) / posScaleNum;
00386         posScaleInc   = max_scale / posScaleNum;
00387 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00388 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( data_type_flag==DATA_INT || data_type_flag==DATA_LONG )
00389             posScaleInc = ceil(posScaleInc);            <span class="comment">// don't like integer type to have non-integral posScaleInc</span>
00390 <span class="preprocessor">#endif</span>
00391 <span class="preprocessor"></span>    }
00392 
00393     <span class="keywordflow">if</span>(negScaleNum&lt;1) {
00394         negScaleStep = 0;
00395         negScaleInc = 0;
00396     }
00397     <span class="keywordflow">else</span> {
00398         negScaleStep = (series_y2-xAxisPos) / negScaleNum;
00399         negScaleInc   = -min_scale / negScaleNum;
00400 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00401 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( data_type_flag==DATA_INT || data_type_flag==DATA_LONG )
00402             negScaleInc = ceil(negScaleInc);            <span class="comment">// don't like integer type to have non-integral negScaleInc</span>
00403 <span class="preprocessor">#endif</span>
00404 <span class="preprocessor"></span>    }
00405 
00406     <span class="keywordflow">if</span>(posScaleNum+negScaleNum&lt;1) {
00407         scaleStep = 0;
00408         scaleInc   = 0;
00409     }
00410     <span class="keywordflow">else</span> {
00411         scaleStep = (short)((series_y2-series_y1)/(posScaleNum+negScaleNum));
00412         scaleInc =  ((max_scale-min_scale)/(posScaleNum+negScaleNum));
00413 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00414 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( data_type_flag==DATA_INT || data_type_flag==DATA_LONG )
00415             scaleInc = max(posScaleInc, negScaleInc);
00416 <span class="preprocessor">#endif</span>
00417 <span class="preprocessor"></span>    }
00418 
00419     <span class="keywordtype">double</span> scaleValue;
00420 
00421     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = -negScaleNum,ycheck=xAxisPos-i*scaleStep;
00422          ycheck&gt;graph_y1;
00423          i++,ycheck-=scaleStep) {
00424 
00425         vga_back.bar(series_x1, ycheck, series_x1+<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>*2, ycheck, axis_color);
00426 
00427         scaleValue = i*scaleInc;
00428 
00429         <span class="keywordflow">switch</span> (data_type_flag) {
00430         <span class="keywordflow">case</span> DATA_FLOAT:
00431         <span class="keywordflow">case</span> DATA_DOUBLE:
00432             font_ptr-&gt;right_put(series_x1-<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>, ycheck-font_ptr-&gt;max_font_height/2, m.format(scaleValue,num_format));
00433             <span class="keywordflow">break</span>;
00434         <span class="keywordflow">case</span> DATA_INT:
00435         <span class="keywordflow">case</span> DATA_LONG:
00436             font_ptr-&gt;right_put(series_x1-<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>, ycheck-font_ptr-&gt;max_font_height/2, m.format(<span class="keywordtype">long</span>(scaleValue),num_format));
00437         }
00438     }
00439 
00440     <span class="comment">//------ Draw x-axis -------//</span>
00441     vga_back.bar(series_x1, xAxisPos+<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>, series_x2+1, xAxisPos+2*<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>, axis_color);
00442 
00443     <span class="comment">// show x-axis scale</span>
00444 
00445     <span class="comment">// At max, how much data points shown for each series</span>
00446     <span class="keywordtype">int</span> data_year_shown=8;
00447 
00448     <span class="comment">// The scales within how much years should be shown</span>
00449     <span class="keywordtype">int</span> scale_year_shown=8;
00450 
00451     <span class="comment">// pesudo year = which year the indicator pointing to</span>
00452     <span class="keywordtype">double</span> pesudo_end;
00453     <span class="comment">// ##### patch begin Gilbert 07/09/2001 ######//</span>
00454     pesudo_end = info.financial_year();
00455     <span class="comment">//  if(info.game_month&lt;finance.fiscal_year_start_month)</span>
00456     <span class="comment">//          pesudo_end=info.game_year-1;</span>
00457     <span class="comment">//  else</span>
00458     <span class="comment">//          pesudo_end=info.game_year;</span>
00459     <span class="comment">// ##### patch begin Gilbert 07/09/2001 ######//</span>
00460 
00461     <span class="keywordflow">if</span>(info.graph_year&lt;data_year_shown)
00462         data_year_shown=info.graph_year;
00463 
00464     <span class="keywordtype">short</span> maxLabelWidth = font_ptr-&gt;text_width(m.format(pesudo_end, 16));
00465     <span class="keywordtype">double</span> scaleYearRatio =1.0;
00466     x_axis_step = (series_x2-series_x1) / (scale_year_shown);
00467 
00468     <span class="keywordtype">short</span> displayInc = 1;
00469     <span class="keywordflow">while</span> (displayInc * x_axis_step &lt; maxLabelWidth ) displayInc++;
00470 
00471 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00472 <span class="preprocessor"></span>    <span class="keywordtype">double</span> printing_offset=0.0f;
00473 <span class="preprocessor">#else</span>
00474 <span class="preprocessor"></span>    <span class="keywordtype">double</span> printing_offset=1-finance.fiscal_year_start_month/12.0;
00475 <span class="preprocessor">#endif</span>
00476 <span class="preprocessor"></span>
00477     <span class="keywordtype">int</span> start_printing_year=(int)(pesudo_end+
00478                                   ((this_year_indicator&gt;=0)?this_year_indicator:0)
00479                                   +2-data_year_shown);
00480 
00481     <span class="comment">//  double actual_end_year=(double)info.game_month/12.0+info.game_year+1;</span>
00482     <span class="comment">//  int show_end_year=(int)(actual_end_year-finance.fiscal_year_start_month/12.0);</span>
00483     <span class="comment">//  int show_start_year=show_end_year-year_shown+1;</span>
00484 
00485     <span class="comment">//------ Draw x-axis -------//</span>
00486     <span class="keywordflow">for</span> (i = 0; i &lt; scale_year_shown ; i += displayInc) {
00487         vga_back.bar(
00488             (<span class="keywordtype">int</span>)(series_x1+(printing_offset+i)*x_axis_step),
00489             xAxisPos-<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>*2,
00490             (<span class="keywordtype">int</span>)(series_x1+(printing_offset+i)*x_axis_step),
00491             xAxisPos+<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>*2, axis_color);
00492         font_ptr-&gt;center_put(
00493             (<span class="keywordtype">int</span>)(series_x1+(printing_offset+i)*x_axis_step)-maxLabelWidth/2-<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>,
00494             xAxisPos+<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>+4,
00495             (<span class="keywordtype">int</span>)(series_x1+(printing_offset+i)*x_axis_step)+maxLabelWidth/2+<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>,
00496             xAxisPos+<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>+font_ptr-&gt;max_font_height+4,
00497             m.format((<span class="keywordtype">int</span>)(start_printing_year+i/scaleYearRatio), 16));
00498     }
00499 
00500     <span class="comment">//---- Draw this year indicators ----//</span>
00501     <span class="keywordflow">if</span>((this_year_indicator&gt;=0)&amp;&amp;(this_year_indicator&lt;HISTORY_YEAR_COUNT))
00502         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=series_y1;j&lt;series_y2+<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>;j+=8)
00503             vga_back.bar(
00504                 (<span class="keywordtype">int</span>)(series_x1+(data_year_shown-this_year_indicator-1)*x_axis_step),
00505                 j,
00506                 (<span class="keywordtype">int</span>)(series_x1+(data_year_shown-this_year_indicator-1)*x_axis_step),
00507                 j+4,
00508                 axis_color);
00509 }
00510 
00511 <span class="comment">//------------ End of function GraphDoubleBarYear::draw_scale -------------//</span>
00512 
00513 <span class="comment">//---------- Begin of function GraphDoubleBarYear::draw_series ------------//</span>
<a name="l00515"></a><a class="code" href="classGraphDoubleBarYear.html#b4">00515</a> <span class="comment">void GraphDoubleBarYear::draw_series() {</span>
00516     <span class="keywordflow">switch</span> (data_type_flag) {
00517     <span class="keywordflow">case</span> DATA_FLOAT: draw_series_float(); <span class="keywordflow">break</span>;
00518     <span class="keywordflow">case</span> DATA_DOUBLE: draw_series_double(); <span class="keywordflow">break</span>;
00519     <span class="keywordflow">case</span> DATA_INT: draw_series_int(); <span class="keywordflow">break</span>;
00520     <span class="keywordflow">case</span> DATA_LONG: draw_series_long(); <span class="keywordflow">break</span>;
00521     }
00522 }
00523 
00524 <span class="comment">//------------ End of function GraphDoubleBarYear::draw_series ------------//</span>
00525 
00526 <span class="comment">//---------- Begin of function GraphDoubleBarYear::draw_series_float ------------//</span>
<a name="l00528"></a><a class="code" href="classGraphDoubleBarYear.html#b5">00528</a> <span class="comment">void GraphDoubleBarYear::draw_series_float() {</span>
00529     <span class="keywordtype">float</span> *dataArray = (<span class="keywordtype">float</span> *) data_array;
00530     <span class="keywordtype">short</span> currX, currY;
00531     <span class="keywordtype">int</span> barWidth = x_axis_step/(series_num+2);
00532 
00533     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00534         dataArray-=(info.graph_year-2);
00535         dataArray+=HISTORY_YEAR_COUNT;
00536         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; (info.graph_year-2); j++) {
00537             currX = (short)(series_x1 + (j+0.5) * x_axis_step + i * barWidth);
00538             <span class="keywordflow">if</span> (x_axis_pos)
00539                 currY = xAxisPos+(short)(*dataArray * scaleStep/scaleInc);
00540             <span class="keywordflow">else</span>
00541                 currY = xAxisPos-(short)(*dataArray * scaleStep/scaleInc);
00542 
00543             vga_back.bar((<span class="keywordtype">int</span>)(currX-0.5*barWidth), currY,
00544                          (<span class="keywordtype">int</span>)(currX+0.5*barWidth)-<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>, xAxisPos,
00545                          series_color[i]);
00546             dataArray++;
00547         }
00548 
00549         <span class="keywordflow">if</span> (value_flag)
00550             draw_value(dataArray-1, vga_back.translate_color(series_color[i]), currX+<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>-(int)(0.3f*x_axis_step), currY-font_ptr-&gt;max_font_height/2, DATA_FLOAT);
00551     }
00552 }
00553 
00554 <span class="comment">//------------ End of function GraphDoubleBarYear::draw_series_float ------------//</span>
00555 
00556 <span class="comment">//---------- Begin of function GraphDoubleBarYear::draw_series_double ------------//</span>
<a name="l00558"></a><a class="code" href="classGraphDoubleBarYear.html#b6">00558</a> <span class="comment">void GraphDoubleBarYear::draw_series_double() {</span>
00559     <span class="keywordtype">double</span> *dataArray = (<span class="keywordtype">double</span> *) data_array;
00560     <span class="keywordtype">short</span> currX, currY;
00561     <span class="keywordtype">int</span> barWidth = x_axis_step/(series_num+2);
00562 
00563     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00564         dataArray-=(info.graph_year-2);
00565         dataArray+=HISTORY_YEAR_COUNT;
00566         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; (info.graph_year-2); j++) {
00567             currX = (short)(series_x1 + (j+0.5) * x_axis_step + i * barWidth);
00568             <span class="keywordflow">if</span> (x_axis_pos)
00569                 currY = xAxisPos+(short)(*dataArray * (double)scaleStep/scaleInc);
00570             <span class="keywordflow">else</span>
00571                 currY = xAxisPos-(short)(*dataArray * (double)scaleStep/scaleInc);
00572 
00573             vga_back.bar((<span class="keywordtype">int</span>)(currX-0.5*barWidth), currY,
00574                          (<span class="keywordtype">int</span>)(currX+0.5*barWidth)-<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>,xAxisPos,
00575                          series_color[i]);
00576             dataArray++;
00577         }
00578 
00579         <span class="keywordflow">if</span> (value_flag)
00580             draw_value(dataArray-1, vga_back.translate_color(series_color[i]), currX+<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>-(int)(0.3f*x_axis_step), currY-font_ptr-&gt;max_font_height/2, DATA_DOUBLE);
00581     }
00582 }
00583 
00584 <span class="comment">//------------ End of function GraphDoubleBarYear::draw_series_double ------------//</span>
00585 
00586 <span class="comment">//---------- Begin of function GraphDoubleBarYear::draw_series_int ------------//</span>
<a name="l00588"></a><a class="code" href="classGraphDoubleBarYear.html#b7">00588</a> <span class="comment">void GraphDoubleBarYear::draw_series_int() {</span>
00589     <span class="keywordtype">int</span> *dataArray = (<span class="keywordtype">int</span> *) data_array;
00590     <span class="keywordtype">short</span> currX, currY;
00591     <span class="keywordtype">int</span> barWidth = x_axis_step/(series_num+2);
00592 
00593     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00594         dataArray-=(info.graph_year-2);
00595         dataArray+=HISTORY_YEAR_COUNT;
00596         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; (info.graph_year-2); j++) {
00597 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00598 <span class="preprocessor"></span>            currX = (short)(series_x1 + j * x_axis_step + i * barWidth + 3*barWidth/2);
00599 <span class="preprocessor">#else</span>
00600 <span class="preprocessor"></span>            currX = (short)(series_x1 + (j+0.5) * x_axis_step + i * barWidth);
00601 <span class="preprocessor">#endif</span>
00602 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (x_axis_pos)
00603                 currY = (short)(xAxisPos+(int)(*dataArray * scaleStep/scaleInc));
00604             <span class="keywordflow">else</span>
00605                 currY = (short)(xAxisPos-(int)(*dataArray * scaleStep/scaleInc));
00606 
00607             vga_back.bar((<span class="keywordtype">int</span>)(currX-0.5*barWidth), currY,
00608                          (<span class="keywordtype">int</span>)(currX+0.5*barWidth)-<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>, xAxisPos,
00609                          series_color[i]);
00610             dataArray++;
00611         }
00612 
00613         <span class="keywordflow">if</span> (value_flag)
00614             draw_value(dataArray-1, vga_back.translate_color(series_color[i]), currX+<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>-(int)(0.3f*x_axis_step), currY-font_ptr-&gt;max_font_height/2, DATA_INT);
00615     }
00616 }
00617 
00618 <span class="comment">//------------ End of function GraphDoubleBarYear::draw_series_int ------------//</span>
00619 
00620 <span class="comment">//---------- Begin of function GraphDoubleBarYear::draw_series_long ------------//</span>
<a name="l00622"></a><a class="code" href="classGraphDoubleBarYear.html#b8">00622</a> <span class="comment">void GraphDoubleBarYear::draw_series_long() {</span>
00623     <span class="keywordtype">long</span> *dataArray = (<span class="keywordtype">long</span> *) data_array;
00624     <span class="keywordtype">short</span> currX, currY;
00625     <span class="keywordtype">int</span> barWidth = x_axis_step/(series_num+2);
00626 
00627     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00628         dataArray-=(info.graph_year-2);
00629         dataArray+=HISTORY_YEAR_COUNT;
00630         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; (info.graph_year-2); j++) {
00631             currX = (short)(series_x1 + (j+0.5) * x_axis_step + i * barWidth);
00632             <span class="keywordflow">if</span> (x_axis_pos)
00633                 currY = xAxisPos+(short)(*dataArray * scaleStep/scaleInc);
00634             <span class="keywordflow">else</span>
00635                 currY = xAxisPos-(short)(*dataArray * scaleStep/scaleInc);
00636             vga_back.bar((<span class="keywordtype">int</span>)(currX-0.5*barWidth), currY,
00637                          (<span class="keywordtype">int</span>)(currX+0.5*barWidth)-<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>, xAxisPos,
00638                          series_color[i]);
00639             dataArray++;
00640         }
00641 
00642         <span class="keywordflow">if</span> (value_flag)
00643             draw_value(dataArray-1, vga_back.translate_color(series_color[i]), currX+<a class="code" href="Ogrpdyr_8cpp.html#a9a6">COMMON_OFFSET</a>-(int)(0.3f*x_axis_step), currY-font_ptr-&gt;max_font_height/2, DATA_LONG);
00644     }
00645 }
00646 
00647 <span class="comment">//------------ End of function GraphDoubleBarYear::draw_series_float ------------//</span>
00648 
00649 <span class="comment">//---------- Begin of function GraphDoubleBarYear::draw_value -------------------//</span>
<a name="l00651"></a><a class="code" href="classGraphDoubleBarYear.html#b9">00651</a> <span class="comment">void GraphDoubleBarYear::draw_value(void *value, int color, short x, short y, int dataType) {</span>
00652     <span class="keywordtype">char</span> *valueString;
00653     <span class="keywordflow">switch</span> (data_type_flag) {
00654     <span class="keywordflow">case</span> DATA_FLOAT:
00655         valueString = m.format(*((<span class="keywordtype">float</span> *) value), num_format); <span class="keywordflow">break</span>;
00656     <span class="keywordflow">case</span> DATA_DOUBLE:
00657         valueString = m.format(*((<span class="keywordtype">double</span> *) value), num_format); <span class="keywordflow">break</span>;
00658     <span class="keywordflow">case</span> DATA_INT:
00659         valueString = m.format(*((<span class="keywordtype">int</span> *) value), num_format); <span class="keywordflow">break</span>;
00660     <span class="keywordflow">case</span> DATA_LONG:
00661         valueString = m.format(*((<span class="keywordtype">long</span> *) value), num_format); <span class="keywordflow">break</span>;
00662     }
00663 
00664     <span class="keywordtype">short</span> textHeight = font_ptr-&gt;max_font_height;
00665     <span class="keywordtype">short</span> textWidth = font_ptr-&gt;text_width(valueString) + 1;
00666     <span class="comment">/*  </span>
00667 <span class="comment">        short *bitmap = (short *) sys.common_data_buf;</span>
00668 <span class="comment">        err_when( (2 + textWidth * textHeight) * sizeof(short) &gt; COMMON_DATA_BUF_SIZE );</span>
00669 <span class="comment">        *bitmap++ = textWidth;</span>
00670 <span class="comment">        *bitmap++ = textHeight;</span>
00671 <span class="comment"></span>
00672 <span class="comment">        short *shortPtr = bitmap;</span>
00673 <span class="comment">        for (int i = 0; i &lt; textWidth * textHeight; i++)</span>
00674 <span class="comment">        *shortPtr++ = transparent_code_w;</span>
00675 <span class="comment"></span>
00676 <span class="comment">        font_ptr-&gt;put_to_bufferW(bitmap, textWidth * sizeof(short), 0, 0, valueString);</span>
00677 <span class="comment"></span>
00678 <span class="comment">        shortPtr = bitmap;</span>
00679 <span class="comment">        for (i = 0; i &lt; textWidth * textHeight; i++, shortPtr++)</span>
00680 <span class="comment">        if (*shortPtr != transparent_code_w)</span>
00681 <span class="comment">        *shortPtr = color;</span>
00682 <span class="comment"></span>
00683 <span class="comment">        vga_back.put_bitmapW_trans(x, y, (short *) sys.common_data_buf);</span>
00684 <span class="comment">    */</span>
00685     font_chartsm.put(x+3,y,valueString);
00686 }
00687 
00688 <span class="comment">//---------- End of function GraphDoubleBarYear::draw_value -------------------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:50 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
