<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OHELP.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>OHELP.CPP</h1><a href="OHELP_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OHELP.CPP</span>
00002 <span class="comment">//Description : Object Help</span>
00003 
00004 <span class="preprocessor">#include &lt;<a class="code" href="OHELP_8H.html">OHELP.H</a>&gt;</span>
00005 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00006 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="OSTR_8H.html">OSTR.H</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00009 <span class="comment">//nclude &lt;OMODEID.H&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="OMUSIC_8H.html">OMUSIC.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;OFONT.H&gt;</span>
00012 <span class="preprocessor">#include &lt;<a class="code" href="OIMGRES_8H.html">OIMGRES.H</a>&gt;</span>
00013 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00014 <span class="preprocessor">#include &lt;OIFACE.H&gt;</span>
00015 <span class="preprocessor">#include &lt;<a class="code" href="OGAME_8H.html">OGAME.H</a>&gt;</span>
00016 <span class="comment">//#include &lt;OUNIT.H&gt;</span>
00017 <span class="preprocessor">#include &lt;<a class="code" href="OBOX_8H.html">OBOX.H</a>&gt;</span>
00018 <span class="preprocessor">#include &lt;OMOUSE.H&gt;</span>
00019 <span class="comment">//#include &lt;OREMOTE.H&gt;</span>
00020 <span class="preprocessor">#include &lt;<a class="code" href="OVBROWSE_8H.html">OVBROWSE.H</a>&gt;</span>
00021 <span class="preprocessor">#include &lt;<a class="code" href="OFILETXT_8H.html">OFILETXT.H</a>&gt;</span>
00022 <span class="preprocessor">#include &lt;OCONFIG.H&gt;</span>
00023 <span class="preprocessor">#include &lt;<a class="code" href="OBLOB2W_8H.html">OBLOB2W.H</a>&gt;</span>
00024 
00025 <span class="comment">//---------- Define constant -------------//</span>
00026 
00027 <span class="comment">//#define HELP_BOX_COLOR      (VGA_GRAY+5)</span>
<a name="l00028"></a><a class="code" href="OHELP_8CPP.html#a0">00028</a> <span class="preprocessor">#define HELP_BOX_COLOR      185</span>
00029 <span class="preprocessor"></span>
00030 <span class="comment">//#define HELP_INACTIVE_TIME  ((float) 0.5)             // when the mouse is inactive for one second, display help</span>
00031 
00032 <span class="comment">//##### begin trevor 10-12 #####//</span>
<a name="l00033"></a><a class="code" href="OHELP_8CPP.html#a1">00033</a> <span class="preprocessor">#define HELP_INACTIVE_TIME  ((float) 1.5)         // when the mouse is inactive for one second, display help</span>
00034 <span class="preprocessor"></span><span class="comment">//##### end trevor 10-12 #####//</span>
00035 
00036 <span class="keyword">enum</span> {                                            <span class="comment">// 400</span>
00037     <a class="code" href="OHELP_8CPP.html#a10a2">HELP_SCR_BUF_WIDTH</a>  = 400,
00038     <a class="code" href="OHELP_8CPP.html#a10a3">HELP_SCR_BUF_HEIGHT</a> = 200,                      <span class="comment">// 300</span>
00039     <a class="code" href="OHELP_8CPP.html#a10a4">HELP_SCR_BUF_SIZE</a>   = <a class="code" href="OHELP_8CPP.html#a10a2">HELP_SCR_BUF_WIDTH</a> * <a class="code" href="OHELP_8CPP.html#a10a3">HELP_SCR_BUF_HEIGHT</a>
00040 };
00041 
00042 <span class="keyword">enum</span> { <a class="code" href="OHELP_8CPP.html#a11a5">MSG_LINE_SPACE</a> = 4 };
00043 
00044 <span class="keyword">enum</span> {
00045     <a class="code" href="OHELP_8CPP.html#a12a6">X_MARGIN</a> = 10,
00046     <a class="code" href="OHELP_8CPP.html#a12a7">Y_MARGIN</a> = 6
00047 };
00048 
00049 <span class="keyword">enum</span> {
00050     <a class="code" href="OHELP_8CPP.html#a13a8">MSG_WIN_WIDTH</a>   = 390,
00051     <a class="code" href="OHELP_8CPP.html#a13a9">MSG_HEAD_HEIGHT</a> = 16
00052 };
00053 
00054 <span class="comment">//------- Begin of function Help::Help ----------//</span>
00055 
<a name="l00056"></a><a class="code" href="classHelp.html#a0">00056</a> <a class="code" href="classHelp.html#a0">Help::Help</a>() {
00057     memset( <span class="keyword">this</span>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classHelp.html">Help</a>) );
00058 
00059     <a class="code" href="classHelp.html#m14">help_info_array</a> = (<a class="code" href="structHelpInfo.html">HelpInfo</a>*) <a class="code" href="ALL_8H.html#a5">mem_add</a>( <span class="keyword">sizeof</span>(<a class="code" href="structHelpInfo.html">HelpInfo</a>) * <a class="code" href="OHELP_8H.html#a3a2">MAX_HELP_INFO</a> );
00060 }
00061 
00062 <span class="comment">//------- Begin of function Help::Help ----------//</span>
00063 
00064 <span class="comment">//------- Begin of function Help::~Help ----------//</span>
00065 
<a name="l00066"></a><a class="code" href="classHelp.html#a1">00066</a> <a class="code" href="classHelp.html#a1">Help::~Help</a>() {
00067     <a class="code" href="classHelp.html#a3">deinit</a>();
00068 }
00069 
00070 <span class="comment">//------- Begin of function Help::~Help ----------//</span>
00071 
00072 <span class="comment">//------- Begin of function Help::init ----------//</span>
00073 
<a name="l00074"></a><a class="code" href="classHelp.html#a2">00074</a> <span class="keywordtype">void</span> <a class="code" href="classHelp.html#a2">Help::init</a>(<span class="keywordtype">char</span>* resName) {
00075     <a class="code" href="classString.html">String</a> str;
00076 
00077     str  = <a class="code" href="Gamedef_8h.html#a4">DIR_RES</a>;
00078     str += resName;
00079 
00080     <a class="code" href="classHelp.html#a4">load</a>( str );
00081 
00082     <a class="code" href="classHelp.html#m17">long_save_buf</a>.<a class="code" href="classHelpSaveScreen.html#a2">init</a>();
00083     <a class="code" href="classHelp.html#m18">short_front_buf</a>.<a class="code" href="classHelpSaveScreen.html#a2">init</a>();
00084     <a class="code" href="classHelp.html#m19">short_back_buf</a>.<a class="code" href="classHelpSaveScreen.html#a2">init</a>();
00085 }
00086 
00087 <span class="comment">//------- Begin of function Help::init ----------//</span>
00088 
00089 <span class="comment">//------- Begin of function Help::deinit ----------//</span>
00090 
<a name="l00091"></a><a class="code" href="classHelp.html#a3">00091</a> <span class="keywordtype">void</span> <a class="code" href="classHelp.html#a3">Help::deinit</a>() {
00092     <a class="code" href="classHelp.html#m17">long_save_buf</a>.<a class="code" href="classHelpSaveScreen.html#a3">deinit</a>();
00093     <a class="code" href="classHelp.html#m18">short_front_buf</a>.<a class="code" href="classHelpSaveScreen.html#a3">deinit</a>();
00094     <a class="code" href="classHelp.html#m19">short_back_buf</a>.<a class="code" href="classHelpSaveScreen.html#a3">deinit</a>();
00095 
00096     <span class="keywordflow">if</span>( help_info_array ) {
00097         <a class="code" href="ALL_8H.html#a8">mem_del</a>( <a class="code" href="classHelp.html#m14">help_info_array</a> );
00098         <a class="code" href="classHelp.html#m14">help_info_array</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00099     }
00100 
00101     <span class="keywordflow">if</span>( help_text_buf ) {
00102         <a class="code" href="ALL_8H.html#a8">mem_del</a>( <a class="code" href="classHelp.html#m15">help_text_buf</a> );
00103         <a class="code" href="classHelp.html#m15">help_text_buf</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00104     }
00105 }
00106 
00107 <span class="comment">//------- Begin of function Help::deinit ----------//</span>
00108 
00109 <span class="comment">//------- Begin of function Help::load ----------//</span>
<a name="l00113"></a><a class="code" href="classHelp.html#a4">00113</a> <span class="comment">void Help::load(char* helpFileName) {</span>
00114     <span class="comment">//------ Open the file and allocate buffer -----//</span>
00115 
00116     <a class="code" href="classFileTxt.html">FileTxt</a> fileTxt( helpFileName );
00117 
00118     <span class="keywordtype">int</span> dataSize = fileTxt.<a class="code" href="classFileTxt.html#a10">file_size</a>();
00119 
00120     <span class="keywordflow">if</span>( dataSize &gt; help_text_buf_size ) {
00121         <span class="comment">// allocate a buffer larger than we need for the largest size possible</span>
00122         help_text_buf      = <a class="code" href="ALL_8H.html#a7">mem_resize</a>( help_text_buf, dataSize );
00123         help_text_buf_size = dataSize;
00124     }
00125 
00126     <span class="comment">//-------- read in help info one by one --------//</span>
00127 
00128     <a class="code" href="structHelpInfo.html">HelpInfo</a>* iptr    = help_info_array;
00129     <span class="keywordtype">char</span>*     textPtr = help_text_buf;
00130     <span class="keywordtype">int</span>       readLen, totalReadLen=0;              <span class="comment">// total length of text read into the help_text_buf</span>
00131     <span class="keywordtype">int</span>    loopCount=0;
00132     <span class="keywordtype">char</span>*    tokenStr;
00133 
00134     help_info_count=0;
00135 
00136     first_help_by_help_code = first_help_by_area = -1;
00137     last_help_by_help_code = last_help_by_area = 0;
00138 
00139     <span class="keywordflow">while</span>( !fileTxt.<a class="code" href="classFileTxt.html#a11">is_eof</a>() ) {
00140         <a class="code" href="ALL_8H.html#a0">err_when</a>( loopCount++ &gt; 10000 );
00141 
00142         tokenStr = fileTxt.<a class="code" href="classFileTxt.html#a6">get_token</a>(0);              <span class="comment">// don't advance the pointer</span>
00143 
00144         <span class="keywordflow">if</span>( !tokenStr )
00145             <span class="keywordflow">break</span>;
00146 
00147         <span class="comment">// ##### begin Gilbert 9/9 ######//</span>
00148         iptr-&gt;<a class="code" href="structHelpInfo.html#m0">help_code</a>[0] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;                    <span class="comment">// to identitfy search help text by help_code or coordinate</span>
00149         <span class="comment">// ##### end Gilbert 9/9 ######//</span>
00150 
00151         <span class="comment">//--------- if it's a help code ----------//</span>
00152 
00153         <span class="keywordflow">if</span>( tokenStr[0] &gt;= <span class="charliteral">'A'</span> &amp;&amp; tokenStr[0] &lt;= <span class="charliteral">'Z'</span> ) {
00154             strncpy( iptr-&gt;<a class="code" href="structHelpInfo.html#m0">help_code</a>, tokenStr, iptr-&gt;<a class="code" href="structHelpInfo.html#s2s0">HELP_CODE_LEN</a> );
00155             iptr-&gt;<a class="code" href="structHelpInfo.html#m0">help_code</a>[iptr-&gt;<a class="code" href="structHelpInfo.html#s2s0">HELP_CODE_LEN</a>] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00156 
00157             <span class="comment">// ###### begin Gilbert 9/9 #######//</span>
00158             <span class="keywordflow">if</span>( first_help_by_help_code == -1)
00159                 first_help_by_help_code = help_info_count;
00160             last_help_by_help_code = help_info_count+1; <span class="comment">// record one after last</span>
00161             <span class="comment">// ###### end Gilbert 9/9 #######//</span>
00162         }
00163 
00164         <span class="comment">//------ if it's a help area position ------//</span>
00165 
00166         <span class="keywordflow">else</span> <span class="keywordflow">if</span>( tokenStr[0] &gt;= <span class="charliteral">'0'</span> &amp;&amp; tokenStr[0] &lt;= <span class="charliteral">'9'</span> ) {
00167             iptr-&gt;<a class="code" href="structHelpInfo.html#m1">area800x600_x1</a> = (short) fileTxt.<a class="code" href="classFileTxt.html#a7">get_num</a>();
00168             iptr-&gt;<a class="code" href="structHelpInfo.html#m2">area800x600_y1</a> = (short) fileTxt.<a class="code" href="classFileTxt.html#a7">get_num</a>();
00169             iptr-&gt;<a class="code" href="structHelpInfo.html#m3">area800x600_x2</a> = (short) fileTxt.<a class="code" href="classFileTxt.html#a7">get_num</a>();
00170             iptr-&gt;<a class="code" href="structHelpInfo.html#m4">area800x600_y2</a> = (short) fileTxt.<a class="code" href="classFileTxt.html#a7">get_num</a>();
00171             iptr-&gt;<a class="code" href="structHelpInfo.html#m5">area1024x768_x1</a> = (short) fileTxt.<a class="code" href="classFileTxt.html#a7">get_num</a>();
00172             iptr-&gt;<a class="code" href="structHelpInfo.html#m6">area1024x768_y1</a> = (short) fileTxt.<a class="code" href="classFileTxt.html#a7">get_num</a>();
00173             iptr-&gt;<a class="code" href="structHelpInfo.html#m7">area1024x768_x2</a> = (short) fileTxt.<a class="code" href="classFileTxt.html#a7">get_num</a>();
00174             iptr-&gt;<a class="code" href="structHelpInfo.html#m8">area1024x768_y2</a> = (short) fileTxt.<a class="code" href="classFileTxt.html#a7">get_num</a>();
00175             <span class="comment">// 0 when display for both interfaces</span>
00176             iptr-&gt;<a class="code" href="structHelpInfo.html#m9">monster_human_interface</a> = (short) fileTxt.<a class="code" href="classFileTxt.html#a7">get_num</a>();
00177             <span class="comment">// 1 when display only for monster interface</span>
00178             <span class="comment">// 2 when display only for human interface</span>
00179             <span class="comment">// ###### begin Gilbert 15/9 #######//</span>
00180             <span class="keywordflow">if</span>( first_help_by_area == -1)
00181                 first_help_by_area = help_info_count;
00182             last_help_by_area = help_info_count+1;      <span class="comment">// record one after last</span>
00183             <span class="comment">// ###### end Gilbert 15/9 #######//</span>
00184         }
00185         <span class="keywordflow">else</span>
00186             <a class="code" href="ALL_8H.html#a1">err_here</a>();
00187 
00188         <span class="comment">//---------- next line -----------//</span>
00189 
00190         fileTxt.<a class="code" href="classFileTxt.html#a3">next_line</a>();
00191 
00192         <span class="keywordflow">if</span>( fileTxt.<a class="code" href="classFileTxt.html#a11">is_eof</a>() )
00193             <span class="keywordflow">break</span>;
00194 
00195         <span class="comment">//--------------------------------------------//</span>
00196         <span class="comment">// get help title</span>
00197         <span class="comment">//--------------------------------------------//</span>
00198 
00199         fileTxt.<a class="code" href="classFileTxt.html#a8">read_line</a>( iptr-&gt;<a class="code" href="structHelpInfo.html#m10">help_title</a>, iptr-&gt;<a class="code" href="structHelpInfo.html#s2s1">HELP_TITLE_LEN</a> );
00200 
00201         <span class="comment">//---------------------------------------------------------//</span>
00202         <span class="comment">// get help description</span>
00203         <span class="comment">//---------------------------------------------------------//</span>
00204 
00205         readLen = fileTxt.<a class="code" href="classFileTxt.html#a9">read_paragraph</a>(textPtr, help_text_buf_size-totalReadLen);
00206 
00207         iptr-&gt;<a class="code" href="structHelpInfo.html#m11">help_text_ptr</a> = textPtr;
00208         iptr-&gt;<a class="code" href="structHelpInfo.html#m12">help_text_len</a> = readLen;
00209 
00210         textPtr      += readLen;
00211         totalReadLen += readLen;
00212 
00213         <a class="code" href="ALL_8H.html#a0">err_when</a>( totalReadLen&gt;help_text_buf_size );
00214 
00215         <span class="comment">//----------- next help block -------------//</span>
00216 
00217         fileTxt.<a class="code" href="classFileTxt.html#a3">next_line</a>();                          <span class="comment">// pass the page break line</span>
00218 
00219         help_info_count++;
00220         iptr++;
00221 
00222         <a class="code" href="ALL_8H.html#a0">err_when</a>( help_info_count &gt;= <a class="code" href="OHELP_8H.html#a3a2">MAX_HELP_INFO</a> );
00223     }
00224 
00225     <span class="keywordflow">if</span>( first_help_by_help_code == -1 )
00226         first_help_by_help_code = 0;
00227     <span class="keywordflow">if</span>( first_help_by_area == -1 )
00228         first_help_by_area = 0;
00229 
00230     <a class="code" href="ALL_8H.html#a0">err_when</a>( last_help_by_help_code &gt; help_info_count );
00231     <a class="code" href="ALL_8H.html#a0">err_when</a>( last_help_by_area &gt; help_info_count );
00232 }
00233 
00234 <span class="comment">//--------- End of function Help::load ----------//</span>
00235 
00236 <span class="comment">//----------- Begin of function Help::disp --------//</span>
<a name="l00240"></a><a class="code" href="classHelp.html#a13">00240</a> <span class="comment">void Help::disp() {</span>
00241     <span class="comment">//---- first check if we should disp the help now ------//</span>
00242 
00243     <span class="keywordflow">if</span>( !should_disp() ) {
00244         <span class="comment">// display short help here  // begin ##chwg031199</span>
00245         <span class="comment">//              disp_short_help(&amp;vga_front);</span>
00247 <span class="comment">        help_code[0] = NULL;                          // reset it everytime after displaying, if the mouse is still on the button, help_code will be set again.</span>
00248         custom_help_title[0] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00249         <span class="keywordflow">return</span>;
00250     }
00251 
00252     <span class="keywordtype">int</span> i;
00253     <a class="code" href="structHelpInfo.html">HelpInfo</a>* helpInfo = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00254 
00255     <span class="comment">// ------ button help -------//</span>
00256 
00257     <span class="keywordflow">if</span>( help_code[0] ) {
00258         <span class="comment">//--------- locate the help and display it ----------//</span>
00259 
00260         helpInfo = help_info_array + (i = first_help_by_help_code);
00261         <span class="keywordflow">for</span>( ; i&lt;last_help_by_help_code; i++, helpInfo++ ) {
00262             <span class="keywordflow">if</span>( helpInfo-&gt;<a class="code" href="structHelpInfo.html#m0">help_code</a>[0] == help_code[0] &amp;&amp;
00263                 strcmp( helpInfo-&gt;<a class="code" href="structHelpInfo.html#m0">help_code</a>, help_code )==0 ) {
00264                 <span class="keywordflow">break</span>;
00265             }
00266         }
00267 
00268         <span class="keywordflow">if</span>( i &gt;= last_help_by_help_code )             <span class="comment">// not found</span>
00269             helpInfo = NULL;
00270     }
00271 
00272     <span class="comment">//-------- custom help ---------//</span>
00273 
00274     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( custom_help_title[0] ) {
00275     }
00276 
00277     <span class="comment">//-------- other interface help ---------//</span>
00278 
00279     <span class="keywordflow">else</span> {
00280         <span class="comment">//--------- locate the help and display it ----------//</span>
00281 
00282         <span class="comment">//              switch( current_display_mode.mode_id )</span>
00283         <span class="comment">//              {</span>
00284         <span class="comment">//              case MODE_ID_800x600x16:</span>
00285         helpInfo = help_info_array + (i = first_help_by_area);
00286         <span class="keywordflow">for</span>( ; i&lt;last_help_by_area ; i++, helpInfo++ ) {
00287             <span class="keywordflow">if</span>( !helpInfo-&gt;<a class="code" href="structHelpInfo.html#m0">help_code</a>[0] &amp;&amp; mouse.in_area( helpInfo-&gt;<a class="code" href="structHelpInfo.html#m1">area800x600_x1</a>, helpInfo-&gt;<a class="code" href="structHelpInfo.html#m2">area800x600_y1</a>,
00288                                                           helpInfo-&gt;<a class="code" href="structHelpInfo.html#m3">area800x600_x2</a>, helpInfo-&gt;<a class="code" href="structHelpInfo.html#m4">area800x600_y2</a>)
00289                 <span class="comment">//                                      ( (helpInfo-&gt;monster_human_interface == 1 &amp;&amp; config.race_id &lt; 0) ||</span>
00290                 <span class="comment">//                                              (helpInfo-&gt;monster_human_interface == 2 &amp;&amp; config.race_id &gt; 0) ||</span>
00291                 <span class="comment">//                                              (helpInfo-&gt;monster_human_interface == 0) )</span>
00292                 ) {
00293                 <span class="keywordflow">break</span>;
00294             }
00295         }
00296         <span class="comment">/*                      break;</span>
00297 <span class="comment"></span>
00298 <span class="comment">                                case MODE_ID_1024x768x16:</span>
00299 <span class="comment">                                helpInfo = help_info_array + (i = first_help_by_area);</span>
00300 <span class="comment">                                for( ; i&lt;last_help_by_area ; i++, helpInfo++ )</span>
00301 <span class="comment">                                {</span>
00302 <span class="comment">                                if( !helpInfo-&gt;help_code[0] &amp;&amp; mouse.in_area( helpInfo-&gt;area1024x768_x1, helpInfo-&gt;area1024x768_y1,</span>
00303 <span class="comment">                                helpInfo-&gt;area1024x768_x2, helpInfo-&gt;area1024x768_y2) &amp;&amp;</span>
00304 <span class="comment">                                ( (helpInfo-&gt;monster_human_interface == 1 &amp;&amp; config.race_id &lt; 0) ||</span>
00305 <span class="comment">                                (helpInfo-&gt;monster_human_interface == 2 &amp;&amp; config.race_id &gt; 0) ||</span>
00306 <span class="comment">                                (helpInfo-&gt;monster_human_interface == 0) ) )</span>
00307 <span class="comment">                                {</span>
00308 <span class="comment">                                break;</span>
00309 <span class="comment">                                }</span>
00310 <span class="comment">                                }</span>
00311 <span class="comment">                                break;</span>
00312 <span class="comment">                                default:</span>
00313 <span class="comment">                                err_here();</span>
00314 <span class="comment">                                }</span>
00315 <span class="comment">        */</span>
00316         <span class="keywordflow">if</span>( i &gt;= last_help_by_area )                  <span class="comment">// not found</span>
00317             helpInfo = NULL;
00318     }
00319 
00320     <span class="comment">//-------- button help ---------//</span>
00321 
00322     <span class="keywordflow">if</span>( help_code[0] &amp;&amp; helpInfo ) {
00323         disp_help( help_x, help_y,
00324                    helpInfo-&gt;<a class="code" href="structHelpInfo.html#m10">help_title</a>, helpInfo-&gt;<a class="code" href="structHelpInfo.html#m11">help_text_ptr</a> );
00325 
00326         help_code[0] = NULL;                          <span class="comment">// reset it everytime after displaying, if the mouse is still on the button, help_code will be set again.</span>
00327     }
00328 
00329     <span class="comment">//-------- custom help ---------//</span>
00330 
00331     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( custom_help_title[0] ) {
00332         disp_help(help_x, help_y, custom_help_title, custom_help_detail);
00333         custom_help_title[0] = NULL;
00334     }
00335 
00336     <span class="comment">//-------- other interface help ---------//</span>
00337 
00338     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( helpInfo ) {
00339         <span class="comment">/*              switch( current_display_mode.mode_id )</span>
00340 <span class="comment">                        {</span>
00341 <span class="comment">                        case MODE_ID_800x600x16:</span>
00342 <span class="comment">        */</span>
00343         disp_help( (helpInfo-&gt;<a class="code" href="structHelpInfo.html#m1">area800x600_x1</a>+helpInfo-&gt;<a class="code" href="structHelpInfo.html#m3">area800x600_x2</a>)/2,
00344                    (helpInfo-&gt;<a class="code" href="structHelpInfo.html#m2">area800x600_y1</a>+helpInfo-&gt;<a class="code" href="structHelpInfo.html#m4">area800x600_y2</a>)/2,
00345                    helpInfo-&gt;<a class="code" href="structHelpInfo.html#m10">help_title</a>, helpInfo-&gt;<a class="code" href="structHelpInfo.html#m11">help_text_ptr</a> );
00346         <span class="comment">/*                      break;</span>
00347 <span class="comment"></span>
00348 <span class="comment">                                case MODE_ID_1024x768x16:</span>
00349 <span class="comment">                                disp_help( (helpInfo-&gt;area1024x768_x1+helpInfo-&gt;area1024x768_x2)/2,</span>
00350 <span class="comment">                                (helpInfo-&gt;area1024x768_y1+helpInfo-&gt;area1024x768_y2)/2,</span>
00351 <span class="comment">                                helpInfo-&gt;help_title, helpInfo-&gt;help_text_ptr );</span>
00352 <span class="comment">                                break;</span>
00353 <span class="comment"></span>
00354 <span class="comment">                                default:</span>
00355 <span class="comment">                                err_here();</span>
00356 <span class="comment">                                }</span>
00357 <span class="comment">        */</span>
00358     }
00359 }
00360 
00361 <span class="comment">//------------ End of function Help::disp ----------//</span>
00362 
00363 <span class="comment">//---------- Begin of function Help::disp_help ----------//</span>
<a name="l00369"></a><a class="code" href="classHelp.html#a14">00369</a> <span class="comment">void Help::disp_help(int centerX, int centerY, char* helpTitle, char* helpDetail) {</span>
00370     <span class="keywordflow">if</span>( !config.context_sensitive_help )
00371         <span class="keywordflow">return</span>;
00372 
00373     mouse.hide();
00374 
00375     <span class="comment">//------ calculate the position of the help box ------//</span>
00376 
00377     <span class="keywordtype">int</span> winWidth, winHeight, dispHelpDetail=0;
00378 
00379     <span class="keywordflow">if</span>( helpDetail &amp;&amp; helpDetail[0] &amp;&amp;              <span class="comment">// with detailed help</span>
00380         config.context_sensitive_help ) {               <span class="comment">// Detailed Help</span>
00381         winWidth  = font_san.text_width(helpDetail, -1, <a class="code" href="OHELP_8CPP.html#a13a8">MSG_WIN_WIDTH</a>-<a class="code" href="OHELP_8CPP.html#a12a6">X_MARGIN</a>*2) + <a class="code" href="OHELP_8CPP.html#a12a6">X_MARGIN</a>*2;
00382         <span class="comment">// text_width() must be called before calling text_height()</span>
00383         winHeight = <a class="code" href="OHELP_8CPP.html#a12a7">Y_MARGIN</a>*2 + font_san.height() + 11 + font_san.text_height(<a class="code" href="OHELP_8CPP.html#a11a5">MSG_LINE_SPACE</a>);
00384 
00385         <span class="keywordtype">int</span> titleWidth = font_san.text_width(helpTitle, -1, <a class="code" href="OHELP_8CPP.html#a13a8">MSG_WIN_WIDTH</a>-<a class="code" href="OHELP_8CPP.html#a12a6">X_MARGIN</a>*2) + <a class="code" href="OHELP_8CPP.html#a12a6">X_MARGIN</a>*2;
00386         <span class="keywordflow">if</span>( winWidth &lt; titleWidth )
00387             winWidth = titleWidth;
00388 
00389         dispHelpDetail = 1;
00390     }
00391     <span class="keywordflow">else</span> {                                          <span class="comment">// Help title only</span>
00392         winWidth  = font_san.text_width(helpTitle, -1, <a class="code" href="OHELP_8CPP.html#a13a8">MSG_WIN_WIDTH</a>-<a class="code" href="OHELP_8CPP.html#a12a6">X_MARGIN</a>*2) + <a class="code" href="OHELP_8CPP.html#a12a6">X_MARGIN</a>*2;
00393         winHeight = <a class="code" href="OHELP_8CPP.html#a12a7">Y_MARGIN</a>*2 + font_san.height() + 3;
00394     }
00395 
00396     <span class="comment">//--- if the text is bigger than one text box can hold, use a scrollable text box ---//</span>
00397 
00398     <span class="keywordtype">int</span> x1, y1, x2, y2;
00399 
00400     <span class="keywordflow">if</span>( winWidth * winHeight &gt; <a class="code" href="OHELP_8CPP.html#a10a4">HELP_SCR_BUF_SIZE</a> ) {
00401         x1 = max( 2, centerX - <a class="code" href="OHELP_8CPP.html#a10a2">HELP_SCR_BUF_WIDTH</a>  / 2 );
00402         y1 = max( 2, centerY - <a class="code" href="OHELP_8CPP.html#a10a3">HELP_SCR_BUF_HEIGHT</a> / 2 );
00403 
00404         x2 = x1 + <a class="code" href="OHELP_8CPP.html#a10a2">HELP_SCR_BUF_WIDTH</a> - 1;
00405         y2 = y1 + <a class="code" href="OHELP_8CPP.html#a10a3">HELP_SCR_BUF_HEIGHT</a> - 1;
00406     }
00407     <span class="keywordflow">else</span> {
00408         x1 = max( 2, centerX - winWidth  / 2 );
00409         y1 = max( 2, centerY - winHeight / 2 );
00410 
00411         x2 = x1 + winWidth - 1;
00412         y2 = y1 + winHeight - 1;
00413     }
00414 
00415     <span class="keywordflow">if</span>( x2 &gt;= <a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a> ) {
00416         x2 = <a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a>-10;
00417         x1 = x2-winWidth+1;
00418     }
00419 
00420     <span class="keywordflow">if</span>( y2 &gt;= <a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a> ) {
00421         y2 = <a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a>-3;
00422         y1 = y2-winHeight+1;
00423     }
00424 
00425     <span class="comment">// ######## begin Gilbert 21/12 #######//</span>
00426 
00427     <span class="comment">// -------- hide short help --------//</span>
00428 
00429     <span class="comment">//  hide_short_help(&amp;vga_front);    // ## chwg031199</span>
00430     <span class="comment">//  short_front_buf.rest_scr(&amp;vga_front);  // ## chwg031199</span>
00431     <span class="comment">// ######## end Gilbert 21/12 #######//</span>
00432 
00433     <span class="comment">//------------- save the area --------------//</span>
00434 
00435     <span class="comment">// save the screen to the private buffer in Help</span>
00436     long_save_buf.save_scr( x1, y1, x2, y2 , &amp;vga_front);
00437 
00438     <span class="comment">//------- Draw box (and arrow if specified object) ------//</span>
00439 
00440     <span class="comment">//  vga_front.bar( x1, y1, x2, y2, V_WHITE );</span>
00441 
00442     <span class="comment">//  vga_front.bar( x1, y1, x2, y1+1, HELP_BOX_COLOR );        // Top border</span>
00443     <span class="comment">//  vga_front.bar( x1, y2-1, x2, y2, HELP_BOX_COLOR );        // Bottom border</span>
00444     <span class="comment">//  vga_front.bar( x1, y1, x1+1, y2, HELP_BOX_COLOR );        // Left border</span>
00445     <span class="comment">//  vga_front.bar( x2-1, y1, x2, y2, HELP_BOX_COLOR );        // Right border</span>
00446 
00447     <span class="comment">//vga_front.rect( x1+2, y1+2, x2, y2, 3, V_BLACK );</span>
00448     vga_front.bar( x1, y1, x2-3, y2-3, <a class="code" href="classVgaBuf.html#p3">VgaBuf::color_up</a> );
00449     vga_front.rect( x1, y1, x2-3, y2-3, 3, <a class="code" href="OHELP_8CPP.html#a0">HELP_BOX_COLOR</a> );
00450     <span class="comment">//  vga_front.bar_alpha( x2-2, y1+2, x2, y2-3, 1, V_BLACK );</span>
00451     <span class="comment">//  vga_front.bar_alpha( x1+2, y2-2, x2, y2, 1, V_BLACK );</span>
00452 
00453     vga.use_front();
00454     user_interface.darken( x2-2, y1+2, x2, y2-3);
00455     user_interface.darken( x1+2, y2-2, x2, y2);
00456 
00457     <span class="comment">//--------- disp help detail -----------//</span>
00458 
00459     font_san.put( x1+<a class="code" href="OHELP_8CPP.html#a12a6">X_MARGIN</a>, y1+<a class="code" href="OHELP_8CPP.html#a12a7">Y_MARGIN</a>, helpTitle );
00460 
00461     <span class="keywordflow">if</span>( dispHelpDetail ) {
00462         <span class="keywordtype">int</span> y = y1 + <a class="code" href="OHELP_8CPP.html#a12a7">Y_MARGIN</a> + font_san.height() + 4;
00463 
00464         <span class="comment">// vga_front.bar( x1, y, x2, y+1, HELP_BOX_COLOR );  // line between description and help text</span>
00465         <span class="comment">// line between description and help text</span>
00466         vga_front.bar( x1, y, x2-3, y+1, <a class="code" href="OHELP_8CPP.html#a0">HELP_BOX_COLOR</a> );
00467 
00468         font_san.put_paragraph( x1+<a class="code" href="OHELP_8CPP.html#a12a6">X_MARGIN</a>, y+4, x2-<a class="code" href="OHELP_8CPP.html#a12a6">X_MARGIN</a>+2, y2-<a class="code" href="OHELP_8CPP.html#a12a7">Y_MARGIN</a>, helpDetail, <a class="code" href="OHELP_8CPP.html#a11a5">MSG_LINE_SPACE</a> );
00469     }
00470 
00471     <span class="comment">//  if( sys.debug_session )</span>
00472     sys.blt_virtual_buf();
00473 
00474     <span class="comment">//--- in a single player game, pause the game when a help message is disp_helplayed ---//</span>
00475 
00476     <span class="keywordflow">while</span>( should_disp() ) {
00477         sys.yield();
00478         music.yield();
00479 
00480         mouse.get_event();
00481     }
00482 
00483     long_save_buf.rest_scr();
00484     short_back_buf.rest_scr();                      <span class="comment">// ## chwg031199</span>
00485 
00486     <span class="comment">// ###### begin Gilbert 21/12 #######//</span>
00487     <span class="comment">// ---------- show short help -------//</span>
00488 
00489     <span class="comment">//  disp_short_help(&amp;vga_front);</span>
00490     <span class="comment">// ##### end Gilbert 21/12 #######//</span>
00491 
00492     mouse.show();
00493 
00494     sys.blt_virtual_buf();
00495 }
00496 
00497 <span class="comment">//--------- End of function Help::disp_help ----------//</span>
00498 
00499 <span class="comment">//--------- Begin of function Help::should_disp --------//</span>
<a name="l00501"></a><a class="code" href="classHelp.html#a12">00501</a> <span class="comment">int Help::should_disp() {</span>
00502     <span class="keywordflow">if</span>( !config.context_sensitive_help )
00503         <span class="keywordflow">return</span> 0;
00504 
00505     <span class="keywordflow">if</span>( VBrowse::press_record )
00506         <span class="keywordflow">return</span> 0;
00507 
00508     <span class="keywordflow">if</span>( last_mouse_x==mouse.cur_x &amp;&amp; last_mouse_y==mouse.cur_y &amp;&amp;
00509         !mouse.left_press &amp;&amp; !mouse.right_press &amp;&amp; !mouse.any_click(2) ) {
00510         <span class="keywordflow">if</span>( m.get_time() &gt;= mouse_still_time + <a class="code" href="OHELP_8CPP.html#a1">HELP_INACTIVE_TIME</a> * 1000 ) {
00511             <span class="keywordflow">return</span> 1;
00512         }
00513     }
00514     <span class="keywordflow">else</span> {
00515         last_mouse_x = mouse.cur_x;
00516         last_mouse_y = mouse.cur_y;
00517         mouse_still_time = m.get_time();
00518     }
00519 
00520     <span class="keywordflow">return</span> 0;
00521 }
00522 
00523 <span class="comment">//---------- End of function Help::should_disp ---------//</span>
00524 
00525 <span class="comment">//--------- Begin of function Help::set_help --------//</span>
<a name="l00527"></a><a class="code" href="classHelp.html#a8">00527</a> <span class="comment">void Help::set_help(int x1, int y1, int x2, int y2, char* helpCode) {</span>
00528     <a class="code" href="ALL_8H.html#a0">err_when</a>( strlen(helpCode) &gt; 8 );
00529 
00530     <span class="keywordflow">if</span>( !mouse.in_area(x1, y1, x2, y2) )
00531         <span class="keywordflow">return</span>;
00532 
00533     strcpy( help_code, helpCode );
00534 
00535     help_x = (x1+x2)/2;
00536     help_y = (y1+y2)/2;
00537     help_x1 = x1;
00538     help_y1 = y1;
00539     help_x2 = x2;
00540     help_y2 = y2;
00541 
00542     <span class="comment">//  disp_short_help(&amp;vga_front);</span>
00543 }
00544 
00545 <span class="comment">//---------- End of function Help::set_help ---------//</span>
00546 
00547 <span class="comment">//--------- Begin of function Help::set_help2 --------//</span>
<a name="l00549"></a><a class="code" href="classHelp.html#a9">00549</a> <span class="comment">void Help::set_help2(int x1, int y1, int width, int height, char* helpCode) {</span>
00550     set_help( x1, y1, x1+width-1, y1+height-1, helpCode );
00551 }
00552 
00553 <span class="comment">//---------- End of function Help::set_help2 ---------//</span>
00554 
00555 <span class="comment">//--------- Begin of function Help::set_unit_help --------//</span>
<a name="l00557"></a><a class="code" href="classHelp.html#a10">00557</a> <span class="comment">void Help::set_unit_help(int unitId, int rankId, int x1, int y1, int x2, int y2) {</span>
00558     <span class="keywordflow">if</span>( !mouse.in_area(x1, y1, x2, y2) )
00559         <span class="keywordflow">return</span>;
00560     <span class="comment">/*</span>
00561 <span class="comment">      //-------- compose the help string --------//</span>
00562 <span class="comment"></span>
00563 <span class="comment">      static String str;</span>
00564 <span class="comment"></span>
00565 <span class="comment">      #if(defined(SPANISH) || defined(FRENCH))</span>
00566 <span class="comment">      str = "";</span>
00567 <span class="comment">      if( rankId==RANK_KING )</span>
00568 <span class="comment">      str = translate.process("King ");</span>
00569 <span class="comment">      else if( rankId==RANK_GENERAL )</span>
00570 <span class="comment">      str = translate.process("General ");</span>
00571 <span class="comment">      str += unit_res[unitId]-&gt;name;</span>
00572 <span class="comment">      #else</span>
00573 <span class="comment">      str = unit_res[unitId]-&gt;name;</span>
00574 <span class="comment"></span>
00575 <span class="comment">      //        #if( !defined(GERMAN) &amp;&amp; !defined(FRENCH) &amp;&amp; !defined(SPANISH) )                 // english</span>
00576 <span class="comment">      //                if( rankId&gt;=RANK_GENERAL &amp;&amp; unitId==UNIT_MAYA )</span>
00577 <span class="comment">      //                        str += "n";                     // "Mayan"</span>
00578 <span class="comment">      //        #endif</span>
00579 <span class="comment"></span>
00580 <span class="comment">      if( rankId==RANK_KING )</span>
00581 <span class="comment">      {</span>
00582 <span class="comment">      str += " ";</span>
00583 <span class="comment">      str += translate.process( "King" );</span>
00584 <span class="comment">      }</span>
00585 <span class="comment">      else if( rankId==RANK_GENERAL )</span>
00586 <span class="comment">      {</span>
00587 <span class="comment">      str += " ";</span>
00588 <span class="comment">      str += translate.process( "General" );</span>
00589 <span class="comment">      }</span>
00590 <span class="comment">      #endif</span>
00591 <span class="comment"></span>
00592 <span class="comment">      set_custom_help( x1, y1, x2, y2, str );</span>
00593 <span class="comment">    */</span>
00594 }
00595 
00596 <span class="comment">//---------- End of function Help::set_unit_help ---------//</span>
00597 
00598 <span class="comment">//--------- Begin of function Help::set_custom_help --------//</span>
<a name="l00604"></a><a class="code" href="classHelp.html#a11">00604</a> <span class="comment">void Help::set_custom_help(int x1, int y1, int x2, int y2, char* helpTitle, char* helpDetail) {</span>
00605     <span class="keywordflow">if</span>( !mouse.in_area(x1, y1, x2, y2) )
00606         <span class="keywordflow">return</span>;
00607 
00608     <span class="comment">// ##### begin Gilbert 10/12 ######//</span>
00609     <span class="comment">// clear help code</span>
00610     help_code[0] = <span class="charliteral">'\0'</span>;
00611     <span class="comment">// ##### end Gilbert 10/12 ######//</span>
00612     help_x = (x1+x2)/2;
00613     help_y = (y1+y2)/2;
00614     help_x1 = x1;
00615     help_y1 = y1;
00616     help_x2 = x2;
00617     help_y2 = y2;
00618 
00619     strncpy( custom_help_title, helpTitle, CUSTOM_HELP_TITLE_LEN );
00620     custom_help_title[CUSTOM_HELP_TITLE_LEN] = NULL;
00621 
00622     <span class="keywordflow">if</span>( helpDetail ) {
00623         strncpy( custom_help_detail, helpDetail, CUSTOM_HELP_DETAIL_LEN );
00624         custom_help_detail[CUSTOM_HELP_DETAIL_LEN] = NULL;
00625     }
00626     <span class="keywordflow">else</span> {
00627         custom_help_detail[0] = NULL;
00628     }
00629 
00630     <span class="comment">//  disp_short_help(&amp;vga_front);</span>
00631 }
00632 
00633 <span class="comment">//---------- End of function Help::set_custom_help ---------//</span>
00634 
00635 <span class="comment">//--------- Begin of function Help::disp_short_help --------//</span>
<a name="l00637"></a><a class="code" href="classHelp.html#a15">00637</a> <span class="comment">void Help::disp_short_help(VgaBuf *vgaBuf) {</span>
00638     <span class="comment">// ###### begin Gilbert 9/9 #######//</span>
00639 
00640     <span class="comment">// ----- display help title in short bar under info -------//</span>
00641 
00642     <span class="keywordtype">int</span> i;
00643     <a class="code" href="structHelpInfo.html">HelpInfo</a>* helpInfo = NULL;
00644 
00645     <span class="comment">// ------ button help -------//</span>
00646 
00647     <span class="keywordflow">if</span>( help_code[0] ) {
00648         <span class="comment">//--------- locate the help and display it ----------//</span>
00649 
00650         helpInfo = help_info_array + (i = first_help_by_help_code);
00651         <span class="keywordflow">for</span>( ; i&lt;last_help_by_help_code; i++, helpInfo++ ) {
00652             <span class="keywordflow">if</span>( helpInfo-&gt;<a class="code" href="structHelpInfo.html#m0">help_code</a>[0] == help_code[0] &amp;&amp;
00653                 strcmp( helpInfo-&gt;<a class="code" href="structHelpInfo.html#m0">help_code</a>, help_code )==0 ) {
00654                 <span class="keywordflow">break</span>;
00655             }
00656         }
00657 
00658         <span class="keywordflow">if</span>( i &gt;= last_help_by_help_code )             <span class="comment">// not found</span>
00659             helpInfo = NULL;
00660     }
00661 
00662     <span class="comment">//-------- custom help ---------//</span>
00663 
00664     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( custom_help_title[0] ) {
00665     }
00666 
00667     <span class="comment">//-------- other interface help ---------//</span>
00668 
00669     <span class="keywordflow">else</span> {
00670         <span class="comment">//--------- locate the help and display it ----------//</span>
00671 
00672         <span class="comment">//switch( current_display_mode.mode_id )</span>
00673         <span class="comment">//{</span>
00674         <span class="comment">//case MODE_ID_800x600x16:</span>
00675         helpInfo = help_info_array + (i = first_help_by_area);
00676         <span class="keywordflow">for</span>( ; i&lt;last_help_by_area ; i++, helpInfo++ ) {
00677             <span class="keywordflow">if</span>( !helpInfo-&gt;<a class="code" href="structHelpInfo.html#m0">help_code</a>[0] &amp;&amp; mouse.in_area( helpInfo-&gt;<a class="code" href="structHelpInfo.html#m1">area800x600_x1</a>, helpInfo-&gt;<a class="code" href="structHelpInfo.html#m2">area800x600_y1</a>,
00678                                                           helpInfo-&gt;<a class="code" href="structHelpInfo.html#m3">area800x600_x2</a>, helpInfo-&gt;<a class="code" href="structHelpInfo.html#m4">area800x600_y2</a>)) {
00679                 <span class="comment">//                                      &amp;&amp;</span>
00680                 <span class="comment">//                      ( (helpInfo-&gt;monster_human_interface == 1 &amp;&amp; config.race_id &lt; 0) ||</span>
00681                 <span class="comment">//                              (helpInfo-&gt;monster_human_interface == 2 &amp;&amp; config.race_id &gt; 0) ||</span>
00682                 <span class="comment">//                              (helpInfo-&gt;monster_human_interface == 0) ) )</span>
00683                 help_x1 = helpInfo-&gt;<a class="code" href="structHelpInfo.html#m1">area800x600_x1</a>;
00684                 help_y1 = helpInfo-&gt;<a class="code" href="structHelpInfo.html#m2">area800x600_y1</a>;
00685                 help_x2 = helpInfo-&gt;<a class="code" href="structHelpInfo.html#m3">area800x600_x2</a>;
00686                 help_y2 = helpInfo-&gt;<a class="code" href="structHelpInfo.html#m4">area800x600_y2</a>;
00687                 <span class="keywordflow">break</span>;
00688             }
00689         }
00690         <span class="comment">/*                      break;</span>
00691 <span class="comment"></span>
00692 <span class="comment">                                //case MODE_ID_1024x768x16:</span>
00693 <span class="comment">                                helpInfo = help_info_array + (i = first_help_by_area);</span>
00694 <span class="comment">                                for( ; i&lt;last_help_by_area ; i++, helpInfo++ )</span>
00695 <span class="comment">                                {</span>
00696 <span class="comment">                                if( !helpInfo-&gt;help_code[0] &amp;&amp; mouse.in_area( helpInfo-&gt;area1024x768_x1, helpInfo-&gt;area1024x768_y1,</span>
00697 <span class="comment">                                helpInfo-&gt;area1024x768_x2, helpInfo-&gt;area1024x768_y2) &amp;&amp;</span>
00698 <span class="comment">                                //                      ( (helpInfo-&gt;monster_human_interface == 1 &amp;&amp; config.race_id &lt; 0) ||</span>
00699 <span class="comment">                                //                              (helpInfo-&gt;monster_human_interface == 2 &amp;&amp; config.race_id &gt; 0) ||</span>
00700 <span class="comment">                                //                              (helpInfo-&gt;monster_human_interface == 0) ) )</span>
00701 <span class="comment">                                {</span>
00702 <span class="comment">                                help_x1 = helpInfo-&gt;area1024x768_x1;</span>
00703 <span class="comment">                                help_y1 = helpInfo-&gt;area1024x768_y1;</span>
00704 <span class="comment">                                help_x2 = helpInfo-&gt;area1024x768_x2;</span>
00705 <span class="comment">                                help_y2 = helpInfo-&gt;area1024x768_y2;</span>
00706 <span class="comment">                                break;</span>
00707 <span class="comment">                                }</span>
00708 <span class="comment">                                }</span>
00709 <span class="comment">                                //      break;</span>
00710 <span class="comment">                                //default:</span>
00711 <span class="comment">                                //      err_here();</span>
00712 <span class="comment">                                //}</span>
00713 <span class="comment">        */</span>
00714         <span class="keywordflow">if</span>( i &gt;= last_help_by_area )                  <span class="comment">// not found</span>
00715             helpInfo = NULL;
00716     }
00717 
00718     <span class="comment">// ------ backup active_buf, use_back_buf ------//</span>
00719 
00720     <span class="keywordtype">char</span> *titleStr = NULL;
00721 
00722     <span class="keywordflow">if</span>( helpInfo ) {
00723         titleStr = helpInfo-&gt;<a class="code" href="structHelpInfo.html#m10">help_title</a>;
00724     }
00725     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( custom_help_title[0] ) {
00726         titleStr = custom_help_title;
00727     }
00728 
00729     <span class="keywordflow">if</span>( titleStr ) {
00730         <span class="keywordtype">short</span> x1, y1, x2, y2;                         <span class="comment">// top left corner of the area</span>
00731         <span class="comment">//#### begin trevor 10-12 #####//</span>
00732         <span class="keywordtype">int</span> textWidth = font_san.text_width(titleStr) + <a class="code" href="OHELP_8CPP.html#a12a6">X_MARGIN</a>*2;
00733         <span class="keywordtype">int</span> textHeight = font_san.text_height() + <a class="code" href="OHELP_8CPP.html#a12a7">Y_MARGIN</a>*2;
00734         <span class="comment">//#### begin trevor 10-12 #####//</span>
00735         x2 = help_x1 - 1;
00736         y2 = help_y1 - 1;
00737         x1 = x2 - textWidth + 1;
00738         y1 = y2 - textHeight + 1;
00739         <span class="keywordflow">if</span>( y1 &lt; 0 ) {
00740             <span class="comment">// try top border</span>
00741             y1 = 0;
00742             y2 = y1 + textHeight - 1;
00743         }
00744         <span class="keywordflow">if</span>( x1 &lt; 0 ) {
00745             <span class="comment">// try right side</span>
00746             x1 = help_x2 + 1;
00747             x2 = x1 + textWidth - 1;
00748         }
00749 
00750         vga.use_back();
00751         <span class="keywordflow">if</span>(short_back_buf.save_scr_buf)
00752             short_back_buf.rest_scr();                  <span class="comment">// ## chwg031199</span>
00753 
00754         <span class="comment">// save buffer</span>
00755 
00756         <span class="comment">//              (vgaBuf-&gt;is_front ? short_front_buf : short_back_buf).save_scr( x1, y1, x2, y2, vgaBuf );// ## chwg031199</span>
00757 
00758         <span class="comment">// ## chwg031199</span>
00759         short_back_buf.save_scr( x1, y1, x2, y2, &amp;vga_front );
00760 
00761         <span class="keywordflow">if</span>( config.context_sensitive_help ) {
00762             <span class="comment">// for safety, still capture the screen even though short help is not displayed</span>
00763             <span class="comment">// may cause problem when changing help_mode</span>
00764 
00765             <span class="comment">// put text</span>
00766 
00767             <span class="comment">// vgaBuf-&gt;bar(x1, y1, x2, y2, V_WHITE);</span>
00768             <span class="comment">// vgaBuf-&gt;rect(x1, y1, x2, y2, 1, V_BLACK);</span>
00769             vgaBuf-&gt;bar( x1, y1, x2-3, y2-3, <a class="code" href="classVgaBuf.html#p3">VgaBuf::color_up</a> );
00770             vgaBuf-&gt;rect( x1, y1, x2-3, y2-3, 3, <a class="code" href="OHELP_8CPP.html#a0">HELP_BOX_COLOR</a> );
00771             font_san.center_put( x1, y1, x2-3, y2-3, titleStr );
00772 
00773             <span class="comment">//                  vgaBuf-&gt;bar_alpha( x2-2, y1+2, x2, y2-3, 1, V_BLACK );</span>
00774             <span class="comment">//                  vgaBuf-&gt;bar_alpha( x1+2, y2-2, x2, y2, 1, V_BLACK );</span>
00775 
00776             <span class="comment">/*</span>
00777 <span class="comment">              char useBackFlag = vga.use_back_buf;      //save use_back_buf</span>
00778 <span class="comment">              VgaBuf *activeBuf = vga.active_buf;</span>
00779 <span class="comment"></span>
00780 <span class="comment">              vga.use_back_buf = !vgaBuf-&gt;is_front;</span>
00781 <span class="comment">              vga.active_buf = vgaBuf;</span>
00782 <span class="comment"></span>
00783 <span class="comment">              vga.use_back_buf = useBackFlag;   // restore use_back_buf</span>
00784 <span class="comment">              vga.active_buf = activeBuf;</span>
00785 <span class="comment">            */</span>
00786             vga.blt_buf(x1,y1,x2,y2);
00787             sys.blt_virtual_buf();
00788         }
00789     }
00790     <span class="comment">// ###### end Gilbert 9/9 #######//</span>
00791 }
00792 
00793 <span class="comment">//--------- End of function Help::disp_short_help --------//</span>
00794 
00795 <span class="comment">//--------- Begin of function Help::flip --------//</span>
<a name="l00797"></a><a class="code" href="classHelp.html#a19">00797</a> <span class="comment">void Help::flip() {</span>
00798 <span class="preprocessor">#if(defined(USE_FLIP))</span>
00799 <span class="preprocessor"></span>
00800     <span class="comment">// ------ called when flip page ------//</span>
00801 
00802     <span class="comment">// exchange front and back save buf</span>
00803 
00804     short_front_buf.swap(short_back_buf);
00805 <span class="preprocessor">#endif</span>
00806 <span class="preprocessor"></span>
00807 }
00808 
00809 <span class="comment">//--------- End of function Help::flip --------//</span>
00810 
00811 <span class="comment">//--------- Begin of function Help::hide_short_help --------//</span>
<a name="l00813"></a><a class="code" href="classHelp.html#a16">00813</a> <span class="comment">void Help::hide_short_help(VgaBuf *vgaBuf) {</span>
00814     (vgaBuf-&gt;is_front ? short_front_buf : short_back_buf).rest_scr(vgaBuf);
00815 }
00816 
00817 <span class="comment">//--------- End of function Help::hide_short_help --------//</span>
00818 
00819 <span class="comment">//--------- Begin of function Help::hide_area --------//</span>
<a name="l00821"></a><a class="code" href="classHelp.html#a17">00821</a> <span class="comment">void Help::hide_area(int x1, int y1, int x2, int y2) {</span>
00822     <span class="comment">// updating front buffer, hide the area first</span>
00823 
00824     <span class="keywordflow">if</span>( !short_front_buf.is_clear() ) {
00825         short_front_buf.hide_area(x1, y1, x2, y2);
00826     }
00827 }
00828 
00829 <span class="comment">//--------- End of function Help::hide_area --------//</span>
00830 
00831 <span class="comment">//--------- Begin of function Help::show_area --------//</span>
<a name="l00833"></a><a class="code" href="classHelp.html#a18">00833</a> <span class="comment">void Help::show_area() {</span>
00834     <span class="comment">// updating front buffer, hide the area first</span>
00835 
00836     <span class="keywordflow">if</span>( !short_front_buf.is_clear() ) {
00837         short_front_buf.show_area();
00838     }
00839 }
00840 
00841 <span class="comment">//--------- End of function Help::show_area --------//</span>
00842 
00843 <span class="comment">//--------- Begin of function HelpSaveScreen::HelpSaveScreen --------//</span>
<a name="l00845"></a><a class="code" href="classHelpSaveScreen.html#a0">00845</a> <span class="comment">HelpSaveScreen::HelpSaveScreen() {</span>
00846     save_scr_buf = NULL;
00847     clear();
00848 }
00849 
00850 <span class="comment">//--------- End of function HelpSaveScreen::HelpSaveScreen --------//</span>
00851 
00852 <span class="comment">//--------- Begin of function HelpSaveScreen::~HelpSaveScreen --------//</span>
<a name="l00854"></a><a class="code" href="classHelpSaveScreen.html#a1">00854</a> <span class="comment">HelpSaveScreen::~HelpSaveScreen() {</span>
00855     deinit();
00856 }
00857 
00858 <span class="comment">//--------- End of function HelpSaveScreen::~HelpSaveScreen --------//</span>
00859 
00860 <span class="comment">//--------- Begin of function HelpSaveScreen::init --------//</span>
<a name="l00862"></a><a class="code" href="classHelpSaveScreen.html#a2">00862</a> <span class="comment">void HelpSaveScreen::init() {</span>
00863     deinit();
00864 
00865     hiding_flag = 0;
00866     hide_area_count = 0;
00867     save_scr_buf = <span class="keyword">new</span> <a class="code" href="classBlob2DW.html">Blob2DW</a>;
00868     clear();
00869 }
00870 
00871 <span class="comment">//--------- End of function HelpSaveScreen::init --------//</span>
00872 
00873 <span class="comment">//--------- Begin of function HelpSaveScreen::deinit --------//</span>
<a name="l00875"></a><a class="code" href="classHelpSaveScreen.html#a3">00875</a> <span class="comment">void HelpSaveScreen::deinit() {</span>
00876     clear();
00877     <span class="keywordflow">if</span>( save_scr_buf ) {
00878         <span class="keyword">delete</span> save_scr_buf;
00879         save_scr_buf = NULL;
00880     }
00881 }
00882 
00883 <span class="comment">//--------- End of function HelpSaveScreen::deinit --------//</span>
00884 
00885 <span class="comment">//--------- Begin of function HelpSaveScreen::swap --------//</span>
<a name="l00887"></a><a class="code" href="classHelpSaveScreen.html#a4">00887</a> <span class="comment">void HelpSaveScreen::swap( HelpSaveScreen &amp;s) {</span>
00888     <span class="comment">// memory swap</span>
00889 
00890     <span class="keywordtype">char</span> t[<span class="keyword">sizeof</span>(HelpSaveScreen)];
00891     memcpy( t, <span class="keyword">this</span>, <span class="keyword">sizeof</span>(<a class="code" href="classHelpSaveScreen.html">HelpSaveScreen</a>) );
00892     memcpy( <span class="keyword">this</span>, &amp;s, <span class="keyword">sizeof</span>(<a class="code" href="classHelpSaveScreen.html">HelpSaveScreen</a>) );
00893     memcpy( &amp;s, t, <span class="keyword">sizeof</span>(<a class="code" href="classHelpSaveScreen.html">HelpSaveScreen</a>) );
00894 }
00895 
00896 <span class="comment">//--------- End of function HelpSaveScreen::swap --------//</span>
00897 
00898 <span class="comment">//--------- Begin of function HelpSaveScreen::save_scr --------//</span>
<a name="l00900"></a><a class="code" href="classHelpSaveScreen.html#a5">00900</a> <span class="comment">void HelpSaveScreen::save_scr(int x1, int y1, int x2, int y2, VgaBuf* vgaBuf ) {</span>
00901     <span class="keywordflow">if</span>( !is_clear() )                               <span class="comment">// there is already a screen saved</span>
00902         <span class="keywordflow">return</span>;
00903 
00904     <a class="code" href="ALL_8H.html#a0">err_when</a>( x1&gt;x2 || y1&gt;y2 || x1&lt;0 || y1&lt;0 || x2&gt;=<a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a> || y2&gt;=<a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a> );
00905 
00906     <span class="keywordtype">long</span> saveSize = (long)(x2-x1+1) * (y2-y1+1);
00907 
00908     <a class="code" href="ALL_8H.html#a0">err_when</a>( saveSize &gt; <a class="code" href="OHELP_8CPP.html#a10a4">HELP_SCR_BUF_SIZE</a> );
00909 
00910     <span class="keywordflow">if</span>( !vgaBuf )
00911         vgaBuf = &amp;vga_front;
00912 
00913     save_scr_x1 = x1;
00914     save_scr_y1 = y1;
00915     save_scr_x2 = x2;
00916     save_scr_y2 = y2;
00917 
00918     <span class="keywordflow">if</span>( vgaBuf-&gt;is_front )
00919         mouse.hide_area( x1, y1, x2, y2 );
00920 
00921     save_scr_buf-&gt;clear();
00922     save_scr_buf-&gt;resize( x1, y1, x2-x1+1, y2-y1+1 );
00923     vgaBuf-&gt;read_bitmapW( x1, y1, x2, y2, save_scr_buf-&gt;bitmap_ptr() );
00924 
00925     <span class="keywordflow">if</span>( vgaBuf-&gt;is_front )
00926         mouse.show_area();
00927 
00928     unclear();
00929 }
00930 
00931 <span class="comment">//--------- End of function HelpSaveScreen::save_scr --------//</span>
00932 
00933 <span class="comment">//--------- Begin of function HelpSaveScreen::rest_scr --------//</span>
<a name="l00935"></a><a class="code" href="classHelpSaveScreen.html#a6">00935</a> <span class="comment">void HelpSaveScreen::rest_scr(VgaBuf* vgaBuf, int keepUnclear ) {</span>
00936     <span class="keywordflow">if</span>( is_clear() )                                <span class="comment">// already restored, or not saved yet</span>
00937         <span class="keywordflow">return</span>;
00938 
00939     <a class="code" href="ALL_8H.html#a0">err_when</a>( save_scr_x1&gt;save_scr_x2 || save_scr_y1&gt;save_scr_y2 ||
00940               save_scr_x1&lt;0 || save_scr_y1&lt;0 || save_scr_x2&gt;=<a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a> || save_scr_y2&gt;=<a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a> );
00941 
00942     <span class="keywordflow">if</span>( !vgaBuf )
00943         vgaBuf = &amp;vga_front;
00944 
00945     <span class="comment">//  mouse.hide_area( save_scr_x1, save_scr_y1, save_scr_x2, save_scr_y2 );</span>
00946 
00947     vgaBuf-&gt;put_bitmapW( save_scr_x1, save_scr_y1, save_scr_buf-&gt;bitmap_ptr() );
00948 
00949     <span class="comment">//  mouse.show_area();</span>
00950 
00951     <span class="keywordflow">if</span>( !keepUnclear )
00952         clear();                                      <span class="comment">// state that it has been restored.</span>
00953 }
00954 
00955 <span class="comment">//--------- End of function HelpSaveScreen::rest_scr --------//</span>
00956 
00957 <span class="comment">//--------- Begin of function HelpSaveScreen::hide_area --------//</span>
<a name="l00959"></a><a class="code" href="classHelpSaveScreen.html#a7">00959</a> <span class="comment">void HelpSaveScreen::hide_area(int x1, int y1, int x2, int y2 ) {</span>
00960     <span class="keywordflow">if</span>( is_clear() )                                <span class="comment">// there is already a screen saved</span>
00961         <span class="keywordflow">return</span>;
00962 
00963     ++hide_area_count;
00964 
00965     <span class="keywordflow">if</span>( !hiding_flag &amp;&amp; m.is_touch( x1, y1, x2, y2,
00966                                     save_scr_x1, save_scr_y1, save_scr_x2, save_scr_y2 ) ) {
00967         <span class="comment">// don't handle mouse cursor</span>
00968         vga.active_buf-&gt;put_bitmapW( save_scr_x1, save_scr_y1, save_scr_buf-&gt;bitmap_ptr() );
00969 
00970         hiding_flag = hide_area_count;
00971     }
00972 }
00973 
00974 <span class="comment">//--------- End of function HelpSaveScreen::hide_area --------//</span>
00975 
00976 <span class="comment">//--------- Begin of function HelpSaveScreen::show_area --------//</span>
<a name="l00978"></a><a class="code" href="classHelpSaveScreen.html#a8">00978</a> <span class="comment">void HelpSaveScreen::show_area() {</span>
00979     <span class="keywordflow">if</span>( is_clear() )                                <span class="comment">// already restored, or not saved yet</span>
00980         <span class="keywordflow">return</span>;
00981 
00982     <span class="keywordflow">if</span>( hiding_flag &amp;&amp; hiding_flag == hide_area_count ) {
00983         vga_front.read_bitmapW( save_scr_x1, save_scr_y1, save_scr_x2, save_scr_y2,
00984                                 save_scr_buf-&gt;bitmap_ptr() );
00985         hiding_flag = 0;
00986     }
00987     --hide_area_count;
00988     <a class="code" href="ALL_8H.html#a0">err_when</a>( hide_area_count &lt; 0 );
00989 }
00990 
00991 <span class="comment">//--------- End of function HelpSaveScreen::show_area --------//</span>
00992 
00993 <span class="comment">//--------- Begin of function HelpSaveScreen::clear --------//</span>
<a name="l00995"></a><a class="code" href="classHelpSaveScreen.html#a9">00995</a> <span class="comment">void HelpSaveScreen::clear() {</span>
00996     clear_flag = 1;
00997 }
00998 
00999 <span class="comment">//--------- End of function HelpSaveScreen::clear --------//</span>
01000 
01001 <span class="comment">//--------- Begin of function HelpSaveScreen::unclear --------//</span>
<a name="l01003"></a><a class="code" href="classHelpSaveScreen.html#a10">01003</a> <span class="comment">void HelpSaveScreen::unclear() {</span>
01004     clear_flag = 0;
01005 }
01006 
01007 <span class="comment">//--------- End of function HelpSaveScreen::unclear --------//</span>
01008 
01009 <span class="comment">//--------- Begin of function HelpSaveScreen::is_clear --------//</span>
<a name="l01011"></a><a class="code" href="classHelpSaveScreen.html#a11">01011</a> <span class="comment">int HelpSaveScreen::is_clear() {</span>
01012     <span class="keywordflow">return</span> clear_flag;
01013 }
01014 
01015 <span class="comment">//--------- End of function HelpSaveScreen::is_clear --------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:58 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
