<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>omouse.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>omouse.cpp</h1><a href="omouse_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OMOUSE.CPP</span>
00002 <span class="comment">//Description : Mouse handling Object</span>
00003 
00004 <span class="preprocessor">#if( !defined(GERMAN) &amp;&amp; !defined(FRENCH) &amp;&amp; !defined(SPANISH))</span>
00005 <span class="preprocessor"></span>
00006 <span class="preprocessor">#include &lt;OMOUSE.H&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="OPOWER_8H.html">OPOWER.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;<a class="code" href="OMOUSECR_8H.html">OMOUSECR.H</a>&gt;</span>
00012 <span class="preprocessor">#include &lt;<a class="code" href="OMOUSE2_8H.html">OMOUSE2.H</a>&gt;</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="KEY_8H.html">KEY.H</a>&gt;</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="OVGALOCK_8H.html">OVGALOCK.H</a>&gt;</span>
00015 
00016 <span class="comment">//--- define the size of a buffer for real-time vga screen updating ---//</span>
00017 
00018                                                   <span class="comment">// 100 x 100</span>
<a name="l00019"></a><a class="code" href="omouse_8cpp.html#a0">00019</a> <span class="preprocessor">#define VGA_UPDATE_BUF_SIZE (100*100*sizeof(short))</span>
00020 <span class="preprocessor"></span>
00021 <span class="comment">//--------- Define Click Threshold -----------//</span>
00022 <span class="comment">//</span>
00023 <span class="comment">// Clock tick is incremented 1000 times per second or once per millisecond.</span>
00024 <span class="comment">//</span>
00025 <span class="comment">// The minimum time interval between consequent mouse click is set to</span>
00026 <span class="comment">// = 0.3 seconds</span>
00027 <span class="comment">//</span>
00028 <span class="comment">//--------------------------------------------//</span>
00029 
00030 <span class="keyword">static</span> DWORD click_threshold = (LONG)(0.3 * 1000);
00031 
00032 <span class="comment">//------- Define static functions -----------//</span>
00033 
00034 LRESULT CALLBACK <a class="code" href="omouse_8cpp.html#a11">key_hook_proc</a>(<span class="keywordtype">int</span> nCode, <a class="code" href="OCOLTBL_8H.html#a2">WORD</a> wParam, LONG lParam);
00035 <span class="comment">// static unsigned translate_key(unsigned scanCode, unsigned short skeyState);</span>
00036 
00037 <span class="comment">//------- define constant --------//</span>
00038 
<a name="l00039"></a><a class="code" href="omouse_8cpp.html#a1">00039</a> <span class="preprocessor">#define MOUSE_BUFFER_SIZE 100</span>
<a name="l00040"></a><a class="code" href="omouse_8cpp.html#a2">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define KEYB_BUFFER_SIZE 16</span>
<a name="l00041"></a><a class="code" href="omouse_8cpp.html#a3">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define DOUBLE_SPEED_THREHOLD 8</span>
00042 <span class="preprocessor"></span>
00043 <span class="comment">//------- define static storage -----------//</span>
00044 
00045 <span class="keyword">static</span> DIDEVICEOBJECTDATA mouse_data[<a class="code" href="omouse_8cpp.html#a1">MOUSE_BUFFER_SIZE</a>];
00046 <span class="keyword">static</span> DIDEVICEOBJECTDATA keyb_data[<a class="code" href="omouse_8cpp.html#a2">KEYB_BUFFER_SIZE</a>];
00047 <span class="comment">// coordination of the last double-buffer update area</span>
00048 <span class="keyword">static</span> <span class="keywordtype">int</span> update_x1, update_y1, update_x2, update_y2;
00049 
00050 <span class="comment">//--------- Start of Mouse::Mouse ---------//</span>
00051 <span class="comment">//</span>
<a name="l00052"></a><a class="code" href="classMouse.html#a0">00052</a> <a class="code" href="classMouse.html#a0">Mouse::Mouse</a>() {
00053     memset( <span class="keyword">this</span>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classMouse.html">Mouse</a>) );
00054     <a class="code" href="classMouse.html#m16">double_speed_threshold</a> = <a class="code" href="Omouse_8h.html#a19">DEFAULT_DOUBLE_SPEED_THRESHOLD</a>;
00055     <a class="code" href="classMouse.html#m17">triple_speed_threshold</a> = <a class="code" href="Omouse_8h.html#a20">DEFAULT_TRIPLE_SPEED_THRESHOLD</a>;
00056 }
00057 
00058 <span class="comment">//---------- End of Mouse::Mouse ---------//</span>
00059 
00060 <span class="comment">//---------- Begin of Mouse::~Mouse --------//</span>
00061 <span class="comment">//</span>
00062 <span class="comment">// Deinitialize the mouse driver, reset event handler</span>
00063 <span class="comment">//</span>
<a name="l00064"></a><a class="code" href="classMouse.html#a1">00064</a> <a class="code" href="classMouse.html#a1">Mouse::~Mouse</a>() {
00065     <a class="code" href="classMouse.html#a3">deinit</a>();
00066 }
00067 
00068 <span class="comment">//------------ End of Mouse::~Mouse --------//</span>
00069 
00070 <span class="comment">//------------ Start of Mouse::init ------------//</span>
00071 <span class="comment">//</span>
<a name="l00072"></a><a class="code" href="classMouse.html#a2">00072</a> <span class="keywordtype">void</span> <a class="code" href="classMouse.html#a2">Mouse::init</a>(HINSTANCE hinst, HWND hwnd, LPDIRECTINPUT createdDirectInput) {
00073     <span class="comment">//-------- set starting position ---------//</span>
00074 
00075     POINT pt;
00076 
00077     GetCursorPos(&amp;pt);
00078 
00079     <a class="code" href="classMouse.html#m7">cur_x</a> = pt.x;
00080     <a class="code" href="classMouse.html#m8">cur_y</a> = pt.y;
00081 
00082     <span class="comment">/*</span>
00083 <span class="comment">      //------ install keyboard hook ---------//</span>
00084 <span class="comment"></span>
00085 <span class="comment">      key_hook_handle = SetWindowsHookEx(WH_KEYBOARD, (HOOKPROC) key_hook_proc, sys.app_hinstance, NULL);</span>
00086 <span class="comment"></span>
00087 <span class="comment">      if( !key_hook_handle )</span>
00088 <span class="comment">      err.run( "Failed installing keyboard hook." );</span>
00089 <span class="comment">    */</span>
00090     <span class="comment">//-------- initialize DirectInput Mouse device--------//</span>
00091     <span class="comment">/*</span>
00092 <span class="comment">      direct_mouse_handle = DMouseOpen();</span>
00093 <span class="comment"></span>
00094 <span class="comment">      if( !direct_mouse_handle )</span>
00095 <span class="comment">      err.run( "Failed installing direct mouse." );</span>
00096 <span class="comment">    */</span>
00097     HRESULT hr;
00098     <span class="keywordflow">if</span>( createdDirectInput ) {
00099         <a class="code" href="classMouse.html#m4">direct_input</a> = createdDirectInput;
00100         hr = <a class="code" href="classMouse.html#m4">direct_input</a>-&gt;AddRef();
00101     }
00102     <span class="keywordflow">else</span> {
00103         hr = DirectInputCreate(hinst, <a class="code" href="Omouse_8h.html#a0">DIRECTINPUT_VERSION</a>, &amp;<a class="code" href="classMouse.html#m4">direct_input</a>, <a class="code" href="OHELP_8H.html#a0">NULL</a>);
00104     }
00105     <span class="keywordflow">if</span>(hr)
00106         err.run( <span class="stringliteral">"Failed creating DirectInput"</span>); {
00107 
00108         <span class="comment">// ####### begin Gilbert 12/9 #######//</span>
00109         <a class="code" href="classVgaFrontLock.html">VgaFrontLock</a> vgaLock;
00110         hr = <a class="code" href="classMouse.html#m4">direct_input</a>-&gt;CreateDevice(GUID_SysMouse,&amp;<a class="code" href="classMouse.html#m5">di_mouse_device</a>,<a class="code" href="OHELP_8H.html#a0">NULL</a>);
00111     }
00112     <span class="comment">// ####### end Gilbert 12/9 #######//</span>
00113 
00114     <span class="keywordflow">if</span>(hr)
00115         err.run( <span class="stringliteral">"Failed creating mouse interface from DirectInput"</span>);
00116 
00117     <span class="comment">// ------- set cooperative level --------//</span>
00118     <span class="keywordflow">if</span>( sys.use_true_front == 2 )                   <span class="comment">// window mode</span>
00119         hr = <a class="code" href="classMouse.html#m5">di_mouse_device</a>-&gt;SetCooperativeLevel(hwnd, DISCL_FOREGROUND | DISCL_NONEXCLUSIVE);
00120     <span class="keywordflow">else</span>
00121         hr = <a class="code" href="classMouse.html#m5">di_mouse_device</a>-&gt;SetCooperativeLevel(hwnd, DISCL_FOREGROUND | DISCL_EXCLUSIVE);
00122 
00123     <span class="comment">// ------- set data format ---------//</span>
00124     <span class="keywordflow">if</span>(!hr)
00125         hr = <a class="code" href="classMouse.html#m5">di_mouse_device</a>-&gt;SetDataFormat(&amp;c_dfDIMouse);
00126 
00127     <span class="comment">// ------- set relative coordinate mode --------//</span>
00128     <span class="comment">// DirectInput default is relative</span>
00129     <span class="keywordflow">if</span>(!hr) {
00130         DIPROPDWORD propDword;
00131         propDword.diph.dwSize = <span class="keyword">sizeof</span>(DIPROPDWORD);
00132         propDword.diph.dwHeaderSize = <span class="keyword">sizeof</span>(DIPROPHEADER);
00133         propDword.diph.dwHow = DIPH_DEVICE;           <span class="comment">// Entire device</span>
00134         propDword.diph.dwObj =  0;                    <span class="comment">// Entire device, so zero</span>
00135         propDword.dwData = DIPROPAXISMODE_REL;
00136         hr = <a class="code" href="classMouse.html#m5">di_mouse_device</a>-&gt;SetProperty(DIPROP_AXISMODE, &amp;propDword.diph);
00137     }
00138 
00139     <span class="comment">// ------- set buffer size --------//</span>
00140     <span class="keywordflow">if</span>(!hr) {
00141         DIPROPDWORD propDword;
00142         propDword.diph.dwSize = <span class="keyword">sizeof</span>(DIPROPDWORD);
00143         propDword.diph.dwHeaderSize = <span class="keyword">sizeof</span>(DIPROPHEADER);
00144         propDword.diph.dwHow = DIPH_DEVICE;           <span class="comment">// Entire device</span>
00145         propDword.diph.dwObj =  0;                    <span class="comment">// Entire device, so zero</span>
00146         propDword.dwData = <a class="code" href="omouse_8cpp.html#a1">MOUSE_BUFFER_SIZE</a>;         <span class="comment">// * sizeof(DIDEVICEOBJECTDATA);</span>
00147         hr = <a class="code" href="classMouse.html#m5">di_mouse_device</a>-&gt;SetProperty(DIPROP_BUFFERSIZE, &amp;propDword.diph);
00148     }
00149 
00150     <span class="keywordflow">if</span>(hr)
00151         err.run( <span class="stringliteral">"Failed initializing mouse interface"</span>); {
00152 
00153         <span class="comment">// ------- create direct input keyboard interface --------- //</span>
00154         <span class="comment">// ####### begin Gilbert 12/9 #######//</span>
00155         <a class="code" href="classVgaFrontLock.html">VgaFrontLock</a> vgaLock;
00156         hr = <a class="code" href="classMouse.html#m4">direct_input</a>-&gt;CreateDevice(GUID_SysKeyboard,&amp;<a class="code" href="classMouse.html#m6">di_keyb_device</a>,<a class="code" href="OHELP_8H.html#a0">NULL</a>);
00157     }
00158     <span class="comment">// ####### end Gilbert 12/9 #######//</span>
00159 
00160     <span class="keywordflow">if</span>(hr)
00161         err.run( <span class="stringliteral">"Failed creating keyboard interface from DirectInput"</span>);
00162 
00163     <span class="comment">// ------- set cooperative level --------//</span>
00164     hr = <a class="code" href="classMouse.html#m6">di_keyb_device</a>-&gt;SetCooperativeLevel(hwnd, DISCL_FOREGROUND | DISCL_NONEXCLUSIVE);
00165 
00166     <span class="comment">// ------- set data format ---------//</span>
00167     <span class="keywordflow">if</span>(!hr)
00168         hr = <a class="code" href="classMouse.html#m6">di_keyb_device</a>-&gt;SetDataFormat(&amp;c_dfDIKeyboard);
00169 
00170     <span class="comment">// ------- set buffer size --------//</span>
00171     <span class="keywordflow">if</span>(!hr) {
00172         DIPROPDWORD propDword;
00173         propDword.diph.dwSize = <span class="keyword">sizeof</span>(DIPROPDWORD);
00174         propDword.diph.dwHeaderSize = <span class="keyword">sizeof</span>(DIPROPHEADER);
00175         propDword.diph.dwHow = DIPH_DEVICE;           <span class="comment">// Entire device</span>
00176         propDword.diph.dwObj =  0;                    <span class="comment">// Entire device, so zero</span>
00177         propDword.dwData = <a class="code" href="omouse_8cpp.html#a2">KEYB_BUFFER_SIZE</a>;          <span class="comment">// * sizeof(DIDEVICEOBJECTDATA);</span>
00178         hr = <a class="code" href="classMouse.html#m6">di_keyb_device</a>-&gt;SetProperty(DIPROP_BUFFERSIZE, &amp;propDword.diph);
00179     }
00180 
00181     <span class="keywordflow">if</span>(hr)
00182         err.run( <span class="stringliteral">"Failed initializing keyboard interface"</span>);
00183 
00184     <span class="comment">// ------- get initial keyboard state ----------//</span>
00185     <a class="code" href="classMouse.html#m11">skey_state</a> = 0;
00186     <span class="keywordflow">if</span>(GetKeyState(VK_LSHIFT) &lt; 0)
00187         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a3">LEFT_SHIFT_KEY_MASK</a>;
00188     <span class="keywordflow">if</span>(GetKeyState(VK_RSHIFT) &lt; 0)
00189         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a4">RIGHT_SHIFT_KEY_MASK</a>;
00190     <span class="keywordflow">if</span>(GetKeyState(VK_LCONTROL) &lt; 0)
00191         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a6">LEFT_CONTROL_KEY_MASK</a>;
00192     <span class="keywordflow">if</span>(GetKeyState(VK_RCONTROL) &lt; 0)
00193         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a7">RIGHT_CONTROL_KEY_MASK</a>;
00194     <span class="keywordflow">if</span>(GetKeyState(VK_LMENU) &lt; 0)
00195         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a9">LEFT_ALT_KEY_MASK</a>;
00196     <span class="keywordflow">if</span>(GetKeyState(VK_RMENU) &lt; 0)
00197         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a10">RIGHT_ALT_KEY_MASK</a>;
00198     <span class="keywordflow">if</span>(GetKeyState(VK_NUMLOCK) &amp; 1)
00199         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a12">NUM_LOCK_STATE_MASK</a>;
00200     <span class="keywordflow">if</span>(GetKeyState(VK_CAPITAL) &amp; 1)
00201         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a13">CAP_LOCK_STATE_MASK</a>;
00202     <span class="keywordflow">if</span>(GetKeyState(VK_SCROLL) &amp; 1)
00203         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a14">SCROLL_LOCK_STATE_MASK</a>;
00204     <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a15">INSERT_STATE_MASK</a>;                <span class="comment">// enable insert mode by default</span>
00205 
00206     <span class="comment">//------- initialize VGA update buffer -------//</span>
00207 
00208     <a class="code" href="classMouse.html#m2">vga_update_buf</a> = (<span class="keywordtype">short</span> *)<a class="code" href="ALL_8H.html#a5">mem_add</a>( <a class="code" href="omouse_8cpp.html#a0">VGA_UPDATE_BUF_SIZE</a> );
00209 
00210     <span class="comment">// ------ initialize mouse boundary ---------//</span>
00211     <a class="code" href="classMouse.html#a18">reset_boundary</a>();
00212 
00213     <span class="comment">// ------- initialize event queue ---------//</span>
00214     <a class="code" href="classMouse.html#m25">head_ptr</a> = <a class="code" href="classMouse.html#m26">tail_ptr</a> = 0;
00215 
00216     <span class="comment">//--------------------------------------------//</span>
00217 
00218     <a class="code" href="classMouse.html#m0">init_flag</a> = 1;
00219 }
00220 
00221 <span class="comment">//------------- End of Mouse::init -------------//</span>
00222 
00223 <span class="comment">//------------ Start of Mouse::deinit ------------//</span>
00224 <span class="comment">//</span>
<a name="l00225"></a><a class="code" href="classMouse.html#a3">00225</a> <span class="keywordtype">void</span> <a class="code" href="classMouse.html#a3">Mouse::deinit</a>() {
00226     <span class="keywordflow">if</span>( init_flag ) {
00227         <span class="comment">// UnhookWindowsHookEx(key_hook_handle);</span>
00228 
00229         <span class="comment">// DMouseClose(direct_mouse_handle);</span>
00230         <a class="code" href="classMouse.html#m0">init_flag</a> = 0;
00231     }
00232 
00233     <span class="keywordflow">if</span>( vga_update_buf ) {
00234         <a class="code" href="ALL_8H.html#a8">mem_del</a>(<a class="code" href="classMouse.html#m2">vga_update_buf</a>);
00235         <a class="code" href="classMouse.html#m2">vga_update_buf</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00236     }
00237 
00238     <span class="keywordflow">if</span>( di_keyb_device ) {
00239         <a class="code" href="classMouse.html#m6">di_keyb_device</a>-&gt;Unacquire();
00240         <a class="code" href="classMouse.html#m6">di_keyb_device</a>-&gt;Release();
00241         <a class="code" href="classMouse.html#m6">di_keyb_device</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00242     }
00243     <span class="keywordflow">if</span>( di_mouse_device ) {
00244         <a class="code" href="classMouse.html#m5">di_mouse_device</a>-&gt;Unacquire();
00245         <a class="code" href="classMouse.html#m5">di_mouse_device</a>-&gt;Release();
00246         <a class="code" href="classMouse.html#m5">di_mouse_device</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00247     }
00248     <span class="keywordflow">if</span>( direct_input ) {
00249         <a class="code" href="classMouse.html#m4">direct_input</a>-&gt;Release();
00250         <a class="code" href="classMouse.html#m4">direct_input</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00251     }
00252 }
00253 
00254 <span class="comment">//------------- End of Mouse::deinit -------------//</span>
00255 
00256 <span class="comment">//--------- Start of Mouse::hide -------//</span>
00257 <span class="comment">//</span>
00258 <span class="comment">// Suspend the mouse function, use resume() to resume to function</span>
00259 <span class="comment">//</span>
<a name="l00260"></a><a class="code" href="classMouse.html#a11">00260</a> <span class="keywordtype">void</span> <a class="code" href="classMouse.html#a11">Mouse::hide</a>() {
00261     mouse_cursor.hide_all_flag=1;
00262 
00263     mouse_cursor.process(<a class="code" href="classMouse.html#m7">cur_x</a>, <a class="code" href="classMouse.html#m8">cur_y</a>);
00264 }
00265 
00266 <span class="comment">//---------- End of Mouse::hide --------//</span>
00267 
00268 <span class="comment">//--------- Start of Mouse::show -------//</span>
00269 <span class="comment">//</span>
00270 <span class="comment">// Resume the mouse function which is previously hideed by hide()</span>
00271 <span class="comment">//</span>
<a name="l00272"></a><a class="code" href="classMouse.html#a10">00272</a> <span class="keywordtype">void</span> <a class="code" href="classMouse.html#a10">Mouse::show</a>() {
00273     mouse_cursor.hide_all_flag=0;
00274 
00275     mouse_cursor.process(<a class="code" href="classMouse.html#m7">cur_x</a>, <a class="code" href="classMouse.html#m8">cur_y</a>);
00276 }
00277 
00278 <span class="comment">//---------- End of Mouse::show --------//</span>
00279 
00280 <span class="comment">//--------- Begin of Mouse::hide_area ----------//</span>
00281 <span class="comment">//</span>
<a name="l00282"></a><a class="code" href="classMouse.html#a12">00282</a> <span class="keywordtype">void</span> <a class="code" href="classMouse.html#a12">Mouse::hide_area</a>(<span class="keywordtype">int</span> x1, <span class="keywordtype">int</span> y1, <span class="keywordtype">int</span> x2, <span class="keywordtype">int</span> y2) {
00283     mouse_cursor.hide_area_flag++;
00284 
00285     <span class="keywordflow">if</span>( mouse_cursor.hide_area_flag!=1 )            <span class="comment">// only process for the first call of hide_area()</span>
00286         <span class="keywordflow">return</span>;
00287 
00288     mouse_cursor.hide_x1 = x1;
00289     mouse_cursor.hide_y1 = y1;
00290     mouse_cursor.hide_x2 = x2;
00291     mouse_cursor.hide_y2 = y2;
00292 
00293     <span class="keywordtype">int</span> curX = <a class="code" href="classMouse.html#m7">cur_x</a> - mouse_cursor.hot_spot_x;
00294     <span class="keywordtype">int</span> curY = <a class="code" href="classMouse.html#m8">cur_y</a> - mouse_cursor.hot_spot_y;
00295 
00296     <span class="keywordflow">if</span>( m.is_touch( x1, y1, x2, y2, curX, curY,
00297                     curX+mouse_cursor.icon_width-1,
00298                     curY+mouse_cursor.icon_height-1 ) ) {
00299         <span class="keywordflow">if</span>( handle_flicking ) {
00300             update_x1 = min(x1, curX);
00301             update_y1 = min(y1, curY);
00302             update_x2 = max(x2, curX+mouse_cursor.icon_width-1);
00303             update_y2 = max(y2, curY+mouse_cursor.icon_height-1);
00304 
00305             update_x1 = max(0, update_x1);
00306             update_y1 = max(0, update_y1);
00307             update_x2 = min(<a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a>-1 , update_x2);
00308             update_y2 = min(<a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a>-1, update_y2);
00309 
00310             <a class="code" href="ALL_8H.html#a0">err_when</a>( (update_x2-update_x1+1) * (update_y2-update_y1+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>) &gt; <a class="code" href="omouse_8cpp.html#a0">VGA_UPDATE_BUF_SIZE</a> );
00311 
00312             <span class="comment">//---- save the update area of the back buf to a temp buffer ----//</span>
00313 
00314             vga_back.read_bitmapW( update_x1, update_y1, update_x2, update_y2, <a class="code" href="classMouse.html#m2">vga_update_buf</a> );
00315 
00316             <span class="comment">//--- copy the update area from the front buf to the back buf ---//</span>
00317 
00318             vga_back.blt_buf_fast( &amp;vga_front, update_x1, update_y1, update_x2, update_y2 );
00319 
00320             <span class="comment">//-- redirect the front VGA buffer pointer to the back VGA buffer --//</span>
00321 
00322             vga_front.set_buf_ptr( vga_back.buf_ptr() );
00323         }
00324 
00325         <span class="comment">//------ hide up the mouse cursor --------//</span>
00326 
00327         mouse_cursor.process(<a class="code" href="classMouse.html#m7">cur_x</a>, <a class="code" href="classMouse.html#m8">cur_y</a>);
00328     }
00329 }
00330 
00331 <span class="comment">//--------- End of Mouse::hide_area --------------//</span>
00332 
00333 <span class="comment">//--------- Begin of Mouse::show_area ----------//</span>
00334 <span class="comment">//</span>
<a name="l00335"></a><a class="code" href="classMouse.html#a13">00335</a> <span class="keywordtype">void</span> <a class="code" href="classMouse.html#a13">Mouse::show_area</a>() {
00336     mouse_cursor.hide_area_flag--;
00337 
00338     <span class="keywordflow">if</span>( mouse_cursor.hide_area_flag!=0 )            <span class="comment">// only process for the first call of hide_area()</span>
00339         <span class="keywordflow">return</span>;
00340 
00341     <span class="keywordtype">int</span> curX = <a class="code" href="classMouse.html#m7">cur_x</a> - mouse_cursor.hot_spot_x;
00342     <span class="keywordtype">int</span> curY = <a class="code" href="classMouse.html#m8">cur_y</a> - mouse_cursor.hot_spot_y;
00343 
00344     <span class="keywordflow">if</span>( m.is_touch( mouse_cursor.hide_x1, mouse_cursor.hide_y1,
00345                     mouse_cursor.hide_x2, mouse_cursor.hide_y2,
00346                     curX, curY, curX+mouse_cursor.icon_width-1,
00347                     curY+mouse_cursor.icon_height-1 ) ) {
00348         <span class="comment">//----- redisplay the mouse cursor ------//</span>
00349 
00350         mouse_cursor.process(<a class="code" href="classMouse.html#m7">cur_x</a>, <a class="code" href="classMouse.html#m8">cur_y</a>);
00351 
00352         <span class="keywordflow">if</span>( handle_flicking ) {
00353             <span class="comment">//--- copy the update area from the back buf to the front buf ---//</span>
00354 
00355             vga_front.blt_buf_fast( &amp;vga_back, update_x1, update_y1, update_x2, update_y2 );
00356 
00357             <span class="comment">//--- restore the update area of the back buf with the temp buffer ---//</span>
00358 
00359             vga_back.put_bitmapW( update_x1, update_y1, <a class="code" href="classMouse.html#m2">vga_update_buf</a> );
00360 
00361             <span class="comment">//--- restore the VGA front buffer's buf ptr ---//</span>
00362 
00363             vga_front.set_default_buf_ptr();
00364         }
00365     }
00366 }
00367 
00368 <span class="comment">//--------- End of Mouse::show_area --------------//</span>
00369 
00370 <span class="comment">//--------- Start of Mouse::add_event ---------//</span>
00371 <span class="comment">//</span>
00372 <span class="comment">// Called by handler interrupt to procss the state</span>
00373 <span class="comment">//</span>
<a name="l00374"></a><a class="code" href="classMouse.html#a4">00374</a> <span class="keywordtype">void</span> <a class="code" href="classMouse.html#a4">Mouse::add_event</a>(<a class="code" href="structMouseEvent.html">MouseEvent</a> *mouseEvent) {
00375     <span class="comment">//---- call the game object to see if the mouse cursor icon needs to be changed, or if the nation selection square needs to be activated ----//</span>
00376 
00377     power.mouse_handler();
00378 
00379     <span class="comment">//--------- update the mouse cursor ----------//</span>
00380 
00381     mouse_cursor.process(<a class="code" href="classMouse.html#m7">cur_x</a>, <a class="code" href="classMouse.html#m8">cur_y</a>);             <span class="comment">// repaint mouse cursor</span>
00382 
00383     <span class="comment">//-------- save state into the event queue --------//</span>
00384 
00385     <span class="keywordflow">if</span>((<a class="code" href="classMouse.html#m25">head_ptr</a> == <a class="code" href="classMouse.html#m26">tail_ptr</a>-1) ||                  <span class="comment">// see if the buffer is full</span>
00386        (<a class="code" href="classMouse.html#m25">head_ptr</a> == <a class="code" href="classMouse.html#s1s0">EVENT_BUFFER_SIZE</a>-1 &amp;&amp; <a class="code" href="classMouse.html#m26">tail_ptr</a> == 0)) {
00387         <span class="keywordflow">return</span>;
00388     }
00389 
00390     <a class="code" href="classMouse.html#m24">event_buffer</a>[<a class="code" href="classMouse.html#m25">head_ptr</a>] = *mouseEvent;
00391 
00392     <span class="keywordflow">if</span>(++<a class="code" href="classMouse.html#m25">head_ptr</a> &gt;= <a class="code" href="classMouse.html#s1s0">EVENT_BUFFER_SIZE</a>)             <span class="comment">// increment the head ptr</span>
00393         <a class="code" href="classMouse.html#m25">head_ptr</a> = 0;
00394 }
00395 
00396 <span class="comment">//----------- End of Mouse::add_event ----------//</span>
00397 
00398 <span class="comment">//--------- Start of Mouse::add_key_event ---------//</span>
00399 <span class="comment">//</span>
00400 <span class="comment">// Called by key handler to save the key pressed</span>
00401 <span class="comment">//</span>
<a name="l00402"></a><a class="code" href="classMouse.html#a5">00402</a> <span class="keywordtype">void</span> <a class="code" href="classMouse.html#a5">Mouse::add_key_event</a>(<span class="keywordtype">unsigned</span> scanCode, DWORD timeStamp) {
00403     <span class="keywordflow">if</span>((<a class="code" href="classMouse.html#m25">head_ptr</a> == <a class="code" href="classMouse.html#m26">tail_ptr</a>-1) ||                  <span class="comment">// see if the buffer is full</span>
00404        (<a class="code" href="classMouse.html#m25">head_ptr</a> == <a class="code" href="classMouse.html#s1s0">EVENT_BUFFER_SIZE</a>-1 &amp;&amp; <a class="code" href="classMouse.html#m26">tail_ptr</a> == 0)) {
00405         <span class="keywordflow">return</span>;
00406     }
00407 
00408     <a class="code" href="structMouseEvent.html">MouseEvent</a> *ev = <a class="code" href="classMouse.html#m24">event_buffer</a> + <a class="code" href="classMouse.html#m25">head_ptr</a>;
00409 
00410     ev-&gt;<a class="code" href="structMouseEvent.html#m0">event_type</a> = <a class="code" href="Omouse_8h.html#a28a24">KEY_PRESS</a>;
00411     ev-&gt;<a class="code" href="structMouseEvent.html#m5">scan_code</a> = scanCode;
00412     ev-&gt;<a class="code" href="structMouseEvent.html#m2">skey_state</a> = <a class="code" href="classMouse.html#m11">skey_state</a>;
00413     ev-&gt;<a class="code" href="structMouseEvent.html#m1">time</a> = timeStamp;
00414 
00415     <span class="comment">// put mouse state</span>
00416     <span class="comment">// ev-&gt;state = 0;                   //ev-&gt;state = left_press | right_press;</span>
00417     ev-&gt;<a class="code" href="structMouseEvent.html#m3">x</a> = <a class="code" href="classMouse.html#m7">cur_x</a>;
00418     ev-&gt;<a class="code" href="structMouseEvent.html#m4">y</a> = <a class="code" href="classMouse.html#m8">cur_y</a>;
00419 
00420     <span class="keywordflow">if</span>(++<a class="code" href="classMouse.html#m25">head_ptr</a> &gt;= <a class="code" href="classMouse.html#s1s0">EVENT_BUFFER_SIZE</a>)             <span class="comment">// increment the head ptr</span>
00421         <a class="code" href="classMouse.html#m25">head_ptr</a> = 0;
00422 }
00423 
00424 <span class="comment">//----------- End of Mouse::add_key_event ----------//</span>
00425 
00426 <span class="comment">//--------- Start of Mouse::get_event ---------//</span>
00427 <span class="comment">//</span>
00428 <span class="comment">// Get next event from the event buffer</span>
00429 <span class="comment">//</span>
00430 <span class="comment">// return : &lt;int&gt; 1 - event fetched from the event queue</span>
00431 <span class="comment">//                0 - not event remained in the buffer</span>
00432 <span class="comment">//</span>
00433 <span class="comment">// to know what type of event :</span>
00434 <span class="comment">// 1. check is_mouse_event() or is_key_event()</span>
00435 <span class="comment">// 2. if is_mouse_event(), check mouse_event_type</span>
00436 <span class="comment">//                      if( LEFT_BUTTON or LEFT_BUTTON_RELEASE, read click_buffer[LEFT_BUTTON]</span>
00437 <span class="comment">//                      if( RIGHT_BUTTON or RIGHT_BUTTON_RELEASE, read click_buffer[RIGHT_BUTTON]</span>
00438 <span class="comment">// 3. if is_key_event(), check event_skey_state, scan_code and key_code</span>
00439 <span class="comment">//</span>
<a name="l00440"></a><a class="code" href="classMouse.html#a6">00440</a> <span class="keywordtype">int</span> <a class="code" href="classMouse.html#a6">Mouse::get_event</a>() {
00441     <span class="keywordflow">if</span>(<a class="code" href="classMouse.html#m25">head_ptr</a> == <a class="code" href="classMouse.html#m26">tail_ptr</a>) {                      <span class="comment">// no event queue left in the buffer</span>
00442         <a class="code" href="classMouse.html#m22">scan_code</a>      =0;                            <span class="comment">// no keyboard event</span>
00443         <a class="code" href="classMouse.html#m23">key_code</a>       =0;
00444         <a class="code" href="classMouse.html#m19">has_mouse_event</a>=0;                            <span class="comment">// no mouse event</span>
00445         <span class="keywordflow">return</span> 0;
00446     }
00447 
00448     <span class="comment">//--------- get event from queue ---------//</span>
00449 
00450     <a class="code" href="structMouseEvent.html">MouseEvent</a>* eptr = <a class="code" href="classMouse.html#m24">event_buffer</a> + <a class="code" href="classMouse.html#m26">tail_ptr</a>;
00451     <a class="code" href="structMouseClick.html">MouseClick</a>* cptr;
00452 
00453     <a class="code" href="classMouse.html#m18">event_skey_state</a> = eptr-&gt;<a class="code" href="structMouseEvent.html#m2">skey_state</a>;
00454     <a class="code" href="classMouse.html#m20">mouse_event_type</a> = eptr-&gt;<a class="code" href="structMouseEvent.html#m0">event_type</a>;
00455 
00456     <span class="keywordflow">switch</span>( eptr-&gt;<a class="code" href="structMouseEvent.html#m0">event_type</a> ) {
00457     <span class="keywordflow">case</span> <a class="code" href="Omouse_8h.html#a28a22">LEFT_BUTTON</a>:
00458     <span class="keywordflow">case</span> <a class="code" href="Omouse_8h.html#a28a23">RIGHT_BUTTON</a>:
00459         <span class="comment">// set count of other button to zero</span>
00460         <a class="code" href="classMouse.html#m21">click_buffer</a>[<a class="code" href="Omouse_8h.html#a28a22">LEFT_BUTTON</a>+<a class="code" href="Omouse_8h.html#a28a23">RIGHT_BUTTON</a>-eptr-&gt;<a class="code" href="structMouseEvent.html#m0">event_type</a>].count = 0;
00461         cptr = <a class="code" href="classMouse.html#m21">click_buffer</a> + eptr-&gt;<a class="code" href="structMouseEvent.html#m0">event_type</a>;
00462         <span class="keywordflow">if</span>(                                         <span class="comment">//eptr-&gt;event_type == LEFT_BUTTON   &amp;&amp;              // left button has double click</span>
00463             eptr-&gt;<a class="code" href="structMouseEvent.html#m1">time</a> - cptr-&gt;<a class="code" href="structMouseClick.html#m5">time</a> &lt; click_threshold )
00464             cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a>++;
00465         <span class="keywordflow">else</span>
00466             cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a> = 1;
00467 
00468         cptr-&gt;<a class="code" href="structMouseClick.html#m5">time</a> = eptr-&gt;<a class="code" href="structMouseEvent.html#m1">time</a>;
00469         cptr-&gt;<a class="code" href="structMouseClick.html#m0">x</a>    = eptr-&gt;<a class="code" href="structMouseEvent.html#m3">x</a>;
00470         cptr-&gt;<a class="code" href="structMouseClick.html#m1">y</a>    = eptr-&gt;<a class="code" href="structMouseEvent.html#m4">y</a>;
00471         <a class="code" href="classMouse.html#m22">scan_code</a>       = 0;
00472         <a class="code" href="classMouse.html#m23">key_code</a>        = 0;
00473         <a class="code" href="classMouse.html#m19">has_mouse_event</a> = 1;
00474         <span class="keywordflow">break</span>;
00475 
00476     <span class="keywordflow">case</span> <a class="code" href="Omouse_8h.html#a28a24">KEY_PRESS</a>:
00477         <a class="code" href="classMouse.html#m22">scan_code</a> = eptr-&gt;<a class="code" href="structMouseEvent.html#m5">scan_code</a>;
00478         <a class="code" href="classMouse.html#m23">key_code</a> = mouse.is_key(mouse.scan_code, mouse.event_skey_state, (<a class="code" href="OCOLTBL_8H.html#a2">WORD</a>) 0, <a class="code" href="OMOUSE2_8H.html#a15a13">K_CHAR_KEY</a>);
00479         <a class="code" href="classMouse.html#m19">has_mouse_event</a> = 0;
00480         <span class="keywordflow">break</span>;
00481 
00482     <span class="keywordflow">case</span> <a class="code" href="Omouse_8h.html#a28a25">LEFT_BUTTON_RELEASE</a>:
00483     <span class="keywordflow">case</span> <a class="code" href="Omouse_8h.html#a28a26">RIGHT_BUTTON_RELEASE</a>:
00484         cptr = <a class="code" href="classMouse.html#m21">click_buffer</a> + eptr-&gt;<a class="code" href="structMouseEvent.html#m0">event_type</a> - <a class="code" href="Omouse_8h.html#a28a25">LEFT_BUTTON_RELEASE</a>;
00485         cptr-&gt;<a class="code" href="structMouseClick.html#m6">release_time</a> = eptr-&gt;<a class="code" href="structMouseEvent.html#m1">time</a>;
00486         cptr-&gt;<a class="code" href="structMouseClick.html#m2">release_x</a>    = eptr-&gt;<a class="code" href="structMouseEvent.html#m3">x</a>;
00487         cptr-&gt;<a class="code" href="structMouseClick.html#m3">release_y</a>    = eptr-&gt;<a class="code" href="structMouseEvent.html#m4">y</a>;
00488         <a class="code" href="classMouse.html#m22">scan_code</a>          = 0;
00489         <a class="code" href="classMouse.html#m23">key_code</a>           = 0;
00490         <a class="code" href="classMouse.html#m19">has_mouse_event</a>    = 1;
00491         <span class="keywordflow">break</span>;
00492 
00493     <span class="keywordflow">case</span> <a class="code" href="Omouse_8h.html#a28a27">KEY_RELEASE</a>:
00494         <span class="comment">// no action</span>
00495         <span class="keywordflow">break</span>;
00496 
00497     <span class="keywordflow">default</span>:
00498         <a class="code" href="ALL_8H.html#a1">err_here</a>();
00499     }
00500 
00501     <span class="keywordflow">if</span>(++<a class="code" href="classMouse.html#m26">tail_ptr</a> &gt;= <a class="code" href="classMouse.html#s1s0">EVENT_BUFFER_SIZE</a>)
00502         <a class="code" href="classMouse.html#m26">tail_ptr</a> = 0;
00503 
00504     <span class="keywordflow">return</span> 1;
00505 }
00506 
00507 <span class="comment">//----------- End of Mouse::get_event ----------//</span>
00508 
00509 <span class="comment">//--------- Begin of Mouse::clear_event ----------//</span>
00510 <span class="comment">//</span>
<a name="l00511"></a><a class="code" href="classMouse.html#a7">00511</a> <span class="keywordtype">void</span> <a class="code" href="classMouse.html#a7">Mouse::clear_event</a>() {
00512     <span class="keywordtype">int</span> loopCount=0;
00513 
00514     <a class="code" href="classMouse.html#a8">poll_event</a>();
00515 
00516     <span class="keywordflow">while</span>( <a class="code" href="classMouse.html#a6">get_event</a>() ) {
00517         <a class="code" href="ALL_8H.html#a0">err_when</a>( loopCount++ &gt; 10000 );
00518     }
00519 
00520     <a class="code" href="classMouse.html#m25">head_ptr</a> = 0;
00521     <a class="code" href="classMouse.html#m26">tail_ptr</a> = 0;
00522     <a class="code" href="classMouse.html#m23">key_code</a> = 0;
00523     <a class="code" href="classMouse.html#m22">scan_code</a> = 0;
00524 }
00525 
00526 <span class="comment">//--------- End of Mouse::clear_event --------------//</span>
00527 
00528 <span class="comment">//--------- Begin of Mouse::in_area ----------//</span>
00529 <span class="comment">//</span>
00530 <span class="comment">// &lt;Real-time access&gt;</span>
00531 <span class="comment">//</span>
00532 <span class="comment">// Detect whether mouse cursor is in the specified area</span>
00533 <span class="comment">//</span>
00534 <span class="comment">// &lt;int&gt; x1,y1,x2,y2 = the coordinations of the area</span>
00535 <span class="comment">//</span>
00536 <span class="comment">// Return : 1 - if the mouse cursor is in the area</span>
00537 <span class="comment">//          0 - if not</span>
00538 <span class="comment">//</span>
<a name="l00539"></a><a class="code" href="classMouse.html#a14">00539</a> <span class="keywordtype">int</span> <a class="code" href="classMouse.html#a14">Mouse::in_area</a>(<span class="keywordtype">int</span> x1, <span class="keywordtype">int</span> y1, <span class="keywordtype">int</span> x2, <span class="keywordtype">int</span> y2) {
00540     <span class="keywordflow">return</span>( <a class="code" href="classMouse.html#m7">cur_x</a> &gt;= x1 &amp;&amp; <a class="code" href="classMouse.html#m8">cur_y</a> &gt;= y1 &amp;&amp; <a class="code" href="classMouse.html#m7">cur_x</a> &lt;= x2 &amp;&amp; <a class="code" href="classMouse.html#m8">cur_y</a> &lt;= y2 );
00541 }
00542 
00543 <span class="comment">//--------- End of Mouse::in_area --------------//</span>
00544 
00545 <span class="comment">//--------- Begin of Mouse::press_area ----------//</span>
00546 <span class="comment">//</span>
00547 <span class="comment">// &lt;Real-time access&gt;</span>
00548 <span class="comment">//</span>
00549 <span class="comment">// Detect whether the specified area has been pressed by mouse</span>
00550 <span class="comment">//</span>
00551 <span class="comment">// &lt;int&gt; x1,y1,x2,y2 = the coordinations of the area</span>
00552 <span class="comment">// &lt;int&gt; buttonId    = which button ( 0=left, 1-right, 2-left or right )</span>
00553 <span class="comment">//</span>
00554 <span class="comment">// Return : 1 - if the area has been pressed (left button)</span>
00555 <span class="comment">//                         1 - if the area has been pressed (right button)</span>
00556 <span class="comment">//          0 - if not</span>
00557 <span class="comment">//</span>
<a name="l00558"></a><a class="code" href="classMouse.html#a15">00558</a> <span class="keywordtype">int</span> <a class="code" href="classMouse.html#a15">Mouse::press_area</a>(<span class="keywordtype">int</span> x1, <span class="keywordtype">int</span> y1, <span class="keywordtype">int</span> x2, <span class="keywordtype">int</span> y2, <span class="keywordtype">int</span> buttonId) {
00559     <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m7">cur_x</a> &gt;= x1 &amp;&amp; <a class="code" href="classMouse.html#m8">cur_y</a> &gt;= y1 &amp;&amp; <a class="code" href="classMouse.html#m7">cur_x</a> &lt;= x2 &amp;&amp; <a class="code" href="classMouse.html#m8">cur_y</a> &lt;= y2 ) {
00560         <span class="comment">// Left button</span>
00561         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m9">left_press</a> &amp;&amp; (buttonId==0 || buttonId==2) )
00562             <span class="keywordflow">return</span> 1;
00563 
00564         <span class="comment">// Right button</span>
00565         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m10">right_press</a> &amp;&amp; (buttonId==1 || buttonId==2) )
00566             <span class="keywordflow">return</span> 2;
00567     }
00568 
00569     <span class="keywordflow">return</span> 0;
00570 }
00571 
00572 <span class="comment">//--------- End of Mouse::press_area --------------//</span>
00573 
00574 <span class="comment">//--------- Begin of Mouse::set_boundary ----------//</span>
00575 <span class="comment">//</span>
00576 <span class="comment">// for each parameter, put -1 to mean unchange</span>
00577 <span class="comment">//</span>
<a name="l00578"></a><a class="code" href="classMouse.html#a17">00578</a> <span class="keywordtype">void</span> <a class="code" href="classMouse.html#a17">Mouse::set_boundary</a>(<span class="keywordtype">int</span> x1, <span class="keywordtype">int</span> y1, <span class="keywordtype">int</span> x2, <span class="keywordtype">int</span> y2) {
00579     <span class="keywordflow">if</span>( x1 &gt;= 0)
00580         <a class="code" href="classMouse.html#m12">bound_x1</a> = x1;
00581     <span class="keywordflow">if</span>( y1 &gt;= 0)
00582         <a class="code" href="classMouse.html#m13">bound_y1</a> = y1;
00583     <span class="keywordflow">if</span>( x2 &gt;= 0)
00584         <a class="code" href="classMouse.html#m14">bound_x2</a> = x2 &gt; <a class="code" href="Omouse_8h.html#a17">MOUSE_X_UPPER_LIMIT</a> ? <a class="code" href="Omouse_8h.html#a17">MOUSE_X_UPPER_LIMIT</a> : x2;
00585     <span class="keywordflow">if</span>( y2 &gt;= 0)
00586         <a class="code" href="classMouse.html#m15">bound_y2</a> = y2 &gt; <a class="code" href="Omouse_8h.html#a18">MOUSE_Y_UPPER_LIMIT</a> ? <a class="code" href="Omouse_8h.html#a18">MOUSE_Y_UPPER_LIMIT</a> : y2;
00587 }
00588 
00589 <span class="comment">//--------- End of Mouse::set_boundary ----------//</span>
00590 
00591 <span class="comment">//--------- Begin of Mouse::reset_boundary ----------//</span>
<a name="l00592"></a><a class="code" href="classMouse.html#a18">00592</a> <span class="keywordtype">void</span> <a class="code" href="classMouse.html#a18">Mouse::reset_boundary</a>() {
00593     <a class="code" href="classMouse.html#m12">bound_x1</a> = 0;
00594     <a class="code" href="classMouse.html#m13">bound_y1</a> = 0;
00595     <a class="code" href="classMouse.html#m14">bound_x2</a> = <a class="code" href="Omouse_8h.html#a17">MOUSE_X_UPPER_LIMIT</a>;
00596     <a class="code" href="classMouse.html#m15">bound_y2</a> = <a class="code" href="Omouse_8h.html#a18">MOUSE_Y_UPPER_LIMIT</a>;
00597 }
00598 
00599 <span class="comment">//--------- End of Mouse::set_boundary ----------//</span>
00600 
00601 <span class="comment">//--------- Begin of Mouse::single_click ----------//</span>
00602 <span class="comment">//</span>
00603 <span class="comment">// &lt;Event queue access&gt;</span>
00604 <span class="comment">//</span>
00605 <span class="comment">// Detect whether the specified area has been single clicked by mouse</span>
00606 <span class="comment">//</span>
00607 <span class="comment">// &lt;int&gt; x1,y1,x2,y2 = the coordinations of the area</span>
00608 <span class="comment">// [int] buttonId    = which button ( 0=left, 1-right, 2-both)</span>
00609 <span class="comment">//                     (default:0)</span>
00610 <span class="comment">//</span>
00611 <span class="comment">// Return : 1 - if the area has been clicked (left click)</span>
00612 <span class="comment">//                              2 - if the area has been clicked (right click)</span>
00613 <span class="comment">//          0 - if not</span>
00614 <span class="comment">//</span>
<a name="l00615"></a><a class="code" href="classMouse.html#a19">00615</a> <span class="keywordtype">int</span> <a class="code" href="classMouse.html#a19">Mouse::single_click</a>(<span class="keywordtype">int</span> x1, <span class="keywordtype">int</span> y1, <span class="keywordtype">int</span> x2, <span class="keywordtype">int</span> y2,<span class="keywordtype">int</span> buttonId) {
00616     <span class="keywordflow">if</span>( !<a class="code" href="classMouse.html#m19">has_mouse_event</a> )
00617         <span class="keywordflow">return</span> 0;
00618 
00619     <a class="code" href="structMouseClick.html">MouseClick</a>* cptr;
00620 
00621     <span class="keywordflow">if</span>( buttonId==0 || buttonId==2 ) {              <span class="comment">// left button</span>
00622         cptr = <a class="code" href="classMouse.html#m21">click_buffer</a>+<a class="code" href="Omouse_8h.html#a28a22">LEFT_BUTTON</a>;
00623 
00624         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m20">mouse_event_type</a> == <a class="code" href="Omouse_8h.html#a28a22">LEFT_BUTTON</a>
00625             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a> == 1
00626             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m0">x</a> &gt;= x1 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m1">y</a> &gt;= y1
00627             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m0">x</a> &lt;= x2 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m1">y</a> &lt;= y2 ) {
00628             <span class="keywordflow">return</span> 1;
00629         }
00630     }
00631 
00632     <span class="keywordflow">if</span>( buttonId==1 || buttonId==2 ) {              <span class="comment">// right button</span>
00633         cptr = <a class="code" href="classMouse.html#m21">click_buffer</a>+<a class="code" href="Omouse_8h.html#a28a23">RIGHT_BUTTON</a>;
00634 
00635         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m20">mouse_event_type</a> == <a class="code" href="Omouse_8h.html#a28a23">RIGHT_BUTTON</a>
00636             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a> == 1
00637             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m0">x</a> &gt;= x1 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m1">y</a> &gt;= y1
00638             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m0">x</a> &lt;= x2 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m1">y</a> &lt;= y2 ) {
00639             <span class="keywordflow">return</span> 2;
00640         }
00641     }
00642 
00643     <span class="keywordflow">return</span> 0;
00644 }
00645 
00646 <span class="comment">//--------- End of Mouse::single_click --------------//</span>
00647 
00648 <span class="comment">//--------- Begin of Mouse::single_click ----------//</span>
00649 <span class="comment">//</span>
00650 <span class="comment">// &lt;Event queue access&gt;</span>
00651 <span class="comment">//</span>
00652 <span class="comment">// Detect whether the specified area has been single clicked by mouse</span>
00653 <span class="comment">//</span>
00654 <span class="comment">// &lt;int&gt; x1,y1,x2,y2 = the coordinations of the area</span>
00655 <span class="comment">// [int] buttonId    = which button ( 0=left, 1-right, 2-both)</span>
00656 <span class="comment">//                     (default:0)</span>
00657 <span class="comment">//</span>
00658 <span class="comment">// Return : 1 - if the area has been clicked (left click)</span>
00659 <span class="comment">//                              2 - if the area has been clicked (right click)</span>
00660 <span class="comment">//          0 - if not</span>
00661 <span class="comment">//</span>
<a name="l00662"></a><a class="code" href="classMouse.html#a20">00662</a> <span class="keywordtype">int</span> <a class="code" href="classMouse.html#a19">Mouse::single_click</a>(<span class="keywordtype">int</span> buttonId) {
00663     <span class="keywordflow">if</span>( !<a class="code" href="classMouse.html#m19">has_mouse_event</a> )
00664         <span class="keywordflow">return</span> 0;
00665 
00666     <a class="code" href="structMouseClick.html">MouseClick</a>* cptr;
00667 
00668     <span class="keywordflow">if</span>( buttonId==0 || buttonId==2 ) {              <span class="comment">// left button</span>
00669         cptr = <a class="code" href="classMouse.html#m21">click_buffer</a>+<a class="code" href="Omouse_8h.html#a28a22">LEFT_BUTTON</a>;
00670 
00671         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m20">mouse_event_type</a> == <a class="code" href="Omouse_8h.html#a28a22">LEFT_BUTTON</a>
00672             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a> == 1) {
00673             <span class="keywordflow">return</span> 1;
00674         }
00675     }
00676 
00677     <span class="keywordflow">if</span>( buttonId==1 || buttonId==2 ) {              <span class="comment">// right button</span>
00678         cptr = <a class="code" href="classMouse.html#m21">click_buffer</a>+<a class="code" href="Omouse_8h.html#a28a23">RIGHT_BUTTON</a>;
00679 
00680         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m20">mouse_event_type</a> == <a class="code" href="Omouse_8h.html#a28a23">RIGHT_BUTTON</a>
00681             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a> == 1) {
00682             <span class="keywordflow">return</span> 2;
00683         }
00684     }
00685 
00686     <span class="keywordflow">return</span> 0;
00687 }
00688 
00689 <span class="comment">//--------- End of Mouse::single_click --------------//</span>
00690 
00691 <span class="comment">//--------- Begin of Mouse::double_click ----------//</span>
00692 <span class="comment">//</span>
00693 <span class="comment">// &lt;Event queue access&gt;</span>
00694 <span class="comment">//</span>
00695 <span class="comment">// Detect whether the specified area has been double clicked by mouse</span>
00696 <span class="comment">//</span>
00697 <span class="comment">// Note : when a mouse double click, it will FIRST generate a SINGLE</span>
00698 <span class="comment">//        click signal and then a DOUBLE click signal.</span>
00699 <span class="comment">//        Because a double click is consisted of two single click</span>
00700 <span class="comment">//</span>
00701 <span class="comment">// &lt;int&gt; x1,y1,x2,y2 = the coordinations of the area</span>
00702 <span class="comment">// [int] buttonId    = which button ( 0=left, 1-right, 2-left or right)</span>
00703 <span class="comment">//                     (default:0)</span>
00704 <span class="comment">//</span>
00705 <span class="comment">// Return : 1 - if the area has been clicked</span>
00706 <span class="comment">//          0 - if not</span>
00707 <span class="comment">//</span>
<a name="l00708"></a><a class="code" href="classMouse.html#a21">00708</a> <span class="keywordtype">int</span> <a class="code" href="classMouse.html#a21">Mouse::double_click</a>(<span class="keywordtype">int</span> x1, <span class="keywordtype">int</span> y1, <span class="keywordtype">int</span> x2, <span class="keywordtype">int</span> y2,<span class="keywordtype">int</span> buttonId) {
00709     <span class="keywordflow">if</span>( !<a class="code" href="classMouse.html#m19">has_mouse_event</a> )
00710         <span class="keywordflow">return</span> 0;
00711 
00712     <a class="code" href="structMouseClick.html">MouseClick</a>* cptr;
00713 
00714     <span class="keywordflow">if</span>( buttonId==0 || buttonId==2 ) {              <span class="comment">// left button</span>
00715         cptr = <a class="code" href="classMouse.html#m21">click_buffer</a>+<a class="code" href="Omouse_8h.html#a28a22">LEFT_BUTTON</a>;
00716 
00717         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m20">mouse_event_type</a> == <a class="code" href="Omouse_8h.html#a28a22">LEFT_BUTTON</a>
00718             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a> == 2
00719             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m0">x</a> &gt;= x1 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m1">y</a> &gt;= y1
00720             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m0">x</a> &lt;= x2 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m1">y</a> &lt;= y2 ) {
00721             <span class="keywordflow">return</span> 1;
00722         }
00723     }
00724 
00725     <span class="keywordflow">if</span>( buttonId==1 || buttonId==2 ) {              <span class="comment">// right button</span>
00726         cptr = <a class="code" href="classMouse.html#m21">click_buffer</a>+<a class="code" href="Omouse_8h.html#a28a23">RIGHT_BUTTON</a>;
00727 
00728         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m20">mouse_event_type</a> == <a class="code" href="Omouse_8h.html#a28a23">RIGHT_BUTTON</a>
00729             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a> == 2
00730             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m0">x</a> &gt;= x1 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m1">y</a> &gt;= y1
00731             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m0">x</a> &lt;= x2 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m1">y</a> &lt;= y2 ) {
00732             <span class="keywordflow">return</span> 1;
00733         }
00734     }
00735 
00736     <span class="keywordflow">return</span> 0;
00737 }
00738 
00739 <span class="comment">//--------- End of Mouse::double_click --------------//</span>
00740 
00741 <span class="comment">//--------- Begin of Mouse::any_click ----------//</span>
00742 <span class="comment">//</span>
00743 <span class="comment">// &lt;Event queue access&gt;</span>
00744 <span class="comment">//</span>
00745 <span class="comment">// Detect whether the specified area has been single or double clicked by mouse</span>
00746 <span class="comment">//</span>
00747 <span class="comment">// &lt;int&gt; x1,y1,x2,y2 = the coordinations of the area</span>
00748 <span class="comment">// [int] buttonId    = which button ( 0=left, 1-right, 2-left or right)</span>
00749 <span class="comment">//                     (default:0)</span>
00750 <span class="comment">//</span>
00751 <span class="comment">// Return : &gt;0 - the no. of click if the area has been clicked</span>
00752 <span class="comment">//          0  - if not</span>
00753 <span class="comment">//</span>
<a name="l00754"></a><a class="code" href="classMouse.html#a22">00754</a> <span class="keywordtype">int</span> <a class="code" href="classMouse.html#a22">Mouse::any_click</a>(<span class="keywordtype">int</span> x1, <span class="keywordtype">int</span> y1, <span class="keywordtype">int</span> x2, <span class="keywordtype">int</span> y2,<span class="keywordtype">int</span> buttonId) {
00755     <span class="keywordflow">if</span>( !<a class="code" href="classMouse.html#m19">has_mouse_event</a> )
00756         <span class="keywordflow">return</span> 0;
00757 
00758     <a class="code" href="structMouseClick.html">MouseClick</a>* cptr;
00759 
00760     <span class="keywordflow">if</span>( buttonId==0 || buttonId==2 ) {              <span class="comment">// left button</span>
00761         cptr = <a class="code" href="classMouse.html#m21">click_buffer</a>+<a class="code" href="Omouse_8h.html#a28a22">LEFT_BUTTON</a>;
00762 
00763         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m20">mouse_event_type</a> == <a class="code" href="Omouse_8h.html#a28a22">LEFT_BUTTON</a>
00764             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a> &gt;= 1
00765             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m0">x</a> &gt;= x1 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m1">y</a> &gt;= y1
00766             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m0">x</a> &lt;= x2 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m1">y</a> &lt;= y2 ) {
00767             <span class="keywordflow">return</span> cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a>;
00768         }
00769     }
00770 
00771     <span class="keywordflow">if</span>( buttonId==1 || buttonId==2 ) {              <span class="comment">// right button</span>
00772         cptr = <a class="code" href="classMouse.html#m21">click_buffer</a>+<a class="code" href="Omouse_8h.html#a28a23">RIGHT_BUTTON</a>;
00773 
00774         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m20">mouse_event_type</a> == <a class="code" href="Omouse_8h.html#a28a23">RIGHT_BUTTON</a>
00775             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a> &gt;= 1
00776             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m0">x</a> &gt;= x1 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m1">y</a> &gt;= y1
00777             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m0">x</a> &lt;= x2 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m1">y</a> &lt;= y2 ) {
00778             <span class="keywordflow">return</span> cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a>;
00779         }
00780     }
00781 
00782     <span class="keywordflow">return</span> 0;
00783 }
00784 
00785 <span class="comment">//--------- End of Mouse::any_click --------------//</span>
00786 
00787 <span class="comment">//--------- Begin of Mouse::any_click ----------//</span>
00788 <span class="comment">//</span>
00789 <span class="comment">// &lt;Event queue access&gt;</span>
00790 <span class="comment">//</span>
00791 <span class="comment">// Detect whether the specified area has been single or double clicked by mouse</span>
00792 <span class="comment">// Only check button, don't check mouse coordination</span>
00793 <span class="comment">//</span>
00794 <span class="comment">// [int] buttonId = which button ( 0=left, 1-right, 2-left or right)</span>
00795 <span class="comment">//                  (default:0)</span>
00796 <span class="comment">//</span>
00797 <span class="comment">// Return : &gt;0 - the no. of click if the area has been clicked</span>
00798 <span class="comment">//          0  - if not</span>
00799 <span class="comment">//</span>
<a name="l00800"></a><a class="code" href="classMouse.html#a23">00800</a> <span class="keywordtype">int</span> <a class="code" href="classMouse.html#a22">Mouse::any_click</a>(<span class="keywordtype">int</span> buttonId) {
00801     <span class="keywordflow">if</span>( !<a class="code" href="classMouse.html#m19">has_mouse_event</a> )
00802         <span class="keywordflow">return</span> 0;
00803 
00804     <a class="code" href="structMouseClick.html">MouseClick</a>* cptr;
00805 
00806     <span class="keywordflow">if</span>( buttonId==0 || buttonId==2 ) {              <span class="comment">// left button</span>
00807         cptr = <a class="code" href="classMouse.html#m21">click_buffer</a>+<a class="code" href="Omouse_8h.html#a28a22">LEFT_BUTTON</a>;
00808 
00809         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m20">mouse_event_type</a> == <a class="code" href="Omouse_8h.html#a28a22">LEFT_BUTTON</a> &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a> &gt;= 1 )
00810             <span class="keywordflow">return</span> cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a>;
00811     }
00812 
00813     <span class="keywordflow">if</span>( buttonId==1 || buttonId==2 ) {              <span class="comment">// right button</span>
00814         cptr = <a class="code" href="classMouse.html#m21">click_buffer</a>+<a class="code" href="Omouse_8h.html#a28a23">RIGHT_BUTTON</a>;
00815 
00816         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m20">mouse_event_type</a> == <a class="code" href="Omouse_8h.html#a28a23">RIGHT_BUTTON</a> &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a> &gt;= 1 )
00817             <span class="keywordflow">return</span> cptr-&gt;<a class="code" href="structMouseClick.html#m4">count</a>;
00818     }
00819 
00820     <span class="keywordflow">return</span> 0;
00821 }
00822 
00823 <span class="comment">//--------- End of Mouse::any_click --------------//</span>
00824 
00825 <span class="comment">//--------- Begin of Mouse::release_click ----------//</span>
00826 <span class="comment">//</span>
00827 <span class="comment">// &lt;Event queue access&gt;</span>
00828 <span class="comment">//</span>
00829 <span class="comment">// Detect whether the specified area has been released button by mouse</span>
00830 <span class="comment">//</span>
00831 <span class="comment">// &lt;int&gt; x1,y1,x2,y2 = the coordinations of the area</span>
00832 <span class="comment">// [int] buttonId    = which button ( 0=left, 1-right, 2-both)</span>
00833 <span class="comment">//                     (default:0)</span>
00834 <span class="comment">//</span>
00835 <span class="comment">// Return : 1 - if the area has been clicked (left click)</span>
00836 <span class="comment">//                              2 - if the area has been clicked (right click)</span>
00837 <span class="comment">//          0 - if not</span>
00838 <span class="comment">//</span>
<a name="l00839"></a><a class="code" href="classMouse.html#a24">00839</a> <span class="keywordtype">int</span> <a class="code" href="classMouse.html#a24">Mouse::release_click</a>(<span class="keywordtype">int</span> x1, <span class="keywordtype">int</span> y1, <span class="keywordtype">int</span> x2, <span class="keywordtype">int</span> y2,<span class="keywordtype">int</span> buttonId) {
00840     <span class="keywordflow">if</span>( !<a class="code" href="classMouse.html#m19">has_mouse_event</a> )
00841         <span class="keywordflow">return</span> 0;
00842 
00843     <a class="code" href="structMouseClick.html">MouseClick</a>* cptr;
00844 
00845     <span class="keywordflow">if</span>( buttonId==0 || buttonId==2 ) {              <span class="comment">// left button</span>
00846         cptr = <a class="code" href="classMouse.html#m21">click_buffer</a>+<a class="code" href="Omouse_8h.html#a28a22">LEFT_BUTTON</a>;
00847 
00848         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m20">mouse_event_type</a> == <a class="code" href="Omouse_8h.html#a28a25">LEFT_BUTTON_RELEASE</a>
00849             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m2">release_x</a> &gt;= x1 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m3">release_y</a> &gt;= y1
00850             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m2">release_x</a> &lt;= x2 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m3">release_y</a> &lt;= y2 ) {
00851             <span class="keywordflow">return</span> 1;
00852         }
00853     }
00854 
00855     <span class="keywordflow">if</span>( buttonId==1 || buttonId==2 ) {              <span class="comment">// right button</span>
00856         cptr = <a class="code" href="classMouse.html#m21">click_buffer</a>+<a class="code" href="Omouse_8h.html#a28a23">RIGHT_BUTTON</a>;
00857 
00858         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m20">mouse_event_type</a> == <a class="code" href="Omouse_8h.html#a28a26">RIGHT_BUTTON_RELEASE</a>
00859             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m2">release_x</a> &gt;= x1 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m3">release_y</a> &gt;= y1
00860             &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m2">release_x</a> &lt;= x2 &amp;&amp; cptr-&gt;<a class="code" href="structMouseClick.html#m3">release_y</a> &lt;= y2 ) {
00861             <span class="keywordflow">return</span> 2;
00862         }
00863     }
00864 
00865     <span class="keywordflow">return</span> 0;
00866 }
00867 
00868 <span class="comment">//--------- End of Mouse::release_click --------------//</span>
00869 
00870 <span class="comment">//------- Begin of function key_hook_proc --------//</span>
00871 
<a name="l00872"></a><a class="code" href="omouse_8cpp.html#a11">00872</a> LRESULT CALLBACK <a class="code" href="omouse_8cpp.html#a11">key_hook_proc</a>(<span class="keywordtype">int</span> nCode, <a class="code" href="OCOLTBL_8H.html#a2">WORD</a> wParam, LONG lParam) {
00873     <span class="keywordflow">if</span> (nCode &gt;= 0)
00874         mouse.add_key_event(wParam, m.get_time());
00875 
00876     <span class="keywordflow">return</span> CallNextHookEx(mouse.key_hook_handle, nCode, wParam, lParam);
00877 }
00878 
00879 <span class="comment">//-------- End of function key_hook_proc --------//</span>
00880 
00881 <span class="comment">//--------- Begin of Mouse::poll_event ----------//</span>
00882 <span class="comment">//</span>
00883 <span class="comment">// Poll mouse events from the direct mouse VXD.</span>
00884 <span class="comment">//</span>
<a name="l00885"></a><a class="code" href="classMouse.html#a8">00885</a> <span class="keywordtype">void</span> <a class="code" href="classMouse.html#a8">Mouse::poll_event</a>() {
00886     <span class="keywordflow">if</span>(!<a class="code" href="classMouse.html#m0">init_flag</a>)
00887         <span class="keywordflow">return</span>;
00888 
00889     <span class="comment">// ---- acquire mouse device and count the message queued ----//</span>
00890     HRESULT hr;
00891     <span class="keywordflow">if</span>( (hr = <a class="code" href="classMouse.html#m5">di_mouse_device</a>-&gt;Acquire()) != DI_OK &amp;&amp; hr != S_FALSE)
00892         <span class="keywordflow">return</span>;
00893 
00894     <span class="keywordflow">if</span>( (hr = <a class="code" href="classMouse.html#m6">di_keyb_device</a>-&gt;Acquire()) != DI_OK &amp;&amp; hr != S_FALSE)
00895         <span class="keywordflow">return</span>;
00896 
00897     <span class="comment">// HRESULT hr;</span>
00898     DWORD mouseLen, keybLen;
00899 
00900     <span class="keywordtype">int</span> moveFlag = 0;
00901     <span class="keywordflow">while</span>( 1 ) {
00902         mouseLen = <a class="code" href="omouse_8cpp.html#a1">MOUSE_BUFFER_SIZE</a>;
00903         keybLen = <a class="code" href="omouse_8cpp.html#a2">KEYB_BUFFER_SIZE</a>;
00904 
00905         <span class="keywordflow">if</span>( (hr = <a class="code" href="classMouse.html#m5">di_mouse_device</a>-&gt;GetDeviceData( <span class="keyword">sizeof</span>(DIDEVICEOBJECTDATA),
00906                                                   mouse_data, &amp;mouseLen, 0)) != DI_OK &amp;&amp; hr != S_FALSE )
00907             mouseLen = 0;
00908         <span class="keywordflow">if</span>( (hr = <a class="code" href="classMouse.html#m6">di_keyb_device</a>-&gt;GetDeviceData( <span class="keyword">sizeof</span>(DIDEVICEOBJECTDATA),
00909                                                  keyb_data, &amp;keybLen, 0)) != DI_OK &amp;&amp; hr != S_FALSE)
00910             keybLen = 0;
00911 
00912         <span class="keywordflow">if</span>( !mouseLen &amp;&amp; !keybLen )
00913             <span class="keywordflow">break</span>;
00914 
00915         DIDEVICEOBJECTDATA *mouseMsg = mouse_data, *keybMsg = keyb_data;
00916 
00917         <span class="keywordflow">while</span>( mouseLen &gt; 0 || keybLen &gt; 0) {
00918             <span class="comment">// merge mouse event and keyboard event</span>
00919             <a class="code" href="structMouseEvent.html">MouseEvent</a> ev;
00920             <span class="keywordtype">int</span> earlyDevice = 0;                        <span class="comment">// 1 = mouse, 2 = keyboard</span>
00921             <span class="keywordflow">if</span>( mouseLen &gt; 0 &amp;&amp; keybLen &gt; 0 ) {
00922                 <span class="keywordflow">if</span>( DISEQUENCE_COMPARE(mouseMsg-&gt;dwSequence, &lt;=, keybMsg-&gt;dwSequence) )
00923                     earlyDevice = 1;
00924                 <span class="keywordflow">else</span>
00925                     earlyDevice = 2;
00926             }
00927             <span class="keywordflow">else</span> <span class="keywordflow">if</span>( mouseLen &gt; 0) {
00928                 earlyDevice = 1;
00929             }
00930             <span class="keywordflow">else</span> <span class="keywordflow">if</span>( keybLen &gt; 0) {
00931                 earlyDevice = 2;
00932             }
00933 
00934             <span class="keywordflow">if</span>( earlyDevice == 1 ) {
00935                 <span class="keywordflow">switch</span>(mouseMsg-&gt;dwOfs) {
00936                 <span class="keywordflow">case</span> DIMOFS_BUTTON0:
00937                     <span class="keywordflow">if</span>( mouseMsg-&gt;dwData &amp; 0x80) {
00938                         <span class="comment">// mouse button pressed</span>
00939                         <span class="comment">//ev.state = left_press = LEFT_BUTTON_MASK;</span>
00940                         <a class="code" href="classMouse.html#m9">left_press</a> = <a class="code" href="Omouse_8h.html#a1">LEFT_BUTTON_MASK</a>;
00941                         ev.<a class="code" href="structMouseEvent.html#m0">event_type</a> = <a class="code" href="Omouse_8h.html#a28a22">LEFT_BUTTON</a>;
00942                         ev.<a class="code" href="structMouseEvent.html#m3">x</a> = <a class="code" href="classMouse.html#m7">cur_x</a>;
00943                         ev.<a class="code" href="structMouseEvent.html#m4">y</a> = <a class="code" href="classMouse.html#m8">cur_y</a>;
00944                         ev.<a class="code" href="structMouseEvent.html#m1">time</a> = mouseMsg-&gt;dwTimeStamp;
00945                         ev.<a class="code" href="structMouseEvent.html#m5">scan_code</a> = 0;
00946                         ev.<a class="code" href="structMouseEvent.html#m2">skey_state</a> = <a class="code" href="classMouse.html#m11">skey_state</a>;
00947                         <a class="code" href="classMouse.html#a4">add_event</a>(&amp;ev);
00948                     }
00949                     <span class="keywordflow">else</span> {
00950                         <span class="comment">// mouse button released</span>
00951                         <a class="code" href="classMouse.html#m9">left_press</a> = 0;
00952                         ev.<a class="code" href="structMouseEvent.html#m0">event_type</a> = <a class="code" href="Omouse_8h.html#a28a25">LEFT_BUTTON_RELEASE</a>;
00953                         ev.<a class="code" href="structMouseEvent.html#m3">x</a> = <a class="code" href="classMouse.html#m7">cur_x</a>;
00954                         ev.<a class="code" href="structMouseEvent.html#m4">y</a> = <a class="code" href="classMouse.html#m8">cur_y</a>;
00955                         ev.<a class="code" href="structMouseEvent.html#m1">time</a> = mouseMsg-&gt;dwTimeStamp;
00956                         ev.<a class="code" href="structMouseEvent.html#m5">scan_code</a> = 0;
00957                         ev.<a class="code" href="structMouseEvent.html#m2">skey_state</a> = <a class="code" href="classMouse.html#m11">skey_state</a>;
00958                         <a class="code" href="classMouse.html#a4">add_event</a>(&amp;ev);
00959                         <a class="code" href="classMouse.html#a18">reset_boundary</a>();                   <span class="comment">// reset_boundary whenever left button is released</span>
00960                     }
00961                     <span class="keywordflow">break</span>;
00962                 <span class="keywordflow">case</span> DIMOFS_BUTTON1:
00963                     <span class="keywordflow">if</span>( mouseMsg-&gt;dwData &amp; 0x80) {
00964                         <span class="comment">// mouse button pressed</span>
00965                         <a class="code" href="classMouse.html#m10">right_press</a> = <a class="code" href="Omouse_8h.html#a2">RIGHT_BUTTON_MASK</a>;
00966                         ev.<a class="code" href="structMouseEvent.html#m0">event_type</a> = <a class="code" href="Omouse_8h.html#a28a23">RIGHT_BUTTON</a>;
00967                         ev.<a class="code" href="structMouseEvent.html#m3">x</a> = <a class="code" href="classMouse.html#m7">cur_x</a>;
00968                         ev.<a class="code" href="structMouseEvent.html#m4">y</a> = <a class="code" href="classMouse.html#m8">cur_y</a>;
00969                         ev.<a class="code" href="structMouseEvent.html#m1">time</a> = mouseMsg-&gt;dwTimeStamp;
00970                         ev.<a class="code" href="structMouseEvent.html#m5">scan_code</a> = 0;
00971                         ev.<a class="code" href="structMouseEvent.html#m2">skey_state</a> = <a class="code" href="classMouse.html#m11">skey_state</a>;
00972                         <a class="code" href="classMouse.html#a4">add_event</a>(&amp;ev);
00973                     }
00974                     <span class="keywordflow">else</span> {
00975                         <span class="comment">// mouse button released</span>
00976                         <a class="code" href="classMouse.html#m10">right_press</a> = 0;
00977                         ev.<a class="code" href="structMouseEvent.html#m0">event_type</a> = <a class="code" href="Omouse_8h.html#a28a26">RIGHT_BUTTON_RELEASE</a>;
00978                         ev.<a class="code" href="structMouseEvent.html#m3">x</a> = <a class="code" href="classMouse.html#m7">cur_x</a>;
00979                         ev.<a class="code" href="structMouseEvent.html#m4">y</a> = <a class="code" href="classMouse.html#m8">cur_y</a>;
00980                         ev.<a class="code" href="structMouseEvent.html#m1">time</a> = mouseMsg-&gt;dwTimeStamp;
00981                         ev.<a class="code" href="structMouseEvent.html#m5">scan_code</a> = 0;
00982                         ev.<a class="code" href="structMouseEvent.html#m2">skey_state</a> = <a class="code" href="classMouse.html#m11">skey_state</a>;
00983                         <a class="code" href="classMouse.html#a4">add_event</a>(&amp;ev);
00984                     }
00985                     <span class="keywordflow">break</span>;
00986                 <span class="keywordflow">case</span> DIMOFS_BUTTON2:
00987                     <span class="comment">// not interested</span>
00988                     <span class="keywordflow">break</span>;
00989                 <span class="keywordflow">case</span> DIMOFS_BUTTON3:
00990                     <span class="comment">// not interested</span>
00991                     <span class="keywordflow">break</span>;
00992                 <span class="keywordflow">case</span> DIMOFS_X:
00993                     <a class="code" href="classMouse.html#m7">cur_x</a> += micky_to_displacement(mouseMsg-&gt;dwData);
00994                     <span class="keywordflow">if</span>(<a class="code" href="classMouse.html#m7">cur_x</a> &lt; <a class="code" href="classMouse.html#m12">bound_x1</a>)
00995                         <a class="code" href="classMouse.html#m7">cur_x</a> = <a class="code" href="classMouse.html#m12">bound_x1</a>;
00996                     <span class="keywordflow">if</span>(<a class="code" href="classMouse.html#m7">cur_x</a> &gt; <a class="code" href="classMouse.html#m14">bound_x2</a>)
00997                         <a class="code" href="classMouse.html#m7">cur_x</a> = <a class="code" href="classMouse.html#m14">bound_x2</a>;
00998                     moveFlag = 1;
00999                     <span class="keywordflow">break</span>;
01000                 <span class="keywordflow">case</span> DIMOFS_Y:
01001                     <a class="code" href="classMouse.html#m8">cur_y</a> += micky_to_displacement(mouseMsg-&gt;dwData);
01002                     <span class="keywordflow">if</span>(<a class="code" href="classMouse.html#m8">cur_y</a> &lt; <a class="code" href="classMouse.html#m13">bound_y1</a>)
01003                         <a class="code" href="classMouse.html#m8">cur_y</a> = <a class="code" href="classMouse.html#m13">bound_y1</a>;
01004                     <span class="keywordflow">if</span>(<a class="code" href="classMouse.html#m8">cur_y</a> &gt; <a class="code" href="classMouse.html#m15">bound_y2</a>)
01005                         <a class="code" href="classMouse.html#m8">cur_y</a> = <a class="code" href="classMouse.html#m15">bound_y2</a>;
01006                     moveFlag = 1;
01007                     <span class="keywordflow">break</span>;
01008                 <span class="keywordflow">case</span> DIMOFS_Z:
01009                     <span class="comment">// not interested</span>
01010                     <span class="keywordflow">break</span>;
01011                 }
01012                 --mouseLen;
01013                 ++mouseMsg;
01014             }
01015             <span class="keywordflow">else</span> <span class="keywordflow">if</span>( earlyDevice == 2 ) {
01016                 <span class="comment">// trap keys, such as shift, ctrl, alt, numlock, caplock and scrolllock</span>
01017                 <span class="comment">// add to event if the key is none of the above</span>
01018                 <span class="keywordflow">switch</span>( keybMsg-&gt;dwOfs ) {
01019                 <span class="keywordflow">case</span> DIK_LSHIFT:
01020                     <span class="keywordflow">if</span>( keybMsg-&gt;dwData &amp; 0x80 )
01021                         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a3">LEFT_SHIFT_KEY_MASK</a>;
01022                     <span class="keywordflow">else</span>
01023                         <a class="code" href="classMouse.html#m11">skey_state</a> &amp;= ~<a class="code" href="Omouse_8h.html#a3">LEFT_SHIFT_KEY_MASK</a>;
01024                     <span class="keywordflow">break</span>;
01025                 <span class="keywordflow">case</span> DIK_RSHIFT:
01026                     <span class="keywordflow">if</span>( keybMsg-&gt;dwData &amp; 0x80 )
01027                         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a4">RIGHT_SHIFT_KEY_MASK</a>;
01028                     <span class="keywordflow">else</span>
01029                         <a class="code" href="classMouse.html#m11">skey_state</a> &amp;= ~<a class="code" href="Omouse_8h.html#a4">RIGHT_SHIFT_KEY_MASK</a>;
01030                     <span class="keywordflow">break</span>;
01031                 <span class="keywordflow">case</span> DIK_LCONTROL:
01032                     <span class="keywordflow">if</span>( keybMsg-&gt;dwData &amp; 0x80 )
01033                         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a6">LEFT_CONTROL_KEY_MASK</a>;
01034                     <span class="keywordflow">else</span>
01035                         <a class="code" href="classMouse.html#m11">skey_state</a> &amp;= ~<a class="code" href="Omouse_8h.html#a6">LEFT_CONTROL_KEY_MASK</a>;
01036                     <span class="keywordflow">break</span>;
01037                 <span class="keywordflow">case</span> DIK_RCONTROL:
01038                     <span class="keywordflow">if</span>( keybMsg-&gt;dwData &amp; 0x80 )
01039                         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a7">RIGHT_CONTROL_KEY_MASK</a>;
01040                     <span class="keywordflow">else</span>
01041                         <a class="code" href="classMouse.html#m11">skey_state</a> &amp;= ~<a class="code" href="Omouse_8h.html#a7">RIGHT_CONTROL_KEY_MASK</a>;
01042                     <span class="keywordflow">break</span>;
01043                 <span class="keywordflow">case</span> DIK_LMENU:
01044                     <span class="keywordflow">if</span>( keybMsg-&gt;dwData &amp; 0x80 )
01045                         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a9">LEFT_ALT_KEY_MASK</a>;
01046                     <span class="keywordflow">else</span>
01047                         <a class="code" href="classMouse.html#m11">skey_state</a> &amp;= ~<a class="code" href="Omouse_8h.html#a9">LEFT_ALT_KEY_MASK</a>;
01048                     <span class="keywordflow">break</span>;
01049                 <span class="keywordflow">case</span> DIK_RMENU:
01050                     <span class="keywordflow">if</span>( keybMsg-&gt;dwData &amp; 0x80 )
01051                         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a10">RIGHT_ALT_KEY_MASK</a>;
01052                     <span class="keywordflow">else</span>
01053                         <a class="code" href="classMouse.html#m11">skey_state</a> &amp;= ~<a class="code" href="Omouse_8h.html#a10">RIGHT_ALT_KEY_MASK</a>;
01054                     <span class="keywordflow">break</span>;
01055                 <span class="keywordflow">case</span> DIK_CAPITAL:
01056                     <span class="keywordflow">if</span>(keybMsg-&gt;dwData &amp; 0x80)
01057                         <a class="code" href="classMouse.html#m11">skey_state</a> ^= <a class="code" href="Omouse_8h.html#a13">CAP_LOCK_STATE_MASK</a>;
01058                     <span class="keywordflow">break</span>;
01059                 <span class="keywordflow">case</span> DIK_NUMLOCK:
01060                     <span class="keywordflow">if</span>(keybMsg-&gt;dwData &amp; 0x80)
01061                         <a class="code" href="classMouse.html#m11">skey_state</a> ^= <a class="code" href="Omouse_8h.html#a12">NUM_LOCK_STATE_MASK</a>;
01062                     <span class="keywordflow">break</span>;
01063                 <span class="keywordflow">case</span> DIK_SCROLL:
01064                     <span class="keywordflow">if</span>(keybMsg-&gt;dwData &amp; 0x80)
01065                         <a class="code" href="classMouse.html#m11">skey_state</a> ^= <a class="code" href="Omouse_8h.html#a14">SCROLL_LOCK_STATE_MASK</a>;
01066                     <span class="keywordflow">break</span>;
01067 
01068                 <span class="keywordflow">case</span> DIK_INSERT:
01069                     <span class="keywordflow">if</span>(keybMsg-&gt;dwData &amp; 0x80) {
01070                         <span class="comment">// insert is a special case, it toggle skey_state and</span>
01071                         <span class="comment">// append event queue</span>
01072                         <a class="code" href="classMouse.html#m11">skey_state</a> ^= <a class="code" href="Omouse_8h.html#a15">INSERT_STATE_MASK</a>;
01073                         <a class="code" href="classMouse.html#a5">add_key_event</a>(keybMsg-&gt;dwOfs, keybMsg-&gt;dwTimeStamp);
01074                     }
01075                     <span class="keywordflow">break</span>;
01076 
01077                 <span class="keywordflow">default</span>:
01078                     <span class="keywordflow">if</span>( keybMsg-&gt;dwData &amp; 0x80 )
01079                         <a class="code" href="classMouse.html#a5">add_key_event</a>(keybMsg-&gt;dwOfs, keybMsg-&gt;dwTimeStamp);
01080                 }
01081                 --keybLen;
01082                 ++keybMsg;
01083             }
01084         }
01085     }
01086 
01087     <span class="comment">// ####### begin Gilbert 12/4 ########//</span>
01088     <span class="keywordflow">if</span>(moveFlag) {
01089         <span class="comment">// ##### begin Gilbert 06/03/2001 #######//</span>
01090         <span class="keywordflow">if</span>( sys.use_true_front == 2 ) {               <span class="comment">// window mode</span>
01091             POINT cursorPos;
01092             <span class="keywordflow">if</span>( GetCursorPos(&amp;cursorPos)
01093                 &amp;&amp; ScreenToClient( sys.main_hwnd, &amp;cursorPos )
01094                 &amp;&amp; cursorPos.x &gt;= <a class="code" href="classMouse.html#m12">bound_x1</a> &amp;&amp; cursorPos.x &lt;= <a class="code" href="classMouse.html#m14">bound_x2</a>
01095                 &amp;&amp; cursorPos.y &gt;= <a class="code" href="classMouse.html#m13">bound_y1</a> &amp;&amp; cursorPos.y &lt;= <a class="code" href="classMouse.html#m15">bound_y2</a> ) {
01096                 <a class="code" href="classMouse.html#m7">cur_x</a> = cursorPos.x;
01097                 <a class="code" href="classMouse.html#m8">cur_y</a> = cursorPos.y;
01098             }
01099         }
01100         <span class="comment">// ##### end Gilbert 06/03/2001 #######//</span>
01101         mouse_cursor.process(<a class="code" href="classMouse.html#m7">cur_x</a>, <a class="code" href="classMouse.html#m8">cur_y</a>);           <span class="comment">// repaint mouse cursor</span>
01102         power.mouse_handler();
01103     }
01104     <span class="comment">// ####### end Gilbert 12/4 ########//</span>
01105 }
01106 
01107 <span class="comment">//--------- End of Mouse::poll_event --------------//</span>
01108 
01109 <span class="comment">// ####### begin Gilbert 31/10 #########//</span>
01110 <span class="comment">//--------- Begin of Mouse::update_skey_state ----------//</span>
01111 <span class="comment">// called after task switch to get the lastest state of ctrl/alt/shift key</span>
<a name="l01112"></a><a class="code" href="classMouse.html#a9">01112</a> <span class="keywordtype">void</span> <a class="code" href="classMouse.html#a9">Mouse::update_skey_state</a>() {
01113     <span class="comment">// ------- get initial keyboard state ----------//</span>
01114     <a class="code" href="classMouse.html#m11">skey_state</a> = 0;
01115     <span class="keywordflow">if</span>(GetKeyState(VK_LSHIFT) &lt; 0)
01116         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a3">LEFT_SHIFT_KEY_MASK</a>;
01117     <span class="keywordflow">if</span>(GetKeyState(VK_RSHIFT) &lt; 0)
01118         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a4">RIGHT_SHIFT_KEY_MASK</a>;
01119     <span class="keywordflow">if</span>(GetKeyState(VK_LCONTROL) &lt; 0)
01120         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a6">LEFT_CONTROL_KEY_MASK</a>;
01121     <span class="keywordflow">if</span>(GetKeyState(VK_RCONTROL) &lt; 0)
01122         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a7">RIGHT_CONTROL_KEY_MASK</a>;
01123     <span class="keywordflow">if</span>(GetKeyState(VK_LMENU) &lt; 0)
01124         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a9">LEFT_ALT_KEY_MASK</a>;
01125     <span class="keywordflow">if</span>(GetKeyState(VK_RMENU) &lt; 0)
01126         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a10">RIGHT_ALT_KEY_MASK</a>;
01127     <span class="keywordflow">if</span>(GetKeyState(VK_NUMLOCK) &amp; 1)
01128         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a12">NUM_LOCK_STATE_MASK</a>;
01129     <span class="keywordflow">if</span>(GetKeyState(VK_CAPITAL) &amp; 1)
01130         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a13">CAP_LOCK_STATE_MASK</a>;
01131     <span class="keywordflow">if</span>(GetKeyState(VK_SCROLL) &amp; 1)
01132         <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a14">SCROLL_LOCK_STATE_MASK</a>;
01133     <a class="code" href="classMouse.html#m11">skey_state</a> |= <a class="code" href="Omouse_8h.html#a15">INSERT_STATE_MASK</a>;                <span class="comment">// enable insert mode by default</span>
01134 }
01135 
01136 <span class="comment">//--------- End of Mouse::update_skey_state ----------//</span>
01137 <span class="comment">// ####### end Gilbert 31/10 #########//</span>
01138 
01139 <span class="comment">//--------- Begin of Mouse::wait_press ----------//</span>
01140 <span class="comment">//</span>
01141 <span class="comment">// Wait until one of the mouse buttons is pressed.</span>
01142 <span class="comment">//</span>
01143 <span class="comment">// [int] timeOutSecond - no. of seconds to time out. If not</span>
01144 <span class="comment">//                                                               given, there will be no time out.</span>
01145 <span class="comment">//</span>
01146 <span class="comment">// return: &lt;int&gt; 1-left mouse button</span>
01147 <span class="comment">//                                        2-right mouse button</span>
01148 <span class="comment">//</span>
<a name="l01149"></a><a class="code" href="classMouse.html#a16">01149</a> <span class="keywordtype">int</span> <a class="code" href="classMouse.html#a16">Mouse::wait_press</a>(<span class="keywordtype">int</span> timeOutSecond) {
01150     <span class="comment">// avoid repeat clicking</span>
01151     <span class="keywordflow">while</span>( mouse.left_press || mouse.any_click() || mouse.key_code ) {
01152         sys.yield();
01153         mouse.get_event();
01154     }
01155 
01156     <span class="keywordtype">int</span> rc=0;
01157     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timeOutTime = m.get_time() + timeOutSecond*1000;
01158 
01159     <span class="keywordflow">while</span>(1) {
01160         sys.yield();
01161         mouse.get_event();
01162 
01163         <span class="comment">// if( sys.debug_session )</span>
01164         sys.blt_virtual_buf();
01165 
01166         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m10">right_press</a> || mouse.key_code==<a class="code" href="KEY_8H.html#a2">KEY_ESC</a> ) {
01167             rc = 2;
01168             <span class="keywordflow">break</span>;
01169         }
01170 
01171         <span class="keywordflow">if</span>( <a class="code" href="classMouse.html#m9">left_press</a> || mouse.key_code ) {
01172             rc = 1;
01173             <span class="keywordflow">break</span>;
01174         }
01175 
01176         <span class="keywordflow">if</span>( timeOutSecond &amp;&amp; m.get_time() &gt; timeOutTime )
01177             <span class="keywordflow">break</span>;
01178     }
01179 
01180     <span class="comment">// avoid repeat clicking</span>
01181     <span class="keywordflow">while</span>( mouse.left_press || mouse.any_click() || mouse.key_code ) {
01182         sys.yield();
01183         mouse.get_event();
01184     }
01185 
01186     <span class="keywordflow">return</span> rc;
01187 }
01188 
01189 <span class="comment">//--------- End of Mouse::wait_press --------------//</span>
01190 
01191 <span class="comment">//--------- Begin of Mouse::reset_click ----------//</span>
01192 <span class="comment">//</span>
01193 <span class="comment">// Reset queued mouse clicks.</span>
01194 <span class="comment">//</span>
<a name="l01195"></a><a class="code" href="classMouse.html#a35">01195</a> <span class="keywordtype">void</span> <a class="code" href="classMouse.html#a35">Mouse::reset_click</a>() {
01196     <a class="code" href="classMouse.html#m21">click_buffer</a>[0].<a class="code" href="structMouseClick.html#m4">count</a>=0;
01197     <a class="code" href="classMouse.html#m21">click_buffer</a>[1].<a class="code" href="structMouseClick.html#m4">count</a>=0;
01198 }
01199 
01200 <span class="comment">//--------- End of Mouse::reset_click --------------//</span>
01201 
01202 <span class="comment">// ------ Begin of Mouse::mickey_to_displacment -------//</span>
01203 <span class="keywordtype">long</span> Mouse::micky_to_displacement(DWORD w) {
01204     <span class="keywordtype">long</span> d = (long)w ;
01205     <span class="comment">// long a = abs(d);</span>
01206     <span class="comment">// return a &gt;= double_speed_threshold ? (a &gt;= triple_speed_threshold ? 3 * d : 2 * d) : d;</span>
01207     <span class="keywordflow">return</span> abs(d) &gt;= <a class="code" href="classMouse.html#m16">double_speed_threshold</a> ? d+d : d;
01208 }
01209 
01210 <span class="comment">// ------ End of Mouse::mickey_to_displacment -------//</span>
01211 
01212 <span class="comment">// ------ Begin of Mouse::is_key -------//</span>
01213 <span class="comment">// compare key with key code</span>
01214 <span class="comment">// e.g. to test a key is alt-a,</span>
01215 <span class="comment">// call mouse.is_key(mouse.scan_code, mouse.event_skey_state, 'a', K_CHAR_KEY | K_IS_ALT)</span>
01216 <span class="comment">//</span>
01217 <span class="comment">// pass 0 as charValue to disable checking in charValue</span>
01218 <span class="comment">// e.g pressed key is 'a'</span>
01219 <span class="comment">// mouse.is_key(mouse.scan_code, mouse.event_skey_state, (WORD) 0, K_CHAR_KEY) returns 'a'</span>
01220 <span class="comment">// but if key pressed is alt-a</span>
01221 <span class="comment">// the same function call returns 0</span>
01222 <span class="comment">// use mouse.is_key(mouse.scan_code, mouse.event_skey_state, (WORD) 0, K_CHAR_KEY | K_IS_ALT ) instead</span>
01223 <span class="comment">//</span>
<a name="l01224"></a><a class="code" href="classMouse.html#d0">01224</a> <span class="keywordtype">int</span> <a class="code" href="classMouse.html#d0">Mouse::is_key</a>(<span class="keywordtype">unsigned</span> scanCode, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> skeyState, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> charValue, <span class="keywordtype">unsigned</span> flags) {
01225     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> priChar = 0, shiftChar = 0, capitalChar = 0;
01226     <span class="keywordtype">unsigned</span> onNumPad = 0;
01227 
01228     <span class="keywordflow">switch</span>(scanCode) {
01229     <span class="keywordflow">case</span> DIK_ESCAPE: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a2">KEY_ESC</a>; <span class="keywordflow">break</span>;
01230     <span class="keywordflow">case</span> DIK_1: priChar = capitalChar = <span class="charliteral">'1'</span>; shiftChar = <span class="charliteral">'!'</span>; <span class="keywordflow">break</span>;
01231     <span class="keywordflow">case</span> DIK_2: priChar = capitalChar = <span class="charliteral">'2'</span>; shiftChar = <span class="charliteral">'@'</span>; <span class="keywordflow">break</span>;
01232     <span class="keywordflow">case</span> DIK_3: priChar = capitalChar = <span class="charliteral">'3'</span>; shiftChar = <span class="charliteral">'#'</span>; <span class="keywordflow">break</span>;
01233     <span class="keywordflow">case</span> DIK_4: priChar = capitalChar = <span class="charliteral">'4'</span>; shiftChar = <span class="charliteral">'$'</span>; <span class="keywordflow">break</span>;
01234     <span class="keywordflow">case</span> DIK_5: priChar = capitalChar = <span class="charliteral">'5'</span>; shiftChar = <span class="charliteral">'%'</span>; <span class="keywordflow">break</span>;
01235     <span class="keywordflow">case</span> DIK_6: priChar = capitalChar = <span class="charliteral">'6'</span>; shiftChar = <span class="charliteral">'^'</span>; <span class="keywordflow">break</span>;
01236     <span class="keywordflow">case</span> DIK_7: priChar = capitalChar = <span class="charliteral">'7'</span>; shiftChar = <span class="charliteral">'&amp;'</span>; <span class="keywordflow">break</span>;
01237     <span class="keywordflow">case</span> DIK_8: priChar = capitalChar = <span class="charliteral">'8'</span>; shiftChar = <span class="charliteral">'*'</span>; <span class="keywordflow">break</span>;
01238     <span class="keywordflow">case</span> DIK_9: priChar = capitalChar = <span class="charliteral">'9'</span>; shiftChar = <span class="charliteral">'('</span>; <span class="keywordflow">break</span>;
01239     <span class="keywordflow">case</span> DIK_0: priChar = capitalChar = <span class="charliteral">'0'</span>; shiftChar = <span class="charliteral">')'</span>; <span class="keywordflow">break</span>;
01240     <span class="keywordflow">case</span> DIK_MINUS: priChar = capitalChar = <span class="charliteral">'-'</span>; shiftChar = <span class="charliteral">'_'</span>; <span class="keywordflow">break</span>;
01241     <span class="keywordflow">case</span> DIK_EQUALS: priChar = capitalChar = <span class="charliteral">'='</span>; shiftChar = <span class="charliteral">'+'</span>; <span class="keywordflow">break</span>;
01242         <span class="comment">// backspace</span>
01243     <span class="keywordflow">case</span> DIK_BACK: priChar = capitalChar = shiftChar = <a class="code" href="KEY_8H.html#a0">KEY_BACK_SPACE</a>; <span class="keywordflow">break</span>;
01244     <span class="keywordflow">case</span> DIK_TAB: priChar = capitalChar = shiftChar = <a class="code" href="KEY_8H.html#a1">KEY_TAB</a>; <span class="keywordflow">break</span>;
01245     <span class="keywordflow">case</span> DIK_Q: priChar = <span class="charliteral">'q'</span>; capitalChar = shiftChar = <span class="charliteral">'Q'</span>; <span class="keywordflow">break</span>;
01246     <span class="keywordflow">case</span> DIK_W: priChar = <span class="charliteral">'w'</span>; capitalChar = shiftChar = <span class="charliteral">'W'</span>; <span class="keywordflow">break</span>;
01247     <span class="keywordflow">case</span> DIK_E: priChar = <span class="charliteral">'e'</span>; capitalChar = shiftChar = <span class="charliteral">'E'</span>; <span class="keywordflow">break</span>;
01248     <span class="keywordflow">case</span> DIK_R: priChar = <span class="charliteral">'r'</span>; capitalChar = shiftChar = <span class="charliteral">'R'</span>; <span class="keywordflow">break</span>;
01249     <span class="keywordflow">case</span> DIK_T: priChar = <span class="charliteral">'t'</span>; capitalChar = shiftChar = <span class="charliteral">'T'</span>; <span class="keywordflow">break</span>;
01250     <span class="keywordflow">case</span> DIK_Y: priChar = <span class="charliteral">'y'</span>; capitalChar = shiftChar = <span class="charliteral">'Y'</span>; <span class="keywordflow">break</span>;
01251     <span class="keywordflow">case</span> DIK_U: priChar = <span class="charliteral">'u'</span>; capitalChar = shiftChar = <span class="charliteral">'U'</span>; <span class="keywordflow">break</span>;
01252     <span class="keywordflow">case</span> DIK_I: priChar = <span class="charliteral">'i'</span>; capitalChar = shiftChar = <span class="charliteral">'I'</span>; <span class="keywordflow">break</span>;
01253     <span class="keywordflow">case</span> DIK_O: priChar = <span class="charliteral">'o'</span>; capitalChar = shiftChar = <span class="charliteral">'O'</span>; <span class="keywordflow">break</span>;
01254     <span class="keywordflow">case</span> DIK_P: priChar = <span class="charliteral">'p'</span>; capitalChar = shiftChar = <span class="charliteral">'P'</span>; <span class="keywordflow">break</span>;
01255     <span class="keywordflow">case</span> DIK_LBRACKET: priChar = capitalChar = <span class="charliteral">'['</span>; shiftChar = <span class="charliteral">'{'</span>; <span class="keywordflow">break</span>;
01256     <span class="keywordflow">case</span> DIK_RBRACKET: priChar = capitalChar = <span class="charliteral">']'</span>; shiftChar = <span class="charliteral">'}'</span>; <span class="keywordflow">break</span>;
01257     <span class="keywordflow">case</span> DIK_NUMPADENTER:                         <span class="comment">// Enter on numeric keypad</span>
01258         onNumPad = 1;                               <span class="comment">// fall through</span>
01259     <span class="keywordflow">case</span> DIK_RETURN: priChar = capitalChar = shiftChar = <a class="code" href="KEY_8H.html#a3">KEY_RETURN</a>;  <span class="keywordflow">break</span>;
01260     <span class="keywordflow">case</span> DIK_A: priChar = <span class="charliteral">'a'</span>; capitalChar = shiftChar = <span class="charliteral">'A'</span>; <span class="keywordflow">break</span>;
01261     <span class="keywordflow">case</span> DIK_S: priChar = <span class="charliteral">'s'</span>; capitalChar = shiftChar = <span class="charliteral">'S'</span>; <span class="keywordflow">break</span>;
01262     <span class="keywordflow">case</span> DIK_D: priChar = <span class="charliteral">'d'</span>; capitalChar = shiftChar = <span class="charliteral">'D'</span>; <span class="keywordflow">break</span>;
01263     <span class="keywordflow">case</span> DIK_F: priChar = <span class="charliteral">'f'</span>; capitalChar = shiftChar = <span class="charliteral">'F'</span>; <span class="keywordflow">break</span>;
01264     <span class="keywordflow">case</span> DIK_G: priChar = <span class="charliteral">'g'</span>; capitalChar = shiftChar = <span class="charliteral">'G'</span>; <span class="keywordflow">break</span>;
01265     <span class="keywordflow">case</span> DIK_H: priChar = <span class="charliteral">'h'</span>; capitalChar = shiftChar = <span class="charliteral">'H'</span>; <span class="keywordflow">break</span>;
01266     <span class="keywordflow">case</span> DIK_J: priChar = <span class="charliteral">'j'</span>; capitalChar = shiftChar = <span class="charliteral">'J'</span>; <span class="keywordflow">break</span>;
01267     <span class="keywordflow">case</span> DIK_K: priChar = <span class="charliteral">'k'</span>; capitalChar = shiftChar = <span class="charliteral">'K'</span>; <span class="keywordflow">break</span>;
01268     <span class="keywordflow">case</span> DIK_L: priChar = <span class="charliteral">'l'</span>; capitalChar = shiftChar = <span class="charliteral">'L'</span>; <span class="keywordflow">break</span>;
01269     <span class="keywordflow">case</span> DIK_SEMICOLON: priChar = capitalChar = <span class="charliteral">';'</span>; shiftChar = <span class="charliteral">':'</span>; <span class="keywordflow">break</span>;
01270     <span class="keywordflow">case</span> DIK_APOSTROPHE: priChar = capitalChar = <span class="charliteral">'\''</span>; shiftChar = <span class="charliteral">'\"'</span>; <span class="keywordflow">break</span>;
01271     <span class="keywordflow">case</span> DIK_GRAVE: priChar = capitalChar = <span class="charliteral">'~'</span>; shiftChar = <span class="charliteral">'`'</span>; <span class="keywordflow">break</span>;
01272     <span class="keywordflow">case</span> DIK_BACKSLASH: priChar = capitalChar = <span class="charliteral">'\\'</span>; shiftChar = <span class="charliteral">'|'</span>; <span class="keywordflow">break</span>;
01273     <span class="keywordflow">case</span> DIK_Z: priChar = <span class="charliteral">'z'</span>; capitalChar = shiftChar = <span class="charliteral">'Z'</span>; <span class="keywordflow">break</span>;
01274     <span class="keywordflow">case</span> DIK_X: priChar = <span class="charliteral">'x'</span>; capitalChar = shiftChar = <span class="charliteral">'X'</span>; <span class="keywordflow">break</span>;
01275     <span class="keywordflow">case</span> DIK_C: priChar = <span class="charliteral">'c'</span>; capitalChar = shiftChar = <span class="charliteral">'C'</span>; <span class="keywordflow">break</span>;
01276     <span class="keywordflow">case</span> DIK_V: priChar = <span class="charliteral">'v'</span>; capitalChar = shiftChar = <span class="charliteral">'V'</span>; <span class="keywordflow">break</span>;
01277     <span class="keywordflow">case</span> DIK_B: priChar = <span class="charliteral">'b'</span>; capitalChar = shiftChar = <span class="charliteral">'B'</span>; <span class="keywordflow">break</span>;
01278     <span class="keywordflow">case</span> DIK_N: priChar = <span class="charliteral">'n'</span>; capitalChar = shiftChar = <span class="charliteral">'N'</span>; <span class="keywordflow">break</span>;
01279     <span class="keywordflow">case</span> DIK_M: priChar = <span class="charliteral">'m'</span>; capitalChar = shiftChar = <span class="charliteral">'M'</span>; <span class="keywordflow">break</span>;
01280     <span class="keywordflow">case</span> DIK_COMMA: priChar = capitalChar = <span class="charliteral">','</span>; shiftChar = <span class="charliteral">'&lt;'</span>; <span class="keywordflow">break</span>;
01281     <span class="keywordflow">case</span> DIK_PERIOD: priChar = capitalChar = <span class="charliteral">'.'</span>; shiftChar = <span class="charliteral">'&gt;'</span>; <span class="keywordflow">break</span>;
01282     <span class="keywordflow">case</span> DIK_SLASH: priChar = capitalChar = <span class="charliteral">'/'</span>; shiftChar = <span class="charliteral">'\?'</span>; <span class="keywordflow">break</span>;
01283         <span class="comment">// * on numeric keypad</span>
01284     <span class="keywordflow">case</span> DIK_MULTIPLY: priChar = capitalChar = shiftChar = <span class="charliteral">'*'</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01285     <span class="keywordflow">case</span> DIK_SPACE: priChar = capitalChar = shiftChar = <span class="charliteral">' '</span>; <span class="keywordflow">break</span>;
01286         <span class="comment">// + on numeric keypad</span>
01287     <span class="keywordflow">case</span> DIK_ADD: priChar = capitalChar = shiftChar = <span class="charliteral">'+'</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01288         <span class="comment">// / on numeric keypad</span>
01289     <span class="keywordflow">case</span> DIK_DIVIDE: priChar = capitalChar = shiftChar = <span class="charliteral">'/'</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01290         <span class="comment">// - on numeric keypad</span>
01291     <span class="keywordflow">case</span> DIK_SUBTRACT: priChar = capitalChar = shiftChar = <span class="charliteral">'-'</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01292 
01293     <span class="keywordflow">case</span> DIK_NUMPAD7: priChar = shiftChar = capitalChar = <span class="charliteral">'7'</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01294     <span class="keywordflow">case</span> DIK_NUMPAD8: priChar = shiftChar = capitalChar = <span class="charliteral">'8'</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01295     <span class="keywordflow">case</span> DIK_NUMPAD9: priChar = shiftChar = capitalChar = <span class="charliteral">'9'</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01296     <span class="keywordflow">case</span> DIK_NUMPAD4: priChar = shiftChar = capitalChar = <span class="charliteral">'4'</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01297     <span class="keywordflow">case</span> DIK_NUMPAD5: priChar = shiftChar = capitalChar = <span class="charliteral">'5'</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01298     <span class="keywordflow">case</span> DIK_NUMPAD6: priChar = shiftChar = capitalChar = <span class="charliteral">'6'</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01299     <span class="keywordflow">case</span> DIK_NUMPAD1: priChar = shiftChar = capitalChar = <span class="charliteral">'1'</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01300     <span class="keywordflow">case</span> DIK_NUMPAD2: priChar = shiftChar = capitalChar = <span class="charliteral">'2'</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01301     <span class="keywordflow">case</span> DIK_NUMPAD3: priChar = shiftChar = capitalChar = <span class="charliteral">'3'</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01302     <span class="keywordflow">case</span> DIK_NUMPAD0: priChar = shiftChar = capitalChar = <span class="charliteral">'0'</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01303     <span class="keywordflow">case</span> DIK_DECIMAL: priChar = shiftChar = capitalChar = <span class="charliteral">'.'</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01304 
01305         <span class="comment">// function keys</span>
01306     <span class="keywordflow">case</span> DIK_F1: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a16">KEY_F1</a>; <span class="keywordflow">break</span>;
01307     <span class="keywordflow">case</span> DIK_F2: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a17">KEY_F2</a>; <span class="keywordflow">break</span>;
01308     <span class="keywordflow">case</span> DIK_F3: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a18">KEY_F3</a>; <span class="keywordflow">break</span>;
01309     <span class="keywordflow">case</span> DIK_F4: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a19">KEY_F4</a>; <span class="keywordflow">break</span>;
01310     <span class="keywordflow">case</span> DIK_F5: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a20">KEY_F5</a>; <span class="keywordflow">break</span>;
01311     <span class="keywordflow">case</span> DIK_F6: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a21">KEY_F6</a>; <span class="keywordflow">break</span>;
01312     <span class="keywordflow">case</span> DIK_F7: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a22">KEY_F7</a>; <span class="keywordflow">break</span>;
01313     <span class="keywordflow">case</span> DIK_F8: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a23">KEY_F8</a>; <span class="keywordflow">break</span>;
01314     <span class="keywordflow">case</span> DIK_F9: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a24">KEY_F9</a>; <span class="keywordflow">break</span>;
01315     <span class="keywordflow">case</span> DIK_F10: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a25">KEY_F10</a>; <span class="keywordflow">break</span>;
01316     <span class="keywordflow">case</span> DIK_F11: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a26">KEY_F11</a>; <span class="keywordflow">break</span>;
01317     <span class="keywordflow">case</span> DIK_F12: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a27">KEY_F12</a>; <span class="keywordflow">break</span>;
01318 
01319         <span class="comment">// arrow keys</span>
01320     <span class="keywordflow">case</span> DIK_HOME: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a4">KEY_HOME</a>; <span class="keywordflow">break</span>;
01321     <span class="keywordflow">case</span> DIK_UP: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a8">KEY_UP</a>; <span class="keywordflow">break</span>;
01322     <span class="keywordflow">case</span> DIK_PRIOR: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a6">KEY_PGUP</a>; <span class="keywordflow">break</span>;
01323     <span class="keywordflow">case</span> DIK_LEFT: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a11">KEY_LEFT</a>; <span class="keywordflow">break</span>;
01324     <span class="keywordflow">case</span> DIK_RIGHT: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a10">KEY_RIGHT</a>; <span class="keywordflow">break</span>;
01325     <span class="keywordflow">case</span> DIK_END: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a5">KEY_END</a>; <span class="keywordflow">break</span>;
01326     <span class="keywordflow">case</span> DIK_DOWN: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a9">KEY_DOWN</a>; <span class="keywordflow">break</span>;
01327     <span class="keywordflow">case</span> DIK_NEXT: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a7">KEY_PGDN</a>; <span class="keywordflow">break</span>;
01328     <span class="keywordflow">case</span> DIK_INSERT: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a14">KEY_INS</a>; <span class="keywordflow">break</span>;
01329     <span class="keywordflow">case</span> DIK_DELETE: priChar = shiftChar = capitalChar = <a class="code" href="KEY_8H.html#a15">KEY_DEL</a>; <span class="keywordflow">break</span>;
01330 
01331         <span class="comment">// other keys found in Japanese keyboard</span>
01332     <span class="keywordflow">case</span> DIK_NUMPADCOMMA: priChar = shiftChar = capitalChar = <span class="charliteral">','</span>; <span class="keywordflow">break</span>;
01333     <span class="keywordflow">case</span> DIK_NUMPADEQUALS: priChar = shiftChar = capitalChar = <span class="charliteral">'='</span>; <span class="keywordflow">break</span>;
01334     <span class="keywordflow">case</span> DIK_AT: priChar = shiftChar = capitalChar = <span class="charliteral">'@'</span>; <span class="keywordflow">break</span>;
01335     <span class="keywordflow">case</span> DIK_COLON: priChar = shiftChar = capitalChar = <span class="charliteral">':'</span>; <span class="keywordflow">break</span>;
01336     <span class="keywordflow">case</span> DIK_UNDERLINE: priChar = shiftChar = capitalChar = <span class="charliteral">'_'</span>; <span class="keywordflow">break</span>;
01337     }
01338 
01339     <span class="comment">// BUGHERE : numpad key is not translated when numlock is off</span>
01340 
01341     <span class="comment">// check flags</span>
01342     <span class="keywordtype">int</span> retFlag = 1;
01343 
01344     <span class="comment">// check shift key state</span>
01345     <span class="keywordflow">if</span>( !(flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a6">K_IGNORE_SHIFT</a>) ) {
01346         <span class="keywordflow">if</span>( flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a1">K_IS_SHIFT</a> ) {
01347             <span class="keywordflow">if</span>( !(skeyState &amp; <a class="code" href="Omouse_8h.html#a5">SHIFT_KEY_MASK</a>) )
01348                 retFlag = 0;
01349         }
01350         <span class="keywordflow">else</span> {
01351             <span class="keywordflow">if</span>( skeyState &amp; <a class="code" href="Omouse_8h.html#a5">SHIFT_KEY_MASK</a> )
01352                 retFlag = 0;
01353         }
01354     }
01355 
01356     <span class="comment">// check contrl key state</span>
01357     <span class="keywordflow">if</span>( !(flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a7">K_IGNORE_CTRL</a>) ) {
01358         <span class="keywordflow">if</span>( flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a2">K_IS_CTRL</a> ) {
01359             <span class="keywordflow">if</span>( !(skeyState &amp; <a class="code" href="Omouse_8h.html#a8">CONTROL_KEY_MASK</a>) )
01360                 retFlag = 0;
01361         }
01362         <span class="keywordflow">else</span> {
01363             <span class="keywordflow">if</span>( skeyState &amp; <a class="code" href="Omouse_8h.html#a8">CONTROL_KEY_MASK</a> )
01364                 retFlag = 0;
01365         }
01366     }
01367 
01368     <span class="comment">// check alt key state</span>
01369     <span class="keywordflow">if</span>( !(flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a8">K_IGNORE_ALT</a>) ) {
01370         <span class="keywordflow">if</span>( flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a3">K_IS_ALT</a> ) {
01371             <span class="keywordflow">if</span>( !(skeyState &amp; <a class="code" href="Omouse_8h.html#a11">ALT_KEY_MASK</a>) )
01372                 retFlag = 0;
01373         }
01374         <span class="keywordflow">else</span> {
01375             <span class="keywordflow">if</span>( skeyState &amp; <a class="code" href="Omouse_8h.html#a11">ALT_KEY_MASK</a> )
01376                 retFlag = 0;
01377         }
01378     }
01379 
01380     <span class="comment">// check numpad state</span>
01381     <span class="keywordflow">if</span>( !(flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a11">K_IGNORE_NUMPAD</a>) ) {
01382         <span class="keywordflow">if</span>( flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a4">K_ON_NUMPAD</a> ) {
01383             <span class="keywordflow">if</span>( !onNumPad )
01384                 retFlag = 0;
01385         }
01386         <span class="keywordflow">else</span> {
01387             <span class="keywordflow">if</span>( onNumPad )
01388                 retFlag = 0;
01389         }
01390     }
01391 
01392     <span class="keywordtype">unsigned</span> outChar = priChar;
01393     <span class="keywordflow">if</span>( flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a12">K_TRANSLATE_KEY</a> )
01394         outChar = skeyState &amp; <a class="code" href="Omouse_8h.html#a13">CAP_LOCK_STATE_MASK</a> ?
01395             (skeyState &amp; <a class="code" href="Omouse_8h.html#a5">SHIFT_KEY_MASK</a> ? priChar : capitalChar) :
01396                 (skeyState &amp; <a class="code" href="Omouse_8h.html#a5">SHIFT_KEY_MASK</a> ? shiftChar : priChar) ;
01397 
01398     <span class="keywordflow">if</span>(!retFlag)
01399         <span class="keywordflow">return</span> 0;
01400 
01401     <span class="keywordtype">int</span> retFlag2 = (charValue == 0) || outChar == charValue
01402         || ((flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a6">K_IGNORE_SHIFT</a>) &amp;&amp; shiftChar == charValue)
01403         || ((flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a10">K_IGNORE_CAP_LOCK</a>) &amp;&amp; capitalChar == charValue)
01404         || ((flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a5">K_CASE_INSENSITIVE</a>) &amp;&amp; outChar == (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>) tolower(charValue));
01405 
01406     <span class="keywordflow">if</span>(retFlag2)
01407         <span class="keywordflow">return</span> outChar;
01408     <span class="keywordflow">else</span>
01409         <span class="keywordflow">return</span> 0;
01410 }
01411 
01412 <span class="comment">// ------ End of Mouse::is_key -------//</span>
01413 
01414 <span class="comment">// ------ Begin of Mouse::is_key -------//</span>
<a name="l01415"></a><a class="code" href="classMouse.html#d1">01415</a> <span class="keywordtype">int</span> <a class="code" href="classMouse.html#d0">Mouse::is_key</a>(<span class="keywordtype">unsigned</span> scanCode, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> skeyState, <span class="keywordtype">char</span> *keyStr, <span class="keywordtype">unsigned</span> flags) {
01416     <span class="keywordtype">int</span> len = strlen(keyStr);
01417     <span class="keywordflow">if</span>( len == 0)
01418         <span class="keywordflow">return</span> 0;
01419     <span class="keywordflow">if</span>( len == 1)
01420         <span class="keywordflow">return</span> <a class="code" href="classMouse.html#d0">is_key</a>(scanCode, skeyState, keyStr[0], flags);
01421 
01422     <span class="keywordtype">char</span> *priChar = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01423     <span class="keywordtype">char</span> *numLockChar = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01424     <span class="keywordtype">int</span> onNumPad = 0;
01425 
01426     <span class="keywordflow">switch</span>(scanCode) {
01427     <span class="keywordflow">case</span> DIK_F1: numLockChar = priChar = <span class="stringliteral">"F1"</span>; <span class="keywordflow">break</span>;
01428     <span class="keywordflow">case</span> DIK_F2: numLockChar = priChar = <span class="stringliteral">"F2"</span>; <span class="keywordflow">break</span>;
01429     <span class="keywordflow">case</span> DIK_F3: numLockChar = priChar = <span class="stringliteral">"F3"</span>; <span class="keywordflow">break</span>;
01430     <span class="keywordflow">case</span> DIK_F4: numLockChar = priChar = <span class="stringliteral">"F4"</span>; <span class="keywordflow">break</span>;
01431     <span class="keywordflow">case</span> DIK_F5: numLockChar = priChar = <span class="stringliteral">"F5"</span>; <span class="keywordflow">break</span>;
01432     <span class="keywordflow">case</span> DIK_F6: numLockChar = priChar = <span class="stringliteral">"F6"</span>; <span class="keywordflow">break</span>;
01433     <span class="keywordflow">case</span> DIK_F7: numLockChar = priChar = <span class="stringliteral">"F7"</span>; <span class="keywordflow">break</span>;
01434     <span class="keywordflow">case</span> DIK_F8: numLockChar = priChar = <span class="stringliteral">"F8"</span>; <span class="keywordflow">break</span>;
01435     <span class="keywordflow">case</span> DIK_F9: numLockChar = priChar = <span class="stringliteral">"F9"</span>; <span class="keywordflow">break</span>;
01436     <span class="keywordflow">case</span> DIK_F10: numLockChar = priChar = <span class="stringliteral">"F10"</span>; <span class="keywordflow">break</span>;
01437     <span class="keywordflow">case</span> DIK_F11: numLockChar = priChar = <span class="stringliteral">"F11"</span>; <span class="keywordflow">break</span>;
01438     <span class="keywordflow">case</span> DIK_F12: numLockChar = priChar = <span class="stringliteral">"F12"</span>; <span class="keywordflow">break</span>;
01439 
01440     <span class="keywordflow">case</span> DIK_NUMPAD7: priChar = <span class="stringliteral">"HOME"</span>; numLockChar = <span class="stringliteral">"7"</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01441     <span class="keywordflow">case</span> DIK_NUMPAD8: priChar = <span class="stringliteral">"UP"</span>; numLockChar = <span class="stringliteral">"8"</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01442     <span class="keywordflow">case</span> DIK_NUMPAD9: priChar = <span class="stringliteral">"PAGE UP"</span>; numLockChar = <span class="stringliteral">"9"</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01443     <span class="keywordflow">case</span> DIK_NUMPAD4: priChar = <span class="stringliteral">"LEFT"</span>; numLockChar = <span class="stringliteral">"4"</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01444     <span class="keywordflow">case</span> DIK_NUMPAD5: priChar = <span class="stringliteral">"CENTER"</span>; numLockChar = <span class="stringliteral">"5"</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01445     <span class="keywordflow">case</span> DIK_NUMPAD6: priChar = <span class="stringliteral">"RIGHT"</span>; numLockChar = <span class="stringliteral">"6"</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01446     <span class="keywordflow">case</span> DIK_NUMPAD1: priChar = <span class="stringliteral">"END"</span>; numLockChar = <span class="stringliteral">"1"</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01447     <span class="keywordflow">case</span> DIK_NUMPAD2: priChar = <span class="stringliteral">"DOWN"</span>; numLockChar = <span class="stringliteral">"2"</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01448     <span class="keywordflow">case</span> DIK_NUMPAD3: priChar = <span class="stringliteral">"PAGE DOWN"</span>; numLockChar = <span class="stringliteral">"3"</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01449     <span class="keywordflow">case</span> DIK_NUMPAD0: priChar = <span class="stringliteral">"INSERT"</span>; numLockChar = <span class="stringliteral">"0"</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01450     <span class="keywordflow">case</span> DIK_DECIMAL: priChar = <span class="stringliteral">"DELETE"</span>; numLockChar = <span class="stringliteral">"."</span>; onNumPad = 1; <span class="keywordflow">break</span>;
01451 
01452         <span class="comment">// keys above arrow keys</span>
01453     <span class="keywordflow">case</span> DIK_HOME: priChar = numLockChar = <span class="stringliteral">"HOME"</span>; <span class="keywordflow">break</span>;
01454     <span class="keywordflow">case</span> DIK_UP: priChar = numLockChar = <span class="stringliteral">"UP"</span>; <span class="keywordflow">break</span>;
01455     <span class="keywordflow">case</span> DIK_PRIOR: priChar = numLockChar = <span class="stringliteral">"PAGE UP"</span>; <span class="keywordflow">break</span>;
01456     <span class="keywordflow">case</span> DIK_LEFT: priChar = numLockChar = <span class="stringliteral">"LEFT"</span>; <span class="keywordflow">break</span>;
01457     <span class="keywordflow">case</span> DIK_RIGHT: priChar = numLockChar = <span class="stringliteral">"RIGHT"</span>; <span class="keywordflow">break</span>;
01458     <span class="keywordflow">case</span> DIK_END: priChar = numLockChar = <span class="stringliteral">"END"</span>; <span class="keywordflow">break</span>;
01459     <span class="keywordflow">case</span> DIK_DOWN: priChar = numLockChar = <span class="stringliteral">"DOWN"</span>; <span class="keywordflow">break</span>;
01460     <span class="keywordflow">case</span> DIK_NEXT: priChar = numLockChar = <span class="stringliteral">"PAGE DOWN"</span>; <span class="keywordflow">break</span>;
01461     <span class="keywordflow">case</span> DIK_INSERT: priChar = numLockChar = <span class="stringliteral">"INSERT"</span>; <span class="keywordflow">break</span>;
01462     <span class="keywordflow">case</span> DIK_DELETE: priChar = numLockChar = <span class="stringliteral">"DELETE"</span>; <span class="keywordflow">break</span>;
01463 
01464         <span class="comment">// 104-key only</span>
01465     <span class="keywordflow">case</span> DIK_LWIN: priChar = numLockChar = <span class="stringliteral">"LEFT WINDOW"</span>; <span class="keywordflow">break</span>;
01466     <span class="keywordflow">case</span> DIK_RWIN: priChar = numLockChar = <span class="stringliteral">"RIGHT WINDOW"</span>; <span class="keywordflow">break</span>;
01467     <span class="keywordflow">case</span> DIK_APPS: priChar = numLockChar = <span class="stringliteral">"APP MENU"</span>; <span class="keywordflow">break</span>;
01468     }
01469 
01470     <span class="comment">// check flags</span>
01471     <span class="keywordtype">int</span> retFlag = 1;
01472 
01473     <span class="comment">// check shift key state</span>
01474     <span class="keywordflow">if</span>( !(flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a6">K_IGNORE_SHIFT</a>) ) {
01475         <span class="keywordflow">if</span>( flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a1">K_IS_SHIFT</a> ) {
01476             <span class="keywordflow">if</span>( !(skeyState &amp; <a class="code" href="Omouse_8h.html#a5">SHIFT_KEY_MASK</a>) )
01477                 retFlag = 0;
01478         }
01479         <span class="keywordflow">else</span> {
01480             <span class="keywordflow">if</span>( skeyState &amp; <a class="code" href="Omouse_8h.html#a5">SHIFT_KEY_MASK</a> )
01481                 retFlag = 0;
01482         }
01483     }
01484 
01485     <span class="comment">// check contrl key state</span>
01486     <span class="keywordflow">if</span>( !(flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a7">K_IGNORE_CTRL</a>) ) {
01487         <span class="keywordflow">if</span>( flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a2">K_IS_CTRL</a> ) {
01488             <span class="keywordflow">if</span>( !(skeyState &amp; <a class="code" href="Omouse_8h.html#a8">CONTROL_KEY_MASK</a>) )
01489                 retFlag = 0;
01490         }
01491         <span class="keywordflow">else</span> {
01492             <span class="keywordflow">if</span>( skeyState &amp; <a class="code" href="Omouse_8h.html#a8">CONTROL_KEY_MASK</a> )
01493                 retFlag = 0;
01494         }
01495     }
01496 
01497     <span class="comment">// check alt key state</span>
01498     <span class="keywordflow">if</span>( !(flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a8">K_IGNORE_ALT</a>) ) {
01499         <span class="keywordflow">if</span>( flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a3">K_IS_ALT</a> ) {
01500             <span class="keywordflow">if</span>( !(skeyState &amp; <a class="code" href="Omouse_8h.html#a11">ALT_KEY_MASK</a>) )
01501                 retFlag = 0;
01502         }
01503         <span class="keywordflow">else</span> {
01504             <span class="keywordflow">if</span>( skeyState &amp; <a class="code" href="Omouse_8h.html#a11">ALT_KEY_MASK</a> )
01505                 retFlag = 0;
01506         }
01507     }
01508 
01509     <span class="comment">// check numpad state</span>
01510     <span class="keywordflow">if</span>( !(flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a11">K_IGNORE_NUMPAD</a>) ) {
01511         <span class="keywordflow">if</span>( flags &amp; <a class="code" href="OMOUSE2_8H.html#a15a4">K_ON_NUMPAD</a> ) {
01512             <span class="keywordflow">if</span>( !onNumPad )
01513                 retFlag = 0;
01514         }
01515         <span class="keywordflow">else</span> {
01516             <span class="keywordflow">if</span>( onNumPad )
01517                 retFlag = 0;
01518         }
01519     }
01520 
01521     <span class="keywordtype">char</span> *outChar = skeyState &amp; <a class="code" href="Omouse_8h.html#a12">NUM_LOCK_STATE_MASK</a> ? numLockChar : priChar;
01522     <span class="keywordtype">int</span> retFlag2 = outChar ? !strcmp(outChar, keyStr) : 0;
01523 
01524     <span class="keywordflow">return</span> retFlag &amp;&amp; retFlag2;
01525 }
01526 
01527 <span class="comment">// ------ End of Mouse::is_key -------//</span>
01528 <span class="preprocessor">#endif</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:07 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
