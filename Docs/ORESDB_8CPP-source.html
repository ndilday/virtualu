<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ORESDB.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>ORESDB.CPP</h1><a href="ORESDB_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : ORESDB.CPP</span>
00002 <span class="comment">//Description : Resource library with database index reading object</span>
00003 
00004 <span class="preprocessor">#include &lt;string.h&gt;</span>
00005 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00006 <span class="preprocessor">#include &lt;<a class="code" href="ODB_8H.html">ODB.H</a>&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="ORESDB_8H.html">ORESDB.H</a>&gt;</span>
00008 
00009 <span class="comment">//-------------------------------------------------------//</span>
00010 <span class="comment">//</span>
00011 <span class="comment">// Resource library reading object</span>
00012 <span class="comment">//</span>
00013 <span class="comment">// Files required :</span>
00014 <span class="comment">//</span>
00015 <span class="comment">// - A resource file build by LIBDB.EXE, it is always in .RES extension</span>
00016 <span class="comment">// - A database file with Index Pointer field, the values of the field</span>
00017 <span class="comment">//   are automatically calculated by LIBDB.EXE</span>
00018 <span class="comment">//</span>
00019 <span class="comment">//-------------------------------------------------------//</span>
00020 
00021 <span class="comment">//---------- Begin of function ResourceDb::init ---------//</span>
<a name="l00029"></a><a class="code" href="classResourceDb.html#a3">00029</a> <span class="comment">void ResourceDb::init(char* resName, Database* dbObj, int indexOffset, int useCommonBuf) {</span>
00030     deinit();
00031 
00032     file_open( resName );
00033 
00034     db_obj             = dbObj;
00035     index_field_offset = indexOffset;
00036     use_common_buf     = useCommonBuf;
00037 
00038     <span class="keywordflow">if</span>( use_common_buf )
00039         data_buf = sys.common_data_buf;
00040     <span class="keywordflow">else</span>
00041         data_buf = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00042 
00043     <a class="code" href="ALL_8H.html#a2">err_if</a>( db_obj == <a class="code" href="OHELP_8H.html#a0">NULL</a> )
00044         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"db_obj is NULL"</span>);
00045 
00046     init_flag = 1;
00047 }
00048 
00049 <span class="comment">//----------- End of function ResourceDb::init ------------//</span>
00050 
00051 <span class="comment">//---------- Begin of function ResourceDb::deinit ---------//</span>
<a name="l00053"></a><a class="code" href="classResourceDb.html#a4">00053</a> <span class="comment">void ResourceDb::deinit() {</span>
00054     <span class="keywordflow">if</span>( init_flag ) {
00055         <span class="keywordflow">if</span>( !use_common_buf &amp;&amp; data_buf ) {
00056             <a class="code" href="ALL_8H.html#a8">mem_del</a>(data_buf);
00057             data_buf = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00058         }
00059 
00060         <span class="keywordflow">if</span>( !read_all )
00061             file_close();
00062 
00063         init_flag=0;
00064     }
00065 }
00066 
00067 <span class="comment">//----------- End of function ResourceDb::deinit ----------//</span>
00068 
00069 <span class="comment">//---------- Begin of function ResourceDb::read ----------//</span>
<a name="l00084"></a><a class="code" href="classResourceDb.html#a5">00084</a> <span class="comment">char* ResourceDb::read(int recNo) {</span>
00085     <a class="code" href="ALL_8H.html#a0">err_when</a>( !init_flag || !db_obj );
00086 
00087     <span class="keywordtype">long</span>* indexFieldPtr;
00088     <span class="keywordtype">char</span>* recPtr;
00089 
00090     <span class="keywordflow">if</span>( (recPtr = db_obj-&gt;read(recNo)) == <a class="code" href="OHELP_8H.html#a0">NULL</a> )
00091         <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00092 
00093     indexFieldPtr = (<span class="keywordtype">long</span>*) (recPtr+index_field_offset);
00094 
00095     <span class="keywordflow">if</span>( memcmp( indexFieldPtr, <span class="stringliteral">"    "</span>, 4 ) == 0 )
00096         <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;                                  <span class="comment">// no sample screen for this file</span>
00097 
00098     file_seek( *indexFieldPtr );
00099     data_buf_size = file_get_long();
00100 
00101     <a class="code" href="ALL_8H.html#a0">err_when</a>( use_common_buf &amp;&amp; data_buf_size &gt; <a class="code" href="Osys_8h.html#a40a2">COMMON_DATA_BUF_SIZE</a> );
00102 
00103     <span class="keywordflow">if</span>( !use_common_buf )
00104         data_buf = <a class="code" href="ALL_8H.html#a7">mem_resize</a>( data_buf, data_buf_size );
00105 
00106     file_read( data_buf, data_buf_size );
00107 
00108     <span class="keywordflow">return</span> data_buf;
00109 }
00110 
00111 <span class="comment">//----------- End of function ResourceDb::read -------------//</span>
00112 
00113 <span class="comment">//---------- Begin of function ResourceDb::get_file ----------//</span>
<a name="l00123"></a><a class="code" href="classResourceDb.html#a6">00123</a> <span class="comment">File* ResourceDb::get_file() {</span>
00124     <a class="code" href="ALL_8H.html#a0">err_when</a>( !init_flag || !db_obj );
00125 
00126     <span class="keywordtype">long</span>* indexFieldPtr;
00127     <span class="keywordtype">char</span>  emptyField[] = <span class="stringliteral">"        "</span>;
00128     <span class="keywordtype">char</span>* recPtr;
00129 
00130     <span class="keywordflow">if</span>( (recPtr = db_obj-&gt;read()) == <a class="code" href="OHELP_8H.html#a0">NULL</a> )
00131         <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00132 
00133     indexFieldPtr = (<span class="keywordtype">long</span>*) (recPtr+index_field_offset);
00134 
00135     <span class="keywordflow">if</span>( memcmp( indexFieldPtr, emptyField, 8 ) == 0 )
00136         <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;                                  <span class="comment">// no sample screen for this file</span>
00137 
00138     file_seek( *indexFieldPtr + <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>) );
00139 
00140     <span class="keywordflow">return</span> <span class="keyword">this</span>;
00141 }
00142 
00143 <span class="comment">//----------- End of function ResourceDb::get_file -------------//</span>
00144 
00145 <span class="comment">//---------- Begin of function ResourceDb::init_imported ----------//</span>
<a name="l00155"></a><a class="code" href="classResourceDb.html#a7">00155</a> <span class="comment">void ResourceDb::init_imported(char* resName, int readAll, int useCommonBuf) {</span>
00156     deinit();
00157 
00158     db_obj             = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00159     index_field_offset = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00160 
00161     read_all = readAll;
00162 
00163     file_open( resName );
00164 
00165     <span class="keywordflow">if</span>( read_all ) {
00166         data_buf_size = file_size();
00167 
00168         data_buf = <a class="code" href="ALL_8H.html#a5">mem_add</a>( data_buf_size );
00169         file_read( data_buf, data_buf_size );
00170         file_close();
00171 
00172         use_common_buf = 0;                           <span class="comment">// don't use vga buffer if read all</span>
00173     }
00174     <span class="keywordflow">else</span> {
00175         use_common_buf = useCommonBuf;
00176 
00177         <span class="keywordflow">if</span>( use_common_buf )
00178             data_buf = sys.common_data_buf;
00179         <span class="keywordflow">else</span>
00180             data_buf = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00181     }
00182 
00183     init_flag = 1;
00184 }
00185 
00186 <span class="comment">//----------- End of function ResourceDb::init_imported -------------//</span>
00187 
00188 <span class="comment">//---------- Begin of function ResourceDb::read_imported ----------//</span>
<a name="l00198"></a><a class="code" href="classResourceDb.html#a8">00198</a> <span class="comment">char* ResourceDb::read_imported(long offset) {</span>
00199     <a class="code" href="ALL_8H.html#a0">err_when</a>( !init_flag );
00200 
00201     <span class="comment">// #### begin Gilbert 4/10 ######//</span>
00202     <span class="comment">//  err_if( offset&lt;0 || offset&gt;=data_buf_size )</span>
00203     <span class="comment">//          err_here();</span>
00204     <span class="comment">// #### end Gilbert 4/10 ######//</span>
00205 
00206     <span class="comment">//-------- read from buffer ---------//</span>
00207 
00208     <span class="comment">// ##### begin Gilbert 4/10 #######//</span>
00209     <span class="keywordflow">if</span>( read_all ) {
00210         <a class="code" href="ALL_8H.html#a0">err_when</a>( offset&lt;0 || offset&gt;=data_buf_size );
00211         <span class="keywordflow">return</span> data_buf + offset + <span class="keyword">sizeof</span>(long);      <span class="comment">// by pass the long parameters which is the size of the data</span>
00212     }
00213     <span class="comment">// ##### end Gilbert 4/10 #######//</span>
00214 
00215     <span class="comment">//---------- read from file ---------//</span>
00216 
00217     <span class="comment">// ##### begin Gilbert 2/10 ######//</span>
00218     <a class="code" href="ALL_8H.html#a0">err_when</a>( offset &gt;= file_size() );
00219     <span class="comment">// ##### end Gilbert 2/10 ######//</span>
00220     file_seek( offset );
00221 
00222     data_buf_size = file_get_long();
00223 
00224     <a class="code" href="ALL_8H.html#a0">err_when</a>( use_common_buf &amp;&amp; data_buf_size &gt; <a class="code" href="Osys_8h.html#a40a2">COMMON_DATA_BUF_SIZE</a>);
00225 
00226     <span class="keywordflow">if</span>( !use_common_buf )
00227         data_buf = <a class="code" href="ALL_8H.html#a7">mem_resize</a>( data_buf, data_buf_size );
00228 
00229     file_read( data_buf, data_buf_size );
00230 
00231     <span class="keywordflow">return</span> data_buf;
00232 }
00233 
00234 <span class="comment">//----------- End of function ResourceDb::read_imported -------------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:17 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
