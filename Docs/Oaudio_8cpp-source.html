<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Oaudio.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Oaudio.cpp</h1><a href="Oaudio_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OAUDIO.CPP</span>
00002 <span class="comment">//Description : Object Midi Audio and Digitized Sound</span>
00003 <span class="comment">//Ownership   : Gilbert</span>
00004 
00005 <span class="preprocessor">#include &lt;OAUDIO.H&gt;</span>
00006 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00007 <span class="preprocessor">#include &lt;windowsx.h&gt;</span>
00008 <span class="preprocessor">#include &lt;commdlg.h&gt;</span>
00009 <span class="preprocessor">#include &lt;string.h&gt;</span>
00010 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00011 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00012 <span class="preprocessor">#include &lt;direct.h&gt;</span>
00013 <span class="preprocessor">#include &lt;mmsystem.h&gt;</span>
00014 <span class="preprocessor">#include &lt;string.h&gt;</span>
00015 <span class="preprocessor">#include &lt;limits.h&gt;</span>
00016 
00017 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00018 <span class="preprocessor">#include &lt;<a class="code" href="OBOX_8H.html">OBOX.H</a>&gt;</span>
00019 <span class="preprocessor">#include &lt;<a class="code" href="OVGALOCK_8H.html">OVGALOCK.H</a>&gt;</span>
00020 <span class="preprocessor">#ifndef DSBCAPS_CTRLDEFAULT</span>
<a name="l00021"></a><a class="code" href="Oaudio_8cpp.html#a0">00021</a> <span class="preprocessor"></span><span class="preprocessor">#define DSBCAPS_CTRLDEFAULT DSBCAPS_CTRLFREQUENCY|DSBCAPS_CTRLPAN|DSBCAPS_CTRLVOLUME</span>
00022 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00023 <span class="preprocessor"></span><span class="comment">//#define DEBUG_LOG_LOCAL 1</span>
00024 <span class="comment">//#include &lt;OLOG.H&gt;</span>
00025 
00026 <span class="comment">//---------------- Define constant ------------------//</span>
00027 <span class="comment">//</span>
00028 <span class="comment">// DirectSoundBuffer size = LWAV_STREAM_BUFSIZ * LWAV_BANKS</span>
00029 <span class="comment">// if it is going to play a high transfer rate wave</span>
00030 <span class="comment">// (e.g. 16-bit 44.1kHz Stereo), increase LWAV_STREAM_BUFSIZ</span>
00031 <span class="comment">//</span>
00032 <span class="comment">//---------------------------------------------------//</span>
00033 
<a name="l00034"></a><a class="code" href="Oaudio_8cpp.html#a1">00034</a> <span class="preprocessor">#define LWAV_STREAM_BUFSIZ  0x1000</span>
<a name="l00035"></a><a class="code" href="Oaudio_8cpp.html#a2">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define LWAV_BANKS      4</span>
<a name="l00036"></a><a class="code" href="Oaudio_8cpp.html#a3">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define LOOPWAV_STREAM_BUFSIZ 0x1000</span>
<a name="l00037"></a><a class="code" href="Oaudio_8cpp.html#a4">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define LOOPWAV_BANKS   4</span>
00038 <span class="preprocessor"></span>
00039 <span class="comment">//---------- Define static variables ---------//</span>
00040 
00041 <span class="keyword">static</span> MCI_PLAY_PARMS mci_play;
00042 <span class="keyword">static</span> MCI_OPEN_PARMS mci_open;
00043 <span class="keyword">static</span> MCI_SET_PARMS  mci_set;
00044 
00045 <span class="comment">//--------- Begin of function wavefile_offset -------//</span>
00049 <span class="comment">static char * wavefile_data(char *wavfile_buf) {</span>
00050     <span class="comment">//----- position at WAVEfmt tag size ------//</span>
00051 
00052     <span class="keywordtype">char</span> *p = wavfile_buf+0x10;
00053     DWORD tagSize=*(DWORD *)p;
00054 
00055     <span class="comment">//-------- go to next tag field -----------//</span>
00056 
00057     <span class="keywordflow">for</span>( p += <span class="keyword">sizeof</span>(DWORD)+tagSize; strncmp(p, <span class="stringliteral">"data"</span>, 4) != 0;
00058          p += <span class="keyword">sizeof</span>(DWORD)+tagSize) {
00059         p += 4;                                       <span class="comment">// pointing at size of tag field</span>
00060         tagSize = *(DWORD *)p;                        <span class="comment">// get the size of this tage field</span>
00061 
00062         <span class="keywordflow">if</span>(p - wavfile_buf &gt; 128)
00063             <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00064     }
00065 
00066     <span class="comment">//----- p pointing at the start of "data" tag ------//</span>
00067 
00068     <span class="keywordflow">return</span> p;
00069 }
00070 
00071 <span class="comment">//--------- End of function wavefile_offset------------//</span>
00072 
00073 <span class="comment">//--------- Begin of function Audio::Audio ----------//</span>
00074 
<a name="l00075"></a><a class="code" href="classAudio.html#a0">00075</a> <a class="code" href="classAudio.html#a0">Audio::Audio</a>() {
00076     <a class="code" href="classAudio.html#m0">init_flag</a> = 0;
00077 }
00078 
00079 <span class="comment">//--------- Begin of function Audio::Audio ----------//</span>
00080 
00081 <span class="comment">//--------- Begin of function Audio::~Audio ----------//</span>
00082 
<a name="l00083"></a><a class="code" href="classAudio.html#a1">00083</a> <a class="code" href="classAudio.html#a1">Audio::~Audio</a>() {
00084     <a class="code" href="classAudio.html#a3">deinit</a>();
00085 }
00086 
00087 <span class="comment">//--------- Begin of function Audio::~Audio ----------//</span>
00088 
00089 <span class="comment">//--------- Begin of function Audio::init ----------//</span>
<a name="l00096"></a><a class="code" href="classAudio.html#a2">00096</a> <span class="comment">int Audio::init() {</span>
00097     <span class="comment">//-------- init vars -----------//</span>
00098 
00099     run_yield = 0;
00100     mid_init_flag = 0;                              <span class="comment">// the init flag is on when the driver is initialized successfully</span>
00101     wav_init_flag = 0;
00102     cd_init_flag  = 0;
00103 
00104     mid_flag = 1;
00105     wav_flag = 1;
00106     cd_flag  = 1;
00107 
00108     mid_buf = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00109     wav_buf = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00110 
00111     mid_buf_size = 0;
00112     wav_buf_size = 0;
00113 
00114     last_played_lwave_ch = 0;
00115 
00116     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="Oaudio_8h.html#a4">MAX_WAV_CHANNEL</a>; ++i) {
00117         lp_wav_ch_dsb[i] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00118         wav_serial_no[i] = 0;
00119     }
00120     max_lwav_serial_no = 0;
00121 
00122     <span class="keywordflow">for</span>(i=0; i &lt; <a class="code" href="Oaudio_8h.html#a5">MAX_LONG_WAV_CH</a>; ++i) {
00123         lp_lwav_ch_dsb[i] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00124         lwav_serial_no[i] = 0;
00125         lwav_fileptr[i] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00126     }
00127     max_lwav_serial_no = 0;
00128 
00129     <span class="keywordflow">for</span>(i=0; i &lt; <a class="code" href="Oaudio_8h.html#a6">MAX_LOOP_WAV_CH</a>; ++i) {
00130         lp_loop_ch_dsb[i] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00131         loopwav_fileptr[i] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00132     }
00133 
00134     <span class="comment">// wav_volume = 0;</span>
00135     wav_volume = 100;                               <span class="comment">// 0(slient) - 100(loudest)</span>
00136 
00137     <span class="comment">//--------- init devices ----------//</span>
00138 
00139     <span class="keywordflow">if</span>( init_wav() ) {
00140         wav_res.init( <a class="code" href="Gamedef_8h.html#a4">DIR_RES</a><span class="stringliteral">"A_WAVE2.RES"</span>, 0, 0 );   <span class="comment">// 2nd 0-don't read all, 3rd 0-don't use vga buffer</span>
00141         wav_buf      = <a class="code" href="ALL_8H.html#a5">mem_add</a>(<a class="code" href="Oaudio_8h.html#a2">DEFAULT_WAV_BUF_SIZE</a>);
00142         wav_buf_size = <a class="code" href="Oaudio_8h.html#a2">DEFAULT_WAV_BUF_SIZE</a>;
00143     }
00144     <span class="comment">/*</span>
00145 <span class="comment">      if( init_mid() )</span>
00146 <span class="comment">      {</span>
00147 <span class="comment">      mid_res.init( DIR_RES"A_MIDI.RES", 0, 0 );      // 2nd 0-don't read all, 3rd 0-don't use vga buffer</span>
00148 <span class="comment">      mid_buf            = mem_add(DEFAULT_MID_BUF_SIZE);</span>
00149 <span class="comment">      mid_buf_size = DEFAULT_MID_BUF_SIZE;</span>
00150 <span class="comment">      }</span>
00151 <span class="comment">    */</span>
00152     init_cd();
00153 
00154     <span class="comment">//----------------------------------//</span>
00155 
00156     init_flag = wav_init_flag || cd_init_flag;
00157 
00158     <span class="keywordflow">return</span> 1;
00159 }
00160 
00161 <span class="comment">//--------- End of function Audio::init ----------//</span>
00162 
00163 <span class="comment">//--------- Begin of function Audio::deinit ----------//</span>
00164 
<a name="l00165"></a><a class="code" href="classAudio.html#a3">00165</a> <span class="keywordtype">void</span> <a class="code" href="classAudio.html#a3">Audio::deinit</a>() {
00166     <span class="keywordflow">if</span>( init_flag ) {
00167         <span class="comment">//------- deinit vars --------//</span>
00168 
00169         run_yield = 0;
00170         <a class="code" href="classAudio.html#m0">init_flag</a> = 0;
00171 
00172         <span class="comment">//------- deinit devices -------//</span>
00173 
00174         deinit_wav();
00175         deinit_mid();
00176         deinit_cd();
00177     }
00178 }
00179 
00180 <span class="comment">//--------- End of function Audio::deinit ----------//</span>
00181 
00182 <span class="comment">//--------- Begin of function Audio::init_wav ----------//</span>
00189 <span class="comment">int Audio::init_wav() {</span>
00190     <span class="keywordflow">if</span>( wav_init_flag )
00191         <span class="keywordflow">return</span> 1;
00192 
00193     <span class="comment">//-------- create DirectSound object -------//</span>
00194 
00195     HRESULT rc=DirectSoundCreate(<a class="code" href="OHELP_8H.html#a0">NULL</a>, &amp;lp_direct_sound, <a class="code" href="OHELP_8H.html#a0">NULL</a>);
00196 
00197     <span class="comment">//------------------------------------------//</span>
00198 
00199     <span class="keywordflow">if</span>( rc==DS_OK ) {                               <span class="comment">// Create succeeded</span>
00200         lp_direct_sound-&gt;SetCooperativeLevel(sys.main_hwnd, DSSCL_NORMAL);
00201         wav_init_flag=1;
00202         <span class="comment">//DEBUG_LOG("Audio:: set wav_init_flag");</span>
00203     }
00204 
00205     <span class="keywordflow">return</span> wav_init_flag;
00206 }
00207 
00208 <span class="comment">//--------- End of function Audio::init_wav ----------//</span>
00209 
00210 <span class="comment">//--------- Begin of function Audio::init_mid ----------//</span>
00217 <span class="comment">int Audio::init_mid() {</span>
00218     <span class="keywordflow">if</span>( mid_init_flag )
00219         <span class="keywordflow">return</span> 1;
00220 
00221     <span class="comment">//.. insert code here ...//</span>
00222 
00223     mid_init_flag=1;
00224 
00225     <span class="keywordflow">return</span> 1;
00226 }
00227 
00228 <span class="comment">//--------- End of function Audio::init_mid ----------//</span>
00229 
00230 <span class="comment">//--------- Begin of function Audio::init_cd ----------//</span>
00237 <span class="comment">int Audio::init_cd() {</span>
00238     mci_open.lpstrDeviceType = (LPCSTR) MCI_DEVTYPE_CD_AUDIO;
00239 
00240     <span class="keywordflow">if</span>( mciSendCommand( <a class="code" href="OHELP_8H.html#a0">NULL</a>, MCI_OPEN, MCI_OPEN_TYPE | MCI_OPEN_TYPE_ID,
00241                         (DWORD) (LPVOID) &amp;mci_open) == 0 ||
00242         mciSendCommand( <a class="code" href="OHELP_8H.html#a0">NULL</a>, MCI_OPEN, MCI_OPEN_TYPE |
00243                         MCI_OPEN_TYPE_ID | MCI_OPEN_SHAREABLE,
00244                         (DWORD) (LPVOID) &amp;mci_open)== 0 ) {
00245         mci_set.dwTimeFormat = MCI_FORMAT_TMSF;
00246 
00247         mciSendCommand( mci_open.wDeviceID, MCI_SET, MCI_SET_TIME_FORMAT,
00248                         (DWORD) (LPVOID) &amp;mci_set);
00249 
00250         cd_init_flag = 1;
00251         <span class="comment">//DEBUG_LOG("Audio:: set cd_init_flag");</span>
00252         <span class="keywordflow">return</span> 1;
00253     }
00254 
00255     cd_init_flag = 0;
00256     <span class="keywordflow">return</span> 0;
00257 }
00258 
00259 <span class="comment">//--------- End of function Audio::init_cd ----------//</span>
00260 
00261 <span class="comment">//--------- Begin of function Audio::deinit_cd ----------//</span>
00262 
00263 <span class="keywordtype">void</span> Audio::deinit_cd() {
00264     <span class="keywordflow">if</span>( cd_init_flag ) {
00265         <a class="code" href="classAudio.html#a26">stop_cd</a>();
00266 
00267         mciSendString (<span class="stringliteral">"close cdaudio"</span>, <a class="code" href="OHELP_8H.html#a0">NULL</a>, 0, <a class="code" href="OHELP_8H.html#a0">NULL</a>);
00268 
00269         <a class="code" href="classAudio.html#m3">cd_init_flag</a> = 0;
00270     }
00271 }
00272 
00273 <span class="comment">//--------- End of function Audio::deinit_cd ----------//</span>
00274 
00275 <span class="comment">//--------- Begin of function Audio::deinit_wav ----------//</span>
00276 
00277 <span class="keywordtype">void</span> Audio::deinit_wav() {
00278     <a class="code" href="classAudio.html#a25">stop_wav</a>();
00279 
00280     <span class="keywordflow">if</span>( wav_buf ) {
00281         <a class="code" href="ALL_8H.html#a8">mem_del</a>(<a class="code" href="classAudio.html#m8">wav_buf</a>);
00282         <a class="code" href="classAudio.html#m8">wav_buf</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00283     }
00284 
00285     <span class="keywordflow">if</span>(wav_init_flag) {
00286         lp_direct_sound-&gt;Release();
00287         <a class="code" href="classAudio.html#m2">wav_init_flag</a> = 0;
00288     }
00289 }
00290 
00291 <span class="comment">//--------- End of function Audio::deinit_wav ----------//</span>
00292 
00293 <span class="comment">//--------- Begin of function Audio::deinit_mid ----------//</span>
00294 
00295 <span class="keywordtype">void</span> Audio::deinit_mid() {
00296     <span class="keywordflow">if</span>( !<a class="code" href="classAudio.html#m1">mid_init_flag</a> )
00297         <span class="keywordflow">return</span>;
00298 
00299     <a class="code" href="classAudio.html#a24">stop_mid</a>();
00300 
00301     <span class="comment">//.. insert code here ...//</span>
00302     <a class="code" href="ALL_8H.html#a8">mem_del</a>(<a class="code" href="classAudio.html#m7">mid_buf</a>);
00303     <a class="code" href="classAudio.html#m7">mid_buf</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00304 
00305     <a class="code" href="classAudio.html#m1">mid_init_flag</a> = 0;
00306 }
00307 
00308 <span class="comment">//--------- End of function Audio::deinit_mid ----------//</span>
00309 
00310 <span class="comment">//------- Begin of function Audio::play_mid -------//</span>
<a name="l00319"></a><a class="code" href="classAudio.html#a5">00319</a> <span class="comment">int Audio::play_mid(char* midName) {</span>
00320     <span class="keywordflow">if</span>( !mid_init_flag || !mid_flag )               <span class="comment">// a initialized and workable midi device can be disabled by user setting</span>
00321         <span class="keywordflow">return</span> 0;
00322 
00323     stop_mid();                                     <span class="comment">// stop currently playing mid if any</span>
00324 
00325     <span class="comment">//------ Load mid file -------//</span>
00326 
00327     <span class="keywordtype">int</span>   dataSize;
00328 
00329     <a class="code" href="classFile.html">File</a>* filePtr = mid_res.get_file(midName, dataSize);
00330 
00331     <span class="keywordflow">if</span>( !filePtr )
00332         <span class="keywordflow">return</span> 0;
00333 
00334     <span class="keywordflow">if</span>( dataSize &gt; mid_buf_size ) {
00335         mid_buf_size = dataSize;
00336         mid_buf = <a class="code" href="ALL_8H.html#a7">mem_resize</a>( mid_buf, mid_buf_size );
00337     }
00338 
00339     <span class="keywordflow">if</span>( !filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>( mid_buf, dataSize ) )
00340         <span class="keywordflow">return</span> 0;
00341 
00342     <span class="comment">//-------- Play mid file --------//</span>
00343 
00344     <span class="comment">//.. insert code here ...//</span>
00345 
00346     <span class="keywordflow">return</span> 1;
00347 }
00348 
00349 <span class="comment">//------- End of function Audio::play_mid -------//</span>
00350 
00351 <span class="comment">//------- Begin of function Audio::stop_mid -------//</span>
<a name="l00353"></a><a class="code" href="classAudio.html#a24">00353</a> <span class="comment">void Audio::stop_mid() {</span>
00354     <span class="keywordflow">if</span>( !mid_init_flag || !mid_flag )
00355         <span class="keywordflow">return</span>;
00356 
00357     <span class="comment">//.. insert code here ...//</span>
00358 
00359     mciSendCommand(mci_open.wDeviceID, MCI_STOP, <a class="code" href="OHELP_8H.html#a0">NULL</a>, <a class="code" href="OHELP_8H.html#a0">NULL</a>);
00360 }
00361 
00362 <span class="comment">//------- End of function Audio::stop_mid -------//</span>
00363 
00364 <span class="comment">//------- Begin of function Audio::play_wav -------//</span>
<a name="l00375"></a><a class="code" href="classAudio.html#a6">00375</a> <span class="comment">int Audio::play_wav(char* wavName, DsVolume dsVolume) {</span>
00376     <span class="comment">/*</span>
00377 <span class="comment">      //---- redirect to play_long_wav -------//</span>
00378 <span class="comment"></span>
00379 <span class="comment">      String str;</span>
00380 <span class="comment"></span>
00381 <span class="comment">      str  = DIR_SOUND;</span>
00382 <span class="comment">      str += wavName;</span>
00383 <span class="comment">      str += ".WAV";</span>
00384 <span class="comment"></span>
00385 <span class="comment">      if( m.is_file_exist(str) )</span>
00386 <span class="comment">      return play_long_wav(str);</span>
00387 <span class="comment">      else</span>
00388 <span class="comment">      return 0;</span>
00389 <span class="comment"></span>
00390 <span class="comment">      //------------------------------------//</span>
00391 <span class="comment">    */</span>
00392     <span class="keywordflow">if</span>( !wav_init_flag || !wav_flag )               <span class="comment">// a initialized and workable midi device can be disabled by user setting</span>
00393         <span class="keywordflow">return</span> 0;
00394 
00395     <span class="comment">//-------- Load wav file header-------//</span>
00396     <span class="keywordtype">int</span>   dataSize;
00397     DWORD wavDataOffset, wavDataLength;
00398 
00399     <a class="code" href="classFile.html">File</a>* filePtr = wav_res.get_file(wavName, dataSize);
00400 
00401     <span class="keywordflow">if</span>( !filePtr )
00402         <span class="keywordflow">return</span> 0;
00403 
00404     <span class="comment">// load small part of the wave file (first 128 bytes) enough to hold</span>
00405     <span class="comment">// the hold header</span>
00406     <span class="comment">//#define LOAD_FULL_WAVE</span>
00407 <span class="preprocessor">#ifdef LOAD_FULL_WAVE</span>
00408 <span class="preprocessor"></span>    <span class="keywordflow">if</span>( dataSize &gt; wav_buf_size ) {
00409         wav_buf_size = dataSize;
00410         wav_buf = <a class="code" href="ALL_8H.html#a7">mem_resize</a>( wav_buf, wav_buf_size );
00411     }
00412     <span class="keywordflow">if</span>( !filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>( wav_buf, dataSize))
00413 <span class="preprocessor">#else</span>
00414 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( !filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>( wav_buf, 128 ) )
00415 <span class="preprocessor">#endif</span>
00416 <span class="preprocessor"></span>            <span class="keywordflow">return</span> 0;
00417 
00418     <span class="comment">// short-cut to test play_resided_wave()</span>
00419 <span class="preprocessor">#ifdef LOAD_FULL_WAVE</span>
00420 <span class="preprocessor"></span>    <span class="keywordflow">return</span> play_resided_wav(wav_buf);
00421 <span class="preprocessor">#endif</span>
00422 <span class="preprocessor"></span>
00423     <span class="comment">// determine the wave data offset and length</span>
00424     <span class="keywordtype">char</span> * dataTag = wavefile_data(wav_buf);
00425     <span class="keywordflow">if</span> (!dataTag) {
00426         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Invalid wave file format"</span>);
00427         <span class="keywordflow">return</span> 0;                                     <span class="comment">// invalid RIFF WAVE format</span>
00428     }
00429 
00430     wavDataOffset = (dataTag - wav_buf) + 4 + <span class="keyword">sizeof</span>(DWORD);
00431     wavDataLength = *(DWORD *)(dataTag+4);
00432 
00433 <span class="preprocessor">#ifndef LOAD_FULL_WAVE</span>
00434 <span class="preprocessor"></span>    <span class="comment">// seek to the start of wave data</span>
00435     filePtr-&gt;<a class="code" href="classFile.html#a7">file_seek</a>(wavDataOffset-128,FILE_CURRENT);
00436 <span class="preprocessor">#endif</span>
00437 <span class="preprocessor"></span>
00438     <span class="comment">//------- Create DirectSoundBuffer to store a wave ------//</span>
00439     LPDIRECTSOUNDBUFFER lpDsb;
00440     DSBUFFERDESC dsbDesc;
00441     HRESULT hr;
00442     DWORD dsbStatus;
00443 
00444     <span class="comment">// set up DSBUFFERDESC structure</span>
00445     memset(&amp;dsbDesc, 0, <span class="keyword">sizeof</span>(DSBUFFERDESC));      <span class="comment">// zero it out</span>
00446     dsbDesc.dwSize = <span class="keyword">sizeof</span>(DSBUFFERDESC);
00447     dsbDesc.dwFlags = <a class="code" href="Oaudio_8cpp.html#a0">DSBCAPS_CTRLDEFAULT</a>;          <span class="comment">// Need defaul controls (pan, volume, frequency)</span>
00448     dsbDesc.dwBufferBytes = wavDataLength;
00449     dsbDesc.lpwfxFormat = (LPWAVEFORMATEX) (wav_buf+0x14);
00450     <span class="comment">// ------- assign buffer to a channel number ----------//</span>
00451     lpDsb = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00452     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> chanNum = 0; chanNum &lt; <a class="code" href="Oaudio_8h.html#a4">MAX_WAV_CHANNEL</a>; ++chanNum)
00453         <span class="keywordflow">if</span>(lp_wav_ch_dsb[chanNum] == <a class="code" href="OHELP_8H.html#a0">NULL</a> || (lp_wav_ch_dsb[chanNum]-&gt;GetStatus(&amp;dsbStatus),
00454                                               !(dsbStatus &amp; DSBSTATUS_PLAYING))) {
00455             <span class="keywordflow">if</span>(lp_wav_ch_dsb[chanNum]) {
00456                 lp_wav_ch_dsb[chanNum]-&gt;Release();
00457                 lp_wav_ch_dsb[chanNum] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00458             }
00459             <span class="comment">// found an idle channel, create DirectSoundBuffer</span>
00460             hr = lp_direct_sound-&gt;CreateSoundBuffer(&amp;dsbDesc, &amp;lpDsb, <a class="code" href="OHELP_8H.html#a0">NULL</a>);
00461             <span class="keywordflow">if</span> (DS_OK != hr) {
00462                 <span class="comment">// failed!</span>
00463                 <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot create DirectSoundBuffer"</span>);
00464                 <span class="keywordflow">return</span> 0;
00465             }
00466             lp_wav_ch_dsb[chanNum] = lpDsb;
00467             <span class="keywordflow">break</span>;
00468         }
00469     <span class="keywordflow">if</span>( chanNum &gt;= <a class="code" href="Oaudio_8h.html#a4">MAX_WAV_CHANNEL</a>) {
00470         <span class="keywordflow">return</span> 0;
00471     }
00472     <span class="comment">// Note : if not found, just play the sound, don't play the sound</span>
00473     <span class="comment">// increase MAX_WAV_CHANNEL</span>
00474 
00475     <span class="comment">//------- copy sound data to DirectSoundBuffer--------//</span>
00476     <span class="comment">// unlock vga_front</span>
00477     <a class="code" href="classVgaFrontLock.html">VgaFrontLock</a> vgaLock;
00478 
00479     <span class="comment">// lock the buffer first</span>
00480     LPVOID lpvPtr1;
00481     DWORD dwBytes1;
00482     LPVOID lpvPtr2;
00483     DWORD dwBytes2;
00484 
00485     hr = lpDsb-&gt;Lock(0, wavDataLength, &amp;lpvPtr1, &amp;dwBytes1, &amp;lpvPtr2, &amp;dwBytes2, 0);
00486     <span class="keywordflow">if</span>(DS_OK != hr) {
00487         <span class="comment">// fail to lock</span>
00488         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot lock DirectSoundBuffer"</span>);
00489         <span class="keywordflow">return</span> 0;
00490     }
00491 
00492     <span class="comment">// write to pointers</span>
00493 <span class="preprocessor">#ifdef LOAD_FULL_WAVE</span>
00494 <span class="preprocessor"></span>    memcpy(lpvPtr1, wav_buf+wavDataOffset, dwBytes1);
00495 <span class="preprocessor">#else</span>
00496 <span class="preprocessor"></span>    filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>(lpvPtr1, dwBytes1);
00497 <span class="preprocessor">#endif</span>
00498 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(lpvPtr2) {
00499 <span class="preprocessor">#ifdef LOAD_FULL_WAVE</span>
00500 <span class="preprocessor"></span>        memcpy(lpvPtr2, wav_buf+wavDataOffset+dwBytes1, dwBytes2);
00501 <span class="preprocessor">#else</span>
00502 <span class="preprocessor"></span>        filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>(lpvPtr2, dwBytes2);
00503 <span class="preprocessor">#endif</span>
00504 <span class="preprocessor"></span>    }
00505     <span class="comment">// unlock data back</span>
00506     hr = lpDsb-&gt;Unlock(lpvPtr1, dwBytes1, lpvPtr2, dwBytes2);
00507     <span class="keywordflow">if</span>(DS_OK != hr) {
00508         <span class="comment">// fail to unlock</span>
00509         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot unlock DirectSoundBuffer"</span>);
00510         <span class="keywordflow">return</span> 0;
00511     }
00512 
00513     <span class="comment">//------- Set volume and pan -----------//</span>
00514     lpDsb-&gt;SetVolume(dsVolume.ds_vol);
00515     lpDsb-&gt;SetPan(dsVolume.ds_pan);
00516 
00517     <span class="comment">//------- Play wav file --------//</span>
00518     <span class="keywordflow">if</span>(lpDsb-&gt;Play(0, 0, 0) != DS_OK) {
00519         <span class="comment">// fail to play</span>
00520         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot play DirectSoundBuffer"</span>);
00521         <span class="keywordflow">return</span> 0;
00522     }
00523 
00524     <span class="keywordflow">return</span> wav_serial_no[chanNum] = assign_serial(max_wav_serial_no);
00525 }
00526 
00527 <span class="comment">//------- End of function Audio::play_wav -------//</span>
00528 
00529 <span class="comment">//------- Begin of function Audio::play_wav -------//</span>
<a name="l00540"></a><a class="code" href="classAudio.html#a7">00540</a> <span class="comment">int Audio::play_wav(short resIdx, DsVolume dsVolume) {</span>
00541     <span class="keywordflow">if</span>( !wav_init_flag || !wav_flag )               <span class="comment">// a initialized and workable midi device can be disabled by user setting</span>
00542         <span class="keywordflow">return</span> 0;
00543 
00544     <span class="comment">//-------- Load wav file header-------//</span>
00545     <span class="keywordtype">int</span>   dataSize;
00546     DWORD wavDataOffset, wavDataLength;
00547 
00548     <a class="code" href="classFile.html">File</a>* filePtr = wav_res.get_file(resIdx, dataSize);
00549 
00550     <span class="keywordflow">if</span>( !filePtr )
00551         <span class="keywordflow">return</span> 0;
00552 
00553     <span class="comment">// load small part of the wave file (first 128 bytes) enough to hold</span>
00554     <span class="comment">// the hold header</span>
00555 <span class="preprocessor">#ifdef LOAD_FULL_WAVE</span>
00556 <span class="preprocessor"></span>    <span class="keywordflow">if</span>( dataSize &gt; wav_buf_size ) {
00557         wav_buf_size = dataSize;
00558         wav_buf = <a class="code" href="ALL_8H.html#a7">mem_resize</a>( wav_buf, wav_buf_size );
00559     }
00560     <span class="keywordflow">if</span>( !filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>( wav_buf, dataSize))
00561 <span class="preprocessor">#else</span>
00562 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( !filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>( wav_buf, 128 ) )
00563 <span class="preprocessor">#endif</span>
00564 <span class="preprocessor"></span>            <span class="keywordflow">return</span> 0;
00565 
00566     <span class="comment">// short-cut to test play_resided_wave()</span>
00567 <span class="preprocessor">#ifdef LOAD_FULL_WAVE</span>
00568 <span class="preprocessor"></span>    <span class="keywordflow">return</span> play_resided_wav(wav_buf);
00569 <span class="preprocessor">#endif</span>
00570 <span class="preprocessor"></span>
00571     <span class="comment">// determine the wave data offset and length</span>
00572     <span class="keywordtype">char</span> * dataTag = wavefile_data(wav_buf);
00573     <span class="keywordflow">if</span> (!dataTag) {
00574         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Invalid wave file format"</span>);
00575         <span class="keywordflow">return</span> 0;                                     <span class="comment">// invalid RIFF WAVE format</span>
00576     }
00577 
00578     wavDataOffset = (dataTag - wav_buf) + 4 + <span class="keyword">sizeof</span>(DWORD);
00579     wavDataLength = *(DWORD *)(dataTag+4);
00580 
00581 <span class="preprocessor">#ifndef LOAD_FULL_WAVE</span>
00582 <span class="preprocessor"></span>    <span class="comment">// seek to the start of wave data</span>
00583     filePtr-&gt;<a class="code" href="classFile.html#a7">file_seek</a>(wavDataOffset-128,FILE_CURRENT);
00584 <span class="preprocessor">#endif</span>
00585 <span class="preprocessor"></span>
00586     <span class="comment">//------- Create DirectSoundBuffer to store a wave ------//</span>
00587     LPDIRECTSOUNDBUFFER lpDsb;
00588     DSBUFFERDESC dsbDesc;
00589     HRESULT hr;
00590     DWORD dsbStatus;
00591 
00592     <span class="comment">// set up DSBUFFERDESC structure</span>
00593     memset(&amp;dsbDesc, 0, <span class="keyword">sizeof</span>(DSBUFFERDESC));      <span class="comment">// zero it out</span>
00594     dsbDesc.dwSize = <span class="keyword">sizeof</span>(DSBUFFERDESC);
00595     dsbDesc.dwFlags = <a class="code" href="Oaudio_8cpp.html#a0">DSBCAPS_CTRLDEFAULT</a>;          <span class="comment">// Need defaul controls (pan, volume, frequency)</span>
00596     dsbDesc.dwBufferBytes = wavDataLength;
00597     dsbDesc.lpwfxFormat = (LPWAVEFORMATEX) (wav_buf+0x14);
00598     <span class="comment">// ------- assign buffer to a channel number ----------//</span>
00599     lpDsb = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00600     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> chanNum = 0; chanNum &lt; <a class="code" href="Oaudio_8h.html#a4">MAX_WAV_CHANNEL</a>; ++chanNum)
00601         <span class="keywordflow">if</span>(lp_wav_ch_dsb[chanNum] == <a class="code" href="OHELP_8H.html#a0">NULL</a> || (lp_wav_ch_dsb[chanNum]-&gt;GetStatus(&amp;dsbStatus),
00602                                               !(dsbStatus &amp; DSBSTATUS_PLAYING))) {
00603             <span class="keywordflow">if</span>(lp_wav_ch_dsb[chanNum]) {
00604                 lp_wav_ch_dsb[chanNum]-&gt;Release();
00605                 lp_wav_ch_dsb[chanNum] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00606             }
00607             <span class="comment">// found an idle channel, create DirectSoundBuffer</span>
00608             hr = lp_direct_sound-&gt;CreateSoundBuffer(&amp;dsbDesc, &amp;lpDsb, <a class="code" href="OHELP_8H.html#a0">NULL</a>);
00609             <span class="keywordflow">if</span> (DS_OK != hr) {
00610                 <span class="comment">// failed!</span>
00611                 <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot create DirectSoundBuffer"</span>);
00612                 <span class="keywordflow">return</span> 0;
00613             }
00614             lp_wav_ch_dsb[chanNum] = lpDsb;
00615             <span class="keywordflow">break</span>;
00616         }
00617     <span class="keywordflow">if</span>( chanNum &gt;= <a class="code" href="Oaudio_8h.html#a4">MAX_WAV_CHANNEL</a>) {
00618         <span class="keywordflow">return</span> 0;
00619     }
00620     <span class="comment">// Note : if not found, just play the sound, don't play the sound</span>
00621     <span class="comment">// increase MAX_WAV_CHANNEL</span>
00622 
00623     <span class="comment">//------- copy sound data to DirectSoundBuffer--------//</span>
00624     <span class="comment">// unlock vga_front</span>
00625     <a class="code" href="classVgaFrontLock.html">VgaFrontLock</a> vgaLock;
00626 
00627     <span class="comment">// lock the buffer first</span>
00628     LPVOID lpvPtr1;
00629     DWORD dwBytes1;
00630     LPVOID lpvPtr2;
00631     DWORD dwBytes2;
00632 
00633     hr = lpDsb-&gt;Lock(0, wavDataLength, &amp;lpvPtr1, &amp;dwBytes1, &amp;lpvPtr2, &amp;dwBytes2, 0);
00634     <span class="keywordflow">if</span>(DS_OK != hr) {
00635         <span class="comment">// fail to lock</span>
00636         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot lock DirectSoundBuffer"</span>);
00637         <span class="keywordflow">return</span> 0;
00638     }
00639 
00640     <span class="comment">// write to pointers</span>
00641 <span class="preprocessor">#ifdef LOAD_FULL_WAVE</span>
00642 <span class="preprocessor"></span>    memcpy(lpvPtr1, wav_buf+wavDataOffset, dwBytes1);
00643 <span class="preprocessor">#else</span>
00644 <span class="preprocessor"></span>    filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>(lpvPtr1, dwBytes1);
00645 <span class="preprocessor">#endif</span>
00646 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(lpvPtr2) {
00647 <span class="preprocessor">#ifdef LOAD_FULL_WAVE</span>
00648 <span class="preprocessor"></span>        memcpy(lpvPtr2, wav_buf+wavDataOffset+dwBytes1, dwBytes2);
00649 <span class="preprocessor">#else</span>
00650 <span class="preprocessor"></span>        filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>(lpvPtr2, dwBytes2);
00651 <span class="preprocessor">#endif</span>
00652 <span class="preprocessor"></span>    }
00653     <span class="comment">// unlock data back</span>
00654     hr = lpDsb-&gt;Unlock(lpvPtr1, dwBytes1, lpvPtr2, dwBytes2);
00655     <span class="keywordflow">if</span>(DS_OK != hr) {
00656         <span class="comment">// fail to unlock</span>
00657         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot unlock DirectSoundBuffer"</span>);
00658         <span class="keywordflow">return</span> 0;
00659     }
00660 
00661     <span class="comment">//------- Set volume and pan -----------//</span>
00662     lpDsb-&gt;SetVolume(dsVolume.ds_vol);
00663     lpDsb-&gt;SetPan(dsVolume.ds_pan);
00664 
00665     <span class="comment">//------- Play wav file --------//</span>
00666     <span class="keywordflow">if</span>(lpDsb-&gt;Play(0, 0, 0) != DS_OK) {
00667         <span class="comment">// fail to play</span>
00668         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot play DirectSoundBuffer"</span>);
00669         <span class="keywordflow">return</span> 0;
00670     }
00671 
00672     <span class="keywordflow">return</span> wav_serial_no[chanNum] = assign_serial(max_wav_serial_no);
00673 }
00674 
00675 <span class="comment">//------- End of function Audio::play_wav -------//</span>
00676 
00677 <span class="comment">//------- Begin of function Audio::play_resided_wav -------//</span>
<a name="l00688"></a><a class="code" href="classAudio.html#a8">00688</a> <span class="comment">int Audio::play_resided_wav(char* wavBuf, DsVolume dsVolume) {</span>
00689     <span class="keywordflow">if</span>( !wav_init_flag || !wav_flag )               <span class="comment">// a initialized and workable midi device can be disabled by user setting</span>
00690         <span class="keywordflow">return</span> 0;
00691 
00692     <span class="comment">//-------- Load wav file header-------//</span>
00693     DWORD wavDataOffset, wavDataLength;
00694 
00695     <span class="comment">// determine the wave data offset and length</span>
00696     <span class="keywordtype">char</span> * dataTag = wavefile_data(wavBuf);
00697     <span class="keywordflow">if</span> (!dataTag) {
00698         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Invalid wave file format"</span>);
00699         <span class="keywordflow">return</span> 0;                                     <span class="comment">// invalid RIFF WAVE format</span>
00700     }
00701 
00702     wavDataOffset = (dataTag - wavBuf) + 4 + <span class="keyword">sizeof</span>(DWORD);
00703     wavDataLength = *(DWORD *)(dataTag+4);
00704 
00705     <span class="comment">//------- Create DirectSoundBuffer to store a wave ------//</span>
00706     LPDIRECTSOUNDBUFFER lpDsb;
00707     DSBUFFERDESC dsbDesc;
00708     HRESULT hr;
00709     DWORD dsbStatus;
00710 
00711     <span class="comment">// set up DSBUFFERDESC structure</span>
00712     memset(&amp;dsbDesc, 0, <span class="keyword">sizeof</span>(DSBUFFERDESC));      <span class="comment">// zero it out</span>
00713     dsbDesc.dwSize = <span class="keyword">sizeof</span>(DSBUFFERDESC);
00714     dsbDesc.dwFlags = <a class="code" href="Oaudio_8cpp.html#a0">DSBCAPS_CTRLDEFAULT</a>;          <span class="comment">// Need defaul controls (pan, volume, frequency)</span>
00715     dsbDesc.dwBufferBytes = wavDataLength;
00716     dsbDesc.lpwfxFormat = (LPWAVEFORMATEX) (wavBuf+0x14);
00717     <span class="comment">// ------- assign buffer to a channel number ----------//</span>
00718     lpDsb = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00719     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> chanNum = 0; chanNum &lt; <a class="code" href="Oaudio_8h.html#a4">MAX_WAV_CHANNEL</a>; ++chanNum)
00720         <span class="keywordflow">if</span>(lp_wav_ch_dsb[chanNum] == <a class="code" href="OHELP_8H.html#a0">NULL</a> || (lp_wav_ch_dsb[chanNum]-&gt;GetStatus(&amp;dsbStatus),
00721                                               !(dsbStatus &amp; DSBSTATUS_PLAYING))) {
00722             <span class="keywordflow">if</span>(lp_wav_ch_dsb[chanNum]) {
00723                 lp_wav_ch_dsb[chanNum]-&gt;Release();
00724                 lp_wav_ch_dsb[chanNum] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00725             }
00726             <span class="comment">// found an idle channel, create DirectSoundBuffer</span>
00727             hr = lp_direct_sound-&gt;CreateSoundBuffer(&amp;dsbDesc, &amp;lpDsb, <a class="code" href="OHELP_8H.html#a0">NULL</a>);
00728             <span class="keywordflow">if</span> (DS_OK != hr) {
00729                 <span class="comment">// failed!</span>
00730                 <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot create DirectSoundBuffer"</span>);
00731                 <span class="keywordflow">return</span> 0;
00732             }
00733             lp_wav_ch_dsb[chanNum] = lpDsb;
00734             <span class="keywordflow">break</span>;
00735         }
00736     <span class="keywordflow">if</span>( chanNum &gt;= <a class="code" href="Oaudio_8h.html#a4">MAX_WAV_CHANNEL</a>) {
00737         <span class="keywordflow">return</span> 0;
00738     }
00739     <span class="comment">// Note : if not found, just play the sound, don't play the sound</span>
00740     <span class="comment">// increase MAX_WAV_CHANNEL</span>
00741 
00742     <span class="comment">//------- copy sound data to DirectSoundBuffer--------//</span>
00743     <span class="comment">// unlock vga_front</span>
00744     <a class="code" href="classVgaFrontLock.html">VgaFrontLock</a> vgaLock;
00745 
00746     <span class="comment">// lock the buffer first</span>
00747     LPVOID lpvPtr1;
00748     DWORD dwBytes1;
00749     LPVOID lpvPtr2;
00750     DWORD dwBytes2;
00751 
00752     hr = lpDsb-&gt;Lock(0, wavDataLength, &amp;lpvPtr1, &amp;dwBytes1, &amp;lpvPtr2, &amp;dwBytes2, 0);
00753     <span class="keywordflow">if</span>(DS_OK != hr) {
00754         <span class="comment">// fail to lock</span>
00755         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot lock DirectSoundBuffer"</span>);
00756         <span class="keywordflow">return</span> 0;
00757     }
00758 
00759     <span class="comment">// write to pointers</span>
00760     memcpy(lpvPtr1, wavBuf+wavDataOffset, dwBytes1);
00761     <span class="keywordflow">if</span>(lpvPtr2) {
00762         memcpy(lpvPtr2, wavBuf+wavDataOffset+dwBytes1, dwBytes2);
00763     }
00764     <span class="comment">// unlock data back</span>
00765     hr = lpDsb-&gt;Unlock(lpvPtr1, dwBytes1, lpvPtr2, dwBytes2);
00766     <span class="keywordflow">if</span>(DS_OK != hr) {
00767         <span class="comment">// fail to unlock</span>
00768         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot unlock DirectSoundBuffer"</span>);
00769         <span class="keywordflow">return</span> 0;
00770     }
00771 
00772     <span class="comment">//------- Set volume -----------//</span>
00773     lpDsb-&gt;SetVolume(dsVolume.ds_vol);
00774     lpDsb-&gt;SetPan(dsVolume.ds_pan);
00775 
00776     <span class="comment">//------- Play wav file --------//</span>
00777     <span class="keywordflow">if</span>(lpDsb-&gt;Play(0, 0, 0) != DS_OK) {
00778         <span class="comment">// fail to play</span>
00779         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot play DirectSoundBuffer"</span>);
00780         <span class="keywordflow">return</span> 0;
00781     }
00782 
00783     <span class="keywordflow">return</span> wav_serial_no[chanNum] = assign_serial(max_wav_serial_no);
00784 }
00785 
00786 <span class="comment">//------- End of function Audio::play_resided_wav -------//</span>
00787 
00788 <span class="comment">// ###### begin Gilbert 6/12 ########//</span>
00789 <span class="comment">//------- Begin of function Audio::get_free_wav_ch --------//</span>
<a name="l00790"></a><a class="code" href="classAudio.html#a9">00790</a> <span class="keywordtype">int</span> <a class="code" href="classAudio.html#a9">Audio::get_free_wav_ch</a>() {
00791     <span class="keywordtype">int</span> count = 0;
00792     DWORD dsbStatus;
00793     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> chanNum = 0; chanNum &lt; <a class="code" href="Oaudio_8h.html#a4">MAX_WAV_CHANNEL</a>; ++chanNum) {
00794         <span class="keywordflow">if</span>( lp_wav_ch_dsb[chanNum] != <a class="code" href="OHELP_8H.html#a0">NULL</a> &amp;&amp; (lp_wav_ch_dsb[chanNum]-&gt;GetStatus(&amp;dsbStatus),
00795                                                !(dsbStatus &amp; DSBSTATUS_PLAYING)) ) {
00796             lp_wav_ch_dsb[chanNum]-&gt;Release();
00797             lp_wav_ch_dsb[chanNum] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00798         }
00799 
00800         <span class="keywordflow">if</span>( !lp_wav_ch_dsb[chanNum] )
00801             count++;
00802     }
00803 
00804     <span class="keywordflow">return</span> count;
00805 }
00806 
00807 <span class="comment">//------- End of function Audio::get_free_wav_ch --------//</span>
00808 <span class="comment">// ###### end Gilbert 6/12 ########//</span>
00809 
00810 <span class="comment">//------- Begin of function Audio::stop_wav ------------//</span>
<a name="l00819"></a><a class="code" href="classAudio.html#a10">00819</a> <span class="comment">int Audio::stop_wav(int serial) {</span>
00820     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> chanNum = 0; chanNum &lt; <a class="code" href="Oaudio_8h.html#a4">MAX_WAV_CHANNEL</a>; ++chanNum) {
00821         <span class="keywordflow">if</span>(lp_wav_ch_dsb[chanNum] != <a class="code" href="OHELP_8H.html#a0">NULL</a> &amp;&amp; wav_serial_no[chanNum] == serial) {
00822             lp_wav_ch_dsb[chanNum]-&gt;Stop();
00823             lp_wav_ch_dsb[chanNum]-&gt;Release();
00824             lp_wav_ch_dsb[chanNum] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00825             wav_serial_no[chanNum] = 0;
00826             <span class="keywordflow">return</span> 1;
00827         }
00828     }
00829     <span class="keywordflow">return</span> 0;
00830 }
00831 
00832 <span class="comment">//------- End of function Audio::stop_wav ------------//</span>
00833 
00834 <span class="comment">//------- Begin of function Audio::is_wav_playing ------------//</span>
<a name="l00840"></a><a class="code" href="classAudio.html#a11">00840</a> <span class="comment">int Audio::is_wav_playing(int serial) {</span>
00841     DWORD dsbStatus;
00842     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> chanNum = 0; chanNum &lt; <a class="code" href="Oaudio_8h.html#a4">MAX_WAV_CHANNEL</a>; ++chanNum) {
00843         <span class="keywordflow">if</span>(lp_wav_ch_dsb[chanNum] != <a class="code" href="OHELP_8H.html#a0">NULL</a> &amp;&amp; wav_serial_no[chanNum] == serial
00844            &amp;&amp; lp_wav_ch_dsb[chanNum]-&gt;GetStatus(&amp;dsbStatus) ) {
00845             <span class="keywordflow">return</span> dsbStatus &amp; DSBSTATUS_PLAYING;
00846         }
00847     }
00848     <span class="keywordflow">return</span> 0;
00849 }
00850 
00851 <span class="comment">//------- End of function Audio::is_wav_playing ------------//</span>
00852 
00853 <span class="comment">// ## chwg0105</span>
00854 <span class="comment">//------- Begin of function Audio::play_long_wav2 --------//</span>
<a name="l00856"></a><a class="code" href="classAudio.html#a13">00856</a> <span class="comment">void Audio::play_long_wav2(char *wavName, DsVolume dsVolume) {</span>
00857     <span class="comment">//stop the long_wav played before</span>
00858     <span class="keywordflow">if</span>(last_played_lwave_ch!=0)
00859         stop_long_wav(last_played_lwave_ch);
00860     last_played_lwave_ch=play_long_wav(wavName,dsVolume);
00861 }
00862 
00863 <span class="comment">//------- End of function Audio::play_long_wav2 ----------//</span>
00864 
00865 <span class="comment">//------- Begin of function Audio::play_long_wav --------//</span>
00876 <span class="comment"></span>
00877 <span class="comment">// Create a DirectSoundBuffer of size lwav_buf_size[c]*LWAV_BANKS</span>
00878 <span class="comment">// divide into LWAV_BANKS parts. Each time Audio::yield() is called,</span>
00879 <span class="comment">// load wave file into one part. lwav_bank[c] record which part to be</span>
00880 <span class="comment">// filled next for channel c.</span>
00881 
<a name="l00882"></a><a class="code" href="classAudio.html#a12">00882</a> <span class="keywordtype">int</span> <a class="code" href="classAudio.html#a12">Audio::play_long_wav</a>(<span class="keywordtype">char</span> *wavName, <a class="code" href="classDsVolume.html">DsVolume</a> dsVolume) {
00883     <span class="keywordflow">if</span>( !<a class="code" href="classAudio.html#m2">wav_init_flag</a> || !<a class="code" href="classAudio.html#m5">wav_flag</a> )               <span class="comment">// a initialized and workable midi device can be disabled by user setting</span>
00884         <span class="keywordflow">return</span> 0;
00885 
00886     <span class="comment">//-------- Load wav file header-------//</span>
00887     DWORD wavDataOffset,wavDataLength;
00888 
00889     <span class="keywordflow">if</span>( <a class="code" href="Oaudio_8cpp.html#a1">LWAV_STREAM_BUFSIZ</a>*<a class="code" href="Oaudio_8cpp.html#a2">LWAV_BANKS</a> &gt; <a class="code" href="classAudio.html#m10">wav_buf_size</a> ) {
00890         <a class="code" href="classAudio.html#m10">wav_buf_size</a> = <a class="code" href="Oaudio_8cpp.html#a1">LWAV_STREAM_BUFSIZ</a>*<a class="code" href="Oaudio_8cpp.html#a2">LWAV_BANKS</a>;
00891         <a class="code" href="classAudio.html#m8">wav_buf</a> = <a class="code" href="ALL_8H.html#a7">mem_resize</a>( <a class="code" href="classAudio.html#m8">wav_buf</a>, <a class="code" href="classAudio.html#m10">wav_buf_size</a> );
00892     }
00893 
00894     <span class="comment">// File* filePtr = (File *)mem_add(sizeof(File));           // new File;</span>
00895     <a class="code" href="classFile.html">File</a>* filePtr = <span class="keyword">new</span> <a class="code" href="classFile.html">File</a>;                       <span class="comment">// new File;</span>
00896     <span class="keywordflow">if</span>(!filePtr-&gt;<a class="code" href="classFile.html#a2">file_open</a>(wavName,0,0)) {
00897         <span class="keywordtype">char</span> errmsg[60];
00898         sprintf(errmsg, <span class="stringliteral">"Cannot open %s"</span>, wavName);
00899         box.msg(errmsg);
00900         <span class="keyword">delete</span> filePtr;
00901         <span class="keywordflow">return</span> 0;
00902     }
00903 
00904     <span class="keywordflow">if</span>( !filePtr ) {
00905         <span class="keyword">delete</span> filePtr;
00906         <span class="keywordflow">return</span> 0;
00907     }
00908 
00909     <span class="comment">// load small part of the wave file (first 128 bytes) enough to hold</span>
00910     <span class="comment">// the hold header</span>
00911     <span class="keywordflow">if</span>( !filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>( <a class="code" href="classAudio.html#m8">wav_buf</a>, 128 ) ) {
00912         <span class="keyword">delete</span> filePtr;
00913         <span class="keywordflow">return</span> 0;
00914     }
00915 
00916     <span class="comment">// determine the wave data offset</span>
00917     <span class="keywordtype">char</span> * dataTag = wavefile_data(<a class="code" href="classAudio.html#m8">wav_buf</a>);
00918     <span class="keywordflow">if</span> (!dataTag) {
00919         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Invalid wave file format"</span>);
00920         <span class="keyword">delete</span> filePtr;
00921         <span class="keywordflow">return</span> 0;                                     <span class="comment">// invalid RIFF WAVE format</span>
00922     }
00923     wavDataOffset = (dataTag - <a class="code" href="classAudio.html#m8">wav_buf</a>) + 4 + <span class="keyword">sizeof</span>(DWORD);
00924     wavDataLength = *(DWORD *)(dataTag+4);
00925 
00926     <span class="comment">// seek to the start of wave data</span>
00927     <span class="keywordtype">long</span> temp1 = filePtr-&gt;<a class="code" href="classFile.html#a7">file_seek</a>(wavDataOffset,FILE_BEGIN);
00928 
00929     <a class="code" href="OCOLTBL_8H.html#a2">WORD</a> OptBufferSize=<a class="code" href="Oaudio_8cpp.html#a1">LWAV_STREAM_BUFSIZ</a>,
00930         MinRemainder =(WORD)(wavDataLength % (OptBufferSize * <a class="code" href="Oaudio_8cpp.html#a2">LWAV_BANKS</a>));
00931     <span class="comment">//------- find out the best buffer size -------//</span>
00932     <span class="comment">// store it in OptBufferSize</span>
00933     <span class="comment">// criteria : below or equal to LWAV_STREAM_BUFSIZ and</span>
00934     <span class="comment">// minimize wavDataLength % (OptBufferSize * LWAV_BANKS)</span>
00935     <span class="comment">// i.e. minimize the truncation to the wave file</span>
00936     <span class="keywordflow">for</span>(<a class="code" href="OCOLTBL_8H.html#a2">WORD</a> TryBufSiz=<a class="code" href="Oaudio_8cpp.html#a1">LWAV_STREAM_BUFSIZ</a>-0x200; TryBufSiz &lt;= <a class="code" href="Oaudio_8cpp.html#a1">LWAV_STREAM_BUFSIZ</a>;
00937         TryBufSiz+=0x20) {
00938         <a class="code" href="OCOLTBL_8H.html#a2">WORD</a> TryRemainder = (WORD)(wavDataLength % (TryBufSiz * <a class="code" href="Oaudio_8cpp.html#a2">LWAV_BANKS</a>));
00939         <span class="keywordflow">if</span>(TryRemainder &lt; MinRemainder) {
00940             MinRemainder = TryRemainder;
00941             OptBufferSize = TryBufSiz;
00942         }
00943     }
00944 
00945     <span class="comment">//------- Create DirectSoundBuffer to store a wave ------//</span>
00946     LPDIRECTSOUNDBUFFER lpDsb;
00947     DSBUFFERDESC dsbDesc;
00948     HRESULT hr;
00949     DWORD dsbStatus;
00950 
00951     <span class="comment">// set up DSBUFFERDESC structure</span>
00952     memset(&amp;dsbDesc, 0, <span class="keyword">sizeof</span>(DSBUFFERDESC));      <span class="comment">// zero it out</span>
00953     dsbDesc.dwSize = <span class="keyword">sizeof</span>(DSBUFFERDESC);
00954     dsbDesc.dwFlags = <a class="code" href="Oaudio_8cpp.html#a0">DSBCAPS_CTRLDEFAULT</a>;          <span class="comment">// Need defaul controls (pan, volume, frequency)</span>
00955     dsbDesc.dwBufferBytes = OptBufferSize * <a class="code" href="Oaudio_8cpp.html#a2">LWAV_BANKS</a>;
00956     dsbDesc.lpwfxFormat = (LPWAVEFORMATEX) (<a class="code" href="classAudio.html#m8">wav_buf</a>+0x14);
00957     <span class="comment">// ------- assign buffer to a channel number ----------//</span>
00958     lpDsb = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00959     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> chanNum = 0; chanNum &lt; <a class="code" href="Oaudio_8h.html#a5">MAX_LONG_WAV_CH</a>; ++chanNum)
00960         <span class="keywordflow">if</span>(lp_lwav_ch_dsb[chanNum] == <a class="code" href="OHELP_8H.html#a0">NULL</a> || (lp_lwav_ch_dsb[chanNum]-&gt;GetStatus(&amp;dsbStatus),
00961                                                !(dsbStatus &amp; DSBSTATUS_PLAYING))) {
00962             <span class="keywordflow">if</span>(lp_lwav_ch_dsb[chanNum]) {
00963                 lp_lwav_ch_dsb[chanNum]-&gt;Release();
00964                 lp_lwav_ch_dsb[chanNum] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00965                 <span class="comment">// mem_del(lwav_fileptr[chanNum]);      // delete lwav_fileptr[chanNum];</span>
00966                 <span class="keyword">delete</span> lwav_fileptr[chanNum];
00967                 lwav_fileptr[chanNum] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00968             }
00969             <span class="comment">// found an idle channel, create DirectSoundBuffer</span>
00970             hr = lp_direct_sound-&gt;CreateSoundBuffer(&amp;dsbDesc, &amp;lpDsb, <a class="code" href="OHELP_8H.html#a0">NULL</a>);
00971             <span class="keywordflow">if</span> (DS_OK != hr) {
00972                 <span class="comment">// failed!</span>
00973                 <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot create Stream DirectSoundBuffer"</span>);
00974                 <span class="keyword">delete</span> filePtr;
00975                 <span class="keywordflow">return</span> 0;
00976             }
00977             lp_lwav_ch_dsb[chanNum] = lpDsb;
00978             lwav_fileptr[chanNum] = filePtr;              <span class="comment">// no need to delete filePtr any more</span>
00979             lwav_bank[chanNum] = 0;
00980             lwav_bufsiz[chanNum] = OptBufferSize;
00981             <span class="keywordflow">break</span>;
00982         }
00983     <span class="keywordflow">if</span>( chanNum &gt;= <a class="code" href="Oaudio_8h.html#a5">MAX_LONG_WAV_CH</a>) {
00984         <span class="keyword">delete</span> filePtr;
00985         <span class="keywordflow">return</span> 0;
00986     }
00987     <span class="comment">// Note : if not found, just play the sound, don't play the sound</span>
00988     <span class="comment">// increase MAX_LONG_WAV_CH</span>
00989 
00990     <span class="comment">//------- copy sound data to DirectSoundBuffer--------//</span>
00991     <span class="comment">// unlock vga_front</span>
00992     <a class="code" href="classVgaFrontLock.html">VgaFrontLock</a> vgaLock;
00993 
00994     <span class="comment">// lock the buffer first</span>
00995     LPVOID lpvPtr1;
00996     DWORD dwBytes1;
00997     LPVOID lpvPtr2;
00998     DWORD dwBytes2;
00999 
01000     <span class="comment">// load wave data into buffer</span>
01001     <span class="comment">// load data before lock DirectSoundBuffer in case the wave file</span>
01002     <span class="comment">// is very short</span>
01003     DWORD startPos = filePtr-&gt;<a class="code" href="classFile.html#a8">file_pos</a>();
01004     <span class="keywordflow">if</span>( !filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>(<a class="code" href="classAudio.html#m8">wav_buf</a>, OptBufferSize*<a class="code" href="Oaudio_8cpp.html#a2">LWAV_BANKS</a>)) {
01005         <span class="comment">// file error</span>
01006         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Missing wave file"</span>);
01007         <span class="keywordflow">return</span> 0;
01008     }
01009     DWORD readStreamSize = filePtr-&gt;<a class="code" href="classFile.html#a8">file_pos</a>() - startPos;
01010     DWORD playFlag = DSBPLAY_LOOPING;
01011     hr = lpDsb-&gt;Lock(0, OptBufferSize*<a class="code" href="Oaudio_8cpp.html#a2">LWAV_BANKS</a>, &amp;lpvPtr1, &amp;dwBytes1,
01012                      &amp;lpvPtr2, &amp;dwBytes2, 0);
01013     <span class="keywordflow">if</span>(DS_OK != hr) {
01014         <span class="comment">// fail to lock</span>
01015         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot lock DirectSoundBuffer"</span>);
01016         <span class="keywordflow">return</span> 0;
01017     }
01018 
01019     <span class="comment">// write to pointers</span>
01020     memcpy(lpvPtr1, <a class="code" href="classAudio.html#m8">wav_buf</a>, min(dwBytes1, readStreamSize));
01021     <span class="keywordflow">if</span>( dwBytes1 &gt; readStreamSize ) {
01022         <span class="comment">// end of file, fill the remaining with zero</span>
01023         memset((<span class="keywordtype">char</span> *)lpvPtr1+readStreamSize, 0, dwBytes1 - readStreamSize);
01024         playFlag &amp;= ~DSBPLAY_LOOPING;
01025     }
01026     <span class="keywordflow">else</span> {
01027         readStreamSize -= dwBytes1;
01028         <span class="keywordflow">if</span>(lpvPtr2 &amp;&amp; dwBytes2 &gt; 0) {
01029             memcpy(lpvPtr2, <a class="code" href="classAudio.html#m8">wav_buf</a>+dwBytes1, min(dwBytes2, readStreamSize));
01030             <span class="keywordflow">if</span>( dwBytes2 &gt; readStreamSize ) {
01031                 <span class="comment">// end of file, fill the remaining with zero</span>
01032                 memset((<span class="keywordtype">char</span> *)lpvPtr2+readStreamSize, 0 , dwBytes2 - readStreamSize);
01033                 playFlag &amp;= ~DSBPLAY_LOOPING;
01034             }
01035         }
01036     }
01037 
01038     <span class="comment">// unlock data back</span>
01039     hr = lpDsb-&gt;Unlock(lpvPtr1, dwBytes1, lpvPtr2, dwBytes2);
01040     <span class="keywordflow">if</span>(DS_OK != hr) {
01041         <span class="comment">// fail to unlock</span>
01042         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot unlock DirectSoundBuffer"</span>);
01043         <span class="keywordflow">return</span> 0;
01044     }
01045 
01046     <span class="comment">//------- Set volume -----------//</span>
01047     lpDsb-&gt;SetVolume(dsVolume.<a class="code" href="classDsVolume.html#m0">ds_vol</a>);
01048     lpDsb-&gt;SetPan(dsVolume.<a class="code" href="classDsVolume.html#m1">ds_pan</a>);
01049 
01050     <span class="comment">//------- Play wav file --------//</span>
01051     <span class="keywordflow">if</span>(lpDsb-&gt;Play(0, 0, playFlag) != DS_OK) {
01052         <span class="comment">// fail to play</span>
01053         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot play DirectSoundBuffer"</span>);
01054         <span class="keywordflow">return</span> 0;
01055     }
01056     run_yield = 1;
01057     <span class="keywordflow">return</span> lwav_serial_no[chanNum] = assign_serial(max_lwav_serial_no);
01058 }
01059 
01060 <span class="comment">//------- End of function Audio::play_long_wav ----------//</span>
01061 
01062 <span class="comment">//------- Begin of function Audio::stop_long_wav ------------//</span>
<a name="l01071"></a><a class="code" href="classAudio.html#a14">01071</a> <span class="comment">int Audio::stop_long_wav(int serial) {</span>
01072     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> chanNum = 0; chanNum &lt; <a class="code" href="Oaudio_8h.html#a5">MAX_LONG_WAV_CH</a>; ++chanNum) {
01073         <span class="keywordflow">if</span>(lp_lwav_ch_dsb[chanNum] != <a class="code" href="OHELP_8H.html#a0">NULL</a> &amp;&amp; lwav_serial_no[chanNum] == serial) {
01074             lp_lwav_ch_dsb[chanNum]-&gt;Stop();
01075             lp_lwav_ch_dsb[chanNum]-&gt;Release();
01076             lp_lwav_ch_dsb[chanNum] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01077             <span class="keyword">delete</span> lwav_fileptr[chanNum];
01078             lwav_fileptr[chanNum] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01079             lwav_serial_no[chanNum] = 0;
01080             <span class="keywordflow">return</span> 1;
01081         }
01082     }
01083     <span class="keywordflow">return</span> 0;
01084 }
01085 
01086 <span class="comment">//------- End of function Audio::stop_long_wav ------------//</span>
01087 
01088 <span class="comment">//------- Begin of function Audio::is_long_wav_playing ------------//</span>
<a name="l01094"></a><a class="code" href="classAudio.html#a15">01094</a> <span class="comment">int Audio::is_long_wav_playing(int serial) {</span>
01095     DWORD dsbStatus;
01096     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> chanNum = 0; chanNum &lt; <a class="code" href="Oaudio_8h.html#a5">MAX_LONG_WAV_CH</a>; ++chanNum) {
01097         <span class="keywordflow">if</span>(lp_lwav_ch_dsb[chanNum] != <a class="code" href="OHELP_8H.html#a0">NULL</a> &amp;&amp; lwav_serial_no[chanNum] == serial
01098            &amp;&amp; lp_lwav_ch_dsb[chanNum]-&gt;GetStatus(&amp;dsbStatus) == DS_OK ) {
01099             <span class="keywordflow">return</span> dsbStatus &amp; DSBSTATUS_PLAYING;
01100         }
01101     }
01102     <span class="keywordflow">return</span> 0;
01103 }
01104 
01105 <span class="comment">//------- End of function Audio::is_long_wav_playing ------------//</span>
01106 
01107 <span class="comment">//--------------- Begin of Audio::vol_multiply --------------//</span>
01108 <span class="keywordtype">long</span> Audio::vol_multiply(<span class="keywordtype">int</span> relVolume) {
01109     <span class="keywordtype">long</span> dsVolume = (wav_volume * relVolume) - 10000;
01110     <span class="keywordflow">if</span>( dsVolume &gt; 0 )
01111         dsVolume = 0;
01112     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( dsVolume &lt; -10000 )
01113         dsVolume = -10000;
01114     <span class="keywordflow">return</span> dsVolume;
01115 }
01116 
01117 <span class="comment">//--------------- End of Audio::vol_multiply --------------//</span>
01118 
01119 <span class="comment">//--------------- Begin of Audio::vol_divide --------------//</span>
01120 <span class="keywordtype">int</span> Audio::vol_divide(<span class="keywordtype">long</span> dsVolume) {
01121     <span class="keywordflow">if</span>( wav_volume == 0)
01122         <span class="keywordflow">return</span> 0;
01123 
01124     <span class="keywordtype">int</span> relVolume = (dsVolume + 10000) / wav_volume;
01125     <span class="keywordflow">if</span>( relVolume &lt; 0)
01126         relVolume = 0;
01127     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( relVolume &gt; 100 )
01128         relVolume = 100;
01129     <span class="keywordflow">return</span> relVolume;
01130 }
01131 
01132 <span class="comment">//--------------- End of Audio::vol_divide --------------//</span>
01133 
01134 <span class="comment">//------- Begin of function Audio::play_loop_wav -------//</span>
<a name="l01145"></a><a class="code" href="classAudio.html#a17">01145</a> <span class="comment">int Audio::play_loop_wav(char *wavName, int repeatOffset, DsVolume dsVolume) {</span>
01146     <span class="keywordflow">if</span>( !wav_init_flag || !wav_flag )               <span class="comment">// a initialized and workable midi device can be disabled by user setting</span>
01147         <span class="keywordflow">return</span> 0;
01148 
01149     <span class="comment">//-------- Load wav file header-------//</span>
01150     DWORD wavDataOffset,wavDataLength;
01151 
01152     <span class="comment">// File* filePtr = (File *)mem_add(sizeof(File));           // new File;</span>
01153     <a class="code" href="classFile.html">File</a>* filePtr = <span class="keyword">new</span> <a class="code" href="classFile.html">File</a>;
01154 
01155     <span class="keywordflow">if</span>(!filePtr-&gt;<a class="code" href="classFile.html#a2">file_open</a>(wavName,0,0)) {
01156         <span class="keywordtype">char</span> errmsg[60];
01157         sprintf(errmsg, <span class="stringliteral">"Cannot open %s"</span>, wavName);
01158         box.msg(errmsg);
01159         <span class="keyword">delete</span> filePtr;
01160         <span class="keywordflow">return</span> 0;
01161     }
01162 
01163     <span class="keywordflow">if</span>( !filePtr )
01164         <span class="keywordflow">return</span> 0;
01165 
01166     <span class="comment">// load small part of the wave file (first 128 bytes) enough to hold</span>
01167     <span class="comment">// the hold header</span>
01168     <span class="keywordflow">if</span>( !filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>( wav_buf, 128 ) ) {
01169         <span class="keyword">delete</span> filePtr;
01170         <span class="keywordflow">return</span> 0;
01171     }
01172 
01173     <span class="comment">// determine the wave data offset</span>
01174     <span class="keywordtype">char</span> * dataTag = wavefile_data(wav_buf);
01175     <span class="keywordflow">if</span> (!dataTag) {
01176         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Invalid wave file format"</span>);
01177         <span class="keyword">delete</span> filePtr;
01178         <span class="keywordflow">return</span> 0;                                     <span class="comment">// invalid RIFF WAVE format</span>
01179     }
01180     wavDataOffset = (dataTag - wav_buf) + 4 + <span class="keyword">sizeof</span>(DWORD);
01181     wavDataLength = *(DWORD *)(dataTag+4);
01182 
01183     <span class="comment">// seek to the start of wave data</span>
01184     <span class="keywordtype">long</span> temp1 = filePtr-&gt;<a class="code" href="classFile.html#a7">file_seek</a>(wavDataOffset,FILE_BEGIN);
01185 
01186     <a class="code" href="OCOLTBL_8H.html#a2">WORD</a> OptBufferSize=<a class="code" href="Oaudio_8cpp.html#a3">LOOPWAV_STREAM_BUFSIZ</a>;
01187 
01188     <span class="comment">//------- Create DirectSoundBuffer to store a wave ------//</span>
01189     LPDIRECTSOUNDBUFFER lpDsb;
01190     DSBUFFERDESC dsbDesc;
01191     HRESULT hr;
01192     DWORD dsbStatus;
01193 
01194     <span class="comment">// set up DSBUFFERDESC structure</span>
01195     memset(&amp;dsbDesc, 0, <span class="keyword">sizeof</span>(DSBUFFERDESC));      <span class="comment">// zero it out</span>
01196     dsbDesc.dwSize = <span class="keyword">sizeof</span>(DSBUFFERDESC);
01197     dsbDesc.dwFlags = <a class="code" href="Oaudio_8cpp.html#a0">DSBCAPS_CTRLDEFAULT</a>;          <span class="comment">// Need defaul controls (pan, volume, frequency)</span>
01198     dsbDesc.dwBufferBytes = OptBufferSize * <a class="code" href="Oaudio_8cpp.html#a2">LWAV_BANKS</a>;
01199     dsbDesc.lpwfxFormat = (LPWAVEFORMATEX) (wav_buf+0x14);
01200     <span class="comment">// ------- assign buffer to a channel number ----------//</span>
01201     lpDsb = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01202     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> chanNum = 0; chanNum &lt; <a class="code" href="Oaudio_8h.html#a6">MAX_LOOP_WAV_CH</a>; ++chanNum)
01203         <span class="keywordflow">if</span>(lp_loop_ch_dsb[chanNum] == <a class="code" href="OHELP_8H.html#a0">NULL</a> || (lp_loop_ch_dsb[chanNum]-&gt;GetStatus(&amp;dsbStatus),
01204                                                !(dsbStatus &amp; DSBSTATUS_PLAYING))) {
01205             <span class="keywordflow">if</span>(lp_loop_ch_dsb[chanNum]) {
01206                 lp_loop_ch_dsb[chanNum]-&gt;Release();
01207                 lp_loop_ch_dsb[chanNum] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01208                 <span class="comment">// mem_del(loopwav_fileptr[chanNum]);   // delete lwav_fileptr[chanNum];</span>
01209                 <span class="keyword">delete</span> loopwav_fileptr[chanNum];
01210                 loopwav_fileptr[chanNum] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01211             }
01212             <span class="comment">// found an idle channel, create DirectSoundBuffer</span>
01213             hr = lp_direct_sound-&gt;CreateSoundBuffer(&amp;dsbDesc, &amp;lpDsb, <a class="code" href="OHELP_8H.html#a0">NULL</a>);
01214             <span class="keywordflow">if</span> (DS_OK != hr) {
01215                 <span class="comment">// failed!</span>
01216                 <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot create Stream DirectSoundBuffer"</span>);
01217                 <span class="keywordflow">return</span> 0;
01218             }
01219             lp_loop_ch_dsb[chanNum] = lpDsb;
01220             loopwav_fileptr[chanNum] = filePtr;           <span class="comment">// no need to delete filePtr any more</span>
01221             loopwav_bank[chanNum] = 0;
01222             repeat_offset[chanNum] = wavDataOffset + repeatOffset;
01223             loopwav_fade_rate[chanNum] = 0;
01224             <span class="keywordflow">break</span>;
01225         }
01226     <span class="keywordflow">if</span>( chanNum &gt;= <a class="code" href="Oaudio_8h.html#a6">MAX_LOOP_WAV_CH</a>) {
01227         <span class="keyword">delete</span> filePtr;
01228         <span class="keywordflow">return</span> 0;
01229     }
01230     <span class="comment">// Note : if not found, just play the sound, don't play the sound</span>
01231 
01232     <span class="comment">//------- copy sound data to DirectSoundBuffer--------//</span>
01233     <span class="comment">// unlock vga_front</span>
01234     <a class="code" href="classVgaFrontLock.html">VgaFrontLock</a> vgaLock;
01235 
01236     <span class="comment">// lock the buffer first</span>
01237     LPVOID lpvPtr1;
01238     DWORD dwBytes1;
01239     LPVOID lpvPtr2;
01240     DWORD dwBytes2;
01241 
01242     <span class="comment">// load wave data into buffer</span>
01243     <span class="comment">// load data before lock DirectSoundBuffer in case the wave file</span>
01244     <span class="comment">// is very short</span>
01245     DWORD startPos = filePtr-&gt;<a class="code" href="classFile.html#a8">file_pos</a>();
01246     <span class="keywordflow">if</span>( !filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>(wav_buf, OptBufferSize*<a class="code" href="Oaudio_8cpp.html#a4">LOOPWAV_BANKS</a>)) {
01247         <span class="comment">// file error</span>
01248         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Missing wave file"</span>);
01249         <span class="keywordflow">return</span> 0;
01250     }
01251     DWORD readStreamSize = filePtr-&gt;<a class="code" href="classFile.html#a8">file_pos</a>() - startPos;
01252     DWORD playFlag = DSBPLAY_LOOPING;
01253     hr = lpDsb-&gt;Lock(0, OptBufferSize*<a class="code" href="Oaudio_8cpp.html#a4">LOOPWAV_BANKS</a>, &amp;lpvPtr1, &amp;dwBytes1,
01254                      &amp;lpvPtr2, &amp;dwBytes2, 0);
01255     <span class="keywordflow">if</span>(DS_OK != hr) {
01256         <span class="comment">// fail to lock</span>
01257         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot lock DirectSoundBuffer"</span>);
01258         <span class="keywordflow">return</span> 0;
01259     }
01260 
01261     <span class="comment">// write to pointers, assume wave file repeating size is</span>
01262     <span class="comment">// larger than OptBufferSize * LOOPWAV_BANKS</span>
01263     memcpy(lpvPtr1, wav_buf, min(dwBytes1, readStreamSize));
01264     <span class="keywordflow">if</span>( dwBytes1 &lt; readStreamSize ) {
01265         readStreamSize -= dwBytes1;
01266         <span class="keywordflow">if</span>(lpvPtr2 &amp;&amp; dwBytes2 &gt; 0) {
01267             memcpy(lpvPtr2, wav_buf+dwBytes1, min(dwBytes2, readStreamSize));
01268         }
01269     }
01270 
01271     <span class="comment">// unlock data back</span>
01272     hr = lpDsb-&gt;Unlock(lpvPtr1, dwBytes1, lpvPtr2, dwBytes2);
01273     <span class="keywordflow">if</span>(DS_OK != hr) {
01274         <span class="comment">// fail to unlock</span>
01275         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot unlock DirectSoundBuffer"</span>);
01276         <span class="keywordflow">return</span> 0;
01277     }
01278 
01279     <span class="comment">//------- Set volume -----------//</span>
01280     lpDsb-&gt;SetVolume(dsVolume.ds_vol);
01281     lpDsb-&gt;SetPan(dsVolume.ds_pan);
01282 
01283     <span class="comment">//------- Play wav file --------//</span>
01284     <span class="keywordflow">if</span>(lpDsb-&gt;Play(0, 0, playFlag) != DS_OK) {
01285         <span class="comment">// fail to play</span>
01286         <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot play DirectSoundBuffer"</span>);
01287         <span class="keywordflow">return</span> 0;
01288     }
01289     run_yield = 1;
01290     <span class="keywordflow">return</span> chanNum+1;
01291 }
01292 
01293 <span class="comment">//------- End of function Audio::play_loop_wav ---------//</span>
01294 
01295 <span class="comment">//------- Begin of function Audio::volume_loop_wav -------//</span>
<a name="l01296"></a><a class="code" href="classAudio.html#a19">01296</a> <span class="keywordtype">void</span>  <a class="code" href="classAudio.html#a19">Audio::volume_loop_wav</a>(<span class="keywordtype">int</span> ch, <a class="code" href="classDsVolume.html">DsVolume</a> dsVolume) {
01297     <span class="keywordtype">int</span> chanNum = ch-1;
01298     <span class="keywordflow">if</span>( chanNum &lt; 0 || chanNum &gt;= <a class="code" href="Oaudio_8h.html#a6">MAX_LOOP_WAV_CH</a>)
01299         <span class="keywordflow">return</span>;
01300     <span class="keywordflow">if</span>(lp_loop_ch_dsb[chanNum]) {
01301         lp_loop_ch_dsb[chanNum]-&gt;SetVolume(dsVolume.<a class="code" href="classDsVolume.html#m0">ds_vol</a>);
01302         lp_loop_ch_dsb[chanNum]-&gt;SetPan(dsVolume.<a class="code" href="classDsVolume.html#m1">ds_pan</a>);
01303 
01304         <span class="comment">// stop fading</span>
01305         loopwav_fade_rate[chanNum] = 0;
01306     }
01307 }
01308 
01309 <span class="comment">//------- End of function Audio::volume_loop_wav -------//</span>
01310 
01311 <span class="comment">//------- Begin of function Audio::fade_out_loop_wav -------//</span>
<a name="l01315"></a><a class="code" href="classAudio.html#a20">01315</a> <span class="comment">void Audio::fade_out_loop_wav(int ch, int fadeRate) {</span>
01316     <span class="keywordtype">int</span> chanNum = ch-1;
01317     <span class="keywordflow">if</span>( chanNum &lt; 0 || chanNum &gt;= <a class="code" href="Oaudio_8h.html#a6">MAX_LOOP_WAV_CH</a>)
01318         <span class="keywordflow">return</span>;
01319     <span class="keywordflow">if</span>(lp_loop_ch_dsb[chanNum]) {
01320         loopwav_fade_rate[chanNum] = fadeRate;
01321         loopwav_fade_time[chanNum] = m.get_time();
01322     }
01323 }
01324 
01325 <span class="comment">//------- End of function Audio::fade_out_loop_wav -------//</span>
01326 
01327 <span class="comment">//------- Begin of function Audio::get_loop_wav_volume -------//</span>
<a name="l01328"></a><a class="code" href="classAudio.html#a21">01328</a> <a class="code" href="classDsVolume.html">DsVolume</a> <a class="code" href="classAudio.html#a21">Audio::get_loop_wav_volume</a>(<span class="keywordtype">int</span> ch) {
01329     <span class="keywordtype">int</span> chanNum = ch-1;
01330     <span class="keywordflow">if</span>( chanNum &lt; 0 || chanNum &gt;= <a class="code" href="Oaudio_8h.html#a6">MAX_LOOP_WAV_CH</a>)
01331         <span class="keywordflow">return</span> <a class="code" href="classRelVolume.html">RelVolume</a>(0,0);
01332 
01333     <span class="keywordtype">long</span> volume;
01334     <span class="keywordtype">long</span> pan;
01335     LPDIRECTSOUNDBUFFER lpDsb= lp_loop_ch_dsb[chanNum];
01336     <span class="keywordflow">if</span>( lpDsb &amp;&amp; lpDsb-&gt;GetVolume(&amp;volume) == DS_OK &amp;&amp;
01337         lpDsb-&gt;GetPan(&amp;pan) == DS_OK ) {
01338         <span class="keywordflow">return</span> <a class="code" href="classDsVolume.html">DsVolume</a>(volume, pan);
01339     }
01340     <span class="keywordflow">return</span> <a class="code" href="classRelVolume.html">RelVolume</a>(0,0);
01341 }
01342 
01343 <span class="comment">//------- End of function Audio::get_loop_wav_volume -------//</span>
01344 
01345 <span class="comment">//------- Begin of function Audio::is_loop_wav_fading -------//</span>
<a name="l01346"></a><a class="code" href="classAudio.html#a22">01346</a> <span class="keywordtype">int</span> <a class="code" href="classAudio.html#a22">Audio::is_loop_wav_fading</a>(<span class="keywordtype">int</span> ch) {
01347     <span class="keywordtype">int</span> chanNum = ch-1;
01348     <span class="keywordflow">if</span>( chanNum &lt; 0 || chanNum &gt;= <a class="code" href="Oaudio_8h.html#a6">MAX_LOOP_WAV_CH</a>)
01349         <span class="keywordflow">return</span> 0;
01350 
01351     <span class="keywordflow">return</span> lp_loop_ch_dsb[chanNum] &amp;&amp; loopwav_fade_rate[chanNum];
01352 }
01353 
01354 <span class="comment">//------- End of function Audio::is_loop_wav_fading -------//</span>
01355 
01356 <span class="comment">//------- Begin of function Audio::yield ---------------//</span>
<a name="l01357"></a><a class="code" href="classAudio.html#a4">01357</a> <span class="keywordtype">void</span>  <a class="code" href="classAudio.html#a4">Audio::yield</a>() {
01358     <span class="keywordflow">if</span>( !run_yield)
01359         <span class="keywordflow">return</span>;
01360 
01361     run_yield = 0;                                  <span class="comment">// suspend recursive Audio::yield();</span>
01362 
01363     <span class="comment">// unlock vga_front</span>
01364     <a class="code" href="classVgaFrontLock.html">VgaFrontLock</a> vgaLock;
01365 
01366     <span class="comment">// set break point beyond this point</span>
01367     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="Oaudio_8h.html#a5">MAX_LONG_WAV_CH</a>; ++i) {
01368         <span class="keywordflow">if</span>( !lp_lwav_ch_dsb[i] )
01369             <span class="keywordflow">continue</span>;
01370 
01371         <span class="comment">// if a wav is not play, or buffer lost, stop it</span>
01372         LPDIRECTSOUNDBUFFER&amp; lpDsb = lp_lwav_ch_dsb[i];
01373         DWORD dsbStatus;
01374         <span class="keywordflow">if</span>( lpDsb-&gt;GetStatus(&amp;dsbStatus) != DS_OK) {
01375             <a class="code" href="ALL_8H.html#a1">err_here</a>();
01376             <span class="keywordflow">continue</span>;
01377         }
01378 
01379         <span class="keywordflow">if</span>( !(dsbStatus &amp; DSBSTATUS_PLAYING) ||
01380             (dsbStatus &amp; DSBSTATUS_BUFFERLOST) &amp;&amp; lpDsb-&gt;Restore() != DS_OK ) {
01381             lpDsb-&gt;Stop();
01382             lpDsb-&gt;Release();
01383             lpDsb = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01384             <span class="comment">// mem_del(lwav_fileptr[i]);</span>
01385             <span class="keyword">delete</span> lwav_fileptr[i];
01386             lwav_fileptr[i] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01387             <span class="keywordflow">continue</span>;
01388         }
01389 
01390         <span class="keywordtype">char</span> writeTooFast = 1;
01391 
01392         <span class="comment">// buffer lost, succeeded in restoring</span>
01393         <span class="keywordflow">if</span>( dsbStatus &amp; DSBSTATUS_BUFFERLOST ) {
01394             writeTooFast = 0;
01395         }
01396         <span class="keywordflow">else</span> {
01397             <span class="comment">// perform flow control</span>
01398             DWORD tmpPlayCursor, tmpWriteCursor;
01399             <span class="keywordflow">if</span>( lpDsb-&gt;GetCurrentPosition(&amp;tmpPlayCursor, &amp;tmpWriteCursor) == DS_OK) {
01400                 writeTooFast = ((short)(tmpPlayCursor / lwav_bufsiz[i]) == lwav_bank[i]);
01401             }
01402         }
01403 
01404         <span class="keywordflow">if</span>(!writeTooFast) {
01405             <span class="comment">// lock a channel for lwav_bufsiz[i]</span>
01406             LPVOID lpvPtr1;
01407             DWORD dwBytes1;
01408             LPVOID lpvPtr2;
01409             DWORD dwBytes2;
01410             File *filePtr = lwav_fileptr[i];
01411             HRESULT hr = lpDsb-&gt;Lock(lwav_bank[i]*lwav_bufsiz[i], lwav_bufsiz[i],
01412                                      &amp;lpvPtr1, &amp;dwBytes1,  &amp;lpvPtr2, &amp;dwBytes2, 0);
01413             <span class="comment">// next bank to fill</span>
01414             lwav_bank[i] = (lwav_bank[i] + 1) % <a class="code" href="Oaudio_8cpp.html#a2">LWAV_BANKS</a>;
01415             <span class="keywordflow">if</span>(DS_OK != hr) {
01416                 <span class="comment">// fail to lock</span>
01417                 <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot lock DirectSoundBuffer"</span>);
01418                 run_yield = 1;
01419                 <span class="keywordflow">return</span>;
01420             }
01421 
01422             <span class="keywordtype">long</span> startPos;
01423             <span class="keywordtype">long</span> readStreamSize;
01424             DWORD playFlag = DSBPLAY_LOOPING;
01425 
01426             <span class="comment">// write to pointers</span>
01427             startPos = filePtr-&gt;<a class="code" href="classFile.html#a8">file_pos</a>();
01428 
01429             <span class="comment">//                  filePtr-&gt;file_read(wav_buf, dwBytes1);</span>
01430             <span class="comment">//                  readStreamSize = filePtr-&gt;file_pos() - startPos;        // bytes read in</span>
01431             <span class="comment">//                  memcpy(lpvPtr1, wav_buf, readStreamSize);</span>
01432             filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>(lpvPtr1, dwBytes1);
01433             <span class="comment">// bytes read in</span>
01434             readStreamSize = filePtr-&gt;<a class="code" href="classFile.html#a8">file_pos</a>() - startPos;
01435 
01436             <span class="keywordflow">if</span>((long)dwBytes1 &gt; readStreamSize) {
01437                 <span class="comment">// end of file, fill the remaining with zero</span>
01438                 <span class="comment">//                              memset((char *)lpvPtr1+readStreamSize, 0, dwBytes1 - readStreamSize);</span>
01439                 playFlag &amp;= ~DSBPLAY_LOOPING;             <span class="comment">// clear DSBPLAY_LOOPING</span>
01440             }
01441             <span class="keywordflow">else</span> {
01442                 <span class="keywordflow">if</span>( lpvPtr2 &amp;&amp; dwBytes2 &gt; 0) {
01443                     startPos = filePtr-&gt;<a class="code" href="classFile.html#a8">file_pos</a>();
01444                     filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>(lpvPtr2, dwBytes2);
01445                     <span class="comment">// bytes read in</span>
01446                     readStreamSize = filePtr-&gt;<a class="code" href="classFile.html#a8">file_pos</a>() - startPos;
01447                     <span class="keywordflow">if</span>((long)dwBytes2 &gt; readStreamSize) {
01448                         <span class="comment">// end of file</span>
01449                         <span class="comment">//                                              memset((char *)lpvPtr2+readStreamSize, 0, dwBytes2 - readStreamSize);</span>
01450                         playFlag &amp;= ~DSBPLAY_LOOPING;         <span class="comment">// clear DSBPLAY_LOOPING</span>
01451                     }
01452                 }
01453             }
01454 
01455             <span class="comment">// unlock data back</span>
01456             hr = lpDsb-&gt;Unlock(lpvPtr1, dwBytes1, lpvPtr2, dwBytes2);
01457             <span class="keywordflow">if</span>(DS_OK != hr) {
01458                 <span class="comment">// fail to unlock</span>
01459                 <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot unlock DirectSoundBuffer"</span>);
01460                 run_yield = 1;
01461                 <span class="keywordflow">return</span>;
01462             }
01463             <span class="comment">// load file into a channel, on last stream, don't loop back</span>
01464             <span class="comment">//------- Play wav file --------//</span>
01465             <span class="keywordflow">if</span>(lpDsb-&gt;Play(0, 0, playFlag) != DS_OK) {
01466                 <span class="comment">// fail to play</span>
01467                 <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot play DirectSoundBuffer"</span>);
01468                 run_yield = 1;
01469                 <span class="keywordflow">return</span>;
01470             }
01471         }
01472     }
01473 
01474     <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="Oaudio_8h.html#a6">MAX_LOOP_WAV_CH</a>; ++i) {
01475         <span class="keywordflow">if</span>( !lp_loop_ch_dsb[i] )
01476             <span class="keywordflow">continue</span>;
01477 
01478         <span class="comment">// if a channel is not playing, or can't restore release it</span>
01479         LPDIRECTSOUNDBUFFER&amp; lpDsb = lp_loop_ch_dsb[i];
01480         DWORD dsbStatus;
01481         <span class="keywordflow">if</span>( lpDsb-&gt;GetStatus(&amp;dsbStatus) != DS_OK ) {
01482             <a class="code" href="ALL_8H.html#a1">err_here</a>();
01483             <span class="keywordflow">continue</span>;
01484         }
01485         <span class="keywordflow">if</span>( !(dsbStatus &amp; DSBSTATUS_PLAYING) ||
01486             (dsbStatus &amp; DSBSTATUS_BUFFERLOST) &amp;&amp; lpDsb-&gt;Restore() != DS_OK ) {
01487             lpDsb-&gt;Stop();
01488             lpDsb-&gt;Release();
01489             lpDsb = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01490             <span class="comment">// mem_del(loopwav_fileptr[i]);</span>
01491             <span class="keyword">delete</span> loopwav_fileptr[i];
01492             loopwav_fileptr[i] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01493             <span class="keywordflow">continue</span>;
01494         }
01495 
01496         <span class="keywordtype">char</span> writeTooFast = 1;
01497 
01498         <span class="comment">// buffer lost, succeeded in restoring</span>
01499         <span class="keywordflow">if</span>( dsbStatus &amp; DSBSTATUS_BUFFERLOST ) {
01500             writeTooFast = 0;
01501         }
01502         <span class="keywordflow">else</span> {
01503             <span class="comment">// perform flow control</span>
01504             DWORD tmpPlayCursor, tmpWriteCursor;
01505             <span class="keywordflow">if</span>( lpDsb-&gt;GetCurrentPosition(&amp;tmpPlayCursor, &amp;tmpWriteCursor) == DS_OK) {
01506                 writeTooFast = ((short)(tmpPlayCursor / <a class="code" href="Oaudio_8cpp.html#a3">LOOPWAV_STREAM_BUFSIZ</a>) == loopwav_bank[i]);
01507             }
01508 
01509         }
01510 
01511         <span class="keywordflow">if</span>(!writeTooFast) {
01512             <span class="comment">// lock a channel for loopwav_bufsiz[i]</span>
01513             LPVOID lpvPtr1;
01514             DWORD dwBytes1;
01515             LPVOID lpvPtr2;
01516             DWORD dwBytes2;
01517             File *filePtr = loopwav_fileptr[i];
01518             HRESULT hr = lpDsb-&gt;Lock(loopwav_bank[i]*<a class="code" href="Oaudio_8cpp.html#a3">LOOPWAV_STREAM_BUFSIZ</a>, <a class="code" href="Oaudio_8cpp.html#a3">LOOPWAV_STREAM_BUFSIZ</a>,
01519                                      &amp;lpvPtr1, &amp;dwBytes1,  &amp;lpvPtr2, &amp;dwBytes2, 0);
01520             <span class="comment">// next bank to fill</span>
01521             loopwav_bank[i] = (loopwav_bank[i] + 1) % <a class="code" href="Oaudio_8cpp.html#a4">LOOPWAV_BANKS</a>;
01522             <span class="keywordflow">if</span>(DS_OK != hr) {
01523                 <span class="comment">// fail to lock</span>
01524                 <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot lock DirectSoundBuffer"</span>);
01525                 run_yield = 1;
01526                 <span class="keywordflow">return</span>;
01527             }
01528 
01529             <span class="keywordtype">long</span> startPos;
01530             <span class="keywordtype">long</span> readStreamSize;
01531             DWORD playFlag = DSBPLAY_LOOPING;
01532 
01533             <span class="comment">// write to pointers</span>
01534             startPos = filePtr-&gt;<a class="code" href="classFile.html#a8">file_pos</a>();
01535             filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>(lpvPtr1, dwBytes1);
01536             <span class="comment">// bytes read in</span>
01537             readStreamSize = filePtr-&gt;<a class="code" href="classFile.html#a8">file_pos</a>() - startPos;
01538 
01539             <span class="keywordflow">if</span>((long)dwBytes1 &gt; readStreamSize) {
01540                 <span class="comment">// end of file, seek to beginning and read again</span>
01541                 filePtr-&gt;<a class="code" href="classFile.html#a7">file_seek</a>(repeat_offset[i]);
01542                 filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>((<span class="keywordtype">char</span> *)lpvPtr1+readStreamSize, dwBytes1-readStreamSize);
01543             }
01544 
01545             <span class="comment">// unlock data back</span>
01546             hr = lpDsb-&gt;Unlock(lpvPtr1, dwBytes1, lpvPtr2, dwBytes2);
01547             <span class="keywordflow">if</span>(DS_OK != hr) {
01548                 <span class="comment">// fail to unlock</span>
01549                 <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot unlock DirectSoundBuffer"</span>);
01550                 run_yield = 1;
01551                 <span class="keywordflow">return</span>;
01552             }
01553 
01554             <span class="comment">// set volume if fading</span>
01555             <span class="keywordflow">if</span>( loopwav_fade_rate[i] ) {
01556                 DWORD nextFadeTime = m.get_time();
01557                 <span class="keywordtype">long</span>  volume;
01558                 <span class="keywordflow">if</span>( DS_OK == (hr = lpDsb-&gt;GetVolume(&amp;volume)) ) {
01559                     <span class="comment">// calculate new volume</span>
01560                     volume -= (nextFadeTime - loopwav_fade_time[i]) * loopwav_fade_rate[i];
01561                     <span class="keywordflow">if</span>( volume &lt; DSBVOLUME_MIN )
01562                         volume = DSBVOLUME_MIN;
01563                     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( volume &gt; DSBVOLUME_MAX )
01564                         volume = DSBVOLUME_MAX;
01565                     <span class="keywordflow">if</span>( DS_OK == (hr = lpDsb-&gt;SetVolume(volume)) ) {
01566                         loopwav_fade_time[i] = nextFadeTime;
01567                     }
01568                 }
01569             }
01570 
01571             <span class="comment">// load file into a channel, on last stream, don't loop back</span>
01572             <span class="comment">//------- Play wav file --------//</span>
01573             <span class="keywordflow">if</span>(lpDsb-&gt;Play(0, 0, playFlag) != DS_OK) {
01574                 <span class="comment">// fail to play</span>
01575                 <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"Cannot play DirectSoundBuffer"</span>);
01576                 run_yield = 1;
01577                 <span class="keywordflow">return</span>;
01578             }
01579         }
01580     }
01581 
01582     run_yield = 1;                                  <span class="comment">// resume Audio::yield();</span>
01583 }
01584 
01585 <span class="comment">//------- End of function Audio::yield ---------------//</span>
01586 
01587 <span class="comment">//------- Begin of function Audio::stop_wav -------//</span>
<a name="l01589"></a><a class="code" href="classAudio.html#a25">01589</a> <span class="comment">void Audio::stop_wav() {</span>
01590     <span class="keywordflow">if</span>( !wav_init_flag || !wav_flag )
01591         <span class="keywordflow">return</span>;
01592 
01593     <span class="comment">// ---------- stop all short wave  ------------- //</span>
01594     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="Oaudio_8h.html#a4">MAX_WAV_CHANNEL</a>; ++i)
01595         <span class="keywordflow">if</span>(lp_wav_ch_dsb[i]) {
01596             lp_wav_ch_dsb[i]-&gt;Stop();
01597             lp_wav_ch_dsb[i]-&gt;Release();
01598             lp_wav_ch_dsb[i] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01599         }
01600 
01601     <span class="comment">// ----------- stop all long wave ------------- //</span>
01602     stop_long_wav();
01603 
01604     <span class="comment">// ------------ stop all loop wave ------------//</span>
01605     <span class="keywordflow">for</span>(i = 1; i &lt;= <a class="code" href="Oaudio_8h.html#a6">MAX_LOOP_WAV_CH</a>; ++i) {
01606         stop_loop_wav(i);
01607     }
01608 
01609 }
01610 
01611 <span class="comment">//------- End of function Audio::stop_wav -------//</span>
01612 
01613 <span class="comment">//------- Begin of function Audio::stop_long_wav -------//</span>
<a name="l01615"></a><a class="code" href="classAudio.html#a27">01615</a> <span class="comment">void Audio::stop_long_wav() {</span>
01616     <span class="keywordflow">if</span>( !wav_init_flag || !wav_flag )
01617         <span class="keywordflow">return</span>;
01618 
01619     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="Oaudio_8h.html#a5">MAX_LONG_WAV_CH</a>; ++i)
01620         <span class="keywordflow">if</span>(lp_lwav_ch_dsb[i]) {
01621             lp_lwav_ch_dsb[i]-&gt;Stop();
01622             lp_lwav_ch_dsb[i]-&gt;Release();
01623             lp_lwav_ch_dsb[i] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01624             <span class="comment">// mem_del(lwav_fileptr[i]);</span>
01625             <span class="keyword">delete</span> lwav_fileptr[i];
01626             lwav_fileptr[i] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01627         }
01628 }
01629 
01630 <span class="comment">//------- End of function Audio::stop_long_wav -------//</span>
01631 
01632 <span class="comment">//------- Begin of function Audio::stop_loop_wav -------//</span>
<a name="l01633"></a><a class="code" href="classAudio.html#a18">01633</a> <span class="keywordtype">void</span>  <a class="code" href="classAudio.html#a18">Audio::stop_loop_wav</a>(<span class="keywordtype">int</span> ch) {
01634     <span class="keywordtype">int</span> chanNum = ch-1;
01635     <span class="keywordflow">if</span>( chanNum &lt; 0 || chanNum &gt;= <a class="code" href="Oaudio_8h.html#a6">MAX_LOOP_WAV_CH</a>)
01636         <span class="keywordflow">return</span>;
01637     <span class="keywordflow">if</span>(lp_loop_ch_dsb[chanNum]) {
01638         lp_loop_ch_dsb[chanNum]-&gt;Stop();
01639         lp_loop_ch_dsb[chanNum]-&gt;Release();
01640         lp_loop_ch_dsb[chanNum] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01641         <span class="comment">// mem_del(loopwav_fileptr[chanNum]);   // delete lwav_fileptr[chanNum];</span>
01642         <span class="keyword">delete</span> loopwav_fileptr[chanNum];
01643         loopwav_fileptr[chanNum] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01644     }
01645 }
01646 
01647 <span class="comment">//------- End of function Audio::stop_loop_wav ---------//</span>
01648 
01649 <span class="comment">//------- Begin of function Audio::play_cd -------//</span>
<a name="l01653"></a><a class="code" href="classAudio.html#a23">01653</a> <span class="comment">int Audio::play_cd(int trackId, int volume) {</span>
01654     <span class="keywordflow">if</span>( !cd_init_flag || !cd_flag )
01655         <span class="keywordflow">return</span> 0;
01656 
01657     <span class="comment">// ###### begin Gilbert 3/10 ########//</span>
01658     MCIERROR mciError;
01659     DWORD maxTrack = 99;
01660 
01661     <span class="comment">// Get the number of tracks;</span>
01662     <span class="comment">// limit to number that can be displayed (20).</span>
01663     MCI_STATUS_PARMS mciStatusParms;
01664     mciStatusParms.dwItem = MCI_STATUS_NUMBER_OF_TRACKS;
01665     mciError = mciSendCommand(mci_open.wDeviceID, MCI_STATUS,
01666                               MCI_STATUS_ITEM, (DWORD)(LPVOID) &amp;mciStatusParms);
01667     <span class="keywordflow">if</span>( !mciError )
01668         maxTrack = mciStatusParms.dwReturn;
01669 
01670     <span class="comment">//--- Send an MCI_PLAY command to the CD Audio driver ---//</span>
01671 
01672     mci_open.lpstrDeviceType = (LPCSTR) MCI_DEVTYPE_CD_AUDIO;
01673 
01674     mci_play.dwFrom = MCI_MAKE_TMSF(trackId , 0, 0, 0);
01675     mci_play.dwTo   = MCI_MAKE_TMSF(trackId+1, 0, 0, 0);
01676 
01677     DWORD cmdFlag = MCI_FROM;
01678     <span class="keywordflow">if</span>( (DWORD) trackId &lt; maxTrack )
01679         cmdFlag |= MCI_TO;                            <span class="comment">// if MCI_TO is missing, play until the end</span>
01680     mciError = mciSendCommand( mci_open.wDeviceID, MCI_PLAY, cmdFlag,
01681                                (DWORD) (LPVOID) &amp;mci_play);
01682     <span class="keywordflow">if</span>( mciError )
01683         <span class="keywordflow">return</span> 0;
01684 
01685     <span class="keywordflow">return</span> 1;
01686     <span class="comment">// ###### end Gilbert 3/10 ########//</span>
01687 }
01688 
01689 <span class="comment">//------- End of function Audio::play_cd -------//</span>
01690 
01691 <span class="comment">//------- Begin of function Audio::stop_cd -------//</span>
<a name="l01693"></a><a class="code" href="classAudio.html#a26">01693</a> <span class="comment">void Audio::stop_cd() {</span>
01694     <span class="keywordflow">if</span>( !cd_init_flag || !cd_flag )
01695         <span class="keywordflow">return</span>;
01696 
01697     DWORD dwResult;
01698     dwResult = mciSendCommand(mci_open.wDeviceID, MCI_STOP,
01699                               MCI_WAIT, (DWORD)(LPVOID)<a class="code" href="OHELP_8H.html#a0">NULL</a>);
01700 }
01701 
01702 <span class="comment">//------- End of function Audio::stop_cd -------//</span>
01703 
01704 <span class="comment">//------- Begin of function Audio::is_mid_playing -------//</span>
<a name="l01706"></a><a class="code" href="classAudio.html#a28">01706</a> <span class="comment">int Audio::is_mid_playing() {</span>
01707     <span class="keywordflow">if</span>( !mid_init_flag || !mid_flag )               <span class="comment">// a initialized and workable midi device can be disabled by user setting</span>
01708         <span class="keywordflow">return</span> 0;
01709 
01710     <span class="comment">//... insert code here ...//</span>
01711 
01712     <span class="keywordflow">return</span> 0;
01713 }
01714 
01715 <span class="comment">//------- End of function Audio::is_mid_playing -------//</span>
01716 
01717 <span class="comment">//------- Begin of function Audio::is_wav_playing -------//</span>
<a name="l01719"></a><a class="code" href="classAudio.html#a29">01719</a> <span class="comment">int Audio::is_wav_playing() {</span>
01720     <span class="keywordtype">int</span> playingChannelCount = 0;
01721     DWORD dwStatus;
01722     <span class="keywordflow">if</span>( !wav_init_flag || !wav_flag )               <span class="comment">// a initialized and workable midi device can be disabled by user setting</span>
01723         <span class="keywordflow">return</span> 0;
01724 
01725     <span class="comment">//------ find any wav channel is playing -----//</span>
01726     <span class="comment">// update lp_wav_ch_dsb[x] if necessary</span>
01727     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ch=0; ch &lt; <a class="code" href="Oaudio_8h.html#a4">MAX_WAV_CHANNEL</a>; ++ch)
01728         <span class="keywordflow">if</span>( lp_wav_ch_dsb[ch])
01729             <span class="keywordflow">if</span>( lp_wav_ch_dsb[ch]-&gt;GetStatus(&amp;dwStatus) == DS_OK)
01730                 <span class="keywordflow">if</span> (dwStatus &amp; DSBSTATUS_PLAYING )
01731                     <span class="comment">// a channel is playing</span>
01732                     playingChannelCount++;
01733                 <span class="keywordflow">else</span>
01734                     <span class="comment">// is not playing, clear it</span>
01735                     lp_wav_ch_dsb[ch] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01736             <span class="keywordflow">else</span>
01737                 <span class="comment">// GetStatus not ok, clear it</span>
01738                 lp_wav_ch_dsb[ch] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
01739         <span class="keywordflow">else</span> {
01740             <span class="comment">// nothing</span>
01741         }
01742 
01743     <span class="keywordflow">return</span> (playingChannelCount &gt; 0);
01744 }
01745 
01746 <span class="comment">//------- End of function Audio::is_wav_playing -------//</span>
01747 
01748 <span class="comment">//------- Begin of function Audio::is_cd_playing -------//</span>
<a name="l01750"></a><a class="code" href="classAudio.html#a30">01750</a> <span class="comment">int Audio::is_cd_playing() {</span>
01751     <span class="keywordflow">if</span>( !cd_init_flag || !cd_flag )                 <span class="comment">// a initialized and workable midi device can be disabled by user setting</span>
01752         <span class="keywordflow">return</span> 0;
01753 
01754     MCI_STATUS_PARMS status;
01755     DWORD dwResult;
01756 
01757     <span class="comment">//</span>
01758     <span class="comment">// get the current status</span>
01759     <span class="comment">//</span>
01760 
01761     status.dwItem = MCI_STATUS_MODE;
01762     dwResult = mciSendCommand(mci_open.wDeviceID, MCI_STATUS,
01763                               MCI_WAIT | MCI_STATUS_ITEM, (DWORD)(LPVOID)&amp;status);
01764     <span class="keywordflow">if</span> (dwResult == 0)
01765         <span class="keywordflow">return</span> status.dwReturn == MCI_MODE_PLAY;
01766     <span class="keywordflow">return</span> 0;
01767 }
01768 
01769 <span class="comment">//------- End of function Audio::is_cd_playing -------//</span>
01770 
01771 <span class="comment">//----------------- Begin of Audio::toggle_mid -----------------//</span>
01772 <span class="comment">//</span>
<a name="l01773"></a><a class="code" href="classAudio.html#a31">01773</a> <span class="keywordtype">void</span> <a class="code" href="classAudio.html#a31">Audio::toggle_mid</a>(<span class="keywordtype">int</span> midFlag) {
01774     <span class="keywordflow">if</span>( !midFlag )
01775         <a class="code" href="classAudio.html#a24">stop_mid</a>();
01776 
01777     <a class="code" href="classAudio.html#m4">mid_flag</a> = midFlag;
01778 }
01779 
01780 <span class="comment">//------------------- End of Audio::toggle_mid ------------------//</span>
01781 
01782 <span class="comment">//----------------- Begin of Audio::toggle_wav -----------------//</span>
01783 <span class="comment">//</span>
<a name="l01784"></a><a class="code" href="classAudio.html#a32">01784</a> <span class="keywordtype">void</span> <a class="code" href="classAudio.html#a32">Audio::toggle_wav</a>(<span class="keywordtype">int</span> wavFlag) {
01785     <span class="keywordflow">if</span>( !wavFlag )
01786         <a class="code" href="classAudio.html#a25">stop_wav</a>();
01787 
01788     <a class="code" href="classAudio.html#m5">wav_flag</a> = wavFlag;
01789 }
01790 
01791 <span class="comment">//------------------- End of Audio::toggle_wav ------------------//</span>
01792 
01793 <span class="comment">//----------------- Begin of Audio::toggle_cd -----------------//</span>
01794 <span class="comment">//</span>
<a name="l01795"></a><a class="code" href="classAudio.html#a33">01795</a> <span class="keywordtype">void</span> <a class="code" href="classAudio.html#a33">Audio::toggle_cd</a>(<span class="keywordtype">int</span> cdFlag) {
01796     <span class="keywordflow">if</span>( !cdFlag )
01797         <a class="code" href="classAudio.html#a26">stop_cd</a>();
01798 
01799     <a class="code" href="classAudio.html#m6">cd_flag</a> = cdFlag;
01800 }
01801 
01802 <span class="comment">//------------------- End of Audio::toggle_cd ------------------//</span>
01803 
01804 <span class="comment">//-------------- Begin of Audio::set_mid_volume -------------//</span>
01805 <span class="comment">//</span>
01806 <span class="comment">// Set mid volume</span>
01807 <span class="comment">//</span>
01808 <span class="comment">// &lt;int&gt; midVolume = mid volume, 0-100</span>
01809 <span class="comment">//</span>
<a name="l01810"></a><a class="code" href="classAudio.html#a34">01810</a> <span class="keywordtype">void</span> <a class="code" href="classAudio.html#a34">Audio::set_mid_volume</a>(<span class="keywordtype">int</span> midVolume) {
01811     <span class="keywordflow">if</span>( !<a class="code" href="classAudio.html#m1">mid_init_flag</a> )
01812         <span class="keywordflow">return</span>;
01813 
01814     <span class="comment">//.. insert code here ...//</span>
01815 
01816 }
01817 
01818 <span class="comment">//--------------- End of Audio::set_mid_volume --------------//</span>
01819 
01820 <span class="comment">//-------------- Begin of Audio::set_wav_volume -------------//</span>
01821 <span class="comment">//</span>
01822 <span class="comment">// Set wav volume</span>
01823 <span class="comment">//</span>
01824 <span class="comment">// &lt;int&gt; wavVolume = wav volume, 0-100</span>
01825 <span class="comment">//</span>
<a name="l01826"></a><a class="code" href="classAudio.html#a35">01826</a> <span class="keywordtype">void</span> <a class="code" href="classAudio.html#a35">Audio::set_wav_volume</a>(<span class="keywordtype">int</span> wavVolume) {
01827     <span class="keywordflow">if</span>( !<a class="code" href="classAudio.html#m2">wav_init_flag</a> )
01828         <span class="keywordflow">return</span>;
01829 
01830     <span class="keywordtype">long</span> dsVolume;
01831     <span class="keywordtype">long</span> dsVolDiff = (wavVolume - wav_volume) * 100;
01832 
01833     <span class="comment">// change volume for all channels</span>
01834     <span class="keywordtype">int</span> i;
01835     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Oaudio_8h.html#a4">MAX_WAV_CHANNEL</a>; ++i) {
01836         <span class="keywordflow">if</span>( lp_wav_ch_dsb[i] &amp;&amp;
01837             lp_wav_ch_dsb[i]-&gt;GetVolume(&amp;dsVolume) == DS_OK) {
01838             dsVolume += dsVolDiff;
01839             <span class="keywordflow">if</span>( dsVolume &gt; DSBVOLUME_MAX )
01840                 dsVolume = DSBVOLUME_MAX;
01841             <span class="keywordflow">if</span>( dsVolume &lt; DSBVOLUME_MIN )
01842                 dsVolume = DSBVOLUME_MIN;
01843             lp_wav_ch_dsb[i]-&gt;SetVolume(dsVolume);
01844         }
01845     }
01846 
01847     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Oaudio_8h.html#a5">MAX_LONG_WAV_CH</a>; ++i) {
01848         <span class="keywordflow">if</span>( lp_lwav_ch_dsb[i] &amp;&amp;
01849             lp_lwav_ch_dsb[i]-&gt;GetVolume(&amp;dsVolume) == DS_OK) {
01850             dsVolume += dsVolDiff;
01851             <span class="keywordflow">if</span>( dsVolume &gt; DSBVOLUME_MAX )
01852                 dsVolume = DSBVOLUME_MAX;
01853             <span class="keywordflow">if</span>( dsVolume &lt; DSBVOLUME_MIN )
01854                 dsVolume = DSBVOLUME_MIN;
01855             lp_lwav_ch_dsb[i]-&gt;SetVolume(dsVolume);
01856         }
01857     }
01858 
01859     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Oaudio_8h.html#a6">MAX_LOOP_WAV_CH</a>; ++i) {
01860         <span class="keywordflow">if</span>( lp_loop_ch_dsb[i] &amp;&amp;
01861             lp_loop_ch_dsb[i]-&gt;GetVolume(&amp;dsVolume) == DS_OK) {
01862             dsVolume += dsVolDiff;
01863             <span class="keywordflow">if</span>( dsVolume &gt; DSBVOLUME_MAX )
01864                 dsVolume = DSBVOLUME_MAX;
01865             <span class="keywordflow">if</span>( dsVolume &lt; DSBVOLUME_MIN )
01866                 dsVolume = DSBVOLUME_MIN;
01867             lp_loop_ch_dsb[i]-&gt;SetVolume(dsVolume);
01868         }
01869     }
01870 
01871     wav_volume = wavVolume;
01872 }
01873 
01874 <span class="comment">//--------------- End of Audio::set_wav_volume --------------//</span>
01875 
01876 <span class="comment">//-------------- Begin of Audio::set_cd_volume -------------//</span>
01877 <span class="comment">//</span>
01878 <span class="comment">// Set cd volume</span>
01879 <span class="comment">//</span>
01880 <span class="comment">// &lt;int&gt; cdVolume = cd volume, 0-100</span>
01881 <span class="comment">//</span>
<a name="l01882"></a><a class="code" href="classAudio.html#a36">01882</a> <span class="keywordtype">void</span> <a class="code" href="classAudio.html#a36">Audio::set_cd_volume</a>(<span class="keywordtype">int</span> cdVolume) {
01883     <span class="keywordflow">if</span>( !<a class="code" href="classAudio.html#m3">cd_init_flag</a> )
01884         <span class="keywordflow">return</span>;
01885 
01886     <span class="comment">//.. insert code here ...//</span>
01887 
01888 }
01889 
01890 <span class="comment">//--------------- End of Audio::set_cd_volume --------------//</span>
01891 
01892 <span class="comment">//-------------- Begin of function Audio::assign_serial ----------//</span>
01893 <span class="keywordtype">int</span> Audio::assign_serial(<span class="keywordtype">int</span> &amp;s) {
01894     <span class="keywordflow">if</span>( s == INT_MAX)
01895         <span class="keywordflow">return</span> s = 1;
01896     <span class="keywordflow">return</span> ++s;
01897 }
01898 
01899 <span class="comment">//-------------- End of function Audio::assign_serial ----------//</span>
01900 
01901 <span class="comment">// ------------ Begin of function Audio::volume_long_wav -------//</span>
<a name="l01902"></a><a class="code" href="classAudio.html#a16">01902</a> <span class="keywordtype">void</span> <a class="code" href="classAudio.html#a16">Audio::volume_long_wav</a>(<span class="keywordtype">int</span> serial, <a class="code" href="classDsVolume.html">DsVolume</a> dsVolume) {
01903     <span class="keywordflow">if</span>( <a class="code" href="classAudio.html#a15">is_long_wav_playing</a>(serial) ) {
01904         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> chanNum = 0; chanNum &lt; <a class="code" href="Oaudio_8h.html#a5">MAX_LONG_WAV_CH</a>; ++chanNum) {
01905             <span class="keywordflow">if</span>(lp_lwav_ch_dsb[chanNum] != <a class="code" href="OHELP_8H.html#a0">NULL</a> &amp;&amp; lwav_serial_no[chanNum] == serial ) {
01906                 lp_lwav_ch_dsb[chanNum]-&gt;SetVolume(dsVolume.<a class="code" href="classDsVolume.html#m0">ds_vol</a>);
01907                 <span class="comment">// lp_lwav_ch_dsb[chanNum]-&gt;SetPan(dsVolume.ds_pan);</span>
01908                 <span class="keywordflow">break</span>;
01909             }
01910         }
01911     }
01912 }
01913 
01914 <span class="comment">// ------------ End of function Audio::volume_long_wav -------//</span>
01915 
01916 <span class="comment">// ------------ Begin of function Audio::int_to_DsVolume -------//</span>
<a name="l01917"></a><a class="code" href="classAudio.html#a37">01917</a> <a class="code" href="classDsVolume.html">DsVolume</a> <a class="code" href="classAudio.html#a37">Audio::int_to_DsVolume</a>(<span class="keywordtype">int</span> sys_config_vol) {
01918     <span class="keywordflow">if</span>(sys_config_vol==0)
01919         <span class="keywordflow">return</span> <a class="code" href="classDsVolume.html">DsVolume</a>(<a class="code" href="classRelVolume.html">RelVolume</a>(0,0));
01920     <span class="keywordflow">return</span> <a class="code" href="classDsVolume.html">DsVolume</a>(<a class="code" href="classRelVolume.html">RelVolume</a>(<span class="keywordtype">long</span>(sys_config_vol*0.2+80),0));
01921 }
01922 
01923 <span class="comment">// ------------ End of function Audio::int_to_DsVolume -------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:14 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
