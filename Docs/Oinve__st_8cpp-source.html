<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Oinve_st.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Oinve_st.cpp</h1><a href="Oinve__st_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OStat.cpp</span>
00002 <span class="comment">//Description : Investment Class Definition</span>
00003 <span class="comment">//Owner       : Fred</span>
00004 
00005 <span class="comment">// ES library header file</span>
00006 <span class="preprocessor">#include &lt;OMATH.H&gt;</span>
00007 
00008 <span class="comment">// CU header file</span>
00009 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00010 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>
00011 <span class="preprocessor">#include &lt;OFINANCE.H&gt;</span>
00012 <span class="preprocessor">#include &lt;ODEVELOP.H&gt;</span>
00013 <span class="preprocessor">#include &lt;OCHANCE.H&gt;</span>
00014 
00015 <span class="preprocessor">#include "OINVEST.H"</span>
00016 
00017 <span class="comment">//----------- Define constants -------------//</span>
00018 <span class="comment">// no smoothing                   (=&gt;lam = 0)</span>
00019 <span class="comment">// 3-year smoothing               (=&gt;lam = 0.45)</span>
00020 <span class="comment">// 5-year smoothing               (=&gt;lam = 0.60)</span>
00021 
00022 <span class="comment">//## chea 241199 12.2.2 b)</span>
00023 <span class="comment">//static float endowment_lambda[INPUT_OPTION_COUNT] = { 0, 0.45f, 0.60f };</span>
00024 <span class="keyword">static</span> <span class="keywordtype">float</span> endowment_lambda[<a class="code" href="Gamedef_8h.html#a73a25">INPUT_OPTION_COUNT</a>] = { 0, 0.398f, 0.541f };
00025 
00026 <span class="keyword">static</span> <span class="keywordtype">float</span> tmp_max = 1;
00027 
00028 <span class="comment">//----------- Begin of function Investment::init_data --------//</span>
<a name="l00030"></a><a class="code" href="classInvestment.html#a9">00030</a> <span class="comment">void Investment::init_data() {</span>
00031     <span class="comment">// assume called: memset(this, 0, sizeof(Investment));</span>
00032 
00033     <span class="comment">//----------------------------//</span>
00034     <span class="comment">// data from excel sheet: response_func:investments</span>
00035 
00036     <span class="comment">//LC 50%    0.060   0.220</span>
00037     <span class="comment">//SC 20%    0.095   0.260</span>
00038     <span class="comment">//BD 30%    0.025   0.180</span>
00039 
00040   <span class="comment">/*</span>
00041 <span class="comment">    ASSET_TYPE_COUNT = 3,</span>
00042 <span class="comment"></span>
00043 <span class="comment">    AS_LC_STOCK=0,              // large-cap</span>
00044 <span class="comment">    AS_SC_STOCK,                // small-cap</span>
00045 <span class="comment">    AS_BONDS,</span>
00046 <span class="comment"></span>
00047 <span class="comment">    int allocation_percent;             // 33%</span>
00048 <span class="comment">    float       return_mean;</span>
00049 <span class="comment">    float       return_deviation;</span>
00050 <span class="comment">  */</span>
00051 
00052     asset_array[<a class="code" href="Oinvest_8h.html#a17a12">AS_LC_STOCK</a>].allocation_percent = 50;
00053     asset_array[<a class="code" href="Oinvest_8h.html#a17a13">AS_SC_STOCK</a>].allocation_percent = 20;
00054     asset_array[<a class="code" href="Oinvest_8h.html#a17a14">AS_BONDS</a>].allocation_percent = 30;
00055 
00056     asset_array[<a class="code" href="Oinvest_8h.html#a17a12">AS_LC_STOCK</a>].return_mean = 0.06f;
00057     asset_array[<a class="code" href="Oinvest_8h.html#a17a13">AS_SC_STOCK</a>].return_mean = 0.095f;
00058     asset_array[<a class="code" href="Oinvest_8h.html#a17a14">AS_BONDS</a>].return_mean = 0.025f;
00059 
00060     asset_array[<a class="code" href="Oinvest_8h.html#a17a12">AS_LC_STOCK</a>].return_deviation = 0.22f;
00061     asset_array[<a class="code" href="Oinvest_8h.html#a17a13">AS_SC_STOCK</a>].return_deviation = 0.26f;
00062     asset_array[<a class="code" href="Oinvest_8h.html#a17a14">AS_BONDS</a>].return_deviation = 0.18f;
00063 
00064     <span class="comment">//-----------------------------------------//</span>
00065 
00066     <span class="keywordtype">int</span> i, j;
00067 
00068     <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="Oinvest_8h.html#a17a11">ASSET_TYPE_COUNT</a>; i++)
00069         <span class="keywordflow">for</span> (j=0; j &lt; <a class="code" href="Oinvest_8h.html#a17a11">ASSET_TYPE_COUNT</a>; j++) {
00070             <span class="comment">// should use a matrix of multipliers!!??</span>
00071             <span class="keywordtype">float</span> multiplier;
00072 
00073             <span class="keywordflow">if</span> ( i == j)
00074                 multiplier = 1;
00075             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ( i == <a class="code" href="Oinvest_8h.html#a17a13">AS_SC_STOCK</a> &amp;&amp; j == <a class="code" href="Oinvest_8h.html#a17a12">AS_LC_STOCK</a> )  || ( j == <a class="code" href="Oinvest_8h.html#a17a13">AS_SC_STOCK</a> &amp;&amp; i == <a class="code" href="Oinvest_8h.html#a17a12">AS_LC_STOCK</a> ) )
00076                 multiplier = 0.9f;
00077             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ( i == <a class="code" href="Oinvest_8h.html#a17a13">AS_SC_STOCK</a> &amp;&amp; j == <a class="code" href="Oinvest_8h.html#a17a14">AS_BONDS</a> ) || ( j == <a class="code" href="Oinvest_8h.html#a17a13">AS_SC_STOCK</a> &amp;&amp; i == <a class="code" href="Oinvest_8h.html#a17a14">AS_BONDS</a> ) )
00078                 multiplier = 0.3f;
00079             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ( i == <a class="code" href="Oinvest_8h.html#a17a12">AS_LC_STOCK</a> &amp;&amp; j == <a class="code" href="Oinvest_8h.html#a17a14">AS_BONDS</a> ) || ( j == <a class="code" href="Oinvest_8h.html#a17a12">AS_LC_STOCK</a> &amp;&amp; i == <a class="code" href="Oinvest_8h.html#a17a14">AS_BONDS</a> ) )
00080                 multiplier = 0.4f;
00081 
00082             asset_covariance_array[i][j] = multiplier * asset_array[j].return_deviation * asset_array[i].return_deviation;
00083         }
00084 
00085     s_n_p_history[THIS_MONTH] = 100;
00086     endowment_performance_history[THIS_MONTH] = 100;
00087 
00088     <span class="comment">//s_n_p_history[THIS_MONTH] = 0;</span>
00089     <span class="comment">//endowment_performance_history[THIS_MONTH] = 0;</span>
00090 
00091     <span class="comment">//----------------------------//</span>
00092 
00093     degree_smoothing_for_endowment_payout = 0;
00094     <span class="comment">//  smoothed_endowment_value = finance.last_year.asset_array[AC_ENDOWMENT];  // inited in finance.init_data()</span>
00095 
00096   <span class="comment">//----------------------------//</span>
00097 
00098     endowment_ratio = float(100*development_office.last_year.endowment / finance.last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]);
00099 
00100     endowment_change_year_to_date = 0;              <span class="comment">// 990527</span>
00101 
00102   <span class="comment">//----------------------------//</span>
00103 
00104   <span class="comment">// expected_real_return.init(FA_HISTORY_YEAR, 0);</span>
00105 
00106     <span class="keywordtype">float</span> realReturn = 0;
00107 
00108     <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="Oinvest_8h.html#a17a11">ASSET_TYPE_COUNT</a>; i++)
00109         realReturn += asset_array[i].allocation_percent * ( asset_array[i].return_mean );
00110 
00111     expected_real_return.init(<a class="code" href="OHISTORY_8H.html#a1a0">FA_HISTORY_YEAR</a>, realReturn / 12.0f );
00112 
00113     update_history(UPDATE_MONTH);
00114 
00115                                                   <span class="comment">// min &amp; max bug chea</span>
00116     tmp_max = max(1.0f, max(s_n_p_history[THIS_MONTH], endowment_performance_history[THIS_MONTH]));
00117     s_n_p_history[THIS_MONTH] /= tmp_max;
00118     endowment_performance_history[THIS_MONTH] /= tmp_max;
00119 
00120     <span class="keywordtype">int</span> m = THIS_MONTH;
00121     s_n_p_history[m-1] = s_n_p_history[m-2] = s_n_p_history[THIS_MONTH];
00122     endowment_performance_history[m-1] = endowment_performance_history[m-2] = endowment_performance_history[THIS_MONTH];
00123 
00124   <span class="comment">//----------------------------//</span>
00125 
00126   <span class="comment">//update_history(UPDATE_YEAR);                // equilibrium_payout_rate calced here</span>
00127     calc_equilibrium_payout_rate();
00128 
00129     <span class="comment">//----------------------------//</span>
00130 
00131     <a class="code" href="ALL_8H.html#a0">err_when</a>(! finance.last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]);
00132 }
00133 
00134 <span class="comment">//------------- End of function Investment::init_data --------//</span>
00135 
00136 <span class="comment">//----------- Begin of function Investment::calc_endowment_growth ------//</span>
00141 <span class="comment">void Investment::calc_endowment_growth() {</span>
00142     <span class="keywordtype">int</span> i,j;
00143 
00144     <span class="comment">// nominal return // 33%</span>
00145     <span class="keywordtype">float</span> monthlyEndowmentGrowthRate = finance.inflation_rate_hist.get_cur();
00146     <span class="keywordtype">float</span> realReturn = 0;
00147 
00148     <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="Oinvest_8h.html#a17a11">ASSET_TYPE_COUNT</a>; i++)
00149         realReturn += asset_array[i].allocation_percent * ( asset_array[i].return_mean );
00150 
00151     monthlyEndowmentGrowthRate += realReturn / 12.0f / 100.0f;
00152 
00153     <span class="comment">//----------------------------//</span>
00154     expected_real_return.shift_hist();
00155     expected_real_return.set_cur(realReturn / 12.0f);
00156     expected_real_annual_return_rate = expected_real_return.get_sum();
00157 
00158     <span class="comment">//----------------------------//</span>
00159     endowment_growthrate_deviation = 0;             <span class="comment">// annual   // 0.99 -&gt; 99%</span>
00160     <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="Oinvest_8h.html#a17a11">ASSET_TYPE_COUNT</a>; i++)
00161         <span class="keywordflow">for</span> (j=0; j &lt; <a class="code" href="Oinvest_8h.html#a17a11">ASSET_TYPE_COUNT</a>; j++)
00162             endowment_growthrate_deviation += (asset_array[i].allocation_percent / 100.0f) * (asset_array[j].allocation_percent / 100.0f) * asset_covariance_array[i][j];
00163 
00164     endowment_growthrate_deviation = (float) sqrt(endowment_growthrate_deviation);
00165 
00166     <span class="comment">// check mean = 5.7%, sd = 18.6%</span>
00167 
00168     <span class="comment">/* //## old idea</span>
00169 <span class="comment">       float lamda = 0.5f;                              // value from email req25.txtf</span>
00170 <span class="comment">       float sd = 0.000084545f;         // for calc inflation_rate_hist in ofin_day.cpp</span>
00171 <span class="comment">       float endowmentGrowthrateDeviationMonthly = 0;   // 0.99 (99%)</span>
00172 <span class="comment">       endowmentGrowthrateDeviationMonthly = float( sqrt(endowment_growthrate_deviation - 12 * sd * sd / (1-lamda)) / sqrt(12) );</span>
00173 <span class="comment"></span>
00174 <span class="comment">       float chance = 0;</span>
00175 <span class="comment">       float endRand = math.get_random_snd(monthlyEndowmentGrowthRate/100.0f, endowmentGrowthrateDeviationMonthly*0.01f);</span>
00176 <span class="comment">       float oldEndowment = (float) finance.this_year.asset_array[AC_ENDOWMENT];</span>
00177 <span class="comment">       // 990525 finance.this_year.asset_array[AC_ENDOWMENT] = oldEndowment * ( 1 + endRand + chance );</span>
00178 <span class="comment">       endowment_change_year_to_date += oldEndowment * ( endRand + chance );</span>
00179 <span class="comment"></span>
00180 <span class="comment">       endowment_performance_history[THIS_MONTH] = float( (1+endRand) * endowment_performance_history[THIS_MONTH-1]);</span>
00181 <span class="comment"></span>
00182 <span class="comment">       // endowment_performance_history[THIS_MONTH] /= tmp_max;</span>
00183 <span class="comment">    */</span>
00184     <span class="comment">//## chea 231199 11.1.1</span>
00185     <span class="keywordtype">float</span> endowmentGrowthrateDeviationMonthly = 0;  <span class="comment">// 0.99 (99%)</span>
00186     endowmentGrowthrateDeviationMonthly = math.get_random_snd(monthlyEndowmentGrowthRate, endowment_growthrate_deviation/12);
00187 
00188     <span class="comment">//chose up or down //## chea 031299 Bill only want it to go up</span>
00189     <span class="keywordtype">int</span> dir = m.random(2) ? 1:0 ;
00190     <span class="keywordflow">if</span>(dir == 1)
00191         endowmentGrowthrateDeviationMonthly = -(endowmentGrowthrateDeviationMonthly);
00192 
00193     <span class="comment">// add chance card here</span>
00194 
00195     <span class="keywordtype">float</span> endRand = math.get_random_snd(monthlyEndowmentGrowthRate, endowmentGrowthrateDeviationMonthly);
00196 
00197     <span class="comment">//------ chance card handling ----------//</span>
00198 
00199     <span class="keywordflow">if</span>(chance_event.stock_dir == -1) {
00200         endRand = -float(100+m.random(400)) / 1000.f;
00201         chance_event.stock_dir = 0;
00202     }
00203     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(chance_event.stock_dir == 1) {
00204         endRand = float(100+m.random(400)) / 1000.f;
00205         chance_event.stock_dir = 0;
00206     }
00207 
00208     <span class="comment">//-------------------------------------//</span>
00209 
00210     <span class="keywordtype">float</span> oldEndowment = (float) finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>];
00211 
00212     endowment_change_year_to_date += oldEndowment * endRand;
00213     endowment_performance_history[THIS_MONTH] = float( (1+endRand) * endowment_performance_history[THIS_MONTH-1]);
00214 
00215     <span class="comment">/*</span>
00216 <span class="comment">      //------------------------------//</span>
00217 <span class="comment">      // calc S&amp;P 500</span>
00218 <span class="comment"></span>
00219 <span class="comment">      float sapRand = math.get_random_snd(</span>
00220 <span class="comment">      finance.inflation_rate_hist.get_cur() / 100.0f + asset_array[AS_LC_STOCK].return_mean - expected_real_return.get_cur() / 100.0f,</span>
00221 <span class="comment">      //990507 asset_array[AS_LC_STOCK].return_deviation - endowmentGrowthrateDeviationMonthly);</span>
00222 <span class="comment">      asset_array[AS_LC_STOCK].return_deviation / 12 - endowmentGrowthrateDeviationMonthly);</span>
00223 <span class="comment"></span>
00224 <span class="comment">      //        s_n_p_history[THIS_MONTH] = float(( 1.0 + endRand + sapRand ) * s_n_p_history[THIS_MONTH-1]);</span>
00225 <span class="comment">      // chwg0604</span>
00226 <span class="comment">      double ir=0.6*sapRand+0.4*asset_array[AS_BONDS].return_mean;</span>
00227 <span class="comment">      s_n_p_history[THIS_MONTH] = s_n_p_history[THIS_MONTH-1]*(float)(1.0f+(ir));</span>
00228 <span class="comment"></span>
00229 <span class="comment">      // s_n_p_history[THIS_MONTH] /= tmp_max;</span>
00230 <span class="comment">    */</span>
00231 }
00232 
00233 <span class="comment">//----------- End of function Investment::calc_endowment_growth ------//</span>
00234 
00235 <span class="comment">//----------- Begin of function Investment::update_history_sub ------//</span>
00238 <span class="comment">void Investment::update_history_sub() {</span>
00239 
00240     <span class="comment">/*</span>
00241 <span class="comment"></span>
00242 <span class="comment">      refer to email req25b.txt</span>
00243 <span class="comment"></span>
00244 <span class="comment">      &gt;---------</span>
00245 <span class="comment">      &gt;And, will there be any special projection method used for the</span>
00246 <span class="comment">      &gt;two outyear projections?  Or just apply the related-algorithm</span>
00247 <span class="comment">      &gt;immediately after the player makes changes on interface?</span>
00248 <span class="comment"></span>
00249 <span class="comment">      just apply the new payout rate, new smoothing-rule lambda-value, and</span>
00250 <span class="comment">      current expected annual endowment total return (based on the current</span>
00251 <span class="comment">      monthly endowment growthrate, which in turn depends on the asset</span>
00252 <span class="comment">      allocations from overview-1 and the monthly inflation rate) to the existing</span>
00253 <span class="comment">      formulas.</span>
00254 <span class="comment"></span>
00255 <span class="comment">      i now remember the other item i talked with trevor about, which may have</span>
00256 <span class="comment">      led tot he confusion about how may lines to include on the graph. what i'd</span>
00257 <span class="comment">      like to do is project three values for each of the two outyears (next and</span>
00258 <span class="comment">      second next), as follows:</span>
00259 <span class="comment"></span>
00260 <span class="comment">      based on expected total return plus one standard deviation (annual)</span>
00261 <span class="comment">      based on expected total return:</span>
00262 <span class="comment">      based on expected total return minus one standard deviation (annual)</span>
00263 <span class="comment"></span>
00264 <span class="comment">      the three lines will start at the same value (in the current year), then</span>
00265 <span class="comment">      diverge with the first one being at the top and the last one at the bottom.</span>
00266 <span class="comment">      note that the standard deviation depends on the current asset allocation.</span>
00267 <span class="comment"></span>
00268 <span class="comment">    */</span>
00269 
00270     <span class="comment">//------- P_THIS_YEAR ----------//  //##chea 191099------- should be P_LAST_YEAR ----------//</span>
00271 
00272     <span class="comment">//  endowment_spending_history[PROJECTED_VALUE][P_THIS_YEAR] = (int)finance.projected_revenue_array[AC_ENDOWMENT_SPENDING].this_year.total;</span>
00273     <span class="comment">//  endowment_spending_history[PROJECTED_MAX_VALUE][P_THIS_YEAR] = (int)finance.projected_revenue_array[AC_ENDOWMENT_SPENDING].this_year.total;</span>
00274     <span class="comment">//  endowment_spending_history[PROJECTED_MIN_VALUE][P_THIS_YEAR] = (int)finance.projected_revenue_array[AC_ENDOWMENT_SPENDING].this_year.total;</span>
00275 
00276     <span class="comment">//## chea 191099</span>
00277     <span class="comment">//  endowment_spending_history[PROJECTED_VALUE][P_THIS_YEAR] = (int)finance.revenue_array[AC_ENDOWMENT_SPENDING].total;</span>
00278     <span class="comment">//  endowment_spending_history[PROJECTED_MAX_VALUE][P_THIS_YEAR] = (int)(int)finance.revenue_array[AC_ENDOWMENT_SPENDING].total;</span>
00279     <span class="comment">//  endowment_spending_history[PROJECTED_MIN_VALUE][P_THIS_YEAR] = (int)(int)finance.revenue_array[AC_ENDOWMENT_SPENDING].total;</span>
00280     endowment_spending_history[<a class="code" href="Oinvest_8h.html#a16a8">PROJECTED_VALUE</a>][<a class="code" href="Oinvest_8h.html#a15a4">P_THIS_YEAR</a>] = (int)finance.projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].this_year.total;
00281     endowment_spending_history[<a class="code" href="Oinvest_8h.html#a16a10">PROJECTED_MAX_VALUE</a>][<a class="code" href="Oinvest_8h.html#a15a4">P_THIS_YEAR</a>] = (int)finance.projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].this_year.total;
00282     endowment_spending_history[<a class="code" href="Oinvest_8h.html#a16a9">PROJECTED_MIN_VALUE</a>][<a class="code" href="Oinvest_8h.html#a15a4">P_THIS_YEAR</a>] = (int)finance.projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].this_year.total;
00283 
00284     <span class="comment">//------- init data ----------//</span>
00285 
00286     <span class="keyword">const</span> <span class="keywordtype">float</span> annualReturnRate = expected_real_annual_return_rate;
00287     <span class="keyword">const</span> <span class="keywordtype">float</span> annualReturnDeviation = endowment_growthrate_deviation;
00288     <span class="keyword">const</span> <span class="keywordtype">float</span> payoutRate = float(finance.revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a67">PL_ENDOWMENT_SPENDING_RATE</a>].result_value) / 100;
00289 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00290 <span class="preprocessor"></span>    <span class="keywordtype">float</span> curEndowmentValue = (float) finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]+(float) finance.this_year.asset_array[AC_QUASI];
00291 <span class="preprocessor">#else</span>
00292 <span class="preprocessor"></span>    <span class="keywordtype">float</span> curEndowmentValue = (float) finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>];
00293 <span class="preprocessor">#endif</span>
00294 <span class="preprocessor"></span>
00295     <span class="comment">//------- P_NEXT_YEAR ----------//  //##chea 191099------- should be P_THIS_YEAR ----------//</span>
00296     <span class="keywordtype">float</span>   lam = endowment_lambda[degree_smoothing_for_endowment_payout];
00297 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00298 <span class="preprocessor"></span>    lam = 1.0f - lam;
00299 <span class="preprocessor">#endif</span>
00300 <span class="preprocessor"></span>    <a class="code" href="ALL_8H.html#a0">err_when</a>(degree_smoothing_for_endowment_payout&gt;<a class="code" href="Gamedef_8h.html#a73a24">INPUT_HIGH</a>);
00301 
00302     curEndowmentValue *= (1+annualReturnRate/100.0f);
00303     <span class="keywordtype">float</span> smoothedEndowmentValue = math.latency_func(lam, curEndowmentValue, smoothed_endowment_value);
00304 
00305     endowment_spending_history[<a class="code" href="Oinvest_8h.html#a16a8">PROJECTED_VALUE</a>][<a class="code" href="Oinvest_8h.html#a15a5">P_NEXT_YEAR</a>] = int( smoothedEndowmentValue * payoutRate);
00306     endowment_spending_history[<a class="code" href="Oinvest_8h.html#a16a10">PROJECTED_MAX_VALUE</a>][<a class="code" href="Oinvest_8h.html#a15a5">P_NEXT_YEAR</a>] = int( math.latency_func(lam, curEndowmentValue * (1+annualReturnDeviation), smoothed_endowment_value) * payoutRate );
00307     endowment_spending_history[<a class="code" href="Oinvest_8h.html#a16a9">PROJECTED_MIN_VALUE</a>][<a class="code" href="Oinvest_8h.html#a15a5">P_NEXT_YEAR</a>] = int( math.latency_func(lam, curEndowmentValue * (1-annualReturnDeviation), smoothed_endowment_value) * payoutRate );
00308 
00309     <span class="comment">//## chea 191099 to update endowment_spending</span>
00310     <span class="keywordtype">int</span> temp1 = int( smoothedEndowmentValue * payoutRate);
00311     <span class="keywordtype">int</span> temp2 = (int)finance.revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].total;
00312 
00313     <span class="comment">//## chea 241199 make the 3rd row the same 12.2.2 d)</span>
00314     <span class="comment">//  finance.projected_revenue_array[AC_ENDOWMENT_SPENDING].this_year.total = temp1;</span>
00315     <span class="comment">//  finance.projected_revenue_array[AC_ENDOWMENT_SPENDING].change_last_year.total = finance.calc_change(temp1 , temp2);</span>
00316 
00317     <span class="comment">//------- P_2ND_NEXT_YEAR ----------//  //##chea 191099------- should be P_NEXT_YEAR ----------//</span>
00318     curEndowmentValue *= (1+annualReturnRate/100.0f);
00319     smoothedEndowmentValue = math.latency_func(lam, curEndowmentValue, smoothed_endowment_value);
00320 
00321     endowment_spending_history[<a class="code" href="Oinvest_8h.html#a16a8">PROJECTED_VALUE</a>][<a class="code" href="Oinvest_8h.html#a15a6">P_2ND_NEXT_YEAR</a>] = int( smoothedEndowmentValue * payoutRate);
00322     endowment_spending_history[<a class="code" href="Oinvest_8h.html#a16a10">PROJECTED_MAX_VALUE</a>][<a class="code" href="Oinvest_8h.html#a15a6">P_2ND_NEXT_YEAR</a>] = int( math.latency_func(lam, curEndowmentValue * (1+annualReturnDeviation), smoothed_endowment_value) * payoutRate );
00323     endowment_spending_history[<a class="code" href="Oinvest_8h.html#a16a9">PROJECTED_MIN_VALUE</a>][<a class="code" href="Oinvest_8h.html#a15a6">P_2ND_NEXT_YEAR</a>] = int( math.latency_func(lam, curEndowmentValue * (1-annualReturnDeviation), smoothed_endowment_value) * payoutRate );
00324 
00325     <span class="comment">//## chea 191099 to update endowment_spending</span>
00326 
00327     <span class="keywordtype">int</span> temp3 = int( smoothedEndowmentValue * payoutRate);
00328     <span class="keywordtype">int</span> temp4 = (int)finance.projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].this_year.total;
00329     finance.projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].next_year.total = temp3;
00330     finance.projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].change_next_year.total = finance.calc_change(temp3 , temp4);
00331 
00332 }
00333 
00334 <span class="comment">//------------- End of function Investment::update_history_sub ------//</span>
00335 
00336 <span class="comment">//----------- Begin of function Investment::next_day ------//</span>
<a name="l00339"></a><a class="code" href="classInvestment.html#a10">00339</a> <span class="comment">void Investment::next_day() {</span>
00340     <span class="comment">// start of a month</span>
00341     <span class="keywordflow">if</span>(info.game_day == 29 &amp;&amp; info.game_month == 8) {
00342         <span class="keywordtype">int</span> asdfasdfasd=7;
00343     }
00344 
00345     <span class="keywordflow">if</span> ( info.game_day == 1 ) {
00346         <span class="comment">// start of a year</span>
00347         <span class="keywordflow">if</span> ( info.game_month == finance.fiscal_year_start_month )
00348             update_history(UPDATE_YEAR);
00349 
00350         update_history(UPDATE_MONTH);
00351     }
00352 
00353     <span class="comment">// start of a trimester</span>
00354     <span class="keywordflow">if</span> ( info.game_day == player_school.trimester_array[player_school.cur_trimester].start_day
00355          &amp;&amp; info.game_month == player_school.trimester_array[player_school.cur_trimester].start_month ) {
00356         update_history(UPDATE_TRIMESTER);
00357     }
00358 }
00359 
00360 <span class="comment">//------------- End of function Investment::next_day ------//</span>
00361 
00362 <span class="comment">//----------- Begin of function Athletics::update_history ------//</span>
00367 <span class="comment">void Investment::update_history(char updateFlag) {</span>
00368     <span class="comment">//  float input;</span>
00369     <span class="keywordtype">int</span> i;
00370 
00371     <span class="keywordflow">switch</span> (updateFlag) {
00372     <span class="keywordflow">case</span> UPDATE_MONTH:
00373         <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(s_n_p_history, HISTORY_MONTH_COUNT);
00374         <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(endowment_performance_history, HISTORY_MONTH_COUNT);
00375         calc_endowment_growth();
00376         update_history_sub();
00377         <span class="keywordflow">break</span>;
00378 
00379     <span class="keywordflow">case</span> UPDATE_TRIMESTER:
00380         <span class="keywordflow">break</span>;
00381 
00382     <span class="keywordflow">case</span> UPDATE_YEAR:
00383         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Oinvest_8h.html#a16a7">PROJECTION_TYPE_COUNT</a>; i++) {
00384             <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(endowment_spending_history[i], <a class="code" href="Oinvest_8h.html#a15a1">P_HISTORY_YEAR_COUNT</a>);
00385         }
00386 
00387         calc_equilibrium_payout_rate();
00388         endowment_change_year_to_date = 0;          <span class="comment">// 990527</span>
00389         <span class="keywordflow">break</span>;
00390 
00391     <span class="keywordflow">case</span> UPDATE_ALL:
00392         <span class="comment">//              update_history(UPDATE_MONTH);</span>
00393         <span class="comment">//              update_history(UPDATE_TRIMESTER);</span>
00394         <span class="comment">//              update_history(UPDATE_YEAR);</span>
00395         <span class="comment">//              break;</span>
00396 
00397     <span class="keywordflow">default</span>:
00398         <a class="code" href="ALL_8H.html#a1">err_here</a>();
00399         <span class="keywordflow">break</span>;
00400     }
00401 }
00402 
00403 <span class="comment">//------------- End of function Athletics::update_history ------//</span>
00404 
00405 <span class="comment">//----------- Begin of function Investment::deinit --------//</span>
00409 <span class="comment">void Investment::calc_equilibrium_payout_rate() {</span>
00410     <span class="keywordtype">float</span> road, r, i, g, E, B, I;                   <span class="comment">// 99%</span>
00411 
00412     <span class="comment">// assume called just after stage1 resource allocation, by opsch_pi.cpp for game score calculation</span>
00413 
00414     <span class="comment">// road: This is the "expected real annual return" described in Section 2.1 of the same document.</span>
00415 
00416     road = (float) expected_real_annual_return_rate;
00417     r = float(<a class="code" href="classFinance.html#d0">Finance::calc_change</a>(finance.projected_total_expense.this_year.total, finance.total_expense.total)
00418               - finance.inflation_rate);
00419 
00420     <span class="keywordtype">float</span> thisRev = float(finance.projected_total_revenue.this_year.total - finance.projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].this_year.total);
00421     <span class="keywordtype">float</span> lastRev = float(finance.total_revenue.total - finance.revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].total);
00422 
00423     i = float(<a class="code" href="classFinance.html#d0">Finance::calc_change</a>(thisRev, lastRev) - finance.inflation_rate);
00424     g = endowment_ratio = math.latency_func(0.6f, endowment_ratio,
00425                                             <span class="keywordtype">float</span>(100*development_office.this_year.endowment / finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]));
00426     E = float(finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]);
00427     B = float(finance.projected_total_expense.this_year.total);
00428     I = thisRev;
00429 
00430     <span class="comment">// solution of quadratic equation</span>
00431 
00432     <span class="comment">// min &amp; max bug chea</span>
00433     equilibrium_payout_rate = (float) sqrt(max(0.0f, math.safe_pow(road+g, 2) - 4 * (r*B-i*I) /E));
00434     <span class="comment">// min &amp; max bug chea</span>
00435     equilibrium_payout_rate = (float) min(100.0f, max(0.04f, 0.5f * (road+g + equilibrium_payout_rate)));
00436 
00437     <span class="comment">// return equilibrium_payout_rate;</span>
00438 }
00439 
00440 <span class="comment">//------------- End of function Investment::deinit --------//</span>
00441 
00442 <span class="comment">//----------- Begin of function Investment::calc_smoothed_endowment_value --------//</span>
<a name="l00446"></a><a class="code" href="classInvestment.html#a11">00446</a> <span class="comment">void Investment::calc_smoothed_endowment_value() {</span>
00447 
00448     <span class="comment">/*</span>
00449 <span class="comment">      Finally, having gotten into this area again, I'd like to suggest one more</span>
00450 <span class="comment">      change while you're working on the Overview 2 screen and related</span>
00451 <span class="comment">      procedures.</span>
00452 <span class="comment"></span>
00453 <span class="comment">      **First, I'd like to define a new variable:</span>
00454 <span class="comment"></span>
00455 <span class="comment">      smoothedEndowmentMV[t] =</span>
00456 <span class="comment">      (1-lam)endowmentMarketValue[t]+lam*smoothedEndowmentMV[t-1]</span>
00457 <span class="comment">      smoothedEndowmentMV[0] = endowmentMarketValue[0]</span>
00458 <span class="comment"></span>
00459 <span class="comment">      **The new variable should be used in place of "endowmentMarketValue[t]"</span>
00460 <span class="comment">      wherever it's multiplied by the payout rate: that would be in recourse</span>
00461 <span class="comment">      allocation Stage I and in the projections discussed above. The original</span>
00462 <span class="comment">      "endowmentMarketValue" should continue to be used in all financial</span>
00463 <span class="comment">      statements.</span>
00464 <span class="comment"></span>
00465 <span class="comment">      **The value of lambda should determined by Player input on the Overview 2</span>
00466 <span class="comment">      screen via the following (new) 3-way radio button:</span>
00467 <span class="comment"></span>
00468 <span class="comment">      float             lam = endowment_lambda[degree_smoothing_for_endowment_payout];</span>
00469 <span class="comment"></span>
00470 <span class="comment">      err_when(degree_smoothing_for_endowment_payout&gt;INPUT_HIGH);</span>
00471 <span class="comment"></span>
00472 <span class="comment">      smoothed_endowment_value = math.latency_func(lam,</span>
00473 <span class="comment">      float(finance.this_year.asset_array[AC_ENDOWMENT]), smoothed_endowment_value);</span>
00474 <span class="comment"></span>
00475 <span class="comment">    */</span>
00476 
00477     <span class="comment">//## 241199 new idea from Bill</span>
00478     <span class="comment">//b)</span>
00479     <span class="keywordtype">float</span>   lam = endowment_lambda[degree_smoothing_for_endowment_payout];
00480     <span class="comment">//a)</span>
00481 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00482 <span class="preprocessor"></span>    smoothed_endowment_value = (float)((1.0f-lam) * finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>] + lam * smoothed_endowment_value);
00483     smoothed_quasi_endowment_value = (float)((1.0f-lam) * finance.this_year.asset_array[AC_QUASI] + lam * smoothed_quasi_endowment_value);
00484 <span class="preprocessor">#else</span>
00485 <span class="preprocessor"></span>    smoothed_endowment_value = (float)(lam * finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>] + (1-lam) * smoothed_endowment_value);
00486 <span class="preprocessor">#endif</span>
00487 <span class="preprocessor"></span>    <span class="comment">//  smoothed_endowment_value = math.latency_func(lam,</span>
00488     <span class="comment">//          float(finance.this_year.asset_array[AC_ENDOWMENT]), smoothed_endowment_value);</span>
00489 
00490 }
00491 
00492 <span class="comment">//----------- End of function Investment::calc_smoothed_endowment_value --------//</span>
00493 
00494 <span class="comment">// ##### Begin MArco ##### //</span>
00495 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00496 <span class="preprocessor"></span><span class="comment">//----------- Begin of function Investment::save_initial_data --------//</span>
00497 <span class="keywordtype">void</span> Investment::save_initial_data() {
00498     <span class="comment">//  for (int i = 0; i &lt; ASSET_TYPE_COUNT; i++)</span>
00499     <span class="comment">//          initial_asset_array[i] = asset_array[i];</span>
00500     initial_asset_array0_allocation_percent = <a class="code" href="classInvestment.html#m1">asset_array</a>[0].<a class="code" href="structAssetItem.html#m0">allocation_percent</a>;
00501     initial_asset_array1_allocation_percent = <a class="code" href="classInvestment.html#m1">asset_array</a>[1].<a class="code" href="structAssetItem.html#m0">allocation_percent</a>;
00502     initial_asset_array2_allocation_percent = <a class="code" href="classInvestment.html#m1">asset_array</a>[2].<a class="code" href="structAssetItem.html#m0">allocation_percent</a>;
00503     initial_endowment_performance = <a class="code" href="classInvestment.html#m3">endowment_performance_history</a>[THIS_MONTH];
00504 }
00505 
00506 <span class="comment">//----------- End of function Investment::save_initial_data --------//</span>
00507 <span class="preprocessor">#endif</span>
00508 <span class="preprocessor"></span><span class="comment">// ##### End MArco ##### //</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:00 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
