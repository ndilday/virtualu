<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Opsch_gs.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Opsch_gs.cpp</h1><a href="Opsch__gs_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename   : ODEPT_GS.CPP</span>
00002 <span class="comment">//Description: functions for generating student records</span>
00003 <span class="comment">//owner:                        fred 0616</span>
00004 
00005 <span class="preprocessor">#include &lt;<a class="code" href="OBOX_8H.html">OBOX.H</a>&gt;</span>
00006 
00007 <span class="preprocessor">#include &lt;OMATH.H&gt;</span>
00008 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00009 <span class="preprocessor">#include &lt;OMISC.H&gt;</span>
00010 <span class="preprocessor">#include &lt;ODEPT.H&gt;</span>
00011 <span class="preprocessor">#include &lt;<a class="code" href="ODEPTRES_8H.html">ODEPTRES.H</a>&gt;</span>
00012 <span class="preprocessor">#include &lt;<a class="code" href="OSCHLRES_8H.html">OSCHLRES.H</a>&gt;</span>
00013 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="OPEERSCH_8H.html">OPEERSCH.H</a>&gt;</span>                             <span class="comment">//##### fred 0714 #####//</span>
00015 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00016 
00017 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>                                  <span class="comment">//for debug_msg</span>
00018 <span class="preprocessor">#include &lt;STDIO.H&gt;</span>
00019 
00020 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00021 <span class="preprocessor"></span>
00022 <span class="preprocessor">#define MAX_TRADITION_COUNT 5</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#define MAX_NONTRA_COUNT    5</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#define MAX_MASTER_COUNT    3</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#define MAX_DOCTOR_COUNT    3</span>
00026 <span class="preprocessor"></span>
00027 <span class="keyword">const</span> <a class="code" href="ogfile5_8cpp.html#a5">RECORD_SEPARATOR_LEN</a> = 2;
00028 <span class="keyword">static</span> <span class="keywordtype">char</span> *RECORD_SEPARATOR = <span class="stringliteral">"\r\n"</span>;
00029 <span class="keyword">const</span> <a class="code" href="ogfile5_8cpp.html#a7">FIELD_SEPARATOR_LEN</a> = 1;
00030 <span class="keyword">static</span> <span class="keywordtype">char</span> *FIELD_SEPARATOR = <span class="stringliteral">"\t"</span>;
00031 
00032 <span class="keyword">static</span> <span class="keywordtype">char</span> *export_num(<span class="keywordtype">int</span> value) {
00033     <span class="keyword">static</span> <span class="keywordtype">char</span> num_str[20];
00034     <span class="keywordflow">return</span> itoa( value, num_str, 10 );              <span class="comment">// 10 is radix</span>
00035 }
00036 
00037 <span class="keyword">static</span> <span class="keywordtype">char</span> *export_num(<span class="keywordtype">double</span> value) {
00038     <span class="keyword">static</span> <span class="keywordtype">char</span> num_str[20];
00039     <span class="keywordflow">return</span> gcvt( value, 7, num_str );               <span class="comment">// a few more more than 7, for negative sign, decimal point and exponent</span>
00040 }
00041 
00042 <span class="keyword">static</span> <span class="keywordtype">char</span> *export_percent(<span class="keywordtype">double</span> value) {       <span class="comment">// value already multiplied by 100</span>
00043     <span class="keyword">static</span> <span class="keywordtype">char</span> num_str[20];
00044     <span class="keywordflow">return</span> gcvt( value*0.01, 7, num_str );          <span class="comment">// a few more more than 7, for negative sign, decimal point and exponent</span>
00045 }
00046 
00047 <span class="preprocessor">#define WRITE_FIELD_SEPARATOR(f)      f-&gt;file_write(FIELD_SEPARATOR, FIELD_SEPARATOR_LEN)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#define WRITE_STR_FIELD(f,s)          { f-&gt;file_write(s, strlen(s)); }</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#define WRITE_NUM_FIELD(f,n)          { char *s=export_num(n); f-&gt;file_write(s, strlen(s)); }</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#define WRITE_PERCENT_FIELD(f,n)      { char *s=export_percent(n); f-&gt;file_write(s, strlen(s)); }</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#define WRITE_RECORD_SEPARATOR(f)     f-&gt;file_write(RECORD_SEPARATOR, RECORD_SEPARATOR_LEN)</span>
00052 <span class="preprocessor"></span>
00053 <span class="comment">//-------- Define struct  ---------//</span>
00054 <span class="keywordtype">short</span> NONTRA_COUNT = 0;
00055 <span class="keywordtype">short</span> MASTER_COUNT = 0;
00056 <span class="keywordtype">short</span> DOCTOR_COUNT = 0;
00057 <span class="preprocessor">#endif</span>
00058 <span class="preprocessor"></span>
<a name="l00061"></a><a class="code" href="structStudentStruct.html">00061</a> <span class="keyword">struct </span><a class="code" href="structStudentStruct.html">StudentStruct</a> {
<a name="l00062"></a><a class="code" href="structStudentStruct.html#m0">00062</a>     <span class="keywordtype">int</span> <a class="code" href="structStudentStruct.html#m0">stu_recno</a>;
<a name="l00063"></a><a class="code" href="structStudentStruct.html#m1">00063</a>     <span class="keywordtype">int</span> <a class="code" href="structStudentStruct.html#m1">dept_recno</a>;
<a name="l00064"></a><a class="code" href="structStudentStruct.html#m2">00064</a>     <span class="keywordtype">char</span>  <a class="code" href="structStudentStruct.html#m2">trimester_tag</a>;
00065 };
00066 
<a name="l00069"></a><a class="code" href="classStuDynArray.html">00069</a> <span class="keyword">class </span><a class="code" href="classStuDynArray.html">StuDynArray</a> : <span class="keyword">public</span> <a class="code" href="classDynArray.html">DynArray</a> {
00070 <span class="keyword">public</span>:
<a name="l00071"></a><a class="code" href="classStuDynArray.html#a0">00071</a>     <a class="code" href="classStuDynArray.html#a0">StuDynArray</a>() : <a class="code" href="classDynArray.html">DynArray</a>(sizeof(<a class="code" href="structStudentStruct.html">StudentStruct</a>), 200) {};
00072 
<a name="l00073"></a><a class="code" href="classStuDynArray.html#a1">00073</a>     <span class="keywordtype">void</span> <a class="code" href="classStuDynArray.html#a1">deinit</a>() {
00074         <span class="keywordflow">if</span>( <a class="code" href="classDynArray.html#a28">size</a>()==0 )
00075             <span class="keywordflow">return</span>;
00076 
00077         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=<a class="code" href="classDynArray.html#a28">size</a>() ; i&gt;0 ; i-- ) {
00078             <span class="comment">//if( !is_deleted(i) )</span>
00079             <a class="code" href="classDynArray.html#a6">linkout</a>(i);
00080         }
00081 
00082         <a class="code" href="classDynArray.html#a38">zap</a>();                                      <span class="comment">// zap the DynArrayB</span>
00083     };
00084 };
00085 
00086 <span class="comment">//------- Define static vars -----------//</span>
00087 
00088 <span class="keyword">static</span> <a class="code" href="classStuDynArray.html">StuDynArray</a>    stuArr[<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>];
00089 
00090 <span class="comment">//---------- Begin of function PlayerSchoolgenerate_student -----------//</span>
<a name="l00092"></a><a class="code" href="classPlayerSchool.html#a35">00092</a> <span class="comment">void PlayerSchool::generate_student() {</span>
00093     <span class="comment">// refer to techdoc3.3 section 4.1</span>
00094     generate_student_level_pct();
00095 
00096   <span class="comment">// refer to techdoc3.3 section 4.2 &amp; 4.3</span>
00097     generate_student_transition_prob_n_year_in_program();
00098 
00099     <span class="comment">// refer to techdoc3.3 section 4.4</span>
00100     generate_student_gender_ethnic();
00101 
00102     <span class="comment">// refer to techdoc3.3 section 4.5: talent indices</span>
00103     <span class="comment">// refer to techdoc3.3 section 4.6: financial aid</span>
00104     <span class="comment">// NOTE: see td3.4 section 2.7 for these two parts; see enrollment model</span>
00105 
00106   <span class="comment">// refer to techdoc3.3 section 4.7</span>
00107     generate_student_major_preference();
00108 
00109     <span class="comment">// refer to techdoc3.3 section 4.8: elective course preference</span>
00110     <span class="comment">// refer to techdoc3.3 section 4.9: courses taken</span>
00111 
00112     <span class="comment">// adjust the pct arrays for generate_student_random_get_group_index()</span>
00113     generate_student_adjust_pct_arrays();
00114 
00115     <span class="comment">// NOTE.1 980930</span>
00116     <span class="comment">// DL students will use the data in HE.GDB.init:Student_Parameters for non-traditional</span>
00117     <span class="comment">// undergraduates (SL-2).  The original data for SL-5, non-matriculated students, can</span>
00118     <span class="comment">// be abandoned.</span>
00119 
00120     <span class="comment">//</span>
00121     <span class="comment">//----- randomly get properties for generate student -----//</span>
00122     <span class="comment">//</span>
00123     <span class="keywordtype">char</span> studentLevel, yearInProgram, genderEthnicGroup, stuSeg, major;
00124     <span class="keywordtype">float</span> talentArr[<a class="code" href="Ostudent_8h.html#a39a25">TALENT_VAR_COUNT</a>];
00125     <span class="keywordtype">int</span> i, finAid = 0, progressIndex = 50;
00126 
00127     talentArr[0]=talentArr[1]=talentArr[2] = 0.5f;
00128 
00129   <span class="comment">//## chea 281099 you can lower the init student no. from below</span>
00130     <span class="keywordtype">int</span> stuCount = get_player_expected_student_count();
00131 
00132     <span class="comment">//DynArrayB         stuArr(sizeof(Student*), 2000,DEFAULT_REUSE_INTERVAL_DAYS);</span>
00133 
00134     <span class="keywordtype">int</span> sl_count=0;
00135 
00136 <span class="preprocessor">#ifdef DEBUG</span>
00137 <span class="preprocessor"></span>    <span class="keywordtype">int</span> year1Count[<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>];
00138     memset( year1Count, 0, <span class="keyword">sizeof</span>(year1Count) );
00139 <span class="preprocessor">#endif</span>
00140 <span class="preprocessor"></span>
00141     <span class="keywordflow">for</span>( i=stuCount; i&gt;0 ; i-- ) {
00142 
00143         <span class="comment">//----- find studentLevel -----//</span>
00144 
00145 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00146 <span class="preprocessor"></span>        studentLevel = generate_student_random_get_group_index
00147             (student_level_pct, <a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>-1);   <span class="comment">// omit Distance Learning</span>
00148 <span class="preprocessor">#else</span>
00149 <span class="preprocessor"></span>        studentLevel = generate_student_random_get_group_index
00150             (student_level_pct, <a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>);
00151 <span class="preprocessor">#endif</span>
00152 <span class="preprocessor"></span>
00153         <span class="keywordflow">if</span> ( studentLevel &lt;= <a class="code" href="Ostudent_8h.html#a32a5">MASTER</a> ) {
00154             yearInProgram = 1 + generate_student_random_get_group_index
00155                 (year_in_program_pct[studentLevel], <a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>+1);
00156         }
00157         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( studentLevel == <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a> ) {
00158             <span class="comment">// special case: doctor's major is assigned here</span>
00159             <span class="comment">//</span>
00160             <a class="code" href="ALL_8H.html#a0">err_when</a>(studentLevel-1 != <a class="code" href="Ostudent_8h.html#a36a17">SL_DOCTOR</a>);
00161             <span class="comment">// major is dept_recno to department_array</span>
00162             major = 1 + generate_student_random_get_group_index
00163                 (adjusted_student_major_pref[<a class="code" href="Ostudent_8h.html#a36a17">SL_DOCTOR</a>], department_array.department_count);
00164 
00165             yearInProgram = 1 + generate_student_random_get_group_index
00166                 (department_res[department_array[major]-&gt;department_id]-&gt;doctor_year_in_program_pct, <a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>+1);
00167         }
00168         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( studentLevel == <a class="code" href="Ostudent_8h.html#a32a7">DISTANCE_LEARN</a> ) {
00169             yearInProgram = 1 + generate_student_random_get_group_index
00170                 <span class="comment">// see note.1 above</span>
00171                 (year_in_program_pct[<a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>], <a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>+1);
00172         }
00173         <span class="keywordflow">else</span>
00174             <a class="code" href="ALL_8H.html#a1">err_here</a>();                                 <span class="comment">// unknown student level</span>
00175 
00176         <span class="keywordflow">if</span>(yearInProgram==1)
00177             sl_count++;
00178 
00179         <span class="comment">//----- find gender -----//</span>
00180 
00181         genderEthnicGroup = generate_student_random_get_group_index
00182             (student_gender_pct[studentLevel], <a class="code" href="Gamedef_8h.html#a74a26">GENDER_ETHNIC_TYPE_COUNT</a>);
00183 
00184         <span class="comment">//----- find major = deptRecno -----//</span>
00185 
00186         <span class="keywordflow">if</span> ( yearInProgram &gt; 1 ||
00187              ( !is_ug_group(studentLevel) )  ) {
00188             <span class="keywordflow">if</span> ( studentLevel != <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a> ) {             <span class="comment">// doctor's major is assigned above</span>
00189                 <span class="keywordtype">short</span> sl;
00190                 <span class="keywordflow">if</span> ( studentLevel == <a class="code" href="Ostudent_8h.html#a32a7">DISTANCE_LEARN</a> )     <span class="comment">// for sl5</span>
00191                     sl = <a class="code" href="Ostudent_8h.html#a36a15">SL_UG</a>;
00192                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( studentLevel &gt; <a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>  )  <span class="comment">// for sl2-3</span>
00193                     sl = studentLevel - 1;
00194                 <span class="keywordflow">else</span>
00195                     sl = <a class="code" href="Ostudent_8h.html#a36a15">SL_UG</a>;                             <span class="comment">// for sl1</span>
00196 
00197                 <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="Ostudent_8h.html#a32a5">MASTER</a> != <a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a> + 2);
00198 
00199                 <span class="comment">// major is dept_recno to department_array</span>
00200                 major = 1 + generate_student_random_get_group_index
00201                     <span class="comment">// sl: 0107: this should fix the DL student in agricultre dept</span>
00202                     (adjusted_student_major_pref[sl], department_array.department_count);
00203             }
00204         }
00205         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( yearInProgram == 1 ) {
00206             <span class="comment">// 1st year UG student don't have major</span>
00207             major = 0;                                  <span class="comment">// 0 -&gt; UNDECIDED;</span>
00208         }
00209         <span class="keywordflow">else</span>
00210             <a class="code" href="ALL_8H.html#a1">err_here</a>();
00211 
00212         <span class="comment">//----------- student segment ------------//</span>
00213 
00214         <span class="keywordflow">if</span> ( studentLevel == <a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a> ) {
00215             stuSeg = m.random(<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>);   <span class="comment">//BUGHERE //TO calc subSeg</span>
00216         }
00217         <span class="keywordflow">else</span> {
00218             stuSeg = -1;
00219         }
00220 
00221         <span class="comment">//----- add student -----//</span>
00222 
00223         <span class="comment">// add old students here and, will add new students (yr1 student) in enrollment</span>
00224 
00225         <span class="keywordflow">if</span> ( yearInProgram &gt; 1 ) {
00226             <span class="comment">// assign talent here // 990414</span>
00227 
00228             enroll_res.calc_a_talent(talentArr, studentLevel, genderEthnicGroup, stuSeg);
00229 
00230             <span class="keywordtype">int</span> stuRecno=0;
00231             <span class="keywordflow">if</span> ( major )
00232                 stuRecno = department_array[major]-&gt;student_array.add( studentLevel, yearInProgram,
00233                                                                        genderEthnicGroup, stuSeg, major, finAid, talentArr );
00234             <span class="keywordflow">else</span>
00235                 <a class="code" href="ALL_8H.html#a1">err_here</a>();
00236             <span class="comment">//department_res.general_dept.student_array.add( studentLevel, yearInProgram,</span>
00237             <span class="comment">//  genderEthnicGroup, stuSeg, major, finAid, talentArr );</span>
00238 
00239             <span class="comment">// 990413</span>
00240             <span class="comment">// init var for course taking init</span>
00241             <a class="code" href="classStudent.html">Student</a>* stuPtr = department_array[major]-&gt;student_array[stuRecno];
00242             <a class="code" href="structStudentStruct.html">StudentStruct</a> stuStruct;
00243 
00244             stuStruct.<a class="code" href="structStudentStruct.html#m0">stu_recno</a> = stuRecno;
00245             stuStruct.<a class="code" href="structStudentStruct.html#m1">dept_recno</a> = major;
00246             stuStruct.<a class="code" href="structStudentStruct.html#m2">trimester_tag</a> = -1;
00247 
00248             <span class="comment">// remember this sim</span>
00249             stuArr[studentLevel].<a class="code" href="classDynArray.html#a4">linkin</a>(&amp;stuStruct);
00250 
00251             <span class="comment">//StudentStruct* stuStrPtr = (StudentStruct *) stuArr.get();</span>
00252             <span class="comment">//err_when(stuPtr-&gt;student_level != studentLevel);</span>
00253             <span class="comment">//err_when(stuStrPtr-&gt;stu_ptr != stuPtr);</span>
00254             <span class="comment">//err_when(stuStrPtr-&gt;stu_ptr-&gt;student_level != studentLevel);</span>
00255         }
00256 <span class="preprocessor">#ifdef DEBUG</span>
00257 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
00258             ++year1Count[studentLevel];
00259         }
00260 <span class="preprocessor">#endif</span>
00261 <span class="preprocessor"></span>    }
00262 
00263 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00264 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( sys.debug_session ) {
00265         <span class="keywordflow">do</span> {
00266             <a class="code" href="classDepartment.html">Department</a>* deptPtr = department_array[m.random(10)+1];
00267 
00268             <span class="keywordtype">int</span> stdRecno = m.random(deptPtr-&gt;<a class="code" href="classGeneralDepartment.html#m0">student_array</a>.<a class="code" href="classDynArray.html#a28">size</a>())+1;
00269 
00270             <a class="code" href="classStudent.html">Student</a>* stdPtr = deptPtr-&gt;<a class="code" href="classGeneralDepartment.html#m0">student_array</a>[stdRecno];
00271 
00272             <span class="keywordflow">if</span> ( stdPtr-&gt;audit_flag )
00273                 <span class="keywordflow">continue</span>;
00274 
00275             <span class="keywordflow">switch</span> ( stdPtr-&gt;<a class="code" href="classStudent.html#m2">student_level</a> ) {
00276             <span class="keywordflow">case</span> <a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>:    <span class="keywordflow">continue</span>;
00277                 <span class="keywordflow">break</span>;
00278             <span class="keywordflow">case</span> <a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>: <span class="keywordflow">if</span> ( NONTRA_COUNT &gt;= MAX_NONTRA_COUNT )
00279                 <span class="keywordflow">continue</span>;
00280             NONTRA_COUNT++;
00281             <span class="keywordflow">break</span>;
00282             <span class="keywordflow">case</span> <a class="code" href="Ostudent_8h.html#a32a5">MASTER</a>:        <span class="keywordflow">if</span> ( MASTER_COUNT &gt;= MAX_MASTER_COUNT )
00283                 <span class="keywordflow">continue</span>;
00284             MASTER_COUNT++;
00285             <span class="keywordflow">break</span>;
00286             <span class="keywordflow">case</span> <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a>:        <span class="keywordflow">if</span> ( DOCTOR_COUNT &gt;= MAX_DOCTOR_COUNT )
00287                 <span class="keywordflow">continue</span>;
00288             DOCTOR_COUNT++;
00289             <span class="keywordflow">break</span>;
00290             }
00291 
00292             stdPtr-&gt;old_student_recno = stdRecno;
00293 
00294             stdPtr-&gt;audit_flag = 1;
00295 
00296             <a class="code" href="classFile.html">File</a> file;
00297 
00298             <span class="keywordtype">char</span> fileName[123];
00299 
00300             <span class="keywordflow">switch</span>( stdPtr-&gt;<a class="code" href="classStudent.html#m2">student_level</a> ) {
00301             <span class="keywordflow">case</span> <a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>: strcpy( fileName, <span class="stringliteral">"NONTRADITION"</span> );
00302                 <span class="keywordflow">break</span>;
00303             <span class="keywordflow">case</span> <a class="code" href="Ostudent_8h.html#a32a5">MASTER</a>:        strcpy( fileName, <span class="stringliteral">"MASTER"</span> );
00304                 <span class="keywordflow">break</span>;
00305             <span class="keywordflow">case</span> <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a>:        strcpy( fileName, <span class="stringliteral">"DOCTOR"</span> );
00306                 <span class="keywordflow">break</span>;
00307             }
00308 
00309             strcat( fileName, m.format(stdPtr-&gt;old_student_recno) );
00310             strcat( fileName, <span class="stringliteral">".txt"</span> );
00311 
00312             file.<a class="code" href="classFile.html#a3">file_create</a>(fileName);
00313 
00314             <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"Cohort"</span> );
00315             <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
00316             <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"Trimester"</span> );
00317             <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
00318             <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"ID"</span> );
00319             <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
00320             <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"Variable"</span> );
00321             <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
00322             <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"Trimester"</span> );
00323             <a class="code" href="ogfile5_8cpp.html#a4">WRITE_RECORD_SEPARATOR</a>( (&amp;file) );
00324 
00325             <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0; i&lt;4; i++ ) {
00326                 <a class="code" href="ogfile5_8cpp.html#a2">WRITE_NUM_FIELD</a>( (&amp;file), -1 );
00327                 <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
00328                 <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"A"</span> );
00329                 <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
00330                 <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
00331                 <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"S"</span> );
00332                 <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
00333 
00334                 <span class="keywordflow">switch</span> (i) {
00335                 <span class="keywordflow">case</span> 0: <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"Courses"</span> );
00336                     <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
00337                     <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
00338                     <a class="code" href="ogfile5_8cpp.html#a2">WRITE_NUM_FIELD</a>( (&amp;file), stdPtr-&gt;<a class="code" href="classStudent.html#m11">course_per_trimester</a>[0] );
00339                     <a class="code" href="ogfile5_8cpp.html#a2">WRITE_NUM_FIELD</a>( (&amp;file), stdPtr-&gt;<a class="code" href="classStudent.html#m11">course_per_trimester</a>[1] );
00340                     <a class="code" href="ogfile5_8cpp.html#a2">WRITE_NUM_FIELD</a>( (&amp;file), stdPtr-&gt;<a class="code" href="classStudent.html#m11">course_per_trimester</a>[2] );
00341                     <span class="keywordflow">break</span>;
00342 
00343                 <span class="keywordflow">case</span> 1: <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"Status"</span> );
00344                     <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
00345                     <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
00346                     <span class="keywordflow">if</span> ( stdPtr-&gt;<a class="code" href="classStudent.html#m1">department_recno</a> ) {
00347                         <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), department_res[department_array[stdPtr-&gt;<a class="code" href="classStudent.html#m1">department_recno</a>]-&gt;department_id]-&gt;name );
00348                     }
00349                     <span class="keywordflow">else</span>
00350                         <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"Undec"</span> );
00351                     <span class="keywordflow">break</span>;
00352 
00353                 <span class="keywordflow">case</span> 2: <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"AcadTalent"</span> );
00354                     <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
00355                     <a class="code" href="ogfile5_8cpp.html#a2">WRITE_NUM_FIELD</a>( (&amp;file), stdPtr-&gt;<a class="code" href="classStudent.html#m20">talent_academic</a> );
00356                     <span class="keywordflow">break</span>;
00357                 <span class="keywordflow">case</span> 3: <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"GenEnth"</span> );
00358                     <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
00359                     <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
00360                     <span class="keywordflow">switch</span>( stdPtr-&gt;<a class="code" href="classStudent.html#m3">gender_ethnic_group</a> ) {
00361                     <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a>:    <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"NM"</span> ); <span class="keywordflow">break</span>;
00362                     <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a>:  <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"NF"</span> ); <span class="keywordflow">break</span>;
00363                     <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a>:     <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"MM"</span> ); <span class="keywordflow">break</span>;
00364                     <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a>:   <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"MF"</span> ); <span class="keywordflow">break</span>;
00365                     }
00366                     <span class="keywordflow">break</span>;
00367                 }
00368                 <a class="code" href="ogfile5_8cpp.html#a4">WRITE_RECORD_SEPARATOR</a>( (&amp;file) );
00369             }
00370 
00371             file.<a class="code" href="classFile.html#a5">file_close</a>();
00372         } <span class="keywordflow">while</span> ((NONTRA_COUNT != MAX_NONTRA_COUNT ) || (MASTER_COUNT != MAX_MASTER_COUNT) || (DOCTOR_COUNT != MAX_DOCTOR_COUNT));
00373     }
00374 <span class="preprocessor">#endif</span>
00375 <span class="preprocessor"></span>
00376     <span class="comment">//--- initialize previous course selection data for newly generated students. ---//</span>
00377     generate_student_init_course(progressIndex);    <span class="comment">// 990412</span>
00378 
00379     <span class="keywordflow">for</span> (<span class="keywordtype">char</span> sl=0; sl&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; sl++)
00380         stuArr[sl].<a class="code" href="classStuDynArray.html#a1">deinit</a>();
00381 
00382 }
00383 
00384 <span class="comment">//---------- End of function PlayerSchool::generate_student -----------//</span>
00385 
00386 <span class="comment">//---------- Begin of function PlayerSchool::generate_student_level_pct -----------//</span>
00390 <span class="comment"></span>
<a name="l00391"></a><a class="code" href="classPlayerSchool.html#a0">00391</a> <span class="keywordtype">int</span> <a class="code" href="classPlayerSchool.html#a0">PlayerSchool::get_player_expected_student_count</a>() {
00392     <span class="keyword">const</span> <span class="keywordtype">int</span> remap[<a class="code" href="Gamedef_8h.html#a73a25">INPUT_OPTION_COUNT</a>] = {         <span class="comment">//refer to notes 990114</span>
00393         2000, 6000, 10000
00394     };
00395 
00396     <span class="comment">//## BUGHER for newif</span>
00397     <a class="code" href="ALL_8H.html#a0">err_when</a>(student_count &lt; 0 || student_count &gt;= <a class="code" href="Gamedef_8h.html#a73a25">INPUT_OPTION_COUNT</a>);
00398 
00399     <span class="keywordflow">return</span> remap[<a class="code" href="classPlayerSchool.html#m17">student_count</a>];
00400     <span class="comment">//## BUGHER for newif</span>
00401     <span class="keywordflow">return</span> <a class="code" href="classPlayerSchool.html#m17">student_count</a>;
00402 }
00403 
00404 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00405 <span class="preprocessor"></span><span class="keywordtype">int</span> PlayerSchool::get_player_expected_sponsored_research() {
00406     <span class="keywordflow">switch</span> (sponsored_research_intensity) {
00407     <span class="keywordflow">case</span> 0:   <span class="keywordflow">return</span> 1;
00408     <span class="keywordflow">case</span> 5:   <span class="keywordflow">return</span> 2;
00409     <span class="keywordflow">case</span> 10:    <span class="keywordflow">return</span> 4;
00410     <span class="keywordflow">default</span>:
00411         <a class="code" href="ALL_8H.html#a1">err_here</a>();
00412         <span class="keywordflow">return</span> 1;
00413     }
00414 }
00415 <span class="preprocessor">#endif</span>
00416 <span class="preprocessor"></span>
00417 <span class="keywordtype">void</span> PlayerSchool::generate_student_level_pct() {
00418     <a class="code" href="classPeerSchool.html">PeerSchool</a> *playerEx = school_res.player_peer_school;
00419     <span class="keywordtype">int</span> studentCount=0, i;
00420 
00421     <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a> != 0 || <a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a> != 1);
00422 
00423     <span class="keywordtype">float</span> sl2Multiplier[3] = { 1.5f, 1.0f, 0.5f };
00424     <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="Opschool_8h.html#a62a17">URBAN</a> != 0);
00425 
00426     <span class="keywordtype">int</span> realStuCount = <a class="code" href="classPlayerSchool.html#a0">get_player_expected_student_count</a>();
00427 
00428     <a class="code" href="classPlayerSchool.html#m69">student_level_pct</a>[<a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>]   = playerEx-&gt;<a class="code" href="classSchoolEx.html#m51">full_time_undergrad</a>;
00429     <span class="comment">// 1009 + campus location</span>
00430     <a class="code" href="classPlayerSchool.html#m69">student_level_pct</a>[<a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>]  = playerEx-&gt;<a class="code" href="classSchoolEx.html#m52">part_time_undergrad</a> * sl2Multiplier[player_school.campus_environment] * player_school.parttime_undergrad_percent / 100;
00431     <span class="comment">// player_input</span>
00432     <a class="code" href="classPlayerSchool.html#m69">student_level_pct</a>[<a class="code" href="Ostudent_8h.html#a32a7">DISTANCE_LEARN</a>] = (float) ( realStuCount * <a class="code" href="classPlayerSchool.html#m18">sl5_student_percent</a> / 100);
00433 
00434     <span class="keywordtype">int</span> gradStudCount = realStuCount * <a class="code" href="classPlayerSchool.html#m23">graduate_student_percent</a> / 100;
00435 
00436     <a class="code" href="classPlayerSchool.html#m69">student_level_pct</a>[<a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a>] = gradStudCount * player_school.doctoral_program_intensity / 100;
00437     <a class="code" href="classPlayerSchool.html#m69">student_level_pct</a>[<a class="code" href="Ostudent_8h.html#a32a5">MASTER</a>] = gradStudCount - <a class="code" href="classPlayerSchool.html#m69">student_level_pct</a>[<a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a>];
00438 
00439     <span class="comment">//-----------------------------------------------//</span>
00440 
00441     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; i++)
00442         studentCount += (int) <a class="code" href="classPlayerSchool.html#m69">student_level_pct</a>[i];
00443 
00444     <span class="comment">//-----------------------------------------------//</span>
00445 
00446     <span class="keywordtype">float</span> scaleFactor = float(realStuCount) / studentCount;
00447 
00448     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; i++) {
00449         <a class="code" href="classPlayerSchool.html#m69">student_level_pct</a>[i]
00450             = (<a class="code" href="classPlayerSchool.html#m69">student_level_pct</a>[i] * scaleFactor) / realStuCount;
00451     }
00452 }
00453 
00454 <span class="comment">//---------- End of function PlayerSchool::generate_student_level_pct -----------//</span>
00455 
00456 <span class="comment">//---------- Begin of function PlayerSchool::generate_student_transition_probabilities -----------//</span>
00466 <span class="comment">void PlayerSchool::generate_student_transition_prob_n_year_in_program() {</span>
00467     <a class="code" href="classPeerSchool.html">PeerSchool</a> *playerEx = school_res.player_peer_school;
00468     <span class="keywordtype">int</span> yr, sl, i;
00469 
00470     <span class="comment">//----- transition probabilities for UG_TRADITION &amp; UG_NONTRADITION &amp; MASTER-----//</span>
00471     <span class="comment">// refer to techdoc3.3 section 4.2</span>
00472     <span class="comment">//temporarily place the following procedures in this function</span>
00473 
00474     <span class="comment">// read these two arrays from dbase</span>
00475     <span class="keyword">const</span> <span class="keywordtype">float</span> dropouts_fraction[<a class="code" href="Ostudent_8h.html#a35a14">MASTER_ARRAY_SIZE</a>][<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>] = {
00476         { 0.29f, 0.19f, 0.26f,  0.16f, 0.07f, 0.02f, 0.01f, 0.00f },
00477         { 0.25f, 0.20f, 0.15f, 0.10f, 0.08f, 0.08f, 0.07f, 0.07f  },
00478         { 0.70f, 0.30f, 0.00f, 0.00f, 0.00f, 0.00f, 0.00f, 0.00f  }
00479 
00480     };
00481 
00482     <span class="keyword">const</span> <span class="keywordtype">float</span> graduates_fraction[<a class="code" href="Ostudent_8h.html#a35a14">MASTER_ARRAY_SIZE</a>][<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>] = {
00483         { 0.00f,  0.00f,  0.06f,  0.53f,  0.31f,  0.08f,  0.02f,  0.00f },
00484         { 0.00f,  0.00f,  0.00f,  0.00f,  0.00f,  0.10f,  0.30f,  0.50f },
00485         { 0.95f,  0.05f,  0.00f,  0.00f,  0.00f,  0.00f,  0.00f,  0.00f }
00486     };
00487 
00488     <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>!=0);
00489     <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="Ostudent_8h.html#a32a5">MASTER</a>!=2);
00490 
00491     <span class="comment">// step 1</span>
00492     <span class="comment">//</span>
00493     <span class="keywordtype">float</span> fractionWhoGradOnTime[<a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>+1];
00494     <span class="keywordtype">float</span> gradAnytimePct[<a class="code" href="Ostudent_8h.html#a35a14">MASTER_ARRAY_SIZE</a>];
00495 
00496     memset(fractionWhoGradOnTime, 0, <span class="keyword">sizeof</span>(fractionWhoGradOnTime));
00497 
00498     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>; i++)
00499         fractionWhoGradOnTime[<a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>] += graduates_fraction[<a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>][i];
00500 
00501     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>; i++)
00502         fractionWhoGradOnTime[<a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>] += graduates_fraction[<a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>][i];
00503 
00504     <span class="keywordflow">for</span> (sl= 0; sl&lt;=<a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>; sl++) {
00505         gradAnytimePct[sl]
00506             = playerEx-&gt;<a class="code" href="classSchool.html#m113">target_grad_rate_sl</a>[sl] / 100.0f
00507             + ( 1-playerEx-&gt;<a class="code" href="classSchool.html#m113">target_grad_rate_sl</a>[sl] / 100.0f )
00508             * ( 1-fractionWhoGradOnTime[sl] );
00509     }
00510     <span class="comment">// special case for MASTER</span>
00511     gradAnytimePct[<a class="code" href="Ostudent_8h.html#a32a5">MASTER</a>] = playerEx-&gt;<a class="code" href="classSchool.html#m113">target_grad_rate_sl</a>[<a class="code" href="Ostudent_8h.html#a32a5">MASTER</a>] / 100.0f;
00512 
00513     <span class="comment">// step 2</span>
00514     <span class="comment">//</span>
00515     <span class="keywordtype">float</span> fractionSurvivors[<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>+1], popDivisor[<a class="code" href="Ostudent_8h.html#a35a14">MASTER_ARRAY_SIZE</a>];
00516     <span class="keywordtype">float</span> gradTransProb[<a class="code" href="Ostudent_8h.html#a35a14">MASTER_ARRAY_SIZE</a>][<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>];
00517 
00518     <span class="keywordflow">for</span> (sl=0; sl&lt;<a class="code" href="Ostudent_8h.html#a35a14">MASTER_ARRAY_SIZE</a>; sl++) {
00519         <span class="keywordflow">for</span> (yr=0; yr&lt;<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>; yr++) {
00520             <span class="keywordflow">if</span> ( yr &gt; 0 ) {
00521                 fractionSurvivors[yr]  = fractionSurvivors[yr-1] * (1.0f - gradTransProb[sl][yr-1]    - dropout_trans_prob[sl][yr-1]);
00522                 popDivisor[sl] += fractionSurvivors[yr];
00523             }
00524             <span class="keywordflow">else</span> {
00525                 fractionSurvivors[yr] = 1.0f;
00526                 popDivisor[sl] = fractionSurvivors[yr];
00527             }
00528 
00529 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00530 <span class="preprocessor"></span>            <span class="comment">// BUG FIX if divided by zero</span>
00531             dropout_trans_prob[sl][yr] = math.safe_divide( dropouts_fraction[sl][yr] * ( 1.0f - gradAnytimePct[sl] ), fractionSurvivors[yr] );
00532 
00533             gradTransProb[sl][yr] = math.safe_divide( graduates_fraction[sl][yr] * gradAnytimePct[sl], fractionSurvivors[yr] );
00534 <span class="preprocessor">#else</span>
00535 <span class="preprocessor"></span>            dropout_trans_prob[sl][yr] = dropouts_fraction[sl][yr] * ( 1.0f - gradAnytimePct[sl] ) / fractionSurvivors[yr];
00536 
00537             gradTransProb[sl][yr] = graduates_fraction[sl][yr] * gradAnytimePct[sl] / fractionSurvivors[yr];
00538 <span class="preprocessor">#endif</span>
00539 <span class="preprocessor"></span>        }
00540 
00541         <span class="comment">//----- calc year_in_program_pct -----//</span>
00542         fractionSurvivors[yr]  = fractionSurvivors[yr-1] * (1.0f - gradTransProb[sl][yr-1] - dropout_trans_prob[sl][yr-1]);
00543         popDivisor[sl] += fractionSurvivors[yr];
00544 
00545         <span class="keywordflow">for</span> (yr=0; yr&lt;<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>+1; yr++) {
00546 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00547 <span class="preprocessor"></span>            year_in_program_pct[sl][yr] = math.safe_divide( fractionSurvivors[yr], popDivisor[sl] );
00548 <span class="preprocessor">#else</span>
00549 <span class="preprocessor"></span>            year_in_program_pct[sl][yr] = fractionSurvivors[yr] / popDivisor[sl];
00550 <span class="preprocessor">#endif</span>
00551 <span class="preprocessor"></span>            <span class="comment">//## chea 120200 just checking</span>
00552             <span class="keywordflow">if</span>(year_in_program_pct[sl][yr]&lt;=0)
00553                 year_in_program_pct[sl][yr]=0;
00554         }
00555     }
00556 
00557     memcpy(grad_trans_prob, gradTransProb, <span class="keyword">sizeof</span>(gradTransProb));
00558 
00559     <span class="comment">//----- transition probabilities for DOCTOR -----//</span>
00560     <span class="comment">// calculated for each department;</span>
00561     <span class="comment">// see DepartmentInfo::generate_student_transition_prob_n_year_in_program_doctor()</span>
00562     <span class="keywordtype">short</span> deptCount = department_res.department_count;
00563     <span class="keywordflow">for</span>( i=1 ; i&lt;=deptCount ; i++ ) {
00564         <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a> *deptInfo = department_res[i];
00565         deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#a0">generate_student_transition_prob_n_year_in_program_doctor</a>();
00566     }
00567 
00568     <span class="comment">//----- transition probabilities for SL-5 are not necessary -----//</span>
00569 }
00570 
00571 <span class="comment">//---------- End of function PlayerSchool::generate_student_transition_probabilities -----------//</span>
00572 
00573 <span class="comment">//-------- Begin of function PlayerSchool::generate_student_transition_probabilities -------//</span>
<a name="l00577"></a><a class="code" href="structDepartmentInfo.html#a0">00577</a> <span class="comment">void DepartmentInfo::generate_student_transition_prob_n_year_in_program_doctor() {</span>
00578     <span class="comment">//----- transition probabilities for DOCTOR -----//</span>
00579     <span class="comment">// refer to techdo3.3, section 4.2, p.12-p.13</span>
00580     <span class="comment">//</span>
00581     <span class="keywordtype">short</span> sl = <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a>;
00582     <span class="keywordtype">short</span> yr;
00583 
00584     <a class="code" href="classPeerSchool.html">PeerSchool</a> *playerEx = school_res.player_peer_school;
00585     <span class="keywordtype">float</span> targetSchoolGradRate = playerEx-&gt;<a class="code" href="classSchool.html#m113">target_grad_rate_sl</a>[sl] / 100.0f;
00586     <span class="keywordtype">float</span> avgTimeToDegree = playerEx-&gt;<a class="code" href="classSchool.html#m129">doc_time_to_degree</a>;
00587 
00588     <span class="comment">//temp vars for debug</span>
00589     <span class="comment">//targetSchoolGradRate = 0.465f;</span>
00590     <span class="comment">//avgTimeToDegree = 4.21f;</span>
00591 
00592     <span class="keywordtype">float</span> avgTimeToDropout = 0.5f * avgTimeToDegree;<span class="comment">// B102</span>
00593 
00594     <span class="comment">// step1: F106:H106 of student_par spreadsheet</span>
00595     <span class="comment">//</span>
00596 <span class="preprocessor">#define MAX_GRADUATE_RATE 0.8f</span>
00597 <span class="preprocessor"></span>
00598     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a>* deptInfo = <span class="keyword">this</span>;                <span class="comment">// department_res[department_id];</span>
00599 
00600     <span class="keywordtype">float</span> cummGradRate = targetSchoolGradRate * deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m8">doctoral_grad_rate_multiplier</a>;
00601     <span class="keywordflow">if</span> ( cummGradRate &gt; MAX_GRADUATE_RATE )
00602         cummGradRate = MAX_GRADUATE_RATE;
00603 
00604     <span class="keywordtype">float</span> aveTimeToDropout  = avgTimeToDropout * deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m9">doctoral_time_to_dropout_multiplier</a>;
00605     <span class="keywordtype">float</span> aveTimeToDegree = avgTimeToDegree * deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m10">doctoral_time_to_degree_multiplier</a>;
00606 
00607     <span class="comment">// step2: I106:P106</span>
00608 
00609     <span class="keywordtype">float</span> graduateFraction, dropoutFraction;
00610     <span class="keywordtype">float</span> fractionSurvivors[<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>], popDivisor;
00611 
00612     <span class="keywordflow">for</span> (yr=0; yr&lt;<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>; yr++) {
00613         <span class="keywordflow">if</span> ( yr &gt; 0 ) {
00614             fractionSurvivors[yr]  = fractionSurvivors[yr-1] * (1.0f - doctor_dropout_trans_prob[yr-1] - doctor_graduate_trans_prob[yr-1]);
00615             popDivisor += fractionSurvivors[yr];
00616         }
00617         <span class="keywordflow">else</span> {
00618             fractionSurvivors[yr] = 1.0f;
00619             popDivisor = fractionSurvivors[yr];
00620         }
00621 
00622         <span class="comment">//askbillok: 1-yr or yr-1:</span>
00623         yr++;                                         <span class="comment">// see equation (3) in p.13 techdoc 3.3</span>
00624         dropoutFraction
00625             = float( exp((1-yr)/aveTimeToDropout) - exp(-yr/aveTimeToDropout));
00626         graduateFraction
00627             = float( exp((3-yr)/(aveTimeToDegree-2)) - exp((2-yr)/(aveTimeToDegree-2)));
00628         yr--;
00629 
00630         <span class="comment">//----- calc trans_prob -----//</span>
00631 
00632         doctor_dropout_trans_prob[yr] = dropoutFraction*(1-cummGradRate)/fractionSurvivors[yr];
00633 
00634         <span class="keywordflow">if</span> ( yr==0 || yr==1 )
00635             doctor_graduate_trans_prob[yr]  = 0.0f;
00636         <span class="keywordflow">else</span>
00637             doctor_graduate_trans_prob[yr]  = graduateFraction*cummGradRate/fractionSurvivors[yr];
00638     }
00639 
00640     fractionSurvivors[yr]  = fractionSurvivors[yr-1] * (1.0f - doctor_dropout_trans_prob[yr-1] - doctor_graduate_trans_prob[yr-1]);
00641     popDivisor += fractionSurvivors[yr];
00642 
00643     <span class="keywordflow">for</span> (yr=0; yr&lt;<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>+1; yr++) {     <span class="comment">//askbillok: take the easiest approaach; why yr=0to8 (why+1)</span>
00644         doctor_year_in_program_pct[yr] = fractionSurvivors[yr] / popDivisor;
00645     }
00646 }
00647 
00648 <span class="comment">//---------- End of function PlayerSchool::generate_faculty_calc_vars -----------//</span>
00649 
00650 <span class="comment">//-------- Begin of function PlayerSchool::generate_student_gender_ethnic -------//</span>
00654 <span class="comment">void PlayerSchool::generate_student_gender_ethnic() {</span>
00655     <span class="comment">//----- initial percent for each gender-ethic group ----//</span>
00656 
00657     <a class="code" href="classPeerSchool.html">PeerSchool</a> *playerEx = school_res.player_peer_school;
00658 
00659     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> sl=0; sl&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; sl++ ) {
00660         <span class="comment">//----- get female and minority percentages from player_school_ex -----//</span>
00661 
00662         <span class="keywordtype">float</span> femalePercent = playerEx-&gt;<a class="code" href="classSchoolEx.html#m56">percent_female_sl</a>[sl] / 100.0f;
00663         <span class="keywordtype">float</span> minorityPercent = playerEx-&gt;<a class="code" href="classSchoolEx.html#m57">percent_minority_sl</a>[sl] / 100.0f;
00664 
00665         <span class="comment">//--------- special case: scenario ---------//</span>
00666 
00667         <span class="keywordflow">if</span> ( info.year_passed == 1 &amp;&amp; player_school.scenario_id == <a class="code" href="Opschool_8h.html#a63a29">SCN_STUDENT_DIVERSITY</a> ) {
00668             minorityPercent *= 0.571f;
00669         }
00670 
00671         <span class="comment">// calc what we want</span>
00672 
00673         student_gender_pct[sl][<a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a>] = femalePercent*minorityPercent;
00674         student_gender_pct[sl][<a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a>] = femalePercent*(1.0f - minorityPercent);
00675         student_gender_pct[sl][<a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a>] = (1.0f - femalePercent)*minorityPercent;
00676         student_gender_pct[sl][<a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a>] = (1.0f - femalePercent)*(1.0f - minorityPercent);
00677     }
00678 }
00679 
00680 <span class="comment">//---------- End of function PlayerSchool::generate_student_gender_ethnic -----------//</span>
00681 
00682 <span class="comment">//-------- Begin of function PlayerSchool::generate_student_major_preference -------//</span>
00686 <span class="comment">void PlayerSchool::generate_student_major_preference() {</span>
00687     <span class="keywordtype">short</span> i, sl, deptCount, deptId;
00688     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a> *deptInfo;
00689 
00690     deptCount = department_res.department_count;
00691     <span class="keywordflow">for</span>( i=1 ; i&lt;=deptCount ; i++ ) {
00692         deptInfo = department_res[i];
00693         deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#a1">generate_student_major_preference</a>();
00694     }
00695 
00696     <span class="comment">//----- adjust the preferecne percentages for the included dept -----//</span>
00697     <span class="comment">//</span>
00698     <span class="comment">// please note that if a department is not included in department_array,</span>
00699     <span class="comment">// it won't have an entry in adjusted_student_major_pref</span>
00700     <span class="comment">//</span>
00701 
00702     deptCount = department_array.department_count;
00703     <span class="keywordtype">float</span> totalPctIncludedDept = 0.0f;
00704 
00705     <a class="code" href="ALL_8H.html#a0">err_when</a>(!deptCount);
00706     memset(adjusted_student_major_pref, 0, <span class="keyword">sizeof</span>(adjusted_student_major_pref));
00707 
00708     <span class="keywordflow">for</span> (sl=0; sl&lt;<a class="code" href="Ostudent_8h.html#a1">MAX_STUDENT_LEVEL_INI</a>; sl++) {
00709         totalPctIncludedDept = 0.0f;
00710 
00711         <span class="keywordflow">for</span> (i=1; i&lt;=deptCount; i++) {
00712             deptId = department_array[i]-&gt;<a class="code" href="classGeneralDepartment.html#m2">department_id</a>;
00713             deptInfo = department_res[deptId];
00714             totalPctIncludedDept += deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m30">student_major_pref</a>[sl];
00715         }
00716 
00717         <span class="keywordflow">for</span> (i=1; i&lt;=deptCount; i++) {
00718             deptId = department_array[i]-&gt;<a class="code" href="classGeneralDepartment.html#m2">department_id</a>;
00719             deptInfo = department_res[deptId];
00720 
00721             adjusted_student_major_pref[sl][i-1] = math.safe_divide(deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m30">student_major_pref</a>[sl], totalPctIncludedDept);
00722             <span class="comment">// another alternative:</span>
00723             <span class="comment">// adjusted_student_major_pref[sl][deptId] /= totalPctIncludedDept;</span>
00724         }
00725 
00726         <span class="comment">// 0304 change upon Jesse's latest email</span>
00727         <span class="keywordtype">float</span> minPct = 1.0f / deptCount;
00728         totalPctIncludedDept = 0;
00729 
00730         <span class="keywordflow">for</span> (i=1; i&lt;=deptCount; i++) {
00731             <span class="comment">// if pref &lt; 0.1 (10%)</span>
00732             <span class="keywordflow">if</span> ( adjusted_student_major_pref[sl][i-1] &lt; minPct )
00733                 <span class="comment">// + 1% pref to this dept</span>
00734                 adjusted_student_major_pref[sl][i-1] += 0.03f;
00735 
00736             totalPctIncludedDept += adjusted_student_major_pref[sl][i-1];
00737         }
00738 
00739         <span class="keywordflow">for</span> (i=1; i&lt;=deptCount; i++)
00740             adjusted_student_major_pref[sl][i-1] /= totalPctIncludedDept;
00741 
00742         <span class="comment">// end 0304</span>
00743     }
00744 }
00745 
00746 <span class="comment">//---------- End of function PlayerSchool::generate_student_major_preference -----------//</span>
00747 
00748 <span class="comment">//-------- Begin of function DepartmentInfo::generate_student_major_preference -------//</span>
<a name="l00752"></a><a class="code" href="structDepartmentInfo.html#a1">00752</a> <span class="comment">void DepartmentInfo::generate_student_major_preference() {</span>
00753     <span class="keywordtype">short</span> sl;
00754     <a class="code" href="classPeerSchool.html">PeerSchool</a> *playerEx = school_res.player_peer_school;
00755 
00756     <span class="keywordflow">for</span> (sl=0; sl&lt;<a class="code" href="Ostudent_8h.html#a1">MAX_STUDENT_LEVEL_INI</a>; sl++) {
00757         <span class="comment">// refer to spreadsheet: student_par: E24 = C24*D24:</span>
00758         <span class="comment">// Preference for major = IPEDS %UG degrees * Fraction of field pct</span>
00759 
00760         student_major_pref[sl]
00761             = playerEx-&gt;<a class="code" href="classSchoolEx.html#m63">student_ifield_pct</a>[sl][iped_field]
00762             * field_fraction_pct[sl];
00763     }
00764 
00765     <span class="comment">//TO debug the values of student_major_pref?</span>
00766 }
00767 
00768 <span class="comment">//---------- Begin of function DeptInfo::generate_student_ajdust_arrays -----------//</span>
00769 
00770 <span class="comment">//---------- Begin of function PlayerSchool::generate_student_ajdust_arrays -----------//</span>
00773 <span class="comment">void PlayerSchool::generate_student_adjust_pct_arrays() {</span>
00774     <span class="keywordtype">int</span> sl, i;
00775 
00776     generate_student_adjust_pct_array
00777         (student_level_pct, <a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>);
00778 
00779     <span class="keywordflow">for</span> (sl=0; sl&lt;<a class="code" href="Ostudent_8h.html#a35a14">MASTER_ARRAY_SIZE</a>; sl++) {
00780         generate_student_adjust_pct_array
00781             (year_in_program_pct[sl], <a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>+1);
00782     }
00783 
00784     <span class="keywordtype">short</span> deptCount = department_res.department_count;
00785     <span class="keywordflow">for</span>( i=1 ; i&lt;=deptCount ; i++ ) {
00786         generate_student_adjust_pct_array
00787             (department_res[i]-&gt;doctor_year_in_program_pct, <a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>+1);
00788     }
00789 
00790     <span class="keywordflow">for</span> (sl=0; sl&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; sl++) {
00791         generate_student_adjust_pct_array
00792             (student_gender_pct[sl], <a class="code" href="Gamedef_8h.html#a74a26">GENDER_ETHNIC_TYPE_COUNT</a>);
00793     }
00794 
00795     <span class="keywordflow">for</span> (sl=0; sl&lt;<a class="code" href="Ostudent_8h.html#a1">MAX_STUDENT_LEVEL_INI</a>; sl++) {
00796         generate_student_adjust_pct_array
00797             (adjusted_student_major_pref[sl], department_array.department_count);
00798     }
00799 }
00800 
<a name="l00801"></a><a class="code" href="classPlayerSchool.html#a37">00801</a> <span class="keywordtype">void</span> <a class="code" href="classPlayerSchool.html#a37">PlayerSchool::generate_student_adjust_pct_array</a>(<span class="keywordtype">float</span> *arr, <span class="keywordtype">int</span> size) {
00802     <span class="keywordtype">int</span> i;
00803     <span class="keywordflow">for</span> (i=1; i&lt;size; i++)
00804         arr[i] += arr[i-1];
00805 
00806     <span class="keywordflow">if</span> ( arr[size-1] &gt; 0.95)
00807         arr[size-1] = 1.0f;
00808     <span class="keywordflow">else</span> {
00809         <span class="keywordflow">if</span> (arr[0] != 0 )                             <span class="comment">//1120 bug from special game_setting</span>
00810             <a class="code" href="ALL_8H.html#a1">err_here</a>();                                 <span class="comment">// debug_msg("PlayerSchool::generate_student_adjust_pct_array: Array Data Incorrect");</span>
00811     }
00812 }
00813 
<a name="l00814"></a><a class="code" href="classPlayerSchool.html#a38">00814</a> <span class="keywordtype">void</span> <a class="code" href="classPlayerSchool.html#a38">PlayerSchool::generate_student_readjust_pct_array</a>(<span class="keywordtype">float</span> *arr, <span class="keywordtype">int</span> size) {
00815     <span class="keywordtype">int</span> i;
00816     <span class="keywordflow">for</span> (i=size-1; i&gt;0; i--)
00817         arr[i] -= arr[i-1];
00818 
00819     <a class="code" href="ALL_8H.html#a0">err_when</a>(arr[0]&lt;0);
00820 }
00821 
00822 <span class="comment">//---------- End of function PlayerSchool::generate_student_adjust_arrays -----------//</span>
00823 
00824 <span class="comment">//---------- End of function PlayerSchool::generate_student_random_get_group_index -----------//</span>
00825 <span class="comment">//</span>
00826 <span class="comment">// &lt;size&gt; = number of group</span>
00827 <span class="comment">// return the group index</span>
00828 <span class="comment">//</span>
<a name="l00829"></a><a class="code" href="classPlayerSchool.html#a8">00829</a> <span class="keywordtype">char</span> <a class="code" href="classPlayerSchool.html#a8">PlayerSchool::generate_student_random_get_group_index</a>(<span class="keywordtype">float</span> *arr, <span class="keywordtype">int</span> size) {
00830     <span class="keyword">const</span> <span class="keywordtype">int</span> randomPrecesion = 10000;
00831     <span class="keywordtype">float</span> rand = float(m.random(randomPrecesion+1)) / randomPrecesion;
00832 
00833     <a class="code" href="ALL_8H.html#a0">err_when</a>(size &gt;127);                            <span class="comment">// since return type is char</span>
00834 
00835     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0; i&lt;size; i++ ) {
00836         <span class="keywordflow">if</span> ( rand &lt;= arr[i] )
00837             <span class="keywordflow">return</span> (char) i;
00838     }
00839     <span class="keywordflow">return</span> 0;
00840 }
00841 
00842 <span class="comment">//---------- End of function PlayerSchool::generate_student_random_get_group_index -----------//</span>
00843 
00844 <span class="comment">//---------- End of function PlayerSchool::get_random_major -----------//</span>
00845 <span class="comment">//</span>
00846 <span class="comment">// &lt;sl&gt; = student level</span>
00847 <span class="comment">// return the dept_recno index</span>
00848 <span class="comment">//</span>
<a name="l00849"></a><a class="code" href="classPlayerSchool.html#a7">00849</a> <span class="keywordtype">int</span> <a class="code" href="classPlayerSchool.html#a7">PlayerSchool::get_random_major</a>(<span class="keywordtype">char</span> sl) {
00850     <span class="keywordflow">if</span> ( sl == <a class="code" href="Ostudent_8h.html#a32a7">DISTANCE_LEARN</a>)                      <span class="comment">// 0107</span>
00851         sl = <a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>;
00852     <span class="keywordflow">if</span> ( sl &gt;= <a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a> )
00853         sl--;
00854 
00855     <a class="code" href="ALL_8H.html#a0">err_when</a>(sl&lt;0 || sl&gt;= <a class="code" href="Ostudent_8h.html#a1">MAX_STUDENT_LEVEL_INI</a>);
00856 
00857     <span class="keywordtype">int</span> returnValue = 1 + <a class="code" href="classPlayerSchool.html#a8">generate_student_random_get_group_index</a>( <a class="code" href="classPlayerSchool.html#m73">adjusted_student_major_pref</a>[sl], department_array.department_count );
00858 
00859 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00860 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( returnValue &gt; department_array.size() )
00861         returnValue = department_array.size();
00862 <span class="preprocessor">#endif</span>
00863 <span class="preprocessor"></span>
00864     <span class="keywordflow">return</span> returnValue;                             <span class="comment">// major is dept_recno to department_array</span>
00865 
00866 }
00867 
00868 <span class="comment">//---------- End of function PlayerSchool::get_random_major -----------//</span>
00869 
00870 <span class="comment">//### begin trevor 1908 ##//</span>
00871 
00872 <span class="comment">//---------- End of function PlayerSchool::generate_student_init_course -----------//</span>
00873 <span class="comment">//</span>
00874 <span class="comment">// Initialize previous course selection data for newly generated students.</span>
00875 <span class="comment">//</span>
00876 <span class="comment">/*</span>
00877 <span class="comment">void PlayerSchool::generate_student_init_course(int progressIndex)</span>
00878 <span class="comment">{</span>
00879 <span class="comment">  //err_here();         // 990413</span>
00880 <span class="comment"></span>
00881 <span class="comment">  for( int processYearInProgram=4 ; processYearInProgram&gt;=2 ; processYearInProgram-- )          // only process students whose year in program equal to this</span>
00882 <span class="comment">  {</span>
00883 <span class="comment">    for( int deptRecno=department_array.size() ; deptRecno&gt;0 ; deptRecno-- )</span>
00884 <span class="comment">    {</span>
00885 <span class="comment">      if ( deptRecno==3 || deptRecno==6 || deptRecno==9 )</span>
00886 <span class="comment"></span>
00887 <span class="comment">if( department_array.is_deleted(deptRecno) )</span>
00888 <span class="comment">continue;</span>
00889 <span class="comment"></span>
00890 <span class="comment">department_array[deptRecno]-&gt;student_array.init_course(processYearInProgram);</span>
00891 <span class="comment">}</span>
00892 <span class="comment">}</span>
00893 <span class="comment">}</span>
00894 <span class="comment">//---------- End of function PlayerSchool::generate_student_init_course -----------//</span>
00895 <span class="comment">*/</span>
00896 <span class="comment">//### end trevor 1908 ##//</span>
00897 
00898 <span class="comment">//--------------------------------------------------------------------------//</span>
00899 <span class="comment">//--------------------------------------------------------------------------//</span>
00900 <span class="comment">//--------------------------------------------------------------------------//</span>
00901 
00902 <span class="keyword">static</span> <span class="keywordtype">char</span> cur_student_level_for_sorting = 0;
00903 
00904 <span class="comment">//------ Begin of function sort_stu_talent_function ------//</span>
00908 <span class="comment">static int sort_stu_talent_function( const void *a, const void *b ) {</span>
00909     <span class="comment">// 1st sort key: trimester_tag</span>
00910     <span class="comment">// 2nd sort key: talent</span>
00911 
00912     <a class="code" href="structStudentStruct.html">StudentStruct</a>* stuStrPtrA, *stuStrPtrB;
00913     <a class="code" href="classStudent.html">Student</a>* stuPtrA, *stuPtrB;
00914 
00915     stuStrPtrA = (<a class="code" href="structStudentStruct.html">StudentStruct</a> *) stuArr[cur_student_level_for_sorting].get(*((<span class="keywordtype">short</span>*)a));
00916     stuStrPtrB = (<a class="code" href="structStudentStruct.html">StudentStruct</a> *) stuArr[cur_student_level_for_sorting].get(*((<span class="keywordtype">short</span>*)b));
00917 
00918     <span class="keywordtype">float</span> rc = float(stuStrPtrA-&gt;<a class="code" href="structStudentStruct.html#m2">trimester_tag</a> - stuStrPtrB-&gt;<a class="code" href="structStudentStruct.html#m2">trimester_tag</a>);
00919 
00920     <span class="keywordflow">if</span>( rc &gt; 0 )
00921         <span class="keywordflow">return</span> 1;
00922     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( rc &lt; 0 )
00923         <span class="keywordflow">return</span> -1;
00924 
00925     stuPtrA = department_array[stuStrPtrA-&gt;<a class="code" href="structStudentStruct.html#m1">dept_recno</a>]-&gt;student_array[stuStrPtrA-&gt;<a class="code" href="structStudentStruct.html#m0">stu_recno</a>];
00926     stuPtrB = department_array[stuStrPtrB-&gt;<a class="code" href="structStudentStruct.html#m1">dept_recno</a>]-&gt;student_array[stuStrPtrB-&gt;<a class="code" href="structStudentStruct.html#m0">stu_recno</a>];
00927 
00928     <span class="keywordtype">float</span> valueA = stuPtrA-&gt;<a class="code" href="classStudent.html#m20">talent_academic</a>;
00929     <span class="keywordtype">float</span> valueB = stuPtrB-&gt;<a class="code" href="classStudent.html#m20">talent_academic</a>;
00930 
00931     rc = valueA - valueB;
00932 
00933     <span class="keywordflow">if</span>( rc &gt; 0 )
00934         <span class="keywordflow">return</span> 1;
00935     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( rc &lt; 0 )
00936         <span class="keywordflow">return</span> -1;
00937     <span class="keywordflow">else</span>
00938         <span class="keywordflow">return</span> 0;
00939 }
00940 
00941 <span class="comment">//------- End of function sort_stu_talent_function ------//</span>
00942 
00943 <span class="comment">//---------- Begin of function PlayerSchool::generate_student_init_course -----------//</span>
00948 <span class="comment">/*</span>
00949   <span class="keywordflow">for</span> SL-1,2,4,5
00950   {
00951        set tag = 0
00952 
00953        <span class="keywordflow">for</span> eachTriGroup (note: i.e. there're (8-2 = 6) TriGroups <span class="keywordflow">for</span> SL-1)
00954        {
00955           generate sims <span class="keywordflow">for</span> <span class="keyword">this</span> triGroup
00956           assign the current tag to these sims
00957           <span class="keywordflow">for</span> each sim generated <span class="keywordflow">for</span> <span class="keyword">this</span> triGroup AND sims created SO FAR
00958           {
00959 run A-2
00960 }
00961 increment tag!!!
00962 }
00963 
00964 run B <span class="keywordflow">for</span> SL-1,2,3,4,5
00965 }
00966 
00967 */
00968 
00969 <span class="keywordtype">void</span> PlayerSchool::generate_student_init_course(<span class="keywordtype">int</span> progressIndex) {
00970     <span class="keywordtype">int</span> try_to_count = 0;
00971     <span class="keyword">const</span> <span class="keywordtype">char</span> norm_ft_trimesters[<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>] = { 8,8,2,4,8 };
00972     <span class="comment">//## chea 281099</span>
00973     <span class="keyword">const</span> <span class="keywordtype">char</span> no_of_time_sel_cour[<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>] = {
00974         2,2,1,1,2
00975     };
00976 
00977     <span class="keywordtype">int</span> i;
00978 
00979     <a class="code" href="structStudentStruct.html">StudentStruct</a>* stuStrPtr;
00980     <a class="code" href="classStudent.html">Student</a>* stuPtr;
00981 
00982     <span class="comment">//---- get the maximum # of students in all student levels ----//</span>
00983 
00984     <span class="keywordtype">int</span> stuCount = 0;
00985 
00986     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a> ; i++ ) {
00987         <span class="keywordflow">if</span>( stuArr[i].<a class="code" href="classDynArray.html#a28">size</a>() &gt; stuCount )
00988             stuCount = stuArr[i].<a class="code" href="classDynArray.html#a28">size</a>();
00989     }
00990 
00991     <a class="code" href="ALL_8H.html#a0">err_when</a>( stuCount &lt;= 0 );
00992     <a class="code" href="ALL_8H.html#a0">err_when</a>( stuCount &gt; 10000000 );
00993 
00994     <span class="comment">//---- allocate the array ---------//</span>
00995 
00996     <span class="keywordtype">short</span>* stuSortArray = (<span class="keywordtype">short</span>*) <a class="code" href="ALL_8H.html#a5">mem_add</a>( stuCount * <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>) );
00997 
00998     <span class="keywordflow">for</span> ( <span class="keywordtype">char</span> sl=0; sl&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; sl++ ) {
00999         <span class="comment">/*</span>
01000 <span class="comment">          int tag = 1;</span>
01001 <span class="comment">          int stuCountThisLevel = stuArr[sl].size();</span>
01002 <span class="comment">          int stuCountPerTrimester = stuCountThisLevel / norm_ft_trimesters[sl];</span>
01003 <span class="comment"></span>
01004 <span class="comment">          // ------ Part A ------</span>
01005 <span class="comment"></span>
01006 <span class="comment">          for ( int t=0; t&lt;norm_ft_trimesters[sl]-2; t++ )  //## chea 281099 for testing</span>
01007 <span class="comment">          {</span>
01008 <span class="comment">          for ( i=1; i&lt;=stuCountPerTrimester*(1+t); i++ )</span>
01009 <span class="comment">          {</span>
01010 <span class="comment">          stuStrPtr = (StudentStruct *) stuArr[sl].get(i);</span>
01011 <span class="comment">          stuPtr = department_array[stuStrPtr-&gt;dept_recno]-&gt;student_array[stuStrPtr-&gt;stu_recno];</span>
01012 <span class="comment"></span>
01013 <span class="comment">          if ( i &gt; stuCountPerTrimester * t )                   // shoudn't be "&gt;="</span>
01014 <span class="comment">          stuStrPtr-&gt;trimester_tag = tag;</span>
01015 <span class="comment"></span>
01016 <span class="comment">          err_when(stuPtr-&gt;student_level != sl);                //BUGHERE</span>
01017 <span class="comment">          stuPtr-&gt;select_course(1);             // 1: ignoreFaculty</span>
01018 <span class="comment">          }</span>
01019 <span class="comment"></span>
01020 <span class="comment">          tag++;</span>
01021 <span class="comment">          }</span>
01022 <span class="comment">        */</span>
01023 
01024         <span class="comment">//## chea 281099 new idea since the old alg. ignor year_in_program</span>
01025         <span class="keywordtype">int</span> tag = 1;
01026         <span class="keywordtype">int</span> time_in_school;
01027         <span class="keywordtype">int</span> stuCountThisLevel = stuArr[sl].<a class="code" href="classDynArray.html#a28">size</a>();
01028 
01029         <span class="keywordtype">int</span> stuCountPerTrimester = stuCountThisLevel / norm_ft_trimesters[sl];
01030 
01031 <span class="preprocessor">#ifdef DEBUG</span>
01032 <span class="preprocessor"></span>        <span class="keywordtype">int</span> studentYearCount[<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>+1];
01033         memset( studentYearCount, 0, <span class="keyword">sizeof</span>(studentYearCount) );
01034         <span class="keywordtype">int</span> studentCredit[32+1];
01035         memset( studentCredit, 0, <span class="keyword">sizeof</span>(studentCredit) );
01036 <span class="preprocessor">#endif</span>
01037 <span class="preprocessor"></span>
01038         <span class="keywordflow">for</span> ( i=1; i&lt;=stuCountThisLevel; i++ ) {
01039 
01040             stuStrPtr = (<a class="code" href="structStudentStruct.html">StudentStruct</a> *) stuArr[sl].<a class="code" href="classDynArray.html#a13">get</a>(i);
01041             stuPtr = department_array[stuStrPtr-&gt;<a class="code" href="structStudentStruct.html#m1">dept_recno</a>]-&gt;student_array[stuStrPtr-&gt;<a class="code" href="structStudentStruct.html#m0">stu_recno</a>];
01042 
01043             <a class="code" href="ALL_8H.html#a0">err_when</a>(stuPtr-&gt;<a class="code" href="classStudent.html#m6">year_in_program</a> == 1);
01044             time_in_school = stuPtr-&gt;<a class="code" href="classStudent.html#m6">year_in_program</a>-1;
01045 
01046 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01047 <span class="preprocessor"></span>            <span class="comment">//                  if(sl==UG_TRADITION &amp;&amp; time_in_school&gt;BACHELOR_YEAR_COUNT+1)   //Gilbert : too many graduate at the end of pre-run year</span>
01048             <span class="comment">//                          time_in_school=BACHELOR_YEAR_COUNT-1;</span>
01049 <span class="preprocessor">#else</span>
01050 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(sl==<a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a> &amp;&amp; time_in_school&gt;5)    <span class="comment">//## chea 281099 try not to handle student study ug. over 5 years.</span>
01051                 time_in_school=3;
01052 <span class="preprocessor">#endif</span>
01053 <span class="preprocessor"></span>
01054 <span class="preprocessor">#ifdef DEBUG</span>
01055 <span class="preprocessor"></span>            <span class="keywordflow">if</span>( time_in_school &gt; <a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a> )
01056                 studentYearCount[<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>]++;
01057             <span class="keywordflow">else</span> <span class="keywordflow">if</span>( time_in_school &gt;= 0 )
01058                 studentYearCount[time_in_school]++;
01059 <span class="preprocessor">#endif</span>
01060 <span class="preprocessor"></span>
01061             <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> t=0; t&lt;no_of_time_sel_cour[sl]*time_in_school; t++ ) {
01062 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01063 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( stuPtr-&gt;audit_flag ) {
01064                     <a class="code" href="classFile.html">File</a> file;
01065 
01066                     <span class="keywordtype">char</span> fileName[123];
01067 
01068                     <span class="keywordflow">switch</span>( stuPtr-&gt;<a class="code" href="classStudent.html#m2">student_level</a> ) {
01069                     <span class="keywordflow">case</span> <a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>:    strcpy( fileName, <span class="stringliteral">"TRADITION"</span> );
01070                         <span class="keywordflow">break</span>;
01071                     <span class="keywordflow">case</span> <a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>: strcpy( fileName, <span class="stringliteral">"NONTRADITION"</span> );
01072                         <span class="keywordflow">break</span>;
01073                     <span class="keywordflow">case</span> <a class="code" href="Ostudent_8h.html#a32a5">MASTER</a>:        strcpy( fileName, <span class="stringliteral">"MASTER"</span> );
01074                         <span class="keywordflow">break</span>;
01075                     <span class="keywordflow">case</span> <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a>:        strcpy( fileName, <span class="stringliteral">"DOCTOR"</span> );
01076                         <span class="keywordflow">break</span>;
01077                     }
01078 
01079                     strcat( fileName, m.format(stuPtr-&gt;old_student_recno) );
01080                     strcat( fileName, <span class="stringliteral">".txt"</span> );
01081 
01082                     file.<a class="code" href="classFile.html#a4">file_append</a>( fileName );
01083                     file.<a class="code" href="classFile.html#a7">file_seek</a>(0, FILE_END);
01084 
01085                     <span class="keywordtype">char</span> textDisplay[128];
01086                     sprintf( textDisplay, <span class="stringliteral">"****** This is the No.%d trimester in the history ******"</span>, t );
01087                     <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), textDisplay );
01088 
01089                     <a class="code" href="ogfile5_8cpp.html#a4">WRITE_RECORD_SEPARATOR</a>( (&amp;file) );
01090 
01091                     file.<a class="code" href="classFile.html#a5">file_close</a>();
01092                 }
01093 <span class="preprocessor">#endif</span>
01094 <span class="preprocessor"></span>
01095 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01096 <span class="preprocessor"></span>                stuPtr-&gt;<a class="code" href="classStudent.html#a7">select_course</a>(1, 1);              <span class="comment">// 1: ignoreFaculty, 1: ignore course student count, denial count</span>
01097 <span class="preprocessor">#else</span>
01098 <span class="preprocessor"></span>                stuPtr-&gt;<a class="code" href="classStudent.html#a7">select_course</a>(1);                 <span class="comment">// 1: ignoreFaculty</span>
01099 <span class="preprocessor">#endif</span>
01100 <span class="preprocessor"></span>            }
01101 
01102             <span class="comment">//          if ( i &gt; stuCountPerTrimester * t )                     // shoudn't be "&gt;="</span>
01103             <span class="comment">//                          stuStrPtr-&gt;trimester_tag = tag;</span>
01104 
01105 <span class="preprocessor">#ifdef DEBUG</span>
01106 <span class="preprocessor"></span>            <span class="keywordflow">if</span>( stuPtr-&gt;<a class="code" href="classStudent.html#m12">total_course_all</a> &gt;= 32 )
01107                 ++studentCredit[32];
01108             <span class="keywordflow">else</span> <span class="keywordflow">if</span>( stuPtr-&gt;<a class="code" href="classStudent.html#m12">total_course_all</a> &gt;= 0 )
01109                 ++studentCredit[stuPtr-&gt;<a class="code" href="classStudent.html#m12">total_course_all</a>];
01110 <span class="preprocessor">#endif</span>
01111 <span class="preprocessor"></span>            tag++;
01112         }
01113 
01114         <span class="comment">// ------ Part B ------</span>
01115 
01116         <span class="keywordtype">int</span> t = norm_ft_trimesters[sl]-2;
01117         <span class="keywordtype">int</span> tmpBound = stuCountPerTrimester * t;
01118 
01119         <span class="keywordflow">for</span> ( i=1; i&lt;=stuCountThisLevel; i++ ) {
01120             stuStrPtr = (<a class="code" href="structStudentStruct.html">StudentStruct</a> *) stuArr[sl].<a class="code" href="classDynArray.html#a13">get</a>(i);
01121             stuPtr = department_array[stuStrPtr-&gt;<a class="code" href="structStudentStruct.html#m1">dept_recno</a>]-&gt;student_array[stuStrPtr-&gt;<a class="code" href="structStudentStruct.html#m0">stu_recno</a>];
01122 
01123             <span class="keywordflow">if</span> ( i &gt; tmpBound )
01124                 stuStrPtr-&gt;<a class="code" href="structStudentStruct.html#m2">trimester_tag</a> = tag;
01125             try_to_count++;
01126 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01127 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( stuPtr-&gt;audit_flag ) {
01128                 <a class="code" href="classFile.html">File</a> file;
01129 
01130                 <span class="keywordtype">char</span> fileName[123];
01131 
01132                 <span class="keywordflow">switch</span>( stuPtr-&gt;<a class="code" href="classStudent.html#m2">student_level</a> ) {
01133                 <span class="keywordflow">case</span> <a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>:    strcpy( fileName, <span class="stringliteral">"TRADITION"</span> );
01134                     <span class="keywordflow">break</span>;
01135                 <span class="keywordflow">case</span> <a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>: strcpy( fileName, <span class="stringliteral">"NONTRADITION"</span> );
01136                     <span class="keywordflow">break</span>;
01137                 <span class="keywordflow">case</span> <a class="code" href="Ostudent_8h.html#a32a5">MASTER</a>:        strcpy( fileName, <span class="stringliteral">"MASTER"</span> );
01138                     <span class="keywordflow">break</span>;
01139                 <span class="keywordflow">case</span> <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a>:        strcpy( fileName, <span class="stringliteral">"DOCTOR"</span> );
01140                     <span class="keywordflow">break</span>;
01141                 }
01142 
01143                 strcat( fileName, m.format(stuPtr-&gt;old_student_recno) );
01144                 strcat( fileName, <span class="stringliteral">".txt"</span> );
01145 
01146                 file.<a class="code" href="classFile.html#a4">file_append</a>( fileName );
01147                 file.<a class="code" href="classFile.html#a7">file_seek</a>(0, FILE_END);
01148 
01149                 <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"********** It is the start of the prerun year **********"</span> );
01150 
01151                 <a class="code" href="ogfile5_8cpp.html#a4">WRITE_RECORD_SEPARATOR</a>( (&amp;file) );
01152 
01153                 file.<a class="code" href="classFile.html#a5">file_close</a>();
01154             }
01155 <span class="preprocessor">#endif</span>
01156 <span class="preprocessor"></span>            stuPtr-&gt;<a class="code" href="classStudent.html#a7">select_course</a>(1);                   <span class="comment">// 1: ignoreFaculty</span>
01157         }
01158 
01159         <span class="comment">// ------ Part C-1 ------ // sort tag and talent</span>
01160 
01161         <span class="keywordflow">for</span>( i=1; i&lt;=stuCountThisLevel; i++ )
01162             stuSortArray[i-1] = i;                      <span class="comment">// stuArr[sl].get();</span>
01163 
01164         cur_student_level_for_sorting = sl;
01165         qsort( stuSortArray, stuCountThisLevel, <span class="keyword">sizeof</span>(stuSortArray[0]), sort_stu_talent_function );
01166 
01167         <span class="comment">// ------ Part C-2 ------</span>
01168 
01169         <span class="keywordtype">float</span> *yearInProgramPctArr;
01170 
01171         <span class="keywordflow">if</span> ( sl &lt;= <a class="code" href="Ostudent_8h.html#a32a5">MASTER</a> ) {
01172             yearInProgramPctArr = <a class="code" href="classPlayerSchool.html#m70">year_in_program_pct</a>[sl];
01173         }
01174         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( sl == <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a> ) {
01175             <span class="comment">//major = 1 + generate_student_random_get_group_index                                       // major is dept_recno to department_array</span>
01176             <span class="comment">//  (adjusted_student_major_pref[SL_DOCTOR], department_array.department_count);</span>
01177 
01178             <span class="comment">//yearInProgram = 1 + generate_student_random_get_group_index</span>
01179             <span class="keywordtype">int</span> major = 1+m.random(department_array.department_count);
01180             yearInProgramPctArr =
01181                 department_res[department_array[major]-&gt;<a class="code" href="classGeneralDepartment.html#m2">department_id</a>]-&gt;doctor_year_in_program_pct;
01182         }
01183         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( sl == <a class="code" href="Ostudent_8h.html#a32a7">DISTANCE_LEARN</a> ) {
01184             yearInProgramPctArr = <a class="code" href="classPlayerSchool.html#m70">year_in_program_pct</a>[<a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>];
01185         }
01186 
01187         <span class="comment">// to find stuCountByYear[]</span>
01188         <span class="keywordtype">int</span> stuCountByYear[<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>+1];
01189         memset(stuCountByYear,0,<span class="keyword">sizeof</span>(stuCountByYear));
01190 
01191         <span class="keywordtype">int</span> chkCount = 0;
01192         <span class="keywordtype">float</span> pct = yearInProgramPctArr[0];
01193 
01194         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>+1 &amp;&amp; pct&lt;=1; i++) {
01195             stuCountByYear[i] = int(stuCountThisLevel * yearInProgramPctArr[i]);
01196 
01197             chkCount += stuCountByYear[i];
01198             pct += yearInProgramPctArr[i+1];
01199         }
01200 
01201         <span class="comment">// to eliminate the difference</span>
01202 
01203         <span class="keywordtype">int</span> diff = stuCountThisLevel - chkCount;
01204         <a class="code" href="ALL_8H.html#a0">err_when</a>(diff &lt; 0);
01205 
01206         <span class="keywordflow">if</span> ( diff &gt; 0 ) {
01207             i = min(<a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>, i);
01208             stuCountByYear[i] += diff;
01209         }
01210 
01211         <span class="comment">/*              for (i=MAX_GRADUATE_YEARS; i&gt;=0 &amp;&amp; diff&gt;0; i--)</span>
01212 <span class="comment">                        {</span>
01213 <span class="comment">                        if ( stuCountByYear[i] &gt;= diff )</span>
01214 <span class="comment">                        {</span>
01215 <span class="comment">                        stuCountByYear[i] -= diff;</span>
01216 <span class="comment">                        diff = 0;</span>
01217 <span class="comment">                        }</span>
01218 <span class="comment">                        else</span>
01219 <span class="comment">                        {</span>
01220 <span class="comment">                        diff -= stuCountByYear[i];</span>
01221 <span class="comment">                        stuCountByYear[i] = 0;</span>
01222 <span class="comment">                        }</span>
01223 <span class="comment">                        }*/</span>
01224 
01225         <span class="comment">// ------ Part C-3 ------</span>
01226 
01227         <span class="keywordtype">int</span> year = <a class="code" href="Ostudent_8h.html#a2">MAX_GRADUATE_YEARS</a>+1;
01228 
01229         <span class="keywordflow">for</span> (i=0; ; ) {
01230             <span class="keywordflow">if</span> ( stuCountByYear[year-1] &gt; 0 )
01231                 stuCountByYear[year-1]--;
01232             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( year &gt; 2 ) {
01233                 year--;
01234                 <span class="keywordflow">continue</span>;
01235             }
01236             <span class="keywordflow">else</span>
01237                 <span class="keywordflow">break</span>;
01238 
01239             <a class="code" href="ALL_8H.html#a0">err_when</a>(stuSortArray[i] &lt; 1 || stuSortArray[i] &gt; stuCountThisLevel);
01240 
01241             stuStrPtr = (<a class="code" href="structStudentStruct.html">StudentStruct</a> *) stuArr[sl].<a class="code" href="classDynArray.html#a13">get</a>(stuSortArray[i]);
01242             stuPtr = department_array[stuStrPtr-&gt;<a class="code" href="structStudentStruct.html#m1">dept_recno</a>]-&gt;student_array[stuStrPtr-&gt;<a class="code" href="structStudentStruct.html#m0">stu_recno</a>];
01243 
01244             stuPtr-&gt;<a class="code" href="classStudent.html#m6">year_in_program</a> = year;
01245 
01246             i++;
01247         }
01248 
01249         <span class="keywordtype">int</span> finalStuCountThisLevel = i;
01250 
01251         <span class="comment">// discard sims</span>
01252         <span class="keywordflow">if</span> ( finalStuCountThisLevel != stuCountThisLevel ) {
01253             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=finalStuCountThisLevel; j&lt;stuCountThisLevel; j++) {
01254                 stuStrPtr = (<a class="code" href="structStudentStruct.html">StudentStruct</a> *) stuArr[sl].<a class="code" href="classDynArray.html#a13">get</a>(stuSortArray[j]);
01255                 department_array[stuStrPtr-&gt;<a class="code" href="structStudentStruct.html#m1">dept_recno</a>]-&gt;student_array.del(stuStrPtr-&gt;<a class="code" href="structStudentStruct.html#m0">stu_recno</a>);
01256                 stuStrPtr-&gt;<a class="code" href="structStudentStruct.html#m1">dept_recno</a> = 0;
01257                 stuStrPtr-&gt;<a class="code" href="structStudentStruct.html#m0">stu_recno</a> = 0;
01258             }
01259         }
01260 
01261         <span class="comment">// ------ Part D ------ // admission procedure will be run in enrollment model</span>
01262 
01263         <span class="comment">// ------ Part E-1 ------</span>
01264 
01265         <span class="keywordtype">float</span> failRate = 0;
01266 
01267         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;finalStuCountThisLevel; j++) {
01268             stuStrPtr = (<a class="code" href="structStudentStruct.html">StudentStruct</a> *) stuArr[sl].<a class="code" href="classDynArray.html#a13">get</a>(stuSortArray[j]);
01269 
01270             <span class="comment">// Last bug : sl=1, j=6 -&gt; stuStrPtr = NULL</span>
01271             <span class="comment">// stuSortArray seems corruptted</span>
01272             <span class="comment">// chwg 072199 // avoid the bug of stuStrPtr become NULL</span>
01273             <span class="keywordflow">if</span>(stuStrPtr==<a class="code" href="OHELP_8H.html#a0">NULL</a>)
01274                 <span class="keywordflow">continue</span>;
01275             stuPtr = department_array[stuStrPtr-&gt;<a class="code" href="structStudentStruct.html#m1">dept_recno</a>]-&gt;student_array[stuStrPtr-&gt;<a class="code" href="structStudentStruct.html#m0">stu_recno</a>];
01276 
01277             <span class="keywordtype">float</span> newValue= 40+(stuPtr-&gt;<a class="code" href="classStudent.html#m20">talent_academic</a>)*(.2f + .8f * ((50)-50)/100);
01278             newValue = math.single_response_func(0.0f, 0.1f, -70.11f, 53.65f, newValue);
01279 
01280             failRate += newValue;
01281         }
01282 
01283 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01284 <span class="preprocessor"></span>        <span class="comment">// BUG FIX if divided by zero</span>
01285         failRate = math.safe_divide( failRate, (<span class="keywordtype">float</span>)finalStuCountThisLevel );
01286 <span class="preprocessor">#else</span>
01287 <span class="preprocessor"></span>        failRate /= finalStuCountThisLevel;
01288 <span class="preprocessor">#endif</span>
01289 <span class="preprocessor"></span>
01290         <span class="comment">// ------ Part E-2 ------</span>
01291 
01292         <a class="code" href="classPeerSchool.html">PeerSchool</a>* player = school_res.player_peer_school;
01293         <span class="keyword">const</span> <span class="keywordtype">float</span> expectedYearsToDegree[<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>] = { 4.47f, 7.65f, 1.05f, player-&gt;<a class="code" href="classSchool.html#m129">doc_time_to_degree</a>-2, 7.65f };
01294         <span class="keyword">const</span> <span class="keywordtype">char</span> normYearsToDegree[<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>] = { 4,8,1,2,8 };
01295 
01296         <span class="comment">//## chea 151099</span>
01297         <span class="keywordtype">float</span> lagRate = expectedYearsToDegree[sl] / normYearsToDegree[sl];
01298         <span class="comment">//              float lagRate = normYearsToDegree[sl] / expectedYearsToDegree[sl];    //## chea 151099  want to change to this but I am lost</span>
01299 
01300         <span class="comment">// ------ Part E-3 ------</span>
01301 
01302         <span class="comment">//## chea 151099</span>
01303         this-&gt;<a class="code" href="classPlayerSchool.html#m76">delay_rate</a>[sl] = 1 - (1-lagRate) / (1-failRate);
01304         <span class="comment">//              this-&gt;delay_rate[sl] = min(0.975f,max(0.8f,1 - (1-lagRate) / (1-failRate)));   //## chea 151099 want to change to this but I am lost</span>
01305 
01306     }                                               <span class="comment">// end for</span>
01307 
01308     <a class="code" href="ALL_8H.html#a8">mem_del</a>( stuSortArray );                        <span class="comment">// sorting finished</span>
01309 }
01310 
01311 <span class="comment">//---------- End of function PlayerSchool::generate_student_init_course -----------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:14 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
