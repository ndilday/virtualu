<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Oenroll.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Oenroll.cpp</h1><a href="Oenroll_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename              : OEnroll.cpp</span>
00002 <span class="comment">//Description   : EnrollRes Class Definition</span>
00003 <span class="comment">//Owner                 : Fred</span>
00004 
00005 <span class="preprocessor">#include &lt;obox.h&gt;</span>                                 <span class="comment">// for progress box</span>
00006 <span class="preprocessor">#include &lt;stdio.h&gt;</span>                                <span class="comment">// for DEBUG</span>
00007 <span class="preprocessor">#include &lt;osys.h&gt;</span>                                 <span class="comment">// for progress box</span>
00008 
00009 <span class="comment">// ES library header file</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;<a class="code" href="OGAMESET_8H.html">OGAMESET.H</a>&gt;</span>
00012 <span class="preprocessor">#include &lt;OMATH.H&gt;</span>                                <span class="comment">// average_float, gammaCDF</span>
00013 <span class="preprocessor">#include &lt;OSTR.h&gt;</span>                                 <span class="comment">// strcmp</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="OLINALG_8H.html">OLINALG.H</a>&gt;</span>                              <span class="comment">// for this calc_enroll_offers</span>
00015 
00016 <span class="comment">// CU header file</span>
00017 <span class="preprocessor">#include &lt;GAMEDEF.H&gt;</span>                              <span class="comment">// enum { NONMINORITY_MALE, NONMINORITY_FEMALE, MINORITY_MALE, MINORITY_FEMALE };</span>
00018 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>
00019 <span class="preprocessor">#include &lt;<a class="code" href="OPEERSCH_8H.html">OPEERSCH.H</a>&gt;</span>
00020 <span class="preprocessor">#include &lt;<a class="code" href="OSCHLRES_8H.html">OSCHLRES.H</a>&gt;</span>
00021 <span class="preprocessor">#include &lt;<a class="code" href="ODEPTRES_8H.html">ODEPTRES.H</a>&gt;</span>
00022 <span class="preprocessor">#include &lt;OFINANCE.H&gt;</span>                             <span class="comment">// for next_day</span>
00023 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>                                <span class="comment">// for next_day</span>
00024 <span class="preprocessor">#include &lt;ODEPT.H&gt;</span>                                <span class="comment">// for calc_student_count</span>
00025 <span class="preprocessor">#include &lt;OSTUDENT.H&gt;</span>                             <span class="comment">// for calc_student_count</span>
00026 <span class="preprocessor">#include &lt;OLIBTECH.H&gt;</span>
00027 <span class="preprocessor">#include &lt;OATHLETI.H&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="OSTUOFF_8H.html">OSTUOFF.H</a>&gt;</span>
00029 <span class="preprocessor">#include "OEnroll.h"</span>
00030 
00031 <span class="comment">// database come from data_to_db.xls</span>
00032 <span class="comment">//</span>
<a name="l00033"></a><a class="code" href="Oenroll_8cpp.html#a0">00033</a> <span class="preprocessor">#define PREFERENCE_DB "STUPREF"</span>
<a name="l00034"></a><a class="code" href="Oenroll_8cpp.html#a1">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define APP_YIELD_DB    "APPYIELD"</span>
<a name="l00035"></a><a class="code" href="Oenroll_8cpp.html#a2">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define PREFERENCE_DB2  "STUPREF2"</span>
<a name="l00036"></a><a class="code" href="Oenroll_8cpp.html#a3">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define TALENT_DB     "STTALENT"</span>
00037 <span class="preprocessor"></span>
00038 <span class="comment">//----------- Define constants -------------//</span>
00039 <span class="comment">//----------- Define static variables -------------//</span>
00040 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00041 <span class="preprocessor"></span><span class="keywordtype">short</span> TRADIT_COUNT = 0;
00042 
00043 <span class="preprocessor">#define MAX_TRADITION_COUNT 5</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#define MAX_NONTRA_COUNT    5</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#define MAX_MASTER_COUNT    3</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#define MAX_DOCTOR_COUNT    3</span>
00047 <span class="preprocessor"></span>
00048 <span class="keyword">const</span> <a class="code" href="ogfile5_8cpp.html#a5">RECORD_SEPARATOR_LEN</a> = 2;
00049 <span class="keyword">static</span> <span class="keywordtype">char</span> *RECORD_SEPARATOR = <span class="stringliteral">"\r\n"</span>;
00050 <span class="keyword">const</span> <a class="code" href="ogfile5_8cpp.html#a7">FIELD_SEPARATOR_LEN</a> = 1;
00051 <span class="keyword">static</span> <span class="keywordtype">char</span> *FIELD_SEPARATOR = <span class="stringliteral">"\t"</span>;
00052 
00053 <span class="keyword">static</span> <span class="keywordtype">char</span> *export_num(<span class="keywordtype">int</span> value) {
00054     <span class="keyword">static</span> <span class="keywordtype">char</span> num_str[20];
00055     <span class="keywordflow">return</span> itoa( value, num_str, 10 );              <span class="comment">// 10 is radix</span>
00056 }
00057 
00058 <span class="keyword">static</span> <span class="keywordtype">char</span> *export_num(<span class="keywordtype">double</span> value) {
00059     <span class="keyword">static</span> <span class="keywordtype">char</span> num_str[20];
00060     <span class="keywordflow">return</span> gcvt( value, 7, num_str );               <span class="comment">// a few more more than 7, for negative sign, decimal point and exponent</span>
00061 }
00062 
00063 <span class="keyword">static</span> <span class="keywordtype">char</span> *export_percent(<span class="keywordtype">double</span> value) {       <span class="comment">// value already multiplied by 100</span>
00064     <span class="keyword">static</span> <span class="keywordtype">char</span> num_str[20];
00065     <span class="keywordflow">return</span> gcvt( value*0.01, 7, num_str );          <span class="comment">// a few more more than 7, for negative sign, decimal point and exponent</span>
00066 }
00067 
00068 <span class="preprocessor">#define WRITE_FIELD_SEPARATOR(f)      f-&gt;file_write(FIELD_SEPARATOR, FIELD_SEPARATOR_LEN)</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#define WRITE_STR_FIELD(f,s)          { f-&gt;file_write(s, strlen(s)); }</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#define WRITE_NUM_FIELD(f,n)          { char *s=export_num(n); f-&gt;file_write(s, strlen(s)); }</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#define WRITE_PERCENT_FIELD(f,n)      { char *s=export_percent(n); f-&gt;file_write(s, strlen(s)); }</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#define WRITE_RECORD_SEPARATOR(f)     f-&gt;file_write(RECORD_SEPARATOR, RECORD_SEPARATOR_LEN)</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00074 <span class="preprocessor"></span>
00075 <span class="comment">//----------- Define static class member variables -------------//</span>
00076 <span class="keyword">const</span> <span class="keywordtype">float</span> EnrollRes::apps_latency[<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>] = { .4f, .4f, .5f, .6f, .7f };
00077 <span class="comment">// 990408 const float EnrollRes::yield_latency[MAX_STUDENT_LEVEL] = { .6f, .5f, .5f, .5f, .5f };        // elm 1-4 are useless</span>
00078 <span class="comment">// elm 1-4 are useless</span>
00079 <span class="keyword">const</span> <span class="keywordtype">float</span> EnrollRes::yield_latency[<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>] = {
00080     .9f, .5f, .5f, .5f, .5f
00081 };
00082 
00083 <span class="comment">// (* given to minority scores *)</span>
00084 <span class="keyword">const</span> <span class="keywordtype">float</span> EnrollRes::aidMinMultipliers[<a class="code" href="Oenroll_8h.html#a1">PRIORITY_LEVEL_COUNT</a>] = {
00085     1, 1.05f, 1.10f
00086 };
00087 <span class="comment">//const float aidAthMultipliers         = {1, 1.25f, 1.50f}; // (* extra aid for athletes *)</span>
00088 
<a name="l00089"></a><a class="code" href="classEnrollRes.html#a0">00089</a> <a class="code" href="classEnrollRes.html#a0">EnrollRes::EnrollRes</a>() {
00090 }
00091 
00092 <span class="comment">//----------- Define static functions -------------//</span>
00093 <span class="keyword">static</span> <span class="keywordtype">bool</span> is_minority_group(<span class="keywordtype">char</span> group) {
00094     <span class="keywordflow">return</span> group == <a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a> || group == <a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a>;
00095 }
00096 
00097 <span class="keyword">static</span> <span class="keywordtype">bool</span> is_male_group(<span class="keywordtype">char</span> group) {
00098     <span class="keywordflow">return</span> group == <a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a> || group == <a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a>;
00099 }
00100 
00101 <span class="comment">//----------- Begin of function EnrollRes::adjust_fraction_merit_aid --------//</span>
00104 <span class="comment">void EnrollRes::adjust_fraction_merit_aid(float&amp; fraction) {</span>
00105     <span class="keywordflow">if</span> ( fraction &gt; 0 &amp;&amp; fraction &lt; fraction_merit_top - .005f )
00106         fraction = fraction_merit_top + .005f;
00107     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( fraction &gt; 1 + .005f - fraction_merit_top )
00108         fraction = (1 - .005f - fraction_merit_top) ;
00109 }
00110 
00111 <span class="comment">//----------- Begin of function EnrollRes::adjust_fraction_merit_aid --------//</span>
00112 
00113 <span class="comment">//----------- Begin of function EnrollRes::init --------//</span>
<a name="l00116"></a><a class="code" href="classEnrollRes.html#a1">00116</a> <span class="comment">void EnrollRes::init() {</span>
00117     memset(<span class="keyword">this</span>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classEnrollRes.html">EnrollRes</a>));
00118 
00119     load_db_student_pref();
00120     load_db_student_pref2();
00121     load_db_app_yield();
00122     load_db_student_talent();
00123 
00124 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00125 <span class="preprocessor"></span>    distance_learner_acceptance = 1;
00126 <span class="preprocessor">#endif</span>
00127 <span class="preprocessor"></span>
00128     <span class="comment">//-------- init constants ----------//</span>
00129     s_lower_bound = 0.5f;
00130     s_upper_bound = 1.5f;
00131     s_slope     = 5.0f;
00132 
00133     chance_avg  = 1.0f;
00134     chance_sd = 1.0f;
00135 
00136     fraction_merit_top = 0.025f;                    <span class="comment">// see section 2.4 last paragraph</span>
00137 }
00138 
00139 <span class="comment">//------------- End of function EnrollRes::init --------//</span>
00140 
00141 <span class="comment">//----------- Begin of function EnrollRes::deinit --------//</span>
<a name="l00143"></a><a class="code" href="classEnrollRes.html#a2">00143</a> <span class="comment">void EnrollRes::deinit() {</span>
00144 }
00145 
00146 <span class="comment">//------------- End of function EnrollRes::deinit --------//</span>
00147 
00148 <span class="comment">//----------- Begin of function EnrollRes::load_db_student_pref ------//</span>
00152 <span class="comment">void EnrollRes::load_db_student_pref() {</span>
00153     <a class="code" href="structPreferenceRec.html">PreferenceRec</a>  *prefRec;
00154     <a class="code" href="classDatabase.html">Database</a>    *dbPreference = game_set.open_db(<a class="code" href="Oenroll_8cpp.html#a0">PREFERENCE_DB</a>);
00155 
00156     <span class="keywordtype">int</span> db_count = (short) dbPreference-&gt;<a class="code" href="classDatabase.html#a7">rec_count</a>();
00157 
00158     <a class="code" href="ALL_8H.html#a0">err_when</a>( db_count != <a class="code" href="Oenroll_8h.html#a30a4">PREFERECNE_COUNT</a> * 2 );   <span class="comment">// 2: average and deviation</span>
00159 
00160     <span class="comment">//askbillok: how to handle "na in cells like E119-120</span>
00161     <span class="comment">//  segment2 = segment1</span>
00162 
00163     <span class="comment">//------ read in Preference information array -------//</span>
00164 
00165     memset( preference_array, 0, <span class="keyword">sizeof</span>(preference_array));
00166 
00167     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;db_count ; i++ ) {
00168         <span class="comment">//----- odd row/record store average -----//</span>
00169         prefRec = (<a class="code" href="structPreferenceRec.html">PreferenceRec</a>*) dbPreference-&gt;<a class="code" href="classDatabase.html#a4">read</a>(i+1);
00170 
00171         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> j=0 ; j&lt;<a class="code" href="Oenroll_8h.html#a30a3">INSTITU_SEGMENT_COUNT</a>; j++ ) {
00172             preference_array[i/2][j].average = (float) m.atof( prefRec-&gt;<a class="code" href="structPreferenceRec.html#m0">value</a>[j], 9 );
00173             preference_array[i/2][j].weight = (float) m.atof( prefRec-&gt;<a class="code" href="structPreferenceRec.html#m1">weight</a>, 9 );
00174         }
00175 
00176         i++;
00177         <span class="comment">//-----  even row/record store deviation -----//</span>
00178         prefRec = (<a class="code" href="structPreferenceRec.html">PreferenceRec</a>*) dbPreference-&gt;<a class="code" href="classDatabase.html#a4">read</a>(i+1);
00179 
00180         <span class="keywordflow">for</span>( j=0 ; j&lt;<a class="code" href="Oenroll_8h.html#a30a3">INSTITU_SEGMENT_COUNT</a>; j++ )
00181             preference_array[i/2][j].deviation = (float) m.atof( prefRec-&gt;<a class="code" href="structPreferenceRec.html#m0">value</a>[j], 9 );
00182 
00183         preference_array[i/2][j].tmp_fuzzy_value = 0.0f;
00184     }
00185 }
00186 
00187 <span class="comment">//------------- End of function EnrollRes::load_db_student_pref ------//</span>
00188 
00189 <span class="comment">//----------- Begin of function EnrollRes::load_db_student_pref2 ------//</span>
00193 <span class="comment">void EnrollRes::load_db_student_pref2() {</span>
00194     <a class="code" href="structPreferenceRec2.html">PreferenceRec2</a>  *prefRec;
00195     <a class="code" href="classDatabase.html">Database</a>    *dbPreference = game_set.open_db(<a class="code" href="Oenroll_8cpp.html#a2">PREFERENCE_DB2</a>);
00196     <a class="code" href="classString.html">String</a>      tmpStr;
00197 
00198     <span class="keywordtype">int</span> db_count = (short) dbPreference-&gt;<a class="code" href="classDatabase.html#a7">rec_count</a>();
00199 
00200     <a class="code" href="ALL_8H.html#a0">err_when</a>( db_count != <a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a> * (<a class="code" href="Oenroll_8h.html#a30a7">SCHOOL_CONTROL_COUNT</a> + <a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a> - 1) );
00201 
00202     <span class="comment">// make sure values of constants conformed to database column order</span>
00203     <a class="code" href="ALL_8H.html#a0">err_when</a>( <a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a> != 0 );
00204     <a class="code" href="ALL_8H.html#a0">err_when</a>( <a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a> != 1 || <a class="code" href="Opschool_8h.html#a61a15">PRIVATE</a> != 0 );
00205 
00206     <span class="comment">//------ read in Preference information array -------//</span>
00207 
00208     memset( preference_array2, 0, <span class="keyword">sizeof</span>(preference_array2));
00209 
00210     <span class="comment">// for sl1</span>
00211 
00212     <span class="keywordtype">int</span> i, j, arrSL;
00213     <span class="keywordtype">char</span>  control = <a class="code" href="Opschool_8h.html#a61a15">PRIVATE</a>;
00214 
00215     <span class="keywordflow">for</span>( i=0; i&lt;<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>*<a class="code" href="Oenroll_8h.html#a30a7">SCHOOL_CONTROL_COUNT</a>; i++ ) {
00216         <span class="keywordflow">if</span> ( i &gt;= <a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a> ) {
00217             control = <a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a>;
00218             j = i - <a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>;
00219         }
00220         <span class="keywordflow">else</span> {
00221             j = i;
00222         }
00223 
00224         prefRec = (<a class="code" href="structPreferenceRec2.html">PreferenceRec2</a>*) dbPreference-&gt;<a class="code" href="classDatabase.html#a4">read</a>(i+1);
00225 
00226         m.rtrim_fld(tmpStr, prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[0], 9);
00227         <span class="keywordflow">if</span> ( strcmp(tmpStr, <span class="stringliteral">""</span>) != 0 )
00228             preference_array2[control][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][j].apps_ratio  = (float) m.atof( prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[0], 9 );
00229         <span class="keywordflow">else</span>
00230             preference_array2[control][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][j].apps_ratio  = -1.0f;
00231 
00232         m.rtrim_fld(tmpStr, prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[1], 9);
00233         <span class="keywordflow">if</span> ( strcmp(tmpStr, <span class="stringliteral">""</span>) != 0 )
00234             preference_array2[control][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][j].apps_ratio      = (float) m.atof( prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[1], 9 );
00235         <span class="keywordflow">else</span>
00236             preference_array2[control][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][j].apps_ratio      = -1.0f;
00237 
00238         m.rtrim_fld(tmpStr, prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[2], 9);
00239         <span class="keywordflow">if</span> ( strcmp(tmpStr, <span class="stringliteral">""</span>) != 0 )
00240             preference_array2[control][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][j].yield_rate  = (float) m.atof( prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[2], 9 );
00241         <span class="keywordflow">else</span>
00242             preference_array2[control][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][j].yield_rate  = -1.0f;
00243 
00244         m.rtrim_fld(tmpStr, prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[3], 9);
00245         <span class="keywordflow">if</span> ( strcmp(tmpStr, <span class="stringliteral">""</span>) != 0 )
00246             preference_array2[control][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][j].yield_rate      = (float) m.atof( prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[3], 9 );
00247         <span class="keywordflow">else</span>
00248             preference_array2[control][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][j].yield_rate      = -1.0f;
00249 
00250     }
00251 
00252     <span class="comment">// for sl2-5;  arrSL=0 -&gt; sl2</span>
00253 
00254     <span class="keywordflow">for</span>( i=0, arrSL=-1; i&lt;<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a> * (<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a> - 1); i++ ) {
00255         j = i % <a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>;
00256 
00257         <span class="keywordflow">if</span> ( j==0 ) {
00258             arrSL++;    <a class="code" href="ALL_8H.html#a0">err_when</a>(arrSL == <a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>-1);
00259         }
00260 
00261         prefRec = (<a class="code" href="structPreferenceRec2.html">PreferenceRec2</a>*) dbPreference-&gt;<a class="code" href="classDatabase.html#a4">read</a>(<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>*<a class="code" href="Oenroll_8h.html#a30a7">SCHOOL_CONTROL_COUNT</a> + i+1);
00262 
00263         <span class="comment">// for sl1</span>
00264 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00265 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( i == 63 ) {                              <span class="comment">// start of SL5, Institutional Prestige</span>
00266             preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a15">PRIVATE</a>][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][0]  = 0.1;
00267             preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a15">PRIVATE</a>][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][0]      = 0.1;
00268             preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a>][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][0]   = 0.1;
00269             preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a>][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][0]     = 0.1;
00270         }
00271         <span class="keywordflow">else</span>
00272             <span class="keywordflow">if</span> ( i == 75 ) {                              <span class="comment">// % of minority</span>
00273                 preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a15">PRIVATE</a>][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][12] = -1.0f;
00274                 preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a15">PRIVATE</a>][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][12]   = -1.0f;
00275                 preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a>][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][12]  = -1.0f;
00276                 preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a>][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][12]      = -1.0f;
00277             }
00278             <span class="keywordflow">else</span>
00279                 <span class="keywordflow">if</span> ( i == 78 ) {                              <span class="comment">// Tuition: Private Institutions</span>
00280                     preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a15">PRIVATE</a>][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][15] = 0.5;
00281                     preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a15">PRIVATE</a>][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][15]   = 0.5;
00282                     preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a>][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][15]  = -1.0f;
00283                     preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a>][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][15]      = -1.0f;
00284                 }
00285                 <span class="keywordflow">else</span>
00286                     <span class="keywordflow">if</span> ( i == 79 ) {                              <span class="comment">// Blended Tuition: Public Institutions</span>
00287                         preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a15">PRIVATE</a>][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][16] = -1.0f;
00288                         preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a15">PRIVATE</a>][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][16]   = -1.0f;
00289                         preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a>][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][16]  = 0.3;
00290                         preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a>][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][16]      = 0.3;
00291                     }
00292                     <span class="keywordflow">else</span> {
00293 <span class="preprocessor">#endif</span>
00294 <span class="preprocessor"></span>                        m.rtrim_fld(tmpStr, prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[0], 9);
00295                         preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a15">PRIVATE</a>][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][j]
00296                             = ( strcmp(tmpStr, <span class="stringliteral">""</span>) != 0 ) ? (float) m.atof( prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[0], 9 ) : -1.0f;
00297 
00298                         m.rtrim_fld(tmpStr, prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[1], 9);
00299                         preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a15">PRIVATE</a>][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][j]
00300                             = ( strcmp(tmpStr, <span class="stringliteral">""</span>) != 0 ) ? (float) m.atof( prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[1], 9 ) : -1.0f;
00301 
00302                         m.rtrim_fld(tmpStr, prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[2], 9);
00303                         preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a>][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][j]
00304                             = ( strcmp(tmpStr, <span class="stringliteral">""</span>) != 0 ) ? (float) m.atof( prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[2], 9 ) : -1.0f;
00305 
00306                         m.rtrim_fld(tmpStr, prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[3], 9);
00307                         preference_array2_sls[arrSL][<a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a>][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][j]
00308                             = ( strcmp(tmpStr, <span class="stringliteral">""</span>) != 0 ) ? (float) m.atof( prefRec-&gt;<a class="code" href="structPreferenceRec2.html#m0">weight</a>[3], 9 ) : -1.0f;
00309 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00310 <span class="preprocessor"></span>                    }
00311 <span class="preprocessor">#endif</span>
00312 <span class="preprocessor"></span>    }
00313 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00314 <span class="preprocessor"></span>    <span class="comment">// set new variable (Percent of courses redesigned for optimal IT)</span>
00315     <span class="comment">// just for SL-5 Distance Learning</span>
00316     preference_array2_sls[3][<a class="code" href="Opschool_8h.html#a61a15">PRIVATE</a>][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][21] = 0.4;
00317     preference_array2_sls[3][<a class="code" href="Opschool_8h.html#a61a15">PRIVATE</a>][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][21]     = 0.4;
00318     preference_array2_sls[3][<a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a>][<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>][21]    = 0.6;
00319     preference_array2_sls[3][<a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a>][<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>][21]      = 0.6;
00320 <span class="preprocessor">#endif</span>
00321 <span class="preprocessor"></span>}
00322 
00323 <span class="comment">//------------- End of function EnrollRes::load_db_student_pref2 ------//</span>
00324 
00325 <span class="comment">//----------- Begin of function EnrollRes::load_db_app_yield ------//</span>
00329 <span class="comment">void EnrollRes::load_db_app_yield() {</span>
00330     <a class="code" href="structAppYieldRec.html">AppYieldRec</a>   *appRec;
00331     <a class="code" href="classDatabase.html">Database</a>    *dbAppYield = game_set.open_db(<a class="code" href="Oenroll_8cpp.html#a1">APP_YIELD_DB</a>);
00332     <span class="keywordtype">int</span>       varOffset, stuSubSeg, stuSeg, iSeg, i=0;
00333 
00334     <span class="keywordtype">int</span> db_count = (short) dbAppYield-&gt;<a class="code" href="classDatabase.html#a7">rec_count</a>();
00335 
00336     <a class="code" href="ALL_8H.html#a0">err_when</a>( db_count != <a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a> * <a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a> * <a class="code" href="Oenroll_8h.html#a33a15">APP_YIELD_VAR_COUNT</a>);
00337 
00338     <span class="comment">//------ read in Preference information array -------//</span>
00339 
00340     memset( app_yield_array, 0, <span class="keyword">sizeof</span>(app_yield_array));
00341 
00342     <span class="keywordflow">for</span> ( varOffset=0; varOffset&lt;<a class="code" href="Oenroll_8h.html#a33a15">APP_YIELD_VAR_COUNT</a>; varOffset++ )
00343         <span class="keywordflow">for</span> ( stuSubSeg=0; stuSubSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; stuSubSeg++ )
00344             <span class="keywordflow">for</span> ( stuSeg=0; stuSeg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; stuSeg++ ) {
00345                 appRec = (<a class="code" href="structAppYieldRec.html">AppYieldRec</a>*) dbAppYield-&gt;<a class="code" href="classDatabase.html#a4">read</a>(i+1);
00346                 i++;
00347                 <span class="keywordflow">for</span> ( iSeg=0; iSeg&lt;<a class="code" href="Oenroll_8h.html#a30a3">INSTITU_SEGMENT_COUNT</a>; iSeg++ ) {
00348                     app_yield_array[stuSubSeg][stuSeg][iSeg][varOffset]
00349                         = (short) m.atoi( appRec-&gt;<a class="code" href="structAppYieldRec.html#m0">count</a>[iSeg], 9 );
00350                     <a class="code" href="ALL_8H.html#a0">err_when</a>(app_yield_array[stuSubSeg][stuSeg][iSeg][varOffset] &lt; 0);
00351                 }
00352             }
00353 
00354 <span class="preprocessor">#ifdef DEBUG_</span>
00355 <span class="preprocessor"></span>    debug_msg(<span class="stringliteral">"----- begin enroll: app_yield -----"</span>);
00356 
00357     <span class="keywordflow">for</span> ( stuSubSeg=0; stuSubSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; stuSubSeg++ )
00358         <span class="keywordflow">for</span> ( stuSeg=0; stuSeg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; stuSeg++ ) {
00359             <span class="keywordtype">char</span> str[100] = <span class="stringliteral">""</span>;
00360             <span class="keywordflow">for</span> ( iSeg=0; iSeg&lt;<a class="code" href="Oenroll_8h.html#a30a3">INSTITU_SEGMENT_COUNT</a>; iSeg++ ) {
00361                 sprintf(str, <span class="stringliteral">"%s, %d"</span>, str, app_yield_array[stuSubSeg][stuSeg][iSeg].apps);
00362             }
00363             debug_msg(str);
00364         }
00365     debug_msg(<span class="stringliteral">"----- end enroll: app_yield -----"</span>);
00366 <span class="preprocessor">#endif</span>
00367 <span class="preprocessor"></span>}
00368 
00369 <span class="comment">//------------- End of function EnrollRes::load_db_app_yield ------//</span>
00370 
00371 <span class="comment">//----------- Begin of function EnrollRes::load_db_student_talent ------//</span>
00375 <span class="comment"></span>
00376 <span class="comment">//------- static var for the 2 func below ------------//</span>
00377 <span class="keyword">static</span> <span class="keywordtype">float</span> income_growth[<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>][<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>];
00378 <span class="keyword">static</span> <span class="keywordtype">float</span> income_growth_last2[<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>][<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>];
00379 
00380 <span class="keywordtype">void</span> EnrollRes::load_db_student_talent() {
00381 <span class="preprocessor">#define TALENT_VAR_PROPERTIES_COUNT   3         // mean, sd, count</span>
00382 <span class="preprocessor"></span>
00383     <a class="code" href="structTalentRec.html">TalentRec</a> *talentRec;
00384     <a class="code" href="classDatabase.html">Database</a>    *dbPreference = game_set.open_db(<a class="code" href="Oenroll_8cpp.html#a3">TALENT_DB</a>);
00385 
00386     <span class="keywordtype">int</span> db_count = (short) dbPreference-&gt;<a class="code" href="classDatabase.html#a7">rec_count</a>();
00387 
00388     <a class="code" href="ALL_8H.html#a0">err_when</a>( db_count !=  <a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a> * <a class="code" href="Ostudent_8h.html#a39a24">TALENT_INCOME_VAR_COUNT</a> * TALENT_VAR_PROPERTIES_COUNT);
00389 
00390     <span class="comment">//------ read in array -------//</span>
00391 
00392     memset( <a class="code" href="classEnrollRes.html#m3">talent_array</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classEnrollRes.html#m3">talent_array</a>));
00393 
00394     <span class="keywordtype">int</span> var, subSeg, seg, i=1;
00395 
00396     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ )
00397         <span class="keywordflow">for</span> ( var=0; var&lt;<a class="code" href="Ostudent_8h.html#a39a24">TALENT_INCOME_VAR_COUNT</a>; var++ ) {
00398             <span class="comment">// read average row</span>
00399             talentRec = (<a class="code" href="structTalentRec.html">TalentRec</a>*) dbPreference-&gt;<a class="code" href="classDatabase.html#a4">read</a>(i++);
00400 
00401             <span class="keywordflow">for</span> ( seg=0; seg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; seg++ ) {
00402                 <a class="code" href="classEnrollRes.html#m3">talent_array</a>[subSeg][seg][var].<a class="code" href="structTalent.html#m0">average</a>
00403                     = (float) m.atof( talentRec-&gt;<a class="code" href="structTalentRec.html#m0">seg</a>[seg], 9 );
00404             }
00405 
00406             <span class="comment">// read standard deviation row</span>
00407             talentRec = (<a class="code" href="structTalentRec.html">TalentRec</a>*) dbPreference-&gt;<a class="code" href="classDatabase.html#a4">read</a>(i++);
00408 
00409             <span class="keywordflow">for</span> ( seg=0; seg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; seg++ ) {
00410                 <a class="code" href="classEnrollRes.html#m3">talent_array</a>[subSeg][seg][var].<a class="code" href="structTalent.html#m1">variance</a>
00411                     = (float) m.atof( talentRec-&gt;<a class="code" href="structTalentRec.html#m0">seg</a>[seg], 9 );
00412             }
00413 
00414             <span class="comment">// skip the row "count" for each talent rating</span>
00415             <span class="comment">//talentRec = (TalentRec*) dbPreference-&gt;read(i++);</span>
00416             i++;
00417         }
00418 
00419     <span class="comment">// adjust the talent_array</span>
00420     <span class="comment">// refer to mathca cell:</span>
00421     <span class="comment">// "Traditional Undergraduates: sL-1: Test financial data"</span>
00422     <span class="comment">//</span>
00423     <span class="comment">// 10 years</span>
00424     <span class="keyword">const</span> <span class="keywordtype">float</span> INCOME_UPDATE = math.safe_pow(1.04f, 10);
00425 
00426     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
00427         <span class="keywordflow">for</span> ( var=0; var&lt;<a class="code" href="Ostudent_8h.html#a39a25">TALENT_VAR_COUNT</a>; var++ )
00428             <span class="keywordflow">for</span> ( seg=0; seg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; seg++ ) {
00429                 <a class="code" href="classEnrollRes.html#m3">talent_array</a>[subSeg][seg][var].<a class="code" href="structTalent.html#m1">variance</a>
00430                     = math.safe_pow(<a class="code" href="classEnrollRes.html#m3">talent_array</a>[subSeg][seg][var].variance, 2);
00431             }
00432 
00433         <span class="keywordflow">for</span> ( seg=0; seg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; seg++ ) {
00434             <a class="code" href="classEnrollRes.html#m3">talent_array</a>[subSeg][seg][<a class="code" href="Ostudent_8h.html#a39a29">INCOME</a>].average
00435                 *= INCOME_UPDATE;
00436             <a class="code" href="classEnrollRes.html#m3">talent_array</a>[subSeg][seg][<a class="code" href="Ostudent_8h.html#a39a29">INCOME</a>].variance
00437                 <span class="comment">// * INCOME_UPDATE</span>
00438                 = math.safe_pow(<a class="code" href="classEnrollRes.html#m3">talent_array</a>[subSeg][seg][var].variance / 10, 2);
00439         }
00440     }
00441 
00442     <span class="comment">//--------------------------//</span>
00443 
00444     <span class="comment">// 1027 req26.txt</span>
00445 
00446     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
00447         <span class="keywordflow">for</span> ( seg=0; seg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; seg++ ) {
00448             income_growth[subSeg][seg] = math.get_random_snd(0.015f, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(.0025f));
00449             income_growth_last2[subSeg][seg] = 0;
00450         }
00451     }
00452 }
00453 
00454 <span class="comment">//------------- End of function EnrollRes::load_db_student_talent ------//</span>
00455 
00456 <span class="comment">//----------- Begin of function EnrollRes::update_income ------//</span>
00460 <span class="comment">void EnrollRes::update_income() {</span>
00461     <span class="comment">// adjust this var: Talent talent_array[STUDENT_SUBSEGMENT_COUNT][STUDENT_SEGMENT_COUNT][TALENT_INCOME_VAR_COUNT];</span>
00462     <span class="comment">//</span>
00463 
00464     <span class="keywordtype">int</span> subSeg, seg;
00465     <span class="keywordtype">float</span> inflationRate = (float) finance.inflation_rate / 100.0f;
00466 
00467     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
00468         <span class="keywordflow">for</span> ( seg=0; seg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; seg++ ) {
00469             <span class="keywordtype">float</span> lastValue = income_growth[subSeg][seg];
00470 
00471             income_growth[subSeg][seg] = math.time_variation(lastValue, income_growth_last2[subSeg][seg], 0.9908f, -0.6314f, 0.003202690f);
00472             income_growth_last2[subSeg][seg] = lastValue;
00473 
00474             talent_array[subSeg][seg][<a class="code" href="Ostudent_8h.html#a39a29">INCOME</a>].average *= (1+inflationRate+income_growth[subSeg][seg]);
00475         }
00476     }
00477 }
00478 
00479 <span class="comment">//----------- End of function EnrollRes::update_income ------//</span>
00480 
00481 <span class="comment">//----------- Begin of function EnrollRes::calc_student_pref --------//</span>
00488 <span class="comment">void EnrollRes::calc_student_pref() {</span>
00489     <span class="comment">// column L</span>
00490     <span class="comment">// recalculate PeerSchool's properties to prefArray to speed up calculation</span>
00491     <span class="comment">// '10' is the additional field included in PREFERECNE_COUNT2 (pref_vars_array)</span>
00492     <span class="comment">// but not PREFERECNE_COUNT (prefArray)</span>
00493     <span class="comment">//</span>
00494     <a class="code" href="classPeerSchool.html">PeerSchool</a>* player = school_res.player_peer_school;
00495     <span class="keywordtype">float</span> prefArray[<a class="code" href="Oenroll_8h.html#a30a4">PREFERECNE_COUNT</a>];
00496     <span class="keywordtype">int</span> i, j;
00497 
00498     <span class="keywordflow">for</span> (j=0, i=0; j&lt;<a class="code" href="Oenroll_8h.html#a30a4">PREFERECNE_COUNT</a>; j++, i++) {
00499         <span class="keywordflow">if</span> ( j == 10 )                                <span class="comment">// skip in-state freshmen percent</span>
00500             i++;
00501 
00502         prefArray[j] = player-&gt;<a class="code" href="classPeerSchool.html#m7">pref_vars_array</a>[i];
00503     }
00504 
00505     <a class="code" href="ALL_8H.html#a0">err_when</a>( <a class="code" href="Oenroll_8h.html#a30a4">PREFERECNE_COUNT</a> != 20 );
00506 
00507     <span class="comment">// E129-K147: Fuzzy Logic Indices for Undergraduate Applications Ratios and Yield Rates</span>
00508     <a class="code" href="structPreference.html">Preference</a> *prefPtr;
00509 
00510     <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="Oenroll_8h.html#a30a4">PREFERECNE_COUNT</a>; j++)
00511         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Oenroll_8h.html#a30a3">INSTITU_SEGMENT_COUNT</a>; i++) {
00512             prefPtr = (enroll_res.preference_array[j]) + i;
00513             <span class="comment">//prefPtr++;</span>
00514             prefPtr-&gt;<a class="code" href="structPreference.html#m3">tmp_fuzzy_value</a> = (float) exp(-math.safe_pow((  math.safe_divide((prefPtr-&gt;<a class="code" href="structPreference.html#m0">average</a>-prefArray[j]), prefPtr-&gt;<a class="code" href="structPreference.html#m1">deviation</a>)  ), 2));
00515         }
00516 
00517     <span class="comment">// E150-K150: weighted raw index value: update player's preference_array</span>
00518     <span class="keywordtype">bool</span> isPlayerSchoolPublic = player_school.is_public();
00519     <span class="keywordtype">float</span> tmpSumOfSum = 0.0f;
00520 
00521     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Oenroll_8h.html#a30a3">INSTITU_SEGMENT_COUNT</a>; i++) {
00522         <span class="keywordtype">float</span> tmpSum = 0.0f;
00523 
00524         <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="Oenroll_8h.html#a30a5">NON_FINANCIAL_PREFERECNE_COUNT</a>; j++) {
00525             prefPtr = (enroll_res.preference_array[j]) + i;
00526 
00527             tmpSum += prefPtr-&gt;<a class="code" href="structPreference.html#m3">tmp_fuzzy_value</a> * prefPtr-&gt;<a class="code" href="structPreference.html#m2">weight</a>;
00528 
00529         }
00530 
00531         <a class="code" href="ALL_8H.html#a0">err_when</a>(tmpSum==0);
00532 
00533         <span class="keywordflow">for</span> (j=<a class="code" href="Oenroll_8h.html#a30a5">NON_FINANCIAL_PREFERECNE_COUNT</a>; j&lt;<a class="code" href="Oenroll_8h.html#a30a4">PREFERECNE_COUNT</a>; j+=2) {
00534             prefPtr = (enroll_res.preference_array[j]) + i;
00535 
00536             <span class="keywordflow">if</span> ( isPlayerSchoolPublic )
00537                 prefPtr++;
00538 
00539             tmpSum += prefPtr-&gt;<a class="code" href="structPreference.html#m3">tmp_fuzzy_value</a> * prefPtr-&gt;<a class="code" href="structPreference.html#m2">weight</a>;
00540         }
00541         pref_weight_array[i] = tmpSum;
00542         tmpSumOfSum += tmpSum;
00543 
00544         <a class="code" href="ALL_8H.html#a0">err_when</a>(tmpSumOfSum==0);
00545     }
00546 
00547     <span class="comment">// E151-K151: calc segment weight</span>
00548     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Oenroll_8h.html#a30a3">INSTITU_SEGMENT_COUNT</a>; i++)
00549         pref_weight_array[i] /= tmpSumOfSum;
00550 }
00551 
00552 <span class="comment">//------------- End of function EnrollRes::calc_student_pref --------//</span>
00553 
00554 <span class="comment">//----------- Begin of function EnrollRes::calc_app_yield --------//</span>
00565 <span class="comment">void EnrollRes::calc_app_yield() {</span>
00566     <span class="keywordtype">float</span>     appYield[<a class="code" href="Oenroll_8h.html#a33a15">APP_YIELD_VAR_COUNT</a>], totalMatrics=0;
00567     <span class="keywordtype">int</span>     varOffset, stuSubSeg, stuSeg, iSeg, i=0;
00568     <span class="comment">// short                            *shortPtr</span>
00569     <span class="comment">// short                    *studenCountPtr;</span>
00570 
00571     <span class="comment">// refer to columns BM:QR</span>
00572     <span class="keywordflow">for</span> ( stuSubSeg=0; stuSubSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; stuSubSeg++ )
00573         <span class="keywordflow">for</span> ( stuSeg=0; stuSeg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; stuSeg++ ) {
00574             memset(appYield, 0, <span class="keyword">sizeof</span>(appYield));
00575             <span class="keywordflow">for</span> ( varOffset=0; varOffset&lt;<a class="code" href="Oenroll_8h.html#a33a15">APP_YIELD_VAR_COUNT</a>; varOffset++ ) {
00576                 <span class="comment">//studenCountPtr = &amp;( appYieldArray[varOffset] );</span>
00577                 <span class="keywordflow">for</span> ( iSeg=0; iSeg&lt;<a class="code" href="Oenroll_8h.html#a30a3">INSTITU_SEGMENT_COUNT</a>; iSeg++ ) {
00578                     appYield[varOffset] += (enroll_res.app_yield_array[stuSubSeg][stuSeg][iSeg][varOffset] * pref_weight_array[iSeg]);
00579 
00580                     <a class="code" href="ALL_8H.html#a0">err_when</a>(appYield[varOffset] &lt; 0);
00581                 }
00582             }
00583 
00584             <a class="code" href="ALL_8H.html#a0">err_when</a>( appYield[<a class="code" href="Oenroll_8h.html#a33a18">MATRICS</a>] &lt; 0.000001f || appYield[<a class="code" href="Oenroll_8h.html#a33a17">OFFERS</a>] &lt; 0.000001f );
00585             <span class="comment">//err_when( appYield[OFFERS] &gt; appYield[APPS] );    //1117</span>
00586             <a class="code" href="ALL_8H.html#a0">err_when</a>( appYield[<a class="code" href="Oenroll_8h.html#a33a18">MATRICS</a>] &gt; appYield[<a class="code" href="Oenroll_8h.html#a33a17">OFFERS</a>] );
00587 
00588             <span class="comment">//TO use pointer to speed it up</span>
00589             enroll_data_sl1[stuSubSeg][stuSeg].apps_ratio = float(appYield[<a class="code" href="Oenroll_8h.html#a33a16">APPS</a>]) / appYield[<a class="code" href="Oenroll_8h.html#a33a18">MATRICS</a>];
00590             enroll_data_sl1[stuSubSeg][stuSeg].yield_rate = float(appYield[<a class="code" href="Oenroll_8h.html#a33a18">MATRICS</a>]) / appYield[<a class="code" href="Oenroll_8h.html#a33a17">OFFERS</a>];
00591             enroll_data_sl1[stuSubSeg][stuSeg].fraction_matrics = appYield[<a class="code" href="Oenroll_8h.html#a33a18">MATRICS</a>];
00592 
00593             totalMatrics += appYield[<a class="code" href="Oenroll_8h.html#a33a18">MATRICS</a>];
00594         }
00595 
00596     <span class="comment">// note: apps_ratio in enroll_data is not updated yearly, it's just for init_enroll</span>
00597     <a class="code" href="ALL_8H.html#a0">err_when</a>(totalMatrics &lt;= 0);
00598 
00599     <span class="keywordflow">for</span> ( stuSubSeg=0; stuSubSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; stuSubSeg++ )
00600         <span class="keywordflow">for</span> ( stuSeg=0; stuSeg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; stuSeg++ ) {
00601             enroll_data_sl1[stuSubSeg][stuSeg].fraction_matrics /= totalMatrics;
00602         }
00603 }
00604 
00605 <span class="comment">//------------- End of function EnrollRes::calc_app_yield --------//</span>
00606 
00607 <span class="comment">//------------- End of function EnrollRes::set_app_yield --------//</span>
00608 <span class="comment">//</span>
<a name="l00609"></a><a class="code" href="classEnrollRes.html#a10">00609</a> <span class="keywordtype">void</span> <a class="code" href="classEnrollRes.html#a10">EnrollRes::set_app_yield</a>(<span class="keywordtype">float</span> appMultipler, <span class="keywordtype">float</span> yieldMultiplier) {
00610     <span class="keywordtype">int</span> stuSubSeg, stuSeg;
00611 
00612     <span class="keywordflow">for</span> ( stuSubSeg=0; stuSubSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; stuSubSeg++ )
00613         <span class="keywordflow">for</span> ( stuSeg=0; stuSeg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; stuSeg++ ) {
00614             <a class="code" href="classEnrollRes.html#m23">enroll_data_sl1</a>[stuSubSeg][stuSeg].<a class="code" href="structEnrollDataSL1.html#m0">apps_ratio</a> *= appMultipler;
00615             <a class="code" href="classEnrollRes.html#m23">enroll_data_sl1</a>[stuSubSeg][stuSeg].<a class="code" href="structEnrollDataSL1.html#m1">yield_rate</a> *= yieldMultiplier;
00616         }
00617 }
00618 
00619 <span class="comment">//------------- End of function EnrollRes::set_app_yield --------//</span>
00620 
00621 <span class="comment">//----------- static variables of class PeerSchool --------//</span>
<a name="l00622"></a><a class="code" href="classPeerSchool.html#p0">00622</a> <span class="keywordtype">float</span> <a class="code" href="classPeerSchool.html#p0">PeerSchool::pref_vars_average_array</a>[<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>];
<a name="l00623"></a><a class="code" href="classPeerSchool.html#p1">00623</a> <span class="keywordtype">float</span> <a class="code" href="classPeerSchool.html#p1">PeerSchool::pref_vars_average_array_last</a>[<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>];
00624 
00625 <span class="comment">//----------- Begin of function PeerSchool::calc_student_pref_vars_array --------//</span>
<a name="l00633"></a><a class="code" href="classPeerSchool.html#a1">00633</a> <span class="comment">void PeerSchool::calc_student_pref_vars_array() {</span>
00634     <span class="keywordflow">if</span> ( <span class="keyword">this</span> != school_res.player_peer_school ) {
00635         calc_student_pref_vars_array_peer();
00636         <span class="keywordflow">return</span>;
00637     }
00638 
00639     memcpy( pref_vars_array_last, pref_vars_array, <span class="keyword">sizeof</span>(pref_vars_array) );
00640 
00641     <span class="comment">// calculate the column Q in [HE.STU.pref.xls]Sheet1</span>
00642     <span class="comment">//</span>
00643     <span class="comment">// recalculate PeerSchool's properties to prefArray to speed up calculation</span>
00644     <span class="comment">// (refer to column L of [HE.initialization]stu_pref)</span>
00645     <span class="comment">// local var: float pref_vars_array[PREFERECNE_COUNT2];</span>
00646 
00647     <span class="comment">// (minor bug) the following RHSs may NOT be updated during play</span>
00648 
00649     <span class="comment">// assume "this" is the player_peeer_school</span>
00650     <span class="keywordtype">int</span> studentEnrollCount[<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>];
00651     <span class="keywordtype">int</span> i;
00652 
00653     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; i++ ) {
00654         studentEnrollCount[i] = enroll_res.student_count[i];
00655         percent_female_sl[i] = (char) enroll_res.student_female_percent[i];
00656         percent_minority_sl[i] = (char) enroll_res.student_minority_percent[i];
00657     }
00658 
00659     pref_vars_array[0] = prestige;
00660     <span class="comment">// by 1021 email</span>
00661     pref_vars_array[1] = (float) athletics_office.ncaa_level_value;
00662     pref_vars_array[2] = float(student_life_staff_salaries+student_life_other_expense)/(full_time_undergrad+part_time_undergrad);
00663     pref_vars_array[3] = percent_traditional_ug_in_residence_halls / 100.0f;
00664     pref_vars_array[4] = percent_get_bacc_in_5_year / 100.0f;
00665 
00666     pref_vars_array[5] = enroll_res.applications_rate[<a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>];
00667     pref_vars_array[6] = enroll_res.cur_yield_rate[<a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>];
00668     pref_vars_array[7] = float(studentEnrollCount[1]) / float(studentEnrollCount[0]+studentEnrollCount[1]);
00669 
00670     <span class="keywordtype">float</span> tmpCount = 0;
00671 
00672     pref_vars_array[8] = float(studentEnrollCount[0]+studentEnrollCount[1]) / enroll_res.total_student_count;
00673     pref_vars_array[9] = float(studentEnrollCount[4]) / enroll_res.total_student_count;
00674 
00675     <span class="comment">// the additional field included in PREFERECNE_COUNT2 but not PREFERECNE_COUNT</span>
00676     pref_vars_array[10] = float(percent_instate_freshmen) / 100;
00677 
00678     <span class="keywordflow">for</span> (i = 0, tmpCount = 0; i&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; i++)
00679         tmpCount += float(studentEnrollCount[i]) * percent_female_sl[i] / 100;
00680 
00681     pref_vars_array[11] = float(tmpCount) / enroll_res.total_student_count;
00682 
00683     <span class="keywordflow">for</span> (i = 0, tmpCount = 0; i&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; i++)
00684         tmpCount += studentEnrollCount[i] * percent_minority_sl[i] / 100;
00685 
00686     pref_vars_array[12] = float(tmpCount) /  enroll_res.total_student_count;
00687     pref_vars_array[13] = doc_time_to_degree;
00688     pref_vars_array[14] = sponsored_research_rating;
00689     pref_vars_array[15] = (float) finance.tuition_rate;
00690 
00691     pref_vars_array[16] = pref_vars_array[15];
00692     pref_vars_array[17] = percent_ug_students_on_aid / 100.0f;
00693     pref_vars_array[18] = pref_vars_array[17];
00694     pref_vars_array[19] = institutional_aid_per_fte;
00695     pref_vars_array[20] = institutional_aid_per_fte;
00696 
00697     <a class="code" href="ALL_8H.html#a0">err_when</a>( <a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a> != 21 );
00698 
00699     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>; i++)
00700         <a class="code" href="ALL_8H.html#a0">err_when</a>( pref_vars_array[i] &lt; 0 );
00701 
00702 }
00703 
00704 <span class="comment">//------------- End of function PeerSchool::calc_student_pref_vars_array --------//</span>
00705 
00706 <span class="comment">//------------- Begin of function PeerSchool::calc_student_pref_vars_array_peer --------//</span>
<a name="l00716"></a><a class="code" href="classPeerSchool.html#a2">00716</a> <span class="comment">void PeerSchool::calc_student_pref_vars_array_peer() {</span>
00717     memcpy( pref_vars_array_last, pref_vars_array, <span class="keyword">sizeof</span>(pref_vars_array) );
00718 
00719     <span class="comment">// calculate the column Q in [HE.STU.pref.xls]Sheet1</span>
00720     <span class="comment">//</span>
00721     <span class="comment">// recalculate PeerSchool's properties to prefArray to speed up calculation</span>
00722     <span class="comment">// (refer to column L of [HE.initialization]stu_pref)</span>
00723     <span class="comment">// local var: float pref_vars_array[PREFERECNE_COUNT2];</span>
00724 
00725     <span class="comment">// the following RHSs may NOT be updated during play</span>
00726 
00727     pref_vars_array[0] = prestige;
00728     pref_vars_array[1] = (float) athletics_office.ncaa_level_value;
00729 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00730 <span class="preprocessor"></span>    pref_vars_array[2] = math.safe_divide( <span class="keywordtype">float</span>(student_life_staff_salaries+student_life_other_expense), (<span class="keywordtype">float</span>)full_time_undergrad+part_time_undergrad );
00731 <span class="preprocessor">#else</span>
00732 <span class="preprocessor"></span>    pref_vars_array[2] = float(student_life_staff_salaries+student_life_other_expense)/(full_time_undergrad+part_time_undergrad);
00733 <span class="preprocessor">#endif</span>
00734 <span class="preprocessor"></span>    pref_vars_array[3] = percent_traditional_ug_in_residence_halls / 100.0f;
00735     pref_vars_array[4] = percent_get_bacc_in_5_year / 100.0f;
00736 
00737     pref_vars_array[5] = ug_applications_rate;
00738     pref_vars_array[6] = ug_yield_rate / 100.0f;
00739 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00740 <span class="preprocessor"></span>    pref_vars_array[7] = math.safe_divide( (<span class="keywordtype">float</span>)part_time_undergrad, (<span class="keywordtype">float</span>)full_time_undergrad+part_time_undergrad );
00741 <span class="preprocessor">#else</span>
00742 <span class="preprocessor"></span>    pref_vars_array[7] = part_time_undergrad/float(full_time_undergrad+part_time_undergrad);
00743 <span class="preprocessor">#endif</span>
00744 <span class="preprocessor"></span>
00745     <span class="keywordtype">int</span> studentEnrollCount[<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>];
00746     studentEnrollCount[0] = full_time_undergrad;
00747     studentEnrollCount[1] = part_time_undergrad;
00748     studentEnrollCount[2] = enrollment_masters;
00749     studentEnrollCount[3] = enrollment_doctoral;
00750     studentEnrollCount[4] = non_degree_seeking;
00751 
00752     <span class="keywordtype">float</span> studentCount = 0.0f;
00753     <span class="keywordtype">int</span> i, tmpCount=0;
00754     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; i++)
00755         studentCount += (float) studentEnrollCount[i];
00756 
00757 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00758 <span class="preprocessor"></span>    pref_vars_array[8] = math.safe_divide( (<span class="keywordtype">int</span>)(full_time_undergrad+part_time_undergrad), (<span class="keywordtype">int</span>)studentCount );
00759     pref_vars_array[9] = math.safe_divide( (<span class="keywordtype">int</span>)non_degree_seeking, (<span class="keywordtype">int</span>)studentCount );
00760 <span class="preprocessor">#else</span>
00761 <span class="preprocessor"></span>    pref_vars_array[8] = (full_time_undergrad+part_time_undergrad) / studentCount;
00762     pref_vars_array[9] = non_degree_seeking / studentCount;
00763 <span class="preprocessor">#endif</span>
00764 <span class="preprocessor"></span>
00765     <span class="comment">// the additional field included in PREFERECNE_COUNT2 but not PREFERECNE_COUNT</span>
00766     pref_vars_array[10] = percent_instate_freshmen;
00767 
00768     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; i++)
00769         tmpCount += studentEnrollCount[i] * percent_female_sl[i] / 100;
00770 
00771 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00772 <span class="preprocessor"></span>    pref_vars_array[11] = math.safe_divide( (<span class="keywordtype">int</span>)tmpCount, (<span class="keywordtype">int</span>)studentCount );
00773 <span class="preprocessor">#else</span>
00774 <span class="preprocessor"></span>    pref_vars_array[11] = tmpCount / studentCount;
00775 <span class="preprocessor">#endif</span>
00776 <span class="preprocessor"></span>
00777     <span class="keywordflow">for</span> (i=0, tmpCount = 0; i&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; i++)
00778         tmpCount += studentEnrollCount[i] * percent_minority_sl[i] / 100;
00779 
00780 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00781 <span class="preprocessor"></span>    pref_vars_array[12] = math.safe_divide( (<span class="keywordtype">int</span>)tmpCount, (<span class="keywordtype">int</span>)studentCount );
00782 <span class="preprocessor">#else</span>
00783 <span class="preprocessor"></span>    pref_vars_array[12] = tmpCount / studentCount;
00784 <span class="preprocessor">#endif</span>
00785 <span class="preprocessor"></span>    pref_vars_array[13] = doc_time_to_degree;
00786     pref_vars_array[14] = sponsored_research_rating;
00787     pref_vars_array[15] = (float) tuition_rate;
00788 
00789     pref_vars_array[16] = pref_vars_array[15];
00790     pref_vars_array[17] = percent_ug_students_on_aid / 100.0f;
00791     pref_vars_array[18] = pref_vars_array[17];
00792     pref_vars_array[19] = institutional_aid_per_fte;
00793     pref_vars_array[20] = institutional_aid_per_fte;
00794 
00795     <a class="code" href="ALL_8H.html#a0">err_when</a>( <a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a> != 21 );
00796 
00797     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>; i++)
00798         <a class="code" href="ALL_8H.html#a0">err_when</a>( pref_vars_array[i] &lt; 0 );
00799 }
00800 
00801 <span class="comment">//------------- End of function PeerSchool::calc_student_pref_vars_array_peer --------//</span>
00802 
00803 <span class="comment">//----------- Begin of static function PeerSchool::calc_student_pref_vars_average_array --------//</span>
00804 <span class="comment">//</span>
00805 <span class="comment">// Refer to [HE.STU.pref.xls]Sheet1</span>
00806 <span class="comment">//</span>
00807 <span class="comment">// Calc values for column Q for PGI and peer schools</span>
00808 <span class="comment">//</span>
<a name="l00809"></a><a class="code" href="classPeerSchool.html#d0">00809</a> <span class="keywordtype">void</span> <a class="code" href="classPeerSchool.html#d0">PeerSchool::calc_student_pref_vars_average_array</a>() {
00810     memcpy( <a class="code" href="classPeerSchool.html#p1">pref_vars_average_array_last</a>, <a class="code" href="classPeerSchool.html#p0">pref_vars_average_array</a>, <span class="keyword">sizeof</span>(<a class="code" href="classPeerSchool.html#p0">pref_vars_average_array</a>) );
00811 
00812     <span class="keywordtype">float</span> sum;
00813     <span class="keywordtype">short</span> psCount = school_res.peer_school_count;
00814 
00815     <span class="comment">// pref_vars_average_array is static</span>
00816     <span class="comment">//</span>
00817     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> var=0; var&lt;<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>; var++) {
00818         sum = 0.0f;
00819 
00820         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;psCount; i++) {
00821             <a class="code" href="classPeerSchool.html">PeerSchool</a> *ps = &amp;(school_res.peer_school_array[i]);
00822 
00823             <span class="keywordflow">if</span> ( ps != school_res.player_peer_school )
00824 
00825                 sum += ps-&gt;<a class="code" href="classPeerSchool.html#m7">pref_vars_array</a>[var];
00826         }
00827 
00828         <a class="code" href="classPeerSchool.html#p0">pref_vars_average_array</a>[var] = sum / psCount;
00829     }
00830 }
00831 
00832 <span class="comment">//------------- End of static function PeerSchool::calc_student_pref_vars_average_array --------//</span>
00833 
00834 <span class="comment">//----------- Begin of function EnrollRes::calc_enroll_applications --------//</span>
<a name="l00847"></a><a class="code" href="classEnrollRes.html#a11">00847</a> <span class="comment">void EnrollRes::calc_enroll_applications() {</span>
00848     <span class="keyword">const</span> <span class="keywordtype">int</span> sl = 0;
00849     <span class="keywordtype">float</span> prefVarsArray[<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>];         <span class="comment">// column Q</span>
00850     <span class="keywordtype">int</span> i, j;
00851 
00852     <span class="comment">// calc values for column Q</span>
00853     <span class="comment">// The data in column Q represent</span>
00854     <span class="comment">// the "ratio of the variable for the PGI to the average of the same variable</span>
00855     <span class="comment">// for the peer institutions." (from email req11_enroll.txt)</span>
00856     <span class="comment">//</span>
00857     <a class="code" href="classPeerSchool.html">PeerSchool</a>* player = school_res.player_peer_school;
00858     memcpy(prefVarsArray, player-&gt;<a class="code" href="classPeerSchool.html#m7">pref_vars_array</a>, <span class="keyword">sizeof</span>(prefVarsArray));
00859 
00860     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>; i++) {
00861         <span class="comment">// (* uses lagged financial aid variables; current values for all else *)</span>
00862         <span class="comment">//</span>
00863         <span class="keywordflow">if</span> ( i &lt; <a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a> - 4 )
00864             prefVarsArray[i] = math.safe_divide(prefVarsArray[i], <a class="code" href="classPeerSchool.html#p0">PeerSchool::pref_vars_average_array</a>[i]);
00865         <span class="keywordflow">else</span>
00866             prefVarsArray[i] = math.safe_divide(player-&gt;<a class="code" href="classPeerSchool.html#m8">pref_vars_array_last</a>[i], <a class="code" href="classPeerSchool.html#p1">PeerSchool::pref_vars_average_array_last</a>[i]);
00867     }
00868 
00869     <span class="comment">// calc values for column R</span>
00870     <span class="comment">//</span>
00871     <span class="keywordtype">bool</span> isPublic = player_school.is_public();
00872     <span class="keywordtype">float</span> finalRatio[<a class="code" href="Oenroll_8h.html#a32a12">MINORITY_GROUP_COUNT</a>];
00873     <span class="keywordtype">float</span> tmpRatio;
00874     <span class="keywordtype">float</span> tmp, <a class="code" href="NEWMATRM_8H.html#a2">sign</a>;
00875 
00876     <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="Oenroll_8h.html#a32a12">MINORITY_GROUP_COUNT</a>; j++) {
00877         finalRatio[j] = 1;
00878 
00879         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>; i++) {
00880             <a class="code" href="NEWMATRM_8H.html#a2">sign</a> = (pref_special_case(i))? -1.0f: 1.0f;
00881 
00882             <span class="comment">// 1</span>
00883             tmp = enroll_res.preference_array2[isPublic][j][i].apps_ratio;
00884 
00885             <span class="keywordflow">if</span> ( tmp &lt;= 0.0 || prefVarsArray[i] == 0)
00886                 tmpRatio = 1.0f;
00887             <span class="keywordflow">else</span>
00888                 tmpRatio = math.safe_pow(prefVarsArray[i], <a class="code" href="NEWMATRM_8H.html#a2">sign</a> * tmp);
00889 
00890             <span class="comment">// 2</span>
00891             finalRatio[j] *= tmpRatio;
00892 
00893         }
00894 
00895         <span class="keywordflow">if</span> ( !(1+ (float) exp(-s_slope*(finalRatio[j]-1))) )
00896             finalRatio[j] = 1;
00897         <span class="keywordflow">else</span>
00898             finalRatio[j] = s_lower_bound+(s_upper_bound-s_lower_bound)/(1+ (float) exp(-s_slope*(finalRatio[j]-1)));
00899 
00900         <a class="code" href="ALL_8H.html#a0">err_when</a>( finalRatio[j] &lt; 0 );
00901     }
00902 
00903     <span class="comment">// refer to mathca code only this part</span>
00904     <span class="comment">//</span>
00905     <span class="keywordtype">int</span> minorGroup, stuSubSeg, stuSeg;
00906     <a class="code" href="structEnrollDataSL1.html">EnrollDataSL1</a>* ed;
00907 
00908     total_applications[sl] = 0;
00909 
00910     finalRatio[<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>] *= app_multiplier[sl];
00911     finalRatio[<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>] *= app_multiplier[sl];
00912 
00913     <span class="comment">//----------------//</span>
00914 
00915     <span class="comment">//  total_applications[sl]=0;       // ## CHWG062199</span>
00916 
00917     <span class="keywordflow">for</span> ( stuSubSeg=0; stuSubSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; stuSubSeg++ ) {
00918         <span class="keywordflow">if</span> ( is_minority_group(stuSubSeg) )
00919             minorGroup = <a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>;
00920         <span class="keywordflow">else</span>
00921             minorGroup = <a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>;
00922 
00923         <span class="keywordflow">for</span> ( stuSeg=0; stuSeg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; stuSeg++ ) {
00924             ed = &amp;enroll_data_sl1[stuSubSeg][stuSeg];
00925 
00926             ed-&gt;<a class="code" href="structEnrollDataSL1.html#m5">applications</a>
00927                 = int( (1.0f-apps_latency[sl]) * math.get_random_snd(chance_avg, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(chance_sd), <span class="keyword">true</span>)
00928                        * finalRatio[minorGroup] * ed-&gt;<a class="code" href="structEnrollDataSL1.html#m2">base_apps</a>
00929                        <span class="comment">// + 0.5 for float-int rounding</span>
00930                        + apps_latency[sl] * ed-&gt;<a class="code" href="structEnrollDataSL1.html#m5">applications</a> + 0.5);
00931 
00932             <a class="code" href="ALL_8H.html#a0">err_when</a>(ed-&gt;<a class="code" href="structEnrollDataSL1.html#m5">applications</a> &lt; 0);
00933             total_applications[sl] += ed-&gt;<a class="code" href="structEnrollDataSL1.html#m5">applications</a>;
00934         }
00935     }
00936 }
00937 
00938 <span class="comment">//---------------------////---------------------////---------------------//</span>
<a name="l00939"></a><a class="code" href="classEnrollRes.html#a13">00939</a> <span class="keywordtype">void</span> <a class="code" href="classEnrollRes.html#a13">EnrollRes::calc_enroll_matriculations</a>() {
00940     <span class="keyword">const</span> <span class="keywordtype">int</span> sl = 0;                               <span class="comment">//## chea 260899 try to use loop below</span>
00941 
00942     <span class="keywordtype">float</span> prefVarsArray[<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>];         <span class="comment">// column Q</span>
00943     <span class="keywordtype">int</span> i, j;
00944 
00945     <span class="comment">// calc values for column Q</span>
00946     <span class="comment">// The data in column Q represent</span>
00947     <span class="comment">// the "ratio of the variable for the PGI to the average of the same variable</span>
00948     <span class="comment">// for the peer institutions." (from email req11_enroll.txt)</span>
00949     <span class="comment">//</span>
00950     <a class="code" href="classPeerSchool.html">PeerSchool</a>* player = school_res.player_peer_school;
00951     memcpy(prefVarsArray, player-&gt;<a class="code" href="classPeerSchool.html#m7">pref_vars_array</a>, <span class="keyword">sizeof</span>(prefVarsArray));
00952 
00953     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>; i++) {
00954         <span class="comment">// (* uses current values for all variables *)</span>
00955         <span class="comment">//</span>
00956         prefVarsArray[i] = math.safe_divide(prefVarsArray[i], <a class="code" href="classPeerSchool.html#p0">PeerSchool::pref_vars_average_array</a>[i]);
00957     }
00958 
00959     <span class="comment">// calc values for column R</span>
00960     <span class="comment">//</span>
00961     <span class="keywordtype">bool</span> isPublic = player_school.is_public();
00962     <span class="keywordtype">float</span> finalRatio[<a class="code" href="Oenroll_8h.html#a32a12">MINORITY_GROUP_COUNT</a>];
00963     <span class="keywordtype">float</span> tmpRatio;
00964     <span class="keywordtype">float</span> tmp, <a class="code" href="NEWMATRM_8H.html#a2">sign</a>;
00965 
00966     <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="Oenroll_8h.html#a32a12">MINORITY_GROUP_COUNT</a>; j++) {
00967         finalRatio[j] = 1;
00968 
00969         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>; i++) {
00970             <a class="code" href="NEWMATRM_8H.html#a2">sign</a> = (pref_special_case(i))? -1.0f: 1.0f;
00971 
00972             <span class="comment">// 1</span>
00973             <span class="comment">//tmp = enroll_res.preference_array2[isPublic][j][i].apps_ratio;</span>
00974             tmp = enroll_res.preference_array2[isPublic][j][i].yield_rate;
00975 
00976             <span class="keywordflow">if</span> ( tmp &lt;= 0.0 )                           <span class="comment">// empty entry in database</span>
00977                 tmpRatio = 1;
00978             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( prefVarsArray[i] == 0 )           <span class="comment">// 0.75: from mathca code</span>
00979                 tmpRatio = 0.75f;
00980             <span class="keywordflow">else</span> {
00981                 <span class="keywordflow">if</span> ( i &lt; <a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a> - 4 )
00982                     tmpRatio = (float) math.safe_pow(prefVarsArray[i], <a class="code" href="NEWMATRM_8H.html#a2">sign</a> * tmp);
00983                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( i &lt; <a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a> - 2 )
00984                     tmpRatio = (float) math.safe_pow(math.safe_divide(fraction_on_aid[j], prefVarsArray[i]), <a class="code" href="NEWMATRM_8H.html#a2">sign</a> * tmp);
00985                 <span class="keywordflow">else</span>
00986                     tmpRatio = (float) math.safe_pow(math.safe_divide(<span class="keywordtype">float</span>(average_aid[j]), prefVarsArray[i]), <a class="code" href="NEWMATRM_8H.html#a2">sign</a> * tmp);
00987             }
00988 
00989             <span class="keywordflow">if</span> ( tmpRatio &lt; -100 || tmpRatio &gt; 100 )    <span class="comment">// fix bug on fly</span>
00990                 tmpRatio = 1;
00991 
00992             <span class="comment">// 2</span>
00993             finalRatio[j] *= tmpRatio;
00994         }
00995 
00996         <span class="keywordflow">if</span> ( !(1+ (float) exp(-s_slope*(finalRatio[j]-1))) )
00997             finalRatio[j] = 1;
00998         <span class="keywordflow">else</span>
00999             finalRatio[j] = s_lower_bound+(s_upper_bound-s_lower_bound)/(1+ (float) exp(-s_slope*(finalRatio[j]-1)));
01000     }
01001 
01002     <span class="comment">// refer to mathca code only for this part</span>
01003     <span class="comment">//</span>
01004     <span class="keywordtype">int</span> minorGroup, stuSubSeg, stuSeg;
01005     <a class="code" href="structEnrollDataSL1.html">EnrollDataSL1</a>* ed; {
01006 
01007         <span class="comment">// BUG_HERE</span>
01008         <span class="comment">// for statement is missing in the original version..//## chwg0628      ..</span>
01009         <span class="comment">//              for(sl=0;sl&lt;MAX_STUDENT_LEVEL;sl++)</span>
01010         <span class="comment">//</span>
01011         <span class="comment">//      for(int sl=0;sl&lt;MAX_STUDENT_LEVEL;sl++)  //## chea 260899 try adding</span>
01012         <a class="code" href="classEnrollRes.html#m15">total_matrics</a>[sl] = 0;
01013         <a class="code" href="classEnrollRes.html#m11">matrics_top_athletes</a> = 0; <a class="code" href="classEnrollRes.html#m8">male_matrics_top_athletes</a> = 0;
01014 
01015         <span class="keywordflow">for</span> ( stuSubSeg=0; stuSubSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; stuSubSeg++ ) {
01016             <span class="keywordflow">if</span> ( is_minority_group(stuSubSeg) )
01017                 minorGroup = <a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>;
01018             <span class="keywordflow">else</span>
01019                 minorGroup = <a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>;
01020 
01021             <span class="keywordflow">for</span> ( stuSeg=0; stuSeg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; stuSeg++ ) {
01022                 ed = &amp;<a class="code" href="classEnrollRes.html#m23">enroll_data_sl1</a>[stuSubSeg][stuSeg];
01023 
01024                 ed-&gt;<a class="code" href="structEnrollDataSL1.html#m1">yield_rate</a>
01025                     = (1.0f-yield_latency[sl]) * math.get_random_snd(chance_avg, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(chance_sd), <span class="keyword">true</span>)
01026                     * <a class="code" href="classEnrollRes.html#m26">yield_multiplier</a>[sl] * finalRatio[minorGroup] * ed-&gt;<a class="code" href="structEnrollDataSL1.html#m3">base_yield_rate</a>
01027                     + yield_latency[sl] * ed-&gt;<a class="code" href="structEnrollDataSL1.html#m1">yield_rate</a>;
01028 
01029                 <span class="comment">// make yield_rate within [1:0]</span>
01030                 <span class="comment">//min &amp; max bug chea</span>
01031                 ed-&gt;<a class="code" href="structEnrollDataSL1.html#m1">yield_rate</a> = max(0.0f, min(1.0f, ed-&gt;<a class="code" href="structEnrollDataSL1.html#m1">yield_rate</a>));
01032 
01033                 <span class="comment">// calc matriculations</span>
01034                 <span class="comment">// + 0.5 for float-int rounding</span>
01035                 ed-&gt;<a class="code" href="structEnrollDataSL1.html#m7">matrics</a> =  int(ed-&gt;<a class="code" href="structEnrollDataSL1.html#m1">yield_rate</a> * ed-&gt;<a class="code" href="structEnrollDataSL1.html#m6">offers</a>+ 0.5);
01036 
01037                 <span class="comment">// calc total matriculations</span>
01038                 <a class="code" href="classEnrollRes.html#m15">total_matrics</a>[sl] += ed-&gt;<a class="code" href="structEnrollDataSL1.html#m7">matrics</a>;
01039             }
01040 
01041             <span class="comment">// calc number of top athletes *newly* recruited</span>
01042             <span class="comment">// which is the number of matriculants in stdent segment 4 (athlete)</span>
01043             <a class="code" href="classEnrollRes.html#m11">matrics_top_athletes</a> += <a class="code" href="classEnrollRes.html#m23">enroll_data_sl1</a>[stuSubSeg][3].<a class="code" href="structEnrollDataSL1.html#m7">matrics</a>;
01044 
01045             <span class="keywordflow">if</span>(is_male_group(stuSubSeg))
01046                 <a class="code" href="classEnrollRes.html#m8">male_matrics_top_athletes</a> += <a class="code" href="classEnrollRes.html#m23">enroll_data_sl1</a>[stuSubSeg][3].<a class="code" href="structEnrollDataSL1.html#m7">matrics</a>;
01047         }
01048     }
01049 
01050 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01051 <span class="preprocessor"></span>    <span class="comment">// do again to adjust total_matrics to target_enrollment</span>
01052     <span class="keywordflow">if</span>( (!info.prerun_year || info.prerun_year &amp;&amp; info.game_year &gt; 1 ) &amp;&amp; <a class="code" href="classEnrollRes.html#m15">total_matrics</a>[sl] &gt;= 10 ) {
01053         <span class="keywordtype">int</span> oldTotalMatrics = <a class="code" href="classEnrollRes.html#m15">total_matrics</a>[sl];
01054         <span class="keywordtype">int</span> targetIntake = <a class="code" href="classEnrollRes.html#m37">target_student_intake</a>[sl];
01055 
01056         <a class="code" href="classEnrollRes.html#m15">total_matrics</a>[sl] = 0;
01057         <a class="code" href="classEnrollRes.html#m11">matrics_top_athletes</a> = 0; <a class="code" href="classEnrollRes.html#m8">male_matrics_top_athletes</a> = 0;
01058 
01059         <span class="keywordflow">for</span> ( stuSubSeg=0; stuSubSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; stuSubSeg++ ) {
01060             <span class="keywordflow">if</span> ( is_minority_group(stuSubSeg) )
01061                 minorGroup = <a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>;
01062             <span class="keywordflow">else</span>
01063                 minorGroup = <a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>;
01064 
01065             <span class="keywordflow">for</span> ( stuSeg=0; stuSeg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; stuSeg++ ) {
01066                 ed = &amp;<a class="code" href="classEnrollRes.html#m23">enroll_data_sl1</a>[stuSubSeg][stuSeg];
01067 
01068                 ed-&gt;<a class="code" href="structEnrollDataSL1.html#m1">yield_rate</a> = ed-&gt;<a class="code" href="structEnrollDataSL1.html#m1">yield_rate</a> * targetIntake / oldTotalMatrics;
01069 
01070                 <span class="comment">// make yield_rate within [1:0]</span>
01071                 <span class="comment">//min &amp; max bug chea</span>
01072                 ed-&gt;<a class="code" href="structEnrollDataSL1.html#m1">yield_rate</a> = max(0.0f, min(1.0f, ed-&gt;<a class="code" href="structEnrollDataSL1.html#m1">yield_rate</a>));
01073 
01074                 <span class="comment">// calc matriculations</span>
01075                 <span class="comment">// + 0.5 for float-int rounding</span>
01076                 ed-&gt;<a class="code" href="structEnrollDataSL1.html#m7">matrics</a> =  int(ed-&gt;<a class="code" href="structEnrollDataSL1.html#m1">yield_rate</a> * ed-&gt;<a class="code" href="structEnrollDataSL1.html#m6">offers</a>+ 0.5);
01077 
01078                 <span class="comment">// calc total matriculations</span>
01079                 <a class="code" href="classEnrollRes.html#m15">total_matrics</a>[sl] += ed-&gt;<a class="code" href="structEnrollDataSL1.html#m7">matrics</a>;
01080             }
01081 
01082             <span class="comment">// calc number of top athletes *newly* recruited</span>
01083             <span class="comment">// which is the number of matriculants in stdent segment 4 (athlete)</span>
01084             <a class="code" href="classEnrollRes.html#m11">matrics_top_athletes</a> += <a class="code" href="classEnrollRes.html#m23">enroll_data_sl1</a>[stuSubSeg][3].<a class="code" href="structEnrollDataSL1.html#m7">matrics</a>;
01085 
01086             <span class="keywordflow">if</span>(is_male_group(stuSubSeg))
01087                 <a class="code" href="classEnrollRes.html#m8">male_matrics_top_athletes</a> += <a class="code" href="classEnrollRes.html#m23">enroll_data_sl1</a>[stuSubSeg][3].<a class="code" href="structEnrollDataSL1.html#m7">matrics</a>;
01088         }
01089     }
01090 <span class="preprocessor">#endif</span>
01091 <span class="preprocessor"></span>
01092     <span class="keywordflow">for</span> ( stuSubSeg=0; stuSubSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; stuSubSeg++ ) {
01093         <span class="keywordflow">for</span> ( stuSeg=0; stuSeg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; stuSeg++ ) {
01094             ed = &amp;<a class="code" href="classEnrollRes.html#m23">enroll_data_sl1</a>[stuSubSeg][stuSeg];
01095 
01096             <span class="keywordflow">if</span> ( <a class="code" href="classEnrollRes.html#m15">total_matrics</a>[sl] &gt; 0 )
01097                 ed-&gt;<a class="code" href="structEnrollDataSL1.html#m4">fraction_matrics</a> = float(ed-&gt;<a class="code" href="structEnrollDataSL1.html#m7">matrics</a>) / <a class="code" href="classEnrollRes.html#m15">total_matrics</a>[sl];
01098             <span class="keywordflow">else</span>
01099                 ed-&gt;<a class="code" href="structEnrollDataSL1.html#m4">fraction_matrics</a> = 0;
01100         }
01101     }
01102 }
01103 
01104 <span class="comment">//------------- End of function EnrollRes::calc_enroll_matriculations --------//</span>
01105 <span class="comment">//------------- End of function EnrollRes::calc_enroll_applications --------//</span>
01106 
01107 <span class="comment">//----------- Begin of function EnrollRes::calc_enroll_offers --------//</span>
<a name="l01112"></a><a class="code" href="classEnrollRes.html#a12">01112</a> <span class="comment">void EnrollRes::calc_enroll_offers() {</span>
01113     <span class="comment">// for sl1 temporarily</span>
01114     <span class="keyword">const</span> <span class="keywordtype">int</span> sl = 0;
01115     <span class="keywordtype">int</span> stuSubSeg, stuSeg;
01116     <a class="code" href="structEnrollDataSL1.html">EnrollDataSL1</a>* ed;
01117     <span class="keywordtype">float</span> sum=0;
01118     total_offers[sl] = 0;
01119 
01120     <span class="comment">//PeerSchool* player = school_res.player_peer_school;</span>
01121     <span class="keywordtype">int</span> targetIntake = target_student_intake[sl];
01122 
01123     <span class="comment">// calc sum</span>
01124     <span class="keywordflow">for</span> ( stuSubSeg=0; stuSubSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; stuSubSeg++ )
01125         <span class="keywordflow">for</span> ( stuSeg=0; stuSeg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; stuSeg++ ) {
01126             ed = &amp;enroll_data_sl1[stuSubSeg][stuSeg];
01127             sum += ed-&gt;<a class="code" href="structEnrollDataSL1.html#m1">yield_rate</a> * ed-&gt;<a class="code" href="structEnrollDataSL1.html#m5">applications</a>;
01128         }
01129 
01130     <span class="comment">// check the calculated sum: (* If applications allow selectivity do QP, else admit all applicants. *)</span>
01131     <span class="keywordflow">if</span> ( sum &lt;= targetIntake ) {
01132         <span class="comment">// admit all applicants</span>
01133         <span class="comment">//</span>
01134         <span class="keywordflow">for</span> ( stuSubSeg=0; stuSubSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; stuSubSeg++ )
01135             <span class="keywordflow">for</span> ( stuSeg=0; stuSeg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; stuSeg++ ) {
01136                 ed = &amp;enroll_data_sl1[stuSubSeg][stuSeg];
01137                 ed-&gt;<a class="code" href="structEnrollDataSL1.html#m6">offers</a> = ed-&gt;<a class="code" href="structEnrollDataSL1.html#m5">applications</a>;
01138                 total_offers[sl] += ed-&gt;<a class="code" href="structEnrollDataSL1.html#m6">offers</a>;
01139             }
01140     }
01141     <span class="keywordflow">else</span> {
01142         <span class="comment">// use quadratic program to solve</span>
01143         <span class="comment">//</span>
01144         <span class="keyword">const</span> <span class="keywordtype">int</span> size = <a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>*<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>;
01145 
01146         DiagonalMatrix  mQ(size);
01147         ColumnVector  mQdiag(size);
01148         DiagonalMatrix I(size);       I = 1;
01149         <a class="code" href="classMatrix.html">Matrix</a> mA = I;
01150         RowVector vA(size);
01151         ColumnVector  vc(size);
01152         ColumnVector  vb(size+1);                     <span class="comment">//bug</span>
01153         ColumnVector  vtmp(1);        vtmp(1) = targetIntake;
01154         ColumnVector  vOffers(size);
01155 
01156         <span class="keyword">const</span> <span class="keywordtype">int</span> K_FACTOR = 5;
01157         <span class="keywordtype">int</span> i=1;
01158 
01159         <span class="comment">// init mQdiag, vA, vc</span>
01160         <span class="keywordflow">for</span> ( stuSubSeg=0; stuSubSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; stuSubSeg++ )
01161             <span class="keywordflow">for</span> ( stuSeg=0; stuSeg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; stuSeg++ ) {
01162                 ed = &amp;enroll_data_sl1[stuSubSeg][stuSeg];
01163                 mQdiag(i) = ed-&gt;<a class="code" href="structEnrollDataSL1.html#m5">applications</a>;
01164                 vA(i) = ed-&gt;<a class="code" href="structEnrollDataSL1.html#m1">yield_rate</a>;
01165                 vc(i) = - ed-&gt;<a class="code" href="structEnrollDataSL1.html#m8">util</a> - K_FACTOR;
01166                 i++;
01167             }
01168 
01169         <span class="comment">// init mQ, mA, vb</span>
01170         vb = mQdiag &amp; vtmp;
01171         mA &amp;= vA;
01172         mA *= -1; vb *= -1;
01173 
01174         <span class="keywordflow">for</span> (i=1; i&lt;=size; i++)
01175             mQdiag(i) = 2 * K_FACTOR / max(mQdiag(i), 0.001);
01176         mQ.set_diagonal(mQdiag);
01177 
01178         <span class="comment">// here the main call</span>
01179         <span class="keywordflow">if</span> ( !<a class="code" href="classLinearAlgebra.html#d0">LinearAlgebra::quadratic_prog</a>(vc,mQ,mA,vb,vOffers) ) {
01180             vOffers = 0;
01181         }
01182 
01183         <span class="comment">// "Partition" vOffers (a list) to ed-&gt;offers (list in list)</span>
01184         <span class="keywordtype">int</span> offs;
01185         i =1;
01186 
01187         <span class="keywordflow">for</span> ( stuSubSeg=0; stuSubSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; stuSubSeg++ )
01188             <span class="keywordflow">for</span> ( stuSeg=0; stuSeg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; stuSeg++ ) {
01189                 offs = enroll_data_sl1[stuSubSeg][stuSeg].offers = int( vOffers(i++) +0.5);
01190                 total_offers[sl] += offs;
01191             }
01192     }
01193     <span class="comment">/*</span>
01194 <span class="comment">      y as prior  year's yield rates</span>
01195 <span class="comment">      z as number of applications</span>
01196 <span class="comment">      eU is expected (average)  utility</span>
01197 <span class="comment">    */</span>
01198 }
01199 
01200 <span class="comment">//------------- End of function EnrollRes::calc_enroll_offers --------//</span>
01201 
01202 <span class="comment">//----------- Begin of function PeerSchool::calc_enroll_aid --------//</span>
01211 <span class="comment">void EnrollRes::calc_enroll_aid() {</span>
01212     <span class="comment">// for sl1 temporarily</span>
01213     <span class="keyword">const</span> <span class="keywordtype">int</span> sl = 0;
01214 
01215     <span class="comment">//-------------------//</span>
01216     <span class="comment">//---- Need Aid -----//</span>
01217     <span class="comment">//-------------------//</span>
01218 
01219     <span class="keywordtype">float</span> x = 60, lastDeviate, deviate;
01220     <span class="keywordtype">float</span> inc = x / 100.f;
01221 
01222     <span class="comment">// nH = FindMinimum[(needFrObj[sL1,x]-frOfTradUGsWithNeed)^2,{x,60}][[2,1,2]];</span>
01223     <span class="comment">// FindMinimum is used in lieu of Golden Section</span>
01224     <span class="comment">//</span>
01225 
01226     <span class="keywordflow">if</span> ( calc_need_aid(x+inc) &gt; calc_need_aid(x-inc) )
01227         inc *= -1;
01228 
01229     deviate = calc_need_aid(x);
01230 
01231     <span class="keywordflow">do</span> {
01232         x += inc;
01233         lastDeviate = deviate;
01234         deviate = calc_need_aid(x);
01235     }
01236     <span class="keywordflow">while</span> ( deviate &lt; lastDeviate &amp;&amp; deviate &gt; 0 );
01237 
01238     need_upper = x;
01239     need_lower = need_upper - max_aid;
01240 
01241     <span class="comment">//-------------------//</span>
01242     <span class="comment">//---- Merit Aid ----//</span>
01243     <span class="comment">//-------------------//</span>
01244 
01245     adjust_fraction_merit_aid(fraction_sl1_offered_merit_aid);
01246 
01247     <span class="comment">// mL = FindMinimum[(meritFrObj[sL1,x]-frStudentsOfferedMeritAid)^2,{x,5}][[2,1,2]];</span>
01248     x = 5;
01249     inc = x / 100.f;
01250 
01251     <span class="keywordflow">if</span> ( calc_merit_aid(x+inc, fraction_sl1_offered_merit_aid)
01252          &gt; calc_merit_aid(x-inc, fraction_sl1_offered_merit_aid) )
01253         inc *= -1;
01254 
01255     deviate = calc_merit_aid(x, fraction_sl1_offered_merit_aid);
01256 
01257     <span class="keywordflow">do</span> {
01258         x += inc;
01259         lastDeviate = deviate;
01260         deviate = calc_merit_aid(x, fraction_sl1_offered_merit_aid);
01261     }
01262     <span class="keywordflow">while</span> ( deviate &lt; lastDeviate &amp;&amp; deviate &gt; 0 );
01263 
01264     merit_lower[sl] = x;
01265 
01266     <span class="comment">// mH = FindMinimum[(meritFrObj[sL1,x]-frMeritTop)^2,{x,6}][[2,1,2]];</span>
01267     x = 6;
01268     inc = x / 100.f;
01269 
01270     <span class="keywordflow">if</span> ( calc_merit_aid(x+inc, fraction_merit_top)
01271          &gt; calc_merit_aid(x-inc, fraction_merit_top) )
01272         inc *= -1;
01273 
01274     deviate = calc_merit_aid(x, fraction_merit_top);
01275 
01276     <span class="keywordflow">do</span> {
01277         x += inc;
01278         lastDeviate = deviate;
01279         deviate = calc_merit_aid(x, fraction_merit_top);
01280     }
01281     <span class="keywordflow">while</span> ( deviate &lt; lastDeviate &amp;&amp; deviate &gt; 0 );
01282 
01283     merit_upper[sl] = x;
01284 }
01285 
01286 <span class="comment">//------------- End of function EnrollRes::calc_enroll_aid --------//</span>
01287 
01288 <span class="comment">//----------- Begin of function EnrollRes::calc_need_aid --------//</span>
01293 <span class="comment">float EnrollRes::calc_need_aid(float aid) {</span>
01294     <span class="comment">// for sl1 temporarily</span>
01295     <span class="keyword">const</span> <span class="keywordtype">int</span> sl = 0;
01296     <a class="code" href="classPeerSchool.html">PeerSchool</a>* player = school_res.player_peer_school;
01297 
01298     <span class="comment">// (* Equals the max of % stu with need and % with need given need aid (cols DR &amp; DS);</span>
01299     <span class="comment">//  taking the max is and approximation to mitigate data problems *)</span>
01300 
01301     <span class="comment">//min &amp; max bug chea</span>
01302     <span class="keyword">const</span> <span class="keywordtype">float</span> frOfTradUGsWithNeed = max(player-&gt;<a class="code" href="classSchool.html#m28">percent_freshmen_with_need</a>, (<span class="keywordtype">float</span>)(player-&gt;<a class="code" href="classSchool.html#m29">freshmen_offered_aid</a>))  / 100.0f;
01303 
01304     <span class="comment">// constant mulitpliers</span>
01305     <span class="comment">// refer also to "Genral: helper function: Minority, athletics, and non-traditional multipliers"</span>
01306 
01307     <span class="keywordtype">float</span> deviate = 0, cdfTmp;
01308 
01309     <span class="keywordtype">float</span> aidMinMultiplier;
01310     <span class="keywordtype">int</span> subSeg, seg;
01311     <span class="comment">//EnrollDataSL1     *ed;</span>
01312     <a class="code" href="structTalent.html">Talent</a>    *talentPtr;
01313 
01314     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
01315         <span class="keywordflow">if</span> ( subSeg == <a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a> || subSeg == <a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a> )
01316             aidMinMultiplier = 1.0f;
01317         <span class="keywordflow">else</span>
01318             aidMinMultiplier = aidMinMultipliers[minority_aid_special];
01319 
01320         <span class="keywordflow">for</span> ( seg=0; seg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; seg++ ) {
01321             <span class="comment">//ed = &amp;enroll_data_sl1[subSeg][seg];</span>
01322             talentPtr = &amp;(enroll_res.talent_array[subSeg][seg][<a class="code" href="Ostudent_8h.html#a39a29">INCOME</a>]);
01323 
01324             cdfTmp = math.get_random_gamma_CDF( aidMinMultiplier * talentPtr-&gt;<a class="code" href="structTalent.html#m0">average</a>,
01325                                                 <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(talentPtr-&gt;<a class="code" href="structTalent.html#m1">variance</a>), aid );
01326             deviate += cdfTmp * enroll_data_sl1[subSeg][seg].fraction_matrics;
01327         }
01328     }
01329 
01330     <span class="keywordflow">return</span> math.safe_pow(deviate - frOfTradUGsWithNeed, 2);
01331 
01332     <span class="comment">/*</span>
01333 <span class="comment">      nH = FindMinimum[(needFrObj[sL1,x]-frOfTradUGsWithNeed)^2,{x,60}][[2,1,2]];</span>
01334 <span class="comment"></span>
01335 <span class="comment">      nL = nH-maxAid;</span>
01336 <span class="comment"></span>
01337 <span class="comment">      needFrObj[sL1,nH_] := Plus@@Flatten[needFrObj[sL1,nH,#]&amp;/@gegs];</span>
01338 <span class="comment">      needFrObj[sL1,nH_,geg_] := With[{cdfTmp = cdf[inc,geg,nH]},</span>
01339 <span class="comment">      cdfTmp[[#]]*frPriorMatrics[geg][[#]]&amp;/@Range[7]];</span>
01340 <span class="comment"></span>
01341 <span class="comment">      cdf[var_,geg_,x_] :=</span>
01342 <span class="comment">      gammaCDF[minMultF[aid,geg]*means[var,geg][[#]],</span>
01343 <span class="comment">      variances[var,geg][[#]],</span>
01344 <span class="comment">      x]&amp;/@Range[7];</span>
01345 <span class="comment">    */</span>
01346 }
01347 
01348 <span class="comment">//------------- End of function EnrollRes::calc_need_aid --------//</span>
01349 
01350 <span class="comment">//----------- Begin of function EnrollRes::calc_merit_aid --------//</span>
01355 <span class="comment">float EnrollRes::calc_merit_aid(float aid, float base) {</span>
01356     <span class="comment">// for sl1 temporarily</span>
01357     <span class="keyword">const</span> <span class="keywordtype">int</span> sl = 0;
01358 
01359     <span class="comment">// constant mulitpliers</span>
01360     <span class="comment">// refer also to "Genral: helper function: Minority, athletics, and non-traditional multipliers"</span>
01361 
01362     <span class="keywordtype">float</span> deviate = 0, cdfTmp;
01363 
01364     <span class="keywordtype">float</span> aidMinMultiplier;
01365     <span class="keywordtype">int</span> subSeg, seg;
01366     <a class="code" href="structEnrollDataSL1.html">EnrollDataSL1</a> *ed;
01367     <span class="comment">//Talent            *talentPtr;</span>
01368 
01369     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
01370         <span class="keywordflow">if</span> ( subSeg == <a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a> || subSeg == <a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a> )
01371             aidMinMultiplier = 1.0f;
01372         <span class="keywordflow">else</span>
01373             aidMinMultiplier = aidMinMultipliers[minority_aid_special];
01374 
01375         <span class="keywordflow">for</span> ( seg=0; seg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; seg++ ) {
01376             ed = &amp;enroll_data_sl1[subSeg][seg];
01377 
01378             cdfTmp = 1 - math.get_random_gamma_CDF( aidMinMultiplier * ed-&gt;<a class="code" href="structEnrollDataSL1.html#m8">util</a>,
01379                                                     <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(ed-&gt;<a class="code" href="structEnrollDataSL1.html#m9">util_variance</a>), aid );
01380 
01381             deviate += cdfTmp * enroll_data_sl1[subSeg][seg].fraction_matrics;
01382         }
01383     }
01384 
01385     <span class="keywordflow">return</span> math.safe_pow(deviate - base, 2);
01386 
01387     <span class="comment">/*  </span>
01388 <span class="comment">        meritFrObj[sL1,mL_] := Plus@@Flatten[meritFrObj[sL1,mL,#]&amp;/@gegs];</span>
01389 <span class="comment">        meritFrObj[sL1,mL_,geg_] := With[{cdfTmp = 1-cdf[util,geg,mL]},</span>
01390 <span class="comment">        cdfTmp[[#]]*frPriorMatrics[geg][[#]]&amp;/@Range[7]];</span>
01391 <span class="comment">    */</span>
01392 }
01393 
01394 <span class="comment">//------------- End of function EnrollRes::calc_merit_aid --------//</span>
01395 
01396 <span class="comment">//----------- Begin of function EnrollRes::player_change_offers_priority --------//</span>
01402 <span class="comment">void EnrollRes::player_change_offers_priority() {</span>
01403     <span class="comment">// for sl1 temporarily</span>
01404     <span class="keyword">const</span> <span class="keywordtype">int</span> sl = 0;
01405 
01406     <span class="comment">// constant mulitpliers</span>
01407     <span class="comment">// refer also to "Genral: helper function: Minority, athletics, and non-traditional multipliers"</span>
01408     <span class="comment">//</span>
01409     <span class="comment">// (* these respresent the "boost" *)</span>
01410     <span class="keyword">const</span> <span class="keywordtype">float</span> admMinMultipliers[<a class="code" href="Oenroll_8h.html#a1">PRIORITY_LEVEL_COUNT</a>] = {
01411         1.0f, 2.0f, 3.0f
01412     };
01413 
01414     <span class="keywordtype">int</span> subSeg, seg, var;
01415     <span class="keywordtype">float</span> admMinMultiplier;
01416     <a class="code" href="structEnrollDataSL1.html">EnrollDataSL1</a> *ed;
01417 
01418     <span class="comment">// update utility on player input</span>
01419     <span class="comment">//</span>
01420     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
01421         <span class="keywordflow">if</span> ( subSeg == <a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a> || subSeg == <a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a> )
01422             admMinMultiplier = 1.0f;
01423         <span class="keywordflow">else</span>
01424             admMinMultiplier = admMinMultipliers[minority_offers_special];
01425 
01426         <span class="keywordflow">for</span> ( seg=0; seg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; seg++ ) {
01427             ed = &amp;enroll_data_sl1[subSeg][seg];
01428             ed-&gt;<a class="code" href="structEnrollDataSL1.html#m8">util</a> = ed-&gt;<a class="code" href="structEnrollDataSL1.html#m9">util_variance</a> = 0.0f;
01429 
01430             <span class="keywordflow">for</span> ( var=0; var&lt;<a class="code" href="Ostudent_8h.html#a39a25">TALENT_VAR_COUNT</a>; var++ ) {
01431                 ed-&gt;<a class="code" href="structEnrollDataSL1.html#m8">util</a> += float(offers_priority[var]) / <a class="code" href="Oenroll_8h.html#a0">MAX_TALENT_PRIORITY_LEVEL</a> * admMinMultiplier * enroll_res.talent_array[subSeg][seg][var].average;
01432                 ed-&gt;<a class="code" href="structEnrollDataSL1.html#m9">util_variance</a> += math.safe_pow(offers_priority[var] / <a class="code" href="Oenroll_8h.html#a0">MAX_TALENT_PRIORITY_LEVEL</a>,2) * enroll_res.talent_array[subSeg][seg][var].variance;
01433             }
01434         }
01435     }
01436 }
01437 
01438 <span class="comment">//------------- End of function EnrollRes::player_change_offers_priority --------//</span>
01439 
01440 <span class="comment">//----------- Begin of function EnrollRes::calc_doctoral_intake_target --------//</span>
01442 <span class="comment">void EnrollRes::calc_doctoral_intake_target() {</span>
01443     <span class="comment">// 0113</span>
01444     <span class="keywordflow">if</span> ( player_school.doctoral_program_intensity == 0 ) {
01445         target_student_intake[<a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a>] = 0;
01446         <span class="keywordflow">return</span>;
01447     }
01448 
01449     <span class="keywordtype">int</span> i,j;
01450     <span class="keywordtype">int</span> targetTotal = 0;
01451     <a class="code" href="classCourseArray.html">CourseArray</a>* courArr;
01452     <a class="code" href="classDepartment.html">Department</a>* deptPtr;
01453 
01454     <span class="keywordflow">for</span> ( i=department_array.size(); i&gt;0; i-- ) {
01455         <span class="keywordflow">if</span> ( department_array.is_deleted(i) )
01456             <span class="keywordflow">continue</span>;
01457 
01458         deptPtr = department_array[i];
01459 
01460         <span class="keywordtype">int</span> totalBreakoutSections = 0;
01461         courArr = &amp;(department_array[i]-&gt;course_array);
01462 
01463         <span class="keywordflow">for</span> (j=courArr-&gt;<a class="code" href="classDynArray.html#a28">size</a>(); j&gt;0; j--) {
01464             <span class="keywordflow">if</span> ( courArr-&gt;operator[](j)-&gt;teaching_method == <a class="code" href="Ocourse_8h.html#a40a34">BREAKOUT_LAB</a> )
01465                 totalBreakoutSections++;
01466         }
01467 
01468         targetTotal += (int) max(deptPtr-&gt;<a class="code" href="classDepartment.html#m36">doctors_per_research_dollar</a> * deptPtr-&gt;<a class="code" href="classDepartment.html#m6">total_research_dollar_direct</a> * 1000,
01469                                  deptPtr-&gt;<a class="code" href="classDepartment.html#m34">init_doctor_count</a> + deptPtr-&gt;<a class="code" href="classDepartment.html#m37">breakout_section_by_doctor</a> * (totalBreakoutSections - deptPtr-&gt;<a class="code" href="classDepartment.html#m35">init_breakout_section_count</a>));
01470     }
01471 
01472     target_student_intake[<a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a>] = max(0, targetTotal - student_count[<a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a>]);
01473 
01474     <span class="keywordflow">if</span> ( target_student_intake[<a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a>] &gt; 3000 )
01475         target_student_intake[<a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a>] = 3000;         <span class="comment">// possibly above has bug</span>
01476     <span class="comment">//  else if ( target_student_intake[DOCTOR] &lt;= 0 )</span>
01477     <span class="comment">//          target_student_intake[DOCTOR] = target_student_intake[MASTER];</span>
01478 
01479     <a class="code" href="ALL_8H.html#a0">err_when</a>(targetTotal &lt; 0);
01480 
01481     <span class="comment">//-------- fix: use the updated target_student_intake[] to recalculate base_apps --------//</span>
01482 
01483     <span class="keywordflow">if</span>( info.prerun_year==1 ) {
01484         <a class="code" href="structEnrollData.html">EnrollData</a>* edSL;
01485         <span class="keywordtype">int</span> sl=3;
01486 
01487         <span class="comment">// 0.3 -&gt; 30%</span>
01488         <span class="keywordtype">float</span> studentGenderPct[<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>];
01489 
01490         <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="Gamedef_8h.html#a74a26">GENDER_ETHNIC_TYPE_COUNT</a> != <a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>);
01491         <span class="keywordtype">float</span> femalePercent = student_female_percent[sl] / 100.0f;
01492         <span class="keywordtype">float</span> minorityPercent = student_minority_percent[sl] / 100.0f;
01493 
01494         <span class="comment">//askbill inital gender percent affect future enrollment?  BUG? = 0 when sl=5</span>
01495         studentGenderPct[<a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a>] = femalePercent*minorityPercent;
01496         studentGenderPct[<a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a>] = femalePercent*(1.0f - minorityPercent);
01497         studentGenderPct[<a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a>] = (1.0f - femalePercent)*minorityPercent;
01498         studentGenderPct[<a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a>] = (1.0f - femalePercent)*(1.0f - minorityPercent);
01499 
01500         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
01501             <span class="comment">//--------- calc enroll_data_sls[][].apps_ratio, applications and conversion_rate ---------//</span>
01502             edSL = &amp;enroll_data_sls[sl-1][subSeg];
01503 
01504             edSL-&gt;<a class="code" href="structEnrollData.html#m1">base_apps</a>
01505                 <span class="comment">// 0.5: rounding</span>
01506                 = int(edSL-&gt;<a class="code" href="structEnrollData.html#m0">apps_ratio</a> * studentGenderPct[subSeg] * target_student_intake[sl] + 0.5);
01507         }
01508     }
01509 }
01510 
01511 <span class="comment">//------------- End of function EnrollRes::calc_doctoral_intake_target --------//</span>
01512 
01513 <span class="comment">//----------- Begin of function EnrollRes::calc_app_multiplier --------//</span>
01515 <span class="comment">void EnrollRes::calc_app_multiplier(char sl) {</span>
01516     <span class="keyword">const</span> <span class="keywordtype">int</span> VAR_COUNT = 3;
01517     <span class="keywordtype">float</span> input[VAR_COUNT];
01518     <span class="keywordtype">int</span> i;
01519 
01520     <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a> != 0);
01521     <a class="code" href="ALL_8H.html#a0">err_when</a>(sl&gt;=<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>);
01522 
01523     <span class="keywordflow">if</span> ( sl == <a class="code" href="Ostudent_8h.html#a32a7">DISTANCE_LEARN</a> ) {
01524         <span class="keywordtype">float</span> in=0;
01525 
01526         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m=THIS_MONTH; m&gt;=THIS_MONTH-info.graph_month_passed+1; m--)
01527             in += library_tech_office.tech_utilization_history[m];
01528 
01529         <span class="comment">//## org.</span>
01530         in = math.single_response_func(0.0f, 1.5f, 10.0f, 5.0f, in/100);
01531 
01532         <span class="comment">//              app_multiplier[sl] = math.latency_func(0.3f, app_multiplier[sl], in);</span>
01533         <span class="comment">//## chea 300899 change latency_func(HE.RespF_Defs.Rev 230899 E-mail)</span>
01534         app_multiplier[sl] = player_school.latency_func(0.25f, app_multiplier[sl], in);
01535 
01536     }
01537     <span class="keywordflow">else</span> {
01538         <span class="comment">// Applications multiplier: on-campus students // 1009 response_func</span>
01539         <span class="comment">//</span>
01540 
01541         memset(input, 0, <span class="keyword">sizeof</span>(input));
01542 
01543         <span class="comment">//-------------------//</span>
01544         input[0] = school_res.player_peer_school-&gt;prestige;
01545 
01546         <span class="comment">//-------------------//</span>
01547         <span class="comment">// (minor bug) should depend on [sl]</span>
01548         input[1] = player_school.satisfaction_overall[THIS_MONTH];
01549 
01550         <span class="comment">//-------------------//</span>
01551         <span class="keywordtype">int</span> totalTargetIntake = 0;
01552 
01553         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; i++)
01554             totalTargetIntake += target_student_intake[i];
01555 
01556         <span class="comment">//min &amp; max bug chea</span>
01557         input[2] = max(1000.0f, <span class="keywordtype">float</span>(finance.projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a54">AC_ENROLLMENT_MANAGEMENT</a>].this_year.total)) / totalTargetIntake;
01558 
01559         <span class="keywordflow">if</span> ( input[2] == 0 )
01560             input[2] = 1;
01561 
01562         input[2] *= (float) finance.cost_rise_policy_array[<a class="code" href="Ofinance_8h.html#a112a85">PL_ENROLLMENT_MANAGEMENT</a>].penalty_multiplier1;
01563 
01564         <span class="comment">//-------------------//</span>
01565         <span class="keywordtype">float</span> weight[VAR_COUNT] = { 0.35f, 0.3f, 0.35f };
01566         <span class="keywordtype">float</span> newValue = 0;
01567         <span class="keywordflow">for</span> (i=0; i&lt;VAR_COUNT; i++)
01568             newValue += input[i] * weight[i];
01569 
01570         <span class="comment">//-------------------//</span>
01571 
01572         <span class="comment">//## chea 300899 change latency_func(HE.RespF_Defs.Rev 230899 E-mail)</span>
01573         app_multiplier[sl] = max(0.7f,min(1.3f, player_school.latency_func(0.8f, app_multiplier[sl], newValue)));
01574     }
01575 
01576     <span class="comment">//-------------------//</span>
01577     <span class="comment">// calc yield_multiplier</span>
01578     <span class="comment">//-------------------//</span>
01579     <span class="keywordtype">float</span> weight[VAR_COUNT] = { 0.35f, 0.5f, 0.15f};
01580     <span class="keywordtype">float</span> newValue = 0;
01581 
01582     <span class="keywordflow">for</span> (i=0; i&lt;VAR_COUNT; i++)
01583         newValue += input[i] * weight[i];
01584 
01585     <span class="comment">//-------------------//</span>
01586 
01587     <span class="comment">//## chea 300899 change latency_func(HE.RespF_Defs.Rev 230899 E-mail)</span>
01588     yield_multiplier[sl] = max(0.7f,min(1.3f, player_school.latency_func(0.80f, yield_multiplier[sl], newValue)));
01589 
01590 }
01591 
01592 <span class="comment">//----------- End of function EnrollRes::calc_app_multiplier --------//</span>
01593 
01594 <span class="comment">//----------- Begin of function EnrollRes::calc_post_enroll --------//</span>
01598 <span class="comment">void EnrollRes::calc_post_enroll() {</span>
01599     <span class="comment">// for sl1 temporarily</span>
01600     <span class="keyword">const</span> <span class="keywordtype">int</span> sl = <a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>;                    <span class="comment">// 0305</span>
01601 
01602     <span class="comment">//-------------------------//</span>
01603     <span class="comment">//           generate student               //</span>
01604     <span class="comment">//-------------------------//</span>
01605     <span class="comment">// refer to td3.4 section 2.7</span>
01606 
01607     <span class="keywordtype">char</span> subSeg, seg;
01608     <span class="keywordtype">int</span> newStudentCount, i, t, aid=0;
01609 
01610     <span class="comment">// temp vars storing new sim properties</span>
01611     <span class="keywordtype">float</span> talentArr[<a class="code" href="Ostudent_8h.html#a39a25">TALENT_VAR_COUNT</a>];
01612     <span class="keywordtype">int</span> maleCount=0, femaleCount=0;
01613 
01614     avg_athletic_talent_male_matrics = 0;
01615     avg_athletic_talent_female_matrics = 0;
01616 
01617     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
01618         <span class="keywordflow">for</span> ( seg=0; seg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; seg++ ) {
01619             newStudentCount = enroll_data_sl1[subSeg][seg].matrics;
01620 
01621             <span class="keywordflow">for</span> (i=0; i&lt;newStudentCount; i++) {
01622                 <span class="comment">//---- Generate student; see also PlayerSchool::generate_student()</span>
01623                 <span class="comment">//</span>
01624                 <span class="comment">// year 1 ug student without major</span>
01625 
01626                 <span class="keywordtype">char</span> subSegStu = subSeg;
01627 
01628                 <span class="keywordflow">if</span> ( info.year_passed == 1 &amp;&amp; player_school.scenario_id == <a class="code" href="Opschool_8h.html#a63a29">SCN_STUDENT_DIVERSITY</a> ) {
01629                     <span class="keywordflow">if</span> ( is_minority_group(subSeg) &amp;&amp; math.get_random_float () &gt; 0.571f ) {
01630                         <span class="keywordflow">if</span> (subSegStu == <a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a> )
01631                             subSegStu = <a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a>;
01632                         <span class="keywordflow">else</span>
01633                             subSegStu = <a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a>;
01634                     }
01635                 }
01636 
01637                 calc_a_talent(talentArr, sl,subSegStu,seg);
01638 
01639                 department_res.general_dept.student_array.add( sl, 1, subSegStu, seg, 0, aid, talentArr );
01640 
01641 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01642 <span class="preprocessor"></span>                <span class="comment">//                              enroll_res.total_matrics++;</span>
01643 <span class="preprocessor">#endif</span>
01644 <span class="preprocessor"></span>
01645                 <span class="comment">// update vars for calc average later</span>
01646                 <span class="comment">//</span>
01647                 <span class="keywordflow">for</span> (t=0; t&lt;<a class="code" href="Ostudent_8h.html#a39a25">TALENT_VAR_COUNT</a>; t++)
01648                     talent_average[sl][t] += int( 10 * talentArr[t] );
01649 
01650                 <span class="keywordflow">if</span> ( is_male_group(subSegStu) ) {
01651                     avg_athletic_talent_male_matrics = (char) talentArr[<a class="code" href="Ostudent_8h.html#a39a28">ATHLETIC</a>];
01652                     maleCount++;
01653                 }
01654                 <span class="keywordflow">else</span> {
01655                     avg_athletic_talent_female_matrics = (char) talentArr[<a class="code" href="Ostudent_8h.html#a39a28">ATHLETIC</a>];
01656                     femaleCount++;
01657                 }
01658 
01659             }                                           <span class="comment">// for studentCount</span>
01660         }
01661     }
01662 
01663     <span class="keywordflow">if</span> ( maleCount )
01664         avg_athletic_talent_male_matrics /= maleCount;
01665 
01666     <span class="keywordflow">if</span> ( femaleCount )
01667         avg_athletic_talent_female_matrics /= femaleCount;
01668 
01669 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01670 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( sys.debug_session ) {
01671         <span class="comment">// audit_flag</span>
01672         <span class="keywordflow">for</span> ( ;; ) {
01673             <span class="keywordflow">if</span> ( TRADIT_COUNT == MAX_TRADITION_COUNT )
01674                 <span class="keywordflow">return</span>;
01675 
01676             <a class="code" href="classGeneralDepartment.html">GeneralDepartment</a>* deptPtr;
01677 
01678             deptPtr = &amp;department_res.general_dept;
01679 
01680             <span class="keywordtype">int</span> stuRecno = m.random(deptPtr-&gt;<a class="code" href="classGeneralDepartment.html#m0">student_array</a>.<a class="code" href="classDynArray.html#a28">size</a>())+1;
01681 
01682             <span class="keywordflow">if</span> ( deptPtr-&gt;<a class="code" href="classGeneralDepartment.html#m0">student_array</a>.<a class="code" href="classStudentArray.html#a9">is_deleted</a>( stuRecno ) )
01683                 <span class="keywordflow">continue</span>;
01684 
01685             <a class="code" href="classStudent.html">Student</a>* stdPtr = deptPtr-&gt;<a class="code" href="classGeneralDepartment.html#m0">student_array</a>[stuRecno];
01686 
01687             <span class="keywordflow">if</span> ( stdPtr-&gt;audit_flag )
01688                 <span class="keywordflow">continue</span>;
01689 
01690             TRADIT_COUNT++;
01691 
01692             stdPtr-&gt;audit_flag = 1;
01693 
01694             stdPtr-&gt;old_student_recno = stdPtr-&gt;<a class="code" href="classStudent.html#m0">student_recno</a>;
01695 
01696             <a class="code" href="classFile.html">File</a> file;
01697 
01698             <span class="keywordtype">char</span> fileName[123];
01699 
01700             strcpy( fileName, <span class="stringliteral">"TRADITION"</span> );
01701             strcat( fileName, m.format(stdPtr-&gt;old_student_recno) );
01702             strcat( fileName, <span class="stringliteral">".txt"</span> );
01703 
01704             file.<a class="code" href="classFile.html#a3">file_create</a>(fileName);
01705 
01706             <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"Cohort"</span> );
01707             <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
01708             <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"Trimester"</span> );
01709             <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
01710             <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"ID"</span> );
01711             <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
01712             <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"Variable"</span> );
01713             <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
01714             <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"Trimester"</span> );
01715             <a class="code" href="ogfile5_8cpp.html#a4">WRITE_RECORD_SEPARATOR</a>( (&amp;file) );
01716 
01717             <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0; i&lt;4; i++ ) {
01718                 <a class="code" href="ogfile5_8cpp.html#a2">WRITE_NUM_FIELD</a>( (&amp;file), -1 );
01719                 <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
01720                 <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"A"</span> );
01721                 <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
01722                 <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
01723                 <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"S"</span> );
01724                 <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
01725 
01726                 <span class="keywordflow">switch</span> (i) {
01727                 <span class="keywordflow">case</span> 0: <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"Courses"</span> );
01728                     <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
01729                     <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
01730                     <a class="code" href="ogfile5_8cpp.html#a2">WRITE_NUM_FIELD</a>( (&amp;file), stdPtr-&gt;<a class="code" href="classStudent.html#m11">course_per_trimester</a>[0] );
01731                     <a class="code" href="ogfile5_8cpp.html#a2">WRITE_NUM_FIELD</a>( (&amp;file), stdPtr-&gt;<a class="code" href="classStudent.html#m11">course_per_trimester</a>[1] );
01732                     <a class="code" href="ogfile5_8cpp.html#a2">WRITE_NUM_FIELD</a>( (&amp;file), stdPtr-&gt;<a class="code" href="classStudent.html#m11">course_per_trimester</a>[2] );
01733                     <span class="keywordflow">break</span>;
01734 
01735                 <span class="keywordflow">case</span> 1: <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"Status"</span> );
01736                     <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
01737                     <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
01738                     <span class="keywordflow">if</span> ( stdPtr-&gt;<a class="code" href="classStudent.html#m1">department_recno</a> ) {
01739                         <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), department_res[department_array[stdPtr-&gt;<a class="code" href="classStudent.html#m1">department_recno</a>]-&gt;department_id]-&gt;name );
01740                     }
01741                     <span class="keywordflow">else</span>
01742                         <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"Undec"</span> );
01743                     <span class="keywordflow">break</span>;
01744 
01745                 <span class="keywordflow">case</span> 2: <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"AcadTalent"</span> );
01746                     <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
01747                     <a class="code" href="ogfile5_8cpp.html#a2">WRITE_NUM_FIELD</a>( (&amp;file), stdPtr-&gt;<a class="code" href="classStudent.html#m20">talent_academic</a> );
01748                     <span class="keywordflow">break</span>;
01749                 <span class="keywordflow">case</span> 3: <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"GenEnth"</span> );
01750                     <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
01751                     <a class="code" href="ogfile5_8cpp.html#a0">WRITE_FIELD_SEPARATOR</a>( (&amp;file) );
01752                     <span class="keywordflow">switch</span>( stdPtr-&gt;<a class="code" href="classStudent.html#m3">gender_ethnic_group</a> ) {
01753                     <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a>:    <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"NM"</span> ); <span class="keywordflow">break</span>;
01754                     <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a>:  <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"NF"</span> ); <span class="keywordflow">break</span>;
01755                     <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a>:     <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"MM"</span> ); <span class="keywordflow">break</span>;
01756                     <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a>:   <a class="code" href="ogfile5_8cpp.html#a1">WRITE_STR_FIELD</a>( (&amp;file), <span class="stringliteral">"MF"</span> ); <span class="keywordflow">break</span>;
01757                     }
01758                     <span class="keywordflow">break</span>;
01759                 }
01760                 <a class="code" href="ogfile5_8cpp.html#a4">WRITE_RECORD_SEPARATOR</a>( (&amp;file) );
01761             }
01762 
01763             file.<a class="code" href="classFile.html#a5">file_close</a>();
01764         }
01765     }
01766 <span class="preprocessor">#endif</span>
01767 <span class="preprocessor"></span>
01768 }
01769 
01770 <span class="comment">//------------- End of function EnrollRes::calc_post_enroll --------//</span>
01771 
01772 <span class="comment">//------------- End of function EnrollRes::calc_post_enroll_adjust_aid_all_sls --------//</span>
01773 <span class="comment">//</span>
01774 <span class="comment">//</span>
01775 <span class="keywordtype">void</span> EnrollRes::calc_post_enroll_adjust_aid_all_sls() {
01776 
01777 }
01778 
01779 <span class="comment">//------------- End of function EnrollRes::calc_post_enroll_adjust_aid_all_sls --------//</span>
01780 
01781 <span class="comment">//----------- Begin of function EnrollRes::init_data_sl1 --------//</span>
01787 <span class="comment">void EnrollRes::init_data_sl1() {</span>
01788     <span class="comment">// for sl1 temporarily</span>
01789     <span class="keyword">const</span> <span class="keywordtype">int</span> sl = 0;
01790 
01791     <span class="comment">// -------- update target_student_intake -------- //</span>
01792     <span class="comment">// init target_student_intake for interface</span>
01793     <span class="comment">//</span>
01794     <span class="comment">// "The intake target is a player decision"</span>
01795     <span class="comment">// the *initialization* value can be obtained from "he.gdb.init:student_pars" by</span>
01796     <span class="comment">// multiplying the percent of students in the first year times the total</span>
01797     <span class="comment">// number of students for the student level. eg, for traditional</span>
01798     <span class="comment">// undergraduates (sl-1), it's ab19*c8.</span>
01799 
01800     <span class="comment">//optional // 0304</span>
01801     memset(target_student_intake, 0, <span class="keyword">sizeof</span>(target_student_intake));
01802 
01803     <span class="keywordflow">for</span> (<span class="keywordtype">char</span> s=0; s&lt;=<a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a>; s++) {
01804         <span class="comment">/*              if( s &lt;= UG_NONTRADITION )</span>
01805 <span class="comment">                        {</span>
01806 <span class="comment">                        target_student_intake[s]</span>
01807 <span class="comment">                        = int(student_count[s] * player_school.year_in_program_pct[s][0]);      // 0: year 1</span>
01808 <span class="comment">                        }</span>
01809 <span class="comment">                        else */</span>
01810 
01811         <span class="keywordflow">if</span> ( s &lt;= <a class="code" href="Ostudent_8h.html#a32a5">MASTER</a> ) {
01812             <span class="comment">//--- the current student_count[] is the total number of student excluding year 0 student.We divide it by (1 - percent) to restore the total number including year 0 student.</span>
01813 
01814             target_student_intake[s] = int(
01815                 (<span class="keywordtype">float</span>) student_count[s] / (1.0f - player_school.year_in_program_pct[s][0])
01816                 * player_school.year_in_program_pct[s][0] );
01817         }
01818         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( s == <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a> ) {
01819             <span class="keywordtype">float</span> total = 0;
01820 
01821             <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> d=department_array.size(); d&gt;0; d--) {
01822                 total += department_res[department_array[d]-&gt;department_id]-&gt;doctor_year_in_program_pct[0];
01823             }
01824 
01825             total /= department_array.size();
01826 
01827             target_student_intake[s] = int( student_count[s] * total );
01828         }
01829     }
01830 
01831     target_student_intake[<a class="code" href="Ostudent_8h.html#a32a7">DISTANCE_LEARN</a>] = target_student_intake[<a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>];
01832 
01833     <span class="keywordtype">int</span> initial_intake = int(1.05 * target_student_intake[sl] + 0.5);
01834 
01835     <a class="code" href="ALL_8H.html#a0">err_when</a>(initial_intake==0);
01836     <span class="comment">/*</span>
01837 <span class="comment">      // 990525</span>
01838 <span class="comment">      for (s=0; s&lt;MAX_STUDENT_LEVEL; s++)</span>
01839 <span class="comment">      target_student_intake[s] = min( target_student_intake[s], student_count[s] );</span>
01840 <span class="comment">    */</span>
01841     <span class="comment">//----------------------------------//</span>
01842 
01843     <a class="code" href="classPeerSchool.html">PeerSchool</a>* player = school_res.player_peer_school;
01844     <span class="keywordtype">int</span> stuSubSeg, stuSeg, i=0;
01845 
01846     <span class="comment">// update vars before calc_student_pref_vars_array()</span>
01847     applications_rate[sl] = player-&gt;<a class="code" href="classSchoolEx.html#m61">ug_applications_rate</a>;
01848     cur_yield_rate[sl] = player-&gt;<a class="code" href="classSchoolEx.html#m62">ug_yield_rate</a> / 100.0f;
01849     <span class="comment">//offers_rate[sl]</span>
01850 
01851     <span class="comment">// call twice in order to update the array pref_vars_array_last</span>
01852     player-&gt;<a class="code" href="classPeerSchool.html#a1">calc_student_pref_vars_array</a>();
01853     player-&gt;<a class="code" href="classPeerSchool.html#a1">calc_student_pref_vars_array</a>();
01854 
01855     calc_student_pref();
01856     calc_app_yield();                               <span class="comment">// calc enroll_data_sl1's members apps_ratio, yield_rate;</span>
01857 
01858     <span class="comment">// calc enroll_data's memebers</span>
01859     <span class="comment">//</span>
01860     <span class="keywordflow">for</span> ( stuSubSeg=0; stuSubSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; stuSubSeg++ ) {
01861         <span class="keywordflow">for</span> ( stuSeg=0; stuSeg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; stuSeg++ ) {
01862             <a class="code" href="structEnrollDataSL1.html">EnrollDataSL1</a> * ed = &amp;enroll_data_sl1[stuSubSeg][stuSeg];
01863 
01864             ed-&gt;<a class="code" href="structEnrollDataSL1.html#m5">applications</a> = int(ed-&gt;<a class="code" href="structEnrollDataSL1.html#m0">apps_ratio</a> * ed-&gt;<a class="code" href="structEnrollDataSL1.html#m4">fraction_matrics</a> * initial_intake + 0.5);
01865             ed-&gt;<a class="code" href="structEnrollDataSL1.html#m2">base_apps</a> = ed-&gt;<a class="code" href="structEnrollDataSL1.html#m5">applications</a>;
01866 
01867             ed-&gt;<a class="code" href="structEnrollDataSL1.html#m3">base_yield_rate</a> = ed-&gt;<a class="code" href="structEnrollDataSL1.html#m1">yield_rate</a>;
01868             ed-&gt;<a class="code" href="structEnrollDataSL1.html#m6">offers</a> = ed-&gt;<a class="code" href="structEnrollDataSL1.html#m7">matrics</a> = 0;
01869 
01870             <a class="code" href="ALL_8H.html#a0">err_when</a>(ed-&gt;<a class="code" href="structEnrollDataSL1.html#m2">base_apps</a> &lt; 0);
01871         }
01872     }
01873 
01874     <span class="comment">//---------------------------------------------------------------//</span>
01875     <span class="comment">// set member variables for default player settings</span>
01876     <span class="comment">//</span>
01877     <span class="comment">// init player input here</span>
01878 
01879     <span class="comment">// for calc_offers</span>
01880 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01881 <span class="preprocessor"></span>    <span class="keywordflow">switch</span> ( player_school.athletic_program_intensity ) {
01882     <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a73a22">INPUT_LOW</a>:   offers_priority[2] = 3; <span class="keywordflow">break</span>;
01883     <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a73a23">INPUT_MEDIUM</a>:  offers_priority[2] = 5; <span class="keywordflow">break</span>;
01884     <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a73a24">INPUT_HIGH</a>:    offers_priority[2] = 7; <span class="keywordflow">break</span>;
01885     }
01886     <span class="keywordflow">switch</span>( player_school.prestige ) {
01887     <span class="keywordflow">case</span> 1: offers_priority[0] = offers_priority[1] = 3; <span class="keywordflow">break</span>;
01888     <span class="keywordflow">case</span> 3: offers_priority[0] = offers_priority[1] = 5; <span class="keywordflow">break</span>;
01889     <span class="keywordflow">case</span> 10: offers_priority[0] = offers_priority[1] = 7;<span class="keywordflow">break</span>;
01890     }
01891 <span class="preprocessor">#else</span>
01892 <span class="preprocessor"></span>    offers_priority[0] = offers_priority[1] = offers_priority[2] = char(<a class="code" href="Oenroll_8h.html#a0">MAX_TALENT_PRIORITY_LEVEL</a> / 2);
01893 <span class="preprocessor">#endif</span>
01894 <span class="preprocessor"></span>    minority_offers_special = <a class="code" href="Oenroll_8h.html#a35a27">SET_LOW</a>;
01895     athlete_offers_special = <a class="code" href="Oenroll_8h.html#a35a27">SET_LOW</a>;
01896     player_change_offers_priority();                <span class="comment">// called before calc_enroll_aid() below</span>
01897 
01898     <span class="comment">// for calc_aid</span>
01899     fraction_sl1_offered_merit_aid = 0.25f;         <span class="comment">//</span>
01900     fraction_sl2_offered_aid = 0.0f;                <span class="comment">// 990407 0.2f</span>
01901     minority_aid_special = <a class="code" href="Oenroll_8h.html#a35a27">SET_LOW</a>;
01902     athlete_aid_special = <a class="code" href="Oenroll_8h.html#a35a27">SET_LOW</a>;
01903     calc_enroll_aid();
01904 
01905     <span class="comment">// for gen sims</span>
01906     fraction_need_covered = 0.10f;                  <span class="comment">// 990407 0.5f</span>
01907     aid_budget_enforced = <span class="keyword">false</span>;                    <span class="comment">// 0405 = true</span>
01908     <span class="comment">// aidBudget                                        = 8000; (* from financial module; $000 *)</span>
01909 
01910     <span class="comment">//---------------------------------------------------------------//</span>
01911 
01912     <span class="comment">//-------- for calc_matrics ----------//</span>
01913     <span class="comment">// init this from base class School/SchoolEx</span>
01914     <span class="comment">// frOnAid[init]                            = 0.63;  (* cell DQ1238 in 'Initial_Conditions' *)</span>
01915     <span class="comment">// aveAid[init]                             = 4089 * (1.04)^5; (* cell DU updated from 1994 *)</span>
01916     <span class="comment">// PeerSchool* player = school_res.player_peer_school;</span>
01917 
01918     <span class="comment">// cell DQ</span>
01919     <span class="keywordtype">float</span> overAllFraction = player-&gt;<a class="code" href="classSchool.html#m114">percent_ug_students_on_aid</a>;
01920     <span class="comment">// cell DU</span>
01921     <span class="keywordtype">float</span> overAllAverage  = (float) player-&gt;<a class="code" href="classSchool.html#m35">institutional_aid_per_fte</a>;
01922 
01923     fraction_on_aid[<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>] = overAllFraction;<span class="comment">// 0.63f;</span>
01924     fraction_on_aid[<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>] = overAllFraction;    <span class="comment">//0.2f;</span>
01925 
01926     <span class="comment">// 5000;</span>
01927     average_aid[<a class="code" href="Oenroll_8h.html#a32a13">NON_MINORITY</a>] = (int) overAllAverage;
01928     average_aid[<a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a>] = (int) overAllAverage;
01929 
01930     <span class="comment">//---------------------------------------------------------------//</span>
01931 
01932     <span class="keywordflow">switch</span> ( player_school.scenario_id ) {
01933     <span class="keywordflow">case</span> ( SCN_WINNING_ATHLETICS ):
01934         offers_priority[<a class="code" href="Ostudent_8h.html#a39a28">ATHLETIC</a>] = math.get_random_snd(2, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.5f));
01935         athlete_offers_special = <a class="code" href="Oenroll_8h.html#a35a27">SET_LOW</a>;
01936         athlete_aid_special = <a class="code" href="Oenroll_8h.html#a35a27">SET_LOW</a>;
01937         <span class="keywordflow">break</span>;
01938     }
01939 }
01940 
01941 <span class="comment">//------------- End of function EnrollRes::init_data_sl1 --------//</span>
01942 
01943 <span class="comment">//----------- Begin of function EnrollRes::init_data --------//</span>
<a name="l01950"></a><a class="code" href="classEnrollRes.html#a5">01950</a> <span class="comment">void EnrollRes::init_data() {</span>
01951     <span class="keywordtype">int</span> progressIndex = 70;
01952 
01953     calc_student_count();
01954 
01955     <span class="keywordtype">int</span> schoolCount = school_res.peer_school_count;
01956 
01957     <span class="comment">// array includes PGI and peer schools</span>
01958     <a class="code" href="classPeerSchool.html">PeerSchool</a> *peerSch = school_res.peer_school_array;
01959 
01960     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;schoolCount; i++, peerSch++) {
01961         peerSch-&gt;<a class="code" href="classPeerSchool.html#a1">calc_student_pref_vars_array</a>();
01962         peerSch-&gt;<a class="code" href="classPeerSchool.html#a1">calc_student_pref_vars_array</a>();
01963     }
01964 
01965     <span class="comment">// peerSch = school_res.player_peer_school;</span>
01966 
01967     <span class="comment">// call twice to update the array pref_vars_average_array_last</span>
01968     <a class="code" href="classPeerSchool.html#d0">PeerSchool::calc_student_pref_vars_average_array</a>();
01969     <a class="code" href="classPeerSchool.html#d0">PeerSchool::calc_student_pref_vars_average_array</a>();
01970 
01971     <span class="comment">// simulate player school ***ONLY***</span>
01972 
01973     <span class="comment">//askbill do? td3.4 section 3.4: Model Initialization for all sl</span>
01974 
01975     <a class="code" href="classPeerSchool.html">PeerSchool</a> *playerSchool = school_res.player_peer_school;
01976     <span class="comment">// 0118 for calc_aid</span>
01977     student_office.room_n_board_rate = playerSchool-&gt;<a class="code" href="classSchoolEx.html#m45">room_and_board_rate</a>;
01978 
01979     init_data_sl1();
01980 
01981     <span class="keywordflow">for</span> (<span class="keywordtype">char</span> sl=<a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>; sl&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; sl++) {
01982         init_data_sls(sl);
01983     }
01984 
01985     calc_talent_student_db();
01986 }
01987 
01988 <span class="comment">//------------- End of function EnrollRes::init_data --------//</span>
01989 
01990 <span class="comment">//----------- Begin of function EnrollRes::enroll_main --------//</span>
<a name="l01996"></a><a class="code" href="classEnrollRes.html#a6">01996</a> <span class="comment">void EnrollRes::enroll_main(int initFlag) {</span>
01997     <span class="comment">// assume PGI's PeerSchool (school_res.player_peer_school) is pointing</span>
01998     <span class="comment">// to peer_school_array in school_res.build_peer_school</span>
01999     <span class="comment">//</span>
02000     <span class="keywordtype">int</span> i, schoolCount = school_res.peer_school_count;
02001     <a class="code" href="classPeerSchool.html">PeerSchool</a> *peerSch = school_res.peer_school_array;
02002 
02003     <span class="comment">// pre-calculation for peerSch-&gt;calc_enroll_*</span>
02004     <span class="comment">//</span>
02005     <span class="keywordflow">for</span> (i=0; i&lt;schoolCount; i++, peerSch++)        <span class="comment">// PGI and/or peer schools</span>
02006         peerSch-&gt;<a class="code" href="classPeerSchool.html#a1">calc_student_pref_vars_array</a>();
02007 
02008     <span class="comment">// pref_vars_average_array is useful for calc_enroll_apps&amp;matrics()</span>
02009     <a class="code" href="classPeerSchool.html#d0">PeerSchool::calc_student_pref_vars_average_array</a>();
02010 
02011     <span class="comment">//------- main calls --------//</span>
02012 
02013     <span class="comment">// initialize intermediate variables</span>
02014 
02015     <span class="comment">//peerSch = school_res.player_peer_school;</span>
02016     <span class="comment">//peerSch-&gt;calc_student_pref_vars_array();  // called above</span>
02017 
02018     <span class="comment">// (* Equals tuition rate + room and board rate (cols BE &amp; BF) + an</span>
02019     <span class="comment">// allowance for incidentials (=$2,000), adjusted to thousands of dollars. *)</span>
02020     <a class="code" href="classPeerSchool.html">PeerSchool</a>* player = school_res.player_peer_school;
02021 
02022     <span class="comment">//990408 max_aid = ( finance.tuition_rate + student_office.room_n_board_rate + 2000 ) / 1000.0f;            //</span>
02023     max_aid = ( finance.tuition_rate ) / 1000.0f;
02024     total_aid = 0;                                  <span class="comment">// this will be calculated in this function</span>
02025 
02026     <span class="comment">// for IF</span>
02027     <span class="comment">// percent_minority = 0;</span>
02028     memset(talent_average, 0, <span class="keyword">sizeof</span>(talent_average));
02029 
02030     <span class="comment">//-------- update for player input ---------//</span>
02031 
02032     calc_doctoral_intake_target();
02033     player_change_offers_priority();
02034     calc_enroll_aid();
02035 
02036     <span class="keywordflow">for</span> (<span class="keywordtype">char</span> sl=<a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>; sl&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; sl++) {
02037         calc_enroll_aid_sls(sl);
02038     }
02039 
02040     <span class="comment">//-------- update pi for enroll ---------//</span>
02041 
02042     <span class="keywordflow">for</span> (sl=0; sl&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; sl++)
02043         calc_app_multiplier(sl);
02044 
02045     <span class="comment">//------------- SL1 -------------//</span>
02046     <span class="comment">// main procedures of enrollment</span>
02047     calc_enroll_applications();
02048     calc_enroll_offers();
02049     calc_enroll_matriculations();
02050     calc_post_enroll();
02051 
02052     <span class="comment">//------------- SL2-5 -------------//</span>
02053 
02054     <span class="keywordflow">for</span> ( sl=<a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>; sl&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; sl++) {
02055 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
02056 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( sl==<a class="code" href="Ostudent_8h.html#a32a7">DISTANCE_LEARN</a> )
02057             <span class="keywordflow">continue</span>;
02058 <span class="preprocessor">#endif</span>
02059 <span class="preprocessor"></span>        enroll_main_sls(sl);
02060         calc_post_enroll_sls(sl);
02061     }
02062 
02063     calc_student_count();
02064 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
02065 <span class="preprocessor"></span>    <span class="comment">// will update this two once a year</span>
02066     <span class="keywordflow">if</span> ( (info.game_month == 9) &amp;&amp; (info.game_day == 1) ) {
02067         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>-1; i++ ) {
02068             last_year_student_count[i] = new_year_student_count[i];
02069             new_year_student_count[i] = student_count[i];
02070 
02071             <span class="keywordflow">if</span> ( info.prerun_year &amp;&amp; info.game_year == 1 )
02072                 target_enrollment[i] = new_year_student_count[i];
02073             <span class="comment">// for year 1 only copy doctor</span>
02074             <span class="keywordflow">if</span> ( info.prerun_year &amp;&amp; info.game_year == 2 &amp;&amp; i == <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a> )
02075                 target_enrollment[i] = new_year_student_count[i];
02076         }
02077     }
02078 <span class="preprocessor">#endif</span>
02079 <span class="preprocessor"></span>    calc_total_aid();
02080     <span class="comment">//calc_post_enroll_adjust_aid_all_sls();</span>
02081 
02082     <a class="code" href="ALL_8H.html#a0">err_when</a>(total_aid &gt; max_aid * total_student_count);
02083     update_enroll_history();
02084 
02085     <span class="comment">//---------------------------------//</span>
02086 
02087     <span class="keywordflow">if</span> ( initFlag &gt; 0 &amp;&amp; player_school.scenario_id == <a class="code" href="Opschool_8h.html#a63a29">SCN_STUDENT_DIVERSITY</a> ) {
02088         player_school.scenario_base = overall_percent_minority;
02089         player_school.scenario_target[0] = min(100, <span class="keywordtype">int</span>(5.0f * overall_percent_minority));
02090         player_school.scenario_max_game_years = 7;
02091     }
02092 }
02093 
02094 <span class="comment">//------------- End of function EnrollRes::enroll_main --------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:28 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
