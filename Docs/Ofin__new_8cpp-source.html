<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Ofin_new.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Ofin_new.cpp</h1><a href="Ofin__new_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename   : OFIN_NEW.CPP</span>
00002 <span class="comment">//Description: New fiscal year report</span>
00003 
00004 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00005 <span class="preprocessor">#include &lt;OIFACE.H&gt;</span>
00006 <span class="preprocessor">#include &lt;OMATH.H&gt;</span>
00007 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00008 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00009 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00010 <span class="preprocessor">#include &lt;OCONFIG.H&gt;</span>
00011 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>
00012 <span class="preprocessor">#include &lt;OOPT.H&gt;</span>
00013 <span class="preprocessor">#include &lt;OMOUSE.H&gt;</span>
00014 <span class="preprocessor">#include &lt;ODEPT.H&gt;</span>
00015 <span class="preprocessor">#include &lt;OBUTTON.H&gt;</span>
00016 <span class="preprocessor">#include &lt;OLETTER.H&gt;</span>
00017 <span class="preprocessor">#include &lt;<a class="code" href="OWORLD_8H.html">OWORLD.H</a>&gt;</span>
00018 <span class="preprocessor">#include &lt;OFONT.H&gt;</span>
00019 <span class="preprocessor">#include &lt;OFINANCE.H&gt;</span>
00020 <span class="preprocessor">#include &lt;OAUDIO.H&gt;</span>
00021 <span class="preprocessor">#include &lt;OATHLETI.H&gt;</span>
00022 <span class="preprocessor">#include &lt;OENROLL.H&gt;</span>
00023 
00024 <span class="comment">//------- define constant -----------//</span>
00025 
00026 <span class="keyword">enum</span> {
00027     <a class="code" href="Ofin__new_8cpp.html#a14a5">BUTTON_Y1</a>=<a class="code" href="Oworldmt_8h.html#a15">ZOOM_Y2</a>-31,
00028     <a class="code" href="Ofin__new_8cpp.html#a14a6">BUTTON_Y2</a>=<a class="code" href="Ofin__new_8cpp.html#a14a5">BUTTON_Y1</a>+24
00029 };
00030 
00031 <span class="keyword">enum</span> {
00032     <a class="code" href="Ofin__new_8cpp.html#a15a7">BUTTON_BACK_WIDTH</a> = 80,
00033     <a class="code" href="Ofin__new_8cpp.html#a15a8">BUTTON_NEXT_WIDTH</a> = 80,
00034     <a class="code" href="Ofin__new_8cpp.html#a15a9">BUTTON_DISTANCE</a> = 60
00035 };
00036 
00037 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00038 <span class="preprocessor"></span><span class="keyword">enum</span> {
00039     FACULTY_LISTS,
00040     FACULTY_DETAILS,
00041 };
00042 <span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044 <span class="comment">//---------- Define static vars ----------//</span>
00045 
00046 <span class="keyword">static</span> report_screen_id;
00047 <span class="keyword">static</span> <a class="code" href="classButton.html">Button</a> button_back, button_next;
00048 
00049 <span class="comment">//--------- Define static functions ----------//</span>
00050 
00051 <span class="keyword">static</span> <span class="keywordtype">void</span> screen_intro();
00052 <span class="keyword">static</span> <span class="keywordtype">void</span> screen_opt_intro();
00053 <span class="keyword">static</span> <span class="keywordtype">void</span> screen_last_year_finance(<span class="keywordtype">int</span> reportOrder, <span class="keywordtype">int</span> reportType, <span class="keywordtype">int</span> reportYear, <span class="keywordtype">char</span>* reportTitle, <span class="keywordtype">int</span> refreshFlag);
00054 <span class="keyword">static</span> <span class="keywordtype">void</span> screen_last_year_finance_detect(<span class="keywordtype">int</span> reportType, <span class="keywordtype">int</span> reportYear);
00055 <span class="keyword">static</span> <span class="keywordtype">int</span> screen_keeping;
00056 <span class="keyword">static</span> <span class="keywordtype">int</span> speed_keeping;
00057 
00058 <span class="comment">//----- Begin of function Finance::new_fiscal_year -----//</span>
00059 
<a name="l00060"></a><a class="code" href="classFinance.html#a21">00060</a> <span class="keywordtype">void</span> <a class="code" href="classFinance.html#a21">Finance::new_fiscal_year</a>() {
00061     <span class="keywordflow">if</span> ( !<a class="code" href="classFinance.html#a27">update_projected_arrays_pre_optimization</a>() )
00062         <span class="keywordflow">return</span>;
00063 
00064     <span class="comment">//---- apply the game setting "relative wealth" effect to surplus/deficit ---//</span>
00065 
00066     <span class="keywordflow">if</span>( info.prerun_year==1 ) {
00067         <span class="comment">//--- special case handling: set last year sponsored research revenue's all 12 months to it last month identically ---//</span>
00068 
00069         <span class="keywordtype">int</span> i=<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>;
00070 
00071         <a class="code" href="classFinance.html#m3">revenue_array</a>[i].<a class="code" href="structRevenueItem.html#m0">direct</a> =  <a class="code" href="classFinance.html#m13">projected_revenue_array</a>[i].<a class="code" href="structRevenueItemChange.html#m4">last_month</a>.<a class="code" href="structRevenueItem.html#m0">direct</a> * 12;
00072         <a class="code" href="classFinance.html#m3">revenue_array</a>[i].<a class="code" href="structRevenueItem.html#m1">indirect</a> =  <a class="code" href="classFinance.html#m13">projected_revenue_array</a>[i].<a class="code" href="structRevenueItemChange.html#m4">last_month</a>.<a class="code" href="structRevenueItem.html#m1">indirect</a> * 12;
00073         <a class="code" href="classFinance.html#m3">revenue_array</a>[i].<a class="code" href="structRevenueItem.html#m2">total</a> =  <a class="code" href="classFinance.html#m13">projected_revenue_array</a>[i].<a class="code" href="structRevenueItemChange.html#m4">last_month</a>.<a class="code" href="structRevenueItem.html#m2">total</a> * 12;
00074 
00075         <span class="comment">//---- special case handling: adjust sponsored research expense -------//</span>
00076 
00077         i=<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>;
00078 
00079         <span class="keywordtype">double</span> totalRevenue = <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].direct;
00080 
00081         <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m0">faculty</a> = totalRevenue * <a class="code" href="classFinance.html#m57">research_expense_fac_ratio</a>;
00082         <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m1">staff</a> = totalRevenue * <a class="code" href="classFinance.html#m58">research_expense_staff_ratio</a>;
00083         <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m2">other</a> = totalRevenue * ( 1-<a class="code" href="classFinance.html#m57">research_expense_fac_ratio</a>-<a class="code" href="classFinance.html#m58">research_expense_staff_ratio</a>);
00084         <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m3">total</a> = <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m0">faculty</a> + <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m1">staff</a> + <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m2">other</a>;
00085 
00086         <span class="comment">//--- special case handling: set endowment spending based on endowment asset (endowment spending generated is too small and has to be re-calculated) ----//</span>
00087 
00088 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00089 <span class="preprocessor"></span>        <span class="comment">// no longer need that</span>
00090         <span class="comment">// revenue_array[AC_ENDOWMENT_SPENDING].total = (this_year.asset_array[AC_ENDOWMENT]+this_year.asset_array[AC_QUASI]) * math.get_random_snd(0.94f,0.003f) * 0.05f;</span>
00091 <span class="preprocessor">#else</span>
00092 <span class="preprocessor"></span>        <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].total = <a class="code" href="classFinance.html#m18">this_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>] * math.get_random_snd(0.94f,0.003f) * 0.05f;
00093 <span class="preprocessor">#endif</span>
00094 <span class="preprocessor"></span>
00095         <span class="comment">//----- recalculate the total for revenue_array[] &amp; expense_array[] -----//</span>
00096 
00097         <a class="code" href="classFinance.html#a29">calc_total_last_year</a>();                       <span class="comment">// it must be updated here first</span>
00098 
00099         <span class="comment">//-------- apply the Game Setting "relative wealth" effect ------//</span>
00100 
00101         apply_relative_wealth_effect();
00102 
00103         <span class="comment">//-------- re-calculate the total after the above adjustments ------------//</span>
00104 
00105         <a class="code" href="classFinance.html#a29">calc_total_last_year</a>();                       <span class="comment">// it has to be updated after apply_relative_wealth_effect() changed the operating reserve</span>
00106     }
00107 
00108     <span class="comment">//--------- generate evaluation letter ------//</span>
00109 
00110     letter.init_eval_letter();                      <span class="comment">// initialize evaluation letter</span>
00111 
00112 <span class="preprocessor">#if(GAME_VERSION&gt;=200) </span>
00113 <span class="preprocessor"></span>    {
00114         <span class="comment">// Item 7b-e)</span>
00115         <span class="comment">// if ( info.prerun_year == 0 ) // begin of 1st year also call update_appropiation</span>
00116         <span class="keywordflow">if</span> ( player_school.is_public() ) {
00117             finance.update_appropiation();              <span class="comment">// change the state appropiation</span>
00118             <span class="keywordtype">double</span> temp = finance.revenue_array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].total;
00119             <a class="code" href="structRevenueItemChange.html">RevenueItemChange</a>* projRev;
00120             projRev = &amp;finance.projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>];
00121             projRev-&gt;<a class="code" href="structRevenueItemChange.html#m6">change_budget_year</a>.<a class="code" href="structRevenueItem.html#m2">total</a>
00122                 = finance.calc_change( finance.budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].total, temp );
00123 
00124             projRev-&gt;<a class="code" href="structRevenueItemChange.html#m0">change_last_year</a>.<a class="code" href="structRevenueItem.html#m2">total</a> = finance.calc_change( projRev-&gt;<a class="code" href="structRevenueItemChange.html#m2">this_year</a>.<a class="code" href="structRevenueItem.html#m2">total</a>, temp );
00125         }
00126     }
00127 <span class="preprocessor">#endif</span>
00128 <span class="preprocessor"></span>
00129     <span class="comment">//---------- show year-end screen -----------//</span>
00130 
00131     <span class="keywordflow">if</span>( config.disp_year_end_report ) {
00132         report_screen_id = 0;
00133 
00134 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00135 <span class="preprocessor"></span>        <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=department_array.size(); i&gt;0; i-- ) {
00136             optimization.pre_target_value[i-1] = finance.hiring_policy_array[i-1].target_value;
00137 
00138             <a class="code" href="classDepartment.html">Department</a>* deptPtr = department_array[i];
00139 
00140             <span class="comment">// set the upper bound = max( 10, 2*departures[dept] )</span>
00141             faculty_res.is_year_end_report = 1;
00142             finance.hiring_policy_array[i-1].upper_bound = 10;
00143             finance.hiring_policy_array[i-1].target_value = optimization.pre_target_value[i-1] + deptPtr-&gt;faculty_departures_number();
00144             finance.hiring_policy_array[i-1].weight = 1/( max( 1, deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classDynArray.html#a28">size</a>() ) );
00145         }
00146 <span class="preprocessor">#endif</span>
00147 <span class="preprocessor"></span>
00148         sys.set_staying_view_mode(<a class="code" href="Osys_8h.html#a45a18">MODE_YEAR_END_REPORT</a>);
00149         <span class="comment">// new ring sound to be added.</span>
00150         audio.play_wav(<span class="stringliteral">"PHONE"</span>,audio.int_to_DsVolume(config.sound_effect_volume));
00151     }
00152     <span class="keywordflow">else</span> {                                          <span class="comment">//-- if the player has elected not to see the year-end report, do the optimization automatically --//</span>
00153         <span class="comment">//-----------------------------------------------------------//</span>
00154 
00155         <span class="comment">//              sys.yield();</span>
00156         <a class="code" href="classFinance.html#a11">optimize_policy_1</a>();
00157         <span class="comment">//              sys.yield();</span>
00158         <a class="code" href="classFinance.html#a12">optimize_policy_2</a>();
00159         sys.yield();
00160         <a class="code" href="classFinance.html#a10">pre_optimization_stage_3</a>();                   <span class="comment">//## fred 990507</span>
00161         <a class="code" href="classFinance.html#a13">optimize_policy_3</a>();
00162 
00163         finance.calc_budget_report();                 <span class="comment">//redundant call?         // BUGHER0 double-check the call order! //## 201199 chea have to added back in 5.1.1</span>
00164 
00165 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00166 <span class="preprocessor"></span>        <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=department_array.size(); i&gt;0; i-- ) {
00167             <span class="comment">// reset faculty target hire</span>
00168             finance.hiring_policy_array[i-1].target_value = 0;
00169         }
00170 <span class="preprocessor">#endif</span>
00171 <span class="preprocessor"></span>
00172         <span class="comment">//---- reset user preference settings after optimization -----//</span>
00173 
00174         sys.redraw_all_flag=1;
00175     }
00176 }
00177 
00178 <span class="comment">//----- End of function Finance::new_fiscal_year -----//</span>
00179 
00180 <span class="comment">//----- Begin of function Finance::new_fiscal_year_report -----//</span>
00181 
<a name="l00182"></a><a class="code" href="classFinance.html#a22">00182</a> <span class="keywordtype">void</span> <a class="code" href="classFinance.html#a17">Finance::new_fiscal_year_report</a>(<span class="keywordtype">int</span> refreshFlag) {
00183     <span class="keywordflow">switch</span>( report_screen_id ) {
00184     <span class="keywordflow">case</span> 0:
00185         screen_intro();
00186         speed_keeping=sys.save_speed;
00187         screen_keeping=sys.save_view_mode;
00188         optimization.is_optimized[0]=0;
00189         optimization.is_optimized[1]=0;
00190         optimization.is_optimized[2]=0;
00191         optimization.is_optimize_slider_modified[0]=0;
00192         optimization.is_optimize_slider_modified[1]=0;
00193         optimization.is_optimize_slider_modified[2]=0;
00194         <span class="keywordflow">break</span>;
00195 
00196     <span class="keywordflow">case</span> 1:
00197         sys.staying_view_mode=<a class="code" href="Osys_8h.html#a45a34">MODE_EVALUATION_LETTER</a>;
00198         sys.set_view_mode(<a class="code" href="Osys_8h.html#a45a34">MODE_EVALUATION_LETTER</a>);
00199         sys.save_view_mode=<a class="code" href="Osys_8h.html#a45a18">MODE_YEAR_END_REPORT</a>;
00200         <span class="comment">//                      sys.redraw_all_flag=1;</span>
00201 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00202 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00203 <span class="preprocessor"></span>        report_screen_id=2;
00204 <span class="preprocessor">#endif</span>
00205 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
00206 
00207     <span class="keywordflow">case</span> 2:
00208         <span class="comment">//                      sys.staying_view_mode=MODE_YEAR_END_REPORT;</span>
00209         <span class="comment">//                      sys.redraw_all_flag=1;</span>
00210 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00211 <span class="preprocessor"></span>        sys.staying_view_mode=MODE_STATE_REPORT;
00212         sys.set_view_mode(MODE_STATE_REPORT);
00213         sys.save_view_mode=<a class="code" href="Osys_8h.html#a45a18">MODE_YEAR_END_REPORT</a>;
00214 <span class="preprocessor">#else</span>
00215 <span class="preprocessor"></span>        screen_last_year_finance(1, <a class="code" href="Ofinance_8h.html#a92a4">REPORT_TYPE_REVENUE</a>, <a class="code" href="Ofinance_8h.html#a94a13">REPORT_YEAR_PREV</a>, <span class="stringliteral">"Revenue and expenditure statement"</span>, refreshFlag);
00216 <span class="preprocessor">#endif</span>
00217 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
00218 
00219     <span class="keywordflow">case</span> 3:
00220         screen_last_year_finance(2, <a class="code" href="Ofinance_8h.html#a92a5">REPORT_TYPE_BALANCE</a>, <a class="code" href="Ofinance_8h.html#a94a13">REPORT_YEAR_PREV</a>, <span class="stringliteral">"Balance sheet"</span>, refreshFlag);
00221         <span class="keywordflow">break</span>;
00222 
00223 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00224 <span class="preprocessor"></span>    <span class="keywordflow">case</span> 4:  player_school.summary_student_report_7(refreshFlag);
00225         <span class="keywordflow">break</span>;
00226     <span class="keywordflow">case</span> 5: faculty_res.is_year_end_report = 1;
00227         faculty_res.summary_report_9(refreshFlag);
00228         <span class="keywordflow">break</span>;
00229 
00230     <span class="keywordflow">case</span> 6:  faculty_res.summary_report_10(refreshFlag);
00231         <span class="keywordflow">break</span>;
00232 
00233     <span class="keywordflow">case</span> 7:
00234         screen_opt_intro();
00235         <span class="keywordflow">break</span>;
00236 
00237     <span class="keywordflow">case</span> 8:
00238     <span class="keywordflow">case</span> 9:
00239     <span class="keywordflow">case</span> 10:
00240         sys.view_mode=<a class="code" href="Osys_8h.html#a45a18">MODE_YEAR_END_REPORT</a>;
00241         optimization.disp(refreshFlag);
00242         <span class="keywordflow">break</span>;
00243 
00244     <span class="keywordflow">case</span> 11:
00245         finance.calc_budget_report();               <span class="comment">//BUGHERE double-check the call order!</span>
00246         sys.save_view_mode=screen_keeping;
00247 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00248 <span class="preprocessor"></span>        config.frame_speed=<a class="code" href="Osys_8h.html#a43a7">DEFAULT_SPEED</a>;
00249         sys.save_speed=<a class="code" href="Osys_8h.html#a43a7">DEFAULT_SPEED</a>;
00250         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=department_array.size(); i&gt;0; i-- ) {
00251             <span class="comment">// reset faculty target hire</span>
00252             finance.hiring_policy_array[i-1].target_value = 0;
00253         }
00254 <span class="preprocessor">#else</span>
00255 <span class="preprocessor"></span>        config.frame_speed=speed_keeping;
00256         sys.save_speed=speed_keeping;
00257 <span class="preprocessor">#endif</span>
00258 <span class="preprocessor"></span>        sys.set_staying_view_mode(0);               <span class="comment">// reset staying view mode</span>
00259         sys.set_view_mode(screen_keeping);
00260         optimization.is_optimized[0]=0;
00261         optimization.is_optimized[1]=0;
00262         optimization.is_optimized[2]=0;
00263         optimization.is_optimize_slider_modified[0]=0;
00264         optimization.is_optimize_slider_modified[1]=0;
00265         optimization.is_optimize_slider_modified[2]=0;
00266         sys.redraw_all_flag=1;
00267         <span class="keywordflow">break</span>;
00268 
00269 <span class="preprocessor">#else</span>
00270 <span class="preprocessor"></span>    <span class="keywordflow">case</span> 4:
00271         screen_opt_intro();
00272         <span class="keywordflow">break</span>;
00273 
00274     <span class="keywordflow">case</span> 5:
00275     <span class="keywordflow">case</span> 6:
00276     <span class="keywordflow">case</span> 7:
00277         sys.view_mode=<a class="code" href="Osys_8h.html#a45a18">MODE_YEAR_END_REPORT</a>;
00278         optimization.disp(refreshFlag);
00279         <span class="keywordflow">break</span>;
00280 
00281         <span class="comment">// BUGHERE ## chwg0301  temparory delete two pages.</span>
00282         <span class="comment">/*</span>
00283 <span class="comment">          case 8:</span>
00284 <span class="comment">          screen_last_year_finance(1, REPORT_TYPE_REVENUE, REPORT_YEAR_THIS, "Revenue and Expenditure Statement", refreshFlag);</span>
00285 <span class="comment">          break;</span>
00286 <span class="comment"></span>
00287 <span class="comment">          case 9:</span>
00288 <span class="comment">          screen_last_year_finance(2, REPORT_TYPE_BALANCE, REPORT_YEAR_THIS, "Balance Sheet", refreshFlag);</span>
00289 <span class="comment">          break;</span>
00290 <span class="comment"></span>
00291 <span class="comment">          case 10:// finished</span>
00292 <span class="comment">        */</span>
00293     <span class="keywordflow">case</span> 8:
00294         finance.calc_budget_report();               <span class="comment">//BUGHERE double-check the call order!</span>
00295         sys.save_view_mode=screen_keeping;
00296         config.frame_speed=speed_keeping;
00297         sys.save_speed=speed_keeping;
00298         sys.set_staying_view_mode(0);               <span class="comment">// reset staying view mode</span>
00299         optimization.is_optimized[0]=0;
00300         optimization.is_optimized[1]=0;
00301         optimization.is_optimized[2]=0;
00302         optimization.is_optimize_slider_modified[0]=0;
00303         optimization.is_optimize_slider_modified[1]=0;
00304         optimization.is_optimize_slider_modified[2]=0;
00305         sys.redraw_all_flag=1;
00306         <span class="keywordflow">break</span>;
00307 <span class="preprocessor">#endif</span>
00308 <span class="preprocessor"></span>    }
00309 }
00310 
00311 <span class="comment">//----- End of function Finance::new_fiscal_year_report -----//</span>
00312 
00313 <span class="comment">//----- Begin of function Finance::new_fiscal_year_report_detect -----//</span>
00314 
<a name="l00315"></a><a class="code" href="classFinance.html#a23">00315</a> <span class="keywordtype">void</span> <a class="code" href="classFinance.html#a23">Finance::new_fiscal_year_report_detect</a>() {
00316     <span class="keywordtype">int</span> reportScreenId = report_screen_id;
00317 
00318     <span class="keywordflow">switch</span>( report_screen_id ) {
00319     <span class="keywordflow">case</span> 0:
00320         <span class="keywordflow">if</span>( mouse.single_click() )
00321             report_screen_id++;
00322         <span class="keywordflow">break</span>;
00323 
00324     <span class="keywordflow">case</span> 1:
00325 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00326 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( letter.eval_letter_detect() == 2 ) {
00327             <span class="keywordflow">if</span> ( player_school.is_public() ) {
00328                 report_screen_id=2;
00329                 sys.set_view_mode( MODE_STATE_REPORT );
00330                 sys.staying_view_mode = MODE_STATE_REPORT;
00331             }
00332             <span class="keywordflow">else</span> {
00333                 report_screen_id=4;
00334                 enroll_res.update_student_intake();
00335                 sys.set_view_mode( <a class="code" href="Osys_8h.html#a45a18">MODE_YEAR_END_REPORT</a> );
00336                 sys.staying_view_mode = <a class="code" href="Osys_8h.html#a45a18">MODE_YEAR_END_REPORT</a>;
00337             }
00338         }
00339 <span class="preprocessor">#endif</span>
00340 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
00341 
00342     <span class="keywordflow">case</span> 2:
00343 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00344 <span class="preprocessor"></span>        <span class="keywordflow">switch</span> ( letter.state_report_detect() ) {
00345         <span class="keywordflow">case</span> 2:                                   <span class="comment">//  next</span>
00346             report_screen_id=4;
00347             enroll_res.update_student_intake();
00348             sys.set_view_mode(<a class="code" href="Osys_8h.html#a45a18">MODE_YEAR_END_REPORT</a>);
00349             sys.staying_view_mode = <a class="code" href="Osys_8h.html#a45a18">MODE_YEAR_END_REPORT</a>;
00350             <span class="keywordflow">break</span>;
00351 
00352         <span class="keywordflow">case</span> 1:                                   <span class="comment">// back</span>
00353             report_screen_id=1;
00354             sys.set_view_mode(<a class="code" href="Osys_8h.html#a45a34">MODE_EVALUATION_LETTER</a>);
00355             sys.staying_view_mode = <a class="code" href="Osys_8h.html#a45a34">MODE_EVALUATION_LETTER</a>;
00356             <span class="keywordflow">break</span>;
00357         }
00358 
00359 <span class="preprocessor">#else</span>
00360 <span class="preprocessor"></span>        screen_last_year_finance_detect(<a class="code" href="Ofinance_8h.html#a92a4">REPORT_TYPE_REVENUE</a>, <a class="code" href="Ofinance_8h.html#a94a13">REPORT_YEAR_PREV</a>);
00361 <span class="preprocessor">#endif</span>
00362 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
00363 
00364     <span class="keywordflow">case</span> 3:
00365         screen_last_year_finance_detect(<a class="code" href="Ofinance_8h.html#a92a5">REPORT_TYPE_BALANCE</a>, <a class="code" href="Ofinance_8h.html#a94a13">REPORT_YEAR_PREV</a>);
00366         <span class="keywordflow">break</span>;
00367 
00368 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00369 <span class="preprocessor"></span>    <span class="keywordflow">case</span> 4:
00370         <span class="keywordflow">switch</span> ( player_school.summary_student_report_detect() ) {
00371         <span class="keywordflow">case</span> 1:                                   <span class="comment">// back to state report or evaluation letter</span>
00372             <span class="keywordflow">if</span> ( player_school.is_public() ) {
00373                 sys.set_view_mode( MODE_STATE_REPORT );
00374                 sys.staying_view_mode = MODE_STATE_REPORT;
00375                 report_screen_id = 2;
00376             }
00377             <span class="keywordflow">else</span> {
00378                 sys.set_view_mode( <a class="code" href="Osys_8h.html#a45a34">MODE_EVALUATION_LETTER</a> );
00379                 sys.staying_view_mode = <a class="code" href="Osys_8h.html#a45a34">MODE_EVALUATION_LETTER</a>;
00380                 report_screen_id = 1;
00381             }
00382             <span class="keywordflow">break</span>;
00383         <span class="keywordflow">case</span> 2: report_screen_id++;               <span class="comment">// Faculty Turnover Report</span>
00384             faculty_res.current_year_report = FACULTY_LISTS;
00385         }
00386         <span class="keywordflow">break</span>;
00387 
00388     <span class="keywordflow">case</span> 5:
00389         <span class="keywordflow">switch</span> ( faculty_res.summary_report_detect() ) {
00390         <span class="keywordflow">case</span> 1:  report_screen_id++;
00391             faculty_res.current_year_report = FACULTY_DETAILS;
00392             <span class="keywordflow">break</span>;
00393         <span class="keywordflow">case</span> 2:  report_screen_id--;
00394             <span class="keywordflow">break</span>;
00395         <span class="keywordflow">case</span> 3:  report_screen_id=7;              <span class="comment">// Student Turnover</span>
00396         }
00397         <span class="keywordflow">break</span>;
00398 
00399     <span class="keywordflow">case</span> 6:
00400         <span class="keywordflow">if</span> ( faculty_res.summary_report_detect() ) {<span class="comment">// Faculty Turnover details</span>
00401             report_screen_id--;
00402             faculty_res.current_year_report = FACULTY_LISTS;
00403         }
00404         <span class="keywordflow">break</span>;
00405 
00406     <span class="keywordflow">case</span> 7:
00407         <span class="keywordflow">if</span>( mouse.single_click() ) {
00408             report_screen_id++;
00409             optimization.current_stage = 1;
00410         }
00411         <span class="keywordflow">break</span>;
00412 
00413     <span class="keywordflow">case</span> 8:
00414         <span class="keywordflow">if</span> ( optimization.detect() == 2 )           <span class="comment">// back button</span>
00415             report_screen_id = 5;
00416 
00417         <span class="keywordflow">if</span>( optimization.current_stage &gt; 1 )
00418             report_screen_id++;
00419 
00420         <span class="keywordflow">break</span>;
00421 
00422     <span class="keywordflow">case</span> 9:
00423         optimization.detect();
00424 
00425         <span class="keywordflow">if</span>( optimization.current_stage &lt; 2 )
00426             report_screen_id--;
00427 
00428         <span class="keywordflow">else</span> <span class="keywordflow">if</span>( optimization.current_stage &gt; 2 ) {
00429             <span class="comment">// set the result value to be all 0</span>
00430             <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=department_array.size(); i&gt;0; i-- )
00431                 finance.hiring_policy_array[i].result_value = 0;
00432             report_screen_id++;
00433         }
00434         <span class="keywordflow">break</span>;
00435 
00436     <span class="keywordflow">case</span> 10:
00437         optimization.detect();
00438 
00439         <span class="keywordflow">if</span>( optimization.current_stage &lt; 3 )
00440             report_screen_id--;
00441         <span class="keywordflow">else</span> <span class="keywordflow">if</span>( optimization.current_stage &gt; 3 ) {
00442             report_screen_id++;
00443             <span class="comment">// unlock the maximum of opt1</span>
00444             optimization.opt1_slider_group[0].lock_max = 0;
00445             <span class="keywordtype">float</span> max = 5.0;
00446             *optimization.opt1_slider_group[0].up_ptr = max;
00447 
00448             faculty_res.is_year_end_report = 0;
00449             player_school.is_year_end_report = 0;
00450         }
00451         <span class="keywordflow">break</span>;
00452 
00453     <span class="keywordflow">case</span> 11:
00454         screen_last_year_finance_detect(<a class="code" href="Ofinance_8h.html#a92a4">REPORT_TYPE_REVENUE</a>, <a class="code" href="Ofinance_8h.html#a94a14">REPORT_YEAR_THIS</a>);
00455         <span class="keywordflow">break</span>;
00456 
00457     <span class="keywordflow">case</span> 12:
00458         screen_last_year_finance_detect(<a class="code" href="Ofinance_8h.html#a92a5">REPORT_TYPE_BALANCE</a>, <a class="code" href="Ofinance_8h.html#a94a14">REPORT_YEAR_THIS</a>);
00459         <span class="keywordflow">break</span>;
00460     }
00461 <span class="preprocessor">#else</span>
00462 <span class="preprocessor"></span> <span class="keywordflow">case</span> 4:
00463      <span class="keywordflow">if</span>( mouse.single_click() ) {
00464          report_screen_id++;
00465          optimization.current_stage = 1;
00466      }
00467      <span class="keywordflow">break</span>;
00468 
00469  <span class="keywordflow">case</span> 5:
00470      optimization.detect();
00471 
00472      <span class="keywordflow">if</span>( optimization.current_stage &lt; 1 )
00473          report_screen_id--;
00474 
00475      <span class="keywordflow">else</span> <span class="keywordflow">if</span>( optimization.current_stage &gt; 1 )
00476          report_screen_id++;
00477      <span class="keywordflow">break</span>;
00478 
00479  <span class="keywordflow">case</span> 6:
00480      optimization.detect();
00481 
00482      <span class="keywordflow">if</span>( optimization.current_stage &lt; 2 )
00483          report_screen_id--;
00484 
00485      <span class="keywordflow">else</span> <span class="keywordflow">if</span>( optimization.current_stage &gt; 2 )
00486          report_screen_id++;
00487      <span class="keywordflow">break</span>;
00488 
00489  <span class="keywordflow">case</span> 7:
00490      optimization.detect();
00491 
00492      <span class="keywordflow">if</span>( optimization.current_stage &lt; 3 )
00493          report_screen_id--;
00494      <span class="keywordflow">else</span> <span class="keywordflow">if</span>( optimization.current_stage &gt; 3 ) {
00495          report_screen_id++;
00496      }
00497      <span class="keywordflow">break</span>;
00498 
00499  <span class="keywordflow">case</span> 8:
00500      screen_last_year_finance_detect(<a class="code" href="Ofinance_8h.html#a92a4">REPORT_TYPE_REVENUE</a>, <a class="code" href="Ofinance_8h.html#a94a14">REPORT_YEAR_THIS</a>);
00501      <span class="keywordflow">break</span>;
00502 
00503  <span class="keywordflow">case</span> 9:
00504      screen_last_year_finance_detect(<a class="code" href="Ofinance_8h.html#a92a5">REPORT_TYPE_BALANCE</a>, <a class="code" href="Ofinance_8h.html#a94a14">REPORT_YEAR_THIS</a>);
00505      <span class="keywordflow">break</span>;
00506 }
00507 <span class="preprocessor">#endif</span>
00508 <span class="preprocessor"></span>
00509 <span class="keywordflow">if</span>( report_screen_id != reportScreenId )
00510     sys.redraw_zoom_flag = 1;
00511 }
00512 
00513 <span class="comment">//----- End of function Finance::new_fiscal_year_report_detect -----//</span>
00514 
00515 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00516 <span class="preprocessor"></span><span class="comment">// --- Begin of function Finance::update_appropiation --- //</span>
00517 <span class="comment">//</span>
00518 <span class="keywordtype">void</span> Finance::update_appropiation() {
00519 <span class="comment">// ----------------- Task 7b)-7e) -------- //</span>
00520 <span class="comment">// Refer to Design Specification: Version 1.2, P.11-12</span>
00521 
00522   <span class="comment">// Shift History for the variables of appropiation</span>
00523 finance.base_appropriation[0]           = finance.base_appropriation[1];
00524 finance.enroll_appropriation[0]         = finance.enroll_appropriation[1];
00525 finance.performance_appropriation[0]      = finance.performance_appropriation[1];
00526 finance.education_quality_appropriation[0]  = finance.education_quality_appropriation[1];
00527 finance.total_appropriation[0]          = finance.total_appropriation[1];
00528 finance.facility_reserve_appropriation[0]   = finance.facility_reserve_appropriation[1];
00529 
00530   <span class="comment">// ********************* Task 7c) ******************* //</span>
00531 
00532   <span class="comment">// First declare some useful variables</span>
00533 <span class="keywordtype">double</span> STt;                                     <span class="comment">// Current State Appropriation</span>
00534 <span class="keywordtype">double</span> STDiv;                                   <span class="comment">// STt / initial_state_appropriation</span>
00535 <span class="keywordtype">double</span> SEt;                                     <span class="comment">// Current Enrollment Appropriation</span>
00536 <span class="keywordtype">double</span> SPIt;                                    <span class="comment">// Current Performance Indicator Appropriation</span>
00537 <span class="keywordtype">double</span> SEQt;                                    <span class="comment">// Current Education Quality Appropriation</span>
00538 <span class="keywordtype">double</span> SBt;                                     <span class="comment">// Current Base Appropriation</span>
00539 <span class="keywordtype">double</span> STAt;                                    <span class="comment">// Current Total State Appropriation</span>
00540 <span class="comment">//      double XTt,X1t,X2t,X3t,X4t;                             // Current variable value</span>
00541 <span class="comment">//      double XT0,X10,X20,X30,X40;                             // Initial variable value</span>
00542 <span class="keywordtype">double</span> XTDiv,X1Div,X2Div,X3Div,X4Div;           <span class="comment">// XTt/XT0, X1t/X10 ...</span>
00543 
00544 <span class="keywordflow">if</span> ( info.prerun_year ) {
00545 <span class="comment">// get the initial values</span>
00546 initial_state_appropriation = <a class="code" href="classFinance.html#m13">projected_revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].this_year.total;
00547 initial_base_appropriation  = 0.5*initial_state_appropriation;
00548 initial_enrollment_appropriation = 0.35*initial_state_appropriation;
00549 initial_performance_appropriation = 0.15*initial_state_appropriation;
00550 }
00551 
00552 <span class="comment">// get STt (Current State Appropriation)</span>
00554 <span class="comment">STt = initial_state_appropriation;</span>
00555 <span class="keywordflow">if</span>( info.prerun_year || initial_state_appropriation == 0.0 )
00556     STDiv = 1.0;
00557 <span class="keywordflow">else</span>
00558 STDiv = STt / initial_state_appropriation;
00559 
00560   <span class="comment">// Calculate SEt ( Current Enrollment Appropriation )</span>
00561   <span class="comment">// XTt = department_array.convention_student_count_history[MAX_TEACHING_METHOD_N_TOTAL-1][HISTORY_TRIMESTER_COUNT-3];</span>
00562   <span class="comment">// XT0 = department_array.initial_convention_student_count[MAX_TEACHING_METHOD_N_TOTAL-1];</span>
00563                                                   <span class="comment">// initial not set, so set convention_student_count</span>
00564 <span class="keywordflow">if</span>( info.prerun_year || department_array.initial_convention_student_count[<a class="code" href="Ocourse_8h.html#a39a30">MAX_TEACHING_METHOD_N_TOTAL</a>-1] == 0 )
00565     XTDiv = 1.0;
00566 <span class="keywordflow">else</span>
00567 XTDiv = (double)department_array.convention_student_count_history[<a class="code" href="Ocourse_8h.html#a39a30">MAX_TEACHING_METHOD_N_TOTAL</a>-1][HISTORY_TRIMESTER_COUNT-3]
00568 / department_array.initial_convention_student_count[<a class="code" href="Ocourse_8h.html#a39a30">MAX_TEACHING_METHOD_N_TOTAL</a>-1];
00569 
00570 SEt = initial_enrollment_appropriation
00571 *STDiv                                          <span class="comment">// *STt/initial_state_appropriation</span>
00572 *XTDiv;                                         <span class="comment">// *XTt/XT0;</span>
00573 
00574 finance.enroll_appropriation[1] = SEt;
00575 
00576 <span class="comment">// Calculate SPIt ( Current Performance Indicator Appropriation )</span>
00577 <span class="comment">//X1t = player_school.sub_score[S_DEGREES_GRANTED][HISTORY_MONTH_COUNT-1];</span>
00578 <span class="comment">//X10 = player_school.sub_score_start[S_DEGREES_GRANTED];</span>
00579 <span class="keywordflow">if</span>( info.prerun_year || player_school.sub_score_start[<a class="code" href="Opschool_8h.html#a65a37">S_DEGREES_GRANTED</a>] == 0.0 )
00580     X1Div = 1.0;
00581 <span class="keywordflow">else</span>
00582 X1Div = player_school.sub_score[<a class="code" href="Opschool_8h.html#a65a37">S_DEGREES_GRANTED</a>][HISTORY_MONTH_COUNT-1]
00583 / player_school.sub_score_start[<a class="code" href="Opschool_8h.html#a65a37">S_DEGREES_GRANTED</a>];
00584 
00585   <span class="comment">//X2t = player_school.sub_score[5][HISTORY_MONTH_COUNT-1];</span>
00586   <span class="comment">//X20 = player_school.sub_score_start[S_STUDENT_DIVERSITY];</span>
00587 <span class="keywordflow">if</span>( info.prerun_year || player_school.sub_score_start[<a class="code" href="Opschool_8h.html#a65a42">S_STUDENT_DIVERSITY</a>] == 0.0 )
00588     X2Div = 1.0;
00589 <span class="keywordflow">else</span>
00590 X2Div = player_school.sub_score[<a class="code" href="Opschool_8h.html#a65a42">S_STUDENT_DIVERSITY</a>][HISTORY_MONTH_COUNT-1]
00591 / player_school.sub_score_start[<a class="code" href="Opschool_8h.html#a65a42">S_STUDENT_DIVERSITY</a>];
00592 
00593   <span class="comment">//    X3t = department_array.admission_denied_count_history[MAX_TEACHING_METHOD][HISTORY_TRIMESTER_COUNT-3]</span>
00594   <span class="comment">//            + department_array.admission_denied_count_history[MAX_TEACHING_METHOD][HISTORY_TRIMESTER_COUNT-2]</span>
00595   <span class="comment">//            + department_array.admission_denied_count_history[MAX_TEACHING_METHOD][HISTORY_TRIMESTER_COUNT-1];</span>
00599 <span class="comment">  // X30 = department_array.initial_admission_denied_count[MAX_TEACHING_METHOD];</span>
00600 <span class="keywordflow">if</span>( info.prerun_year || department_array.initial_admission_denied_count[<a class="code" href="Ocourse_8h.html#a39a29">MAX_TEACHING_METHOD</a>] == 0 )
00601     X3Div = 1.0;
00602 <span class="keywordflow">else</span>
00603 X3Div = (double)(department_array.admission_denied_count_history[<a class="code" href="Ocourse_8h.html#a39a29">MAX_TEACHING_METHOD</a>][HISTORY_TRIMESTER_COUNT-3]
00604 + department_array.admission_denied_count_history[<a class="code" href="Ocourse_8h.html#a39a29">MAX_TEACHING_METHOD</a>][HISTORY_TRIMESTER_COUNT-2]
00605 + department_array.admission_denied_count_history[<a class="code" href="Ocourse_8h.html#a39a29">MAX_TEACHING_METHOD</a>][HISTORY_TRIMESTER_COUNT-1] )
00606     / department_array.initial_admission_denied_count[<a class="code" href="Ocourse_8h.html#a39a29">MAX_TEACHING_METHOD</a>];
00607 
00608   <span class="comment">//X4t = department_array.size_deviation[5]</span>
00609   <span class="comment">//X40 = department_array.initial_size_deviation[5];</span>
00610 <span class="keywordflow">if</span>( info.prerun_year || department_array.initial_size_deviation[<a class="code" href="Ocourse_8h.html#a39a29">MAX_TEACHING_METHOD</a>] == 0 )
00611     X4Div = 1.0;
00612 <span class="keywordflow">else</span>
00613 X4Div = (double)department_array.size_deviation[<a class="code" href="Ocourse_8h.html#a39a29">MAX_TEACHING_METHOD</a>]
00614 / department_array.initial_size_deviation[<a class="code" href="Ocourse_8h.html#a39a29">MAX_TEACHING_METHOD</a>];
00615 
00616 SPIt = initial_performance_appropriation
00617 *STDiv                                          <span class="comment">// *STt/initial_state_appropriation</span>
00618 *math.safe_pow(X1Div,0.1)                       <span class="comment">// *math.safe_pow(X1t/X10,0.1)</span>
00619     *math.safe_pow(X2Div,0.3)                       <span class="comment">// *math.safe_pow(X2t/X20,0.3)</span>
00620     *math.safe_pow(X3Div,0.2)                       <span class="comment">// *math.safe_pow(X3t/X30,0.2)</span>
00621     *math.safe_pow(X4Div,0.1);                      <span class="comment">// *math.safe_pow(X4t/X40,0.1);</span>
00622 
00623 finance.performance_appropriation[1] = SPIt;
00624 
00625 <span class="comment">// Calculate SEQt ( Current Educational Quality Appropriation )</span>
00626 
00627   <span class="comment">// Calculate "result" variable for education quality</span>
00628 <span class="keywordtype">int</span> result = player_school.think_protagonist_event(
00629 player_school.sub_score[<a class="code" href="Opschool_8h.html#a65a40">S_EDUCATIONAL_QUALITY</a>][HISTORY_MONTH_COUNT-1],
00630     player_school.sub_score[<a class="code" href="Opschool_8h.html#a65a40">S_EDUCATIONAL_QUALITY</a>][HISTORY_MONTH_COUNT-1-12],
00631     player_school.sub_score_start[<a class="code" href="Opschool_8h.html#a65a40">S_EDUCATIONAL_QUALITY</a>],
00632     player_school.get_protagonist_info(5),
00633     -1, 1 );
00634 
00635 <span class="keywordflow">switch</span> ( result ) {
00636 <span class="keywordflow">case</span> 1: SEQt = 0.05*STt; <span class="keywordflow">break</span>;
00637 <span class="keywordflow">case</span> 2: SEQt = 0.02*STt; <span class="keywordflow">break</span>;
00638 <span class="keywordflow">case</span> 3: SEQt = -0.02*STt; <span class="keywordflow">break</span>;
00639 <span class="keywordflow">case</span> 4:                                       <span class="comment">// case 4 &amp; 7</span>
00640 <span class="keywordflow">case</span> 7: SEQt = -0.05*STt; <span class="keywordflow">break</span>;
00641 <span class="keywordflow">default</span>:  SEQt = 0;
00642 }
00643 
00644 finance.education_quality_appropriation[1] = SEQt;
00645 
00646   <span class="comment">// Calculate SBt ( Current Base Appropriation )</span>
00647 
00648 SBt = 0.5*STt;
00649 
00650 finance.base_appropriation[1] = SBt;
00651 
00652   <span class="comment">// Calculate STAt ( Current Total State Appropriation )</span>
00653 STAt = SBt + SEt + SPIt + SEQt;
00654 
00655 finance.total_appropriation[1] = STAt;
00656 
00657   <span class="comment">// Replace the Total State Appropriation to State Appropriation</span>
00658 <a class="code" href="classFinance.html#m13">projected_revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].this_year.total = STAt;
00659 <a class="code" href="classFinance.html#m8">budget_revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].total = STAt;
00660 <span class="comment">//      revenue_array[AC_STATE_APPROPRIATION].total = STAt;</span>
00661 
00662 <span class="comment">// ********************* Task 7d) ******************** //</span>
00663 
00664   <span class="comment">// First define some useful variables</span>
00665 <span class="keywordtype">double</span> SFRt=0;                                  <span class="comment">// Current Infusion to the Facilities Reserve</span>
00666 
00667 <span class="keywordtype">int</span> rc1, rc2;
00668 
00669   <span class="comment">// For Football performance and Basketball performance</span>
00670 rc1 = player_school.think_protagonist_event(
00671 math.safe_divide((<span class="keywordtype">float</span>)athletics_office.football_graph[THIS_YEAR], <span class="keywordtype">float</span>(athletics_office.football_graph[THIS_YEAR] + athletics_office.football_graph[HISTORY_YEAR_COUNT+THIS_YEAR]) * 100.0f),
00672     math.safe_divide((<span class="keywordtype">float</span>)athletics_office.football_graph[THIS_YEAR-1], <span class="keywordtype">float</span>(athletics_office.football_graph[THIS_YEAR-1] + athletics_office.football_graph[HISTORY_YEAR_COUNT+THIS_YEAR-1]) * 100.0f),
00673     math.safe_divide((<span class="keywordtype">float</span>)athletics_office.initial_football_graph[0], <span class="keywordtype">float</span>(athletics_office.initial_football_graph[0] + athletics_office.initial_football_graph[1]) * 100.0f),
00674     player_school.get_protagonist_info(29), -1,1 ); <span class="comment">// -1=institutional level</span>
00675 
00676 rc2 = player_school.think_protagonist_event(
00677 math.safe_divide((<span class="keywordtype">float</span>)athletics_office.basketball_graph[THIS_YEAR], <span class="keywordtype">float</span>(athletics_office.basketball_graph[THIS_YEAR] + athletics_office.basketball_graph[HISTORY_YEAR_COUNT+THIS_YEAR]) * 100.0f),
00678     math.safe_divide((<span class="keywordtype">float</span>)athletics_office.basketball_graph[THIS_YEAR-1], <span class="keywordtype">float</span>(athletics_office.basketball_graph[THIS_YEAR-1] + athletics_office.basketball_graph[HISTORY_YEAR_COUNT+THIS_YEAR-1]) * 100.0f),
00679     math.safe_divide((<span class="keywordtype">float</span>)athletics_office.initial_basketball_graph[0], <span class="keywordtype">float</span>(athletics_office.initial_basketball_graph[0] + athletics_office.initial_basketball_graph[1]) * 100.0f),
00680     player_school.get_protagonist_info(30), -1,1 ); <span class="comment">// -1=institutional level</span>
00681 
00682 <span class="keywordflow">if</span> (( rc1 == 1) &amp;&amp; (rc2 == 1)) {
00683 SFRt = 0.03;
00684 }
00685 <span class="keywordflow">else</span>
00686 <span class="keywordflow">if</span> ((rc1 == 1) || (rc2 == 1))
00687     SFRt = 0.01;
00688 
00689   <span class="comment">// For institutional prestige</span>
00690 rc1 = player_school.think_protagonist_event( player_school.sub_score[<a class="code" href="Opschool_8h.html#a65a39">S_PRESTIGE</a>][HISTORY_MONTH_COUNT-1],
00691     player_school.sub_score[<a class="code" href="Opschool_8h.html#a65a39">S_PRESTIGE</a>][HISTORY_MONTH_COUNT-13],
00692     player_school.sub_score_start[<a class="code" href="Opschool_8h.html#a65a39">S_PRESTIGE</a>],
00693     player_school.get_protagonist_info(4), -1,1 );  <span class="comment">// -1=institutional level</span>
00694 
00695 <span class="keywordflow">if</span> ( rc1 == 1 )
00696     SFRt += 0.04;
00697 
00698                                                   <span class="comment">// Capital Reserve</span>
00699 finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>] *= (1+SFRt);
00700 <span class="comment">// Facility Reserve Appropriation</span>
00701 finance.facility_reserve_appropriation[1] = SFRt;
00702 
00703 <span class="comment">// ********************** Part 7e) ************************* //</span>
00704 <span class="comment">// Regulation of tuition increases</span>
00705 
00706 <span class="comment">// get the result of tuition growth variable</span>
00707 rc1 = player_school.think_protagonist_event( finance.tuition_increase_history[THIS_YEAR],
00708     finance.tuition_increase_history[THIS_YEAR-1],
00709     finance.initial_tuition_increase,
00710     player_school.get_protagonist_info(27), -1,1 ); <span class="comment">// -1=institutional level</span>
00711 
00712 <span class="comment">// Base on the result above, set P</span>
00713 <span class="keywordtype">float</span> P;
00714 <span class="keywordflow">switch</span> (rc1) {
00715 <span class="keywordflow">case</span> 4:                                       <span class="comment">// case 4 &amp; 7</span>
00716 <span class="keywordflow">case</span> 7: P=0.65;<span class="keywordflow">break</span>;
00717 <span class="keywordflow">case</span> 3: P=0.4;<span class="keywordflow">break</span>;
00718 <span class="keywordflow">default</span>:  P=0.2;
00719 }
00720 
00721 <span class="keywordtype">float</span> randomNo = math.get_random_float();
00722 
00723   <span class="comment">// get a random variable and compare with P, to check there will be regulation</span>
00724 <span class="keywordflow">if</span> ( randomNo &lt;= P ) {                          <span class="comment">// do regulation</span>
00725 <span class="comment">// By different result, draw a normally-distributed random variable</span>
00726 <span class="keywordtype">float</span> max;
00727 <span class="keywordflow">switch</span> (rc1) {
00728 <span class="keywordflow">case</span> 4: max = math.get_random_snd((<span class="keywordtype">float</span>)2.0,0.2); <span class="keywordflow">break</span>;
00729 <span class="keywordflow">case</span> 3: max = math.get_random_snd((<span class="keywordtype">float</span>)1.5,0.3); <span class="keywordflow">break</span>;
00730 <span class="keywordflow">default</span>:  max = math.get_random_snd((<span class="keywordtype">float</span>)2.0,0.4); <span class="keywordflow">break</span>;
00731 }
00732 
00733 <span class="comment">// After getting the max, set the maximum of tuition growth = max</span>
00734 finance.revenue_policy_array[0].upper_bound = max;
00735 }
00736 }
00737 
00738 <span class="comment">//</span>
00739 <span class="comment">// --- End of function Finance::update_appropiation --- //</span>
00740 <span class="preprocessor">#endif</span>
00741 <span class="preprocessor"></span>
00742 <span class="comment">//----- Begin of static function screen_intro -----//</span>
00743 
00744 <span class="keyword">static</span> <span class="keywordtype">void</span> screen_intro() {
00745 <span class="comment">//-------- message screen: greeting --------//</span>
00746 <span class="comment">//      audio.play_wav("PHONE",audio.int_to_DsVolume(config.sound_effect_volume));</span>
00747 
00748 user_interface.bg_img(1, &amp;vga_back);
00749 
00750 <a class="code" href="classString.html">String</a> str;
00751 
00752 str  = <span class="stringliteral">"End of the Academic/Fiscal Year "</span>;
00753 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00754 <span class="preprocessor"></span>str += m.format( info.financial_year(), 4);     <span class="comment">// end fiscal year 1 at year 2, etc.</span>
00755 <span class="preprocessor">#else</span>
00756 <span class="preprocessor"></span>str += m.format( info.game_year-1, 4);
00757 str += <span class="stringliteral">"-"</span>;
00758 str += m.format( info.game_year, 4);
00759 <span class="preprocessor">#endif</span>
00760 <span class="preprocessor"></span>
00761 font_charts.center_put(<a class="code" href="Oworldmt_8h.html#a12">ZOOM_X1</a>, <a class="code" href="Oworldmt_8h.html#a13">ZOOM_Y1</a>, <a class="code" href="Oworldmt_8h.html#a14">ZOOM_X2</a>, <a class="code" href="Oworldmt_8h.html#a15">ZOOM_Y2</a>-50, str );
00762 
00763 font_charts.center_put(<a class="code" href="Oworldmt_8h.html#a12">ZOOM_X1</a>, <a class="code" href="Oworldmt_8h.html#a15">ZOOM_Y2</a>-50, <a class="code" href="Oworldmt_8h.html#a14">ZOOM_X2</a>, <a class="code" href="Oworldmt_8h.html#a15">ZOOM_Y2</a>,
00764         <span class="stringliteral">"Click to Continue..."</span> );
00765 
00766 vga.blt_buf(<a class="code" href="Oworldmt_8h.html#a12">ZOOM_X1</a>, <a class="code" href="Oworldmt_8h.html#a13">ZOOM_Y1</a>, <a class="code" href="Oworldmt_8h.html#a14">ZOOM_X2</a>, <a class="code" href="Oworldmt_8h.html#a15">ZOOM_Y2</a>, 1);
00767 sys.blt_virtual_buf();
00768 }
00769 
00770 <span class="comment">//----- End of static function screen_intro -----//</span>
00771 
00772 <span class="comment">//----- Begin of static function screen_opt_intro -----//</span>
00773 
00774 <span class="keyword">static</span> <span class="keywordtype">void</span> screen_opt_intro() {
00775 <span class="comment">//------- message screen: begin resource allocation ----//</span>
00776 
00777 user_interface.bg_img(1, &amp;vga_back);
00778 
00779 <a class="code" href="classString.html">String</a> str;
00780 
00781 str  = <span class="stringliteral">"Resource Allocation for the Fiscal Year "</span>;
00782 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00783 <span class="preprocessor"></span>str += m.format( info.financial_year()+1, 4);   <span class="comment">// end fiscal year 1 at year 2, etc.</span>
00784 <span class="preprocessor">#else</span>
00785 <span class="preprocessor"></span>str += m.format( info.game_year-1, 4);
00786 str += <span class="stringliteral">"-"</span>;
00787 str += m.format( info.game_year, 4);
00788 <span class="preprocessor">#endif</span>
00789 <span class="preprocessor"></span>
00790 font_charts.center_put(<a class="code" href="Oworldmt_8h.html#a12">ZOOM_X1</a>, <a class="code" href="Oworldmt_8h.html#a13">ZOOM_Y1</a>, <a class="code" href="Oworldmt_8h.html#a14">ZOOM_X2</a>, <a class="code" href="Oworldmt_8h.html#a15">ZOOM_Y2</a>-50, str );
00791 
00792 font_charts.center_put(<a class="code" href="Oworldmt_8h.html#a12">ZOOM_X1</a>, <a class="code" href="Oworldmt_8h.html#a15">ZOOM_Y2</a>-50, <a class="code" href="Oworldmt_8h.html#a14">ZOOM_X2</a>, <a class="code" href="Oworldmt_8h.html#a15">ZOOM_Y2</a>,
00793         <span class="stringliteral">"Click to Begin Resource Allocation..."</span> );
00794 
00795 vga.blt_buf(<a class="code" href="Oworldmt_8h.html#a12">ZOOM_X1</a>, <a class="code" href="Oworldmt_8h.html#a13">ZOOM_Y1</a>, <a class="code" href="Oworldmt_8h.html#a14">ZOOM_X2</a>, <a class="code" href="Oworldmt_8h.html#a15">ZOOM_Y2</a>, 1);
00796 sys.blt_virtual_buf();
00797 }
00798 
00799 <span class="comment">//----- End of static function screen_opt_intro -----//</span>
00800 
00801 <span class="comment">//----- Begin of static function screen_last_year_finance -----//</span>
00802 
00803 <span class="keyword">static</span> <span class="keywordtype">void</span> screen_last_year_finance(<span class="keywordtype">int</span> reportOrder, <span class="keywordtype">int</span> reportType, <span class="keywordtype">int</span> reportYear, <span class="keywordtype">char</span>* reportTitle, <span class="keywordtype">int</span> refreshFlag) {
00804 <span class="keywordtype">int</span> saveReportType = finance.report_type;
00805 <span class="keywordtype">int</span> saveReportYear = finance.report_year;
00806 
00807 finance.report_type = reportType;
00808 finance.report_year = reportYear;
00809 
00810 <span class="comment">// 0-don't display buttons, we will display buttons by our own</span>
00811 finance.disp_report_main(refreshFlag, 0, reportTitle);
00812 
00813 <span class="comment">//----- paint buttons --------//</span>
00814 
00815 <span class="keywordflow">if</span>( refreshFlag == <a class="code" href="Gamedef_8h.html#a71a16">INFO_REPAINT</a> ) {
00816 <span class="keywordtype">int</span> x;
00817 
00818 <span class="keywordflow">if</span>( reportOrder==1 ) {                        <span class="comment">// just the "Next" button</span>
00819 x = ( <a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a> - <a class="code" href="Ofin__new_8cpp.html#a15a8">BUTTON_NEXT_WIDTH</a> ) / 2;
00820 
00821 button_back.<a class="code" href="classButton.html#a4">reset</a>();
00822 
00823 button_next.<a class="code" href="classButton.html#a11">paint_text</a>( x, <a class="code" href="Ofin__new_8cpp.html#a14a5">BUTTON_Y1</a>,
00824         x+<a class="code" href="Ofin__new_8cpp.html#a15a8">BUTTON_NEXT_WIDTH</a>, <a class="code" href="Ofin__new_8cpp.html#a14a6">BUTTON_Y2</a>, <span class="stringliteral">"Next"</span> );
00825 }
00826 <span class="keywordflow">else</span> {                                        <span class="comment">// the "Back" and "Next" buttons</span>
00827 x = ( <a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a> - (<a class="code" href="Ofin__new_8cpp.html#a15a7">BUTTON_BACK_WIDTH</a> + <a class="code" href="Ofin__new_8cpp.html#a15a9">BUTTON_DISTANCE</a> + <a class="code" href="Ofin__new_8cpp.html#a15a8">BUTTON_NEXT_WIDTH</a>) ) / 2;
00828 
00829 button_back.<a class="code" href="classButton.html#a11">paint_text</a>( x, <a class="code" href="Ofin__new_8cpp.html#a14a5">BUTTON_Y1</a>,
00830         x+<a class="code" href="Ofin__new_8cpp.html#a15a7">BUTTON_BACK_WIDTH</a>, <a class="code" href="Ofin__new_8cpp.html#a14a6">BUTTON_Y2</a>, <span class="stringliteral">"Back"</span> );
00831 
00832 x += <a class="code" href="Ofin__new_8cpp.html#a15a7">BUTTON_BACK_WIDTH</a> + <a class="code" href="Ofin__new_8cpp.html#a15a9">BUTTON_DISTANCE</a>;
00833 
00834 button_next.<a class="code" href="classButton.html#a11">paint_text</a>( x, <a class="code" href="Ofin__new_8cpp.html#a14a5">BUTTON_Y1</a>,
00835         x+<a class="code" href="Ofin__new_8cpp.html#a15a8">BUTTON_NEXT_WIDTH</a>, <a class="code" href="Ofin__new_8cpp.html#a14a6">BUTTON_Y2</a>, <span class="stringliteral">"Next"</span> );
00836 }
00837 }
00838 
00839 finance.report_type = saveReportType;
00840 finance.report_year = saveReportYear;
00841 }
00842 
00843 <span class="comment">//----- End of static function screen_last_year_finance -----//</span>
00844 
00845 <span class="comment">//----- Begin of static function screen_last_year_finance_detect -----//</span>
00846 
00847 <span class="keyword">static</span> <span class="keywordtype">void</span> screen_last_year_finance_detect(<span class="keywordtype">int</span> reportType, <span class="keywordtype">int</span> reportYear) {
00848 <span class="keywordtype">int</span> saveReportType = finance.report_type;
00849 <span class="keywordtype">int</span> saveReportYear = finance.report_year;
00850 
00851 finance.report_type = reportType;
00852 finance.report_year = reportYear;
00853 
00854 finance.report_detect(0);                       <span class="comment">// 0-don't display buttons, we will display buttons by our own</span>
00855 
00856 <span class="comment">//---------------------------------//</span>
00857 
00858 <span class="keywordflow">if</span>( button_back.<a class="code" href="classButton.html#a21">detect</a>() )
00859     report_screen_id--;
00860 
00861 <span class="keywordflow">if</span>( button_next.<a class="code" href="classButton.html#a21">detect</a>() )
00862     report_screen_id++;
00863 
00864 <span class="comment">//---------------------------------//</span>
00865 
00866 finance.report_type = saveReportType;
00867 finance.report_year = saveReportYear;
00868 }
00869 
00870 <span class="comment">//----- End of static function screen_last_year_finance_detect -----//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:35 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
