<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OFILE.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>OFILE.CPP</h1><a href="OFILE_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OFILE.CPP</span>
00002 <span class="comment">//Description : Object File</span>
00003 
00004 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00005 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00006 <span class="comment">//#include &lt;OBOX.H&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;<a class="code" href="OFILE_8H.html">OFILE.H</a>&gt;</span>
00009 
00010 <span class="comment">//--------- Define static variables -----------//</span>
00011 
00012 <span class="keyword">static</span> <span class="keywordtype">char</span> *path_array[] = {                     <span class="comment">// multiple search path</span>
00013     <span class="stringliteral">""</span>
00014 };
00015 
00016 <span class="comment">//-------- Begin of function File::file_open ----------//</span>
<a name="l00031"></a><a class="code" href="classFile.html#a2">00031</a> <span class="comment">int File::file_open(char* fileName, int handleError, int allowVarySize) {</span>
00032     <span class="keywordflow">if</span>( strlen(fileName) &gt; MAX_PATH )
00033         err.run( <span class="stringliteral">"File : file name is too long."</span> );
00034 
00035     <span class="keywordflow">if</span>( file_handle != INVALID_HANDLE_VALUE )
00036         file_close();
00037 
00038     strcpy( file_name, fileName );
00039 
00040     handle_error    = handleError;
00041     allow_vary_size = allowVarySize;
00042 
00043     <span class="comment">//--------- search all path to open the file ------//</span>
00044 
00045     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;<span class="keyword">sizeof</span>(path_array)/<span class="keyword">sizeof</span>(path_array[0]) ; i++ ) {
00046         <span class="keywordtype">char</span>    filePath[MAX_PATH];
00047         strcpy( filePath, path_array[i] );
00048         strcat( filePath, fileName );
00049 
00050         file_handle = CreateFile(filePath,
00051                                  GENERIC_READ,
00052                                  FILE_SHARE_READ,
00053                                  (LPSECURITY_ATTRIBUTES) <a class="code" href="OHELP_8H.html#a0">NULL</a>,
00054                                  OPEN_EXISTING,
00055                                  FILE_ATTRIBUTE_NORMAL,
00056                                  (HANDLE) <a class="code" href="OHELP_8H.html#a0">NULL</a>);
00057 
00058         <span class="keywordflow">if</span>( file_handle != INVALID_HANDLE_VALUE)
00059             <span class="keywordflow">return</span> TRUE;
00060     }
00061 
00062     err.run( <span class="stringliteral">"Error opening file %s."</span>, file_name );
00063 
00064     <span class="keywordflow">return</span> FALSE;
00065 }
00066 
00067 <span class="comment">//---------- End of function File::file_open ----------//</span>
00068 
00069 <span class="comment">//-------- Begin of function File::file_create ----------//</span>
<a name="l00084"></a><a class="code" href="classFile.html#a3">00084</a> <span class="comment">int File::file_create(char* fileName, int handleError, int allowVarySize) {</span>
00085     <span class="keywordflow">if</span>( strlen(fileName) &gt; MAX_PATH )
00086         err.run( <span class="stringliteral">"File : file name is too long."</span> );
00087 
00088     strcpy( file_name, fileName );
00089 
00090     handle_error    = handleError;
00091     allow_vary_size = allowVarySize;
00092 
00093     <span class="comment">// cannot use creat() because it can't specify Binary file type</span>
00094 
00095     file_handle = CreateFile(fileName,
00096                              GENERIC_WRITE,
00097                              0,
00098                              (LPSECURITY_ATTRIBUTES) <a class="code" href="OHELP_8H.html#a0">NULL</a>,
00099                              CREATE_ALWAYS,
00100                              FILE_ATTRIBUTE_NORMAL,
00101                              (HANDLE) <a class="code" href="OHELP_8H.html#a0">NULL</a>);
00102 
00103     <span class="keywordflow">if</span>( file_handle == INVALID_HANDLE_VALUE)
00104         err.run( <span class="stringliteral">"Error creating file %s"</span>, file_name );
00105 
00106     <span class="keywordflow">return</span> TRUE;
00107 }
00108 
00109 <span class="comment">//---------- End of function File::file_create ----------//</span>
00110 
00111 <span class="comment">//### begin alex 24/7 ###//</span>
00112 <span class="comment">//-------- Begin of function File::file_append ----------//</span>
<a name="l00127"></a><a class="code" href="classFile.html#a4">00127</a> <span class="comment">int File::file_append(char* fileName, int handleError, int allowVarySize) {</span>
00128     <span class="keywordflow">if</span>( strlen(fileName) &gt; MAX_PATH )
00129         err.run( <span class="stringliteral">"File : file name is too long."</span> );
00130 
00131     <span class="keywordflow">if</span>( file_handle != INVALID_HANDLE_VALUE )
00132         file_close();
00133 
00134     strcpy( file_name, fileName );
00135 
00136     handle_error    = handleError;
00137     allow_vary_size = allowVarySize;
00138 
00139     <span class="comment">//--------- search all path to open the file ------//</span>
00140 
00141     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;<span class="keyword">sizeof</span>(path_array)/<span class="keyword">sizeof</span>(path_array[0]) ; i++ ) {
00142         <span class="keywordtype">char</span>    filePath[MAX_PATH];
00143         strcpy( filePath, path_array[i] );
00144         strcat( filePath, fileName );
00145 
00146         file_handle = CreateFile(filePath,
00147                                  GENERIC_WRITE,
00148                                  FILE_SHARE_WRITE,
00149                                  (LPSECURITY_ATTRIBUTES) <a class="code" href="OHELP_8H.html#a0">NULL</a>,
00150                                  OPEN_EXISTING,
00151                                  FILE_ATTRIBUTE_NORMAL,
00152                                  (HANDLE) <a class="code" href="OHELP_8H.html#a0">NULL</a>);
00153 
00154         <span class="keywordflow">if</span>( file_handle != INVALID_HANDLE_VALUE)
00155             <span class="keywordflow">return</span> TRUE;
00156     }
00157 
00158     err.run( <span class="stringliteral">"Error opening file %s."</span>, file_name );
00159 
00160     <span class="keywordflow">return</span> FALSE;
00161 }
00162 
00163 <span class="comment">//---------- End of function File::file_append ----------//</span>
00164 <span class="comment">//#### end alex 24/7 ####//</span>
00165 
00166 <span class="comment">//-------- Begin of function File::file_close ----------//</span>
<a name="l00168"></a><a class="code" href="classFile.html#a5">00168</a> <span class="comment">void File::file_close() {</span>
00169     <span class="keywordflow">if</span>( file_handle != INVALID_HANDLE_VALUE ) {
00170         CloseHandle(file_handle);
00171         file_handle = INVALID_HANDLE_VALUE;
00172     }
00173 }
00174 
00175 <span class="comment">//---------- End of function File::file_close ----------//</span>
00176 
00177 <span class="comment">//-------- Begin of function File::~File ----------//</span>
<a name="l00179"></a><a class="code" href="classFile.html#a1">00179</a> <span class="comment">File::~File() {</span>
00180     file_close();
00181 }
00182 
00183 <span class="comment">//---------- End of function File::~File ----------//</span>
00184 
00185 <span class="comment">//-------- Begin of function File::file_write ----------//</span>
<a name="l00194"></a><a class="code" href="classFile.html#a10">00194</a> <span class="comment">int File::file_write(void* dataBuf, unsigned dataSize) {</span>
00195     <a class="code" href="ALL_8H.html#a0">err_when</a>( file_handle == INVALID_HANDLE_VALUE );<span class="comment">// not initialized</span>
00196 
00197     <span class="keywordflow">if</span>( allow_vary_size ) {                         <span class="comment">// allow the writing size and the read size to be different</span>
00198         <span class="keywordflow">if</span>( dataSize &gt; 0xFFFF )
00199             file_put_unsigned_short(0);                 <span class="comment">// if exceed the unsigned short limit, don't write it</span>
00200         <span class="keywordflow">else</span>
00201             file_put_unsigned_short( dataSize );
00202     }
00203 
00204     DWORD actualWritten;
00205 
00206     <span class="keywordtype">int</span> rc = WriteFile( file_handle, dataBuf, dataSize, &amp;actualWritten, <a class="code" href="OHELP_8H.html#a0">NULL</a>);
00207 
00208     <span class="keywordflow">if</span>( !rc &amp;&amp; handle_error )
00209         err.run( <span class="stringliteral">"Error writing file %s"</span>, file_name );
00210 
00211     <span class="keywordflow">return</span> rc;
00212 }
00213 
00214 <span class="comment">//---------- End of function File::file_write ----------//</span>
00215 
00216 <span class="comment">//-------- Begin of function File::file_read ----------//</span>
<a name="l00225"></a><a class="code" href="classFile.html#a9">00225</a> <span class="comment">int File::file_read(void* dataBuf, unsigned dataSize) {</span>
00226 <span class="preprocessor">#define MAX_READ_SIZE 0xFFF0</span>
00227 <span class="preprocessor"></span>
00228     <a class="code" href="ALL_8H.html#a0">err_when</a>( file_handle == INVALID_HANDLE_VALUE );<span class="comment">// not initialized</span>
00229 
00230     <span class="keywordtype">int</span> curPos=file_pos();
00231 
00232     <span class="comment">//start_read:</span>
00233 
00234     <span class="keywordtype">unsigned</span> readSize=dataSize, writtenSize=dataSize;
00235 
00236     <span class="keywordflow">if</span>( allow_vary_size ) {                         <span class="comment">// allow the writing size and the read size to be different</span>
00237         writtenSize = file_get_unsigned_short();
00238 
00239         <span class="keywordflow">if</span>( writtenSize )                             <span class="comment">// writtenSize==0, if the size &gt; 0xFFFF</span>
00240             readSize = min(dataSize,writtenSize);       <span class="comment">// the read size is the minimum of the written size and the supposed read size</span>
00241     }                                               <span class="comment">//min &amp; max bug chea</span>
00242 
00243     DWORD actualRead;
00244 
00245     <span class="keywordtype">int</span> rc=ReadFile( file_handle, dataBuf, dataSize, &amp;actualRead, <a class="code" href="OHELP_8H.html#a0">NULL</a>);
00246 
00247     <span class="comment">//-------- if the data size has been reduced ----------//</span>
00248 
00249     <span class="keywordflow">if</span>( readSize &lt; writtenSize )
00250         file_seek( writtenSize-readSize, FILE_CURRENT );
00251 
00252     <span class="comment">//---- if the data size has been increased, reset the unread area ---//</span>
00253 
00254     <span class="keywordflow">if</span>( readSize &lt; dataSize )
00255         memset( (<span class="keywordtype">char</span>*)dataBuf+readSize, 0, dataSize-readSize );
00256 
00257     <span class="comment">//----- if reading error, popup box and ask for retry -----//</span>
00258 
00259     <span class="keywordflow">if</span>( !rc &amp;&amp; handle_error ) {
00260         <span class="keywordtype">char</span> msgStr[100];
00261 
00262         sprintf( msgStr, <span class="stringliteral">"Error reading file %s, Retry ?"</span>, file_name );
00263 
00264         <span class="comment">/*if( box.ask(msgStr) )</span>
00265 <span class="comment">          {</span>
00266 <span class="comment">          file_seek( curPos );</span>
00267 <span class="comment">          goto start_read;</span>
00268 <span class="comment">          }*/</span>
00269     }
00270 
00271     <span class="keywordflow">return</span> rc;
00272 }
00273 
00274 <span class="comment">//---------- End of function File::file_read ----------//</span>
00275 
00276 <span class="comment">//-------- Begin of function File::file_put_short ----------//</span>
<a name="l00284"></a><a class="code" href="classFile.html#a12">00284</a> <span class="comment">int File::file_put_short(short value) {</span>
00285     <a class="code" href="ALL_8H.html#a0">err_when</a>( file_handle == INVALID_HANDLE_VALUE );<span class="comment">// not initialized</span>
00286 
00287     DWORD actualWritten;
00288 
00289     <span class="keywordflow">if</span>( WriteFile( file_handle, &amp;value, <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>), &amp;actualWritten, <a class="code" href="OHELP_8H.html#a0">NULL</a> ) )
00290         <span class="keywordflow">return</span> TRUE;
00291     <span class="keywordflow">else</span> {
00292         <span class="keywordflow">if</span>( handle_error )
00293             err.run( <span class="stringliteral">"Error writing file %s"</span>, file_name );
00294 
00295         <span class="keywordflow">return</span> FALSE;
00296     }
00297 }
00298 
00299 <span class="comment">//---------- End of function File::file_put_short ----------//</span>
00300 
00301 <span class="comment">//-------- Begin of function File::file_get_short ----------//</span>
<a name="l00307"></a><a class="code" href="classFile.html#a11">00307</a> <span class="comment">short File::file_get_short() {</span>
00308     <a class="code" href="ALL_8H.html#a0">err_when</a>( file_handle == INVALID_HANDLE_VALUE );<span class="comment">// not initialized</span>
00309 
00310     DWORD actualRead;
00311     <span class="keywordtype">short</span> value;
00312 
00313     <span class="keywordflow">if</span>( ReadFile( file_handle, &amp;value, <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>), &amp;actualRead, <a class="code" href="OHELP_8H.html#a0">NULL</a> ) )
00314         <span class="keywordflow">return</span> value;
00315     <span class="keywordflow">else</span> {
00316         <span class="keywordflow">if</span>( handle_error )
00317             err.run( <span class="stringliteral">"Error reading file %s"</span>, file_name );
00318 
00319         <span class="keywordflow">return</span> FALSE;
00320     }
00321 }
00322 
00323 <span class="comment">//---------- End of function File::file_get_short ----------//</span>
00324 
00325 <span class="comment">//-------- Begin of function File::file_put_unsigned_short ----------//</span>
<a name="l00333"></a><a class="code" href="classFile.html#a14">00333</a> <span class="comment">int File::file_put_unsigned_short(unsigned short value) {</span>
00334     <a class="code" href="ALL_8H.html#a0">err_when</a>( file_handle == INVALID_HANDLE_VALUE );<span class="comment">// not initialized</span>
00335 
00336     DWORD actualWritten;
00337 
00338     <span class="keywordflow">if</span>( WriteFile( file_handle, &amp;value, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), &amp;actualWritten, <a class="code" href="OHELP_8H.html#a0">NULL</a> ) )
00339         <span class="keywordflow">return</span> TRUE;
00340     <span class="keywordflow">else</span> {
00341         <span class="keywordflow">if</span>( handle_error )
00342             err.run( <span class="stringliteral">"Error writing file %s"</span>, file_name );
00343 
00344         <span class="keywordflow">return</span> FALSE;
00345     }
00346 }
00347 
00348 <span class="comment">//---------- End of function File::file_put_unsigned_short ----------//</span>
00349 
00350 <span class="comment">//-------- Begin of function File::file_get_unsigned_short ----------//</span>
<a name="l00356"></a><a class="code" href="classFile.html#a13">00356</a> <span class="comment">unsigned short File::file_get_unsigned_short() {</span>
00357     <a class="code" href="ALL_8H.html#a0">err_when</a>( file_handle == INVALID_HANDLE_VALUE );<span class="comment">// not initialized</span>
00358 
00359     DWORD actualRead;
00360     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> value;
00361 
00362     <span class="keywordflow">if</span>( ReadFile( file_handle, &amp;value, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), &amp;actualRead, <a class="code" href="OHELP_8H.html#a0">NULL</a> ) )
00363         <span class="keywordflow">return</span> value;
00364     <span class="keywordflow">else</span> {
00365         <span class="keywordflow">if</span>( handle_error )
00366             err.run( <span class="stringliteral">"Error reading file %s"</span>, file_name );
00367 
00368         <span class="keywordflow">return</span> 0;
00369     }
00370 }
00371 
00372 <span class="comment">//---------- End of function File::file_get_unsigned_short ----------//</span>
00373 
00374 <span class="comment">//-------- Begin of function File::file_put_long ----------//</span>
<a name="l00382"></a><a class="code" href="classFile.html#a16">00382</a> <span class="comment">int File::file_put_long(long value) {</span>
00383     <a class="code" href="ALL_8H.html#a0">err_when</a>( file_handle == INVALID_HANDLE_VALUE );<span class="comment">// not initialized</span>
00384 
00385     DWORD actualWritten;
00386 
00387     <span class="keywordflow">if</span>( WriteFile( file_handle, &amp;value, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>), &amp;actualWritten, <a class="code" href="OHELP_8H.html#a0">NULL</a> ) )
00388         <span class="keywordflow">return</span> TRUE;
00389     <span class="keywordflow">else</span> {
00390         <span class="keywordflow">if</span>( handle_error )
00391             err.run( <span class="stringliteral">"Error writing file %s"</span>, file_name );
00392 
00393         <span class="keywordflow">return</span> FALSE;
00394     }
00395 }
00396 
00397 <span class="comment">//---------- End of function File::file_put_long ----------//</span>
00398 
00399 <span class="comment">//-------- Begin of function File::file_get_long ----------//</span>
<a name="l00405"></a><a class="code" href="classFile.html#a15">00405</a> <span class="comment">long File::file_get_long() {</span>
00406     <a class="code" href="ALL_8H.html#a0">err_when</a>( file_handle == INVALID_HANDLE_VALUE );<span class="comment">// not initialized</span>
00407 
00408     DWORD actualRead;
00409     <span class="keywordtype">long</span>  value;
00410 
00411     <span class="keywordflow">if</span>( ReadFile( file_handle, &amp;value, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>), &amp;actualRead, <a class="code" href="OHELP_8H.html#a0">NULL</a> ) )
00412         <span class="keywordflow">return</span> value;
00413     <span class="keywordflow">else</span> {
00414         <span class="keywordflow">if</span>( handle_error )
00415             err.run( <span class="stringliteral">"Error reading file %s"</span>, file_name );
00416 
00417         <span class="keywordflow">return</span> FALSE;
00418     }
00419 }
00420 
00421 <span class="comment">//---------- End of function File::file_get_long ----------//</span>
00422 
00423 <span class="comment">//---------- Start of function File::file_seek ---------//</span>
00424 <span class="comment">//</span>
00425 <span class="comment">// &lt;long&gt; offset = seek offset</span>
00426 <span class="comment">// [int]  whence = FILE_BEGIN, FILE_CURRENT, FILE_END</span>
00427 <span class="comment">//                 (default : FILE_BEGIN)</span>
00428 <span class="comment">//</span>
00429 <span class="comment">// return : the offset of the pointer's new position, measured in</span>
00430 <span class="comment">//          bytes from the file beginning.</span>
00431 <span class="comment">//</span>
<a name="l00432"></a><a class="code" href="classFile.html#a7">00432</a> <span class="keywordtype">long</span> <a class="code" href="classFile.html#a7">File::file_seek</a>(<span class="keywordtype">long</span> offset, <span class="keywordtype">int</span> whence) {
00433     <span class="keywordflow">if</span>( whence == -1 )
00434         whence = FILE_BEGIN;
00435 
00436     <span class="keywordflow">return</span> SetFilePointer( <a class="code" href="classFile.html#m1">file_handle</a>, offset, <a class="code" href="OHELP_8H.html#a0">NULL</a>, whence );
00437 }
00438 
00439 <span class="comment">//------------ End of function File::file_seek ----------//</span>
00440 
00441 <span class="comment">//---------- Start of function File::file_pos ---------//</span>
00442 <span class="comment">//</span>
00443 <span class="comment">// Get the position of current file pointer</span>
00444 <span class="comment">//</span>
00445 <span class="comment">// return : the position of current file pointer</span>
00446 <span class="comment">//</span>
<a name="l00447"></a><a class="code" href="classFile.html#a8">00447</a> <span class="keywordtype">long</span> <a class="code" href="classFile.html#a8">File::file_pos</a>() {
00448     <span class="keywordflow">return</span> SetFilePointer( <a class="code" href="classFile.html#m1">file_handle</a>, 0, <a class="code" href="OHELP_8H.html#a0">NULL</a>, FILE_CURRENT );
00449 }
00450 
00451 <span class="comment">//------------ End of function File::file_pos ----------//</span>
00452 
00453 <span class="comment">//---------- Start of function File::file_size ---------//</span>
00454 
<a name="l00455"></a><a class="code" href="classFile.html#a6">00455</a> <span class="keywordtype">long</span> <a class="code" href="classFile.html#a6">File::file_size</a>() {
00456     <span class="keywordflow">return</span> GetFileSize(<a class="code" href="classFile.html#m1">file_handle</a>, <a class="code" href="OHELP_8H.html#a0">NULL</a>);
00457 }
00458 
00459 <span class="comment">//------------ End of function File::file_size ----------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:33 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
