<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OGFILE2.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>OGFILE2.CPP</h1><a href="OGFILE2_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OGFILE2.CPP</span>
00002 <span class="comment">//Description : Object Game file, save game and restore game, part 2</span>
00003 
00004 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00005 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00006 
00007 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00008 <span class="preprocessor">#include &lt;<a class="code" href="OBATTLE_8H.html">OBATTLE.H</a>&gt;</span>
00009 
00010 <span class="comment">//---------------------------//</span>
00011 <span class="preprocessor">#include &lt;<a class="code" href="ODEPTRES_8H.html">ODEPTRES.H</a>&gt;</span>
00012 <span class="preprocessor">#include &lt;<a class="code" href="OSCHLRES_8H.html">OSCHLRES.H</a>&gt;</span>
00013 <span class="preprocessor">#include &lt;OENROLL.H&gt;</span>
00014 <span class="preprocessor">#include &lt;OLETTER.H&gt;</span>                              <span class="comment">//##chea 990519</span>
00015 <span class="preprocessor">#include &lt;OFACURES.H&gt;</span>                             <span class="comment">//## chea 090699</span>
00016 
00017 <span class="comment">//---------------------------//</span>
00018 <span class="preprocessor">#include &lt;OCONFIG.H&gt;</span>
00019 <span class="preprocessor">#include &lt;<a class="code" href="OGAME_8H.html">OGAME.H</a>&gt;</span>
00020 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00021 <span class="preprocessor">#include &lt;OFINANCE.H&gt;</span>
00022 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>
00023 <span class="preprocessor">#include &lt;<a class="code" href="OPOWER_8H.html">OPOWER.H</a>&gt;</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="OBOX_8H.html">OBOX.H</a>&gt;</span>
00026 <span class="preprocessor">#include &lt;<a class="code" href="OSTR_8H.html">OSTR.H</a>&gt;</span>
00027 <span class="preprocessor">#include &lt;<a class="code" href="ODATE_8H.html">ODATE.H</a>&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="OMOUSECR_8H.html">OMOUSECR.H</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="OWORLD_8H.html">OWORLD.H</a>&gt;</span>
00030 <span class="preprocessor">#include &lt;<a class="code" href="OGAME_8H.html">OGAME.H</a>&gt;</span>
00031 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00032 <span class="preprocessor">#include &lt;OAUDIO.H&gt;</span>
00033 <span class="preprocessor">#include &lt;<a class="code" href="OMUSIC_8H.html">OMUSIC.H</a>&gt;</span>
00034 
00035 <span class="comment">//---------------------------//</span>
00036 <span class="preprocessor">#include &lt;ODEPT.H&gt;</span>
00037 <span class="preprocessor">#include &lt;ONEWS.H&gt;</span>
00038 <span class="preprocessor">#include &lt;<a class="code" href="OTASK_8H.html">OTASK.H</a>&gt;</span>
00039 <span class="preprocessor">#include &lt;OCHANCE.H&gt;</span>
00040 
00041 <span class="preprocessor">#include &lt;OATHLETI.H&gt;</span>
00042 <span class="preprocessor">#include &lt;ODEVELOP.H&gt;</span>
00043 <span class="preprocessor">#include &lt;OFACILIT.H&gt;</span>
00044 <span class="preprocessor">#include &lt;OLIBTECH.H&gt;</span>
00045 <span class="preprocessor">#include &lt;OINVEST.H&gt;</span>
00046 <span class="preprocessor">#include &lt;<a class="code" href="OSTUOFF_8H.html">OSTUOFF.H</a>&gt;</span>
00047 
00048 <span class="comment">//---------------------------//</span>
00049 <span class="preprocessor">#include &lt;OGFILE.H&gt;</span>
00050 
00051 <span class="comment">//-------- Define constant ----------//</span>
00052 
<a name="l00053"></a><a class="code" href="OGFILE2_8CPP.html#a0">00053</a> <span class="preprocessor">#define BOOK_MARK 0x1000                          // book mark for validing saving data</span>
00054 <span class="preprocessor"></span>
<a name="l00055"></a><a class="code" href="OGFILE2_8CPP.html#a1">00055</a> <span class="preprocessor">#define read_obj(obj, mark)\</span>
00056 <span class="preprocessor">{ \</span>
00057 <span class="preprocessor">      if( !read_book_mark( BOOK_MARK+(mark) ) )\</span>
00058 <span class="preprocessor">                                                   return 0;\</span>
00059 <span class="preprocessor">                                                                if( !((obj).read_file(filePtr)) )\</span>
00060 <span class="preprocessor">                                                                                                     return 0;\</span>
00061 <span class="preprocessor">                                                                                                                  }</span>
00062 <span class="preprocessor"></span>
<a name="l00063"></a><a class="code" href="OGFILE2_8CPP.html#a2">00063</a> <span class="preprocessor">#define write_obj(obj, mark)\</span>
00064 <span class="preprocessor">{ \</span>
00065 <span class="preprocessor">      write_book_mark( BOOK_MARK+(mark) );\</span>
00066 <span class="preprocessor">                                              if( (!(obj).write_file(filePtr)) )\</span>
00067 <span class="preprocessor">                                                                                    return 0;\</span>
00068 <span class="preprocessor">                                                                                                 }</span>
00069 <span class="preprocessor"></span>
00070 <span class="comment">//----------- Game file format --------------//</span>
00071 <span class="comment">//</span>
00072 <span class="comment">// Data of the following objects will be saved: (yes/no)</span>
00073 <span class="comment">//</span>
00074 <span class="comment">// DepartmentRes                department_res;</span>
00075 <span class="comment">//</span>
00076 <span class="comment">//      n       ImageRes          image_sys, image_interface, image_mascot, image_pict;</span>
00077 <span class="comment">//      y       SchoolRes                       school_res;</span>
00078 <span class="comment">//      n       CourseRes                       course_res;</span>
00079 <span class="comment">//      n       FieldRes                                field_res;</span>
00080 <span class="comment">//      y       DepartmentRes           department_res;</span>
00081 <span class="comment">//      n       FirmRes                         firm_res;</span>
00082 <span class="comment">//      n       TerrainRes                      terrain_res;</span>
00083 <span class="comment">//      n       PlantRes                                plant_res;</span>
00084 <span class="comment">//      n       RoadRes                         road_res;</span>
00085 <span class="comment">//      n       SpriteRes                       sprite_res;</span>
00086 <span class="comment">//      y       FacultyRes                      faculty_res;</span>
00087 <span class="comment">//      n       FacultyPhotoRes faculty_photo_res;</span>
00088 <span class="comment">//      n       GameStrRes                      game_str_res;</span>
00089 <span class="comment">//      n       NameRes                         name_res;</span>
00090 <span class="comment">//      y       EnrollRes                       enroll_res;</span>
00091 <span class="comment">//      y       Letter                          letter;</span>
00092 <span class="comment">//      n       BlackBoard                      blackboard;</span>
00093 <span class="comment">//</span>
00094 <span class="comment">// y PlayerSchool               player_school;</span>
00095 <span class="comment">// n Battle            battle;</span>
00096 <span class="comment">// y Config            config;</span>
00097 <span class="comment">// y Game              game;</span>
00098 <span class="comment">// n GameSet           game_set;</span>
00099 <span class="comment">// y Finance                            finance;</span>
00100 <span class="comment">// y Info              info;</span>
00101 <span class="comment">// n Power             power;</span>
00102 <span class="comment">//   World             world;</span>
00103 <span class="comment">//</span>
00104 <span class="comment">//              FirmArray         firm_array;                   // call battle.generate_static_objects() instead</span>
00105 <span class="comment">//      n       SpriteArray                     sprite_array;</span>
00106 <span class="comment">//      y       DepartmentArray department_array;</span>
00107 <span class="comment">//      y       NewsArray                       news_array;</span>
00108 <span class="comment">//      y       TaskArray                       task_array;</span>
00109 <span class="comment">//      y       ChanceEvent                     chance_event;</span>
00110 <span class="comment">//</span>
00111 <span class="comment">//      n       UserInterface           user_interface;</span>
00112 <span class="comment">//      n       AdmOffice                       adm_office;</span>
00113 <span class="comment">//      y       Development                     development_office;</span>
00114 <span class="comment">//      n       Optimization            optimization;</span>
00115 <span class="comment">//      n       OptStage3         opt_stage3;</span>
00116 <span class="comment">//      y       Athletics                       athletics_office;</span>
00117 <span class="comment">//      y       LibTech                         library_tech_office;</span>
00118 <span class="comment">//      y       Facility                                facility_office;</span>
00119 <span class="comment">//      y       Investment                      investment_office;</span>
00120 <span class="comment">//      y       StudentOffice           student_office;         // fred 980918</span>
00121 <span class="comment">//      n       Help                                    help;</span>
00122 <span class="comment">//      n       Test                                    test;</span>
00123 <span class="comment">//      n       GameSetting                     game_setting;</span>
00124 <span class="comment">//-------------------------------------------//</span>
00125 
00126 <span class="comment">//--------- Define static vars ---------//</span>
00127 
00128 <span class="keyword">static</span> <span class="keywordtype">int</span> loaded_random_seed;
00129 
00130 <span class="comment">//-------- Define static class member vars -------//</span>
00131 
<a name="l00132"></a><a class="code" href="classGameFile.html#p0">00132</a> <a class="code" href="classFile.html">File</a>* <a class="code" href="classGameFile.html#p0">GameFile::file_ptr</a>;
<a name="l00133"></a><a class="code" href="classGameFile.html#p1">00133</a> <span class="keywordtype">char</span>  <a class="code" href="classGameFile.html#p1">GameFile::last_read_success_flag</a>=0;
00134 
00135 <span class="comment">//-------- Begin of function GameFile::write_express_file -------//</span>
<a name="l00142"></a><a class="code" href="classGameFile.html#a3">00142</a> <span class="comment">int GameFile::save_express_game(char* fileName) {</span>
00143     <a class="code" href="classFile.html">File</a>   file;
00144     <a class="code" href="classString.html">String</a> errStr;
00145 
00146     power.win_opened=1;                             <span class="comment">// to disable power.mouse_handler()</span>
00147 
00148     <span class="keywordflow">if</span>( fileName )
00149         strcpy( file_name, fileName );
00150 
00151     <span class="keywordtype">int</span> rc = 1;
00152     <span class="keywordtype">char</span> lowDiskSpaceFlag = 0;
00153     DWORD sectorPerCluster = 0;
00154     DWORD bytePerSector = 0;
00155     DWORD freeCluster = 0;
00156     DWORD totalCluster = 0;
00157     <span class="keywordflow">if</span>( GetDiskFreeSpace( <a class="code" href="OHELP_8H.html#a0">NULL</a>,                     <span class="comment">// address of root path, NULL means the current root directory</span>
00158                           &amp;sectorPerCluster, &amp;bytePerSector, &amp;freeCluster, &amp;totalCluster)) {
00159         DWORD freeSpace = DWORD( (<span class="keywordtype">double</span>)freeCluster * sectorPerCluster * bytePerSector / 1024.0);
00160 
00161         <span class="keywordflow">if</span>( m.is_file_exist(file_name) ) {
00162             <span class="comment">// if overwritting existing file, count the file size of the existing file</span>
00163             file.<a class="code" href="classFile.html#a2">file_open</a>(file_name);
00164             freeSpace += file.<a class="code" href="classFile.html#a6">file_size</a>() / 1024;       <span class="comment">// count the existing space</span>
00165             file.<a class="code" href="classFile.html#a5">file_close</a>();
00166         }
00167         <span class="keywordflow">if</span>( !(rc = freeSpace &gt;= <a class="code" href="Ogfile_8h.html#a0">MIN_FREE_SPACE</a>) ) {
00168             errStr = <span class="stringliteral">"Insufficient disk space ! The game is not saved."</span>;
00169             lowDiskSpaceFlag = 1;
00170         }
00171     }
00172 
00173     <span class="keywordflow">if</span>( rc ) {
00174         rc = file.<a class="code" href="classFile.html#a3">file_create</a>( file_name, 0, 1 );     <span class="comment">// 0=tell File don't handle error itself</span>
00175         <span class="comment">// 1=allow the writing size and the read size to be different</span>
00176         <span class="keywordflow">if</span>( !rc )
00177             errStr = <span class="stringliteral">"Error creating saved game file."</span>;
00178     }
00179 
00180     <a class="code" href="classFile.html">File</a>* filePtr = &amp;file;
00181     file_ptr = &amp;file;                               <span class="comment">// for write_book_mark()</span>
00182 
00183     <span class="comment">//----- check valid version first ------//</span>
00184 
00185     <span class="keywordflow">if</span>( rc ) {
00186         <span class="comment">//              save_process();      // process game data before saving the game</span>
00187 
00188         rc = write_game_header(file_ptr);             <span class="comment">// write saved game header information</span>
00189 
00190         <span class="keywordflow">if</span>( game_file_array.demo_format )
00191             file_ptr-&gt;file_put_short( -<a class="code" href="Gamedef_8h.html#a0">GAME_VERSION</a> );  <span class="comment">// negative no. means shareware version</span>
00192         <span class="keywordflow">else</span>
00193             file_ptr-&gt;file_put_short( <a class="code" href="Gamedef_8h.html#a0">GAME_VERSION</a> );
00194 
00195         <span class="keywordflow">if</span>( !rc )
00196             errStr = <span class="stringliteral">"Error creating saved game header."</span>;
00197 
00198         <span class="keywordflow">if</span>( rc ) {
00199             <span class="comment">// put data to file here</span>
00200             <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(player_school, 1);
00201 
00202             <span class="keywordflow">if</span>( !rc )
00203                 errStr = <span class="stringliteral">"Error writing saved game data."</span>;
00204         }
00205     }
00206 
00207     <span class="comment">//------------Close file----------------------------//</span>
00208     file.<a class="code" href="classFile.html#a5">file_close</a>();
00209 
00210     power.win_opened=0;
00211 
00212     <span class="comment">//------- when saving error ---------//</span>
00213 
00214     <span class="keywordflow">if</span>( !rc ) {
00215         <span class="keywordflow">if</span>( !lowDiskSpaceFlag )
00216             remove( file_name );                        <span class="comment">// delete the file as it is not complete</span>
00217 
00218 <span class="preprocessor">#ifndef DEBUG</span>
00219 <span class="preprocessor"></span>        <span class="comment">// use this message for all types of error message in the release version</span>
00220         errStr = <span class="stringliteral">"Insufficient disk space ! The game is not saved."</span>;
00221 <span class="preprocessor">#endif</span>
00222 <span class="preprocessor"></span>
00223         box.msg( errStr );
00224     }
00225 
00226     <span class="keywordflow">return</span> rc;
00227 }
00228 
00229 <span class="comment">//---------- End of function GameFile::save_express_game -------//</span>
00230 
00231 <span class="comment">//-------- Begin of function GameFile::load_express_game -------//</span>
<a name="l00239"></a><a class="code" href="classGameFile.html#a4">00239</a> <span class="comment">int GameFile::load_express_game(char* fileName) {</span>
00240     <a class="code" href="classFile.html">File</a> file;
00241     <span class="keywordtype">int</span>  rc=0;
00242     <span class="keywordtype">char</span> *errMsg = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00243 
00244     power.win_opened=1;                             <span class="comment">// to disable power.mouse_handler()</span>
00245 
00246     <span class="keywordtype">int</span> oldCursor = mouse_cursor.get_icon();
00247     mouse_cursor.set_icon( <a class="code" href="OMOUSECR_8H.html#a6a5">CURSOR_WAITING</a> );
00248 
00249     <span class="keywordtype">int</span> powerEnableFlag = power.enable_flag;
00250 
00251     <span class="keywordflow">if</span>( fileName )
00252         strcpy( file_name, fileName );
00253 
00254     rc = 1;
00255     <span class="keywordflow">if</span>( !file.<a class="code" href="classFile.html#a2">file_open</a>( file_name, 0, 1 ) ) {      <span class="comment">// 0=tell File don't handle error itself</span>
00256         rc = 0;
00257         errMsg = <span class="stringliteral">"Cannot open save game file"</span>;
00258     }
00259 
00260     <span class="comment">//-------- read in the GameFile class --------//</span>
00261 
00262     <span class="keywordflow">if</span>( rc ) {
00263         <span class="keywordtype">char</span> gameFileName[MAX_PATH+1];
00264 
00265         strcpy( gameFileName, file_name );            <span class="comment">// save the file name actually read, in case that the file names are different</span>
00266 
00267         <span class="comment">// read_file_header: read the whole object from the saved game file</span>
00268         <span class="keywordflow">if</span>( !file.<a class="code" href="classFile.html#a9">file_read</a>(<span class="keyword">this</span>, <span class="keyword">sizeof</span>(<a class="code" href="classGameFile.html">GameFile</a>)) ) {
00269             rc = 0;
00270             errMsg = <span class="stringliteral">"Cannot read file header"</span>;
00271         }
00272 
00273         <span class="keywordflow">if</span>( rc ) {
00274             <a class="code" href="ALL_8H.html#a2">err_if</a> ( file.<a class="code" href="classFile.html#a11">file_get_short</a>() != 0x99 )    <span class="comment">// the end of header</span>
00275                 <a class="code" href="ALL_8H.html#a1">err_here</a>();
00276 
00277             <span class="keywordflow">if</span>( !validate_header() ) {
00278                 rc = 0;
00279                 errMsg = <span class="stringliteral">"Save game incompatible"</span>;
00280             }
00281             <span class="keywordflow">else</span>
00282                 strcpy( file_name, gameFileName );
00283         }
00284     }
00285 
00286     <span class="comment">//--------------------------------------------//</span>
00287     <span class="comment">//----- check version no. first ------//</span>
00288     <a class="code" href="classFile.html">File</a>* filePtr = &amp;file;
00289     file_ptr = &amp;file;                               <span class="comment">// for read_book_mark()</span>
00290 
00291     <span class="comment">//-------------------------------------//</span>
00292 
00293     <span class="comment">// compare major version</span>
00294     <span class="keywordflow">if</span>( file_ptr-&gt;file_get_short()/100 != (game_file_array.demo_format ? -(<a class="code" href="Gamedef_8h.html#a0">GAME_VERSION</a>/100) : <a class="code" href="Gamedef_8h.html#a0">GAME_VERSION</a>/100) )
00295         <span class="keywordflow">return</span> -1;
00296 
00297     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(player_school, 1);
00298 
00299     <span class="comment">//-------------------------------------//</span>
00300 
00301     file.<a class="code" href="classFile.html#a5">file_close</a>();
00302 
00303     power.enable_flag = powerEnableFlag;
00304 
00305     mouse_cursor.restore_icon( oldCursor );
00306 
00307     power.win_opened=0;
00308 
00309     <span class="comment">//---------------------------------------//</span>
00310 
00311     <span class="keywordflow">switch</span>(rc) {                                    <span class="comment">// don't display msg if loaded successfully (rc==1)</span>
00312     <span class="keywordflow">case</span> 0:
00313     <span class="keywordflow">case</span> -1:
00314         box.msg( errMsg );
00315         <span class="keywordflow">break</span>;
00316     }
00317 
00318     last_read_success_flag = rc;                    <span class="comment">// for external functions to read.</span>
00319 
00320     <span class="keywordflow">return</span> rc;
00321 }
00322 
00323 <span class="comment">//---------- End of function GameFile::load_express_file -------//</span>
00324 
00325 <span class="comment">//-------- Begin of function GameFile::write_file -------//</span>
00332 <span class="comment">int GameFile::write_file(File* filePtr) {</span>
00333     file_ptr = filePtr;                             <span class="comment">// for write_book_mark()</span>
00334 
00335     <span class="comment">//----- check valid version first ------//</span>
00336 
00337     <span class="keywordflow">if</span>( game_file_array.demo_format )
00338         filePtr-&gt;file_put_short( -<a class="code" href="Gamedef_8h.html#a0">GAME_VERSION</a> );     <span class="comment">// negative no. means shareware version</span>
00339     <span class="keywordflow">else</span>
00340         filePtr-&gt;file_put_short( <a class="code" href="Gamedef_8h.html#a0">GAME_VERSION</a> );
00341 
00342     <span class="comment">//------------------------------------------------//</span>
00343     <span class="comment">//</span>
00344     <span class="comment">// The order of writing data is different between</span>
00345     <span class="comment">// the shareware and registered version.</span>
00346     <span class="comment">//</span>
00347     <span class="comment">//------------------------------------------------//</span>
00348 
00349     <span class="keywordflow">if</span>( game_file_array.demo_format ) {
00350         <span class="keywordflow">if</span>( !write_file_1(filePtr) )
00351             <span class="keywordflow">return</span> 0;
00352 
00353         <span class="keywordflow">if</span>( !write_file_2(filePtr) )
00354             <span class="keywordflow">return</span> 0;
00355     }
00356     <span class="keywordflow">else</span> {
00357         <span class="keywordflow">if</span>( !write_file_2(filePtr) )
00358             <span class="keywordflow">return</span> 0;
00359 
00360         <span class="keywordflow">if</span>( !write_file_1(filePtr) )
00361             <span class="keywordflow">return</span> 0;
00362     }
00363 
00364     <span class="keywordflow">if</span>( !write_file_3(filePtr) )
00365         <span class="keywordflow">return</span> 0;
00366 
00367     <span class="keywordflow">return</span> 1;
00368 }
00369 
00370 <span class="comment">//---------- End of function GameFile::write_file -------//</span>
00371 
00372 <span class="comment">//-------- Begin of function GameFile::read_file -------//</span>
00380 <span class="comment">int GameFile::read_file(File* filePtr) {</span>
00381     file_ptr = filePtr;                             <span class="comment">// for read_book_mark()</span>
00382 
00383     <span class="comment">//----- check version no. first ------//</span>
00384 
00385     <span class="comment">//-------------------------------------//</span>
00386 
00387     battle.create_static_game_object();             <span class="comment">// in order to call deptPtr-&gt;create_department_firm() later; since we don't save firm_array</span>
00388 
00389     <span class="comment">//-------------------------------------//</span>
00390 
00391     <span class="keywordtype">int</span> originalRandomSeed = m.get_random_seed();
00392 
00393     <span class="comment">// compare major version</span>
00394     <span class="keywordflow">if</span>( filePtr-&gt;file_get_short()/100 != (game_file_array.demo_format ? -(<a class="code" href="Gamedef_8h.html#a0">GAME_VERSION</a>/100) : <a class="code" href="Gamedef_8h.html#a0">GAME_VERSION</a>/100) )
00395         <span class="keywordflow">return</span> -1;
00396 
00397     <span class="comment">//------------------------------------------------//</span>
00398     <span class="comment">//</span>
00399     <span class="comment">// The order of writing data is different between</span>
00400     <span class="comment">// the shareware and registered version.</span>
00401     <span class="comment">//</span>
00402     <span class="comment">//------------------------------------------------//</span>
00403 
00404     <span class="keywordflow">if</span>( game_file_array.demo_format ) {
00405         <span class="keywordflow">if</span>( !read_file_1(filePtr) )
00406             <span class="keywordflow">return</span> 0;
00407 
00408         <span class="keywordflow">if</span>( !read_file_2(filePtr) )
00409             <span class="keywordflow">return</span> 0;
00410     }
00411     <span class="keywordflow">else</span> {
00412         <span class="keywordflow">if</span>( !read_file_2(filePtr) )
00413             <span class="keywordflow">return</span> 0;
00414 
00415         <span class="keywordflow">if</span>( !read_file_1(filePtr) )
00416             <span class="keywordflow">return</span> 0;
00417     }
00418 
00419     <span class="keywordflow">if</span>( !read_file_3(filePtr) )
00420         <span class="keywordflow">return</span> 0;
00421 
00422     <span class="comment">//-------------------------------------//</span>
00423 
00424     <a class="code" href="ALL_8H.html#a0">err_when</a>( originalRandomSeed != m.get_random_seed() );
00425 
00426     loaded_random_seed = info.random_seed_4_save;   <span class="comment">//## chea 210899 to load the random seed</span>
00427 
00428     m.set_random_seed(loaded_random_seed);
00429 
00430     <span class="keywordflow">return</span> 1;
00431 }
00432 
00433 <span class="comment">//---------- End of function GameFile::read_file -------//</span>
00434 
00435 <span class="comment">//-------- Begin of function GameFile::write_file_1 -------//</span>
00440 <span class="comment">int GameFile::write_file_1(File* filePtr) {</span>
00441     <span class="comment">// write *_res objects</span>
00442 
00443     <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(department_res, 1);
00444 
00445     <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(school_res, 2);
00446 
00447     <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(enroll_res, 3);
00448 
00449     <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(letter, 4);                           <span class="comment">//## chea 990519</span>
00450 
00451     <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(faculty_res, 5);                      <span class="comment">//## chea 090699</span>
00452 
00453     <span class="keywordflow">return</span> 1;
00454 }
00455 
00456 <span class="comment">//---------- End of function GameFile::write_file_1 -------//</span>
00457 
00458 <span class="comment">//-------- Begin of function GameFile::write_file_2 -------//</span>
00465 <span class="comment">int GameFile::write_file_2(File* filePtr) {</span>
00466     <span class="comment">// write game surface objects</span>
00467 
00468     write_book_mark( <a class="code" href="OGFILE2_8CPP.html#a0">BOOK_MARK</a>+101 );
00469 
00470     <span class="keywordflow">if</span>( !game.write_file(filePtr) )
00471         <span class="keywordflow">return</span> 0;
00472 
00473     write_book_mark( <a class="code" href="OGFILE2_8CPP.html#a0">BOOK_MARK</a>+102 );
00474 
00475     <span class="keywordflow">if</span>( !config.write_file(filePtr) )               <span class="comment">// 1110</span>
00476         <span class="keywordflow">return</span> 0;
00477 
00478     write_book_mark( <a class="code" href="OGFILE2_8CPP.html#a0">BOOK_MARK</a>+103 );
00479 
00480     <span class="keywordflow">if</span>( !info.write_file(filePtr) )                 <span class="comment">// 1110</span>
00481         <span class="keywordflow">return</span> 0;
00482 
00483     write_book_mark( <a class="code" href="OGFILE2_8CPP.html#a0">BOOK_MARK</a>+104 );
00484 
00485     <span class="keywordflow">if</span>( !finance.write_file(filePtr) )              <span class="comment">// 1110</span>
00486         <span class="keywordflow">return</span> 0;
00487 
00488     write_book_mark( <a class="code" href="OGFILE2_8CPP.html#a0">BOOK_MARK</a>+105 );
00489 
00490     <span class="keywordflow">if</span>( !player_school.write_file(filePtr) )        <span class="comment">// 1110</span>
00491         <span class="keywordflow">return</span> 0;
00492 
00493     <span class="keywordflow">return</span> 1;
00494 }
00495 
00496 <span class="comment">//---------- End of function GameFile::write_file_2 -------//</span>
00497 
00498 <span class="comment">//-------- Begin of function GameFile::write_file_3 -------//</span>
00503 <span class="comment">int GameFile::write_file_3(File* filePtr) {</span>
00504     <span class="comment">// write game data objects</span>
00505 
00506     <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(department_array, 201);
00507 
00508     <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(news_array, 202);
00509     <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(task_array, 203);
00510     <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(chance_event, 204);
00511 
00512     <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(development_office, 205);
00513     <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(athletics_office, 206);
00514     <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(library_tech_office, 207);
00515     <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(facility_office, 208);
00516     <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(investment_office, 209);
00517     <a class="code" href="OGFILE2_8CPP.html#a2">write_obj</a>(student_office, 210);
00518 
00519     <span class="keywordflow">return</span> 1;
00520 }
00521 
00522 <span class="comment">//---------- End of function GameFile::write_file_3 -------//</span>
00523 
00524 <span class="comment">//-------- Begin of function GameFile::read_file_1 -------//</span>
00529 <span class="comment">int GameFile::read_file_1(File* filePtr) {</span>
00530     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(department_res, 1);
00531 
00532     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(school_res, 2);
00533 
00534     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(enroll_res, 3);
00535 
00536     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(letter, 4);                            <span class="comment">//## chea 990519</span>
00537 
00538     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(faculty_res, 5);                       <span class="comment">//## chea 090699</span>
00539 
00540     <span class="keywordflow">return</span> 1;
00541 }
00542 
00543 <span class="comment">//---------- End of function GameFile::read_file_1 -------//</span>
00544 
00545 <span class="comment">//-------- Begin of function GameFile::read_file_2 -------//</span>
00550 <span class="comment">int GameFile::read_file_2(File* filePtr) {</span>
00551     <span class="keywordflow">if</span>( !read_book_mark( <a class="code" href="OGFILE2_8CPP.html#a0">BOOK_MARK</a>+101 ) )
00552         <span class="keywordflow">return</span> 0;
00553 
00554     <span class="keywordflow">if</span>( !game.read_file(filePtr) )
00555         <span class="keywordflow">return</span> 0;
00556 
00557     <span class="keywordflow">if</span>( !read_book_mark( <a class="code" href="OGFILE2_8CPP.html#a0">BOOK_MARK</a>+102 ) )
00558         <span class="keywordflow">return</span> 0;
00559 
00560     <span class="keywordflow">if</span>( !config.read_file(filePtr, 1) )             <span class="comment">// 1-keep system settings</span>
00561         <span class="keywordflow">return</span> 0;
00562 
00563     <span class="keywordflow">if</span>( !read_book_mark( <a class="code" href="OGFILE2_8CPP.html#a0">BOOK_MARK</a>+103 ) )
00564         <span class="keywordflow">return</span> 0;
00565 
00566     <span class="keywordflow">if</span>( !info.read_file(filePtr) )
00567         <span class="keywordflow">return</span> 0;
00568 
00569     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(finance, 104);
00570 
00571     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(player_school, 105)
00572 
00573         <span class="keywordflow">return</span> 1;
00574 }
00575 
00576 <span class="comment">//---------- End of function GameFile::read_file_2 -------//</span>
00577 
00578 <span class="comment">//-------- Begin of function GameFile::read_file_3 -------//</span>
00583 <span class="comment">int GameFile::read_file_3(File* filePtr) {</span>
00584 
00585     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(department_array, 201);
00586 
00587     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(news_array, 202);
00588     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(task_array, 203);
00589     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(chance_event, 204);
00590 
00591     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(development_office, 205);
00592     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(athletics_office, 206);
00593     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(library_tech_office, 207);
00594     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(facility_office, 208);
00595     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(investment_office, 209);
00596     <a class="code" href="OGFILE2_8CPP.html#a1">read_obj</a>(student_office, 210);
00597 
00598     <span class="keywordflow">return</span> 1;
00599 }
00600 
00601 <span class="comment">//---------- End of function GameFile::read_file_3 -------//</span>
00602 
00603 <span class="comment">//-------- Begin of function GameFile::write_book_mark -------//</span>
00605 <span class="comment">void GameFile::write_book_mark(short bookMark) {</span>
00606     sys.yield();
00607 
00608     file_ptr-&gt;file_put_short(bookMark);
00609 }
00610 
00611 <span class="comment">//---------- End of function GameFile::write_book_mark -------//</span>
00612 
00613 <span class="comment">//-------- Begin of function GameFile::read_book_mark -------//</span>
00618 <span class="comment">int GameFile::read_book_mark(short bookMark) {</span>
00619     sys.yield();
00620 
00621     <span class="keywordtype">short</span> chk = file_ptr-&gt;file_get_short();
00622 
00623 <span class="preprocessor">#ifdef DEBUG</span>
00624 <span class="preprocessor"></span>    <a class="code" href="ALL_8H.html#a0">err_when</a>( chk != bookMark);
00625 <span class="preprocessor">#endif</span>
00626 <span class="preprocessor"></span>
00627     <span class="keywordflow">return</span> chk == bookMark;
00628 }
00629 
00630 <span class="comment">//---------- End of function GameFile::read_book_mark -------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:46 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
