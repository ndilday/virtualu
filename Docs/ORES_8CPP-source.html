<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ORES.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>ORES.CPP</h1><a href="ORES_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : ORES.CPP</span>
00002 <span class="comment">//Description : Resource library handling object</span>
00003 
00004 <span class="preprocessor">#include &lt;string.h&gt;</span>
00005 
00006 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00007 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00008 <span class="preprocessor">#include &lt;<a class="code" href="ORES_8H.html">ORES.H</a>&gt;</span>
00009 
00010 <span class="comment">//------------ Format of RES file -------------//</span>
00011 <span class="comment">//</span>
00012 <span class="comment">// In the resource file, contain many data unit.</span>
00013 <span class="comment">//</span>
00014 <span class="comment">// &lt;int&gt;  = no. of data records in this RES file</span>
00015 <span class="comment">//</span>
00016 <span class="comment">// Index area</span>
00017 <span class="comment">// &lt;long&gt; = offset of corresponding data unit in this file</span>
00018 <span class="comment">//   .</span>
00019 <span class="comment">//   .</span>
00020 <span class="comment">// &lt;long&gt; = the last index is a virtual index which is used to calculate</span>
00021 <span class="comment">//          the size of the last data unit</span>
00022 <span class="comment">//</span>
00023 <span class="comment">// Data area</span>
00024 <span class="comment">// &lt;char..&gt;  = data</span>
00025 <span class="comment">//</span>
00026 <span class="comment">//---------------------------------------------</span>
00027 <span class="comment">//</span>
00028 <span class="comment">// size of data unit = next offset - current offset</span>
00029 <span class="comment">//</span>
00030 <span class="comment">//---------------------------------------------//</span>
00031 
00032 <span class="comment">//---------- Begin of function Resource::init ----------//</span>
<a name="l00039"></a><a class="code" href="classResource.html#a3">00039</a> <span class="comment">void Resource::init(char* resName, int readAll, int useCommonBuf) {</span>
00040     <span class="keywordflow">if</span>( init_flag )
00041         deinit();
00042 
00043     <span class="comment">//-------------------------------------------//</span>
00044 
00045     <span class="keywordtype">long</span> dataSize;
00046 
00047     file_open(resName);
00048 
00049     read_all      = readAll;
00050     use_common_buf   = useCommonBuf;
00051     data_buf      = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00052     data_buf_size = 0 ;
00053 
00054     rec_count  = file_get_short();
00055     cur_rec_no = -1;
00056 
00057     <span class="comment">//---------- Read in record index -------------//</span>
00058 
00059     index_buf = (<span class="keywordtype">long</span>*) <a class="code" href="ALL_8H.html#a5">mem_add</a>( (rec_count+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>) );
00060 
00061     <span class="comment">// rec_count+1 is the last index pointer for calculating last record size</span>
00062 
00063     file_read( index_buf, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>) * (rec_count+1) );
00064 
00065     <span class="comment">//---------- Read in record data -------------//</span>
00066 
00067     <span class="keywordflow">if</span>( read_all ) {
00068         dataSize = index_buf[rec_count] - index_buf[0];
00069 
00070         data_buf = <a class="code" href="ALL_8H.html#a5">mem_add</a>( dataSize );
00071         file_read( data_buf, dataSize );
00072 
00073         file_close();
00074     }
00075     <span class="keywordflow">else</span> {
00076         <span class="keywordflow">if</span>( use_common_buf )
00077             data_buf = sys.common_data_buf;
00078     }
00079 
00080     init_flag = 1;
00081 }
00082 
00083 <span class="comment">//----------- End of function Resource::init -------------//</span>
00084 
00085 <span class="comment">//---------- Begin of function Resource::deinit ---------//</span>
<a name="l00087"></a><a class="code" href="classResource.html#a4">00087</a> <span class="comment">void Resource::deinit() {</span>
00088     <span class="keywordflow">if</span>( init_flag ) {
00089         <span class="keywordflow">if</span>( index_buf ) {
00090             <a class="code" href="ALL_8H.html#a8">mem_del</a>(index_buf);
00091             index_buf = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00092         }
00093 
00094         <span class="keywordflow">if</span>( data_buf &amp;&amp; data_buf != sys.common_data_buf ) {
00095             <a class="code" href="ALL_8H.html#a8">mem_del</a>(data_buf);
00096             data_buf=<a class="code" href="OHELP_8H.html#a0">NULL</a>;
00097         }
00098 
00099         <span class="keywordflow">if</span>( !read_all )
00100             file_close();
00101 
00102         init_flag=0;
00103     }
00104 }
00105 
00106 <span class="comment">//----------- End of function Resource::deinit ------------//</span>
00107 
00108 <span class="comment">//---------- Begin of function Resource::read ----------//</span>
<a name="l00123"></a><a class="code" href="classResource.html#a6">00123</a> <span class="comment">char* Resource::read(int recNo) {</span>
00124     <a class="code" href="ALL_8H.html#a0">err_when</a>( !init_flag );
00125 
00126     <span class="keywordtype">unsigned</span> dataSize;
00127 
00128     <span class="keywordflow">if</span>( recNo &lt; 1 )
00129         recNo = cur_rec_no;
00130 
00131     <a class="code" href="ALL_8H.html#a0">err_when</a>( recNo &lt; 1 || recNo &gt; rec_count );
00132 
00133     <span class="keywordflow">if</span>( recNo &lt; 1 || recNo &gt; rec_count )            <span class="comment">// when no in debug mode, err_when() will be removed</span>
00134         <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00135 
00136     <span class="comment">//------ all data pre-loaded to memory ------//</span>
00137 
00138     <span class="keywordflow">if</span>( read_all )
00139         <span class="keywordflow">return</span> data_buf + index_buf[recNo-1] - index_buf[0];
00140 
00141     <span class="comment">//------ all data NOT pre-loaded to memory -------//</span>
00142 
00143     <span class="keywordflow">if</span>( recNo == cur_rec_no &amp;&amp; !use_common_buf )
00144         <span class="keywordflow">return</span> data_buf;
00145 
00146     dataSize = index_buf[recNo] - index_buf[recNo-1];
00147 
00148     <a class="code" href="ALL_8H.html#a0">err_when</a>( use_common_buf &amp;&amp; dataSize &gt; <a class="code" href="Osys_8h.html#a40a2">COMMON_DATA_BUF_SIZE</a> );
00149 
00150     <span class="keywordflow">if</span>( !use_common_buf &amp;&amp; data_buf_size &lt; dataSize )
00151         data_buf = <a class="code" href="ALL_8H.html#a7">mem_resize</a>( data_buf, dataSize );
00152 
00153     data_buf_size = dataSize;
00154 
00155     <span class="comment">//------------ read data ------------//</span>
00156 
00157     file_seek( index_buf[recNo-1] );
00158 
00159     file_read( data_buf, dataSize );
00160 
00161     <span class="keywordflow">return</span> data_buf;
00162 }
00163 
00164 <span class="comment">//----------- End of function Resource::read -------------//</span>
00165 
00166 <span class="comment">//---------- Begin of function Resource::get_file ----------//</span>
<a name="l00180"></a><a class="code" href="classResource.html#a7">00180</a> <span class="comment">File* Resource::get_file(int recNo, int&amp; dataSize) {</span>
00181     <a class="code" href="ALL_8H.html#a0">err_when</a>( !init_flag || read_all );             <span class="comment">// if read_all, all data in file has been read in and the file has been closed</span>
00182 
00183     <a class="code" href="ALL_8H.html#a0">err_when</a>( recNo &lt; 1 || recNo &gt; rec_count );
00184 
00185     <span class="keywordflow">if</span>( recNo &lt; 1 || recNo &gt; rec_count )            <span class="comment">// when no in debug mode, err_when() will be removed</span>
00186         <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00187 
00188     file_seek( index_buf[recNo-1] );
00189 
00190     <span class="keywordflow">return</span> <span class="keyword">this</span>;
00191 }
00192 
00193 <span class="comment">//----------- End of function Resource::get_file -------------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:17 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
