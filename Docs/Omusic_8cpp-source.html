<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Omusic.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Omusic.cpp</h1><a href="Omusic_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">// Filename    : OMUSIC.CPP</span>
00002 <span class="comment">// Description : music</span>
00003 
00004 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00005 <span class="preprocessor">#include &lt;GAMEDEF.H&gt;</span>
00006 <span class="preprocessor">#include &lt;OAUDIO.H&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="OMUSIC_8H.html">OMUSIC.H</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00009 <span class="preprocessor">#include &lt;OCONFIG.H&gt;</span>
00010 <span class="preprocessor">#include &lt;OVGABUF.H&gt;</span>
00011 
00012 <span class="comment">// -------- define constant --------//</span>
00013 <span class="comment">// random select 1 - 17 for background music</span>
00014 
<a name="l00015"></a><a class="code" href="Omusic_8cpp.html#a0">00015</a> <span class="preprocessor">#define LOW_RANDOM_SONG   1</span>
<a name="l00016"></a><a class="code" href="Omusic_8cpp.html#a1">00016</a> <span class="preprocessor"></span><span class="preprocessor">#define HIGH_RANDOM_SONG  17</span>
00017 <span class="preprocessor"></span>
00018 <span class="comment">// -------- begin of function Music::Music ---------//</span>
<a name="l00019"></a><a class="code" href="classMusic.html#a0">00019</a> <a class="code" href="classMusic.html#a0">Music::Music</a>() {
00020     <a class="code" href="classMusic.html#m0">init_flag</a> = 0;
00021     <a class="code" href="classMusic.html#m1">song_id</a> = 0;
00022     <a class="code" href="classMusic.html#m2">music_channel</a> = 0;
00023 }
00024 
00025 <span class="comment">// -------- end of function Music::Music ---------//</span>
00026 
00027 <span class="comment">// -------- begin of function Music::~Music ---------//</span>
<a name="l00028"></a><a class="code" href="classMusic.html#a1">00028</a> <a class="code" href="classMusic.html#a1">Music::~Music</a>() {
00029     <a class="code" href="classMusic.html#a3">deinit</a>();
00030 }
00031 
00032 <span class="comment">// -------- end of function Music::~Music ---------//</span>
00033 
00034 <span class="comment">// -------- begin of function Music::init ---------//</span>
00035 <span class="comment">// note : call Music::init after audio.init</span>
<a name="l00036"></a><a class="code" href="classMusic.html#a2">00036</a> <span class="keywordtype">void</span> <a class="code" href="classMusic.html#a2">Music::init</a>() {
00037     <a class="code" href="classMusic.html#a3">deinit</a>();
00038     <a class="code" href="classMusic.html#m0">init_flag</a> = audio.init_flag;
00039 
00040 <span class="preprocessor">#ifdef DEBUG</span>
00041 <span class="preprocessor"></span>    <span class="comment">//if ( init_flag )</span>
00042     <span class="comment">//DEBUG_LOG("Music:: set init_flag");</span>
00043 <span class="preprocessor">#endif</span>
00044 <span class="preprocessor"></span>}
00045 
00046 <span class="comment">// -------- end of function Music::init ---------//</span>
00047 
00048 <span class="comment">// -------- begin of function Music::deinit ---------//</span>
00049 <span class="comment">// call deinit before audio.deinit</span>
<a name="l00050"></a><a class="code" href="classMusic.html#a3">00050</a> <span class="keywordtype">void</span> <a class="code" href="classMusic.html#a3">Music::deinit</a>() {
00051     <span class="keywordflow">if</span>( init_flag ) {
00052         <a class="code" href="classMusic.html#a4">stop</a>();
00053     }
00054 }
00055 
00056 <span class="comment">// -------- end of function Music::deinit ---------//</span>
00057 
00058 <span class="comment">// -------- begin of function Music::stop ---------//</span>
<a name="l00059"></a><a class="code" href="classMusic.html#a4">00059</a> <span class="keywordtype">int</span> <a class="code" href="classMusic.html#a4">Music::stop</a>() {
00060     vga_front.temp_unlock();
00061     <span class="comment">//DEBUG_LOG("Music:: stop called");</span>
00062     vga_front.temp_restore_lock();
00063 
00064     <span class="keywordflow">if</span>( init_flag ) {
00065         <span class="keywordflow">if</span>(music_channel) {
00066             audio.stop_cd();
00067             <a class="code" href="classMusic.html#m2">music_channel</a> = 0;
00068             <a class="code" href="classMusic.html#m1">song_id</a> = 0;
00069         }
00070         <span class="keywordflow">return</span> 1;
00071     }
00072     <span class="keywordflow">else</span> {
00073         <span class="keywordflow">return</span> -1;
00074     }
00075 }
00076 
00077 <span class="comment">// -------- end of function Music::stop ---------//</span>
00078 
00079 <span class="comment">// -------- begin of function Music::play ---------//</span>
00080 <span class="comment">// &lt;int&gt; songId</span>
00081 <span class="comment">// &lt;int&gt; playType   0 = non-looped, 1 = looped</span>
<a name="l00082"></a><a class="code" href="classMusic.html#a5">00082</a> <span class="keywordtype">int</span> <a class="code" href="classMusic.html#a5">Music::play</a>(<span class="keywordtype">int</span> songId, <span class="keywordtype">int</span> playType) {
00083     <span class="keywordflow">if</span>( !<a class="code" href="classMusic.html#m0">init_flag</a> ) {
00084         <span class="keywordflow">return</span> 0;
00085     }
00086 
00087     vga_front.temp_unlock();
00088     <a class="code" href="classMusic.html#a4">stop</a>();
00089     vga_front.temp_restore_lock();
00090 
00091 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00092 <span class="preprocessor"></span>    <span class="comment">// in version 2, check cd, (equals to check  playType &amp; MUSIC_CD_THEN_WAV or MUSIC_PLAY_CD)</span>
00093 
00094     <span class="keywordflow">if</span>( playType &amp; <a class="code" href="OMUSIC_8H.html#a2">MUSIC_CD_THEN_WAV</a> ) {
00095         <span class="keywordflow">return</span> <a class="code" href="classMusic.html#a5">play</a>(songId, playType &amp; ~<a class="code" href="OMUSIC_8H.html#a2">MUSIC_CD_THEN_WAV</a> | <a class="code" href="OMUSIC_8H.html#a1">MUSIC_PLAY_CD</a>)
00096             || <a class="code" href="classMusic.html#a5">play</a>(songId, playType &amp; ~<a class="code" href="OMUSIC_8H.html#a2">MUSIC_CD_THEN_WAV</a> &amp; ~<a class="code" href="OMUSIC_8H.html#a1">MUSIC_PLAY_CD</a>);
00097     }
00098     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( playType &amp; <a class="code" href="OMUSIC_8H.html#a1">MUSIC_PLAY_CD</a> ) {
00099         <span class="comment">// +1 to skip the program track</span>
00100         <span class="keywordflow">if</span>( audio.cd_init_flag &amp;&amp; config.cd_music_volume &gt; 0 &amp;&amp; audio.play_cd(songId+1, config.cd_music_volume) ) {
00101             <a class="code" href="classMusic.html#m3">play_type</a> = playType;
00102             <a class="code" href="classMusic.html#m1">song_id</a> = songId;
00103             <a class="code" href="classMusic.html#m2">music_channel</a> = 1;
00104 
00105             <span class="keywordflow">return</span> 1;
00106         }
00107     }
00108     <span class="keywordflow">else</span> {
00109         <span class="comment">// no wav to play</span>
00110         <span class="comment">//              if( audio.wav_init_flag )</span>
00111         <span class="comment">//              {</span>
00112         <span class="comment">//                      String waveFileStr(DIR_MUSIC);</span>
00113         <span class="comment">//                      waveFileStr += music_file[songId-1];</span>
00114         <span class="comment">//                      if( !DIR_MUSIC[0] || !m.is_file_exist(waveFileStr) || !audio.wav_init_flag )</span>
00115         <span class="comment">//                              return 0;</span>
00116         <span class="comment">//                      if( playType &amp; MUSIC_PLAY_LOOPED )</span>
00117         <span class="comment">//                              music_channel = audio.play_loop_wav(waveFileStr, 0, AbsVolume(config.wav_music_volume,0) );</span>
00118         <span class="comment">//                      else</span>
00119         <span class="comment">//                              music_channel = audio.play_long_wav(waveFileStr, AbsVolume(config.wav_music_volume,0) );</span>
00120         <span class="comment">//                      play_type = playType;</span>
00121         <span class="comment">//                      song_id = songId;</span>
00122         <span class="comment">//                      return music_channel != 0;</span>
00123         <span class="comment">//              }</span>
00124         <span class="keywordflow">return</span> 0;
00125     }
00126 
00127 <span class="preprocessor">#else</span>
00128 <span class="preprocessor"></span>
00129     <span class="comment">// +1 to skip the program track</span>
00130     <span class="keywordflow">if</span>( audio.cd_init_flag &amp;&amp; audio.play_cd(songId+1, config.cd_music_volume) &amp;&amp;
00131         config.cd_music_volume &gt; 0 ) {
00132         <a class="code" href="classMusic.html#m3">play_type</a> = playType;
00133         <a class="code" href="classMusic.html#m1">song_id</a> = songId;
00134         <a class="code" href="classMusic.html#m2">music_channel</a> = 1;
00135 
00136         <span class="keywordflow">return</span> 1;
00137     }
00138 <span class="preprocessor">#endif</span>
00139 <span class="preprocessor"></span>
00140     <span class="keywordflow">return</span> 0;
00141 }
00142 
00143 <span class="comment">// -------- end of function Music::play ---------//</span>
00144 
00145 <span class="comment">// -------- begin of function Music::is_playing ---------//</span>
00146 <span class="comment">// [int] songId        id of the song (default=0, don't care)</span>
<a name="l00147"></a><a class="code" href="classMusic.html#a6">00147</a> <span class="keywordtype">int</span> <a class="code" href="classMusic.html#a6">Music::is_playing</a>(<span class="keywordtype">int</span> songId) {
00148     <span class="keywordflow">if</span>( !<a class="code" href="classMusic.html#m0">init_flag</a> )
00149         <span class="keywordflow">return</span> 0;
00150 
00151     <span class="keywordflow">if</span>( !<a class="code" href="classMusic.html#m2">music_channel</a> )
00152         <span class="keywordflow">return</span> 0;
00153 
00154     <span class="keywordflow">return</span> audio.is_cd_playing() &amp;&amp; (!songId || songId == <a class="code" href="classMusic.html#m1">song_id</a>);
00155 }
00156 
00157 <span class="comment">// -------- end of function Music::is_playing ---------//</span>
00158 
00159 <span class="comment">// -------- begin of function Music::random_bgm_track --------//</span>
<a name="l00160"></a><a class="code" href="classMusic.html#d1">00160</a> <span class="keywordtype">int</span> <a class="code" href="classMusic.html#d1">Music::random_bgm_track</a>(<span class="keywordtype">int</span> excludeSong) {
00161     <span class="keywordtype">int</span> s = <a class="code" href="Omusic_8cpp.html#a0">LOW_RANDOM_SONG</a> + m.get_time() % (<a class="code" href="Omusic_8cpp.html#a1">HIGH_RANDOM_SONG</a> - <a class="code" href="Omusic_8cpp.html#a0">LOW_RANDOM_SONG</a> + 1);
00162     <span class="keywordflow">if</span>( s == excludeSong ) {
00163         <span class="comment">// avoid selecting excludeSong if possible</span>
00164         <span class="keywordflow">if</span>( ++s &gt; <a class="code" href="Omusic_8cpp.html#a1">HIGH_RANDOM_SONG</a> )
00165             s = <a class="code" href="Omusic_8cpp.html#a0">LOW_RANDOM_SONG</a>;
00166     }
00167     <a class="code" href="ALL_8H.html#a0">err_when</a>(s &lt; LOW_RANDOM_SONG || s &gt; <a class="code" href="Omusic_8cpp.html#a1">HIGH_RANDOM_SONG</a> );
00168     <span class="keywordflow">return</span> s;
00169 }
00170 
00171 <span class="comment">// -------- end of function Music::random_bgm_track --------//</span>
00172 
00173 <span class="comment">// -------- begin of function Music::change_volume --------//</span>
<a name="l00174"></a><a class="code" href="classMusic.html#a7">00174</a> <span class="keywordtype">void</span> <a class="code" href="classMusic.html#a7">Music::change_volume</a>(<span class="keywordtype">int</span> vol) {
00175     <span class="keywordflow">if</span>( !<a class="code" href="classMusic.html#m0">init_flag</a> )
00176         <span class="keywordflow">return</span>;
00177 
00178     <span class="keywordflow">if</span>( <a class="code" href="classMusic.html#a6">is_playing</a>() ) {
00179         audio.set_cd_volume(vol);
00180     }
00181 }
00182 
00183 <span class="comment">//-------- end of function Music::change_volume --------//</span>
00184 
00185 <span class="comment">//-------- begin of function Music::yield --------//</span>
00186 
<a name="l00187"></a><a class="code" href="classMusic.html#a8">00187</a> <span class="keywordtype">void</span> <a class="code" href="classMusic.html#a8">Music::yield</a>() {
00188     <span class="keywordflow">if</span>( !<a class="code" href="classMusic.html#m0">init_flag</a> )
00189         <span class="keywordflow">return</span>;
00190 
00191     <span class="keywordtype">int</span> oldSongId = <a class="code" href="classMusic.html#m1">song_id</a>;
00192 
00193     <span class="keywordflow">if</span>( config.cd_music_volume ) {
00194         <span class="keywordflow">if</span>( !<a class="code" href="classMusic.html#a6">is_playing</a>() ) {
00195             vga_front.temp_unlock();
00196             <span class="comment">//DEBUG_LOG("Music::yield(): play random"); //##</span>
00197             vga_front.temp_restore_lock();
00198 
00199             <span class="keywordtype">int</span> songId;
00200 
00201             <span class="keywordflow">while</span>(1) {
00202                 songId = <a class="code" href="classMusic.html#d1">random_bgm_track</a>(oldSongId);
00203 
00204                 <span class="comment">//--- only play Christmas music in December ---//</span>
00205 
00206                 <span class="keywordflow">if</span>( songId==9 &amp;&amp; info.game_month != 12 )
00207                     <span class="keywordflow">continue</span>;
00208 
00209                 <span class="comment">//--- only play Graduation March music in May or June ---//</span>
00210 
00211                 <span class="keywordflow">if</span>( songId==10 &amp;&amp; info.game_month != 5 &amp;&amp; info.game_month != 6 )
00212                     <span class="keywordflow">continue</span>;
00213 
00214                 <a class="code" href="classMusic.html#a5">play</a>( songId, sys.cdrom_drive ? <a class="code" href="OMUSIC_8H.html#a2">MUSIC_CD_THEN_WAV</a> : 0 );
00215                 <span class="keywordflow">return</span>;
00216             }
00217         }
00218     }
00219 }
00220 
00221 <span class="comment">//-------- end of function Music::yield --------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:07 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
