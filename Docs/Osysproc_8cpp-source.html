<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Osysproc.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Osysproc.cpp</h1><a href="Osysproc_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename   : OSYSPROC.CPP</span>
00002 <span class="comment">//Description: Sys class functions</span>
00003 
00004 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00005 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00006 <span class="preprocessor">#include &lt;<a class="code" href="OVGALOCK_8H.html">OVGALOCK.H</a>&gt;</span>
00007 <span class="preprocessor">#include &lt;OVGABUF.H&gt;</span>
00008 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="OIMGRES_8H.html">OIMGRES.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00011 <span class="preprocessor">#include &lt;OIFACE.H&gt;</span>
00012 <span class="preprocessor">#include &lt;<a class="code" href="OCOLTBL_8H.html">OCOLTBL.H</a>&gt;</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="OPOWER_8H.html">OPOWER.H</a>&gt;</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="OBATTLE_8H.html">OBATTLE.H</a>&gt;</span>
00015 <span class="preprocessor">#include &lt;OMISC.H&gt;</span>
00016 <span class="preprocessor">#include &lt;<a class="code" href="OMUSIC_8H.html">OMUSIC.H</a>&gt;</span>
00017 <span class="preprocessor">#include &lt;OMOUSE.H&gt;</span>
00018 <span class="preprocessor">#include &lt;<a class="code" href="OMOUSECR_8H.html">OMOUSECR.H</a>&gt;</span>
00019 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>
00020 <span class="preprocessor">#include &lt;<a class="code" href="OGSET_8H.html">OGSET.H</a>&gt;</span>
00021 <span class="preprocessor">#include &lt;<a class="code" href="OGAME_8H.html">OGAME.H</a>&gt;</span>
00022 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00023 <span class="preprocessor">#include &lt;<a class="code" href="OBOX_8H.html">OBOX.H</a>&gt;</span>
00024 <span class="preprocessor">#include &lt;<a class="code" href="OGAMESET_8H.html">OGAMESET.H</a>&gt;</span>
00025 <span class="preprocessor">#include &lt;<a class="code" href="ODEPTRES_8H.html">ODEPTRES.H</a>&gt;</span>
00026 <span class="preprocessor">#include &lt;OAUDIO.H&gt;</span>
00027 <span class="preprocessor">#include &lt;OCONFIG.H&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="OWORLD_8H.html">OWORLD.H</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;OWORLDMT.H&gt;</span>
00030 <span class="preprocessor">#include &lt;OGFILE.H&gt;</span>
00031 <span class="preprocessor">#include &lt;<a class="code" href="ODEBUGX_8H.html">ODEBUGX.H</a>&gt;</span>
00032 <span class="comment">//#include &lt;OSPRITEA.H&gt;</span>
00033 <span class="comment">// ### begin Gilbert 02/05/2001 ####//</span>
00034 <span class="preprocessor">#ifdef DEBUG</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="OPIECHRT_8H.html">OPIECHRT.H</a>&gt;</span>
00036 <span class="preprocessor">#endif</span>
00037 <span class="preprocessor"></span><span class="comment">// ### end Gilbert 02/05/2001 ####//</span>
00038 
00039 <span class="comment">//-------- Begin of function Sys::yield --------//</span>
<a name="l00040"></a><a class="code" href="classSys.html#a10">00040</a> <span class="keywordtype">void</span> <a class="code" href="classSys.html#a10">Sys::yield</a>() {
00041     <span class="keyword">static</span> isYielding=0;
00042 
00043     <span class="keywordflow">if</span>( isYielding )
00044         <span class="keywordflow">return</span>;
00045 
00046     isYielding=1;
00047 
00048     mouse.poll_event();
00049 
00050     audio.yield();
00051 
00052     isYielding=0;
00053 }
00054 
00055 <span class="comment">//--------- End of function Sys::yield ---------//</span>
00056 
00057 <span class="comment">//-------- Begin of function Sys::run --------//</span>
00058 
<a name="l00059"></a><a class="code" href="classSys.html#a9">00059</a> <span class="keywordtype">void</span> <a class="code" href="classSys.html#a9">Sys::run</a>(<span class="keywordtype">int</span> isLoadedGame) {
00060     <a class="code" href="classSys.html#m6">sys_flag</a>  = <a class="code" href="Osys_8h.html#a41a4">SYS_RUN</a>;
00061     <span class="comment">//  view_mode = MODE_NORMAL;        //chwg1028</span>
00062 
00063     <a class="code" href="classSys.html#m14">view_mode</a> = <a class="code" href="Osys_8h.html#a45a9">MODE_NORMAL</a>;
00064     <span class="keywordflow">if</span>(isLoadedGame!=1) {
00065         <span class="keywordflow">if</span>(player_school.scenario_id&lt;=0)
00066             <a class="code" href="classSys.html#a15">set_staying_view_mode</a>(<a class="code" href="Osys_8h.html#a45a33">MODE_WELCOME_LETTER</a>);
00067         <span class="keywordflow">else</span>
00068             <a class="code" href="classSys.html#a15">set_staying_view_mode</a>(<a class="code" href="Osys_8h.html#a45a32">MODE_SCEN_WELCOME_LETTER</a>);
00069     }
00070 
00071     <span class="comment">//------ reset mouse ---------//</span>
00072 
00073     mouse.reset_click();
00074     mouse_cursor.set_frame(0);
00075 
00076     <span class="comment">//-- enable power after the game objets has been initialized --//</span>
00077 
00078     <span class="comment">//power.enable();      // enable power, which handle mouse inputs</span>
00079 
00080     <span class="comment">//---------- paint screen ---------------//</span>
00081     <span class="comment">// ##chwg1207</span>
00082     <span class="comment">//  world.draw_all();</span>
00083     <span class="comment">//  vga.blt_buf(0, 0, VGA_WIDTH-1, VGA_HEIGHT-1);</span>
00084     <span class="comment">//-----------------------------------------//</span>
00085     <span class="comment">//  disp_frame();</span>
00086 
00087     <span class="comment">// ##chwg1112</span>
00088     <span class="comment">//  vga_back.put_bitmap_area(220, 516, image_interface.get_ptr("MO_LOG1"),  0,      0,      31,80);</span>
00089     <span class="comment">//  vga_back.put_bitmap_area(220, 516, image_interface.get_ptr("MO_LOG3"),  0,      0,      31,27);</span>
00090     <span class="comment">//  vga.blt_buf(220, 516,251,596);</span>
00091 
00092     <span class="comment">//----------- run the main loop -----------//</span>
00093 
00094     main_loop(isLoadedGame);
00095 
00096     <span class="comment">//-- deinit the current report, free up allocated memory and etc.   --//</span>
00097 
00098     deinit_report();
00099 
00100     <span class="comment">//-----------------------------------------//</span>
00101 
00102     m.unlock_seed();
00103 }
00104 
00105 <span class="comment">//--------- End of function Sys::run --------//</span>
00106 
00107 <span class="comment">//-------- Begin of function Sys::main_loop --------//</span>
00108 
00109 <span class="keywordtype">void</span> Sys::main_loop(<span class="keywordtype">int</span> isLoadedGame) {
00110     MSG msg;
00111 
00112     vga_front.unlock_buf();
00113 
00114     <span class="keywordtype">int</span> cou=1;
00115 
00116     <span class="comment">//##chea testing for turn off the report mode</span>
00117     <span class="keywordflow">if</span> (info.game_year==1 &amp;&amp; info.prerun_year==1)
00118         config.disp_year_end_report=0;
00119 
00120 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00121 <span class="preprocessor"></span>    DWORD lastMusicYieldTime = m.get_time();
00122 <span class="preprocessor">#endif</span>
00123 <span class="preprocessor"></span>
00124     <span class="keywordflow">while</span>(1) {
00125         <span class="keywordflow">if</span> (PeekMessage( &amp;msg, <a class="code" href="OHELP_8H.html#a0">NULL</a>, 0, 0, PM_NOREMOVE)) {
00126             <span class="keywordflow">if</span> (!GetMessage( &amp;msg, <a class="code" href="OHELP_8H.html#a0">NULL</a>, 0, 0))
00127                 <span class="keywordflow">break</span>;
00128 
00129             TranslateMessage(&amp;msg);
00130             DispatchMessage(&amp;msg);
00131         }
00132         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !<a class="code" href="classSys.html#m4">paused_flag</a> &amp;&amp; <a class="code" href="classSys.html#m3">active_flag</a> ) {
00133             <span class="keywordflow">if</span>( signal_exit_flag )
00134                 <span class="keywordflow">break</span>;
00135 
00136             vga_front.lock_buf();
00137 
00138             <span class="comment">// ### begin Gilbert 02/05/2001 ####//</span>
00139 <span class="preprocessor">#ifdef DEBUG</span>
00140 <span class="preprocessor"></span>            <span class="keyword">extern</span> <a class="code" href="classPieChart.html">PieChart</a> mode_investment_piechart;   <span class="comment">// make global</span>
00141             <span class="comment">// last element</span>
00142             <span class="keywordtype">short</span> **piechartBitmap = (<span class="keywordtype">short</span> **)(&amp;mode_investment_piechart + 1) - 1;
00143             <a class="code" href="ALL_8H.html#a0">err_when</a>( !mode_investment_piechart.<a class="code" href="classPieChart.html#m19">init_flag</a> &amp;&amp; *piechartBitmap );
00144 <span class="preprocessor">#endif</span>
00145 <span class="preprocessor"></span>            <span class="comment">// ### end Gilbert 02/05/2001 ####//</span>
00146 
00147             <a class="code" href="classSys.html#a10">yield</a>();
00148             detect();                                   <span class="comment">// detect input events for objects</span>
00149 
00150             <span class="comment">// chwg0713</span>
00151             <span class="keywordflow">if</span>(info.prerun_year==1 || <a class="code" href="classSys.html#a12">should_next_frame</a>()) {
00152                 process();                                <span class="comment">// process objects</span>
00153 
00154 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00155 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(info.prerun_year==0)
00156                     <a class="code" href="classSys.html#a27">auto_save</a>();
00157 <span class="preprocessor">#endif</span>
00158 <span class="preprocessor"></span>            }
00159 
00160             <span class="keywordflow">if</span>(info.prerun_year==0)                     <span class="comment">//## chea 140799 try to run the prerun year</span>
00161                 disp_frame();
00162             cou++;
00163 
00164 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00165 <span class="preprocessor"></span>            <span class="comment">// in pre-run year, config.frame_speed is 0, then music.yield called so frequent</span>
00166             <span class="keywordflow">if</span>( m.get_time()-lastMusicYieldTime &gt; 2000 || <a class="code" href="classSys.html#m22">day_frame_count</a> == 0 ) {
00167                 music.yield();
00168                 lastMusicYieldTime = m.get_time();
00169             }
00170 <span class="preprocessor">#else</span>
00171 <span class="preprocessor"></span>            <span class="keywordflow">if</span>( config.frame_speed == 0 || <a class="code" href="classSys.html#m22">day_frame_count</a> == 0)
00172                 music.yield();
00173 <span class="preprocessor">#endif</span>
00174 <span class="preprocessor"></span>
00175 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00176 <span class="preprocessor"></span>            <span class="comment">// not auto-save here, moved to after process()</span>
00177 <span class="preprocessor">#else</span>
00178 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(info.prerun_year==0)                     <span class="comment">//## chea 140799 try to run the prerun year</span>
00179                 <a class="code" href="classSys.html#a27">auto_save</a>();
00180 <span class="preprocessor">#endif</span>
00181 <span class="preprocessor"></span>
00182             vga_front.unlock_buf();
00183 
00184             <span class="keywordflow">if</span>( signal_exit_flag )
00185                 <span class="keywordflow">break</span>;
00186         }
00187         <span class="keywordflow">else</span> {
00188             WaitMessage();
00189         }
00190     }
00191 
00192     vga_front.lock_buf();
00193 }
00194 
00195 <span class="comment">//--------- End of function Sys::main_loop --------//</span>
00196 
00197 <span class="comment">//-------- Begin of function Sys::process --------//</span>
00199 <span class="comment">void Sys::process() {</span>
00200     <span class="comment">//---- if any of the DirectDraw buffers is lost, restore it ----//</span>
00201 
00202     <span class="keywordflow">if</span>( vga_front.is_buf_lost() || vga_back.is_buf_lost() ) {
00203         <span class="keywordflow">if</span> (!restore())
00204             pause();
00205     }
00206 
00207     <span class="keywordflow">if</span>( view_mode &gt;= <a class="code" href="Osys_8h.html#a45a9">MODE_NORMAL</a> &amp;&amp; view_mode &lt;= <a class="code" href="Osys_8h.html#a45a15">MODE_SCORE_REPORT</a> )
00208         vga_back.put_bitmap(<a class="code" href="Oinfo_8h.html#a99a6">REPORT_BUTTON_X1</a>, <a class="code" href="Oinfo_8h.html#a99a7">REPORT_BUTTON_Y1</a>, info.report_bitmap[view_mode-<a class="code" href="Osys_8h.html#a45a9">MODE_NORMAL</a>+1]);
00209     <span class="keywordflow">else</span>
00210         <span class="comment">// the report does not belong to any of the buttons</span>
00211         vga_back.put_bitmap(<a class="code" href="Oinfo_8h.html#a99a6">REPORT_BUTTON_X1</a>, <a class="code" href="Oinfo_8h.html#a99a7">REPORT_BUTTON_Y1</a>, info.report_bitmap[0]);
00212     vga.blt_buf(<a class="code" href="Oinfo_8h.html#a99a6">REPORT_BUTTON_X1</a>, <a class="code" href="Oinfo_8h.html#a99a7">REPORT_BUTTON_Y1</a>, <a class="code" href="Oinfo_8h.html#a99a8">REPORT_BUTTON_X2</a>, <a class="code" href="Oinfo_8h.html#a99a9">REPORT_BUTTON_Y2</a>-1);
00213 
00214     <span class="comment">//------- update frame count and is_sync_frame --------//</span>
00215     frame_count++;
00216 
00217     <span class="comment">//------ processs sprite_array ------//</span>
00218 
00219     <span class="comment">//sprite_array.process();</span>
00220 
00221     <span class="comment">//------ check if it's time for the next day ------//</span>
00222     <span class="keywordflow">if</span>( (day_frame_count+=2) &gt; <a class="code" href="Osys_8h.html#a0">FRAMES_PER_DAY</a> || config.frame_speed==99 ) {
00223         info.next_day();
00224         day_frame_count = 0;
00225     }
00226 
00227 }
00228 
00229 <span class="comment">//--------- End of function Sys::process ---------//</span>
00230 
00231 <span class="comment">//-------- Begin of function Sys::pause --------//</span>
<a name="l00232"></a><a class="code" href="classSys.html#a7">00232</a> <span class="keywordtype">void</span> <a class="code" href="classSys.html#a7">Sys::pause</a>() {
00233     <span class="keywordflow">if</span>( paused_flag )
00234         <span class="keywordflow">return</span>;
00235 
00236     InvalidateRect(<a class="code" href="classSys.html#m0">main_hwnd</a>, <a class="code" href="OHELP_8H.html#a0">NULL</a>, TRUE);
00237 
00238     <a class="code" href="classSys.html#m4">paused_flag</a> = TRUE;
00239 }
00240 
00241 <span class="comment">//--------- End of function Sys::pause ---------//</span>
00242 
00243 <span class="comment">//-------- Begin of function Sys::unpause --------//</span>
<a name="l00245"></a><a class="code" href="classSys.html#a8">00245</a> <span class="comment">void Sys::unpause() {</span>
00246     <span class="keywordflow">if</span>( !paused_flag )
00247         <span class="keywordflow">return</span>;
00248 
00249     <span class="keywordflow">if</span>( !restore() ) {
00250         <span class="comment">//-----------------------------------------------------//</span>
00251         <span class="comment">//  we are unable to restore, this can happen when</span>
00252         <span class="comment">//  the screen resolution or bitdepth has changed</span>
00253         <span class="comment">//  we just reload all the art again and re-create</span>
00254         <span class="comment">//  the front and back buffers.  this is a little</span>
00255         <span class="comment">//  overkill we could handle a screen res change by</span>
00256         <span class="comment">//  just recreating the front and back buffers we dont</span>
00257         <span class="comment">//  need to redo the art, but this is way easier.</span>
00258         <span class="comment">//-----------------------------------------------------//</span>
00259 
00260         <span class="keywordflow">if</span> (init_directx()) {
00261             <span class="keywordflow">if</span>( !restore() )                            <span class="comment">// if still not successful, quit</span>
00262                 <span class="keywordflow">return</span>;
00263         }
00264     }
00265 
00266     mouse.update_skey_state();                      <span class="comment">// update ctrl/shift/alt key state after switch task</span>
00267 
00268     <span class="comment">//---- restore the saved screen before killing the focus ----//</span>
00269 
00270     paused_flag = FALSE;
00271 }
00272 
00273 <span class="comment">//--------- End of function Sys::unpause ---------//</span>
00274 
00275 <span class="comment">//-------- Begin of function Sys::restore --------//</span>
00277 <span class="comment">int Sys::restore() {</span>
00278     <span class="keywordflow">if</span>( !vga_front.restore_buf() )
00279         <span class="keywordflow">return</span> 0;
00280 
00281     <span class="keywordflow">if</span>( !vga_back.restore_buf() )
00282         <span class="keywordflow">return</span> 0;
00283 
00284     <span class="comment">// add in (GAME_VERSION&gt;=200)</span>
00285     <span class="comment">//  if( debugx.debug_session &amp;&amp; !vga_true_front.restore_buf() )</span>
00286     <span class="keywordflow">if</span>( use_true_front &amp;&amp; !vga_true_front.restore_buf() )
00287         <span class="keywordflow">return</span> 0;
00288 
00289     <span class="keyword">enum</span> {
00290         <a class="code" href="Ogammain_8cpp.html#a11a5">MODE_TITLE_SCREEN</a>=-1,
00291         <a class="code" href="Ogammain_8cpp.html#a11a6">MODE_GAME_SETTING</a>=-3,
00292         <a class="code" href="Ogammain_8cpp.html#a11a7">MODE_SCEN_GAME_SETTING</a>=-4
00293     };
00294 
00295     <span class="keywordflow">if</span>(view_mode==<a class="code" href="Ogammain_8cpp.html#a11a6">MODE_GAME_SETTING</a>) {
00296 
00297         <span class="comment">// draw the frame.</span>
00298         vga_front.lock_buf();
00299         image_interface.put_large( &amp;vga_front, 0, 0, <span class="stringliteral">"MAINSCR2"</span> );
00300         game_setting.new_game_report(<a class="code" href="Gamedef_8h.html#a71a16">INFO_REPAINT</a>);
00301         vga_front.unlock_buf();
00302     }
00303     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(view_mode==<a class="code" href="Ogammain_8cpp.html#a11a7">MODE_SCEN_GAME_SETTING</a>) {
00304         <span class="comment">// draw the frame.</span>
00305         vga_front.lock_buf();
00306         image_interface.put_large( &amp;vga_front, 0, 0, <span class="stringliteral">"MAINSCR2"</span> );
00307         game_setting.play_scenario_report(<a class="code" href="Gamedef_8h.html#a71a16">INFO_REPAINT</a>);
00308         vga_front.unlock_buf();
00309     }
00310     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(view_mode==<a class="code" href="Ogammain_8cpp.html#a11a5">MODE_TITLE_SCREEN</a>) {
00311         <span class="comment">// draw title screen.</span>
00312         <span class="keywordtype">int</span> dataSize;
00313 
00314         <span class="keywordtype">char</span>* bmpName = <span class="stringliteral">"MENU-STD"</span>;
00315 
00316 <span class="preprocessor">#ifdef DEMO</span>
00317 <span class="preprocessor"></span>        bmpName = <span class="stringliteral">"MENUDEMO"</span>;
00318 <span class="preprocessor">#endif</span>
00319 <span class="preprocessor"></span>
00320 <span class="preprocessor">#ifdef ADMIN</span>
00321 <span class="preprocessor"></span>        bmpName = <span class="stringliteral">"MENU-ADM"</span>;
00322 <span class="preprocessor">#endif</span>
00323 <span class="preprocessor"></span>
00324         <a class="code" href="classFile.html">File</a>* filePtr = image_interface.get_file(bmpName, dataSize);
00325 
00326         vga_front.lock_buf();
00327 
00328         <span class="keywordflow">if</span> (filePtr-&gt;<a class="code" href="classFile.html#a11">file_get_short</a>() != -1 ) {       <span class="comment">// use common color palette</span>
00329             filePtr-&gt;<a class="code" href="classFile.html#a7">file_seek</a>(filePtr-&gt;<a class="code" href="classFile.html#a8">file_pos</a>() - <span class="keyword">sizeof</span>(short));
00330             vga_front.put_large_bitmap(0, 0, filePtr);
00331         }
00332         <span class="keywordflow">else</span> {                                        <span class="comment">// use own color palette</span>
00333             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> palette[256 * 3];
00334             <span class="keywordtype">short</span> *remapTable;
00335             filePtr-&gt;<a class="code" href="classFile.html#a9">file_read</a>(palette, 256 * 3);
00336             <a class="code" href="structPalDesc.html">PalDesc</a> palDesc(palette, 3, 256, 6);
00337             <a class="code" href="classColorTable.html">ColorTable</a> colorTable;
00338             colorTable.<a class="code" href="classColorTable.html#a9">generate_table_fast</a>(<a class="code" href="OVGA_8H.html#a3">MAX_BRIGHTNESS_ADJUST_DEGREE</a>, palDesc, <a class="code" href="classColorTable.html#d0">ColorTable::bright_func</a>);
00339             remapTable = (<span class="keywordtype">short</span> *) colorTable.<a class="code" href="classColorTable.html#a11">get_table</a>(0);
00340             vga_front.put_large_bitmap(0, 0, filePtr, remapTable);
00341         }
00342         vga_front.unlock_buf();
00343     }
00344     <span class="keywordflow">else</span> {
00345         <span class="comment">// draw the frame.</span>
00346         vga_front.lock_buf();
00347         image_interface.put_large( &amp;vga_front, 0, 0, <span class="stringliteral">"MAINSCR2"</span> );
00348         vga_front.unlock_buf();
00349     }
00350 
00351     <span class="keywordflow">return</span> 1;
00352 }
00353 
00354 <span class="comment">//--------- End of function Sys::restore ---------//</span>
00355 
00356 <span class="comment">//-------- Begin of function Sys::set_speed --------//</span>
<a name="l00358"></a><a class="code" href="classSys.html#a13">00358</a> <span class="comment">void Sys::set_speed(int frameSpeed) {</span>
00359     <span class="comment">// begin ## chwg022399</span>
00360     <span class="keywordflow">if</span>(frameSpeed&lt;0) {
00361         <span class="comment">// just redraw the indicator</span>
00362         <span class="keywordtype">short</span> showX=(short)(config.frame_speed*63.0/98.0);
00363         mouse.hide_area(110, 539, 110+67, 539+30);
00364         vga_back.put_bitmap( 110, 539, image_interface.get_ptr(<span class="stringliteral">"SPED-BAS"</span>));
00365         vga_back.put_bitmap_area( 110, 539, image_interface.get_ptr(<span class="stringliteral">"SPED-TUN"</span>), 0, 0, showX, 30);
00366         mouse.show_area();
00367         vga.blt_buf(110, 539, 110+67, 539+30);
00368         <span class="keywordflow">return</span>;
00369     }
00370     <span class="comment">// end ## chwg022399</span>
00371 
00372     <span class="keywordflow">if</span>( staying_view_mode )                         <span class="comment">// cannot change the speed when staying_view_mode is on. (the speed is frozen in staying view mode)</span>
00373         <span class="keywordflow">return</span>;
00374 
00375     <span class="comment">/*  </span>
00376 <span class="comment">        if(frameSpeed&gt;99)frameSpeed=99;</span>
00377 <span class="comment">        if(frameSpeed&lt;0)frameSpeed=0;</span>
00378 <span class="comment">    */</span>
00379     <span class="comment">// ## begin chwg 0112 ##</span>
00380     <span class="comment">// New frameSpeed range 0 to 98</span>
00381     <span class="keywordflow">if</span>(frameSpeed&gt;99)frameSpeed=99;
00382     <span class="keywordflow">if</span>(frameSpeed&lt;9)frameSpeed=0;
00383 
00384     <span class="comment">// ## begin chwg 1008 ##</span>
00385     <span class="keywordtype">short</span> showX;
00386     <span class="comment">// New Indictor range of length 0 to 63</span>
00387     showX=(short)(frameSpeed*63.0/99.0);
00388     <span class="keywordflow">if</span>(showX&gt;=63)
00389         showX=63;
00390     <span class="keywordflow">if</span>(showX&lt;0)
00391         showX=0;
00392 
00393     mouse.hide_area(110, 539, 110+67, 539+30);
00394     vga_back.put_bitmap( 110, 539, image_interface.get_ptr(<span class="stringliteral">"SPED-BAS"</span>));
00395     vga_back.put_bitmap_area( 110, 539, image_interface.get_ptr(<span class="stringliteral">"SPED-TUN"</span>), 0, 0, showX, 30);
00396     mouse.show_area();
00397     vga.blt_buf(110, 539, 110+67, 539+30);
00398     <span class="comment">// ## end chwg 1008 ##</span>
00399 
00400     config.frame_speed = frameSpeed;
00401 }
00402 
00403 <span class="comment">//--------- End of function Sys::set_speed ---------//</span>
00404 
00405 <span class="comment">//-------- Begin of function Sys::should_next_frame --------//</span>
<a name="l00409"></a><a class="code" href="classSys.html#a12">00409</a> <span class="comment">int Sys::should_next_frame() {</span>
00410     <span class="comment">//----- special modes: 0-frozen, 9-fastest possible -----//</span>
00411 
00412     <span class="keywordflow">if</span>( config.frame_speed==99 )
00413         <span class="keywordflow">return</span> 1;
00414 
00415     <span class="keywordflow">if</span>( config.frame_speed==0 )
00416         <span class="keywordflow">return</span> 0;
00417 
00418     <span class="comment">//---- check if it's now the time for processing the next frame ----//</span>
00419 
00420     DWORD curTime = m.get_time();
00421 
00422     <span class="keywordflow">if</span>( next_frame_time ) {                         <span class="comment">// if next_frame_time==0, it's the first frame of the game</span>
00423         <span class="keywordflow">if</span>( next_frame_time &lt; 1000 ) {                <span class="comment">// the DWORD variable has been overflow</span>
00424             <span class="comment">// &gt;= 1000 if the curTime has been overflow yet, wait for it to overflow so we can compare it when next_frame_time</span>
00425             <span class="keywordflow">if</span>( curTime &lt; next_frame_time || curTime &gt;= 1000 )
00426                 <span class="keywordflow">return</span> 0;
00427         }
00428         <span class="keywordflow">else</span> {                                        <span class="comment">// normal non-overflow case</span>
00429             <span class="keywordflow">if</span>( curTime &lt; next_frame_time )
00430                 <span class="keywordflow">return</span> 0;
00431         }
00432     }
00433 
00434     <span class="comment">//--- Time between frames = 1000 milliseconds / frames per second ---//</span>
00435     <span class="keywordtype">int</span> incs=(int)(500 - 500.0*(config.frame_speed-10)/88);
00436     <span class="keywordflow">if</span>(incs&lt;0)incs=0;
00437     next_frame_time = curTime + incs;
00438 
00439     <span class="keywordflow">return</span> 1;
00440 }
00441 
00442 <span class="comment">//--------- End of function Sys::should_next_frame ---------//</span>
00443 
00444 <span class="comment">//-------- Begin of function Sys::auto_save --------//</span>
<a name="l00446"></a><a class="code" href="classSys.html#a27">00446</a> <span class="comment">void Sys::auto_save() {</span>
00447 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00448 <span class="preprocessor"></span>
00449     <span class="comment">// auto-save per year in ver2</span>
00450 
00451     <span class="keywordflow">if</span>( config.auto_save &amp;&amp; day_frame_count==0
00452         &amp;&amp; info.game_day==player_school.trimester_array[<a class="code" href="Gamedef_8h.html#a79a36">AUTUMN</a>].start_day
00453         &amp;&amp; info.game_month==player_school.trimester_array[<a class="code" href="Gamedef_8h.html#a79a36">AUTUMN</a>].start_month ) {
00454         <span class="keywordflow">if</span>( config.auto_save &amp;&amp; config.auto_save_file_name[0] ) {
00455             <span class="comment">// append extension</span>
00456             <span class="comment">// find the last '.', digits before this '.' will be replaced by &lt;year&gt;</span>
00457             <span class="keywordtype">char</span> *dotPtr, *pathPtr;
00458             <span class="keywordflow">if</span>( (dotPtr=strrchr(config.auto_save_file_name, <span class="charliteral">'.'</span>))
00459                 <span class="comment">// make sure '.' in filename, not in path name</span>
00460                 &amp;&amp; (!(pathPtr=strrchr(config.auto_save_file_name,<span class="charliteral">'\\'</span>)) || pathPtr &lt; dotPtr ) ) {
00461                 <span class="keywordflow">if</span>( !pathPtr )
00462                     pathPtr = config.auto_save_file_name-1;
00463 
00464                 <span class="comment">// unit digit</span>
00465                 <span class="keywordflow">if</span>( dotPtr-pathPtr &gt; 1 ) {                <span class="comment">// at least 1 char before '.'</span>
00466                     dotPtr[-1] = <span class="charliteral">'0'</span> + info.game_year % 10;
00467 
00468                     <span class="comment">// ten digit</span>
00469                     <span class="keywordflow">if</span>( dotPtr-pathPtr &gt; 2                  <span class="comment">// at least 2 char before '.'</span>
00470                         <span class="comment">// if isdigit</span>
00471                         &amp;&amp; dotPtr[-2] &gt;= <span class="charliteral">'0'</span> &amp;&amp; dotPtr[-2] &lt;= <span class="charliteral">'9'</span> ) {
00472                         dotPtr[-2] = <span class="charliteral">'0'</span> + (info.game_year / 10) % 10;
00473 
00474                         <span class="comment">// hundred digit</span>
00475                         <span class="keywordflow">if</span>( dotPtr-pathPtr &gt; 3                <span class="comment">// at least 3 char before '.'</span>
00476                             <span class="comment">// if isdigit</span>
00477                             &amp;&amp; dotPtr[-3] &gt;= <span class="charliteral">'0'</span> &amp;&amp; dotPtr[-3] &lt;= <span class="charliteral">'9'</span> )
00478                             dotPtr[-3] = <span class="charliteral">'0'</span> + (info.game_year / 100) % 10;
00479                     }
00480                 }
00481             }
00482 
00483             game_file.save_game( config.auto_save_file_name );
00484         }
00485     }
00486 
00487     <span class="comment">// write log file in ver2</span>
00488 
00489     <span class="keywordflow">if</span>( config.log_enable &amp;&amp; day_frame_count==0 ) {
00490         <span class="keywordtype">int</span> writeLogFlag = 0;
00491         <span class="keywordflow">switch</span>(config.log_enable) {
00492         <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a73a23">INPUT_MEDIUM</a>:                          <span class="comment">// per year</span>
00493             <span class="keywordflow">if</span>( info.game_day == player_school.trimester_array[0].start_day
00494                 &amp;&amp; info.game_month == player_school.trimester_array[0].start_month )
00495                 writeLogFlag = 1;
00496             <span class="keywordflow">break</span>;
00497 
00498         <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a73a24">INPUT_HIGH</a>: {                          <span class="comment">// per trimester</span>
00499             <span class="keywordflow">for</span>( <span class="keywordtype">int</span> trimester = 0; trimester &lt; <a class="code" href="Gamedef_8h.html#a78a35">TRIMESTER_PER_YEAR</a>; ++trimester ) {
00500                 <span class="keywordflow">if</span>( info.game_day == player_school.trimester_array[trimester].start_day
00501                     &amp;&amp; info.game_month == player_school.trimester_array[trimester].start_month )
00502                     writeLogFlag = 1;
00503             }
00504         }
00505         <span class="keywordflow">break</span>;
00506         }
00507 
00508         <span class="keywordflow">if</span>( writeLogFlag ) {
00509             <span class="comment">// append one line to log file</span>
00510 
00511             <span class="keywordflow">if</span>( config.log_enable &amp;&amp; config.log_file_name[0] ) {
00512                 <span class="keywordflow">if</span>( !m.is_file_exist( config.log_file_name ) )
00513                     <span class="comment">// log file may removed, re-create now</span>
00514                     game_file.create_game_log(config.log_file_name);
00515 
00516                 game_file.append_game_log(config.log_file_name);
00517             }
00518         }
00519     }
00520 <span class="preprocessor">#endif</span>
00521 <span class="preprocessor"></span>
00522 <span class="preprocessor">#ifdef NO_AUTOSAVE</span>
00523 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
00524 <span class="preprocessor">#endif</span>
00525 <span class="preprocessor"></span>
00526     <span class="comment">//---------- single player auto save ----------//</span>
00527 
00528     <span class="keywordflow">if</span> ( info.game_month%4==0 &amp;&amp; info.game_day==1 &amp;&amp; day_frame_count==0) {
00529 <span class="preprocessor">#ifdef DEBUG_SKIP</span>
00530 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(1)
00531 <span class="preprocessor">#else</span>
00532 <span class="preprocessor"></span>            <span class="keywordflow">if</span>( debug_session || testing_session )
00533 <span class="preprocessor">#endif</span>
00534 <span class="preprocessor"></span>            {
00535                 <span class="keyword">static</span> <span class="keywordtype">int</span> saveCount = 0;
00536                 <span class="keywordflow">switch</span>(saveCount) {
00537                 <span class="keywordflow">case</span> 0:  game_file.save_game( <span class="stringliteral">"AUTO1.SAV"</span> );
00538                     <span class="keywordflow">break</span>;
00539                 <span class="keywordflow">case</span> 1:  game_file.save_game( <span class="stringliteral">"AUTO2.SAV"</span> );
00540                     <span class="keywordflow">break</span>;
00541                 <span class="keywordflow">case</span> 2:  game_file.save_game( <span class="stringliteral">"AUTO3.SAV"</span> );
00542                     <span class="keywordflow">break</span>;
00543                 }
00544 
00545                 <span class="comment">// #### begin Gilbert 30/08/2001 ######//</span>
00546                 <span class="comment">//if( ++saveCount&gt;3 )</span>
00547                 <span class="keywordflow">if</span>( ++saveCount&gt;=3 )
00548                     saveCount = 0;
00549                 <span class="comment">// #### end Gilbert 30/08/2001 ######//</span>
00550             }
00551             <span class="keywordflow">else</span> {
00552                 <span class="comment">//--- rename the existing AUTO.SAV to AUTO2.SAV and save a new game ---//</span>
00553 
00554                 <span class="keywordflow">if</span>( m.is_file_exist( <span class="stringliteral">"AUTO.SAV"</span> ) ) {
00555                     <span class="keywordflow">if</span>( m.is_file_exist( <span class="stringliteral">"AUTO2.SAV"</span> ) )      <span class="comment">// if there is already an AUTO2.SAV, delete it</span>
00556                         remove( <span class="stringliteral">"AUTO2.SAV"</span> );
00557 
00558                     rename( <span class="stringliteral">"AUTO.SAV"</span>, <span class="stringliteral">"AUTO2.SAV"</span> );
00559                 }
00560             }
00561 
00562         game_file.save_game( <span class="stringliteral">"AUTO.SAV"</span> );
00563 
00564         <span class="comment">//-*********** syn game test ***********-//</span>
00565 <span class="preprocessor">#ifdef DEBUG_SKIP</span>
00566 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(debug_seed_status_flag==DEBUG_SYN_AUTO_SAVE) {
00567             sp_write_seed();
00568             sp_close_seed_file();
00569 
00570             <span class="keywordflow">if</span>(0) {
00571                 sp_open_seed_file(<span class="stringliteral">"nseed.rs"</span>);
00572                 <span class="comment">// continue recording</span>
00573                 debug_seed_status_flag = DEBUG_SYN_AUTO_SAVE;
00574             }
00575             <span class="keywordflow">else</span> {
00576                 debug_seed_status_flag = NO_DEBUG_SYN;
00577                 <span class="comment">//sp_load_seed_file();</span>
00578                 <span class="comment">//SendMessage(main_hwnd, WM_KEYDOWN, 'L', 0);</span>
00579                 <span class="comment">// load file for comparison</span>
00580                 mouse.add_key_event(DIK_BACKSLASH, m.get_time());
00581             }
00582         }
00583 
00584         <span class="comment">//debug_seed_status_flag = 2;</span>
00585         <span class="comment">//sp_seed_pos_reset();</span>
00586         <span class="comment">//sp_record_match_seed();</span>
00587 <span class="preprocessor">#endif</span>
00588 <span class="preprocessor"></span>        <span class="comment">//-*********** syn game test ***********-//</span>
00589     }
00590 }
00591 
00592 <span class="comment">//-------- End of function Sys::auto_save --------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:29 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
