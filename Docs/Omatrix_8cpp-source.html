<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Omatrix.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Omatrix.cpp</h1><a href="Omatrix_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OMATRIX.CPP</span>
00002 <span class="comment">//Description : Object road direction turn, derived by World, Chain class</span>
00003 
00004 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00005 <span class="preprocessor">#include &lt;<a class="code" href="COLCODE_8H.html">COLCODE.H</a>&gt;</span>
00006 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00007 <span class="preprocessor">#include &lt;OMOUSE.H&gt;</span>
00008 <span class="preprocessor">#include &lt;<a class="code" href="OTERRAIN_8H.html">OTERRAIN.H</a>&gt;</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="OPLANT_8H.html">OPLANT.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="OROAD_8H.html">OROAD.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00012 <span class="preprocessor">#include &lt;OFONT.H&gt;</span>
00013 <span class="preprocessor">#include &lt;OFIRM.H&gt;</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="OSPRITE_8H.html">OSPRITE.H</a>&gt;</span>
00015 <span class="comment">//## fred 990511 #include &lt;OSPRITEA.H&gt;</span>
00016 <span class="preprocessor">#include &lt;<a class="code" href="OWORLD_8H.html">OWORLD.H</a>&gt;</span>
00017 <span class="preprocessor">#include &lt;<a class="code" href="OBITMAPW_8H.html">OBITMAPW.H</a>&gt;</span>
00018 <span class="preprocessor">#include &lt;OMATRIX.H&gt;</span>
00019 <span class="preprocessor">#include &lt;<a class="code" href="OBLOB2W_8H.html">OBLOB2W.H</a>&gt;</span>
00020 
<a name="l00021"></a><a class="code" href="Omatrix_8cpp.html#a0">00021</a> <span class="preprocessor">#define DRAW_SPRITE_ON_MAPVIEW  0                 // 0 or 1</span>
00022 <span class="preprocessor"></span>
00023 <span class="comment">//-------- Declare static functions ---------//</span>
00024 
00025 <span class="keyword">static</span> <span class="keywordtype">int</span> sort_disp_function( <span class="keyword">const</span> <span class="keywordtype">void</span> *a, <span class="keyword">const</span> <span class="keywordtype">void</span> *b );
00026 
00027 <span class="comment">//------- Define static class member functions ----//</span>
00028 
00029 <a class="code" href="classDynArray.html">DynArray</a> <a class="code" href="classMatrix.html#p0">Matrix::disp_sort_array</a>(<span class="keyword">sizeof</span>(<a class="code" href="structDisplaySort.html">DisplaySort</a>),100);
00030 
00031 <span class="comment">//----------- Begin of function Matrix::Matrix ----------//</span>
<a name="l00033"></a><a class="code" href="classMatrix.html#a0">00033</a> <span class="comment">Matrix::Matrix() {</span>
00034     save_image_buf = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00035 }
00036 
00037 <span class="comment">//------------- End of function Matrix::Matrix -----------//</span>
00038 
00039 <span class="comment">//----------- Begin of function Matrix::~Matrix ----------//</span>
<a name="l00041"></a><a class="code" href="classMatrix.html#a1">00041</a> <span class="comment">Matrix::~Matrix() {</span>
00042     <span class="keywordflow">if</span>( save_image_buf ) {
00043         <a class="code" href="ALL_8H.html#a8">mem_del</a>( save_image_buf );
00044         save_image_buf = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00045     }
00046     disp_sort_array.zap(0);                         <span class="comment">// 0-don't resize the array, keep its current size</span>
00047 }
00048 
00049 <span class="comment">//------------- End of function Matrix::~Matrix -----------//</span>
00050 
00051 <span class="comment">//----------- Begin of function Matrix::init ----------//</span>
<a name="l00068"></a><a class="code" href="classMatrix.html#a2">00068</a> <span class="comment">void Matrix::init(int winX1, int winY1, int winX2, int winY2,</span>
00069                   <span class="keywordtype">int</span> locWidth, <span class="keywordtype">int</span> locHeight, <a class="code" href="classLocation.html">Location</a>* locMatrix,
00070                   <span class="keywordtype">int</span> maxXLoc, <span class="keywordtype">int</span> maxYLoc, <span class="keywordtype">int</span> zoomLevel, <span class="keywordtype">char</span> saveImageFlag) {
00071     win_x1 = winX1;                                 <span class="comment">// bitmap area only</span>
00072     win_y1 = winY1;
00073     win_x2 = winX2;
00074     win_y2 = winY2;
00075 
00076     win_width  = win_x2 - win_x1 + 1;
00077     win_height = win_y2 - win_y1 + 1;
00078 
00079     loc_width  = locWidth;
00080     loc_height = locHeight;
00081 
00082     <span class="comment">//---------------------------------------------//</span>
00083 
00084     loc_matrix = locMatrix;
00085 
00086     max_x_loc = maxXLoc;
00087     max_y_loc = maxYLoc;
00088 
00089     disp_x_loc = win_width/loc_width;
00090 
00091     <span class="keywordflow">if</span>( disp_x_loc &gt; max_x_loc )
00092         disp_x_loc = max_x_loc;
00093 
00094     disp_y_loc = win_height/(loc_height/2);
00095 
00096     <span class="keywordflow">if</span>( disp_y_loc &gt; max_y_loc )
00097         disp_y_loc = max_y_loc;
00098 
00099     set_top_loc( <a class="code" href="Oworldmt_8h.html#a0">MAX_WORLD_X_LOC</a>/2, 0 );
00100 
00101     zoom_level = zoomLevel;
00102 
00103     <span class="comment">//----- allocate a buffer for saving the image ------//</span>
00104 
00105     save_image_flag = saveImageFlag;
00106 
00107     <span class="keywordflow">if</span>( saveImageFlag ) {
00108         <span class="keywordflow">if</span> ( save_image_buf )
00109             <a class="code" href="ALL_8H.html#a8">mem_del</a>( save_image_buf );
00110 
00111         save_image_buf = (<span class="keywordtype">short</span> *)<a class="code" href="ALL_8H.html#a5">mem_add</a>( <a class="code" href="classBitmapW.html#a7">BitmapW::size</a>(win_width, win_height) );
00112         is_image_buf_latest = 0;
00113     }
00114 }
00115 
00116 <span class="comment">//------------- End of function Matrix::init -----------//</span>
00117 
00118 <span class="comment">//----------- Begin of function Matrix::set_top_loc ----------//</span>
<a name="l00120"></a><a class="code" href="classMatrix.html#a8">00120</a> <span class="comment">void Matrix::set_top_loc(int topXLoc, int topYLoc) {</span>
00121     top_x_loc = topXLoc;
00122     top_y_loc = topYLoc;
00123 
00124     loc_to_abs_center_left( abs_top_x, abs_top_y, top_x_loc, top_y_loc );
00125 }
00126 
00127 <span class="comment">//------------- End of function Matrix::set_top_loc -----------//</span>
00128 
00129 <span class="comment">//--------- Begin of function Matrix::loc_to_abs_top_left --------//</span>
<a name="l00138"></a><a class="code" href="classMatrix.html#a9">00138</a> <span class="comment">void Matrix::loc_to_abs_top_left(int&amp; absX, int&amp; absY, int locX, int locY) {</span>
00139     absX = (loc_width/2) * (locX + locY);
00140     absY = (max_y_loc/2*loc_height) + (loc_height/2) * (-locX + locY -1);
00141 }
00142 
00143 <span class="comment">//--------- End of function Matrix::loc_to_abs_top_left --------//</span>
00144 
00145 <span class="comment">//--------- Begin of function Matrix::loc_to_abs_center_left --------//</span>
<a name="l00154"></a><a class="code" href="classMatrix.html#a10">00154</a> <span class="comment">void Matrix::loc_to_abs_center_left(int&amp; absX, int&amp; absY, int locX, int locY) {</span>
00155     absX = (loc_width/2) * (locX + locY);
00156     absY = (max_y_loc/2*loc_height) + (loc_height/2) * (-locX + locY);
00157 }
00158 
00159 <span class="comment">//--------- End of function Matrix::loc_to_abs_center_left --------//</span>
00160 
00161 <span class="comment">//--------- Begin of function Matrix::loc_to_abs_bottom_right --------//</span>
<a name="l00170"></a><a class="code" href="classMatrix.html#a11">00170</a> <span class="comment">void Matrix::loc_to_abs_bottom_right(int&amp; absX, int&amp; absY, int locX, int locY) {</span>
00171     absX = (loc_width/2) * (locX + locY + 3) - 1;
00172     absY = (max_y_loc/2*loc_height) + (loc_height/2) * (-locX + locY + 1) - 1;
00173 }
00174 
00175 <span class="comment">//--------- End of function Matrix::loc_to_abs_bottom_right --------//</span>
00176 
00177 <span class="comment">//--------- Begin of function Matrix::abs_to_loc --------//</span>
<a name="l00184"></a><a class="code" href="classMatrix.html#a12">00184</a> <span class="comment">void Matrix::abs_to_loc(int&amp; locX, int&amp; locY, int absX, int absY) {</span>
00185     locX = (absX/loc_width) - (absY/loc_height) + (max_y_loc/2);
00186     locY = (absX/loc_width) + (absY/loc_height) - (max_y_loc/2);
00187 }
00188 
00189 <span class="comment">//--------- End of function Matrix::abs_to_loc --------//</span>
00190 
00191 <span class="comment">//---------- Begin of function Matrix::draw_all ------------//</span>
<a name="l00193"></a><a class="code" href="classMatrix.html#a3">00193</a> <span class="comment">void Matrix::draw_all() {</span>
00194     <span class="comment">//--- if the saved image buffer contains the latest image, use it instead redrawing a new one ---//</span>
00195 
00196     <span class="keywordflow">if</span>( save_image_flag &amp;&amp; is_image_buf_latest ) {
00197         vga_back.put_bitmapW( win_x1, win_y1, save_image_buf );
00198     }
00199     <span class="keywordflow">else</span> {
00200         draw_objects();
00201 
00202         <span class="keywordflow">if</span>( save_image_flag ) {
00203             vga_back.read_bitmapW( win_x1, win_y1, win_x2, win_y2, save_image_buf );
00204             is_image_buf_latest = 1;
00205         }
00206     }
00207 
00208 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00209 <span class="preprocessor"></span>    draw_text();
00210 <span class="preprocessor">#endif</span>
00211 <span class="preprocessor"></span>}
00212 
00213 <span class="comment">//------------ End of function Matrix::draw_all ------------//</span>
00214 
00215 <span class="comment">//---------- Begin of function Matrix::draw_update ------------//</span>
<a name="l00217"></a><a class="code" href="classMatrix.html#a4">00217</a> <span class="comment">void Matrix::draw_update() {</span>
00218 }
00219 
00220 <span class="comment">//------------ End of function Matrix::draw_update ------------//</span>
00221 
00222 <span class="comment">//--------- Begin of function Matrix::draw_objects ---------//</span>
00224 <span class="comment">void Matrix::draw_objects() {</span>
00225     <span class="comment">//----- get the location of the zoom area ------//</span>
00226 
00227     <span class="keyword">enum</span> { DRAW_OUTSIDE = 12 };
00228 
00229     <span class="keywordtype">int</span>     xLocRow = top_x_loc;
00230     <span class="keywordtype">int</span>     yLocRow = top_y_loc-DRAW_OUTSIDE;
00231     <a class="code" href="structDisplaySort.html">DisplaySort</a> displaySort;
00232 
00233     disp_sort_array.zap(0);                         <span class="comment">// 0-don't resize the array, keep its current size</span>
00234 
00235     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> yCount=disp_y_loc+DRAW_OUTSIDE*2 ; yCount&gt;0 ; yCount-- ) {
00236         <span class="comment">//------ process a diagonal row -----//</span>
00237 
00238         <span class="keywordtype">int</span> xLoc = xLocRow;
00239         <span class="keywordtype">int</span> yLoc = yLocRow;
00240 
00241         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> xCount=disp_x_loc+DRAW_OUTSIDE ; xCount&gt;0 ; xCount--, xLoc++, yLoc++ ) {
00242             <span class="keywordflow">if</span>( xLoc &lt; 0 || xLoc &gt;= <a class="code" href="Oworldmt_8h.html#a0">MAX_WORLD_X_LOC</a> ||
00243                 yLoc &lt; 0 || yLoc &gt;= <a class="code" href="Oworldmt_8h.html#a1">MAX_WORLD_Y_LOC</a> ) {
00244                 <span class="keywordflow">continue</span>;
00245             }
00246 
00247             <span class="comment">//------------------------------------------//</span>
00248 
00249             <a class="code" href="classLocation.html">Location</a>* locPtr = world.get_loc(xLoc, yLoc);
00250 
00251             <span class="comment">//-------- if there is a road ---------//</span>
00252 
00253             <span class="keywordflow">if</span>( locPtr-&gt;<a class="code" href="classLocation.html#a24">is_road</a>() ) {                   <span class="comment">// roads do not have height, so they can be drawn at the bottommost layer</span>
00254                 <span class="keywordtype">int</span> absX, absY;
00255 
00256                 loc_to_abs_top_left( absX, absY, xLoc, yLoc );
00257 
00258                 <span class="keywordtype">char</span>* bmpPtr = road_res[locPtr-&gt;<a class="code" href="classLocation.html#a29">road_id</a>()]-&gt;bitmap_ptr[zoom_level];
00259 
00260                 draw_bitmap( absX, absY-loc_height/2, bmpPtr );
00261 
00262                 <span class="comment">//continue;</span>
00263             }
00264 
00265             <span class="keywordflow">else</span> <span class="keywordflow">if</span>( locPtr-&gt;<a class="code" href="classLocation.html#a25">is_road_sub</a>() ) {
00266                 <span class="comment">//continue;</span>
00267             }
00268 
00269             <span class="comment">//------ draw terrain --------//</span>
00270 
00271             <span class="keywordflow">else</span> {
00272                 draw_terrain(xLoc, yLoc, locPtr-&gt;<a class="code" href="classLocation.html#m4">terrain_id</a>);
00273             }
00274 
00275             <span class="comment">//-------- there is a firm on the location --------//</span>
00276 
00277             <span class="keywordflow">if</span>( locPtr-&gt;<a class="code" href="classLocation.html#a16">is_firm</a>() ) {
00278                 displaySort.<a class="code" href="structDisplaySort.html#m0">object_type</a>  = <a class="code" href="Omatrix_8h.html#a11a0">OBJECT_FIRM</a>;
00279                 displaySort.<a class="code" href="structDisplaySort.html#m1">object_recno</a> = locPtr-&gt;<a class="code" href="classLocation.html#a17">firm_recno</a>();
00280 
00281                 <a class="code" href="classFirm.html">Firm</a>* firmPtr = firm_array[locPtr-&gt;<a class="code" href="classLocation.html#a17">firm_recno</a>()];
00282 
00283                 <span class="comment">//##chwg1207</span>
00284                 displaySort.<a class="code" href="structDisplaySort.html#m3">loc_x</a> = firmPtr-&gt;<a class="code" href="classFirm.html#m3">loc_x1</a>;
00285                 displaySort.<a class="code" href="structDisplaySort.html#m4">loc_y</a> = firmPtr-&gt;<a class="code" href="classFirm.html#m6">loc_y2</a>;
00286 
00287                 <span class="keywordflow">if</span>( xLoc==firmPtr-&gt;<a class="code" href="classFirm.html#m3">loc_x1</a> &amp;&amp;              <span class="comment">// only link in the top-left Location to prevent repeated adding of firms</span>
00288                     yLoc==firmPtr-&gt;<a class="code" href="classFirm.html#m4">loc_y1</a> ) {                 <span class="comment">// since size of firm can be greater than 1x1</span>
00289                     disp_sort_array.linkin(&amp;displaySort);
00290                 }
00291                 <span class="keywordflow">if</span>( xLoc==firmPtr-&gt;<a class="code" href="classFirm.html#m5">loc_x2</a> &amp;&amp;              <span class="comment">// only link in the top-right Location to prevent repeated adding of firms</span>
00292                     yLoc==firmPtr-&gt;<a class="code" href="classFirm.html#m4">loc_y1</a> ) {                 <span class="comment">// since size of firm can be greater than 1x1</span>
00293                     disp_sort_array.linkin(&amp;displaySort);
00294                 }
00295             }
00296 
00297             <span class="comment">//-------- there is a plant ---------//</span>
00298 
00299             <span class="keywordflow">else</span> <span class="keywordflow">if</span>( locPtr-&gt;<a class="code" href="classLocation.html#a18">is_plant</a>() ) {
00300                 <a class="code" href="ALL_8H.html#a0">err_when</a>( locPtr-&gt;<a class="code" href="classLocation.html#a11">is_walkable</a>() );
00301                 displaySort.<a class="code" href="structDisplaySort.html#m0">object_type</a> = <a class="code" href="Omatrix_8h.html#a11a1">OBJECT_PLANT</a>;
00302 
00303                 <span class="keywordtype">int</span> absX, absY;
00304 
00305                 loc_to_abs_top_left( absX, absY, xLoc, yLoc );
00306 
00307                 displaySort.<a class="code" href="structDisplaySort.html#m9">bitmap_ptr</a> = plant_res[locPtr-&gt;<a class="code" href="classLocation.html#a21">plant_id</a>()]-&gt;bitmap_ptr[zoom_level];
00308 
00309                 <span class="keywordtype">int</span> bmpWidth  = *((<span class="keywordtype">short</span>*)displaySort.<a class="code" href="structDisplaySort.html#m9">bitmap_ptr</a>);
00310                 <span class="keywordtype">int</span> bmpHeight = *( ((<span class="keywordtype">short</span>*)displaySort.<a class="code" href="structDisplaySort.html#m9">bitmap_ptr</a>)+1 );
00311 
00312                 <span class="comment">//##chwg1207</span>
00313                 displaySort.<a class="code" href="structDisplaySort.html#m5">abs_x1</a> = absX + (int)loc_width  * locPtr-&gt;<a class="code" href="classLocation.html#a22">plant_inner_x</a>() / 100;
00314                 <span class="comment">// plant_inner_x() returns a relative offset as a percentage ranging from 0 to 100</span>
00315                 displaySort.<a class="code" href="structDisplaySort.html#m8">abs_y2</a> = absY + (int)loc_height * locPtr-&gt;<a class="code" href="classLocation.html#a23">plant_inner_y</a>() / 100;
00316                 displaySort.<a class="code" href="structDisplaySort.html#m7">abs_y1</a> = displaySort.<a class="code" href="structDisplaySort.html#m8">abs_y2</a> - bmpHeight + 1;
00317                 displaySort.<a class="code" href="structDisplaySort.html#m3">loc_x</a> = xLoc;
00318                 displaySort.<a class="code" href="structDisplaySort.html#m4">loc_y</a> = yLoc;
00319                 disp_sort_array.linkin(&amp;displaySort);
00320             }
00321             <span class="comment">//-------- there is a unit ---------//</span>
00322             <span class="comment">/*  //## fred 990511</span>
00323 <span class="comment">                else if( locPtr-&gt;has_sprite()</span>
00324 <span class="comment">                &amp;&amp; ( zoom_level != ZOOM_SMALL || DRAW_SPRITE_ON_MAPVIEW ) )</span>
00325 <span class="comment">                {</span>
00326 <span class="comment">                // memset(&amp;displaySort, 0, sizeof(displaySort));</span>
00327 <span class="comment">                Sprite *spritePtr = sprite_array[locPtr-&gt;sprite_recno()];</span>
00328 <span class="comment">                spritePtr-&gt;update_abs_pos();            // update its absolute position</span>
00329 <span class="comment"></span>
00330 <span class="comment">                //##chwg1207</span>
00331 <span class="comment">                displaySort.object_type  = OBJECT_SPRITE;</span>
00332 <span class="comment">                displaySort.object_recno = locPtr-&gt;sprite_recno();</span>
00333 <span class="comment">                displaySort.loc_x = xLoc;</span>
00334 <span class="comment">                displaySort.loc_y = yLoc;</span>
00335 <span class="comment">                disp_sort_array.linkin(&amp;displaySort);</span>
00336 <span class="comment">                }</span>
00337 <span class="comment">            */</span>
00338             <span class="comment">//## fred 990511</span>
00339         }                                             <span class="comment">// for x</span>
00340 
00341         <span class="comment">//------- next row --------//</span>
00342 
00343         <span class="keywordflow">if</span>( yCount%2==0 )                             <span class="comment">// alternately</span>
00344             yLocRow++;
00345         <span class="keywordflow">else</span>
00346             xLocRow--;
00347     }                                               <span class="comment">// for y</span>
00348 
00349     <span class="comment">//---------- quicksort the array -----------//</span>
00350 
00351     <span class="comment">//  disp_sort_array.quick_sort( sort_disp_function );</span>
00352     <span class="comment">//  Quick sort cannot check all objects! Use bubble sort instead.</span>
00353     disp_sort_array.bubble_sort( sort_disp_function );
00354 
00355     <span class="comment">//------------ draw unit path and objects ---------------//</span>
00356 
00357     draw_objects_now( &amp;disp_sort_array );
00358 
00359     <span class="comment">//----------- clean up the array ----------//</span>
00360 
00361     <span class="comment">//  disp_sort_array.zap(0);         // 0-don't resize the array, keep its current size</span>
00362 }
00363 
00364 <span class="comment">//----------- End of function Matrix::draw_objects -----------//</span>
00365 
00366 <span class="comment">//---------- Begin of function Matrix::draw_objects_now -----------//</span>
00368 <span class="comment">void Matrix::draw_objects_now(DynArray* dispSortArray) {</span>
00369     <a class="code" href="structDisplaySort.html">DisplaySort</a> *displaySortPtr;
00370     <a class="code" href="classFirm.html">Firm</a>      *firmPtr;
00371     <span class="comment">//## fred 990511    Sprite          *spritePtr;</span>
00372     <span class="keywordtype">int</span>       i, dispCount = dispSortArray-&gt;size();
00373 
00374     <span class="keywordflow">for</span>( i=1 ; i&lt;=dispCount ; i++ ) {
00375         <span class="keywordflow">if</span>( i%10==1 )
00376             sys.yield();
00377 
00378         displaySortPtr = (<a class="code" href="structDisplaySort.html">DisplaySort</a>*) dispSortArray-&gt;get(i);
00379 
00380         <span class="keywordflow">switch</span>(displaySortPtr-&gt;<a class="code" href="structDisplaySort.html#m0">object_type</a>) {
00381         <span class="keywordflow">case</span> <a class="code" href="Omatrix_8h.html#a11a0">OBJECT_FIRM</a>:
00382             firmPtr = firm_array[displaySortPtr-&gt;<a class="code" href="structDisplaySort.html#m1">object_recno</a>];
00383             firmPtr-&gt;<a class="code" href="classFirm.html#a4">draw</a>(<span class="keyword">this</span>);
00384             <span class="keywordflow">break</span>;
00385 
00386         <span class="keywordflow">case</span> <a class="code" href="Omatrix_8h.html#a11a1">OBJECT_PLANT</a>:
00387             <span class="comment">// shift the tree to left with 44 pixels for the space of shadow.</span>
00388             draw_bitmap( displaySortPtr-&gt;<a class="code" href="structDisplaySort.html#m5">abs_x1</a>-44, displaySortPtr-&gt;<a class="code" href="structDisplaySort.html#m7">abs_y1</a>-2, displaySortPtr-&gt;<a class="code" href="structDisplaySort.html#m9">bitmap_ptr</a> );
00389             <span class="keywordflow">break</span>;
00390 
00391         <span class="keywordflow">case</span> <a class="code" href="Omatrix_8h.html#a11a3">OBJECT_SPRITE</a>:
00392             <a class="code" href="ALL_8H.html#a1">err_here</a>();                               <span class="comment">//## fred 990511</span>
00393             <span class="comment">//## fred 990511    spritePtr = sprite_array[displaySortPtr-&gt;object_recno];</span>
00394             <span class="comment">//## fred 990511    spritePtr-&gt;draw(this);</span>
00395             <span class="keywordflow">break</span>;
00396         }
00397     }
00398 }
00399 
00400 <span class="comment">//----------- End of function Matrix::draw_objects_now ------------//</span>
00401 
00402 <span class="comment">//---------- Begin of function Matrix::draw_terrain -----------//</span>
00404 <span class="comment">void Matrix::draw_terrain(int xLoc, int yLoc, int terrainId) {</span>
00405     <span class="keywordtype">int</span> absX, absY;
00406 
00407     loc_to_abs_top_left( absX, absY, xLoc, yLoc );
00408 
00409     draw_bitmap( absX, absY, terrain_res[terrainId]-&gt;bitmap_ptr[zoom_level] );
00410 }
00411 
00412 <span class="comment">//----------- End of function Matrix::draw_terrain ------------//</span>
00413 
00414 <span class="comment">//---------- Begin of function Matrix::draw_plant -----------//</span>
00416 <span class="comment">void Matrix::draw_plant(int xLoc, int yLoc, int terrainId) {</span>
00417     <span class="keywordtype">int</span> absX, absY;
00418 
00419     loc_to_abs_top_left( absX, absY, xLoc, yLoc );
00420 
00421     draw_bitmap( absX, absY, terrain_res[terrainId]-&gt;bitmap_ptr[zoom_level] );
00422 }
00423 
00424 <span class="comment">//----------- End of function Matrix::draw_plant ------------//</span>
00425 
00426 <span class="comment">//--------- Begin of function Matrix::draw_bitmap ----------//</span>
00430 <span class="comment">void Matrix::draw_bitmap(int absX, int absY, char* bmpPtr) {</span>
00431     <span class="keywordtype">int</span> zoomLevel = zoom_level;
00432     <span class="keywordtype">int</span> bmpWidth  = *( (<span class="keywordtype">short</span>*)bmpPtr );
00433     <span class="keywordtype">int</span> bmpHeight = *( ((<span class="keywordtype">short</span>*)bmpPtr)+1 );
00434 
00435     <span class="keywordtype">int</span> x1 = absX - abs_top_x;
00436 
00437     <span class="keywordflow">if</span>( x1 &lt;= -bmpWidth || x1 &gt;= win_width )        <span class="comment">// out of the view area, not even a slight part of it appears in the view area</span>
00438         <span class="keywordflow">return</span>;
00439 
00440     <span class="keywordtype">int</span> y1 = absY - abs_top_y;
00441 
00442     <span class="keywordflow">if</span>( y1 &lt;= -bmpHeight || y1 &gt;= win_height )
00443         <span class="keywordflow">return</span>;
00444 
00445     <span class="keywordtype">int</span> x2 = absX + bmpWidth - 1 - abs_top_x;
00446     <span class="keywordtype">int</span> y2 = absY + bmpHeight - 1 - abs_top_y;
00447 
00448     <span class="keywordflow">if</span>( x2 &lt; 0 || y2 &lt; 0 )
00449         <span class="keywordflow">return</span>;
00450     <span class="keywordflow">if</span>( x2 &lt;= x1 || y2 &lt;=y1 )
00451         <span class="keywordflow">return</span>;
00452 
00453     <span class="comment">//---- only portion of the sprite is inside the view area ------//</span>
00454 
00455     <span class="keywordflow">if</span>( x1 &lt; 0 || x2 &gt;= win_width || y1 &lt; 0 || y2 &gt;= win_height ) {
00456         vga_back.put_bitmap_area_trans_decompress( x1+win_x1, y1+win_y1, bmpPtr,
00457                                                    max(0,x1)-x1, max(0,y1)-y1, min(win_width-1,x2)-x1, min(win_height-1,y2)-y1 );
00458     }
00459 
00460     <span class="comment">//---- the whole sprite is inside the view area ------//</span>
00461 
00462     <span class="keywordflow">else</span> {
00463         vga_back.put_bitmap_trans_decompress( x1+win_x1, y1+win_y1, bmpPtr );
00464     }
00465 }
00466 
00467 <span class="comment">//--------- End of function Matrix::draw_bitmap -----------//</span>
00468 
00469 <span class="comment">//---------- Begin of function Location::set_firm ------------//</span>
<a name="l00471"></a><a class="code" href="classLocation.html#a14">00471</a> <span class="comment">void Location::set_firm(int firmRecno) {</span>
00472     loc_type    = <a class="code" href="Omatrix_8h.html#a12a5">LOC_IS_FIRM</a>;
00473     cargo_recno = firmRecno;
00474     set_walkable_off();
00475 }
00476 
00477 <span class="comment">//------------ End of function Location::set_firm ------------//</span>
00478 
00479 <span class="comment">//---------- Begin of function Location::remove_firm ------------//</span>
<a name="l00481"></a><a class="code" href="classLocation.html#a15">00481</a> <span class="comment">void Location::remove_firm() {</span>
00482     <a class="code" href="ALL_8H.html#a0">err_when</a>( !is_firm() );
00483 
00484     loc_type = <a class="code" href="Omatrix_8h.html#a12a4">LOC_EMPTY</a>;
00485     cargo_recno = 0;
00486 }
00487 
00488 <span class="comment">//------------ End of function Location::remove_firm ------------//</span>
00489 
00490 <span class="comment">//---------- Begin of function Location::set_plant ------------//</span>
<a name="l00492"></a><a class="code" href="classLocation.html#a19">00492</a> <span class="comment">void Location::set_plant(int plantId, int offsetX, int offsetY) {</span>
00493     loc_type    = <a class="code" href="Omatrix_8h.html#a12a8">LOC_IS_PLANT</a>;
00494 
00495     extra_para  = plantId;
00496     cargo_recno = (offsetY&lt;&lt;8) + offsetX;
00497     set_walkable_off();
00498 }
00499 
00500 <span class="comment">//------------ End of function Location::set_plant ------------//</span>
00501 
00502 <span class="comment">//---------- Begin of function Location::remove_plant ------------//</span>
<a name="l00504"></a><a class="code" href="classLocation.html#a20">00504</a> <span class="comment">void Location::remove_plant() {</span>
00505     <a class="code" href="ALL_8H.html#a0">err_when</a>( !is_plant() );
00506 
00507     loc_type  = <a class="code" href="Omatrix_8h.html#a12a4">LOC_EMPTY</a>;
00508     cargo_recno = 0;
00509     extra_para  = 0;
00510 }
00511 
00512 <span class="comment">//------------ End of function Location::remove_plant ------------//</span>
00513 
00514 <span class="comment">//---------- Begin of function Location::set_road ------------//</span>
<a name="l00516"></a><a class="code" href="classLocation.html#a26">00516</a> <span class="comment">void Location::set_road(int roadId) {</span>
00517     loc_type    = <a class="code" href="Omatrix_8h.html#a12a6">LOC_IS_ROAD</a>;
00518     cargo_recno = roadId;
00519     extra_para  = 0;
00520     set_walkable_on();
00521 }
00522 
00523 <span class="comment">//------------ End of function Location::set_road ------------//</span>
00524 
00525 <span class="comment">//---------- Begin of function Location::remove_road ------------//</span>
<a name="l00527"></a><a class="code" href="classLocation.html#a28">00527</a> <span class="comment">void Location::remove_road() {</span>
00528     <a class="code" href="ALL_8H.html#a0">err_when</a>( !is_road() );
00529 
00530     loc_type  = <a class="code" href="Omatrix_8h.html#a12a4">LOC_EMPTY</a>;
00531     cargo_recno = 0;
00532     extra_para  = 0;
00533     set_walkable_off();
00534 }
00535 
00536 <span class="comment">//------------ End of function Location::remove_road ------------//</span>
00537 
00538 <span class="comment">//---------- Begin of function Location::set_sprite ------------//</span>
<a name="l00540"></a><a class="code" href="classLocation.html#a30">00540</a> <span class="comment">void Location::set_sprite(int recno) {</span>
00541     <a class="code" href="ALL_8H.html#a0">err_when</a>(recno &lt;=0);
00542     <a class="code" href="ALL_8H.html#a0">err_when</a>( !is_walkable() );
00543     <span class="comment">//loc_type          = LOC_IS_SPRITE;</span>
00544     extra_para  = recno;
00545 }
00546 
00547 <span class="comment">//------------ End of function Location::set_sprite ------------//</span>
00548 
00549 <span class="comment">//---------- Begin of function Location::remove_sprite ------------//</span>
<a name="l00551"></a><a class="code" href="classLocation.html#a31">00551</a> <span class="comment">void Location::remove_sprite() {</span>
00552     <a class="code" href="ALL_8H.html#a0">err_when</a>( !has_sprite() );
00553     <span class="comment">//loc_type = LOC_EMPTY;</span>
00554     extra_para  = 0;
00555 }
00556 
00557 <span class="comment">//------------ End of function Location::remove_sprite ------------//</span>
00558 
00559 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00560 <span class="preprocessor"></span><span class="comment">//---------- Begin of function Matrix::draw_text -----------//</span>
00562 <span class="comment">void Matrix::draw_text() {</span>
00563     <span class="comment">// nothing</span>
00564 }
00565 
00566 <span class="comment">//---------- End of function Matrix::draw_text -----------//</span>
00567 <span class="preprocessor">#endif</span>
00568 <span class="preprocessor"></span>
00569 <span class="comment">//---------- Begin of function Matrix::put_center_text -----------//</span>
<a name="l00574"></a><a class="code" href="classMatrix.html#a7">00574</a> <span class="comment">void Matrix::put_center_text(int x, int y, char* str) {</span>
00575     str = translate.process(str);
00576 
00577     <span class="comment">// #### begin Gilbert 12/09/2001 ######//</span>
00578     <span class="comment">/*</span>
00579 <span class="comment">      const TEMP_BUFFER_SIZE = 0x2000;</span>
00580 <span class="comment">      char      tempBuffer[TEMP_BUFFER_SIZE];</span>
00581 <span class="comment"></span>
00582 <span class="comment">      short w = font_news.text_width(str);</span>
00583 <span class="comment">      short h = font_news.max_font_height;</span>
00584 <span class="comment"></span>
00585 <span class="comment">      if( w * h + 2*sizeof(short) &lt;= TEMP_BUFFER_SIZE )</span>
00586 <span class="comment">      {</span>
00587 <span class="comment">      char *bufferPtr = tempBuffer;</span>
00588 <span class="comment"></span>
00589 <span class="comment">      *(short *)bufferPtr = w;</span>
00590 <span class="comment">      bufferPtr += sizeof(short);</span>
00591 <span class="comment"></span>
00592 <span class="comment">      *(short *)bufferPtr = h;</span>
00593 <span class="comment">      bufferPtr += sizeof(short);</span>
00594 <span class="comment"></span>
00595 <span class="comment">      memset( bufferPtr, TRANSPARENT_CODE, w * h );</span>
00596 <span class="comment">      font_news.put_to_buffer(bufferPtr, w, 0, 0, str);</span>
00597 <span class="comment"></span>
00598 <span class="comment">      //-- test clipping against win_x1, win_y1, win_x2, win_y2 --//</span>
00599 <span class="comment"></span>
00600 <span class="comment">      int x1 = x - abs_top_x - w / 2 ;</span>
00601 <span class="comment">      int x2 = x1 + w - 1;</span>
00602 <span class="comment">      int y1 = y - abs_top_y - h / 2;</span>
00603 <span class="comment">      int y2 = y1 + h - 1;</span>
00604 <span class="comment"></span>
00605 <span class="comment">      if( x1 &lt; win_x2 &amp;&amp; x2 &gt;= 0 &amp;&amp; y1 &lt; win_height &amp;&amp; y2 &gt;= 0 )</span>
00606 <span class="comment">      {</span>
00607 <span class="comment">      if( x1 &lt; 0 || x2 &gt;= win_width || y1 &lt; 0 || y2 &gt;= win_height )</span>
00608 <span class="comment">      {</span>
00609 <span class="comment">      vga_back.put_bitmap_area_trans( x1+win_x1, y1+win_y1, tempBuffer,</span>
00610 <span class="comment">      max(0,x1)-x1, max(0,y1)-y1, min(win_width-1,x2)-x1, min(win_height-1,y2)-y1);</span>
00611 <span class="comment">      }</span>
00612 <span class="comment">      else</span>
00613 <span class="comment">      {</span>
00614 <span class="comment">      vga_back.put_bitmap_trans( x1+win_x1, y1+win_y1, tempBuffer );</span>
00615 <span class="comment">      }</span>
00616 <span class="comment">      }</span>
00617 <span class="comment">      }</span>
00618 <span class="comment">    */</span>
00619 
00620     <span class="keyword">static</span> <a class="code" href="classBlob2DW.html">Blob2DW</a> tempBuffer;
00621 
00622     <span class="keyword">const</span> gap = 2;                                  <span class="comment">// outside area for drawing black background</span>
00623     <span class="keywordtype">short</span> w = font_fblack.text_width(str) + 2*gap;
00624     <span class="keywordtype">short</span> h = font_fblack.max_font_height + 2*gap;
00625 
00626     <span class="comment">//-- test clipping against win_x1, win_y1, win_x2, win_y2 --//</span>
00627 
00628     <span class="keywordtype">int</span> x1 = x - abs_top_x - w / 2 ;
00629     <span class="keywordtype">int</span> x2 = x1 + w - 1;
00630     <span class="keywordtype">int</span> y1 = y - abs_top_y - h / 2;
00631     <span class="keywordtype">int</span> y2 = y1 + h - 1;
00632 
00633     <span class="keywordflow">if</span>( x1 &lt; win_width &amp;&amp; x2 &gt;= 0 &amp;&amp; y1 &lt; win_height &amp;&amp; y2 &gt;= 0 ) {
00634         tempBuffer.<a class="code" href="classBlob2DW.html#a14">clear</a>();
00635         tempBuffer.<a class="code" href="classBlob2DW.html#a4">resize</a>(-w/2, -h/2, w, h);
00636         <span class="comment">// black background</span>
00637         tempBuffer.<a class="code" href="classBlob2DW.html#a12">fill_area</a>(-w/2, -h/2, -w/2+w-1, -h/2+h-1, (<span class="keywordtype">short</span>)vga_back.translate_color(<a class="code" href="COLOR_8H.html#a15">V_BLACK</a>), 0);
00638 
00639         font_fblack.put_to_bufferW(tempBuffer.<a class="code" href="classBlob2DW.html#m0">ptr</a>-&gt;<a class="code" href="classBitmapW.html#a5">get_ptr</a>(gap,gap), tempBuffer.<a class="code" href="classBlob2DW.html#a10">buf_true_pitch</a>(), 0, 0, str);
00640 
00641         <span class="keywordflow">if</span>( x1 &lt; 0 || x2 &gt;= win_width || y1 &lt; 0 || y2 &gt;= win_height ) {
00642             vga_back.put_bitmapW_area_trans( x1+win_x1, y1+win_y1, tempBuffer.<a class="code" href="classBlob2DW.html#a7">bitmap_ptr</a>(),
00643                                              max(0,x1)-x1, max(0,y1)-y1, min(win_width-1,x2)-x1, min(win_height-1,y2)-y1);
00644         }
00645         <span class="keywordflow">else</span> {
00646             vga_back.put_bitmapW_trans( x1+win_x1, y1+win_y1, tempBuffer.<a class="code" href="classBlob2DW.html#a7">bitmap_ptr</a>() );
00647         }
00648     }
00649 }
00650 
00651 <span class="comment">//----------- End of function Matrix::put_center_text ------------//</span>
00652 
00653 <span class="comment">//------ Begin of function sort_disp_function ------//</span>
00655 <span class="comment">static int sort_disp_function( const void *a, const void *b ) {</span>
00656     <span class="comment">//##chwg1207</span>
00657     <span class="keywordflow">if</span> (((<a class="code" href="structDisplaySort.html">DisplaySort</a>*)a)-&gt;loc_y&lt;((<a class="code" href="structDisplaySort.html">DisplaySort</a>*)b)-&gt;loc_y)
00658         <span class="keywordflow">return</span> -1;
00659     <span class="keywordflow">if</span> (((<a class="code" href="structDisplaySort.html">DisplaySort</a>*)a)-&gt;loc_x&gt;((<a class="code" href="structDisplaySort.html">DisplaySort</a>*)b)-&gt;loc_x)
00660         <span class="keywordflow">return</span> -1;
00661     <span class="keywordflow">return</span> 1;
00662 }
00663 
00664 <span class="comment">//------- End of function sort_disp_function ------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:04 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
