<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OPRINT2.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>OPRINT2.CPP</h1><a href="OPRINT2_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OPRINT.CPP</span>
00002 <span class="comment">//Description : A collection of print objects</span>
00003 
00004 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00005 <span class="preprocessor">#include &lt;string.h&gt;</span>
00006 <span class="preprocessor">#include &lt;commdlg.h&gt;</span>
00007 <span class="preprocessor">#include &lt;osys.h&gt;</span>
00008 <span class="preprocessor">#include "oprint.h"</span>
00009 
00010 <span class="comment">//printint order:</span>
00011 <span class="comment">//step1: use start_print(); to start printing doc.</span>
00012 <span class="comment">//step2: use open_page(); to start a new page</span>
00013 <span class="comment">//step3: set font by using dfont(); and put_? functions to add text or bmp</span>
00014 <span class="comment">//setp4: use end_page();to end a page</span>
00015 <span class="comment">//step5: use endprint(); to end printing doc</span>
00016 
00017 <span class="comment">//Initialize PRINTDLG structure.</span>
00018 <span class="keywordtype">void</span> Print::print_init(PRINTDLG *printdlg, HWND hwnd,HINSTANCE hThisins) {
00019     printdlg-&gt;lStructSize = <span class="keyword">sizeof</span>(PRINTDLG);
00020     printdlg-&gt;hwndOwner = hwnd;
00021     printdlg-&gt;hDevMode = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00022     printdlg-&gt;hDevNames =<a class="code" href="OHELP_8H.html#a0">NULL</a>;
00023     printdlg-&gt;hDC = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00024     printdlg-&gt;Flags = PD_RETURNDC|PD_RETURNDEFAULT|PD_PRINTSETUP|PD_HIDEPRINTTOFILE|PD_ENABLESETUPTEMPLATE;
00025     printdlg-&gt;nFromPage = 0;
00026     printdlg-&gt;nToPage = 0;
00027     printdlg-&gt;nMinPage = 0;
00028     printdlg-&gt;nMaxPage = 0;
00029     printdlg-&gt;nCopies = 1;
00030     printdlg-&gt;hInstance =hThisins;
00031     printdlg-&gt;lCustData = 0;
00032     printdlg-&gt;lpfnPrintHook = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00033     printdlg-&gt;lpfnSetupHook = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00034     printdlg-&gt;lpPrintTemplateName = <span class="stringliteral">"mydlg"</span>;
00035     printdlg-&gt;lpSetupTemplateName = <span class="stringliteral">"mydlg"</span>;
00036     printdlg-&gt;hPrintTemplate = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00037     printdlg-&gt;hSetupTemplate =<a class="code" href="OHELP_8H.html#a0">NULL</a>;
00038 }
00039 
00040 <span class="keywordtype">int</span> <a class="code" href="classPrint.html#a4">Print::start_print</a>(HWND ohwnd,HINSTANCE hThis) {
00041 
00042     hdc = GetDC(ohwnd);
00043     memDC = CreateCompatibleDC(hdc);
00044 
00045     print_init(&amp;printdlg, ohwnd, hThis);
00046     <span class="keywordflow">if</span>(!PrintDlg(&amp;printdlg)) <span class="keywordflow">return</span> 0;
00047 
00048     docinfo.cbSize = <span class="keyword">sizeof</span>(DOCINFO);
00049     docinfo.lpszDocName = <span class="stringliteral">"Printing bitmaps"</span>;
00050     docinfo.lpszOutput = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00051     docinfo.lpszDatatype = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00052     docinfo.fwType = 0;
00053 
00054     <span class="keywordflow">if</span>(!(GetDeviceCaps(printdlg.hDC, RASTERCAPS)
00055          &amp; (RC_BITBLT | RC_STRETCHBLT|RC_BITMAP64 |
00056             RC_DI_BITMAP| RC_DIBTODEV |RC_PALETTE |RC_SCALING |RC_STRETCHBLT|RC_STRETCHDIB))) {
00057         <span class="comment">/*</span>
00058 <span class="comment">          MessageBox(ohwnd, "Cannot Print Raster Images",</span>
00059 <span class="comment">          "Error", MB_OK);</span>
00060 <span class="comment">        */</span>
00061         <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00062     }
00063 
00064     StartDoc(printdlg.hDC, &amp;docinfo);
00065     <span class="comment">//##        begin   zhoubin 000406</span>
00066     printer_mem_dc = CreateCompatibleDC(printdlg.hDC);
00067     <span class="comment">//##        end             zhoubin 000406</span>
00068 
00069     <span class="keywordflow">return</span> 1;
00070 }
00071 
00072 <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a5">Print::open_page</a>() {
00073 
00074     <span class="comment">//obtain pixels-per-inch</span>
00075     VidXPPI = GetDeviceCaps(memDC, LOGPIXELSX);
00076     VidYPPI = GetDeviceCaps(memDC, LOGPIXELSY);
00077 
00078     PrXPPI = GetDeviceCaps(printdlg.hDC, LOGPIXELSX);
00079     PrYPPI = GetDeviceCaps(printdlg.hDC, LOGPIXELSY);
00080 
00081     <span class="comment">//get scaling ratios</span>
00082     Xratio = (PrXPPI / VidXPPI)*2/3;
00083     Yratio = (PrYPPI / VidYPPI)*2/3;
00084 
00085     StartPage(printdlg.hDC);
00086 
00087 }
00088 
00089 <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a6">Print::put_bitmap_center</a>(<span class="keywordtype">char</span>* name,<span class="keywordtype">int</span> BMPWIDTH,<span class="keywordtype">int</span> BMPHEIGHT,<span class="keywordtype">double</span> pageprotion,<span class="keywordtype">int</span> xcor,<span class="keywordtype">int</span> ycor) {
00090     <span class="comment">//Load Bitmap into hImage</span>
00091     hImage = (HBITMAP)LoadImage(0, name, IMAGE_BITMAP, 0, 0,
00092                                 LR_LOADFROMFILE|LR_CREATEDIBSECTION|LR_DEFAULTCOLOR|LR_LOADMAP3DCOLORS
00093         );
00094     <span class="comment">// put bitmap image into memory DC</span>
00095     SelectObject(memDC, hImage);
00096 
00097     <span class="comment">// copy bitmap while maintaining perspective</span>
00098     <span class="keywordtype">int</span> xpagepos,ypagepos,pagew,pageh;
00099 
00100     pagew= GetDeviceCaps(printdlg.hDC,PHYSICALWIDTH);
00101     xpagepos=(int)((pagew-(BMPWIDTH*Xratio))/2);    <span class="comment">/*1.3*/</span>
00102     pageh= GetDeviceCaps(printdlg.hDC,PHYSICALHEIGHT);
00103     ypagepos=(int)(pageh*pageprotion);
00104 
00105     <span class="comment">//##        begin   zhoubin 000406</span>
00106     <span class="comment">/*    StretchBlt(printdlg.hDC,xpagepos,ypagepos,</span>
00107 <span class="comment">          (int) (BMPWIDTH*Xratio),//*1.3),</span>
00108 <span class="comment">                                     (int) (BMPHEIGHT*Yratio),//*1.2),</span>
00109 <span class="comment">                                                                 memDC, xcor, ycor,</span>
00110 <span class="comment">                                                                 BMPWIDTH, BMPHEIGHT,</span>
00111 <span class="comment">                                                                 SRCCOPY);</span>
00112 <span class="comment">    */</span>
00113     <span class="keywordtype">int</span> printer_width=(int)(BMPWIDTH*Xratio);
00114     <span class="keywordtype">int</span> printer_height=(int)(BMPHEIGHT*Yratio);
00115 
00116     HBITMAP hBitmap = CreateCompatibleBitmap(printer_mem_dc,printer_width,
00117                                              printer_height);
00118 
00119     SelectObject(printer_mem_dc,hBitmap);
00120     StretchBlt(printer_mem_dc,0,0,printer_width,printer_height,
00121                memDC,xcor,ycor,BMPWIDTH,BMPHEIGHT,SRCCOPY);
00122 
00123     BitBlt(printdlg.hDC,xpagepos,ypagepos,
00124            (<span class="keywordtype">int</span>) printer_width,                          <span class="comment">//*1.3),</span>
00125            (<span class="keywordtype">int</span>) printer_height,                         <span class="comment">//*1.2),</span>
00126            printer_mem_dc,0, 0,
00127            SRCCOPY);
00128     DeleteObject(hBitmap);
00129     <span class="comment">//##        end             zhoubin 000406</span>
00130 
00131 }
00132 
00133 <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a7">Print::put_bitmap</a>(<span class="keywordtype">char</span>* name,<span class="keywordtype">int</span> BMPWIDTH,<span class="keywordtype">int</span> BMPHEIGHT,<span class="keywordtype">double</span> xposition,<span class="keywordtype">double</span> yposition,<span class="keywordtype">int</span> xcor,<span class="keywordtype">int</span> ycor) {
00134     <span class="comment">//Load Bitmap into hImage</span>
00135     hImage = (HBITMAP)LoadImage(0, name, IMAGE_BITMAP, 0, 0,LR_LOADFROMFILE|LR_CREATEDIBSECTION);
00136     <span class="comment">// put bitmap image into memory DC</span>
00137     SelectObject(memDC, hImage);
00138 
00139   <span class="comment">// copy bitmap while maintaining perspective</span>
00140 
00141     <span class="keywordtype">int</span> xpagepos,ypagepos,pagew,pageh;
00142 
00143     <span class="comment">//    pagew= GetDeviceCaps(printdlg.hDC,ASPECTX);</span>
00144     pagew= GetDeviceCaps(printdlg.hDC,PHYSICALWIDTH);
00145     xpagepos=(int)(xposition*pagew);
00146     <span class="comment">//   pageh= GetDeviceCaps(printdlg.hDC,ASPECTY);</span>
00147     pageh= GetDeviceCaps(printdlg.hDC,PHYSICALHEIGHT);
00148     ypagepos=(int)(yposition*pageh);
00149     <span class="comment">//##        begin   zhoubin 000406</span>
00150     <span class="comment">/*    StretchBlt(printdlg.hDC,xpagepos,ypagepos,</span>
00151 <span class="comment">          (int) (BMPWIDTH*Xratio),//*1.3),</span>
00152 <span class="comment">                                     (int) (BMPHEIGHT*Yratio),//*1.2),</span>
00153 <span class="comment">                                                                 memDC, xcor, ycor,</span>
00154 <span class="comment">                                                                 BMPWIDTH, BMPHEIGHT,</span>
00155 <span class="comment">                                                                 SRCCOPY);</span>
00156 <span class="comment">                                                          */</span>
00157                <span class="keywordtype">int</span> printer_width=(int)(BMPWIDTH*Xratio);
00158                <span class="keywordtype">int</span> printer_height=(int)(BMPHEIGHT*Yratio);
00159 
00160                HBITMAP hBitmap = CreateCompatibleBitmap(printer_mem_dc,printer_width,
00161                                                         printer_height);
00162 
00163                SelectObject(printer_mem_dc,hBitmap);
00164                StretchBlt(printer_mem_dc,0,0,printer_width,printer_height,
00165                           memDC,xcor,ycor,BMPWIDTH,BMPHEIGHT,SRCCOPY);
00166 
00167                BitBlt(printdlg.hDC,xpagepos,ypagepos,
00168                       (<span class="keywordtype">int</span>) printer_width,                          <span class="comment">//*1.3),</span>
00169                       (<span class="keywordtype">int</span>) printer_height,                         <span class="comment">//*1.2),</span>
00170                       printer_mem_dc,0, 0,
00171                       SRCCOPY);
00172                DeleteObject(hBitmap);
00173                <span class="comment">//##     end             zhoubin 000406</span>
00174 
00175 }
00176 
00177 <span class="comment">/*</span>
00178 <span class="comment">void Print::put_bitmap_bot(char* name,int BMPWIDTH,int BMPHEIGHT,double xprotion,double yprotion,int xcor,int ycor)</span>
00179 <span class="comment">{</span>
00180 <span class="comment">      //Load Bitmap into hImage</span>
00181 <span class="comment">    hImage = LoadImage(0, name, IMAGE_BITMAP, 0, 0,LR_LOADFROMFILE|LR_CREATEDIBSECTION);</span>
00182 <span class="comment">      // put bitmap image into memory DC</span>
00183 <span class="comment">      SelectObject(memDC, hImage);</span>
00184 <span class="comment"></span>
00185 <span class="comment">    // copy bitmap while maintaining perspective</span>
00186 <span class="comment">      int xpagepos,ypagepos,pagew,pageh;</span>
00187 <span class="comment"></span>
00188 <span class="comment">pagew= GetDeviceCaps(printdlg.hDC,PHYSICALWIDTH);</span>
00189 <span class="comment">xpagepos=(int)(pagew-(pagew/xprotion));</span>
00190 <span class="comment"></span>
00191 <span class="comment">pageh= GetDeviceCaps(printdlg.hDC,PHYSICALHEIGHT);</span>
00192 <span class="comment">ypagepos=(int)(pageh-(pageh/yprotion));</span>
00193 <span class="comment"></span>
00194 <span class="comment">StretchBlt(printdlg.hDC,xpagepos,ypagepos,</span>
00195 <span class="comment">(int) (BMPWIDTH*Xratio*1.3),</span>
00196 <span class="comment">(int) (BMPHEIGHT*Yratio*1.2),</span>
00197 <span class="comment">memDC, xcor, ycor,</span>
00198 <span class="comment">BMPWIDTH, BMPHEIGHT,</span>
00199 <span class="comment">SRCCOPY);</span>
00200 <span class="comment">}</span>
00201 <span class="comment">*/</span>
00202 
00203 <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a10">Print::put_text</a>(<span class="keywordtype">char</span>* string,<span class="keywordtype">int</span> xpos,<span class="keywordtype">int</span> ypos) {
00204 
00205     SelectObject(printdlg.hDC,hfont);
00206     GetTextMetrics(printdlg.hDC, &amp;tm);
00207     SetMapMode(printdlg.hDC,MM_TEXT);
00208     xpos=xpos*tm.tmAveCharWidth;
00209     ypos=ypos*(tm.tmHeight + tm.tmExternalLeading);
00210 
00211     <span class="comment">// output to printer</span>
00212     TextOut(printdlg.hDC,xpos, ypos, string, strlen(string));
00213 
00214 }
00215 
00216 <span class="comment">//create font</span>
00217 
00218                                                   <span class="comment">/*bold=700*/</span>
00219 <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a11">Print::dfont</a>(<span class="keywordtype">int</span> PointSize,<span class="keywordtype">bool</span> italic,<span class="keywordtype">bool</span> under,<span class="keywordtype">int</span> weight) {
00220 
00221     hfont=CreateFont(
00222         (-MulDiv(PointSize, GetDeviceCaps(printdlg.hDC, LOGPIXELSY), 72)),
00223         0,                                            <span class="comment">// logical average character width</span>
00224         0,                                            <span class="comment">// angle of escapement</span>
00225         0,                                            <span class="comment">// base-line orientation angle</span>
00226         weight,                                       <span class="comment">// font weight</span>
00227         italic,                                       <span class="comment">// italic attribute flag</span>
00228         under,                                        <span class="comment">// underline attribute flag</span>
00229         <span class="keyword">false</span>,                                        <span class="comment">// strikeout attribute flag</span>
00230         DEFAULT_CHARSET,                              <span class="comment">// character set identifier</span>
00231         OUT_CHARACTER_PRECIS,                         <span class="comment">// output precision</span>
00232         CLIP_DEFAULT_PRECIS,                          <span class="comment">// clipping precision</span>
00233         DEFAULT_QUALITY,                              <span class="comment">// output quality</span>
00234         FF_ROMAN,                                     <span class="comment">//DEFAULT_PITCH, // pitch and family</span>
00235         <a class="code" href="OHELP_8H.html#a0">NULL</a>                                          <span class="comment">// pointer to typeface name string</span>
00236         );
00237 
00238 };
00239 
00240 <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a12">Print::end_page</a>() {
00241     EndPage(printdlg.hDC);
00242 }
00243 
00244 <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a13">Print::endprint</a>(HWND ohwnd) {                <span class="comment">//put the hwnd here</span>
00245 
00246     EndDoc(printdlg.hDC);
00247     DeleteDC(memDC);
00248     DeleteDC(printer_mem_dc);
00249     DeleteDC(printdlg.hDC);
00250     ReleaseDC(ohwnd, hdc);
00251 }
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:11 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
