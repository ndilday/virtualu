<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Osysinit.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Osysinit.cpp</h1><a href="Osysinit_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OSYS.CPP</span>
00002 <span class="comment">//Description : System resource management object</span>
00003 
00004 <span class="preprocessor">#include &lt;resource.h&gt;</span>
00005 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00006 <span class="preprocessor">#include &lt;OCONFIG.H&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="OIMGRES_8H.html">OIMGRES.H</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;<a class="code" href="OGAMESET_8H.html">OGAMESET.H</a>&gt;</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="OGCONFIG_8H.html">OGCONFIG.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;OMOUSE.H&gt;</span>
00011 <span class="preprocessor">#include &lt;<a class="code" href="OMOUSECR_8H.html">OMOUSECR.H</a>&gt;</span>
00012 <span class="preprocessor">#include &lt;OAUDIO.H&gt;</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="OMUSIC_8H.html">OMUSIC.H</a>&gt;</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="OSE_8H.html">OSE.H</a>&gt;</span>
00015 <span class="preprocessor">#include &lt;OFONT.H&gt;</span>
00016 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00017 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00018 <span class="preprocessor">#include &lt;<a class="code" href="OGAME_8H.html">OGAME.H</a>&gt;</span>
00019 <span class="preprocessor">#include &lt;OMISC.H&gt;</span>
00020 <span class="preprocessor">#include &lt;<a class="code" href="OWORLD_8H.html">OWORLD.H</a>&gt;</span>
00021 <span class="preprocessor">#include &lt;<a class="code" href="OHELP_8H.html">OHELP.H</a>&gt;</span>
00022 <span class="preprocessor">#include &lt;OPRINT.H&gt;</span>
00023 <span class="preprocessor">#include &lt;<a class="code" href="ODEBUGX_8H.html">ODEBUGX.H</a>&gt;</span>
<a name="l00024"></a><a class="code" href="Osysinit_8cpp.html#a0">00024</a> <span class="preprocessor">#define DEBUG_LOG_LOCAL 1</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="OLOG_8H.html">OLOG.H</a>&gt;</span>
00026 
00027 <span class="comment">//----------- Declare static functions -----------//</span>
00028 
00029 <span class="keyword">static</span> <span class="keywordtype">long</span> FAR PASCAL static_main_win_proc(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam);
00030 LRESULT CALLBACK <a class="code" href="Osysinit_8cpp.html#a2">win_hook_proc</a>(<span class="keywordtype">int</span> nCode, <a class="code" href="OCOLTBL_8H.html#a2">WORD</a> wParam, LONG lParam);
00031 
00032 <span class="comment">//--------- Begin of static function static_main_win_proc --------//</span>
00033 <span class="comment">// Callback for all Windows messages</span>
00034 <span class="comment">//</span>
00035 <span class="keyword">static</span> <span class="keywordtype">long</span> FAR PASCAL static_main_win_proc(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam) {
00036     <span class="keywordflow">return</span> sys.main_win_proc(hWnd, message, wParam, lParam);
00037 }
00038 
00039 <span class="comment">//--------- End of static function static_main_win_proc --------//</span>
00040 
00041 <span class="comment">//----------- Begin of function Sys::Sys -----------//</span>
<a name="l00042"></a><a class="code" href="classSys.html#a0">00042</a> <a class="code" href="classSys.html#a0">Sys::Sys</a>() {
00043     memset(<span class="keyword">this</span>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classSys.html">Sys</a>));
00044 
00045     <a class="code" href="classSys.html#m35">common_data_buf</a> = <a class="code" href="ALL_8H.html#a5">mem_add</a>( <a class="code" href="Osys_8h.html#a40a2">COMMON_DATA_BUF_SIZE</a> );
00046 
00047     <a class="code" href="classSys.html#m14">view_mode</a> = <a class="code" href="Osys_8h.html#a45a9">MODE_NORMAL</a>;                        <span class="comment">// the animation mode</span>
00048 
00049     <a class="code" href="classSys.html#m13">prev_view_mode</a> = <a class="code" href="Osys_8h.html#a45a9">MODE_NORMAL</a>;
00050 
00051     <a class="code" href="classSys.html#m41">save_view_mode</a> = <a class="code" href="Osys_8h.html#a45a9">MODE_NORMAL</a>;                   <span class="comment">// ## chwg 1106</span>
00052     sys.save_speed=9;                               <span class="comment">// ## chwg 1109</span>
00053     <a class="code" href="classSys.html#m15">back_view_mode</a> = <a class="code" href="Osys_8h.html#a45a9">MODE_NORMAL</a>;
00054 
00055     <a class="code" href="classSys.html#m8">redraw_all_flag</a> = 0;
00056     <a class="code" href="classSys.html#m17">news_pop_up_flag</a> = 0;
00057     <a class="code" href="classSys.html#m9">redraw_zoom_flag</a> = 0;
00058     <span class="comment">//##begin zhoubin 02/23/99</span>
00059     <a class="code" href="classSys.html#m49">old_Dept</a>=-1;
00060     <span class="comment">//##end zhoubin 02/23/99</span>
00061     <span class="comment">// ## begin chwg1008</span>
00062     <span class="comment">//  set_speed( 3*3 );               // set to normal speed</span>
00063     <span class="comment">// ## end chwg1008</span>
00064 
00065 }
00066 
00067 <span class="comment">//----------- End of function Sys::Sys -----------//</span>
00068 
00069 <span class="comment">//----------- Begin of function Sys::~Sys -----------//</span>
<a name="l00070"></a><a class="code" href="classSys.html#a1">00070</a> <a class="code" href="classSys.html#a1">Sys::~Sys</a>() {
00071     <a class="code" href="ALL_8H.html#a8">mem_del</a>(<a class="code" href="classSys.html#m35">common_data_buf</a>);
00072 
00073     <a class="code" href="classSys.html#a3">deinit</a>();
00074 }
00075 
00076 <span class="comment">//----------- End of function Sys::~Sys -----------//</span>
00077 
00078 <span class="comment">//------------ Begin of function Sys::init ----------//</span>
<a name="l00079"></a><a class="code" href="classSys.html#a2">00079</a> <span class="keywordtype">int</span> <a class="code" href="classSys.html#a2">Sys::init</a>( HANDLE hInstance ) {
00080     <a class="code" href="ALL_8H.html#a0">err_when</a>( init_flag );
00081 
00082     <span class="comment">//------- initialize basic vars --------//</span>
00083     <a class="code" href="classSys.html#m1">app_hinstance</a> = (HINSTANCE)hInstance;
00084 
00085 <span class="preprocessor">#ifdef BETA</span>
00086 <span class="preprocessor"></span>    <a class="code" href="classSys.html#m36">debug_session</a>       = m.is_file_exist(<span class="stringliteral">"DEBUG.SYS"</span>);
00087     <a class="code" href="classSys.html#m37">testing_session</a>     = m.is_file_exist(<span class="stringliteral">"TESTING.SYS"</span>);
00088 <span class="preprocessor">#endif</span>
00089 <span class="preprocessor"></span>
00090 <span class="preprocessor">#ifdef DEBUG</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00092 <span class="preprocessor"></span>    <span class="comment">// Ben has put debug.sys in download version, so change to use DEBUGCC.SYS</span>
00093     <a class="code" href="classSys.html#m36">debug_session</a>       = m.is_file_exist(<span class="stringliteral">"DEBUGCC.SYS"</span>);
00094 <span class="preprocessor">#else</span>
00095 <span class="preprocessor"></span>    <a class="code" href="classSys.html#m36">debug_session</a>       = m.is_file_exist(<span class="stringliteral">"DEBUG.SYS"</span>);
00096 <span class="preprocessor">#endif</span>
00097 <span class="preprocessor"></span>    <a class="code" href="classSys.html#m37">testing_session</a>     = m.is_file_exist(<span class="stringliteral">"TESTING.SYS"</span>);
00098 <span class="preprocessor">#endif</span>
00099 <span class="preprocessor"></span>
00100     <span class="comment">// add in (GAME_VERSION&gt;=200)</span>
00101     <a class="code" href="classSys.html#m38">use_true_front</a>      = <a class="code" href="classSys.html#m36">debug_session</a>;
00102 
00103 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00104 <span class="preprocessor"></span>    <span class="comment">// Ben what Win2K winXP has no lock buffer problem, so force to 1 to turn on triple buffer (1 primary + 2 system memory surfaces)</span>
00105     <a class="code" href="classSys.html#m38">use_true_front</a> = 1;
00106 <span class="preprocessor">#endif</span>
00107 <span class="preprocessor"></span>
00108     <span class="keywordflow">if</span>( m.is_file_exist(<span class="stringliteral">"WINMODE.SYS"</span>) )
00109         <a class="code" href="classSys.html#m38">use_true_front</a> = 2;                           <span class="comment">// window mode</span>
00110 
00111     <a class="code" href="classSys.html#a17">set_game_dir</a>();                                 <span class="comment">// set game directories names and game version</span>
00112 
00113     <span class="comment">//------- initialize more stuff ---------//</span>
00114     <span class="keywordflow">if</span>( !init_win() )
00115         <span class="keywordflow">return</span> FALSE;
00116 
00117     <span class="keywordflow">if</span>( !init_directx() )
00118         <span class="keywordflow">return</span> FALSE;
00119 
00120     <span class="keywordflow">if</span>( !init_objects() )                           <span class="comment">// initialize system objects which do not change from games to games.</span>
00121         <span class="keywordflow">return</span> FALSE;
00122 
00123     init_flag = 1;
00124 
00125     <span class="keywordflow">return</span> TRUE;
00126 }
00127 
00128 <span class="comment">//------------ End of function Sys::init ----------//</span>
00129 
00130 <span class="comment">//-------- Begin of function Sys::deinit --------//</span>
<a name="l00133"></a><a class="code" href="classSys.html#a3">00133</a> <span class="comment">void Sys::deinit() {</span>
00134     <span class="keywordflow">if</span>( !init_flag )
00135         <span class="keywordflow">return</span>;
00136 
00137     game.deinit();                                  <span class="comment">// actually game.deinit() will be called by main_win_proc() and calling it here will have no effect</span>
00138     deinit_objects();
00139 
00140     <span class="comment">//-----------------------------------------------//</span>
00141 
00142     <span class="keywordtype">unsigned</span> curTime = m.get_time();
00143 
00144     <span class="keywordflow">while</span>( m.get_time() &lt; curTime + 500 ) {
00145         <span class="keywordflow">if</span>( vga_back.buf_locked )
00146             vga_back.unlock_buf();
00147 
00148         <span class="keywordflow">if</span>( vga_front.buf_locked )
00149             vga_front.unlock_buf();
00150     }
00151 
00152     <span class="comment">//-----------------------------------------------//</span>
00153 
00154     <span class="comment">//### begin zb 02/24/99</span>
00155     <span class="comment">//  PostMessage(main_hwnd, WM_CLOSE, 0, 0);</span>
00156     deinit_directx();
00157     DestroyWindow(sys.main_hwnd);
00158     <span class="comment">//### end zb 02/24/99</span>
00159 
00160     init_flag = 0;
00161 
00162     MSG msg;
00163 
00164     <span class="keywordflow">while</span>( GetMessage(&amp;msg, <a class="code" href="OHELP_8H.html#a0">NULL</a>, 0, 0) ) {
00165         TranslateMessage(&amp;msg);
00166         DispatchMessage(&amp;msg);
00167     }
00168 }
00169 
00170 <span class="comment">//--------- End of function Sys::deinit ---------//</span>
00171 
00172 <span class="comment">//-------- Begin of function Sys::init_win --------//</span>
00173 <span class="keywordtype">int</span> Sys::init_win() {
00174     <span class="comment">//--------- register window class --------//</span>
00175     WNDCLASS    wc;
00176     BOOL        rc;
00177 
00178     wc.style          = CS_DBLCLKS;
00179     wc.lpfnWndProc    = static_main_win_proc;
00180     wc.cbClsExtra     = 0;
00181     wc.cbWndExtra     = 0;
00182     wc.hInstance      = <a class="code" href="classSys.html#m1">app_hinstance</a>;
00183     wc.hIcon          = LoadIcon( <a class="code" href="classSys.html#m1">app_hinstance</a>, MAKEINTATOM(<a class="code" href="RESOURCE_8H.html#a3">IDI_ICON2</a>));
00184     wc.hCursor        = LoadCursor( <a class="code" href="OHELP_8H.html#a0">NULL</a>, IDC_ARROW );
00185     wc.hbrBackground  = (HBRUSH)GetStockObject(BLACK_BRUSH);
00186     wc.lpszMenuName   = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00187     wc.lpszClassName  = <a class="code" href="Gamedef_8h.html#a2">WIN_CLASS_NAME</a>;
00188 
00189     rc = RegisterClass( &amp;wc );
00190 
00191     <span class="keywordflow">if</span>( !rc )
00192         <span class="keywordflow">return</span> FALSE;
00193 
00194     <span class="comment">//--------- create window -----------//</span>
00195 
00196     <span class="keywordflow">if</span>( <a class="code" href="classSys.html#m38">use_true_front</a> == 2 ) {                     <span class="comment">// window mode</span>
00197         DWORD exStyle = 0;
00198         DWORD style = WS_BORDER | WS_CAPTION | WS_CLIPCHILDREN | WS_MINIMIZEBOX | WS_OVERLAPPED | WS_SYSMENU | WS_VISIBLE;
00199 
00200         RECT windowArea = { 0, 0, 0+<a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a>, 0+<a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a> };
00201         AdjustWindowRectEx( &amp;windowArea, style, <a class="code" href="OHELP_8H.html#a0">NULL</a>, exStyle );
00202 
00203         <a class="code" href="classSys.html#m0">main_hwnd</a> = CreateWindowEx(
00204             exStyle,
00205             <a class="code" href="Gamedef_8h.html#a2">WIN_CLASS_NAME</a>,
00206             <a class="code" href="Gamedef_8h.html#a3">WIN_TITLE</a>,
00207             style,
00208             windowArea.left,
00209             windowArea.top,
00210             windowArea.right-windowArea.left,
00211             windowArea.bottom-windowArea.top,
00212             <a class="code" href="OHELP_8H.html#a0">NULL</a>,
00213             <a class="code" href="OHELP_8H.html#a0">NULL</a>,
00214             <a class="code" href="classSys.html#m1">app_hinstance</a>,
00215             <a class="code" href="OHELP_8H.html#a0">NULL</a> );
00216     }
00217     <span class="keywordflow">else</span> {
00218         <a class="code" href="classSys.html#m0">main_hwnd</a> = CreateWindowEx(
00219             <span class="comment">// ## begin zb 02/22/99</span>
00220 #ifdef _DEBUG
00221             <a class="code" href="OHELP_8H.html#a0">NULL</a>,
00222 #<span class="keywordflow">else</span>
00223             WS_EX_APPWINDOW | WS_EX_TOPMOST,
00224 #endif
00225             <span class="comment">// ## end zb 02/22/99</span>
00226             <a class="code" href="Gamedef_8h.html#a2">WIN_CLASS_NAME</a>,
00227             <a class="code" href="Gamedef_8h.html#a3">WIN_TITLE</a>,
00228             WS_VISIBLE |                                <span class="comment">// so we dont have to call ShowWindow</span>
00229             WS_POPUP,
00230             0,
00231             0,
00232             GetSystemMetrics(SM_CXSCREEN),
00233             GetSystemMetrics(SM_CYSCREEN),
00234             <a class="code" href="OHELP_8H.html#a0">NULL</a>,
00235             <a class="code" href="OHELP_8H.html#a0">NULL</a>,
00236             <a class="code" href="classSys.html#m1">app_hinstance</a>,
00237             <a class="code" href="OHELP_8H.html#a0">NULL</a> );
00238     }
00239 
00240     <span class="keywordflow">if</span>( !<a class="code" href="classSys.html#m0">main_hwnd</a> )
00241         <span class="keywordflow">return</span> FALSE;
00242 
00243     UpdateWindow( <a class="code" href="classSys.html#m0">main_hwnd</a> );
00244     SetFocus( <a class="code" href="classSys.html#m0">main_hwnd</a> );
00245 
00246     <span class="keywordflow">return</span> TRUE;
00247 }
00248 
00249 <span class="comment">//-------- End of function Sys::init_win --------//</span>
00250 
00251 <span class="comment">//-------- Begin of function Sys::init_directx --------//</span>
00252 <span class="keywordtype">int</span> Sys::init_directx() {
00253     audio.init();
00254     music.init();
00255     <span class="comment">//  se_ctrl.init();</span>
00256 
00257     <span class="comment">//---------------------------------------//</span>
00258 
00259     ShowCursor(FALSE);
00260 
00261     <span class="comment">//-------- initialize DirectDraw --------//</span>
00262 
00263     <span class="keywordflow">if</span>( !vga.init() )
00264         <span class="keywordflow">return</span> FALSE;
00265 
00266     vga.load_pal(<a class="code" href="Gamedef_8h.html#a4">DIR_RES</a><span class="stringliteral">"PAL_STD.RES"</span>);
00267 
00268     <span class="comment">// add in (GAME_VERSION&gt;=200)</span>
00269     <span class="comment">//  if( debugx.debug_session )                // if we are currently in a debug session, don't lock the front buffer otherwise the system will hang up</span>
00270     <span class="comment">//  {</span>
00271     <span class="comment">//          vga_front.init_back( vga.dd_obj );</span>
00272     <span class="comment">//          vga_front.is_front = 1;                 // set it to 1, overriding the setting in init_back()</span>
00273     <span class="comment">//</span>
00274     <span class="comment">//          vga_true_front.init_front( vga.dd_obj );</span>
00275     <span class="comment">//</span>
00276     <span class="comment">//          vga.activate_pal(&amp;vga_true_front);</span>
00277     <span class="comment">//  }</span>
00278     <span class="comment">//  else</span>
00279     <span class="comment">//  {</span>
00280     <span class="comment">//          vga_front.init_front( vga.dd_obj );</span>
00281     <span class="comment">//          vga.activate_pal(&amp;vga_front);</span>
00282     <span class="comment">//  }</span>
00283 
00284     <span class="keywordflow">if</span>( !<a class="code" href="classSys.html#m38">use_true_front</a> ) {
00285         <span class="comment">// try lock front buffer</span>
00286 
00287         vga_front.init_front( vga.dd_obj );
00288         DDSURFACEDESC2  ddsd;
00289         memset( &amp;ddsd, 0, <span class="keyword">sizeof</span>(ddsd) );
00290         ddsd.dwSize = <span class="keyword">sizeof</span>(ddsd);
00291         <span class="keywordflow">if</span>( vga_front.dd_buf-&gt;Lock(<a class="code" href="OHELP_8H.html#a0">NULL</a>, &amp;ddsd, DDLOCK_WAIT, <a class="code" href="OHELP_8H.html#a0">NULL</a>) == DD_OK ) {
00292             vga_front.dd_buf-&gt;Unlock(<a class="code" href="OHELP_8H.html#a0">NULL</a>);
00293             vga.activate_pal(&amp;vga_front);
00294         }
00295         <span class="keywordflow">else</span> {
00296             vga_front.deinit();
00297             <a class="code" href="classSys.html#m38">use_true_front</a> = 1;                         <span class="comment">// can't lock buffer, use vga_true_front</span>
00298         }
00299     }
00300 
00301     <span class="keywordflow">if</span>( use_true_front ) {
00302         vga_true_front.init_front( vga.dd_obj );
00303 
00304         vga_front.init_back( vga.dd_obj );
00305         vga_front.is_front = 1;                       <span class="comment">// set it to 1, overriding the setting in init_back()</span>
00306 
00307         vga.activate_pal(&amp;vga_true_front);
00308     }
00309 
00310     vga_back.init_back( vga.dd_obj );
00311     vga_front.lock_buf();
00312     vga_back.lock_buf();
00313 
00314     <span class="keywordflow">return</span> TRUE;
00315 }
00316 
00317 <span class="comment">//-------- End of function Sys::init_directx --------//</span>
00318 
00319 <span class="comment">//-------- Begin of function Sys::deinit_directx --------//</span>
<a name="l00320"></a><a class="code" href="classSys.html#a4">00320</a> <span class="keywordtype">void</span> <a class="code" href="classSys.html#a4">Sys::deinit_directx</a>() {
00321     <span class="keywordflow">if</span>( !vga.is_inited() )
00322         <span class="keywordflow">return</span>;
00323 
00324     <span class="keywordflow">if</span>( vga_back.dd_buf &amp;&amp; vga_back.buf_locked )
00325         vga_back.unlock_buf();
00326 
00327     <span class="keywordflow">if</span>( vga_front.dd_buf &amp;&amp; vga_front.buf_locked )
00328         vga_front.unlock_buf();
00329 
00330     vga_back.deinit();
00331 
00332     <span class="comment">// add in (GAME_VERSION&gt;=200)</span>
00333     <span class="comment">//   if( debugx.debug_session )</span>
00334     <span class="keywordflow">if</span>( use_true_front )
00335         vga_true_front.deinit();
00336 
00337     vga_front.deinit();
00338     vga.deinit();
00339 
00340     <span class="comment">//------------------------------------//</span>
00341 
00342     <span class="comment">//  se_ctrl.deinit();</span>
00343     music.deinit();
00344     audio.deinit();
00345 }
00346 
00347 <span class="comment">//--------- End of function Sys::deinit_directx ---------//</span>
00348 
00349 <span class="comment">//------- Begin of function Sys::init_objects -----------//</span>
00352 <span class="comment">int Sys::init_objects() {</span>
00353     <span class="comment">//--------- init system class ----------//</span>
00354 
00355     mouse_cursor.init();
00356     mouse_cursor.set_frame_border(<a class="code" href="Oworldmt_8h.html#a12">ZOOM_X1</a>,<a class="code" href="Oworldmt_8h.html#a13">ZOOM_Y1</a>,<a class="code" href="Oworldmt_8h.html#a14">ZOOM_X2</a>,<a class="code" href="Oworldmt_8h.html#a15">ZOOM_Y2</a>);
00357 
00358     mouse.init(app_hinstance, main_hwnd, <a class="code" href="OHELP_8H.html#a0">NULL</a>);
00359 
00360     <span class="comment">//------- init resource class ----------//</span>
00361     help.init(<span class="stringliteral">"CTXTHELP.RES"</span>);
00362     font_std.init(<span class="stringliteral">"STD"</span>, 2);
00363     font_san.init(<span class="stringliteral">"SAN"</span>, 0);                        <span class="comment">// 0-zero inter-character space</span>
00364     <span class="comment">//  font_red_san.init("RSAN", 0);</span>
00365     <span class="comment">//  font_green_san.init("GSAN", 0);</span>
00366     <span class="comment">//  font_blue_san.init("BSAN", 0);</span>
00367     <span class="comment">//  font_san.init("CHRM", 0);               // 0-zero inter-character space</span>
00368     font_red_san.init(<span class="stringliteral">"RSAN"</span>, 0);
00369     font_green_san.init(<span class="stringliteral">"GSAN"</span>, 0);
00370     font_blue_san.init(<span class="stringliteral">"BSAN"</span>, 0);
00371     font_fdiamond.init(<span class="stringliteral">"FDMD"</span>, 1);
00372     font_yellow_diamond.init(<span class="stringliteral">"YDMD"</span>, 1);
00373     <span class="comment">//  font_fblack.init("BLCK", 0);</span>
00374     <span class="comment">//  font_charts.init("CHRT", 0);</span>
00375     font_charts.init(<span class="stringliteral">"CHRT"</span>, 0);
00376 
00377     <span class="comment">// font file behind is alternate font file used in printing</span>
00378     font_chartsm.init(<span class="stringliteral">"CHRM"</span>, 1);                   <span class="comment">// CHRP</span>
00379     font_chart_red_sm.init(<span class="stringliteral">"RCSM"</span>, 1);              <span class="comment">// RCSP</span>
00380     font_chart_green_sm.init(<span class="stringliteral">"GCSM"</span>, 1);            <span class="comment">// GCSP</span>
00381     font_chart_blue_sm.init(<span class="stringliteral">"BCSM"</span>, 1);             <span class="comment">// BCSP</span>
00382 
00383     font_chart_orange_sm.init(<span class="stringliteral">"OCSM"</span>, 1);
00384     font_chart_purple_sm.init(<span class="stringliteral">"PCSM"</span>, 1);           <span class="comment">// PCSP in ver2</span>
00385     font_numbers.init(<span class="stringliteral">"FNUM"</span>, 1);
00386     font_redcharts.init(<span class="stringliteral">"RCHR"</span>, 0);
00387     font_barcharts.init(<span class="stringliteral">"BCHR"</span>, 0);
00388     font_letter.init(<span class="stringliteral">"LTTR"</span>, 0);
00389     font_fscore.init(<span class="stringliteral">"FSCR"</span>, 0);
00390     font_pgold.init(<span class="stringliteral">"PGLD"</span>, 0);
00391     font_psilver.init(<span class="stringliteral">"PSLV"</span>, 0);
00392     font_pbronze.init(<span class="stringliteral">"PBRZ"</span>, 0);
00393     font_stone.init(<span class="stringliteral">"FSTN"</span>, 0);
00394     font_hstone.init(<span class="stringliteral">"FHSN"</span>, 0);
00395     font_fblack.init(<span class="stringliteral">"WBLK"</span>, 0);
00396     font_small_san.init(<span class="stringliteral">"SMAL"</span>, 0);
00397     font_mid.init(<span class="stringliteral">"MID"</span>);
00398     font_small.init(<span class="stringliteral">"SMAL"</span>);
00399     font_news.init(<span class="stringliteral">"NEWS"</span>);
00400     font_casa.init(<span class="stringliteral">"CASA"</span>, 1, 3);
00401 
00402     image_sys.init(<a class="code" href="Gamedef_8h.html#a4">DIR_RES</a><span class="stringliteral">"I_SYS.RES"</span>,1,0);         <span class="comment">// 1-read into buffer</span>
00403     image_interface.init(<a class="code" href="Gamedef_8h.html#a4">DIR_RES</a><span class="stringliteral">"I_IF.RES"</span>,0,0);    <span class="comment">// 0-don't read into the buffer, don't use common buffer</span>
00404     image_mascot.init(<a class="code" href="Gamedef_8h.html#a4">DIR_RES</a><span class="stringliteral">"I_MASCOT.RES"</span>,0,0);
00405     image_pict.init(<a class="code" href="Gamedef_8h.html#a4">DIR_RES</a><span class="stringliteral">"I_PICT.RES"</span>,0,0);
00406 
00407     <span class="comment">//---------- init other objects ----------//</span>
00408 
00409     game_set.init();                                <span class="comment">// this must be called before game.init() as game.init() assume game_set has been initialized</span>
00410     goal_config.init();
00411 
00412     <span class="comment">// #### begin Gilbert 27/04/2001 ######//</span>
00413     print.init();
00414     <span class="comment">// #### end Gilbert 27/04/2001 ######//</span>
00415 
00416     <span class="keywordflow">return</span> TRUE;
00417 }
00418 
00419 <span class="comment">//------- End of function Sys::init_objects -----------//</span>
00420 
00421 <span class="comment">//------- Begin of function Sys::deinit_objects -----------//</span>
00422 
<a name="l00423"></a><a class="code" href="classSys.html#a5">00423</a> <span class="keywordtype">void</span> <a class="code" href="classSys.html#a5">Sys::deinit_objects</a>() {
00424     <span class="comment">//--------- deinit system class ----------//</span>
00425 
00426     mouse.deinit();                                 <span class="comment">// mouse must be deinitialized first</span>
00427     mouse_cursor.deinit();
00428 
00429     <span class="comment">//------- deinit resource class ----------//</span>
00430 
00431     font_std.deinit();
00432     font_san.deinit();
00433     font_charts.deinit();
00434     font_chartsm.deinit();
00435     font_chart_red_sm.deinit();
00436     font_chart_green_sm.deinit();
00437     font_chart_blue_sm.deinit();
00438     font_chart_orange_sm.deinit();
00439     font_numbers.deinit();
00440     font_chart_purple_sm.deinit();
00441     font_redcharts.deinit();
00442     font_barcharts.deinit();
00443     font_letter.deinit();
00444     font_fscore.deinit();
00445     font_pgold.deinit();
00446     font_psilver.deinit();
00447     font_pbronze.deinit();
00448     font_stone.deinit();
00449     font_hstone.deinit();
00450     font_small_san.deinit();
00451     font_red_san.deinit();
00452     font_fdiamond.deinit();
00453     font_yellow_diamond.deinit();
00454     font_red_san.deinit();
00455     font_green_san.deinit();
00456     font_blue_san.deinit();
00457     font_mid.deinit();
00458     font_small.deinit();
00459     font_news.deinit();
00460     font_casa.deinit();
00461 
00462     image_sys.deinit();
00463     image_interface.deinit();
00464     image_mascot.deinit();
00465     image_pict.deinit();
00466 
00467     <span class="comment">//--------- deinit other objects ----------//</span>
00468 
00469     game_set.deinit();
00470     <span class="comment">// #### begin Gilbert 27/04/2001 ######//</span>
00471     print.deinit();
00472     <span class="comment">// #### end Gilbert 27/04/2001 ######//</span>
00473     goal_config.deinit();
00474     <span class="comment">//  help.deinit();</span>
00475     <span class="comment">//  tutor.deinit();</span>
00476     config.deinit();
00477     <span class="comment">//  game_file_array.deinit();</span>
00478 
00479 }
00480 
00481 <span class="comment">//------- End of function Sys::deinit_objects -----------//</span>
00482 
00483 <span class="comment">//-------- Begin of function Sys::set_game_dir ----------//</span>
<a name="l00487"></a><a class="code" href="classSys.html#a17">00487</a> <span class="comment">void Sys::set_game_dir() {</span>
00488     <span class="comment">//------- If it should run from the CDROM ------//</span>
00489 
00490     get_cdrom_drive();
00491 
00492     set_one_dir( <span class="stringliteral">"IMAGE\\HALLFAME.ICN"</span>    , <span class="stringliteral">"IMAGE\\"</span>, dir_image );
00493     set_one_dir( <span class="stringliteral">"ENCYC\\SEAT\\NORMAN.ICN"</span>, <span class="stringliteral">"ENCYC\\"</span>, dir_encyc );
00494     set_one_dir( <span class="stringliteral">"MOVIE\\INTRO.AVI"</span>       , <span class="stringliteral">"MOVIE\\"</span>, dir_movie );
00495 
00496 <span class="preprocessor">#ifdef DEMO</span>
00497 <span class="preprocessor"></span>    set_one_dir( <span class="stringliteral">"TUTORIAL\\STANDARD.TUT"</span> , <span class="stringliteral">"TUTORIAL\\"</span>, dir_tutorial );
00498     set_one_dir( <span class="stringliteral">"SCENARIO\\DEMO.SCN"</span>     , <span class="stringliteral">"SCENARIO\\"</span>, dir_scenario );
00499 <span class="preprocessor">#else</span>
00500 <span class="preprocessor"></span>    set_one_dir( <span class="stringliteral">"TUTORIAL\\1BAS_MIL.TUT"</span> , <span class="stringliteral">"TUTORIAL\\"</span>, dir_tutorial );
00501     set_one_dir( <span class="stringliteral">"SCENARIO\\7FOR7.SCN"</span>    , <span class="stringliteral">"SCENARIO\\"</span>, dir_scenario );
00502 <span class="preprocessor">#endif</span>
00503 <span class="preprocessor"></span>
00504     <span class="comment">//-------- set game version ---------//</span>
00505 
00506 <span class="preprocessor">#ifdef BETA</span>
00507 <span class="preprocessor"></span>    game_version = <a class="code" href="Osys_8h.html#a42a5">VERSION_FULL</a>;
00508 <span class="preprocessor">#else</span>
00509 <span class="preprocessor"></span><span class="preprocessor">#ifdef DEMO</span>
00510 <span class="preprocessor"></span>    game_version = <a class="code" href="Osys_8h.html#a42a6">VERSION_DEMO</a>;
00511 <span class="preprocessor">#else</span>
00512 <span class="preprocessor"></span>    game_version = <a class="code" href="Osys_8h.html#a42a5">VERSION_FULL</a>;                    <span class="comment">// single player game is not available when game_version == VERSION_FULL</span>
00513 <span class="preprocessor">#endif</span>
00514 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00515 <span class="preprocessor"></span>}
00516 
00517 <span class="comment">//----------- End of function Sys::set_game_dir ----------//</span>
00518 
00519 <span class="comment">//-------- Begin of function Sys::set_one_dir ----------//</span>
<a name="l00521"></a><a class="code" href="classSys.html#a18">00521</a> <span class="comment">int Sys::set_one_dir( char* checkFileName, char* defaultDir, char* trueDir ) {</span>
00522     <span class="keywordflow">if</span>( m.is_file_exist( checkFileName ) ) {
00523         strcpy( trueDir, defaultDir );
00524     }
00525     <span class="keywordflow">else</span> {
00526         <span class="keywordflow">if</span>( cdrom_drive ) {
00527             strcpy( trueDir, <span class="stringliteral">"D:\\"</span> );
00528             strcat( trueDir, defaultDir );
00529 
00530             trueDir[0] = cdrom_drive;
00531         }
00532         <span class="keywordflow">else</span> {
00533             strcpy( trueDir, <span class="stringliteral">""</span> );
00534             <span class="keywordflow">return</span> 0;
00535         }
00536     }
00537 
00538     <span class="keywordflow">return</span> 1;
00539 }
00540 
00541 <span class="comment">//----------- End of function Sys::set_one_dir ----------//</span>
00542 
00543 <span class="comment">//-------- Start of function Sys::get_cdrom_drive -------------//</span>
00544 <span class="comment">//</span>
00545 <span class="comment">// Get the drive letter of the CDROM and restore the result in cdrom_drive.</span>
00546 <span class="comment">//</span>
<a name="l00547"></a><a class="code" href="classSys.html#a19">00547</a> <span class="keywordtype">void</span> <a class="code" href="classSys.html#a19">Sys::get_cdrom_drive</a>() {
00548     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>  i;
00549     <span class="keywordtype">char</span>  driveStr[4];
00550 
00551     <a class="code" href="classSys.html#m29">cdrom_drive</a> = 0;
00552 
00553 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00554 <span class="preprocessor"></span>    <span class="comment">// don't check at all</span>
00555     <span class="keywordflow">return</span>;
00556 
00557     <span class="keyword">static</span> <span class="keywordtype">char</span> checkFileName[30] = <span class="stringliteral">"D:\\VU.EXE"</span>;
00558 <span class="preprocessor">#elif(defined(ADMIN))</span>
00559 <span class="preprocessor"></span>    <span class="keyword">static</span> <span class="keywordtype">char</span> checkFileName[30] = <span class="stringliteral">"D:\\ADMIN.EXE"</span>;<span class="comment">// check this file to identify the disc</span>
00560 <span class="preprocessor">#else</span>
00561 <span class="preprocessor"></span>    <span class="keyword">static</span> <span class="keywordtype">char</span> checkFileName[30] = <span class="stringliteral">"D:\\VU.EXE"</span>;
00562 <span class="preprocessor">#endif</span>
00563 <span class="preprocessor"></span>
00564     driveStr[1] = <span class="charliteral">':'</span>;
00565     driveStr[2] = <span class="charliteral">'\\'</span>;
00566     driveStr[3] = 0;
00567 
00568     <span class="keywordflow">for</span>(i=<span class="charliteral">'C'</span>; i&lt;<span class="charliteral">'Z'</span>; i++) {
00569         checkFileName[0] = i;
00570 
00571         driveStr[0] = i;
00572 
00573         <span class="keywordflow">if</span>(GetDriveType(driveStr) == DRIVE_CDROM) {
00574             <span class="keywordflow">if</span>( m.is_file_exist(checkFileName) ) {
00575                 <a class="code" href="classSys.html#m29">cdrom_drive</a> = i;
00576                 <span class="keywordflow">break</span>;
00577             }
00578         }
00579     }
00580 }
00581 
00582 <span class="comment">//--------- End of function Sys::get_cdrom_drive ---------------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:29 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
