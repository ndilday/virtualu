<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Ofin_day.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Ofin_day.cpp</h1><a href="Ofin__day_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OFinance.cpp</span>
00002 <span class="comment">//Description : Finance Class Definition (functions support next_day())</span>
00003 <span class="comment">//Owner       : Fred</span>
00004 
00005 <span class="comment">// update values for interface; refer to "design doc June 5.doc" p.9 - p.11</span>
00006 
00007 <span class="comment">// ES library header file</span>
00008 <span class="comment">// CU header file</span>
00009 <span class="preprocessor">#include &lt;OMATH.H&gt;</span>                                <span class="comment">// get_random_snd()</span>
00010 <span class="preprocessor">#include &lt;OCONFIG.H&gt;</span>
00011 <span class="preprocessor">#include &lt;OAUDIO.H&gt;</span>
00012 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>                                 <span class="comment">// .signal_exit_flag</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="OBOX_8H.html">OBOX.H</a>&gt;</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00015 <span class="preprocessor">#include &lt;<a class="code" href="ODATE_8H.html">ODATE.H</a>&gt;</span>
00016 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>                                <span class="comment">// info.game_day</span>
00017 <span class="preprocessor">#include &lt;OOPT.H&gt;</span>
00018 <span class="preprocessor">#include &lt;ODEPT.H&gt;</span>                                <span class="comment">// for ::update_projected_arrays_monthly()</span>
00019 <span class="preprocessor">#include &lt;OFACULTY.H&gt;</span>                             <span class="comment">// for ::update_projected_arrays_monthly()</span>
00020 <span class="preprocessor">#include &lt;<a class="code" href="OPEERSCH_8H.html">OPEERSCH.H</a>&gt;</span>                             <span class="comment">// for schoolres.player_peer_school</span>
00021 <span class="preprocessor">#include &lt;<a class="code" href="OSCHLRES_8H.html">OSCHLRES.H</a>&gt;</span>
00022 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>
00023 <span class="preprocessor">#include &lt;OFACILIT.H&gt;</span>                             <span class="comment">// total_debt_capacity</span>
00024 <span class="preprocessor">#include &lt;OINVEST.H&gt;</span>
00025 <span class="preprocessor">#include &lt;ODEVELOP.H&gt;</span>
00026 <span class="preprocessor">#include &lt;OFINANCE.H&gt;</span>
00027 <span class="preprocessor">#include &lt;OCHANCE.H&gt;</span>
00028 <span class="preprocessor">#include &lt;OSTUDENT.H&gt;</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="OSTUOFF_8H.html">OSTUOFF.H</a>&gt;</span>
00030 <span class="preprocessor">#include &lt;OLIBTECH.H&gt;</span>
00031 <span class="preprocessor">#include &lt;<a class="code" href="OLOG_8H.html">OLOG.H</a>&gt;</span>
00032 
00033 <span class="comment">//define        DEBUG_REPORT_NOT</span>
00034 
00035 <span class="comment">//----------- Define constants -------------//</span>
00036 <span class="comment">//----------- Define static variables -------------//</span>
00037 <span class="keyword">static</span> <span class="keywordtype">bool</span> terminate_if_bad_finance = <span class="keyword">true</span>;
00038 
00039 <span class="comment">//----------- Define static class member variables -------------//</span>
00040 
00041 <span class="comment">//----------- Define static functions -------------//</span>
00042 
00043 <span class="keyword">static</span> <span class="keywordtype">bool</span> ask_quit_game(<span class="keywordtype">char</span> *str) {
00044     <a class="code" href="classString.html">String</a> strOut(str);
00045     <span class="comment">//strOut += "  Quit this game ?";</span>
00046 
00047     <span class="comment">//return box.ask(strOut) == 1;</span>
00048 
00049     box.msg(strOut);
00050 
00051     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00052 }
00053 
00054 <span class="keyword">static</span> <span class="keywordtype">bool</span> ask_quit(<span class="keywordtype">char</span> *str, <span class="keywordtype">bool</span> toQuit) {
00055     <span class="keywordflow">if</span> ( sys.signal_exit_flag )
00056         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00057 
00058     <span class="comment">//playsound</span>
00059     audio.play_wav(<span class="stringliteral">"NEWS"</span>,audio.int_to_DsVolume(config.sound_effect_volume));
00060 
00061     <span class="comment">// call interface to ask "end this game?"</span>
00062 
00063     vga.use_front();                                <span class="comment">// 1117</span>
00064     toQuit = toQuit || ask_quit_game(str);
00065     vga.use_back();                                 <span class="comment">// 1117</span>
00066 
00067     <span class="keywordflow">if</span> ( toQuit ) {
00068         sys.signal_exit_flag = 1;
00069         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00070     }
00071     <span class="keywordflow">else</span> {
00072         sys.redraw_all_flag = 1;
00073         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00074     }
00075 }
00076 
00077 <span class="keyword">static</span> <span class="keywordtype">char</span> get_sign(<span class="keywordtype">double</span> v) {
00078     <span class="keywordflow">if</span> ( v == 0 )
00079         <span class="keywordflow">return</span> <a class="code" href="Ofinance_8h.html#a95a18">NO_SIGN</a>;
00080     <span class="keywordflow">else</span>
00081         <span class="keywordflow">return</span> (v &gt; 0 ? <a class="code" href="Ofinance_8h.html#a95a16">POSITIVE</a> : <a class="code" href="Ofinance_8h.html#a95a17">NEGATIVE</a> );
00082 }
00083 
00084 <span class="comment">//----------- End Define static functions -------------//</span>
00085 
00086 <span class="comment">//----------- Begin of function Finance::optimization_input_reset -------------//</span>
00088 <span class="comment">void Finance::optimization_input_reset() {</span>
00089     <span class="keywordtype">int</span> i;
00090 
00091     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>; i++ )
00092         revenue_policy_array[i].reset_change();
00093 
00094     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; i++ )
00095         expense_policy_array[i].reset_change();
00096 
00097     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; i++ )
00098         cost_rise_policy_array[i].reset_change();
00099 
00100     <a class="code" href="structFinancePolicy.html">FinancePolicy</a> *policy;
00101 
00102     <span class="keywordflow">switch</span> ( player_school.scenario_id ) {
00103     <span class="keywordflow">case</span> ( SCN_LIMIT_TUITION_GROWTH ):
00104         policy = &amp;(revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>]);
00105         policy-&gt;<a class="code" href="structFinancePolicy.html#m8">upper_limit</a> = 0;
00106         policy-&gt;<a class="code" href="structFinancePolicy.html#m2">upper_bound</a> = 0;
00107         policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a> = 0;
00108         policy-&gt;<a class="code" href="structFinancePolicy.html#a1">bound_correction</a>();
00109         <span class="keywordflow">break</span>;
00110     }
00111 }
00112 
00113 <span class="comment">//----------- End of function Finance::optimization_input_reset -------------//</span>
00114 
00115 <span class="comment">/*</span>
00116 <span class="comment">//----------- Begin of function Finance::calc_change -------------//</span>
00120 <span class="comment">double Finance::calc_change(double dest, double base)</span>
00121 <span class="comment">{</span>
00122 <span class="comment">  if ( base &gt; 1E-5)</span>
00123 <span class="comment">    return (dest - base) * 100 / base;</span>
00124 <span class="comment">  else</span>
00125 <span class="comment">    return 0;</span>
00126 <span class="comment">}</span>
00127 <span class="comment">//----------- Begin of function Finance::calc_change --------//</span>
00128 <span class="comment">*/</span>
00129 
00130 <span class="comment">//----------- Begin of function Finance::calc_change replace ABOVE -------------//</span>
<a name="l00134"></a><a class="code" href="classFinance.html#d0">00134</a> <span class="comment">double Finance::calc_change(double dest, double base) {</span>
00135     <span class="comment">//---- if both are negative, reverse them to both positive ---//</span>
00136 
00137     <span class="keywordflow">if</span>( dest &lt; 0 &amp;&amp; base &lt; 0 ) {
00138         dest = -dest;
00139         base = -base;
00140     }
00141 
00142     <span class="comment">//----------------------------------------------//</span>
00143 
00144     <span class="keywordtype">double</span> diff,locdest,locbase,result;
00145     locdest = dest;
00146     locbase = base;
00147 
00148     <span class="keywordflow">if</span>(dest == 0 || dest == base)
00149         <span class="keywordflow">return</span> 0;
00150 
00151     <span class="comment">//----------------------------------------//</span>
00152 
00153     diff = dest - base;
00154 
00155     <span class="keywordflow">if</span> (diff &lt;0)
00156         diff = -(diff);
00157 
00158     <span class="keywordflow">if</span> (locbase &lt;0)
00159         locbase =- (locbase);
00160 
00161     <span class="keywordflow">if</span>(locbase == 0)                                <span class="comment">//## chea avoid divided by 051099 0</span>
00162         <span class="keywordflow">return</span> 0;
00163 
00164     result = diff/locbase*100;
00165 
00166     <span class="keywordflow">if</span> (dest&lt;base)
00167         <span class="keywordflow">return</span> -result;
00168     <span class="keywordflow">else</span>
00169         <span class="keywordflow">return</span> result;
00170 
00171     <span class="keywordflow">return</span> 0;                                       <span class="comment">//## chea if unknown value is passed</span>
00172 
00173 }
00174 
00175 <span class="comment">//----------- END of function Finance::calc_change_local --------//</span>
00176 
00177 <span class="comment">//----------- Begin of function Finance::get_available_funds --------//</span>
<a name="l00178"></a><a class="code" href="classFinance.html#a37">00178</a> <span class="keywordtype">double</span> <a class="code" href="classFinance.html#a37">Finance::get_available_funds</a>() {
00179     <span class="keywordtype">float</span> opReserve = (float) finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>];
00180 
00181     <span class="keywordtype">float</span> availableFunds = float( opReserve
00182                                   + 0.5*( <a class="code" href="classFinance.html#m18">this_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]
00183                                           +<a class="code" href="classFinance.html#m18">this_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>] )
00184                                   + 0.25 * <a class="code" href="classFinance.html#m18">this_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a23">AC_BUILDINGS</a>]
00185                                   - <a class="code" href="classFinance.html#m18">this_year</a>.<a class="code" href="structYearReport.html#m2">liability_array</a>[<a class="code" href="Ofinance_8h.html#a99a29">AC_LIABILITY_TOTAL</a>]);
00186 
00187     <span class="keywordflow">return</span> max(0.0f,availableFunds);                <span class="comment">//min &amp; max bug chea</span>
00188 }
00189 
00190 <span class="comment">//----------- Begin of function Finance::get_available_funds --------//</span>
00191 
00192 <span class="comment">//----------- Begin of function Finance::next_day --------//</span>
<a name="l00194"></a><a class="code" href="classFinance.html#a15">00194</a> <span class="comment">void Finance::next_day() {</span>
00195     <span class="comment">//-------- Chance Card special handling ---------//</span>
00196 
00197     <span class="keywordflow">if</span> (chance_event.dept_technology_transfer_start_year == info.game_year &amp;&amp;
00198         chance_event.dept_technology_transfer_start_month == info.game_month &amp;&amp; info.game_day==16) {
00199         <span class="comment">//update screen</span>
00200         budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].total += chance_event.dept_technology_transfer_research_amount;
00201         projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].this_year.total += chance_event.dept_technology_transfer_research_amount;
00202         sys.redraw_all_flag=1;
00203     }
00204 
00205     <span class="keywordflow">if</span> (chance_event.dept_technology_transfer_start_year+3 == info.game_year &amp;&amp;
00206         chance_event.dept_technology_transfer_start_month == info.game_month &amp;&amp; info.game_day==16) {
00207         budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].total -= chance_event.dept_technology_transfer_research_amount;
00208         projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].this_year.total -= chance_event.dept_technology_transfer_research_amount;
00209 
00210         box.msg(<span class="stringliteral">"This is the last year of your sponsorship deal. "</span>);
00211         chance_event.dept_technology_transfer_start_year=0;
00212     }
00213 
00214     <span class="keywordflow">if</span> ( chance_event.research_prize_happen_date == info.game_day-1 &amp;&amp; chance_event.research_prize_happen_month == info.game_month
00215          <span class="comment">//game_day-1 because ochance run first</span>
00216          &amp;&amp; chance_event.research_prize_happen_year == info.game_year) {
00217         development_office.this_year.total *= m.fmin(1.10f, math.get_random_snd(1.15f, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.05f)));
00218     }
00219 
00220 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00221 <span class="preprocessor"></span>
00222     <span class="comment">// calculate the upper bound of indirect cost rate, for reset in 1st sept</span>
00223 
00224     <span class="comment">// info.game_day never 31</span>
00225     <span class="keywordflow">if</span>( date.day(info.game_date) == 30 &amp;&amp; info.game_month == 8 ) {
00226         <span class="comment">// calc the new value of the upper bound of indirect cost rate,</span>
00227         <span class="comment">// will be set at the first day of next year</span>
00228 
00229         <span class="keywordtype">double</span> costRatio = math.safe_divide( budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].total,
00230                                              budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].total + budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].total );
00231         <span class="keywordtype">double</span> costRecovery = (budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a48">AC_IT_RESOURCES</a>].total
00232                                + budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].total
00233                                + budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a53">AC_OPERATIONS_AND_MAINTENANCE</a>].total) * costRatio;
00234 
00235         next_indirect_cost_rate_upper_bound = math.safe_divide( costRecovery, budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].total ) * 100.0;
00236     }
00237 
00238     <span class="comment">// now reset upper_bound change</span>
00239 
00240     <span class="keywordflow">if</span>( !(info.prerun_year &amp;&amp; info.game_year == 1)  <span class="comment">// skip start of prerun year</span>
00241         &amp;&amp; info.game_day == 1 &amp;&amp; info.game_month == 9 ) {
00242         <a class="code" href="structFinancePolicy.html">FinancePolicy</a>* policy = &amp;revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>];
00243         policy-&gt;<a class="code" href="structFinancePolicy.html#m2">upper_bound</a> = next_indirect_cost_rate_upper_bound;
00244         <span class="keywordtype">double</span> oldResultValue = policy-&gt;<a class="code" href="structFinancePolicy.html#m5">result_value</a>; <span class="comment">// don't change result value</span>
00245         policy-&gt;<a class="code" href="structFinancePolicy.html#a1">bound_correction</a>();
00246         policy-&gt;<a class="code" href="structFinancePolicy.html#m5">result_value</a> = oldResultValue;
00247     }
00248 
00249     <span class="comment">// reset required flag of surplus/deficit, and indirect cost rate</span>
00250 
00251     <span class="keywordflow">if</span>( info.prerun_year &amp;&amp; info.game_year == 2
00252         <span class="comment">// start of first year</span>
00253         &amp;&amp; info.game_day == 1 &amp;&amp; info.game_month == 9 ) {
00254         expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a74">PL_SURPLUS_DEFICIT</a>].required_flag = 0;
00255         revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>].required_flag = 0;
00256     }
00257 <span class="preprocessor">#endif</span>
00258 <span class="preprocessor"></span>
00259     <span class="comment">//---------- run finance monthly -----------//</span>
00260 
00261     <span class="keywordflow">if</span> ( info.game_day != 1 )
00262         <span class="keywordflow">return</span>;
00263 
00264     month_left--;
00265 
00266     <span class="comment">//--------- if it's not the start of a new financial year --------//</span>
00267 
00268     <span class="keywordflow">if</span> ( info.game_month != fiscal_year_start_month ) {
00269         <span class="comment">// IMPORTANT asumption: the start date of a game is</span>
00270         <span class="comment">// equal to the start of financial year.</span>
00271 
00272         <a class="code" href="ALL_8H.html#a0">err_when</a>(month_left &lt;= 0 &amp;&amp; month_left &gt;= 12);
00273         update_projected_arrays_monthly();
00274 
00275 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00276 <span class="preprocessor"></span>        <span class="comment">// override budget to current projected value</span>
00277         <span class="keywordflow">if</span>( info.prerun_year &amp;&amp; info.financial_year() == 1 &amp;&amp; info.game_month == 8 ) {
00278             projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].this_year.staff *= 0.5;
00279             projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].this_year.other *= 0.5;
00280 
00281             projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].this_year.total =
00282                 projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].this_year.faculty
00283                 + projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].this_year.staff
00284                 + projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].this_year.other;
00285 
00286             <span class="comment">// calc total revenue</span>
00287             <span class="keywordtype">double</span> totalRevenue = 0.0;
00288             <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; ++i ) {
00289                 <span class="keywordflow">if</span>( i != <a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a> )
00290                     totalRevenue += projected_revenue_array[i].this_year.total;
00291             }
00292             <span class="keywordtype">double</span> totalExpense = 0.0f;
00293             <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a> ; i++ )
00294                 totalExpense += projected_expense_array[i].this_year.total;
00295 
00296             projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].this_year.total
00297                 += totalExpense * ( 1.0 + expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a74">PL_SURPLUS_DEFICIT</a>].target_value / 100.0 ) - totalRevenue;
00298 
00299             <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; ++i ) {
00300                 <span class="keywordflow">if</span>( i == <a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a> ) {
00301                     projected_revenue_array[i].last_month.direct = projected_revenue_array[i].this_year.direct / 12.0;
00302                     projected_revenue_array[i].last_month.indirect = projected_revenue_array[i].this_year.indirect / 12.0;
00303                 }
00304                 projected_revenue_array[i].last_month.total = projected_revenue_array[i].this_year.total / 12.0;
00305                 <span class="keywordflow">if</span>( i == <a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a> ) {
00306                     <span class="comment">// 11 months from September</span>
00307                     projected_revenue_array[i].year_to_date.direct = projected_revenue_array[i].last_month.direct * 11;
00308                     projected_revenue_array[i].year_to_date.indirect = projected_revenue_array[i].last_month.indirect * 11;
00309                 }
00310                 projected_revenue_array[i].year_to_date.total = projected_revenue_array[i].last_month.total * 11;
00311                 <span class="keywordflow">if</span>( i == <a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a> ) {
00312                     budget_revenue_array[i].direct = projected_revenue_array[i].this_year.direct;
00313                     budget_revenue_array[i].indirect = projected_revenue_array[i].this_year.indirect;
00314                 }
00315                 budget_revenue_array[i].total = projected_revenue_array[i].this_year.total;
00316             }
00317             <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; ++i ) {
00318                 projected_expense_array[i].last_month.faculty = projected_expense_array[i].this_year.faculty / 12.0;
00319                 projected_expense_array[i].last_month.staff = projected_expense_array[i].this_year.staff / 12.0;
00320                 projected_expense_array[i].last_month.other = projected_expense_array[i].this_year.other / 12.0;
00321                 projected_expense_array[i].last_month.total = projected_expense_array[i].this_year.total / 12.0;
00322                 projected_expense_array[i].year_to_date.faculty = projected_expense_array[i].last_month.faculty * 11;
00323                 projected_expense_array[i].year_to_date.staff = projected_expense_array[i].last_month.staff * 11;
00324                 projected_expense_array[i].year_to_date.other = projected_expense_array[i].last_month.other * 11;
00325                 projected_expense_array[i].year_to_date.total = projected_expense_array[i].last_month.total * 11;
00326                 budget_expense_array[i].faculty = projected_expense_array[i].this_year.faculty;
00327                 budget_expense_array[i].staff = projected_expense_array[i].this_year.staff;
00328                 budget_expense_array[i].other = projected_expense_array[i].this_year.other;
00329                 budget_expense_array[i].total = projected_expense_array[i].this_year.total;
00330             }
00331 
00332             <span class="comment">// recalc to debug</span>
00333             totalRevenue = 0.0f;
00334             <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; ++i ) {
00335                 <span class="keywordflow">if</span>( i != <a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a> )
00336                     totalRevenue += projected_revenue_array[i].this_year.total;
00337             }
00338 
00339             totalRevenue = 0.0f;
00340 
00341             budget_calc_total();
00342 
00343 <span class="preprocessor">#ifdef DEBUG</span>
00344 <span class="preprocessor"></span>            <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>( <span class="stringliteral">"Modify projected and budget on 1 Aug of pre-run year"</span> );
00345             <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; ++i ) {
00346                 <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>( budget_revenue_array[i].total );
00347             }
00348             <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; ++i ) {
00349                 <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>( budget_expense_array[i].total );
00350             }
00351             <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>( <span class="stringliteral">"End modify projected and budget"</span> );
00352 <span class="preprocessor">#endif</span>
00353 <span class="preprocessor"></span>
00354         }
00355 <span class="preprocessor">#endif</span>
00356 <span class="preprocessor"></span>
00357         update_history(UPDATE_MONTH);
00358     }
00359     <span class="keywordflow">else</span> {                                          <span class="comment">//--------- if it's the start of a new financial year --------//</span>
00360         <span class="comment">// assume update_projected_arrays_pre_optimization() called.</span>
00361         update_projected_arrays_post_optimization();
00362 
00363         <span class="keywordflow">if</span>( !info.prerun_year )
00364             update_hiring_policy();
00365 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00366 <span class="preprocessor"></span>        <span class="comment">// deinit the dynamic array in each department</span>
00367         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=department_array.size(); i&gt;0; i-- ) {
00368             <span class="keywordflow">if</span> ( department_array.is_deleted(i) )
00369                 <span class="keywordflow">continue</span>;
00370 
00371             <a class="code" href="classDepartment.html">Department</a>* deptPtr = department_array[i];
00372 
00373             <span class="comment">// renew the display_faculty_array in this department</span>
00374             <span class="keywordtype">int</span> arraySize = deptPtr-&gt;cur_faculty_array.size();
00375 
00376             <span class="comment">// save the data of faculty into history</span>
00377             deptPtr-&gt;departures_history[THIS_YEAR] = deptPtr-&gt;faculty_departures_number();
00378             deptPtr-&gt;hires_history[THIS_YEAR]    = deptPtr-&gt;faculty_new_hires_number();
00379             deptPtr-&gt;promotion_history[THIS_YEAR]  = deptPtr-&gt;faculty_promotions_number();
00380             
00381             <a class="code" href="Gamedef_8h.html#a14">shift_history</a>( deptPtr-&gt;departures_history, HISTORY_YEAR_COUNT );
00382             <a class="code" href="Gamedef_8h.html#a14">shift_history</a>( deptPtr-&gt;hires_history, HISTORY_YEAR_COUNT );
00383             <a class="code" href="Gamedef_8h.html#a14">shift_history</a>( deptPtr-&gt;promotion_history, HISTORY_YEAR_COUNT );
00384 
00385             deptPtr-&gt;display_faculty_array.zap();       <span class="comment">// clear display_faculty_array</span>
00386 
00387             <span class="keywordflow">if</span> ( arraySize != 0 ) {
00388                 <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j=1; j&lt;=arraySize; j++ ) {
00389                     <a class="code" href="classFaculty.html">Faculty</a>* facOrg = (<a class="code" href="classFaculty.html">Faculty</a>*) deptPtr-&gt;cur_faculty_array.get(j);
00390                     deptPtr-&gt;display_faculty_array.linkin( facOrg );
00391                 }
00392                 deptPtr-&gt;cur_faculty_array.zap();
00393             }
00394         }
00395 <span class="preprocessor">#endif</span>
00396 <span class="preprocessor"></span>
00397         update_history(UPDATE_ALL);
00398 
00399     }
00400 
00401 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00402 <span class="preprocessor"></span>    <span class="comment">// ----- Begin ----- //</span>
00403     <span class="comment">// ----- 5. Bankruptcy Warning ----- //</span>
00404 
00405     <span class="comment">// set up variables for calculations</span>
00406     <span class="keywordtype">double</span> projectedYearEndSyrplusOrDeficit;
00407     <span class="keywordtype">int</span> monthsToBankruptcy;
00408     <span class="keyword">const</span> <span class="keywordtype">double</span> maxStDebtPct = 10;                 <span class="comment">// 99%</span>
00409     <span class="keyword">const</span> <span class="keywordtype">double</span> maxStExpPct = 50;                  <span class="comment">// 99%</span>
00410     <span class="keywordtype">float</span> shortTermDebtCap;
00411     <span class="keywordtype">double</span> currentLoanValue;
00412     <span class="keywordtype">int</span> monthsToYearEnd;
00413 
00414     <span class="comment">// set projectedYearEndSyrplysOrDeficit</span>
00415     projectedYearEndSyrplusOrDeficit = finance.this_year.surplus_deficit;
00416 
00417     <span class="comment">// set shortTermDebtCap</span>
00418     shortTermDebtCap = (float) max(maxStDebtPct * get_available_funds()/ 100,
00419                                    maxStExpPct * finance.projected_total_operating_expense.this_year.total / 100);
00420 
00421     <span class="comment">// set currentLoanValue</span>
00422     <span class="keywordflow">if</span> ( (finance.this_year.asset_array[0] + finance.this_year.asset_array[1]) &lt; 0 )
00423         currentLoanValue = abs(finance.this_year.asset_array[0] + finance.this_year.asset_array[1]);
00424     <span class="keywordflow">else</span>
00425         currentLoanValue = 0;
00426 
00427     <span class="comment">// set monthsToYearEnd</span>
00428     monthsToYearEnd = finance.fiscal_year_start_month - info.game_month;
00429     <span class="keywordflow">if</span> ( monthsToYearEnd &lt;= 0 )
00430         monthsToYearEnd += 12;
00431 
00432     <span class="comment">// set monthsToBankruptcy</span>
00433     <span class="keywordflow">if</span> ( projectedYearEndSyrplusOrDeficit &lt; 0 )
00434         monthsToBankruptcy = abs(( shortTermDebtCap - currentLoanValue)/(projectedYearEndSyrplusOrDeficit/12));
00435     <span class="keywordflow">else</span>
00436         monthsToBankruptcy = 1000000;
00437 
00438     <span class="comment">// Check the conditions for different warning message,</span>
00439     <span class="comment">// and add the message to the news.</span>
00440     <span class="keywordflow">if</span> ( monthsToBankruptcy &lt;= monthsToYearEnd ) {
00441         last_warn_bankrupt_date = info.game_date;
00442         <span class="comment">// add message</span>
00443         news_array.bankruptcy_message_lv1();
00444     }
00445     <span class="keywordflow">else</span>
00446         <span class="keywordflow">if</span> (( monthsToBankruptcy &lt;= monthsToYearEnd+12) &amp;&amp; ( (info.game_date - last_warn_bankrupt_date) &gt; 90 )) {
00447             last_warn_bankrupt_date = info.game_date;
00448             <span class="comment">// add message</span>
00449             news_array.bankruptcy_message_lv2( monthsToBankruptcy );
00450         }
00451         <span class="keywordflow">else</span>
00452             <span class="keywordflow">if</span> (( monthsToBankruptcy &lt;= monthsToYearEnd+24) &amp;&amp; ( (info.game_date - last_warn_bankrupt_date) &gt; 180 )) {
00453                 last_warn_bankrupt_date = info.game_date;
00454                 <span class="comment">// add message</span>
00455                 news_array.bankruptcy_message_lv3( monthsToBankruptcy );
00456             }
00457 
00458     <span class="comment">// ----- End ----- //</span>
00459 <span class="preprocessor">#endif</span>
00460 <span class="preprocessor"></span>
00461 }
00462 
00463 <span class="comment">//------------- End of function Finance::next_day --------//</span>
00464 
00465 <span class="comment">//----------- Begin of function Finance::update_hiring_policy --------//</span>
00467 <span class="comment">void Finance::update_hiring_policy() {</span>
00468     <span class="keywordtype">float</span> totalCost = 0;                            <span class="comment">// not $000</span>
00469     <span class="keywordtype">int</span>  totalFacCount = 0;
00470     <a class="code" href="classDepartment.html">Department</a>* deptPtr;
00471 
00472     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=department_array.size(); i&gt;0; i--) {
00473         <span class="keywordflow">if</span> ( department_array.is_deleted(i) )
00474             <span class="keywordflow">continue</span>;
00475 
00476         <span class="keywordtype">int</span> facCount=0;
00477         <span class="keywordtype">float</span> total2FacultySalary = 0;                <span class="comment">// not $000</span>
00478 
00479         deptPtr = department_array[i];
00480 
00481         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> f=deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classDynArray.html#a28">size</a>(), totalFacultySalary=0; f&gt;0; f-- ) {
00482             <span class="keywordflow">if</span> ( deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#a10">is_deleted</a>(f) )
00483                 <span class="keywordflow">continue</span>;
00484 
00485             totalFacCount++;
00486 
00487             <a class="code" href="classFaculty.html">Faculty</a>* facPtr = deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>[f]; {
00488 
00489                 <span class="comment">//0407  if ( deptPtr-&gt;faculty_array[f]-&gt;rank_age_group() == FULL_PROF+1 )               // fullProf2</span>
00490                 total2FacultySalary += facPtr-&gt;<a class="code" href="classFaculty.html#m11">salary</a>;
00491                 facCount++;
00492             }
00493 
00494             totalCost += facPtr-&gt;<a class="code" href="classFaculty.html#m11">salary</a>;
00495         }
00496 
00497         <span class="comment">// avg_salary: $000</span>
00498         finance.hiring_policy_array[i-1].avg_salary = math.safe_divide(total2FacultySalary, facCount * 1000.0f);
00499 
00500         finance.hiring_policy_array[i-1].fac_count = deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#m1">faculty_count</a>;
00501     }
00502 }
00503 
00504 <span class="comment">//------------- End of function Finance::update_hiring_policy --------//</span>
00505 
00506 <span class="comment">//----------- Begin of function Finance::calc_total_faculty_salary --------//</span>
<a name="l00508"></a><a class="code" href="classFinance.html#a38">00508</a> <span class="comment">double Finance::calc_total_faculty_salary() {</span>
00509     <span class="keywordtype">int</span> d, f, facCount=0;
00510     <span class="keywordtype">short</span> deptCount = department_array.size();      <span class="comment">//, facCount;</span>
00511     <a class="code" href="classDepartment.html">Department</a> *dept;
00512     total_faculty_salary = 0;
00513 
00514     <span class="keywordflow">for</span> ( d=1; d&lt;=deptCount; d++ ) {
00515         <span class="keywordflow">if</span> ( department_array.is_deleted(d) )
00516             <span class="keywordflow">continue</span>;
00517 
00518         dept = department_array[d];
00519 
00520         <span class="comment">//facCount = dept-&gt;faculty_array.size();</span>
00521         <span class="keywordflow">for</span> ( f=dept-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classDynArray.html#a28">size</a>(); f&gt;0; f-- ) {
00522             <span class="keywordflow">if</span> ( dept-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#a10">is_deleted</a>(f) )
00523                 <span class="keywordflow">continue</span>;
00524 
00525             facCount++;
00526 
00527             total_faculty_salary += dept-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>[f]-&gt;salary;
00528         }
00529     }
00530 
00531     <span class="comment">// facCount !=0 &amp;&amp;</span>
00532     <a class="code" href="ALL_8H.html#a0">err_when</a>( total_faculty_salary &lt;=0 );
00533 
00534     total_faculty_salary /= 1000;
00535 
00536     <span class="comment">//----- update the financial data --------//</span>
00537 
00538     projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].this_year.faculty
00539         = total_faculty_salary;
00540 
00541     projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].this_year.total =
00542         projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].this_year.faculty +
00543         projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].this_year.staff   +
00544         projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].this_year.other;
00545 
00546     projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].last_month.faculty
00547         = total_faculty_salary/12.0f;
00548 
00549     projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].last_month.total =
00550         projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].last_month.faculty +
00551         projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].last_month.staff   +
00552         projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].last_month.other;
00553 
00554     calc_projected_total_n_percent(1);              <span class="comment">// 1-recalc</span>
00555 
00556     <span class="comment">//---------- return the value now ---------//</span>
00557 
00558     <span class="keywordflow">return</span> total_faculty_salary;
00559 }
00560 
00561 <span class="comment">//----------- Begin of function Finance::calc_total_faculty_salary --------//</span>
00562 
00563 <span class="comment">//----------- Begin of function Finance::update_external_factors_yearly --------//</span>
00565 <span class="comment">void Finance::update_external_factors_yearly() {</span>
00566     <span class="comment">// yearly update some factors for update_projected_arrays_monthly()</span>
00567     <span class="comment">// assume called in pre_optimization</span>
00568 
00569     <span class="comment">//990528 calc_total_faculty_salary();</span>
00570 
00571     <span class="comment">//</span>
00572     calc_interest(UPDATE_YEAR);
00573 }
00574 
00575 <span class="comment">//----------- End of function Finance::update_external_factors_yearly --------//</span>
00576 
00577 <span class="comment">//----------- Begin of function Finance::update_external_factors_monthly --------//</span>
00581 <span class="comment">void Finance::update_external_factors_monthly() {</span>
00582     <span class="comment">//-----------//</span>
00583     inflation_rate_hist.shift_hist();
00584 
00585     <span class="keyword">static</span> <span class="keywordtype">float</span> growth=0, growthLast2=0;
00586 
00587     <span class="keywordtype">float</span> old = growth;
00588     growth = math.time_variation(old, growthLast2, 1.8254f, -0.8659f, 0.000084545f);
00589     growthLast2 = old;
00590 
00591     inflation_rate_hist.set_cur(inflation_rate_hist.get_cur() + growth);
00592     inflation_rate = inflation_rate_hist.get_sum(); <span class="comment">// set annual inflation rate</span>
00593 
00594     inflation_rate_hist.set_cur(0);                 <span class="comment">//0222</span>
00595     inflation_rate = 0;                             <span class="comment">//0222</span>
00596 
00597     <a class="code" href="ALL_8H.html#a0">err_when</a>(inflation_rate_hist.get_cur() != 0 );
00598 
00599     <span class="comment">//-----------//</span>
00600     calc_interest(UPDATE_MONTH);
00601 
00602     <span class="comment">//-----------//</span>
00603     <a class="code" href="classPeerSchool.html">PeerSchool</a> *player = school_res.player_peer_school;
00604     <span class="keywordtype">int</span>   totalFacResearchExpense = 0;              <span class="comment">// monthly</span>
00605     <span class="keywordtype">short</span>   d;
00606     <span class="comment">// double   last;</span>
00607 
00608     <span class="keywordflow">for</span> ( d=department_array.size(); d&gt;0; d-- ) {
00609         <span class="keywordflow">if</span> ( department_array.is_deleted(d) )
00610             <span class="keywordflow">continue</span>;
00611 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00612 <span class="preprocessor"></span>        <span class="comment">// no divided by 1000 yet</span>
00613         totalFacResearchExpense += department_array[d]-&gt;total_research_dollar;
00614 <span class="preprocessor">#else</span>
00615 <span class="preprocessor"></span>        <span class="comment">//## chea 130899 try to lower the SPONSORED_RESEARCH change by lower the last_month.total</span>
00616         <span class="comment">//              department_array[d]-&gt;total_research_dollar = (int)(department_array[d]-&gt;total_research_dollar*0.7);</span>
00617 
00618         <span class="comment">//## chea 221199</span>
00619         <span class="comment">//              totalFacResearchExpense += department_array[d]-&gt;total_research_dollar;</span>
00620         totalFacResearchExpense += department_array[d]-&gt;total_research_dollar/1000;
00621 <span class="preprocessor">#endif</span>
00622 <span class="preprocessor"></span>
00623     }
00624 
00625 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00626 <span class="preprocessor"></span>    <span class="comment">// * 12 / 1000;</span>
00627     projected_total_research_expense_this_year = totalFacResearchExpense * 3 / 250;
00628 <span class="preprocessor">#else</span>
00629 <span class="preprocessor"></span>    projected_total_research_expense_this_year = 12 * totalFacResearchExpense;
00630 <span class="preprocessor">#endif</span>
00631 <span class="preprocessor"></span>
00632     <span class="comment">//## chea 130899 try to lower the SPONSORED_RESEARCH change by lower the last_month.total</span>
00633 
00634     <span class="comment">//  projected_total_research_expense_this_year = (int)(projected_total_research_expense_this_year * 0.8);</span>
00635 
00636     <span class="comment">/*  990519</span>
00637 <span class="comment">        last = budget_revenue_array[AC_SPONSORED_RESEARCH_REVENUE].total</span>
00638 <span class="comment">        = projected_total_research_expense_this_year;</span>
00639 <span class="comment">        budget_revenue_array[AC_SPONSORED_RESEARCH_REVENUE].direct</span>
00640 <span class="comment">        = last / ( 1 + get_research_overhead_rate() / 100.0);</span>
00641 <span class="comment">        budget_revenue_array[AC_SPONSORED_RESEARCH_REVENUE].indirect</span>
00642 <span class="comment">        = last - budget_revenue_array[AC_SPONSORED_RESEARCH_REVENUE].direct;</span>
00643 <span class="comment">    */</span>
00644 
00645     <span class="comment">//-----------//</span>
00646     <span class="comment">// academic support ratio = deptSupp$/(facSal+dirSponsRes); for pi calc of faculty</span>
00647     <span class="keywordtype">float</span> facExp, nonfacExp;
00648     nonfacExp = float(finance.projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].this_year.staff
00649                       + finance.projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].this_year.other);
00650     facExp = float(finance.total_faculty_salary + finance.projected_total_research_expense_this_year);
00651     academic_support_ratio = facExp&gt;0? nonfacExp/facExp : 0;
00652 }
00653 
00654 <span class="comment">//----------- End of function Finance::update_external_factors_monthly --------//</span>
00655 
00656 <span class="comment">//----------- Begin of function Finance::calc_interest --------//</span>
00664 <span class="comment">void Finance::calc_interest(char updateFlag) {</span>
00665     <span class="keyword">static</span> <a class="code" href="structHistoryData.html">HistoryData</a> randomVarST;
00666     <span class="keyword">static</span> <a class="code" href="structHistoryData.html">HistoryData</a> randomVarLT;
00667     <span class="keywordtype">float</span>  multiplier, multiplierInput;
00668 
00669     <span class="keywordtype">double</span> opReserve = last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>];
00670 
00671     <span class="keywordtype">float</span> temp=(float)get_available_funds();
00672 
00673     <span class="keywordflow">switch</span> (updateFlag) {
00674     <span class="keywordflow">case</span> UPDATE_MONTH:
00675         randomVarST.<a class="code" href="structHistoryData.html#a7">shift_hist</a>();
00676 
00677         <span class="comment">//BUGHER found with Bill 0406: short_term_debt_interest decreases too fast...</span>
00678         randomVarST.<a class="code" href="structHistoryData.html#a3">set_cur</a>(math.time_variation(randomVarST.<a class="code" href="structHistoryData.html#a6">get</a>(-1), randomVarST.<a class="code" href="structHistoryData.html#a6">get</a>(-2), 1.8234f, -0.8909f, 0.00028114f));
00679         base_short_term_debt_interest = max(0.1, randomVarST.<a class="code" href="structHistoryData.html#a4">get_cur</a>() + base_short_term_debt_interest);
00680 
00681         <span class="comment">//---------------------------//</span>
00682 
00683         <span class="comment">//multiplier = Max[outstanding short term debt/prior year operating expenditure, outstanding short-term debt/availabole funds]</span>
00684 
00685         <span class="comment">// Start 06Mar Trev //</span>
00686 
00687         <span class="keywordtype">float</span> a,b;
00688 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00689 <span class="preprocessor"></span>        a=(float)math.safe_divide( (<span class="keywordtype">double</span>)facility_office.total_debt_capacity[THIS_YEAR], total_operating_expense.total);
00690         b=(float)math.safe_divide( (<span class="keywordtype">double</span>)facility_office.total_debt_capacity[THIS_YEAR], get_available_funds());
00691 <span class="preprocessor">#else</span>
00692 <span class="preprocessor"></span>        a=(float)(facility_office.total_debt_capacity[THIS_YEAR] / total_operating_expense.total);
00693         b=(float)(facility_office.total_debt_capacity[THIS_YEAR] / get_available_funds());
00694 <span class="preprocessor">#endif</span>
00695 <span class="preprocessor"></span>
00696         multiplierInput = max(a, b);
00697 
00698         multiplierInput = max(0.0f, multiplierInput);
00699         multiplierInput = min(1.0f, multiplierInput);
00700 
00701         <span class="comment">// End 06Mar Trev //</span>
00702 
00703         <span class="comment">//## chea try to slove the 0/0 problem</span>
00704 
00705         multiplier = math.dual_response_func(1.000f, 1.776f, 4.000f, -1.045f, -0.253f, 0.575f, 0.222f, <span class="keywordtype">float</span>(multiplierInput));
00706 
00707         <span class="comment">//0406</span>
00708         multiplier = (opReserve&gt;0) ? 1.0f : multiplier;
00709 
00710         short_term_debt_interest = max(0.1, multiplier * base_short_term_debt_interest);
00711         <span class="keywordflow">break</span>;
00712 
00713         <span class="comment">//---------------------------//</span>
00714     <span class="keywordflow">case</span> UPDATE_YEAR:
00715         randomVarLT.<a class="code" href="structHistoryData.html#a7">shift_hist</a>();
00716 
00717         randomVarLT.<a class="code" href="structHistoryData.html#a3">set_cur</a>(math.time_variation(randomVarLT.<a class="code" href="structHistoryData.html#a6">get</a>(-1), randomVarLT.<a class="code" href="structHistoryData.html#a6">get</a>(-2), 0.5380f, -0.7579f, 0.006099140f));
00718         base_long_term_debt_interest = max(0.05, randomVarLT.<a class="code" href="structHistoryData.html#a4">get_cur</a>() + base_short_term_debt_interest
00719                                            <span class="comment">// 0: latest/current data</span>
00720                                            + inflation_rate - 12 * inflation_rate_hist.get_cur());
00721 
00722         <span class="comment">//---------------------------//</span>
00723 
00724         <span class="comment">// multiplier = (longTermTebtCapacity-outstandingLongTermDebt)/longTermTebtCapacity</span>
00725         multiplier = (float) calc_change(this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a29">AC_LIABILITY_TOTAL</a>], facility_office.total_debt_capacity[THIS_YEAR]) / -100;
00726         multiplier = math.dual_response_func(1.000f, 1.223f, 2.0f, -0.354f, -0.354f, 0.908f, 0.256f, <span class="keywordtype">float</span>(multiplier));
00727 
00728         long_term_debt_interest = multiplier * base_long_term_debt_interest;
00729         <span class="keywordflow">break</span>;
00730 
00731         <span class="comment">//---------------------------//</span>
00732     <span class="keywordflow">case</span> UPDATE_ALL:
00733         calc_interest(UPDATE_YEAR);
00734         calc_interest(UPDATE_MONTH);
00735         <span class="keywordflow">break</span>;
00736 
00737     <span class="keywordflow">default</span>:
00738         <a class="code" href="ALL_8H.html#a1">err_here</a>();
00739         <span class="keywordflow">break</span>;
00740     }
00741 }
00742 
00743 <span class="comment">//----------- End of function Finance::calc_interest --------//</span>
00744 
00745 <span class="comment">//---------- Begin of function Finance::update_projected_arrays_pre_optimization -----------//</span>
<a name="l00750"></a><a class="code" href="classFinance.html#a27">00750</a> <span class="comment">bool Finance::update_projected_arrays_pre_optimization() {</span>
00751     <a class="code" href="ALL_8H.html#a0">err_when</a>(month_left != 1);
00752     month_left = 0;                                 <span class="comment">// a little trick herew</span>
00753     update_external_factors_yearly();
00754     update_projected_arrays_monthly();
00755 
00756     <span class="comment">//----------------------//</span>
00757     <span class="comment">// CHECK TERMINATION</span>
00758     <span class="comment">//----------------------//</span>
00759 
00760     <span class="keywordflow">if</span> ( terminate_if_bad_finance ) {
00761         <span class="comment">//-------- A. check if we should terminate the game // 1016</span>
00762         <span class="keywordtype">double</span> reserve  = this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>];
00763         <span class="keywordtype">double</span> limit  = 0.2 * investment_office.smoothed_endowment_value + 0.1 * this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a23">AC_BUILDINGS</a>];
00764         <span class="keyword">const</span> <span class="keywordtype">double</span> maxStDebtPct = 10;               <span class="comment">// 99%</span>
00765         <span class="keyword">const</span> <span class="keywordtype">double</span> maxStExpPct = 50;                <span class="comment">// 99%</span>
00766 
00767         <span class="keywordtype">float</span> shortTermDebtCap = (float) max(maxStDebtPct * get_available_funds()/ 100,
00768                                              maxStExpPct * finance.projected_total_operating_expense.this_year.total / 100);
00769 
00770         <a class="code" href="classString.html">String</a> str;
00771         <span class="keywordtype">bool</span> toQuit = <span class="keyword">false</span>;
00772 
00773         <span class="keywordflow">if</span> ( reserve &lt; 0 &amp;&amp; reserve &lt; -shortTermDebtCap ) {
00774             str = <span class="stringliteral">"Bankruptcy!  "</span>;
00775             str += player_school.school_name;
00776             str += <span class="stringliteral">" has no cash and no credit.  Please click OK."</span>;
00777             toQuit = <span class="keyword">false</span>;
00778 
00779             sys.set_speed(0);
00780             sys.save_speed=0;
00781 
00782             <span class="comment">//toQuit = ask_quit(str, toQuit);</span>
00783 
00784             <span class="comment">//BUGHERE //addi</span>
00785             sys.set_staying_view_mode(<a class="code" href="Osys_8h.html#a45a23">MODE_BANKRUPTCY</a>); <span class="comment">// go to bankruptcy and then final score screen</span>
00786         }
00787         <span class="comment">//## chea 130899 stop the msg. display during prerun</span>
00788         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( reserve &lt; 0 &amp;&amp; reserve &lt; -shortTermDebtCap * 0.4 &amp;&amp; info.prerun_year == 0) {
00789             str = <span class="stringliteral">"Warning: Bankruptcy nears for "</span>;
00790             str += player_school.school_name;
00791             str += <span class="stringliteral">".  Having borrowed $"</span>;
00792             str += long(-reserve);
00793             str += <span class="stringliteral">", you are dangerously close to the short-term debt limit of "</span>;
00794             str += long(shortTermDebtCap);
00795             str += <span class="stringliteral">".  You must act now!"</span>;
00796             toQuit = <span class="keyword">false</span>;
00797 
00798             toQuit = ask_quit(str, toQuit);
00799         }
00800         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( reserve &lt; -limit ) {
00801             str = <span class="stringliteral">"Short of cash, "</span>;
00802             str += player_school.school_name;
00803             str += <span class="stringliteral">" must borrow from the bank to pay its bills.  The most the bank will loan is $"</span>;
00804             str += long(shortTermDebtCap);
00805             str += <span class="stringliteral">"."</span>;
00806             toQuit = <span class="keyword">false</span>;
00807 
00808             toQuit = ask_quit(str, toQuit);
00809         }
00810 
00811         <span class="keywordflow">if</span> ( toQuit )
00812             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00813     }
00814 
00815     <span class="comment">//---------------------------------------------------------------------//</span>
00816     <span class="comment">// move data of current year to last year *before* optimization</span>
00817     <span class="comment">// and clear values for this and next years</span>
00818 
00819     <span class="comment">// 1027 special case</span>
00820     <span class="comment">//other_operating_income_last2 = revenue_array[AC_OTHER_OPERATING_INCOME].total;</span>
00821     <span class="comment">//state_appropriation_last2 = revenue_array[AC_STATE_APPROPRIATION].total;</span>
00822 
00823     <span class="comment">//## chea 250899 should init the last two item into the projected_expense_array[i].this_year instead of expense_array[i]</span>
00824     <span class="keywordflow">if</span>(info.prerun_year ==1) {
00825         memcpy( &amp;(projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a55">AC_SERVICE_ON_GENERAL_PLANT_DEBT</a>].this_year),&amp;(expense_array[<a class="code" href="Ofinance_8h.html#a104a55">AC_SERVICE_ON_GENERAL_PLANT_DEBT</a>]), <span class="keyword">sizeof</span>(<a class="code" href="structExpenseItem.html">ExpenseItem</a>));
00826         memcpy( &amp;(projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>].this_year),&amp;(expense_array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>]), <span class="keyword">sizeof</span>(<a class="code" href="structExpenseItem.html">ExpenseItem</a>));
00827     }
00828 
00829     <span class="keywordtype">int</span> i;
00830 
00831     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; i++) {
00832         memcpy( &amp;(revenue_array[i]), &amp;(projected_revenue_array[i].this_year), <span class="keyword">sizeof</span>(<a class="code" href="structRevenueItem.html">RevenueItem</a>));
00833     }
00834 
00835     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; i++) {
00836         memcpy( &amp;(expense_array[i]), &amp;(projected_expense_array[i].this_year), <span class="keyword">sizeof</span>(<a class="code" href="structExpenseItem.html">ExpenseItem</a>));
00837     }
00838 
00839     memcpy( &amp;last_year, &amp;this_year, <span class="keyword">sizeof</span>(<a class="code" href="structYearReport.html">YearReport</a>));
00840     memcpy( &amp;total_revenue, &amp;projected_total_revenue.this_year, <span class="keyword">sizeof</span>(<a class="code" href="structRevenueItem.html">RevenueItem</a>));
00841     memcpy( &amp;total_operating_expense, &amp;projected_total_operating_expense.this_year, <span class="keyword">sizeof</span>(<a class="code" href="structExpenseItem.html">ExpenseItem</a>));
00842     memcpy( &amp;total_expense, &amp;projected_total_expense.this_year, <span class="keyword">sizeof</span>(<a class="code" href="structExpenseItem.html">ExpenseItem</a>));
00843 
00844     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00845 }
00846 
00847 <span class="comment">//----------- End of function Finance::update_projected_arrays_pre_optimization ------------//</span>
00848 
00849 <span class="comment">//----------- Begin of function Finance::update_projected_arrays_post_optimization --------//</span>
<a name="l00854"></a><a class="code" href="classFinance.html#a25">00854</a> <span class="comment">void Finance::update_projected_arrays_post_optimization() {</span>
00855     <span class="comment">//budget_player_report();           //BUGHERE0 double-check the call order!</span>
00856 
00857     <span class="comment">//</span>
00858     investment_office.calc_smoothed_endowment_value();
00859 
00860     <span class="comment">//</span>
00861     <span class="comment">// update this and next year report</span>
00862     <span class="comment">//</span>
00863     <a class="code" href="ALL_8H.html#a0">err_when</a>(month_left != -1);                     <span class="comment">// good check here</span>
00864 
00865     <span class="keywordtype">int</span> i;
00866 
00867     month_left = 12;
00868     <span class="comment">//990520 memset(projected_revenue_array, 0, sizeof(projected_revenue_array));</span>
00869     <span class="comment">//990520 memset(projected_expense_array, 0, sizeof(projected_expense_array));</span>
00870 
00871     <span class="keywordflow">if</span>(info.game_day==1 &amp;&amp; info.prerun_year==0)
00872         <span class="keywordtype">int</span> breajef=0;
00873 
00874     <span class="keywordtype">float</span> ratioMonth = (12-month_left) / 12.0f;
00875 
00876     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; i++ ) {
00877         projected_revenue_array[i].year_to_date.direct = ratioMonth * revenue_array[i].direct;
00878         projected_revenue_array[i].year_to_date.indirect = ratioMonth * revenue_array[i].indirect;
00879         projected_revenue_array[i].year_to_date.total = ratioMonth * revenue_array[i].total;
00880 
00881         projected_revenue_array[i].last_month.direct = budget_revenue_array[i].direct / 12.0;
00882         projected_revenue_array[i].last_month.indirect = budget_revenue_array[i].indirect / 12.0;
00883         projected_revenue_array[i].last_month.total = budget_revenue_array[i].total / 12.0;
00884     }
00885 
00886     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; i++ ) {
00887         <span class="comment">//---- sponsored research is handled differently ----//</span>
00888 
00889         <span class="keywordflow">if</span>( i==<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a> ) {
00890             <span class="keywordtype">double</span> totalFacResearchExpense = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].this_year.direct / 12.0;
00891 
00892             <span class="keywordtype">double</span> totalAYFacultySalaryOffsets = totalFacResearchExpense * 0.1;
00893 
00894             <span class="keywordtype">double</span> lastMonthFaculty = totalAYFacultySalaryOffsets;
00895             <span class="keywordtype">double</span> lastMonthOther = totalAYFacultySalaryOffsets * 0.05;
00896 
00897             <span class="keywordtype">double</span> lastMonthStaff
00898                 = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].this_year.direct / 12.0
00899                 - totalAYFacultySalaryOffsets
00900                 - lastMonthOther;
00901 
00902             projected_expense_array[i].last_month.faculty = lastMonthFaculty;
00903             projected_expense_array[i].last_month.staff = lastMonthStaff;
00904             projected_expense_array[i].last_month.other = lastMonthOther;
00905             projected_expense_array[i].last_month.total = lastMonthFaculty + lastMonthStaff + lastMonthOther;
00906         }
00907         <span class="keywordflow">else</span> {
00908             projected_expense_array[i].last_month.faculty = budget_expense_array[i].faculty / 12.0;
00909             projected_expense_array[i].last_month.staff = budget_expense_array[i].staff / 12.0;
00910             projected_expense_array[i].last_month.other = budget_expense_array[i].other / 12.0;
00911             projected_expense_array[i].last_month.total = budget_expense_array[i].total / 12.0;
00912         }
00913 
00914         projected_expense_array[i].year_to_date.faculty = ratioMonth * expense_array[i].faculty;
00915         projected_expense_array[i].year_to_date.staff = ratioMonth * expense_array[i].staff;
00916         projected_expense_array[i].year_to_date.other = ratioMonth * expense_array[i].other;
00917         projected_expense_array[i].year_to_date.total = ratioMonth * expense_array[i].total;
00918     }
00919 
00920     finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>]
00921         <span class="comment">// 0222</span>
00922         += projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>].this_year.total;
00923 
00924     <span class="comment">//  update_projected_arrays_monthly_sub();  //## chea 250899 these make the 2nd &amp; 3rd col diff.</span>
00925     update_projected_arrays_monthly_sub();          <span class="comment">//## chea 250899 these make the 2nd &amp; 3rd col diff.</span>
00926 
00927     optimization_input_reset();
00928 
00929     <span class="comment">//-----------------------------------//</span>
00930 
00931     department_array.faculty_hiring();
00932 
00933     calc_total_faculty_salary();
00934 
00935     <span class="comment">//  update_projected_arrays_monthly(); //## chea 250899 these make the 2nd &amp; 3rd col diff.</span>
00936 
00937     optimization.refresh_optimization_screen = 1;
00938 
00939     <span class="comment">//----------- scenario special handling -----------//</span>
00940 
00941     <span class="keywordflow">if</span>( player_school.scenario_id == <a class="code" href="Opschool_8h.html#a63a22">SCN_RAISE_SALARY</a> ) {
00942         player_school.scenario_faculty_salary_increase =
00943             100.0f * ( (1.0f + player_school.scenario_faculty_salary_increase / 100.0f)
00944                        *(1.0f + (float) expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a70">PL_FACULTY_SALARY_INCREASES</a>].result_value / 100.0f) - 1.0f);
00945     }
00946 
00947     <span class="comment">//------- update salary ---------//</span>
00948 
00949     department_array.salary_setting();
00950 }
00951 
00952 <span class="comment">//----------- End of function Finance::update_projected_arrays_post_optimization --------//</span>
00953 
00954 <span class="comment">//----------- Begin of function Finance::update_projected_arrays_monthly --------//</span>
00958 <span class="comment">void Finance::update_projected_arrays_monthly() {</span>
00959     update_external_factors_monthly();
00960     sys.yield();
00961 
00962     <span class="comment">/*</span>
00963 <span class="comment"></span>
00964 <span class="comment">      From Email req13d_if_finance.txt:</span>
00965 <span class="comment"></span>
00966 <span class="comment">      During the year:</span>
00967 <span class="comment">      1. Projected values for the current year (1998-99) are calculated each</span>
00968 <span class="comment">      month as described above.</span>
00969 <span class="comment">      2. "Change" (third column) equals the projected year-end value minus the</span>
00970 <span class="comment">      prior-year value.</span>
00971 <span class="comment">      3. Projected following-year values (1999-00) equal the current-year</span>
00972 <span class="comment">      projected value accelerated by the current inflation value plus the growth</span>
00973 <span class="comment">      policy factors that came out of the current year's RA procedure (C136:c144</span>
00974 <span class="comment">      of HE.ResAlloc.ex). In other words, the projected values for the following</span>
00975 <span class="comment">      year represent what would happen if current policies were applied without</span>
00976 <span class="comment">      change to the latest current year-end budget projections.</span>
00977 <span class="comment">      4. "Change" (last column) equals the difference between the projected</span>
00978 <span class="comment">      year-end numbers for 1999-00 and 1998-99.</span>
00979 <span class="comment"></span>
00980 <span class="comment">      General Equation:</span>
00981 <span class="comment">      projected_var[i] = year_to_date + (budget/12) * month_left;</span>
00982 <span class="comment"></span>
00983 <span class="comment">    */</span>
00984 
00985     <span class="keywordtype">int</span> i;
00986     <span class="keywordtype">double</span>  fTmp;
00987     <a class="code" href="classPeerSchool.html">PeerSchool</a> *player = school_res.player_peer_school;
00988 
00989     <span class="comment">//</span>
00990     <span class="comment">// -------------- Step 1. --------------</span>
00991     <span class="comment">//</span>
00992 
00993     <span class="comment">// 1a. Update last_month actual value and hence year_to_date in projected_revenue_array</span>
00994     <span class="keyword">const</span> <span class="keywordtype">float</span> perMonth = 1.0f/12.0f;
00995 
00996     <span class="comment">// ------- REVENUE YTD -------------------------- //</span>
00997 
00998     projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].last_month.total
00999         = perMonth * budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].total;
01000 
01001     projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].last_month.total
01002         = perMonth * budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].total;
01003 
01004     projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>].last_month.total
01005         = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].last_month.total
01006         + projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].last_month.total;
01007 
01008     projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].last_month.total
01009         <span class="comment">// 990519       // budget_revenue_array[AC_SPONSORED_RESEARCH_REVENUE].total;</span>
01010         = perMonth * projected_total_research_expense_this_year;
01011 
01012     <span class="keywordflow">if</span> ( development_office.this_month_total_gift &lt;= 0 )
01013         development_office.this_month_total_gift = (float) finance.revenue_array[<a class="code" href="Ofinance_8h.html#a101a36">AC_GIFTS</a>].total / 12;
01014     <span class="keywordflow">else</span>
01015         development_office.this_month_total_gift *= float(1+finance.inflation_rate_hist.get_cur()/100+development_office.gift_growth_rate);
01016 
01017     projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a36">AC_GIFTS</a>].last_month.total
01018         = development_office.this_month_total_gift;   <span class="comment">// 0115;</span>
01019 
01020     projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].last_month.total
01021         = perMonth * budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].total;
01022 
01023     fTmp = perMonth * budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a38">AC_INTERCOLLEGIATE_ATHLETICS</a>].total;
01024     projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a38">AC_INTERCOLLEGIATE_ATHLETICS</a>].last_month.total
01025         = fTmp + math.get_random_snd(0, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(<span class="keywordtype">float</span>(0.025f * fTmp)));
01026 
01027     fTmp = perMonth * budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].total;
01028     projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].last_month.total
01029         <span class="comment">// 0405</span>
01030         = fTmp + math.get_random_snd(0, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(<span class="keywordtype">float</span>(0.025f * fTmp)));
01031 
01032     <span class="keywordtype">double</span> opReserve = this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>];
01033     projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a40">AC_INTEREST_EARNED_OR_PAID</a>].last_month.total
01034         = (opReserve &gt; 0) ? (opReserve * ( inflation_rate_hist.get_cur() * 12 + short_term_debt_interest ) / 1200.0f)
01035         : (opReserve * ( bank_debt_interest + short_term_debt_interest ) / 1200.0f );
01036 
01037     <span class="comment">// begin trevor 8 Dec 00</span>
01038 
01039     <span class="comment">//  projected_revenue_array[AC_STATE_APPROPRIATION].last_month.total</span>
01040     <span class="comment">//          = perMonth * budget_revenue_array[AC_STATE_APPROPRIATION].total;</span>
01041 
01042     <span class="comment">// end trevor 8 Dec 00</span>
01043 
01044     <span class="comment">//---------//</span>
01045     <span class="comment">// special case</span>
01046     projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].last_month.direct
01047         = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].last_month.total / ( 1 + get_research_overhead_rate() / 100.0);
01048 
01049     projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].last_month.indirect
01050         = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].last_month.total - projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].last_month.direct;
01051 
01052     <span class="comment">//---------//</span>
01053 
01054     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; i++) {
01055         projected_revenue_array[i].year_to_date.direct
01056             += projected_revenue_array[i].last_month.direct;
01057         projected_revenue_array[i].year_to_date.indirect
01058             += projected_revenue_array[i].last_month.indirect;
01059         projected_revenue_array[i].year_to_date.total
01060             += projected_revenue_array[i].last_month.total;
01061     }
01062 
01063     <span class="comment">// ------- EXPENDITURE YTD -------------------------- //</span>
01064 
01065     projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].last_month.faculty
01066         = perMonth * total_faculty_salary;
01067 
01068     fTmp = perMonth * budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].staff;
01069     projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].last_month.staff
01070         = fTmp + math.get_random_snd(0, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(<span class="keywordtype">float</span>(0.005f * fTmp)));
01071 
01072     fTmp = perMonth * budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].other;
01073     projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].last_month.other
01074         = fTmp + math.get_random_snd(0, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(<span class="keywordtype">float</span>(0.01f * fTmp))); {
01075 
01076         <span class="comment">//      projected_revenue_array[AC_SPONSORED_RESEARCH_REVENUE].last_month.direct</span>
01077 
01078         <span class="comment">// 0406 the result of this code section will be over-written or will not be used later</span>
01079 
01080         <span class="keywordtype">double</span> totalFacResearchExpense = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].this_year.direct / 12.0;
01081         <span class="keywordtype">double</span> totalAYFacultySalaryOffsets = totalFacResearchExpense * 0.1;
01082         projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].last_month.faculty
01083             = totalAYFacultySalaryOffsets;
01084 
01085         projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].last_month.other = totalAYFacultySalaryOffsets * 0.05;
01086         projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].last_month.staff
01087             = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].this_year.direct / 12.0
01088             - totalAYFacultySalaryOffsets
01089             - projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].last_month.other;
01090     }
01091 
01092     <span class="keywordflow">for</span> (i=<a class="code" href="Ofinance_8h.html#a104a47">AC_LIBRARIES</a>; i&lt;=<a class="code" href="Ofinance_8h.html#a104a54">AC_ENROLLMENT_MANAGEMENT</a>; i++) {
01093         <span class="keywordtype">float</span> devFactor;
01094 
01095         <span class="keywordflow">if</span> ( i == <a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a> )
01096             devFactor = 0.015f;
01097         <span class="keywordflow">else</span>
01098             devFactor = 0.015f;
01099 
01100         fTmp = perMonth * budget_expense_array[i].staff;
01101         projected_expense_array[i].last_month.staff
01102             = fTmp + math.get_random_snd(0, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(<span class="keywordtype">float</span>(devFactor * fTmp)));
01103 
01104         fTmp = perMonth * budget_expense_array[i].other;
01105         projected_expense_array[i].last_month.other
01106             = fTmp + math.get_random_snd(0, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(<span class="keywordtype">float</span>(devFactor * fTmp)));
01107     }
01108 
01109     projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a55">AC_SERVICE_ON_GENERAL_PLANT_DEBT</a>].last_month.total
01110         = this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a27">AC_GENERAL_PLANT_DEBT</a>] * long_term_debt_interest / 1200;
01111     <span class="comment">// 990419 = perMonth * budget_expense_array[AC_SERVICE_ON_GENERAL_PLANT_DEBT].total;</span>
01112 
01113     projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>].last_month.total
01114         = perMonth * budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>].total;
01115 
01116     <span class="comment">//---------//</span>
01117 
01118     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; i++) {
01119         projected_expense_array[i].year_to_date.faculty
01120             += projected_expense_array[i].last_month.faculty;
01121         projected_expense_array[i].year_to_date.staff
01122             += projected_expense_array[i].last_month.staff;
01123         projected_expense_array[i].year_to_date.other
01124             += projected_expense_array[i].last_month.other;
01125         projected_expense_array[i].year_to_date.total
01126             += projected_expense_array[i].last_month.total;
01127     }
01128 
01129     sys.yield();
01130 
01131     <span class="comment">//---------////---------////---------//</span>
01132     <span class="comment">//---- Step 3, 2 and 4 ----//</span>
01133     update_projected_arrays_monthly_sub();
01134 
01135     sys.yield();
01136 }
01137 
01138 <span class="comment">//------------- End of function Finance::update_projected_arrays_monthly --------//</span>
01139 
01140 <span class="comment">//----------- Begin of function Finance::update_projected_arrays_monthly_sub ------//</span>
01144 <span class="comment">void Finance::update_projected_arrays_monthly_sub() {</span>
01145     <span class="keywordtype">int</span> i;
01146     <span class="keywordtype">double</span> temp;
01147 
01148     <span class="comment">// 1b. Calc this year projected value in projected_revenue_array</span>
01149 
01150     <span class="comment">//float ratioMonthLeft = month_left / 12.0f;</span>
01151 
01152     <span class="keywordflow">if</span>(info.game_day ==1 &amp;&amp; info.game_month ==9) {
01153         <span class="keywordtype">int</span> fhdh=0;
01154     }
01155 
01156     <span class="keywordflow">if</span>(info.game_day==1)                            <span class="comment">// &amp;&amp; info.prerun_year==0)</span>
01157         <span class="keywordtype">int</span> breajef=0;
01158 
01159     <span class="keywordflow">if</span>(info.game_day==1 &amp;&amp; info.game_month == 8) {
01160         last_month_SR_D =0;
01161         last_month_SR_ID =0;
01162 
01163         <span class="keywordflow">if</span>(info.game_year==1) {
01164             last_month_SR_D = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].last_month.direct * 1.1f;
01165             last_month_SR_ID = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].last_month.indirect* 1.1f;
01166         }
01167         <span class="keywordflow">else</span> {
01168             last_month_SR_D = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].last_month.direct;
01169             last_month_SR_ID = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].last_month.indirect;
01170         }
01171     }
01172 
01173     <span class="comment">//--------------- Calculate Revenue ---------------------//</span>
01174 
01175     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; i++) {
01176         <span class="keywordflow">if</span> ( i==<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a> ||
01177              i==<a class="code" href="Ofinance_8h.html#a101a36">AC_GIFTS</a> ) {                               <span class="comment">// Use the amounts directly. //</span>
01178             <span class="keywordflow">continue</span>;
01179         }
01180 
01181         <span class="comment">//---- for Financial Aid, only update it once a year ----//</span>
01182 
01183         <span class="keywordflow">if</span>( i==<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a> &amp;&amp; info.game_month != 9 ) {
01184             <span class="keywordflow">continue</span>;
01185         }
01186 
01187         <span class="comment">//-------------------------------------------------//</span>
01188 
01189         <span class="keywordflow">if</span> ( i != <a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a> ) {
01190 <span class="preprocessor">#if(GAME_VERSION&gt;=200)                      // Kenneth</span>
01191 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( info.prerun_year || i != <a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a> ) {
01192                 projected_revenue_array[i].this_year.total
01193                     = projected_revenue_array[i].year_to_date.total
01194                     + month_left * projected_revenue_array[i].last_month.total;
01195             }
01196 <span class="preprocessor">#else</span>
01197 <span class="preprocessor"></span>            projected_revenue_array[i].this_year.total
01198                 = projected_revenue_array[i].year_to_date.total
01199                 + month_left * projected_revenue_array[i].last_month.total;
01200 <span class="preprocessor">#endif</span>
01201 <span class="preprocessor"></span>        }
01202         <span class="keywordflow">else</span> {                                        <span class="comment">//--- for AC_SPONSORED_RESEARCH_REVENUE ----//</span>
01203 
01204             <span class="comment">//## chea 021199 don't do in 1/9</span>
01205             <span class="comment">// &gt; 1722030 so that it does not run in the first year of the initialization (initialization has 2 years)</span>
01206             <span class="keywordflow">if</span>(info.game_day ==1 &amp;&amp; info.game_month ==9 &amp;&amp; info.game_date &gt; 1722030 ) {
01207                 <span class="comment">//only [3] will do here anyway</span>
01208                 projected_revenue_array[3].last_month.direct = last_month_SR_D;
01209                 projected_revenue_array[3].year_to_date.indirect = last_month_SR_ID;
01210 
01211                 projected_revenue_array[i].this_year.direct
01212                     = projected_revenue_array[i].year_to_date.direct
01213                     + month_left * projected_revenue_array[i].last_month.direct;
01214 
01215                 projected_revenue_array[i].this_year.indirect
01216                     = projected_revenue_array[i].year_to_date.indirect
01217                     + month_left * projected_revenue_array[i].last_month.indirect;
01218 
01219                 projected_revenue_array[i].this_year.total
01220                     = projected_revenue_array[i].this_year.direct + projected_revenue_array[i].this_year.indirect;
01221 
01222                 <span class="comment">/* can't change budget after optimization otherwise the balance will be off.</span>
01223 <span class="comment">                   //---- special case handling: set sponsored research budget to its projected actual ----//</span>
01224 <span class="comment"></span>
01225 <span class="comment">                   budget_revenue_array[i].direct = projected_revenue_array[i].this_year.direct;</span>
01226 <span class="comment">                   budget_revenue_array[i].indirect = projected_revenue_array[i].this_year.indirect;</span>
01227 <span class="comment">                   budget_revenue_array[i].total = projected_revenue_array[i].this_year.total;</span>
01228 <span class="comment">                */</span>
01229             }                                           
01230             <span class="keywordflow">else</span> {
01231                 <span class="comment">//special case AC_SPONSORED_RESEARCH_REVENUE</span>
01232                 projected_revenue_array[i].this_year.direct
01233                     = projected_revenue_array[i].year_to_date.direct
01234                     + month_left * projected_revenue_array[i].last_month.direct;
01235 
01236                 projected_revenue_array[i].this_year.indirect
01237                     = projected_revenue_array[i].year_to_date.indirect
01238                     + month_left * projected_revenue_array[i].last_month.indirect;
01239                 projected_revenue_array[i].this_year.total
01240                     = projected_revenue_array[i].this_year.direct + projected_revenue_array[i].this_year.indirect;
01241             }
01242 
01243         }
01244 
01245     }
01246 
01247     <span class="comment">// 0118: special case</span>
01248 
01249     <span class="keywordflow">if</span> ( month_left == 12 ) {                       <span class="comment">// 0405</span>
01250         projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].this_year.total = tuition_rate * enroll_res.total_student_count / 1000;
01251 
01252         <span class="comment">//--- special fixing to smoothing the difference between previous year and this year tuition in the beginning of the game. The difference is created in the initialization is difficult to fix by itself ---//</span>
01253 
01254 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01255 <span class="preprocessor"></span>        <span class="comment">// seems no longer need fixing</span>
01256 <span class="preprocessor">#else</span>
01257 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( info.prerun_year ) {
01258             revenue_array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].total = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].this_year.total
01259                 * math.get_random_snd( 1.0f, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.005f) );
01260         }
01261 <span class="preprocessor">#endif</span>
01262 <span class="preprocessor"></span>    }
01263 
01264     projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>].this_year.total =
01265         projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].this_year.total + projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].this_year.total;
01266 
01267     <span class="comment">//------------------ Calculate Expenses ---------------------------//</span>
01268 
01269     <span class="comment">//------------------ Calculate Expenses: phase 1 ---------------------------//</span>
01270 
01271     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; i++) {
01272         projected_expense_array[i].this_year.faculty
01273             = projected_expense_array[i].year_to_date.faculty
01274             + month_left * projected_expense_array[i].last_month.faculty;
01275         projected_expense_array[i].this_year.staff
01276             = projected_expense_array[i].year_to_date.staff
01277             + month_left * projected_expense_array[i].last_month.staff;
01278         projected_expense_array[i].this_year.other
01279             = projected_expense_array[i].year_to_date.other
01280             + month_left * projected_expense_array[i].last_month.other;
01281 
01282         <span class="keywordflow">if</span> ( i== <a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a> ) {    <span class="comment">//1228 by WFM notes 1222</span>
01283             <span class="keywordtype">double</span> total = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].this_year.direct;
01284 
01285             projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].this_year.faculty
01286                 = total * research_expense_fac_ratio;
01287 
01288             projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].this_year.staff
01289                 = total * research_expense_staff_ratio;
01290 
01291             projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].this_year.other
01292                 = total * ( 1-research_expense_fac_ratio-research_expense_staff_ratio);
01293         }
01294 
01295         <span class="comment">//----- calculate the total of one row ------//</span>
01296 
01297         projected_expense_array[i].this_year.total = projected_expense_array[i].this_year.faculty +
01298             projected_expense_array[i].this_year.staff + projected_expense_array[i].this_year.other;
01299 
01300         <span class="comment">//---- special case handling: set sponsored research expense budget to its projected actual ----//</span>
01301 
01302         <span class="comment">/* can't change budget after optimization otherwise the balance will be off.</span>
01303 <span class="comment"></span>
01304 <span class="comment">           if( i== AC_SPONSORED_RESEARCH_EXPENSE &amp;&amp; info.game_day ==1 &amp;&amp; info.game_month ==9 &amp;&amp; info.game_date &gt; 1722030 )              // &gt; 1722030 so that it does not run in the first year of the initialization (initialization has 2 years)</span>
01305 <span class="comment">           {</span>
01306 <span class="comment">           budget_expense_array[i].faculty = projected_expense_array[i].this_year.faculty;</span>
01307 <span class="comment">           budget_expense_array[i].staff  = projected_expense_array[i].this_year.staff;</span>
01308 <span class="comment">           budget_expense_array[i].other  = projected_expense_array[i].this_year.other;</span>
01309 <span class="comment">           budget_expense_array[i].total = projected_expense_array[i].this_year.total;</span>
01310 <span class="comment">           }</span>
01311 <span class="comment">        */</span>
01312     }   
01313 
01314     <span class="comment">//0301</span>
01315     i=<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>;
01316     <span class="keywordflow">if</span> ( projected_expense_array[i].this_year.total &lt; 0 ) {
01317         projected_expense_array[i].this_year.total = 0;
01318         projected_expense_array[i].this_year.other = 0;
01319     }
01320 
01321     <span class="comment">// -------------- Step 3. -------------- projected next year</span>
01322     <span class="comment">//</span>
01323     <span class="comment">// this step is switchable with Step 2.</span>
01324 
01325     <span class="comment">// 3b. update projected *next_year* value from budget year 980902</span>
01326 
01327     <span class="keywordflow">for</span> ( i=<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; i++) {
01328         <span class="keywordflow">if</span> ( i != <a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a> ) {
01329             projected_revenue_array[i].next_year.total
01330                 = projected_revenue_array[i].this_year.total<span class="comment">// budget_revenue_array[i].total</span>
01331                 * (1 + inflation_rate / 100 + projected_revenue_array[i].change_budget_year.total / 100);
01332         }
01333         <span class="keywordflow">else</span> {
01334             <span class="comment">//special case AC_SPONSORED_RESEARCH_REVENUE</span>
01335             projected_revenue_array[i].next_year.direct
01336                 <span class="comment">// budget_revenue_array[i].direct</span>
01337                 = projected_revenue_array[i].this_year.direct
01338                 * (1 + inflation_rate / 100 + projected_revenue_array[i].change_budget_year.direct / 100);
01339             projected_revenue_array[i].next_year.indirect
01340                 <span class="comment">// budget_revenue_array[i].indirect</span>
01341                 = projected_revenue_array[i].this_year.indirect
01342                 * (1 + inflation_rate / 100 + projected_revenue_array[i].change_budget_year.indirect / 100);
01343             projected_revenue_array[i].next_year.total
01344                 = projected_revenue_array[i].next_year.direct + projected_revenue_array[i].next_year.indirect;
01345         }
01346     }
01347 
01348     <span class="comment">//special case</span>
01349     <span class="comment">//0222</span>
01350 
01351     <span class="keywordflow">for</span> ( i=<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>; i&lt;=<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>; i++) {
01352         projected_revenue_array[i].next_year.total
01353             = (1 + inflation_rate ) * projected_revenue_array[i].this_year.total;
01354     }
01355 
01356     <span class="comment">//special case  ## chea 170899</span>
01357     projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>].next_year.total
01358         = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].next_year.total
01359         + projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].next_year.total;
01360 
01361     <span class="comment">//## chea 241199 make the 3rd row the same 12.2.2 d)</span>
01362     finance.projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].this_year.total = finance.budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].total;
01363     finance.projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].this_year.percent = finance.budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].percent;
01364 
01365     <span class="comment">//------------------ Calculate Expenses: phase 2 ---------------------------//</span>
01366 
01367     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; i++) {
01368         projected_expense_array[i].next_year.faculty
01369             = projected_expense_array[i].this_year.faculty<span class="comment">// budget_expense_array[i].faculty</span>
01370             * (1 + inflation_rate / 100 + projected_expense_array[i].change_budget_year.faculty / 100);
01371         projected_expense_array[i].next_year.staff
01372             = projected_expense_array[i].this_year.staff<span class="comment">// budget_expense_array[i].staff</span>
01373             * (1 + inflation_rate / 100 + projected_expense_array[i].change_budget_year.staff / 100);
01374         projected_expense_array[i].next_year.other
01375             = projected_expense_array[i].this_year.other<span class="comment">// budget_expense_array[i].other</span>
01376             * (1 + inflation_rate / 100 + projected_expense_array[i].change_budget_year.other/ 100);
01377 
01378         <span class="keywordflow">if</span> ( i== <a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a> ) {    <span class="comment">//1228</span>
01379             <span class="comment">// 0119</span>
01380 
01381             <span class="keywordtype">double</span> totalAYFacultySalaryOffsets = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].next_year.direct;
01382             projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].next_year.faculty
01383                 = research_expense_fac_ratio * totalAYFacultySalaryOffsets;
01384             projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].next_year.staff
01385                 = research_expense_staff_ratio * totalAYFacultySalaryOffsets;
01386             projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].next_year.other
01387                 = totalAYFacultySalaryOffsets * ( 1-research_expense_fac_ratio-research_expense_staff_ratio);
01388         }
01389 
01390         <span class="comment">//----- calculate the total of one row ------//</span>
01391 
01392         projected_expense_array[i].next_year.total = projected_expense_array[i].next_year.faculty +
01393             projected_expense_array[i].next_year.staff + projected_expense_array[i].next_year.other;
01394     }
01395 
01396     i = <a class="code" href="Ofinance_8h.html#a101a38">AC_INTERCOLLEGIATE_ATHLETICS</a>;
01397     projected_revenue_array[i].this_year.total += chance_event.football_game_bonus + chance_event.basketball_game_bonus;
01398 
01399     <span class="comment">//-------------- Step 2. change_last_year: last_year VS projected this_year ----------//</span>
01400 
01401     <a class="code" href="structRevenueItemChange.html">RevenueItemChange</a>* projRev;
01402     <a class="code" href="structExpenseItemChange.html">ExpenseItemChange</a>* projExp;
01403 
01404     <span class="comment">//## BUGHERE</span>
01405     <span class="comment">//## chea 170899 calc_change have bug it can't calc. change with two - no.</span>
01406     <span class="comment">//   Since this function is called by other cpp. So may have bug</span>
01407     <span class="comment">//</span>
01408 
01409     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; i++) {
01410         <span class="comment">//----- calculate change ------//</span>
01411 
01412         temp = revenue_array[i].direct;
01413         projRev = &amp;projected_revenue_array[i];
01414         projRev-&gt;<a class="code" href="structRevenueItemChange.html#m0">change_last_year</a>.<a class="code" href="structRevenueItem.html#m0">direct</a>
01415             = calc_change( projRev-&gt;<a class="code" href="structRevenueItemChange.html#m2">this_year</a>.<a class="code" href="structRevenueItem.html#m0">direct</a>, temp );
01416 
01417         temp = revenue_array[i].indirect;
01418         projRev = &amp;projected_revenue_array[i];
01419         projRev-&gt;<a class="code" href="structRevenueItemChange.html#m0">change_last_year</a>.<a class="code" href="structRevenueItem.html#m1">indirect</a>
01420             = calc_change( projRev-&gt;<a class="code" href="structRevenueItemChange.html#m2">this_year</a>.<a class="code" href="structRevenueItem.html#m1">indirect</a>, temp );
01421 
01422         temp = revenue_array[i].total;
01423         projRev = &amp;projected_revenue_array[i];
01424 
01425         projRev-&gt;<a class="code" href="structRevenueItemChange.html#m0">change_last_year</a>.<a class="code" href="structRevenueItem.html#m2">total</a> = calc_change( projRev-&gt;<a class="code" href="structRevenueItemChange.html#m2">this_year</a>.<a class="code" href="structRevenueItem.html#m2">total</a>, temp );
01426     }
01427 
01428     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; i++) {
01429         <span class="comment">//----- calculate change ------//</span>
01430 
01431         temp = expense_array[i].faculty;
01432         projExp = &amp;projected_expense_array[i];
01433         projExp-&gt;<a class="code" href="structExpenseItemChange.html#m0">change_last_year</a>.<a class="code" href="structExpenseItem.html#m0">faculty</a>
01434             = calc_change( projExp-&gt;<a class="code" href="structExpenseItemChange.html#m2">this_year</a>.<a class="code" href="structExpenseItem.html#m0">faculty</a>, temp );
01435 
01436         temp = expense_array[i].staff;
01437         projExp = &amp;projected_expense_array[i];
01438         projExp-&gt;<a class="code" href="structExpenseItemChange.html#m0">change_last_year</a>.<a class="code" href="structExpenseItem.html#m1">staff</a>
01439             = calc_change( projExp-&gt;<a class="code" href="structExpenseItemChange.html#m2">this_year</a>.<a class="code" href="structExpenseItem.html#m1">staff</a>, temp );
01440 
01441         temp = expense_array[i].other;
01442         projExp = &amp;projected_expense_array[i];
01443         projExp-&gt;<a class="code" href="structExpenseItemChange.html#m0">change_last_year</a>.<a class="code" href="structExpenseItem.html#m2">other</a>
01444             = calc_change( projExp-&gt;<a class="code" href="structExpenseItemChange.html#m2">this_year</a>.<a class="code" href="structExpenseItem.html#m2">other</a>, temp );
01445 
01446         temp = expense_array[i].total;
01447         projExp = &amp;projected_expense_array[i];
01448         projExp-&gt;<a class="code" href="structExpenseItemChange.html#m0">change_last_year</a>.<a class="code" href="structExpenseItem.html#m3">total</a>
01449             = calc_change( projExp-&gt;<a class="code" href="structExpenseItemChange.html#m2">this_year</a>.<a class="code" href="structExpenseItem.html#m3">total</a>, temp );
01450     }
01451 
01452     <span class="comment">//</span>
01453     <span class="comment">// -------------- Step 4. -------------- change_next_year</span>
01454     <span class="comment">//</span>
01455 
01456     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; i++) {
01457         projRev = &amp;projected_revenue_array[i];
01458         temp = projRev-&gt;<a class="code" href="structRevenueItemChange.html#m2">this_year</a>.<a class="code" href="structRevenueItem.html#m0">direct</a>;
01459         projRev-&gt;<a class="code" href="structRevenueItemChange.html#m1">change_next_year</a>.<a class="code" href="structRevenueItem.html#m0">direct</a>
01460             = calc_change( projRev-&gt;<a class="code" href="structRevenueItemChange.html#m3">next_year</a>.<a class="code" href="structRevenueItem.html#m0">direct</a>, temp );
01461 
01462         projRev = &amp;projected_revenue_array[i];
01463         temp = projRev-&gt;<a class="code" href="structRevenueItemChange.html#m2">this_year</a>.<a class="code" href="structRevenueItem.html#m1">indirect</a>;
01464         projRev-&gt;<a class="code" href="structRevenueItemChange.html#m1">change_next_year</a>.<a class="code" href="structRevenueItem.html#m1">indirect</a>
01465             = calc_change( projRev-&gt;<a class="code" href="structRevenueItemChange.html#m3">next_year</a>.<a class="code" href="structRevenueItem.html#m1">indirect</a>, temp );
01466 
01467         projRev = &amp;projected_revenue_array[i];
01468         temp = projRev-&gt;<a class="code" href="structRevenueItemChange.html#m2">this_year</a>.<a class="code" href="structRevenueItem.html#m2">total</a>;
01469         projRev-&gt;<a class="code" href="structRevenueItemChange.html#m1">change_next_year</a>.<a class="code" href="structRevenueItem.html#m2">total</a>
01470             = calc_change( projRev-&gt;<a class="code" href="structRevenueItemChange.html#m3">next_year</a>.<a class="code" href="structRevenueItem.html#m2">total</a>, temp );
01471 
01472     }
01473 
01474     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; i++) {
01475         projExp = &amp;projected_expense_array[i];
01476         temp = projExp-&gt;<a class="code" href="structExpenseItemChange.html#m2">this_year</a>.<a class="code" href="structExpenseItem.html#m0">faculty</a>;
01477         projExp-&gt;<a class="code" href="structExpenseItemChange.html#m1">change_next_year</a>.<a class="code" href="structExpenseItem.html#m0">faculty</a>
01478             = calc_change( projExp-&gt;<a class="code" href="structExpenseItemChange.html#m3">next_year</a>.<a class="code" href="structExpenseItem.html#m0">faculty</a>, temp );
01479 
01480         projExp = &amp;projected_expense_array[i];
01481         temp = projExp-&gt;<a class="code" href="structExpenseItemChange.html#m2">this_year</a>.<a class="code" href="structExpenseItem.html#m1">staff</a>;
01482         projExp-&gt;<a class="code" href="structExpenseItemChange.html#m1">change_next_year</a>.<a class="code" href="structExpenseItem.html#m1">staff</a>
01483             = calc_change( projExp-&gt;<a class="code" href="structExpenseItemChange.html#m3">next_year</a>.<a class="code" href="structExpenseItem.html#m1">staff</a>, temp );
01484 
01485         projExp = &amp;projected_expense_array[i];
01486         temp = projExp-&gt;<a class="code" href="structExpenseItemChange.html#m2">this_year</a>.<a class="code" href="structExpenseItem.html#m2">other</a>;
01487         projExp-&gt;<a class="code" href="structExpenseItemChange.html#m1">change_next_year</a>.<a class="code" href="structExpenseItem.html#m2">other</a>
01488             = calc_change( projExp-&gt;<a class="code" href="structExpenseItemChange.html#m3">next_year</a>.<a class="code" href="structExpenseItem.html#m2">other</a>, temp );
01489 
01490         projExp = &amp;projected_expense_array[i];
01491         temp = projExp-&gt;<a class="code" href="structExpenseItemChange.html#m2">this_year</a>.<a class="code" href="structExpenseItem.html#m3">total</a>;
01492         projExp-&gt;<a class="code" href="structExpenseItemChange.html#m1">change_next_year</a>.<a class="code" href="structExpenseItem.html#m3">total</a>
01493             = calc_change( projExp-&gt;<a class="code" href="structExpenseItemChange.html#m3">next_year</a>.<a class="code" href="structExpenseItem.html#m3">total</a>, temp );
01494     }
01495 
01496     <span class="comment">//---- Last Step for update monthly ----//</span>
01497     calc_projected_total_n_percent();
01498     sys.yield();
01499 
01500     <span class="comment">//------ update budget change percent and individual budget item's percent of budget total as in special case handling, sponsored research budgets were set to projected sponsored research revenue and expenses</span>
01501 
01502     budget_calc_total();                            <span class="comment">// re-calculate budget total</span>
01503     budget_calc_percent();
01504     budget_calc_change();
01505 }
01506 
01507 <span class="comment">//------------- End of function Finance::update_projected_arrays_monthly_sub ------//</span>
01508 
01509 <span class="comment">//---------- Begin of function Finance::calc_projected_total_n_percent -----------//</span>
<a name="l01514"></a><a class="code" href="classFinance.html#a28">01514</a> <span class="comment">void Finance::calc_projected_total_n_percent(int reCalc) {</span>
01515     <span class="comment">//-----------------//</span>
01516     <span class="comment">//--- total         ----//</span>
01517     <span class="comment">//-----------------//</span>
01518 
01519     <span class="comment">//------- calculate the total revenue ---------//</span>
01520 
01521     memset( &amp;projected_total_revenue, 0, <span class="keyword">sizeof</span>(projected_total_revenue) );
01522 
01523     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a> ; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a> ; i++ ) {
01524         <span class="comment">//------ calculate totals of all rows -------//</span>
01525 
01526         projected_total_revenue.this_year.direct   += projected_revenue_array[i].this_year.direct;
01527         projected_total_revenue.this_year.indirect += projected_revenue_array[i].this_year.indirect;
01528         projected_total_revenue.this_year.total    += projected_revenue_array[i].this_year.total;
01529 
01530         projected_total_revenue.next_year.direct   += projected_revenue_array[i].next_year.direct;
01531         projected_total_revenue.next_year.indirect += projected_revenue_array[i].next_year.indirect;
01532         projected_total_revenue.next_year.total    += projected_revenue_array[i].next_year.total; {
01533         }
01534 
01535 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01536 <span class="preprocessor"></span>        <span class="comment">// BUG FIX if divided by zero</span>
01537         projected_total_revenue.change_next_year.direct
01538             = math.safe_divide((projected_total_revenue.next_year.direct - projected_total_revenue.this_year.direct )*100, projected_total_revenue.this_year.direct );
01539         projected_total_revenue.change_next_year.total
01540             = math.safe_divide((projected_total_revenue.next_year.indirect - projected_total_revenue.this_year.indirect )*100, projected_total_revenue.this_year.indirect );
01541         projected_total_revenue.change_next_year.total
01542             = math.safe_divide((projected_total_revenue.next_year.total - projected_total_revenue.this_year.total )*100, projected_total_revenue.this_year.total );
01543 
01544         projected_total_revenue.change_last_year.direct
01545             = math.safe_divide((projected_total_revenue.this_year.direct - total_revenue.direct )*100, total_revenue.direct);
01546         projected_total_revenue.change_last_year.indirect
01547             = math.safe_divide((projected_total_revenue.this_year.indirect - total_revenue.indirect )*100, total_revenue.indirect);
01548         projected_total_revenue.change_last_year.total
01549             = math.safe_divide((projected_total_revenue.this_year.total - total_revenue.total )*100, total_revenue.total);
01550 
01551         projected_total_revenue.change_budget_year.direct
01552             = calc_change(budget_total_revenue.direct, total_revenue.direct);
01553         projected_total_revenue.change_budget_year.indirect
01554             = calc_change(budget_total_revenue.indirect, total_revenue.indirect);
01555         projected_total_revenue.change_budget_year.total
01556             = calc_change(budget_total_revenue.total, total_revenue.total);
01557 <span class="preprocessor">#else</span>
01558 <span class="preprocessor"></span>        projected_total_revenue.change_next_year.direct
01559             = (projected_total_revenue.next_year.direct - projected_total_revenue.this_year.direct )*100 / projected_total_revenue.this_year.direct;
01560         projected_total_revenue.change_next_year.total
01561             = (projected_total_revenue.next_year.indirect - projected_total_revenue.this_year.indirect )*100 / projected_total_revenue.this_year.indirect;
01562         projected_total_revenue.change_next_year.total
01563             = (projected_total_revenue.next_year.total - projected_total_revenue.this_year.total )*100 / projected_total_revenue.this_year.total;
01564 
01565         projected_total_revenue.change_last_year.direct
01566             = (projected_total_revenue.this_year.direct - total_revenue.direct )*100 / total_revenue.direct;
01567         projected_total_revenue.change_last_year.indirect
01568             = (projected_total_revenue.this_year.indirect - total_revenue.indirect )*100 / total_revenue.indirect;
01569         projected_total_revenue.change_last_year.total
01570             = (projected_total_revenue.this_year.total - total_revenue.total )*100 / total_revenue.total;
01571 
01572         projected_total_revenue.change_budget_year.direct
01573             = calc_change(budget_total_revenue.direct, total_revenue.direct);
01574         projected_total_revenue.change_budget_year.indirect
01575             = calc_change(budget_total_revenue.indirect, total_revenue.indirect);
01576         projected_total_revenue.change_budget_year.total
01577             = calc_change(budget_total_revenue.total, total_revenue.total);
01578 <span class="preprocessor">#endif</span>
01579 <span class="preprocessor"></span>    }
01580 
01581     <span class="comment">//------- calculate the total expense ---------//</span>
01582 
01583     memset( &amp;projected_total_expense, 0, <span class="keyword">sizeof</span>(projected_total_expense) );
01584 
01585     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a102a42">OPERATING_EXPENSE_ITEM_COUNT</a> ; i++ ) {
01586         <span class="comment">//------ calculate totals of all rows -------//</span>
01587 
01588         projected_total_expense.this_year.faculty += projected_expense_array[i].this_year.faculty;
01589         projected_total_expense.this_year.staff   += projected_expense_array[i].this_year.staff;
01590         projected_total_expense.this_year.other   += projected_expense_array[i].this_year.other;
01591         projected_total_expense.this_year.total   += projected_expense_array[i].this_year.total;
01592 
01593         projected_total_expense.next_year.faculty += projected_expense_array[i].next_year.faculty;
01594         projected_total_expense.next_year.staff   += projected_expense_array[i].next_year.staff;
01595         projected_total_expense.next_year.other   += projected_expense_array[i].next_year.other;
01596         projected_total_expense.next_year.total   += projected_expense_array[i].next_year.total; {
01597         }
01598 
01599         <span class="comment">// update struct projected_total_expense.change_xxxx_year</span>
01600 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01601 <span class="preprocessor"></span>        <span class="comment">// BUG FIX if divided by zero</span>
01602         projected_total_expense.change_next_year.faculty
01603             = math.safe_divide((projected_total_expense.next_year.faculty - projected_total_expense.this_year.faculty )*100, projected_total_expense.this_year.faculty);
01604         projected_total_expense.change_next_year.staff
01605             = math.safe_divide((projected_total_expense.next_year.staff - projected_total_expense.this_year.staff )*100, projected_total_expense.this_year.staff);
01606         projected_total_expense.change_next_year.other
01607             = math.safe_divide((projected_total_expense.next_year.other - projected_total_expense.this_year.other )*100, projected_total_expense.this_year.other);
01608         projected_total_expense.change_next_year.total
01609             = math.safe_divide((projected_total_expense.next_year.total - projected_total_expense.this_year.total )*100, projected_total_expense.this_year.total);
01610 
01611         projected_total_expense.change_last_year.faculty
01612             = math.safe_divide((projected_total_expense.this_year.faculty - total_operating_expense.faculty )*100, total_operating_expense.faculty);
01613         projected_total_expense.change_last_year.staff
01614             = math.safe_divide((projected_total_expense.this_year.staff - total_operating_expense.staff )*100, total_operating_expense.staff);
01615         projected_total_expense.change_last_year.other
01616             = math.safe_divide((projected_total_expense.this_year.other - total_operating_expense.other )*100, total_operating_expense.other);
01617         projected_total_expense.change_last_year.total
01618             = math.safe_divide((projected_total_expense.this_year.total - total_operating_expense.total )*100, total_operating_expense.total);
01619 <span class="preprocessor">#else</span>
01620 <span class="preprocessor"></span>        projected_total_expense.change_next_year.faculty
01621             = (projected_total_expense.next_year.faculty - projected_total_expense.this_year.faculty )*100 / projected_total_expense.this_year.faculty;
01622         projected_total_expense.change_next_year.staff
01623             = (projected_total_expense.next_year.staff - projected_total_expense.this_year.staff )*100 / projected_total_expense.this_year.staff;
01624         projected_total_expense.change_next_year.other
01625             = (projected_total_expense.next_year.other - projected_total_expense.this_year.other )*100 / projected_total_expense.this_year.other;
01626         projected_total_expense.change_next_year.total
01627             = (projected_total_expense.next_year.total - projected_total_expense.this_year.total )*100 / projected_total_expense.this_year.total;
01628 
01629         projected_total_expense.change_last_year.faculty
01630             = (projected_total_expense.this_year.faculty - total_operating_expense.faculty )*100 / total_operating_expense.faculty;
01631         projected_total_expense.change_last_year.staff
01632             = (projected_total_expense.this_year.staff - total_operating_expense.staff )*100 / total_operating_expense.staff;
01633         projected_total_expense.change_last_year.other
01634             = (projected_total_expense.this_year.other - total_operating_expense.other )*100 / total_operating_expense.other;
01635         projected_total_expense.change_last_year.total
01636             = (projected_total_expense.this_year.total - total_operating_expense.total )*100 / total_operating_expense.total;
01637 <span class="preprocessor">#endif</span>
01638 <span class="preprocessor"></span>
01639         projected_total_expense.change_budget_year.faculty
01640             = calc_change(budget_total_operating_expense.faculty, total_operating_expense.faculty);
01641         projected_total_expense.change_budget_year.staff
01642             = calc_change(budget_total_operating_expense.staff, total_operating_expense.staff);
01643         projected_total_expense.change_budget_year.other
01644             = calc_change(budget_total_operating_expense.other, total_operating_expense.other);
01645         projected_total_expense.change_budget_year.total
01646             = calc_change(budget_total_operating_expense.total, total_operating_expense.total);
01647     }
01648 
01649     <span class="comment">//------- calculate the total operating expense ---------//</span>
01650     memcpy( &amp;projected_total_operating_expense, &amp;projected_total_expense, <span class="keyword">sizeof</span>(projected_total_expense) );
01651 
01652     <span class="keywordflow">for</span>( i=<a class="code" href="Ofinance_8h.html#a102a42">OPERATING_EXPENSE_ITEM_COUNT</a> ; i&lt;<a class="code" href="Ofinance_8h.html#a102a43">TOTAL_EXPENSE_ITEM_COUNT</a> ; i++ ) {
01653 <span class="preprocessor">#define MONEY_MAX 99999999999.0</span>
01654 <span class="preprocessor"></span>
01655         <a class="code" href="ALL_8H.html#a0">err_when</a>(projected_expense_array[10].this_year.total &gt; MONEY_MAX);
01656         <a class="code" href="ALL_8H.html#a0">err_when</a>(projected_expense_array[10].next_year.other &gt; MONEY_MAX);
01657         <a class="code" href="ALL_8H.html#a0">err_when</a>(projected_expense_array[10].next_year.total &gt; MONEY_MAX);
01658 
01659         <a class="code" href="ALL_8H.html#a0">err_when</a>(projected_expense_array[10].change_last_year.total &gt; MONEY_MAX);
01660         <a class="code" href="ALL_8H.html#a0">err_when</a>(projected_expense_array[10].change_next_year.other &gt; MONEY_MAX);
01661         <a class="code" href="ALL_8H.html#a0">err_when</a>(projected_expense_array[10].change_next_year.total &gt; MONEY_MAX);
01662 
01663         <span class="comment">//------ calculate totals of all rows -------//</span>
01664 
01665         projected_total_expense.this_year.faculty += projected_expense_array[i].this_year.faculty;
01666         projected_total_expense.this_year.staff   += projected_expense_array[i].this_year.staff;
01667         projected_total_expense.this_year.other   += projected_expense_array[i].this_year.other;
01668         projected_total_expense.this_year.total   += projected_expense_array[i].this_year.total;
01669 
01670         projected_total_expense.next_year.faculty += projected_expense_array[i].next_year.faculty;
01671         projected_total_expense.next_year.staff   += projected_expense_array[i].next_year.staff;
01672         projected_total_expense.next_year.other   += projected_expense_array[i].next_year.other;
01673         projected_total_expense.next_year.total   += projected_expense_array[i].next_year.total; {
01674         }
01675 
01676         <span class="comment">// update struct projected_total_expense.change_xxxx_year</span>
01677 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01678 <span class="preprocessor"></span>        projected_total_expense.change_next_year.faculty
01679             = math.safe_divide((projected_total_expense.next_year.faculty - projected_total_expense.this_year.faculty )*100, projected_total_expense.this_year.faculty);
01680         projected_total_expense.change_next_year.staff
01681             = math.safe_divide((projected_total_expense.next_year.staff - projected_total_expense.this_year.staff )*100, projected_total_expense.this_year.staff);
01682         projected_total_expense.change_next_year.other
01683             = math.safe_divide((projected_total_expense.next_year.other - projected_total_expense.this_year.other )*100, projected_total_expense.this_year.other);
01684         projected_total_expense.change_next_year.total
01685             = math.safe_divide((projected_total_expense.next_year.total - projected_total_expense.this_year.total )*100, projected_total_expense.this_year.total);
01686 
01687         projected_total_expense.change_last_year.faculty
01688             = math.safe_divide((projected_total_expense.this_year.faculty - total_expense.faculty )*100, total_expense.faculty);
01689         projected_total_expense.change_last_year.staff
01690             = math.safe_divide((projected_total_expense.this_year.staff - total_expense.staff )*100, total_expense.staff);
01691         projected_total_expense.change_last_year.other
01692             = math.safe_divide((projected_total_expense.this_year.other - total_expense.other )*100, total_expense.other);
01693         projected_total_expense.change_last_year.total
01694             = math.safe_divide((projected_total_expense.this_year.total - total_expense.total )*100, total_expense.total);
01695 <span class="preprocessor">#else</span>
01696 <span class="preprocessor"></span>        projected_total_expense.change_next_year.faculty
01697             = (projected_total_expense.next_year.faculty - projected_total_expense.this_year.faculty )*100 / projected_total_expense.this_year.faculty;
01698         projected_total_expense.change_next_year.staff
01699             = (projected_total_expense.next_year.staff - projected_total_expense.this_year.staff )*100 / projected_total_expense.this_year.staff;
01700         projected_total_expense.change_next_year.other
01701             = (projected_total_expense.next_year.other - projected_total_expense.this_year.other )*100 / projected_total_expense.this_year.other;
01702         projected_total_expense.change_next_year.total
01703             = (projected_total_expense.next_year.total - projected_total_expense.this_year.total )*100 / projected_total_expense.this_year.total;
01704 
01705         projected_total_expense.change_last_year.faculty
01706             = (projected_total_expense.this_year.faculty - total_expense.faculty )*100 / total_expense.faculty;
01707         projected_total_expense.change_last_year.staff
01708             = (projected_total_expense.this_year.staff - total_expense.staff )*100 / total_expense.staff;
01709         projected_total_expense.change_last_year.other
01710             = (projected_total_expense.this_year.other - total_expense.other )*100 / total_expense.other;
01711         projected_total_expense.change_last_year.total
01712             = (projected_total_expense.this_year.total - total_expense.total )*100 / total_expense.total;
01713 <span class="preprocessor">#endif</span>
01714 <span class="preprocessor"></span>
01715         projected_total_expense.change_budget_year.faculty
01716             = calc_change(budget_total_expense.faculty, total_expense.faculty);
01717         projected_total_expense.change_budget_year.staff
01718             = calc_change(budget_total_expense.staff, total_expense.staff);
01719         projected_total_expense.change_budget_year.other
01720             = calc_change(budget_total_expense.other, total_expense.other);
01721         projected_total_expense.change_budget_year.total
01722             = calc_change(budget_total_expense.total, total_expense.total);
01723     }
01724 
01725     sys.yield();
01726 
01727     <span class="comment">//-----------------//</span>
01728     <span class="comment">//--- percent       ----//</span>
01729     <span class="comment">//-----------------//</span>
01730 
01731     <span class="comment">//------- calculate the total revenue ---------//</span>
01732 
01733     <span class="keywordflow">for</span>( i=<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a> ; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a> ; i++ ) {
01734 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01735 <span class="preprocessor"></span>        <span class="comment">// BUG FIXED if divided by zero</span>
01736         projected_revenue_array[i].this_year.percent = 100.0f * math.safe_divide(projected_revenue_array[i].this_year.total,
01737                                                                                  projected_total_revenue.this_year.total);
01738         projected_revenue_array[i].next_year.percent = 100.0f * math.safe_divide(projected_revenue_array[i].next_year.total,
01739                                                                                  projected_total_revenue.next_year.total);
01740 <span class="preprocessor">#else</span>
01741 <span class="preprocessor"></span>        projected_revenue_array[i].this_year.percent = 100.0f * projected_revenue_array[i].this_year.total /
01742             projected_total_revenue.this_year.total;
01743         projected_revenue_array[i].next_year.percent = 100.0f * projected_revenue_array[i].next_year.total /
01744             projected_total_revenue.next_year.total;
01745 <span class="preprocessor">#endif</span>
01746 <span class="preprocessor"></span>    }
01747 
01748     <span class="comment">//------- calculate the total expense ---------//</span>
01749     projected_total_operating_expense.this_year.percent = 0;
01750     projected_total_operating_expense.next_year.percent = 0;
01751 
01752     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a> ; i++ ) {
01753 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01754 <span class="preprocessor"></span>        projected_expense_array[i].this_year.percent = 100.0f * math.safe_divide(projected_expense_array[i].this_year.total,
01755                                                                                  projected_total_expense.this_year.total);
01756         projected_expense_array[i].next_year.percent = 100.0f * math.safe_divide(projected_expense_array[i].next_year.total,
01757                                                                                  projected_total_expense.next_year.total);
01758 <span class="preprocessor">#else</span>
01759 <span class="preprocessor"></span>        projected_expense_array[i].this_year.percent = 100.0f * projected_expense_array[i].this_year.total /
01760             projected_total_expense.this_year.total;
01761         projected_expense_array[i].next_year.percent = 100.0f * projected_expense_array[i].next_year.total /
01762             projected_total_expense.next_year.total;
01763 <span class="preprocessor">#endif</span>
01764 <span class="preprocessor"></span>
01765         <span class="keywordflow">if</span> ( i &lt; <a class="code" href="Ofinance_8h.html#a102a42">OPERATING_EXPENSE_ITEM_COUNT</a> ) {
01766             projected_total_operating_expense.this_year.percent += projected_expense_array[i].this_year.percent;
01767             projected_total_operating_expense.next_year.percent += projected_expense_array[i].next_year.percent;
01768         }
01769     }
01770 
01771     projected_total_revenue.this_year.percent = 100;
01772     projected_total_expense.this_year.percent = 100;
01773     projected_total_revenue.next_year.percent = 100;
01774     projected_total_expense.next_year.percent = 100;
01775 
01776     sys.yield();
01777 
01778     <span class="comment">//----- balance sheet -----//</span>
01779 
01780     this_year.surplus_deficit = projected_total_revenue.this_year.total - projected_total_expense.this_year.total;
01781 
01782     <span class="keywordtype">double</span> cons2 = 1.0 + inflation_rate/100.0 + investment_office.expected_real_annual_return_rate/100.0;
01783     <span class="keywordtype">double</span> cons1 = 1.0 + inflation_rate/100.0 + short_term_debt_interest/100.0;
01784 
01785 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01786 <span class="preprocessor"></span>    <span class="comment">// 1022</span>
01787     <span class="keywordtype">double</span> bank_deposit_rate_per_month = finance.inflation_rate + .005;
01788 
01789     <span class="keywordflow">if</span> ( !reCalc )
01790         this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>]   <span class="comment">//=D50*(1+C72+C73)+F263</span>
01791             = this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>]*(1+bank_deposit_rate_per_month)
01792             + chance_event.operating_reserve_modifier;
01793 <span class="preprocessor">#else</span>
01794 <span class="preprocessor"></span>    this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>]     <span class="comment">//=D50*(1+C72+C73)+F263</span>
01795         = last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>] + this_year.surplus_deficit
01796         + chance_event.operating_reserve_modifier;
01797 <span class="preprocessor">#endif</span>
01798 <span class="preprocessor"></span>
01799     <span class="comment">//-------- Chance Event --------//</span>
01800     <span class="comment">/*</span>
01801 <span class="comment">      if( !reCalc )</span>
01802 <span class="comment">      {</span>
01803 <span class="comment">      if(chance_event.scandalous_fund_use &gt; 0)</span>
01804 <span class="comment">      {</span>
01805 <span class="comment">      this_year.asset_array[AC_OPERATING_RESERVE] -= chance_event.scandalous_fund_use;</span>
01806 <span class="comment">      chance_event.scandalous_fund_use = 0;</span>
01807 <span class="comment">      }</span>
01808 <span class="comment">      }</span>
01809 <span class="comment">    */</span>
01810     <span class="comment">//------ recalc Endowment ----------//</span>
01811 
01812 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01813 <span class="preprocessor"></span>
01814     <span class="keywordtype">double</span> bank_interest_rate = finance.inflation_rate + .01;
01815 
01816     this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>] =
01817         this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]*(1+bank_interest_rate)-
01818         (float)(revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].total*(1-endowment_quasi_ratio)/12);
01819 
01820     this_year.asset_array[AC_QUASI] =
01821         this_year.asset_array[AC_QUASI]*(1+bank_interest_rate)-
01822         (float)(revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].total*endowment_quasi_ratio/12);;
01823 
01824     <span class="comment">/*</span>
01825 <span class="comment">      this_year.asset_array[AC_ENDOWMENT]       //=D51*(1+C72+G72)-F241         // = D51-F241 by fred 1023</span>
01826 <span class="comment">      = last_year.asset_array[AC_ENDOWMENT]</span>
01827 <span class="comment">      + investment_office.endowment_change_year_to_date // 990527</span>
01828 <span class="comment">      + development_office.this_year.endowment;                         // 990608</span>
01829 <span class="comment"></span>
01830 <span class="comment">      //--- scenario special handling ------//</span>
01831 <span class="comment"></span>
01832 <span class="comment">      if( player_school.scenario_id == SCN_INVEST_ACADEMIC &amp;&amp;</span>
01833 <span class="comment">      info.prerun_year==0 &amp;&amp; !(info.game_year &gt;= 2 &amp;&amp; info.game_month &gt;= 9) )           // only do this for the first game year, in the second year, last_year.asset_array[] will be updated correctly already.</span>
01834 <span class="comment">      {</span>
01835 <span class="comment">      this_year.asset_array[AC_ENDOWMENT]       += player_school.scenario_endowment_increase;</span>
01836 <span class="comment">      }</span>
01837 <span class="comment"></span>
01838 <span class="comment">      if ( this_year.asset_array[AC_QUASI] != 0 &amp;&amp; info.prerun_year != 1 )</span>
01839 <span class="comment">      this_year.asset_array[AC_QUASI] = (last_year.asset_array[AC_QUASI]+transfer_quasi) * this_year.asset_array[AC_ENDOWMENT] / last_year.asset_array[AC_ENDOWMENT];</span>
01840 <span class="comment">      else</span>
01841 <span class="comment">      this_year.asset_array[AC_QUASI] = last_year.asset_array[AC_QUASI] * this_year.asset_array[AC_ENDOWMENT] / last_year.asset_array[AC_ENDOWMENT];</span>
01842 <span class="comment"></span>
01843 <span class="comment">      float ratio = this_year.asset_array[AC_QUASI] / (this_year.asset_array[AC_QUASI]+this_year.asset_array[AC_ENDOWMENT]);</span>
01844 <span class="comment"></span>
01845 <span class="comment">      this_year.asset_array[AC_ENDOWMENT] = last_year.asset_array[AC_ENDOWMENT] + (investment_office.endowment_change_year_to_date + development_office.this_year.endowment</span>
01846 <span class="comment">      - projected_revenue_array[AC_ENDOWMENT_SPENDING].this_year.total)*(1-ratio);</span>
01847 <span class="comment"></span>
01848 <span class="comment">      this_year.asset_array[AC_QUASI] = last_year.asset_array[AC_QUASI] + (investment_office.endowment_change_year_to_date + development_office.this_year.endowment</span>
01849 <span class="comment">      - projected_revenue_array[AC_ENDOWMENT_SPENDING].this_year.total)*ratio;</span>
01850 <span class="comment">    */</span>
01851 <span class="preprocessor">#else</span>
01852 <span class="preprocessor"></span>    this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]             <span class="comment">//=D51*(1+C72+G72)-F241             // = D51-F241 by fred 1023</span>
01853         = last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>] - projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].this_year.total
01854         <span class="comment">// 990527</span>
01855         + investment_office.endowment_change_year_to_date
01856         + development_office.this_year.endowment;     <span class="comment">// 990608</span>
01857 
01858     <span class="comment">//--- scenario special handling ------//</span>
01859 
01860     <span class="keywordflow">if</span>( player_school.scenario_id == <a class="code" href="Opschool_8h.html#a63a23">SCN_INVEST_ACADEMIC</a> &amp;&amp;
01861         <span class="comment">// only do this for the first game year, in the second year, last_year.asset_array[] will be updated correctly already.</span>
01862         info.prerun_year==0 &amp;&amp; !(info.game_year &gt;= 2 &amp;&amp; info.game_month &gt;= 9) ) {
01863         this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>] += player_school.scenario_endowment_increase;
01864     }
01865 <span class="preprocessor">#endif</span>
01866 <span class="preprocessor"></span>
01867     <span class="comment">//------- calculate asset totals --------//</span>
01868 
01869     calc_asset_total();
01870 
01871     <span class="comment">//------------- next_year ---------------//</span>
01872 
01873     memcpy(&amp;next_year, &amp;this_year, <span class="keyword">sizeof</span>(<a class="code" href="structYearReport.html">YearReport</a>));
01874     next_year.surplus_deficit = projected_total_revenue.next_year.total - projected_total_expense.next_year.total;
01875 }
01876 
01877 <span class="comment">//----------- End of function Finance::calc_projected_total_n_percent ------------//</span>
01878 
01879 <span class="comment">//---------- Begin of function Finance::calc_asset_total -----------//</span>
<a name="l01881"></a><a class="code" href="classFinance.html#a36">01881</a> <span class="comment">void Finance::calc_asset_total() {</span>
01882     <span class="comment">// calc asset_total</span>
01883     finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a25">AC_ASSET_TOTAL</a>] = 0 ;
01884 
01885     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a96a19">ASSET_ITEM_COUNT</a>-1 ; i++ ) {
01886         <span class="comment">//err_when(finance.this_year.asset_array[i] &lt; 0);</span>
01887         finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a25">AC_ASSET_TOTAL</a>] += finance.this_year.asset_array[i];
01888     }
01889 
01890     finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a29">AC_LIABILITY_TOTAL</a>] = 0;
01891 
01892     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a98a26">LIABILITY_ITEM_COUNT</a>-1 ; i++ ) {
01893         finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a29">AC_LIABILITY_TOTAL</a>] += finance.this_year.liability_array[i];
01894     }
01895 }
01896 
01897 <span class="comment">//----------- End of function Finance::calc_asset_total ------------//</span>
01898 
01899 <span class="comment">//----------- Begin of function Finance::get_policy_var ------------//</span>
<a name="l01901"></a><a class="code" href="classFinance.html#a26">01901</a> <span class="comment">FinancePolicy* Finance::get_policy_var(bool isRevenue, char index) {</span>
01902     <a class="code" href="structFinancePolicy.html">FinancePolicy</a>* policy;
01903     <span class="keywordflow">if</span> ( isRevenue ) {
01904         <span class="comment">// translate from AC_ to PL_</span>
01905         <span class="keywordflow">if</span> ( index == <a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a> )
01906             index = <a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>;
01907         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (index == <a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a> )
01908             index = <a class="code" href="Ofinance_8h.html#a108a67">PL_ENDOWMENT_SPENDING_RATE</a>;
01909         <span class="keywordflow">else</span>
01910             <a class="code" href="ALL_8H.html#a1">err_here</a>();
01911 
01912         policy =  &amp;(revenue_policy_array[index]);
01913 
01914     }
01915     <span class="comment">//BUGHER?, should(?) handle more case in expense_policy_array?</span>
01916     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( index == <a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a> ) {
01917         index = <a class="code" href="Ofinance_8h.html#a110a73">PL_REAL_TRANSFER_TO_PLANT_GROWTH</a>;
01918         policy = &amp;(expense_policy_array[index]);
01919     }
01920     <span class="keywordflow">else</span> {
01921         <span class="comment">// translate from AC_ to PL_</span>
01922         <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="Ofinance_8h.html#a112a78">PL_LIBRARIES</a> != <a class="code" href="Ofinance_8h.html#a104a47">AC_LIBRARIES</a>);
01923         <a class="code" href="ALL_8H.html#a0">err_when</a>(index &lt; 0 || index &gt; <a class="code" href="Ofinance_8h.html#a112a85">PL_ENROLLMENT_MANAGEMENT</a>);
01924 
01925         policy = &amp;(cost_rise_policy_array[index]);
01926     }
01927 
01928     <span class="keywordflow">return</span> policy;
01929 }
01930 
01931 <span class="comment">//---------- End of function Finance::get_policy_var -----------//</span>
01932 
01933 <span class="comment">//---------- Begin of function Finance::change_budget -----------//</span>
<a name="l01944"></a><a class="code" href="classFinance.html#a30">01944</a> <span class="comment">void Finance::change_budget(char changeType, bool isRevenue, char index, float percentChange, char showMsg) {</span>
01945     <span class="comment">// designed for three types of financial decisions:</span>
01946     <span class="comment">// Implemented, Announced and Proposed</span>
01947 
01948     <a class="code" href="ALL_8H.html#a0">err_when</a>( percentChange &gt; 100 &amp;&amp; percentChange &lt; -100 );
01949     <a class="code" href="ALL_8H.html#a0">err_when</a>( index &lt; 0 );
01950     <a class="code" href="classString.html">String</a> str1,str2;
01951 
01952     <a class="code" href="structFinancePolicy.html">FinancePolicy</a> *policy;
01953     <span class="keywordtype">double</span> target,lower,upper, lastTarget;
01954 
01955     policy = get_policy_var(isRevenue, index);
01956 
01957     <span class="comment">//--- if percentChange is 0, do nothing but shows the current target value ---//</span>
01958 
01959     <span class="keywordtype">int</span> mappedChangeType;
01960 
01961     <span class="keywordflow">if</span>( changeType==<a class="code" href="Ofinance_8h.html#a113a86">CONSIDER_NEXT_YEAR</a> )            <span class="comment">// map change type to P_??? scale.</span>
01962         mappedChangeType = <a class="code" href="Ofinanc2_8h.html#a38a6">P_CONSIDER</a>;
01963     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( changeType==<a class="code" href="Ofinance_8h.html#a113a87">ANNOUNCE_NEXT_YEAR</a> )
01964         mappedChangeType = <a class="code" href="Ofinanc2_8h.html#a38a7">P_PROMISE</a>;
01965     <span class="keywordflow">else</span>
01966         mappedChangeType = <a class="code" href="Ofinanc2_8h.html#a38a8">P_IMPLEMENT</a>;
01967 
01968     <span class="comment">// and no change in policy type</span>
01969     <span class="keywordflow">if</span>( percentChange==0 &amp;&amp; policy-&gt;<a class="code" href="structFinancePolicy.html#m6">applied_flag</a> == mappedChangeType ) {
01970         <span class="keywordflow">if</span>( policy-&gt;<a class="code" href="structFinancePolicy.html#m6">applied_flag</a> == <a class="code" href="Ofinanc2_8h.html#a38a6">P_CONSIDER</a> )
01971             str1=<span class="stringliteral">"Current target value is "</span>;
01972         <span class="keywordflow">else</span>
01973             str1=<span class="stringliteral">"The target value is fixed at "</span>;
01974 
01975         str1+=m.format(policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a>,23);
01976         str1+=<span class="stringliteral">"."</span>;
01977 
01978         str1+=<span class="stringliteral">"\r\nIt should be lie between "</span>;
01979         str1+=m.format((<span class="keywordtype">float</span>)policy-&gt;<a class="code" href="structFinancePolicy.html#m7">lower_limit</a>,23);
01980         str1+=<span class="stringliteral">" and "</span>;
01981         str1+=m.format((<span class="keywordtype">float</span>)policy-&gt;<a class="code" href="structFinancePolicy.html#m8">upper_limit</a>,23);
01982         str1+=<span class="stringliteral">"."</span>;
01983 
01984         <span class="keywordflow">if</span>( policy-&gt;<a class="code" href="structFinancePolicy.html#m6">applied_flag</a> == <a class="code" href="Ofinanc2_8h.html#a38a6">P_CONSIDER</a> ) {
01985             str1+=<span class="stringliteral">"\r\n'Consider' is selected or preference '3' has been pressed \r\n in Finance Budget Plan report."</span>;
01986         }
01987         <span class="keywordflow">else</span> <span class="keywordflow">if</span>( policy-&gt;<a class="code" href="structFinancePolicy.html#m6">applied_flag</a> == <a class="code" href="Ofinanc2_8h.html#a38a7">P_PROMISE</a> ) {
01988             str1+=<span class="stringliteral">"\r\n'Promise' is selected or preference 'R' has been pressed \r\n in Finance Budget Plan report."</span>;
01989         }
01990         <span class="keywordflow">else</span> <span class="keywordflow">if</span>( policy-&gt;<a class="code" href="structFinancePolicy.html#m6">applied_flag</a> == <a class="code" href="Ofinanc2_8h.html#a38a8">P_IMPLEMENT</a> ) {
01991             str1+=<span class="stringliteral">"\r\n'Implement now' is selected or preference 'R' has been pressed \r\n in Finance Budget Plan report."</span>;
01992             str1+=<span class="stringliteral">"\r\nThe operation is implemented with this target value now."</span>;
01993         }
01994 
01995         <span class="keywordflow">if</span>( showMsg )
01996             box.msg(str1);
01997         <span class="keywordflow">return</span>;
01998     }
01999 
02000     <span class="comment">//--- the user is not allowed to change the action type or value once the user has applied Promise or Implement ---//</span>
02001 
02002     <span class="keywordflow">if</span>( policy-&gt;<a class="code" href="structFinancePolicy.html#m6">applied_flag</a> == <a class="code" href="Ofinanc2_8h.html#a38a7">P_PROMISE</a> ) {
02003         <span class="keywordflow">if</span>( showMsg )
02004             box.msg( <span class="stringliteral">"Sorry, you have already made a promise for this policy and cannot withdraw it."</span> );
02005         <span class="keywordflow">return</span>;
02006     }
02007 
02008     <span class="keywordflow">if</span>( policy-&gt;<a class="code" href="structFinancePolicy.html#m6">applied_flag</a> == <a class="code" href="Ofinanc2_8h.html#a38a8">P_IMPLEMENT</a> ) {
02009         <span class="keywordflow">if</span>( showMsg )
02010             box.msg( <span class="stringliteral">"Sorry, you have already implemented this policy and cannot change it."</span> );
02011         <span class="keywordflow">return</span>;
02012     }
02013 
02014     <span class="comment">//----- save values for restore next year ------//</span>
02015 
02016     <span class="comment">//----- if first time consider or promise this year, save last target value ------//</span>
02017 
02018     <span class="keywordflow">if</span> ( policy-&gt;<a class="code" href="structFinancePolicy.html#m6">applied_flag</a> == <a class="code" href="Ofinanc2_8h.html#a38a5">P_NONE</a> ) {         <span class="comment">// if it has set it before, keep last_target_value and do not change it.</span>
02019         policy-&gt;<a class="code" href="structFinancePolicy.html#m9">last_target_value</a> = policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a>;
02020         policy-&gt;<a class="code" href="structFinancePolicy.html#m10">last_upper_bound</a> = policy-&gt;<a class="code" href="structFinancePolicy.html#m2">upper_bound</a>;
02021         policy-&gt;<a class="code" href="structFinancePolicy.html#m11">last_lower_bound</a> = policy-&gt;<a class="code" href="structFinancePolicy.html#m1">lower_bound</a>;
02022         policy-&gt;<a class="code" href="structFinancePolicy.html#m12">last_import_weight</a> = policy-&gt;<a class="code" href="structFinancePolicy.html#m3">import_weight</a>;
02023         policy-&gt;<a class="code" href="structFinancePolicy.html#m13">last_required_flag</a> = policy-&gt;<a class="code" href="structFinancePolicy.html#m4">required_flag</a>;
02024     }
02025 
02026     <span class="comment">//-- But the user can change from Consider to Promise or Implement Now ---//</span>
02027 
02028     <span class="keywordflow">switch</span>(changeType) {
02029     <span class="keywordflow">case</span> <a class="code" href="Ofinance_8h.html#a113a86">CONSIDER_NEXT_YEAR</a>:
02030     <span class="keywordflow">case</span> <a class="code" href="Ofinance_8h.html#a113a87">ANNOUNCE_NEXT_YEAR</a>:
02031 
02032         lastTarget = policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a>;
02033         target = policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a> + percentChange;
02034 
02035         <span class="comment">//--- adjust the lower &amp; upper bounds if the target exceed the current bounds ---//</span>
02036 
02037         lower = max(policy-&gt;<a class="code" href="structFinancePolicy.html#m7">lower_limit</a>, min(target, policy-&gt;<a class="code" href="structFinancePolicy.html#m1">lower_bound</a>));
02038         upper = min(policy-&gt;<a class="code" href="structFinancePolicy.html#m8">upper_limit</a>, max(target, policy-&gt;<a class="code" href="structFinancePolicy.html#m2">upper_bound</a>));
02039 
02040         policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a> = min( max(target, lower), upper);
02041         policy-&gt;<a class="code" href="structFinancePolicy.html#m1">lower_bound</a> = lower;
02042         policy-&gt;<a class="code" href="structFinancePolicy.html#m2">upper_bound</a> = upper;
02043         policy-&gt;<a class="code" href="structFinancePolicy.html#m3">import_weight</a> = <a class="code" href="Ofinanc2_8h.html#a2">OPT_HIGH_WEIGHT</a>;
02044 
02045         str1=<span class="stringliteral">"Target value changes from "</span>;
02046         str1+=m.format((<span class="keywordtype">float</span>)lastTarget,23);
02047         str1+=<span class="stringliteral">" to "</span>;
02048         str1+=m.format((<span class="keywordtype">float</span>)policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a>,23);
02049         str1+=<span class="stringliteral">"."</span>;
02050 
02051         str1+=<span class="stringliteral">"\r\nIt should be lie between "</span>;
02052         str1+=m.format((<span class="keywordtype">float</span>)policy-&gt;<a class="code" href="structFinancePolicy.html#m7">lower_limit</a>,23);
02053         str1+=<span class="stringliteral">" and "</span>;
02054         str1+=m.format((<span class="keywordtype">float</span>)policy-&gt;<a class="code" href="structFinancePolicy.html#m8">upper_limit</a>,23);
02055         str1+=<span class="stringliteral">"."</span>;
02056 
02057         <span class="keywordflow">if</span>( changeType==<a class="code" href="Ofinance_8h.html#a113a86">CONSIDER_NEXT_YEAR</a> ) {
02058             str1+=<span class="stringliteral">"\r\n'Consider' is selected or preference '3' has been pressed \r\n in Finance Budget Plan report."</span>;
02059         }
02060         <span class="keywordflow">else</span> {
02061             str1+=<span class="stringliteral">"\r\n'Promise' is selected or preference 'R' has been pressed \r\n in Finance Budget Plan report."</span>;
02062         }
02063 
02064         <span class="keywordflow">if</span>( showMsg )
02065             box.msg(str1);
02066 
02067         <span class="comment">//---------- penalty: check if promise or commitment applied before -------------//</span>
02068         <span class="comment">// add small un-implemented penalty for CONSIDER and big penalty for ANNOUNCE    //</span>
02069 
02070         <span class="keywordflow">if</span> ( policy-&gt;<a class="code" href="structFinancePolicy.html#m6">applied_flag</a> &gt; <a class="code" href="Ofinanc2_8h.html#a38a5">P_NONE</a> &amp;&amp; get_sign(policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a> - lastTarget) == policy-&gt;<a class="code" href="structFinancePolicy.html#m14">penalty_direction</a> ) {
02071             <span class="keywordtype">double</span> value = pow( <span class="keywordtype">double</span>(policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a> - lastTarget)/(policy-&gt;<a class="code" href="structFinancePolicy.html#m8">upper_limit</a> - policy-&gt;<a class="code" href="structFinancePolicy.html#m7">lower_limit</a>),2);
02072 
02073             value = math.dual_response_func(0, 0.451f, 1.000f, -0.358f, -0.361f, 0.819f, 0.213f, <span class="keywordtype">float</span>(value));
02074 
02075             policy-&gt;<a class="code" href="structFinancePolicy.html#m17">penalty_multiplier1</a> = 1 - policy-&gt;<a class="code" href="structFinancePolicy.html#m15">max_penalty1</a> * value;
02076             policy-&gt;<a class="code" href="structFinancePolicy.html#m18">penalty_multiplier2</a> = 1 - policy-&gt;<a class="code" href="structFinancePolicy.html#m16">max_penalty2</a> * value;
02077 
02078             <span class="comment">// adjustment</span>
02079 
02080             <span class="keywordflow">if</span> ( changeType == <a class="code" href="Ofinance_8h.html#a113a86">CONSIDER_NEXT_YEAR</a> ) {
02081                 policy-&gt;<a class="code" href="structFinancePolicy.html#m17">penalty_multiplier1</a> *= 0.333333f;
02082                 policy-&gt;<a class="code" href="structFinancePolicy.html#m18">penalty_multiplier2</a> *= 0.333333f;
02083             }
02084 
02085             <a class="code" href="ALL_8H.html#a0">err_when</a>(value &lt; 0 || value &gt; 1);
02086         }
02087 
02088         <span class="comment">//--------- set the effect now ---------//</span>
02089 
02090         <span class="keywordflow">if</span> ( changeType == <a class="code" href="Ofinance_8h.html#a113a86">CONSIDER_NEXT_YEAR</a> )
02091             policy-&gt;<a class="code" href="structFinancePolicy.html#m6">applied_flag</a> = <a class="code" href="Ofinanc2_8h.html#a38a6">P_CONSIDER</a>;
02092         <span class="keywordflow">else</span> {
02093             policy-&gt;<a class="code" href="structFinancePolicy.html#m4">required_flag</a> = <span class="keyword">true</span>;
02094             policy-&gt;<a class="code" href="structFinancePolicy.html#m6">applied_flag</a> = <a class="code" href="Ofinanc2_8h.html#a38a7">P_PROMISE</a>;
02095         }
02096 
02097         <span class="keywordflow">break</span>;
02098 
02099         <span class="comment">//-------- Click Implement Now button ----------//</span>
02100 
02101     <span class="keywordflow">case</span> <a class="code" href="Ofinance_8h.html#a113a88">IMPLEMENT_NOW</a>:
02102 
02103         <span class="comment">//----- if the user has set Consider previously, restore target_value before calling set_constraint_policy() so that last_target_value will not be overwritten twice</span>
02104 
02105         lastTarget = policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a>;          <span class="comment">// the last target regardless of what the one before the previous value is</span>
02106 
02107         <span class="comment">//---- trancate out-of-limit values  -----------//</span>
02108 
02109         policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a> += percentChange;
02110         policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a> = min( max(policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a>, policy-&gt;<a class="code" href="structFinancePolicy.html#m7">lower_limit</a>), policy-&gt;<a class="code" href="structFinancePolicy.html#m8">upper_limit</a>);
02111 
02112         policy-&gt;<a class="code" href="structFinancePolicy.html#a2">set_constraint_policy</a>(0);           <span class="comment">// don't save last as we already did in this function</span>
02113 
02114         <span class="comment">//---------- display message --------------//</span>
02115 
02116         str1=<span class="stringliteral">"Target value changes from "</span>;
02117         str1+=m.format((<span class="keywordtype">float</span>)lastTarget,23);
02118         str1+=<span class="stringliteral">" to "</span>;
02119         str1+=m.format((<span class="keywordtype">float</span>)policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a>,23);
02120         str1+=<span class="stringliteral">" ."</span>;
02121 
02122         str1+=<span class="stringliteral">"\r\nIt should be lie between "</span>;
02123         str1+=m.format((<span class="keywordtype">float</span>)policy-&gt;<a class="code" href="structFinancePolicy.html#m7">lower_limit</a>,23);
02124         str1+=<span class="stringliteral">" and "</span>;
02125         str1+=m.format((<span class="keywordtype">float</span>)policy-&gt;<a class="code" href="structFinancePolicy.html#m8">upper_limit</a>,23);
02126         str1+=<span class="stringliteral">"."</span>;
02127 
02128         str1+=<span class="stringliteral">"\r\n'Implement now' is selected or preference 'R' has been pressed \r\n in Finance Budget Plan report."</span>;
02129         str1+=<span class="stringliteral">"\r\nThe operation is implemented with this target value now."</span>;
02130 
02131         <span class="keywordflow">if</span>( showMsg )
02132             box.msg(str1);
02133 
02134         <span class="comment">//------- apply the effect now -------//</span>
02135 
02136         policy-&gt;<a class="code" href="structFinancePolicy.html#m4">required_flag</a> = <span class="keyword">true</span>;
02137         policy-&gt;<a class="code" href="structFinancePolicy.html#m6">applied_flag</a> = <a class="code" href="Ofinanc2_8h.html#a38a8">P_IMPLEMENT</a>;
02138 
02139         policy-&gt;<a class="code" href="structFinancePolicy.html#m3">import_weight</a> = <a class="code" href="Ofinanc2_8h.html#a2">OPT_HIGH_WEIGHT</a>;
02140 
02141         <a class="code" href="ALL_8H.html#a0">err_when</a>(policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a> &lt; policy-&gt;<a class="code" href="structFinancePolicy.html#m1">lower_bound</a>);
02142         <span class="keywordflow">break</span>;
02143 
02144         <span class="comment">//------------------//</span>
02145 
02146     <span class="keywordflow">default</span>:
02147         <a class="code" href="ALL_8H.html#a1">err_here</a>();
02148         <span class="keywordflow">break</span>;
02149     }
02150 
02151     optimization.refresh_optimization_screen = 1;
02152 }
02153 
02154 <span class="comment">//----------- End of function Finance::change_budget ------------//</span>
02155 
02156 <span class="comment">//## chea begin 240699 for(WFM comments;3/19/99 15.3)</span>
02157 <span class="comment">//---------- Begin of function Finance::update_history -----------//</span>
02163 <span class="comment">void Finance::update_history(char update_flag) {</span>
02164 
02165     <span class="keywordtype">double</span> operating_sub_surplus = last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>] + finance.this_year.surplus_deficit;
02166     <span class="keywordtype">double</span> sponsored_research =                     <span class="comment">//projected_revenue_array[AC_SPONSORED_RESEARCH_REVENUE].last_month.total + projected_revenue_array[AC_SPONSORED_RESEARCH_EXPENSE].last_month.total;</span>
02167         <span class="comment">//finance.revenue_array[AC_SPONSORED_RESEARCH_REVENUE].total;</span>
02168         projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].this_year.total;
02169 
02170     <span class="keywordtype">double</span> net_tuition = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>].this_year.total;
02171 
02172     <span class="keywordtype">double</span> bank_deposit_rate_per_month ;
02173 
02174     <span class="keywordtype">float</span> test1 = 0.00f;
02175     <span class="keywordtype">float</span> test2 = 0.00f;
02176     <span class="keywordtype">float</span> result = 0.00f;
02177     <span class="keywordtype">int</span> i;
02178 
02179     <span class="keywordflow">switch</span> (update_flag) {
02180     <span class="keywordflow">case</span> UPDATE_MONTH:
02181         <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(surplus_deficit_history, HISTORY_MONTH_COUNT);
02182         surplus_deficit_history[THIS_MONTH] = finance.this_year.surplus_deficit;
02183         <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(operating_sub_surplus_history, HISTORY_MONTH_COUNT);
02184         operating_sub_surplus_history[THIS_MONTH] = operating_sub_surplus;
02185         <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(sponsored_research_history, HISTORY_MONTH_COUNT);
02186         sponsored_research_history[THIS_MONTH] = sponsored_research;
02187         <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(net_tuition_history, HISTORY_MONTH_COUNT);
02188         net_tuition_history[THIS_MONTH] = net_tuition;
02189 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
02190 <span class="preprocessor"></span>        <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(short_term_debt_interest_history, HISTORY_MONTH_COUNT);
02191         short_term_debt_interest_history[THIS_MONTH] = short_term_debt_interest;
02192 
02193         <span class="comment">// 1022</span>
02194         bank_deposit_rate_per_month = (finance.inflation_rate + .005);
02195         this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>] += bank_deposit_rate_per_month * this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>];
02196 
02197         <span class="comment">// copy value from this_year to month_start</span>
02198         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; ++i )
02199             projected_revenue_array[i].month_start = projected_revenue_array[i].this_year;
02200         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; ++i )
02201             projected_expense_array[i].month_start = projected_expense_array[i].this_year;
02202 
02203         projected_net_distance_learning_expense.month_start = projected_net_distance_learning_expense.this_year;
02204         projected_total_revenue.month_start = projected_total_revenue.this_year;
02205         projected_total_operating_expense.month_start = projected_total_operating_expense.this_year;
02206         projected_total_expense.month_start = projected_total_expense.this_year;
02207 <span class="preprocessor">#endif</span>
02208 <span class="preprocessor"></span>
02209         <span class="keywordflow">break</span>;
02210 
02211     <span class="keywordflow">case</span> UPDATE_TRIMESTER:
02212 
02213         <span class="keywordflow">break</span>;
02214 
02215     <span class="keywordflow">case</span> UPDATE_YEAR:
02216         test1 = (float) enroll_res.total_matrics[<a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>];
02217         test2 = (float) enroll_res.total_applications[<a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>];
02218         result =  test1/test2;
02219 
02220         <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(sl1_sel_history, HISTORY_YEAR_COUNT);
02221         sl1_sel_history[THIS_YEAR] = result;
02222 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
02223 <span class="preprocessor"></span>        <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(faculty_salary_increase_history, HISTORY_YEAR_COUNT);
02224         faculty_salary_increase_history[THIS_YEAR] = expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a70">PL_FACULTY_SALARY_INCREASES</a>].result_value;
02225 
02226         <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(tuition_increase_history, HISTORY_YEAR_COUNT);
02227         tuition_increase_history[THIS_YEAR] = revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>].result_value;
02228 
02229         <a class="code" href="Gamedef_8h.html#a14">shift_history</a>( long_term_debt_interest_history, HISTORY_YEAR_COUNT );
02230         long_term_debt_interest_history[THIS_YEAR] = long_term_debt_interest;
02231 
02232         this_year.surplus_deficit = projected_total_revenue.this_year.total - projected_total_expense.this_year.total;
02233 
02234         this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>] += this_year.surplus_deficit;
02235 
02236         this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>] += development_office.this_year.endowment;
02237 <span class="preprocessor">#endif</span>
02238 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
02239 
02240     <span class="keywordflow">case</span> UPDATE_ALL:
02241         update_history(UPDATE_MONTH);
02242         update_history(UPDATE_TRIMESTER);
02243         update_history(UPDATE_YEAR);
02244         <span class="keywordflow">break</span>;
02245 
02246     <span class="keywordflow">default</span>:
02247         <a class="code" href="ALL_8H.html#a1">err_here</a>();
02248         <span class="keywordflow">break</span>;
02249 
02250     }
02251 }
02252 
02253 <span class="comment">//---------- End of function Finance::update_history -----------//</span>
02254 <span class="comment">//## chea begin 240699</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:35 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
