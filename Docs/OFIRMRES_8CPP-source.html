<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OFIRMRES.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>OFIRMRES.CPP</h1><a href="OFIRMRES_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OFIRMRES.CPP</span>
00002 <span class="comment">//Description : FirmRes Class Definition</span>
00003 
00004 <span class="preprocessor">#include &lt;All.h&gt;</span>
00005 <span class="preprocessor">#include &lt;<a class="code" href="COLCODE_8H.html">COLCODE.H</a>&gt;</span>
00006 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00007 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00008 <span class="preprocessor">#include &lt;OSTR.h&gt;</span>
00009 <span class="preprocessor">#include &lt;OMISC.h&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="OCOLTBL_8H.html">OCOLTBL.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;<a class="code" href="OWORLD_8H.html">OWORLD.H</a>&gt;</span>
00012 <span class="preprocessor">#include &lt;<a class="code" href="OGAMESET_8H.html">OGAMESET.H</a>&gt;</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="OFIELD_8H.html">OFIELD.H</a>&gt;</span>
00014 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>
00015 <span class="preprocessor">#include &lt;OFIRMRES.h&gt;</span>
00016 
00017 <span class="comment">//----------- Define constants -------------//</span>
00018 
<a name="l00019"></a><a class="code" href="OFIRMRES_8CPP.html#a0">00019</a> <span class="preprocessor">#define FIRM_DB     "FIRM"</span>
00020 <span class="preprocessor"></span>
00021 <span class="comment">//----------- Begin of function FirmRes Constructor -----//</span>
<a name="l00023"></a><a class="code" href="classFirmRes.html#a0">00023</a> <span class="comment">FirmRes::FirmRes() {</span>
00024     init_flag=0;
00025 }
00026 
00027 <span class="comment">//------------- End of function FirmRes Constructor -----//</span>
00028 
00029 <span class="comment">//----------- Begin of function FirmRes Destructor ------//</span>
00031 <span class="comment"></span>
<a name="l00032"></a><a class="code" href="classFirmRes.html#a1">00032</a> <a class="code" href="classFirmRes.html#a1">FirmRes::~FirmRes</a>() {
00033     <a class="code" href="classFirmRes.html#a3">deinit</a>();
00034 }
00035 
00036 <span class="comment">//------------- End of function FirmRes Destructor ------//</span>
00037 
00038 <span class="comment">//----------- Begin of function FirmRes::init --------//</span>
<a name="l00040"></a><a class="code" href="classFirmRes.html#a2">00040</a> <span class="comment">void FirmRes::init() {</span>
00041     <span class="keywordflow">if</span> ( init_flag )
00042         <span class="keywordflow">return</span>;
00043 
00044     <span class="comment">//------------------------------------//</span>
00045 
00046     <a class="code" href="classString.html">String</a> str;
00047 
00048     str = <span class="stringliteral">"F_"</span>;
00049 
00050     <span class="keywordflow">switch</span>( player_school.school_type ) {
00051     <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a81a42">LIBERAL_ARTS_SCHOOL</a>:
00052         str += <span class="stringliteral">"L"</span>;
00053         <span class="keywordflow">break</span>;
00054 
00055     <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a81a44">COMPREHENSIVE_SCHOOL</a>:
00056         str += <span class="stringliteral">"C"</span>;
00057         <span class="keywordflow">break</span>;
00058 
00059         <span class="comment">//## fred 121</span>
00060     <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a81a41">PRIVATE_SCHOOL</a>:
00061         str += <span class="stringliteral">"VR"</span>;                                <span class="comment">// private</span>
00062         <span class="keywordflow">break</span>;
00063 
00064     <span class="keywordflow">case</span> <a class="code" href="Gamedef_8h.html#a81a43">PUBLIC_SCHOOL</a>:
00065         str += <span class="stringliteral">"PR"</span>;                                <span class="comment">// public</span>
00066         <span class="keywordflow">break</span>;
00067         <span class="comment">//## fred 1211</span>
00068     }
00069 
00070     <span class="comment">//----- read info from FIRM.DBF and F_?.DBF ------//</span>
00071 
00072     load_info();
00073     load_bmp_info(str);
00074 
00075     <span class="comment">//---- open bitmap resource of different resolutions ----//</span>
00076 
00077     load_res( <a class="code" href="Gamedef_8h.html#a72a19">ZOOM_SMALL</a> , str, <span class="stringliteral">"S"</span> );
00078     load_res( <a class="code" href="Gamedef_8h.html#a72a20">ZOOM_MEDIUM</a>, str, <span class="stringliteral">"M"</span> );
00079     load_res( <a class="code" href="Gamedef_8h.html#a72a21">ZOOM_LARGE</a> , str, <span class="stringliteral">"L"</span> );
00080 
00081     <span class="comment">//----------------------------------------//</span>
00082 
00083     init_flag=1;
00084 }
00085 
00086 <span class="comment">//------------- End of function FirmRes::init --------//</span>
00087 
00088 <span class="comment">//----------- Begin of function FirmRes::deinit --------//</span>
<a name="l00090"></a><a class="code" href="classFirmRes.html#a3">00090</a> <span class="comment">void FirmRes::deinit() {</span>
00091     <span class="keywordflow">if</span>( init_flag ) {
00092         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;<a class="code" href="Gamedef_8h.html#a9">MAX_ZOOM_LEVEL</a> ; i++ )
00093             res_bitmap[i].deinit();
00094 
00095         <a class="code" href="ALL_8H.html#a8">mem_del</a>(info_array);
00096 
00097         init_flag=0;
00098     }
00099 }
00100 
00101 <span class="comment">//------------- End of function FirmRes::deinit --------//</span>
00102 
00103 <span class="comment">//----------- Begin of function FirmRes::load_info -------//</span>
00107 <span class="comment">void FirmRes::load_info() {</span>
00108     <a class="code" href="structFirmRec.html">FirmRec</a>  *firmRec;
00109     <a class="code" href="structFirmInfo.html">FirmInfo</a> *firmInfo;
00110     <span class="keywordtype">int</span>      i;
00111     <a class="code" href="classDatabase.html">Database</a> *dbFirm = game_set.open_db(<a class="code" href="OFIRMRES_8CPP.html#a0">FIRM_DB</a>);
00112 
00113     firm_count = (short) dbFirm-&gt;<a class="code" href="classDatabase.html#a7">rec_count</a>();
00114     info_array = (<a class="code" href="structFirmInfo.html">FirmInfo</a>*) <a class="code" href="ALL_8H.html#a5">mem_add</a>( <span class="keyword">sizeof</span>(<a class="code" href="structFirmInfo.html">FirmInfo</a>)*firm_count );
00115 
00116     <span class="comment">//------ read in firm bitmap info array -------//</span>
00117 
00118     memset( info_array, 0, <span class="keyword">sizeof</span>(<a class="code" href="structFirmInfo.html">FirmInfo</a>) * firm_count );
00119 
00120     <span class="keywordflow">for</span>( i=0 ; i&lt;firm_count ; i++ ) {
00121         firmRec  = (<a class="code" href="structFirmRec.html">FirmRec</a>*) dbFirm-&gt;<a class="code" href="classDatabase.html#a4">read</a>(i+1);
00122         firmInfo = info_array+i;
00123 
00124         m.rtrim_fld( firmInfo-&gt;<a class="code" href="structFirmInfo.html#m0">code</a>, firmRec-&gt;<a class="code" href="structFirmRec.html#m0">code</a>, firmRec-&gt;<a class="code" href="structFirmRec.html#s2s0">CODE_LEN</a> );
00125         m.rtrim_fld( firmInfo-&gt;<a class="code" href="structFirmInfo.html#m1">name</a>, firmRec-&gt;<a class="code" href="structFirmRec.html#m1">name</a>, firmRec-&gt;<a class="code" href="structFirmRec.html#s2s1">NAME_LEN</a> );
00126 
00127         firmInfo-&gt;<a class="code" href="structFirmInfo.html#m2">field_id</a> = field_res.look_up_code( firmRec-&gt;<a class="code" href="structFirmRec.html#m2">field</a> );
00128     }
00129 }
00130 
00131 <span class="comment">//----------- End of function FirmRes::load_info -------//</span>
00132 
00133 <span class="comment">//----------- Begin of function FirmRes::load_bmp_info -------//</span>
00135 <span class="comment">void FirmRes::load_bmp_info(char* fileName) {</span>
00136     <span class="comment">// e.g. "F_L" instead of "F_L_?"</span>
00137     <a class="code" href="classDatabase.html">Database</a> *dbFirmBitmap = game_set.open_db(fileName);
00138 
00139     <span class="comment">//---- read location width and height info from FBITMAP -----//</span>
00140 
00141     <a class="code" href="structFirmBitmapRec.html">FirmBitmapRec</a>  *firmBitmapRec;
00142     <a class="code" href="structFirmInfo.html">FirmInfo</a> *firmInfo;
00143     <span class="keywordtype">int</span>      i;
00144 
00145     <span class="keywordflow">for</span>( i=0 ; i&lt;firm_count ; i++ ) {
00146         firmBitmapRec  = (<a class="code" href="structFirmBitmapRec.html">FirmBitmapRec</a>*) dbFirmBitmap-&gt;<a class="code" href="classDatabase.html#a4">read</a>(i+1);
00147         firmInfo = info_array+i;
00148 
00149         firmInfo-&gt;<a class="code" href="structFirmInfo.html#m3">loc_width</a>  = m.atoi( firmBitmapRec-&gt;<a class="code" href="structFirmBitmapRec.html#m1">loc_width</a>, firmBitmapRec-&gt;<a class="code" href="structFirmBitmapRec.html#s3s1">LOC_WIDTH_LEN</a> );
00150         firmInfo-&gt;<a class="code" href="structFirmInfo.html#m4">loc_height</a> = m.atoi( firmBitmapRec-&gt;<a class="code" href="structFirmBitmapRec.html#m2">loc_height</a>, firmBitmapRec-&gt;<a class="code" href="structFirmBitmapRec.html#s3s2">LOC_HEIGHT_LEN</a> );
00151     }
00152 }
00153 
00154 <span class="comment">//----------- End of function FirmRes::load_bmp_info -------//</span>
00155 
00156 <span class="comment">//----------- Begin of function FirmRes::load_res --------//</span>
00158 <span class="comment">void FirmRes::load_res(int zoomLevel, char* namePrefix, char* nameSuffix) {</span>
00159     <span class="comment">//------ read bitmaps into memory -----//</span>
00160 
00161     <a class="code" href="classString.html">String</a> str2;
00162 
00163     str2  = <a class="code" href="Gamedef_8h.html#a4">DIR_RES</a>;
00164     str2 += namePrefix;
00165     str2 += <span class="stringliteral">"_"</span>;
00166     str2 += nameSuffix;
00167 
00168     str2 += <span class="stringliteral">".RES"</span>;
00169 
00170     res_bitmap[zoomLevel].init( str2, 1 );          <span class="comment">// 1-read all bitmaps into memory</span>
00171 
00172     <span class="comment">//-------- set FirmInfo::bitmap_ptr[] --------//</span>
00173 
00174     <span class="keywordtype">char</span>* bmpPtr;
00175 
00176     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;firm_count ; i++ ) {
00177         bmpPtr = res_bitmap[zoomLevel].read( info_array[i].code );
00178 
00179         <span class="keywordflow">if</span>( !bmpPtr ) { {                             <span class="comment">// no bimtap available</span>
00180             <span class="comment">//if ( zoomLevel == ZOOM_MEDIUM )           // 0209</span>
00181             <span class="keywordtype">char</span>* k = info_array[i].code;
00182             <a class="code" href="ALL_8H.html#a1">err_here</a>();
00183         }
00184         <span class="comment">//else</span>
00185         <span class="comment">//      err_here();</span>
00186 
00187         info_array[i].loc_width = 0;                <span class="comment">// BUGHERE, fixing bug on-fly</span>
00188         <span class="comment">//err_when( info_array[i].loc_width &gt; 0 );              // if loc_width &gt; 0, it indicates that the school type has that firm, and there should be a bitmap for it</span>
00189         <span class="keywordflow">continue</span>;
00190         }
00191 
00192         info_array[i].bitmap_ptr[zoomLevel] = bmpPtr;
00193 
00194         info_array[i].bitmap_width[zoomLevel]  = *( (<span class="keywordtype">short</span>*)bmpPtr );
00195         info_array[i].bitmap_height[zoomLevel] = *( ((<span class="keywordtype">short</span>*)bmpPtr)+1 );
00196     }
00197 }
00198 
00199 <span class="comment">//------------- End of function FirmRes::load_res --------//</span>
00200 
00201 <span class="comment">//--------- Begin of function FirmRes::get_color_remap_table --------//</span>
<a name="l00205"></a><a class="code" href="classFirmRes.html#a4">00205</a> <span class="comment">short* FirmRes::get_color_remap_table(int selectedFlag) {</span>
00206     <span class="keywordflow">if</span>( selectedFlag )
00207         <span class="keywordflow">return</span> (<span class="keywordtype">short</span>*) vga.vga_color_table-&gt;get_table(16);
00208     <span class="keywordflow">else</span>
00209         <span class="comment">// for selected buildings</span>
00210         <span class="keywordflow">return</span> (<span class="keywordtype">short</span>*) vga.vga_color_table-&gt;get_table(0);
00211 }
00212 
00213 <span class="comment">//--------- End of function FirmRes::get_color_remap_table --------//</span>
00214 
00215 <span class="comment">//------- Begin of function FirmInfo::can_build ------//</span>
<a name="l00219"></a><a class="code" href="structFirmInfo.html#a1">00219</a> <span class="comment">int FirmInfo::can_build(int xLoc1, int yLoc1) {</span>
00220     <span class="keywordflow">if</span>( !is_fully_visible(xLoc1, yLoc1) )
00221         <span class="keywordflow">return</span> 0;
00222 
00223     <span class="keywordtype">int</span> xLoc, yLoc;
00224 
00225     <span class="keywordflow">for</span>( yLoc=yLoc1 ; yLoc&lt;yLoc1+loc_height ; yLoc++ ) {
00226         <span class="keywordflow">for</span>( xLoc=xLoc1 ; xLoc&lt;xLoc1+loc_width ; xLoc++ ) {
00227             <span class="keywordflow">if</span>( !world.get_loc(xLoc, yLoc)-&gt;is_empty() &amp;&amp;
00228                 !world.get_loc(xLoc, yLoc)-&gt;is_plant() ) {
00229                 <span class="keywordflow">return</span> 0;
00230             }
00231         }
00232     }
00233 
00234     <span class="keywordflow">return</span> 1;
00235 }
00236 
00237 <span class="comment">//------- End of function FirmInfo::can_build --------//</span>
00238 
00239 <span class="comment">//------- Begin of function FirmInfo::is_fully_visible ------//</span>
<a name="l00243"></a><a class="code" href="structFirmInfo.html#a2">00243</a> <span class="comment">int FirmInfo::is_fully_visible(int xLoc1, int yLoc1) {</span>
00244     <a class="code" href="classMatrix.html">Matrix</a>* matrixPtr = &amp;(world.map_matrix);
00245 
00246     <span class="comment">//-------- check if the firm is within the view area --------//</span>
00247 
00248     <span class="keywordtype">int</span> zoomLevel = matrixPtr-&gt;<a class="code" href="classMatrix.html#m20">zoom_level</a>;
00249     <span class="keywordtype">int</span> bmpWidth  = bitmap_width[zoomLevel];
00250     <span class="keywordtype">int</span> bmpHeight = bitmap_height[zoomLevel];
00251 
00252     <span class="keywordtype">int</span> absX1 = (matrixPtr-&gt;<a class="code" href="classMatrix.html#m3">loc_width</a>/2) * (xLoc1 + yLoc1);
00253     <span class="keywordtype">int</span> absX2 = absX1 + bmpWidth - 1;
00254 
00255     <span class="keywordtype">int</span> absY2 = (<a class="code" href="Oworldmt_8h.html#a1">MAX_WORLD_Y_LOC</a> / 2 * matrixPtr-&gt;<a class="code" href="classMatrix.html#m4">loc_height</a>) + ((matrixPtr-&gt;<a class="code" href="classMatrix.html#m4">loc_height</a>/2) * (-xLoc1 + yLoc1 + loc_height ) - 1);
00256     <span class="keywordtype">int</span> absY1 = absY2 - bmpHeight + 1;
00257 
00258     <span class="keywordflow">return</span> absX1 &gt;= matrixPtr-&gt;<a class="code" href="classMatrix.html#m7">abs_top_x</a> &amp;&amp;
00259         absY1 &gt;= matrixPtr-&gt;<a class="code" href="classMatrix.html#m8">abs_top_y</a> &amp;&amp;
00260         absX2 &lt; matrixPtr-&gt;<a class="code" href="classMatrix.html#m7">abs_top_x</a> + matrixPtr-&gt;<a class="code" href="classMatrix.html#m15">win_width</a> &amp;&amp;
00261         absY2 &lt; matrixPtr-&gt;<a class="code" href="classMatrix.html#m8">abs_top_y</a> + matrixPtr-&gt;<a class="code" href="classMatrix.html#m16">win_height</a>;
00262 }
00263 
00264 <span class="comment">//------- End of function FirmInfo::is_fully_visible --------//</span>
00265 
00266 <span class="comment">//---------- Begin of function FirmRes::operator[] -----------//</span>
00267 
<a name="l00268"></a><a class="code" href="classFirmRes.html#a5">00268</a> <a class="code" href="structFirmInfo.html">FirmInfo</a>* <a class="code" href="classFirmRes.html#a5">FirmRes::operator[]</a>(<span class="keywordtype">int</span> firmId) {
00269     <a class="code" href="ALL_8H.html#a2">err_if</a>( firmId&lt;1 || firmId&gt;<a class="code" href="classFirmRes.html#m1">firm_count</a> )
00270         <a class="code" href="ALL_8H.html#a4">err_now</a>( <span class="stringliteral">"FirmRes::operator[]"</span> );
00271 
00272     <span class="keywordflow">return</span> <a class="code" href="classFirmRes.html#m2">info_array</a>+firmId-1;
00273 }
00274 
00275 <span class="comment">//------------ End of function FirmRes::operator[] -----------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:40 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
