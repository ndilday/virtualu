<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Ofaci_st.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Ofaci_st.cpp</h1><a href="Ofaci__st_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : Ofaci_st.cpp</span>
00002 <span class="comment">//Description : Facility Class Definition related to Simulation and Statistics/History</span>
00003 <span class="comment">//              Refer to HE.Facilities.xls and techdoc 2.4</span>
00004 <span class="comment">//Owner       : Fred</span>
00005 
00006 <span class="comment">// ES library header file</span>
00007 <span class="preprocessor">#include &lt;OMATH.H&gt;</span>                                <span class="comment">//random_snd</span>
00008 
00009 <span class="comment">// CU header file</span>
00010 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00011 <span class="preprocessor">#include &lt;OINFO.h&gt;</span>
00012 <span class="preprocessor">#include &lt;OPEERSCH.h&gt;</span>
00013 <span class="preprocessor">#include &lt;OSCHLRES.h&gt;</span>
00014 <span class="preprocessor">#include &lt;OPSCHOOL.h&gt;</span>
00015 <span class="preprocessor">#include &lt;OFinance.h&gt;</span>
00016 <span class="preprocessor">#include &lt;ODEVELOP.h&gt;</span>
00017 <span class="preprocessor">#include &lt;OCHANCE.H&gt;</span>
00018 <span class="preprocessor">#include &lt;Odeptres.h&gt;</span>
00019 <span class="preprocessor">#include &lt;<a class="code" href="Odept_8h.html">Odept.h</a>&gt;</span>
00020 <span class="preprocessor">#include "OFacilit.h"</span>
00021 
00022 <span class="comment">//----------- Define static variables -------------//</span>
00023 <span class="comment">// enum { URBAN, SUBURBAN, RURAL };             // for campus_environment</span>
00024 
00025 <span class="comment">/*</span>
00026 <span class="comment">  Campus Setting        Faculty #       Adj staff $     SL-1 #  SL-2 #  SL-3 #  SL-4 #  SL-5 #</span>
00027 <span class="comment"></span>
00028 <span class="comment">   Urban        {0.70f, 0.40f, 0.00f, 0.45f, 0.65f, 0.70f, 0.50f};</span>
00029 <span class="comment">  Suburban      {1.00f, 0.65f, 0.10f, 0.60f, 0.80f, 0.90f, 0.80f};</span>
00030 <span class="comment">  Rural {1.00f, 0.90f, 0.25f, 1.00f, 1.00f, 1.00f, 1.00f};</span>
00031 <span class="comment">*/</span>
00032 
00033 <span class="keyword">enum</span> {
00034     <a class="code" href="Ofaci__st_8cpp.html#a2a1">COEF_COUNT</a> = <a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>+2,
00035 };
00036 
00037 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> parking_demand_coef[<a class="code" href="Opschool_8h.html#a62a20">ENVIRONMENT_COUNT</a>][<a class="code" href="Ofaci__st_8cpp.html#a2a1">COEF_COUNT</a>] = {
00038     {0.70f, 0.40f, 0.00f, 0.45f, 0.65f, 0.70f, 0.50f},
00039     {1.00f, 0.65f, 0.10f, 0.60f, 0.80f, 0.90f, 0.80f},
00040     {1.00f, 0.90f, 0.25f, 1.00f, 1.00f, 1.00f, 1.00f},
00041 };
00042 
00043 <span class="comment">//----------- Define static functions -------------//</span>
00044 <span class="comment">//----------- Define static class member variables -------------//</span>
00045 
00046 <span class="comment">//----------- Begin of function Facility::init_data --------//</span>
<a name="l00048"></a><a class="code" href="classFacility.html#a9">00048</a> <span class="comment">void Facility::init_data_pre_finance() {</span>
00049     <span class="comment">// calc total_normal_onm for finance</span>
00050 
00051     <a class="code" href="classPeerSchool.html">PeerSchool</a> *playerSchoolEx = school_res.player_peer_school;
00052 
00053     finance.total_operating_expense.total = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m39">total_operating_expenditure</a>;
00054     finance.expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].total = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m19">dept_expense_faculty_salaries</a> + playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m20">dept_expense_staff_salaries</a> + playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m21">dept_expense_other</a>;
00055     finance.expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].total = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m12">sponsored_research</a> / (1+playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m48">overhead_rate_on_sponsored_research</a>/100.0);
00056 
00057     begin_space_inventory();
00058 
00059     department_res.general_dept_info.actual_sf = 0; <span class="comment">// so that this will re-calc during init_data()</span>
00060 
00061     <span class="comment">//----------------------//</span>
00062 
00063     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a> *deptInfo;
00064     <span class="comment">//GeneralDepartment*        dept;</span>
00065 
00066     <span class="keywordtype">int</span> deptCount = department_array.department_count;
00067 
00068     total_normal_onm = 0;
00069 
00070   <span class="comment">//------ read in active department array -------//</span>
00071 
00072     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;=deptCount; i++ ) {
00073         <span class="keywordflow">if</span> (i) {
00074             <span class="comment">//dept              = (department_array[i];</span>
00075             deptInfo  = (department_res.info_array+department_array[i]-&gt;department_id - 1);
00076         }
00077         <span class="keywordflow">else</span> {
00078             <span class="comment">// code to handle general deparment</span>
00079             <span class="comment">//dept              = &amp;department_res.general_dept;</span>
00080             deptInfo = &amp;department_res.general_dept_info;
00081         }
00082 
00083         <span class="keywordtype">float</span> normalOnm = (deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a> * deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m9">normal_onm_cost</a> / 1000.0f);
00084         total_normal_onm += (int) normalOnm;
00085     }
00086 }
00087 
<a name="l00088"></a><a class="code" href="classFacility.html#a10">00088</a> <span class="keywordtype">void</span> <a class="code" href="classFacility.html#a10">Facility::init_data</a>() {
00089     <span class="comment">// assumed memset(this, 0, sizeof(Facility)); called</span>
00090 
00091     <span class="comment">//------------------------//</span>
00092 
00093     <a class="code" href="classFacility.html#a14">update_parking</a>(<span class="keyword">true</span>);                           <span class="comment">// true: init</span>
00094     <a class="code" href="classFacility.html#a15">update_crime</a>(<span class="keyword">true</span>);
00095 
00096   <span class="comment">//----- constants or other factors -----//</span>
00097   <span class="comment">// Debt capacity parameters</span>
00098 
00099     <a class="code" href="classFacility.html#m5">maximum_debt_balance_as_a_percent_of_funds_balances</a> = 0.5f;
00100     <a class="code" href="classFacility.html#m6">max_interest_payments_as_a_percent_of_operating_expenditures</a> = 0.08f;
00101 
00102     <a class="code" href="classFacility.html#m7">percent_gap_required_before_new_construction_is_considered</a> = 0.1f;
00103     <a class="code" href="classFacility.html#m8">escalation_factor_for_deferrd_maintenance_per_year</a> = 0.025f;
00104 
00105   <span class="comment">//---------- init player input/output -------------//</span>
00106 
00107     <a class="code" href="classFacility.html#m13">percent_project_funded_with_debt</a> = 33.3f;
00108 
00109     <span class="comment">// assume finance is inited before</span>
00110     <span class="comment">/*</span>
00111 <span class="comment">      total_debt_capacity[THIS_YEAR] = (int) min(       // min(E22*'$G$12,'$F$257*E23/'$C$74);</span>
00112 <span class="comment">      maximum_debt_balance_as_a_percent_of_funds_balances</span>
00113 <span class="comment">      * ( finance.last_year.asset_array[AC_ASSET_TOTAL] - finance.last_year.liability_array[AC_LIABILITY_TOTAL] ),</span>
00114 <span class="comment">      finance.total_operating_expense.total *  max_interest_payments_as_a_percent_of_operating_expenditures</span>
00115 <span class="comment">      / (finance.long_term_debt_interest / 100.0f) );</span>
00116 <span class="comment">    */</span>
00117 
00118   <span class="comment">// after 981016:</span>
00119 
00120     <span class="keywordtype">float</span> opReserve = (float) finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>];
00121 
00122     <span class="keywordtype">float</span> availableFunds = float( opReserve
00123                                   + 0.5*( finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]
00124                                           +finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>] )
00125                                   + 0.25 *finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a23">AC_BUILDINGS</a>]
00126                                   - finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a29">AC_LIABILITY_TOTAL</a>]);
00127 
00128     availableFunds = max(0.0f,availableFunds);      <span class="comment">//min &amp; max bug chea</span>
00129 
00130     <a class="code" href="classFacility.html#m23">total_debt_capacity</a>[THIS_YEAR] = (int) min(
00131         (<span class="keywordtype">float</span>)(<a class="code" href="classFacility.html#m5">maximum_debt_balance_as_a_percent_of_funds_balances</a> * availableFunds),
00132         (<span class="keywordtype">float</span>)(finance.projected_total_operating_expense.this_year.total *  <a class="code" href="classFacility.html#m6">max_interest_payments_as_a_percent_of_operating_expenditures</a>
00133                 / (finance.long_term_debt_interest / 100.0f)) );<span class="comment">//min &amp; max bug chea</span>
00134 
00135     <a class="code" href="classFacility.html#m23">total_debt_capacity</a>[THIS_YEAR] = max(0,<a class="code" href="classFacility.html#m23">total_debt_capacity</a>[THIS_YEAR]);
00136 
00137                                                   <span class="comment">//0113</span>
00138     <a class="code" href="classFacility.html#m25">debt_limit</a>[THIS_YEAR] = <a class="code" href="classFacility.html#m12">cur_debt_limit</a> = int(<a class="code" href="classFacility.html#m23">total_debt_capacity</a>[THIS_YEAR]);
00139 
00140     <span class="comment">// e44 = outstanding_debt_balance[THIS_YEAR]</span>
00141     <a class="code" href="classFacility.html#m24">outstanding_debt_balance</a>[THIS_YEAR] = (int)finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a27">AC_GENERAL_PLANT_DEBT</a>];
00142 
00143     <span class="keywordtype">int</span> beginCapitalReserve = int(finance.last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>]);
00144     <span class="comment">//  min_capital_reserve_balance = int(beginCapitalReserve * 0.6f);</span>
00145     <a class="code" href="classFacility.html#m14">min_capital_reserve_balance</a> = 0.0f;
00146 
00147     <a class="code" href="classFacility.html#m18">ratio_of_square_footage_to_benchmark</a>[THIS_YEAR] = 1.0f;
00148 
00149     <span class="comment">//---------- other vars -------------//</span>
00150 
00151     <a class="code" href="classFacility.html#m16">cur_change_backlog</a> = 0;
00152 
00153     <span class="comment">// should we do:</span>
00154     begin_space_inventory();                        <span class="comment">// see next_day()</span>
00155 
00156     <span class="comment">// special case - finance vars updated in facilities model</span>
00157 
00158     finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a23">AC_BUILDINGS</a>] = finance.last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a23">AC_BUILDINGS</a>];
00159     finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>] = finance.last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>];
00160     finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a27">AC_GENERAL_PLANT_DEBT</a>] = finance.last_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a27">AC_GENERAL_PLANT_DEBT</a>];
00161 
00162     finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a29">AC_LIABILITY_TOTAL</a>] = 0;
00163     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a98a26">LIABILITY_ITEM_COUNT</a>-1 ; i++ ) {
00164         finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a29">AC_LIABILITY_TOTAL</a>] += finance.this_year.liability_array[i];
00165     }
00166 
00167     update_vars_monthly();
00168     <span class="comment">//update_history_sub();</span>
00169 
00170     <a class="code" href="classFacility.html#m26">onm_n_backlog_history</a>[<a class="code" href="Gamedef_8h.html#a82a56">SECOND_H_THIS_YEAR</a>-1] = <a class="code" href="classFacility.html#m26">onm_n_backlog_history</a>[<a class="code" href="Gamedef_8h.html#a82a56">SECOND_H_THIS_YEAR</a>];
00171 
00172     calc_facility_staff_morale();
00173 }
00174 
00175 <span class="comment">//------------- End of function Facility::init_data --------//</span>
00176 
00177 <span class="comment">//----------- Begin of function Facility next_day ------//</span>
<a name="l00179"></a><a class="code" href="classFacility.html#a12">00179</a> <span class="comment">void Facility::next_day() {</span>
00180     <span class="comment">// per YEAR</span>
00181     <span class="keywordflow">if</span> ( ( info.game_day == 1 )
00182          &amp;&amp; info.game_month == finance.fiscal_year_start_month ) {
00183         <span class="comment">// if it's a new financial year</span>
00184 
00185         <span class="comment">// assume finance.next_day() is called first and RA is just run</span>
00186         <span class="comment">// assume optimization is just run before this at the *same* day</span>
00187 
00188         update_history_yearly();
00189 
00190         update_parking();                             <span class="comment">// before begin_space_inventory()</span>
00191 
00192 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00193 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00194 <span class="preprocessor"></span>        begin_space_inventory();
00195 <span class="preprocessor">#endif</span>
00196 <span class="preprocessor"></span>    }
00197 
00198     <span class="comment">// per MONTH</span>
00199     <span class="keywordflow">if</span> ( info.game_day == 1 ) {
00200         update_crime();
00201 
00202         update_vars_monthly();
00203 
00204         calc_facility_staff_morale();
00205 
00206         <span class="comment">// start of a year</span>
00207         <span class="keywordflow">if</span> ( info.game_month == finance.fiscal_year_start_month ) {
00208 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00209 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00210 <span class="preprocessor"></span>            run_new_construction();
00211 <span class="preprocessor">#endif</span>
00212 <span class="preprocessor"></span>        }
00213     }
00214 }
00215 
00216 <span class="comment">//------------- End of function Facility next_day ------//</span>
00217 
00218 <span class="comment">//----------- Begin of function Facility::update_history_sub ------//</span>
00221 <span class="comment">void Facility::update_history_sub() {</span>
00222     <span class="comment">//------ LAST_YEAR ---------//</span>
00223     onm_n_backlog_history[<a class="code" href="Gamedef_8h.html#a82a55">FIRST_H_THIS_YEAR</a>-1] = (int) finance.expense_array[<a class="code" href="Ofinance_8h.html#a104a53">AC_OPERATIONS_AND_MAINTENANCE</a>].total;
00224     <span class="comment">//onm_n_backlog_history[SECOND_H_THIS_YEAR-1] = not necessary</span>
00225 
00226     transfer_history[<a class="code" href="Gamedef_8h.html#a82a48">H_PREV_YEAR</a>] = (int) finance.expense_array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>].total;
00227     gifts_to_facility[<a class="code" href="Gamedef_8h.html#a82a48">H_PREV_YEAR</a>] = (int) development_office.last_year.facilities;
00228 
00229     <span class="comment">//------ THIS_YEAR ---------//</span>
00230     onm_n_backlog_history[<a class="code" href="Gamedef_8h.html#a82a55">FIRST_H_THIS_YEAR</a>] = (int) finance.projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a53">AC_OPERATIONS_AND_MAINTENANCE</a>].this_year.total;
00231     <span class="comment">//onm_n_backlog_history[SECOND_H_THIS_YEAR] = updated elsewhere in this file</span>
00232 
00233     transfer_history[<a class="code" href="Gamedef_8h.html#a82a49">H_THIS_YEAR</a>] = (int) finance.projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>].this_year.total;
00234 
00235     <span class="comment">// assume called after development_office.next_day() for each year</span>
00236     gifts_to_facility[<a class="code" href="Gamedef_8h.html#a82a49">H_THIS_YEAR</a>] = (int) development_office.this_year.facilities;
00237 
00238     <span class="comment">//captial_reserve_expense[H_THIS_YEAR] = updated elsewhere in this file</span>
00239 
00240     <span class="comment">//------ NEXT_YEAR ---------//</span>
00241     onm_n_backlog_history[<a class="code" href="Gamedef_8h.html#a82a55">FIRST_H_THIS_YEAR</a>+1] = (int) finance.projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a53">AC_OPERATIONS_AND_MAINTENANCE</a>].next_year.total;
00242     <span class="comment">//onm_n_backlog_history[SECOND_H_THIS_YEAR] = updated elsewhere in this file</span>
00243 
00244     transfer_history[<a class="code" href="Gamedef_8h.html#a82a50">H_NEXT_YEAR</a>] = (int) finance.projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>].next_year.total;
00245     gifts_to_facility[<a class="code" href="Gamedef_8h.html#a82a50">H_NEXT_YEAR</a>] = (int) development_office.this_year.facilities;
00246 
00247     captial_reserve_expense[<a class="code" href="Gamedef_8h.html#a82a50">H_NEXT_YEAR</a>] = captial_reserve_expense[<a class="code" href="Gamedef_8h.html#a82a49">H_THIS_YEAR</a>];
00248 }
00249 
00250 <span class="comment">//----------- End of function Facility::update_history_sub ------//</span>
00251 
00252 <span class="comment">//----------- Begin of function Facility::update_history_yearly ------//</span>
<a name="l00256"></a><a class="code" href="classFacility.html#a11">00256</a> <span class="comment">void Facility::update_history_yearly() {</span>
00257     <span class="keywordtype">int</span> h;
00258 
00259     <span class="comment">// part 2</span>
00260 
00261     <span class="comment">// 1 of 2: shift history to "left"</span>
00262     <span class="comment">//</span>
00263     <span class="keywordflow">for</span> ( h=0; h&lt;HISTORY_YEAR_COUNT-1; h++) {
00264         ratio_of_square_footage_to_benchmark[h] = ratio_of_square_footage_to_benchmark[h+1];
00265 
00266         total_debt_capacity[h] = total_debt_capacity[h+1];
00267         outstanding_debt_balance[h] = outstanding_debt_balance[h+1];
00268         debt_limit[h] = debt_limit[h+1];
00269 
00270         construction_project_spending[h] = construction_project_spending[h+1];
00271 
00272         transfer_history[h] = transfer_history[h+1];
00273         gifts_to_facility[h] = gifts_to_facility[h+1];
00274         captial_reserve_expense[h] = captial_reserve_expense[h+1];
00275     }
00276 
00277     <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(onm_n_backlog_history, HISTORY_YEAR_COUNT2);
00278 
00279     <span class="comment">// 2 of 2: update current year values</span>
00280 
00281     captial_reserve_expense[<a class="code" href="Gamedef_8h.html#a82a49">H_THIS_YEAR</a>] = 0;
00282 
00283     <span class="comment">// calc after RA</span>
00284 
00285     <span class="comment">// after 981016:</span>
00286 
00287     <span class="keywordtype">float</span> availableFunds = (float) finance.get_available_funds();
00288 
00289     total_debt_capacity[THIS_YEAR] = (int) min(
00290         (<span class="keywordtype">float</span>)(maximum_debt_balance_as_a_percent_of_funds_balances * availableFunds),
00291         (<span class="keywordtype">float</span>)(finance.projected_total_operating_expense.this_year.total *  max_interest_payments_as_a_percent_of_operating_expenditures
00292                 / (finance.long_term_debt_interest / 100.0f)) );<span class="comment">//min &amp; max bug chea</span>
00293 
00294     total_debt_capacity[THIS_YEAR] = max(0,total_debt_capacity[THIS_YEAR]);
00295 
00296     <span class="comment">//--------------------------//</span>
00297     <span class="comment">// Ending Space Inventory    //</span>
00298     <span class="comment">//--------------------------//</span>
00299     <span class="keywordtype">float</span> inflationRate = (float) finance.inflation_rate / 100.0f;
00300     <span class="keyword">const</span> <span class="keywordtype">float</span> growth = float(1 + inflationRate + finance.construction_cost_growth/100.0f);
00301 
00302     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a> *deptInfo;
00303     <a class="code" href="classGeneralDepartment.html">GeneralDepartment</a>*  dept;
00304 
00305     <span class="keywordtype">int</span> deptCount = department_array.department_count;
00306     <span class="keywordtype">int</span> totalActualSF = 0, totalNormalSF = 0, totalProjectedSF = 0, i;
00307 
00308     <span class="keywordflow">for</span>( i=0 ; i&lt;=deptCount; i++ ) {
00309         <span class="keywordflow">if</span> ( i ) {
00310             dept    = (<a class="code" href="classGeneralDepartment.html">GeneralDepartment</a>*) department_array[i];
00311             <span class="comment">// -1: otherwise will have bug</span>
00312             deptInfo  = (department_res.info_array + department_array[i]-&gt;department_id - 1);
00313         }
00314         <span class="keywordflow">else</span> {
00315             <span class="comment">// code to handle general deparment</span>
00316             dept    = &amp;department_res.general_dept;
00317             deptInfo = &amp;department_res.general_dept_info;
00318         }
00319 
00320         totalActualSF += deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a>;
00321         totalNormalSF += deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a>;
00322         totalProjectedSF += dept-&gt;<a class="code" href="classGeneralDepartment.html#a10">get_constructing_sf</a>() + deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a>;
00323 
00324         <span class="comment">// 1027; see response_func:Time_Variation</span>
00325 
00326         <span class="keywordtype">float</span> last1 = deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m7">cost_growth</a>;
00327         deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m7">cost_growth</a> = math.time_variation(last1, (deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m8">cost_growth_last2</a>), 1.4482f, -0.8011f, 0.003528950f) + 0.03f;
00328         deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m8">cost_growth_last2</a> = last1;
00329 
00330         deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m6">replacement_cost</a> = int( deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m6">replacement_cost</a> * (1+inflationRate+deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m7">cost_growth</a>) );
00331 
00332         <a class="code" href="ALL_8H.html#a0">err_when</a>(deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m6">replacement_cost</a> &lt;= 0);
00333     }
00334 
00335 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00336 <span class="preprocessor"></span>    <span class="comment">// average the replacement_cost among the departments</span>
00337     <span class="keywordtype">int</span> totalReplacementCost=0;
00338     <span class="comment">// Calculate the total Replacement Cost</span>
00339     <span class="keywordflow">for</span>( i=0 ; i&lt;=deptCount; i++ ) {
00340         <span class="keywordflow">if</span> ( i ) {
00341             <span class="comment">// -1: otherwise will have bug</span>
00342             deptInfo  = (department_res.info_array + department_array[i]-&gt;department_id - 1);
00343         }
00344         <span class="keywordflow">else</span> {
00345             <span class="comment">// code to handle general deparment</span>
00346             deptInfo = &amp;department_res.general_dept_info;
00347         }
00348 
00349         totalReplacementCost += deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m6">replacement_cost</a>;
00350     }
00351 
00352     <span class="comment">// get Average and store</span>
00353     <span class="keywordflow">for</span>( i=0 ; i&lt;=deptCount; i++ ) {
00354         <span class="keywordflow">if</span> ( i ) {
00355             <span class="comment">// -1: otherwise will have bug</span>
00356             deptInfo  = (department_res.info_array + department_array[i]-&gt;department_id - 1);
00357         }
00358         <span class="keywordflow">else</span> {
00359             <span class="comment">// code to handle general deparment</span>
00360             deptInfo = &amp;department_res.general_dept_info;
00361         }
00362 
00363         deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m6">replacement_cost</a> = totalReplacementCost/deptCount;
00364     }
00365 <span class="preprocessor">#endif</span>
00366 <span class="preprocessor"></span>
00367     <span class="comment">// askbillok: is it what he want:</span>
00368     <span class="comment">// update this ratio after project completed</span>
00369     <span class="comment">//float ratioSF;</span>
00370     ratio_of_square_footage_to_benchmark[THIS_YEAR] = 1.0f;
00371     <a class="code" href="ALL_8H.html#a0">err_when</a>(!totalActualSF);
00372 
00373     <span class="keywordflow">for</span>( i=0 ; i&lt;=deptCount; i++ ) {
00374         <span class="keywordflow">if</span> ( i ) {
00375             dept    = (<a class="code" href="classGeneralDepartment.html">GeneralDepartment</a>*) department_array[i];
00376             deptInfo  = (department_res.info_array+department_array[i]-&gt;department_id - 1);
00377         }
00378         <span class="keywordflow">else</span>
00379             <span class="comment">// code to handle general deparment</span>
00380             deptInfo = &amp;department_res.general_dept_info;
00381 
00382         <span class="keywordtype">float</span> ratio_sf_to_benchmark = float(deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a>) / deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a>;
00383 
00384         ratio_of_square_footage_to_benchmark[THIS_YEAR] *= (float) math.safe_pow(ratio_sf_to_benchmark, <span class="keywordtype">float</span>(deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a>) / totalActualSF);
00385     }
00386 
00387     <span class="comment">//-------- post last year data first -------//</span>
00388 
00389     <span class="comment">//  finance.last_year.asset_array[AC_BUILDINGS] = finance.this_year.asset_array[AC_BUILDINGS];</span>
00390     <span class="comment">//  finance.last_year.asset_array[AC_CAPITAL_RESERVE] = finance.this_year.asset_array[AC_CAPITAL_RESERVE];</span>
00391     <span class="comment">//  finance.last_year.liability_array[AC_GENERAL_PLANT_DEBT]        = finance.this_year.liability_array[AC_GENERAL_PLANT_DEBT];</span>
00392 
00393     <span class="comment">//------------------------------------//</span>
00394     <span class="comment">// Year-end Replacement Cost and Debt //</span>
00395     <span class="comment">//------------------------------------//</span>
00396     <span class="comment">// assume called after finance optimization and finance.next_day()'s buget update//</span>
00397 
00398     <span class="comment">//askbill</span>
00399     <span class="comment">//option 1: update balance sheet yearly</span>
00400 
00401     <span class="comment">//update at the beginning of construction</span>
00402     <span class="comment">//finance.this_year.liability_array[AC_GENERAL_PLANT_DEBT]</span>
00403     <span class="comment">//  = finance.last_year.liability_array[AC_GENERAL_PLANT_DEBT]</span>
00404     <span class="comment">//  + total_actual_new_debt - finance.last_year.liability_array[AC_GENERAL_PLANT_DEBT] * finance.debt_fraction_repaid_annually / 100.0f;</span>
00405 
00406     <span class="comment">//option 2</span>
00407 
00408     <span class="comment">// assume called after develop_office.next_day</span>
00409     finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a23">AC_BUILDINGS</a>]     <span class="comment">// = E76 (year-end replacement cost</span>
00410         = finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a23">AC_BUILDINGS</a>]
00411         - finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a23">AC_BUILDINGS</a>] / finance.building_life_for_calc_depreciation;
00412 
00413     finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>] += development_office.last_year.facilities;
00414 
00415     finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a27">AC_GENERAL_PLANT_DEBT</a>]
00416         = finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a27">AC_GENERAL_PLANT_DEBT</a>]
00417         - finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a27">AC_GENERAL_PLANT_DEBT</a>] * finance.debt_fraction_repaid_annually / 100.0f;
00418 
00419 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00420 <span class="preprocessor"></span>    facility_office.outstanding_debt_balance[THIS_YEAR] = finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a27">AC_GENERAL_PLANT_DEBT</a>];
00421 <span class="preprocessor">#endif</span>
00422 <span class="preprocessor"></span>
00423     finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a29">AC_LIABILITY_TOTAL</a>] = 0;
00424     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a98a26">LIABILITY_ITEM_COUNT</a>-1 ; i++ ) {
00425         finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a29">AC_LIABILITY_TOTAL</a>] += finance.this_year.liability_array[i];
00426     }
00427 
00428     <span class="comment">//------------------------------------//</span>
00429     <span class="comment">// variables accumlated through a year</span>
00430     construction_project_spending[THIS_YEAR] = 0;
00431     cur_change_backlog = 0;
00432 }
00433 
00434 <span class="comment">//------------- End of function Facility::update_history_yearly ------//</span>
00435 
00436 <span class="comment">//----------- Begin of function Facility::begin_space_inventory --------//</span>
00440 <span class="comment">void Facility::begin_space_inventory() {</span>
00441     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a> *deptInfo;
00442     <a class="code" href="classDepartment.html">Department</a>* dept;
00443 
00444     <span class="keywordtype">int</span> deptCount = department_array.department_count;
00445 
00446     <span class="comment">//-----------------------------------//</span>
00447     <span class="comment">// code to handle deparment_array</span>
00448     <span class="comment">//-----------------------------------//</span>
00449 
00450     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=1 ; i&lt;=deptCount; i++ ) {
00451         dept    = department_array[i];
00452         deptInfo  = (department_res.info_array+dept-&gt;<a class="code" href="classGeneralDepartment.html#m2">department_id</a> - 1);
00453 
00454         <span class="comment">// calc of normal_sf is</span>
00455         <span class="comment">// based on the prior year's enrollments and research, but the</span>
00456         <span class="comment">// current year's faculty numbers. Ie, this routine should run</span>
00457         <span class="comment">// after the resource allocation routine, which determines faculty numbers for the year.</span>
00458         <span class="comment">// course enroll stats should be the maximum trimestrer enrollment over the three trimesters last year &lt;- checked OK on 0106</span>
00459 
00460         deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a> = int(
00461             deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m17">fixed_sf_per_dept</a>
00462             + dept-&gt;<a class="code" href="classDepartment.html#m1">course_array</a>.<a class="code" href="classCourseArray.html#m1">course_enrollments</a>[<a class="code" href="Ocourse_8h.html#a40a31">SEMINAR</a>] * deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m11">sf_per_course_enrollment_in_seminars</a>
00463             + dept-&gt;<a class="code" href="classDepartment.html#m1">course_array</a>.<a class="code" href="classCourseArray.html#m1">course_enrollments</a>[<a class="code" href="Ocourse_8h.html#a40a35">GENERAL</a>] * deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m12">sf_per_course_enrollment_in_general_courses</a>
00464             + dept-&gt;<a class="code" href="classDepartment.html#m1">course_array</a>.<a class="code" href="classCourseArray.html#m1">course_enrollments</a>[<a class="code" href="Ocourse_8h.html#a40a33">CLASS_WITH_BREAKOUT</a>] * deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m13">sf_per_course_enrollment_in_lecture_courses</a>
00465             + deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m14">sf_per_faculty</a> * dept-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#m1">faculty_count</a>
00466             <span class="comment">//  per thousand dollars  //## chea 221199 /1000</span>
00467             + deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m15">sf_per_research_dollar</a> * dept-&gt;<a class="code" href="classDepartment.html#m5">total_research_dollar</a> /1000);
00468 
00469         <span class="comment">// if 1st time calc</span>
00470 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00471 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( info.prerun_year &amp;&amp; info.game_year == 1 ) {
00472             deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a> = (int)( (float)deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a> * math.get_random_snd(1.1f, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.25f)) );
00473         }
00474 <span class="preprocessor">#else</span>
00475 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a> &lt;= 0) {
00476             <span class="comment">// below for debug only</span>
00477             <span class="comment">// deptInfo-&gt;actual_sf = (int) math.get_random_snd(float(deptInfo-&gt;normal_sf * 0.6), deptInfo-&gt;normal_sf * 0.05f);</span>
00478             <span class="comment">// should be</span>
00479             deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a> = m.fmax(10, (<span class="keywordtype">int</span>) math.get_random_snd(<span class="keywordtype">float</span>(deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a>), <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a> * 0.005f)));
00480         }
00481 <span class="preprocessor">#endif</span>
00482 <span class="preprocessor"></span>    }
00483 
00484     <span class="comment">//-----------------------------------//</span>
00485     <span class="comment">// code to handle general deparment</span>
00486     <span class="comment">//-----------------------------------//</span>
00487 
00488     deptInfo = &amp;department_res.general_dept_info;
00489 
00490     <span class="keywordtype">int</span> tmp;
00491 
00492     <span class="comment">//f20</span>
00493     tmp = int(finance.total_operating_expense.total - finance.expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].total - finance.expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].total);
00494     tmp = max(0,tmp);
00495     <span class="comment">//deptInfo-&gt;normal_sf = projected_parking_supply + int(deptInfo-&gt;fixed_sf_per_dept + tmp * deptInfo-&gt;sf_per_dollar_of_central_exp);</span>
00496     deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a> = int(deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m17">fixed_sf_per_dept</a> + tmp * deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m16">sf_per_dollar_of_central_exp</a>);
00497 
00498 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00499 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( info.prerun_year &amp;&amp; info.game_year == 1 ) {
00500         deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a> = (int)( (float)deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a> * math.get_random_snd(1.1f, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.25f)) );
00501     }
00502 <span class="preprocessor">#else</span>
00503 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a> &lt;= 0 ) {
00504         deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a> = m.fmax(10, (<span class="keywordtype">int</span>) math.get_random_snd(<span class="keywordtype">float</span>(deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a>), <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a> * 0.005f)));
00505     }
00506 <span class="preprocessor">#endif</span>
00507 <span class="preprocessor"></span>}
00508 
00509 <span class="comment">//------------- End of function Facility::begin_space_inventory --------//</span>
00510 
00511 <span class="comment">//----------- Begin of function Facility::update_vars_monthly --------//</span>
00513 <span class="comment">void Facility::update_vars_monthly() {</span>
00514     <span class="comment">//----------------------//</span>
00515     <span class="comment">// update actual sf         //              (if new construction completed)</span>
00516     <span class="comment">//----------------------//</span>
00517 
00518     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a> *deptInfo;
00519     <a class="code" href="classGeneralDepartment.html">GeneralDepartment</a>*  dept;
00520 
00521     <span class="keywordtype">int</span> deptCount = department_array.department_count;
00522 
00523     <span class="keywordtype">float</span> normalOnm;
00524     <span class="keywordtype">int</span> newSF, projectExpense, projectExpenseTotal = 0;
00525     <span class="comment">// unit: square foot</span>
00526     <span class="keywordtype">int</span> totalActualSF = 0, totalNormalSF = 0, totalProjectedSF = 0;
00527 
00528     total_normal_onm = 0;
00529 
00530     <span class="comment">//------ read in active department array -------//</span>
00531 
00532     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;=deptCount; i++ ) {
00533         <span class="keywordflow">if</span> (i) {
00534             dept    = (<a class="code" href="classGeneralDepartment.html">GeneralDepartment</a>*) department_array[i];
00535             deptInfo  = (department_res.info_array+department_array[i]-&gt;department_id - 1);
00536         }
00537         <span class="keywordflow">else</span> {
00538             <span class="comment">// code to handle general deparment</span>
00539             dept    = &amp;department_res.general_dept;
00540             deptInfo = &amp;department_res.general_dept_info;
00541         }
00542 
00543         <span class="comment">// check completed new construction</span>
00544         <span class="comment">//</span>
00545         dept-&gt;<a class="code" href="classGeneralDepartment.html#a7">next_month_construction</a>(newSF, projectExpense);
00546 
00547         <span class="comment">//Equals sf at the beginning of the prior year plus NEW CONSTRCUTION COMPLETED during the prior year.</span>
00548         <span class="comment">//This is the amount of space actually available for use during the year.</span>
00549         deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a> += newSF;
00550         projectExpenseTotal += projectExpense;
00551 
00552         <span class="comment">// Same as actual_sf in that: this should be recalculated whenever new sf get completed.</span>
00553         normalOnm = (deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a> * deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m9">normal_onm_cost</a> / 1000.0f);
00554         total_normal_onm += (int) normalOnm;
00555 
00556         totalActualSF += deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a>;
00557         totalNormalSF += deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a>;
00558         totalProjectedSF += dept-&gt;<a class="code" href="classGeneralDepartment.html#a10">get_constructing_sf</a>() + deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a>;
00559 
00560         <a class="code" href="ALL_8H.html#a0">err_when</a>( deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a>&lt;=0 || deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a>&lt;=0 || normalOnm&lt;=0 );
00561     }
00562 
00563     <span class="comment">// for screen "space usage": norm-projected-actual curves graph</span>
00564     <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(normal_area, HISTORY_MONTH_COUNT);
00565     <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(actual_area, HISTORY_MONTH_COUNT);
00566     <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(projected_area, HISTORY_MONTH_COUNT);
00567 
00568     normal_area[THIS_MONTH] = totalNormalSF;
00569     actual_area[THIS_MONTH] = totalActualSF;
00570     projected_area[THIS_MONTH] = totalProjectedSF;
00571 
00572     <span class="comment">//----------------------//</span>
00573     <span class="comment">// update backlog                   //</span>
00574     <span class="comment">//----------------------//</span>
00575 
00576     <span class="comment">// vars after the section "Beginning Space Inventory"</span>
00577 
00578     <span class="comment">// 990420   0.05f *</span>
00579     <span class="keywordtype">int</span> tmp = int(math.get_random_snd(0.0f, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.05f * <span class="keywordtype">float</span>(total_normal_onm)) ));
00580     <span class="keywordtype">int</span> beginBacklog = total_normal_onm + ( (tmp &gt; 0) ? tmp : 0);
00581 
00582 <span class="preprocessor">#if(GAME_VERSION&gt;=200)                          // remove stage1_revenue, stage1_expense, stage2_expense</span>
00583 <span class="preprocessor"></span>
00584     <span class="keywordtype">float</span> buget_monthly; {
00585         <span class="keywordtype">double</span> cons1 = (1 + finance.inflation_rate/100.0 + finance.expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a71">PL_STAFF_SALARY_INCREASES</a>].result_value / 100.0);
00586         <span class="keywordtype">double</span> cons2 = (1 + finance.inflation_rate/100.0 + finance.other_expense_growth/100.0);
00587         <span class="keywordtype">double</span> computed_growthrate = finance.cost_rise_policy_array[<a class="code" href="Ofinance_8h.html#a104a53">AC_OPERATIONS_AND_MAINTENANCE</a>].result_value;
00588         <span class="keywordtype">double</span> base_value = cons1 * finance.expense_array[<a class="code" href="Ofinance_8h.html#a104a53">AC_OPERATIONS_AND_MAINTENANCE</a>].staff + cons2 * finance.expense_array[<a class="code" href="Ofinance_8h.html#a104a53">AC_OPERATIONS_AND_MAINTENANCE</a>].other;
00589         <span class="keywordtype">double</span> change_value = base_value * computed_growthrate / 100.0;
00590         <span class="keywordtype">double</span> new_value = (change_value + base_value );
00591         buget_monthly = float(new_value / 12.0f);
00592     }
00593 
00594 <span class="preprocessor">#else</span>
00595 <span class="preprocessor"></span>    <span class="keywordtype">float</span> buget_monthly = float(finance.stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a36">S2_OPERATIONS_AND_MAINTENANCE</a>].new_value / 12.0f);
00596 <span class="preprocessor">#endif</span>
00597 <span class="preprocessor"></span>
00598     cur_change_backlog = int(
00599         beginBacklog * escalation_factor_for_deferrd_maintenance_per_year / 12.0f
00600         - total_normal_onm / 12.0f - buget_monthly);
00601 
00602     <span class="comment">// update end_backlog</span>
00603     onm_n_backlog_history[<a class="code" href="Gamedef_8h.html#a82a56">SECOND_H_THIS_YEAR</a>] = max(0, beginBacklog + cur_change_backlog);
00604     onm_n_backlog_history[<a class="code" href="Gamedef_8h.html#a82a56">SECOND_H_THIS_YEAR</a>+1] = onm_n_backlog_history[<a class="code" href="Gamedef_8h.html#a82a56">SECOND_H_THIS_YEAR</a>];
00605 
00606     <span class="comment">//------------------//</span>
00607     update_history_sub();
00608 }
00609 
00610 <span class="comment">//------------- End of function Facility::update_vars_monthly --------//</span>
00611 
00612 <span class="comment">//----------- Begin of function Facility::run_new_construction --------//</span>
<a name="l00616"></a><a class="code" href="classFacility.html#a13">00616</a> <span class="comment">void Facility::run_new_construction() {</span>
00617     <span class="comment">//----------------------//</span>
00618     <span class="comment">// Capital Availability //          (pre construction)</span>
00619     <span class="comment">//----------------------//</span>
00620 
00621     <span class="comment">// calc after player change cur_debt_limit</span>
00622 
00623     debt_limit[THIS_YEAR] = cur_debt_limit;
00624 
00625     <span class="comment">// e44 = outstanding_debt_balance[THIS_YEAR]</span>
00626     <span class="keywordtype">int</span> e44;
00627     e44 = outstanding_debt_balance[THIS_YEAR] = (int)finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a27">AC_GENERAL_PLANT_DEBT</a>];
00628 
00629     <span class="keywordtype">int</span> maxNewDebt = int(min(total_debt_capacity[THIS_YEAR], debt_limit[THIS_YEAR])
00630                          - e44 + e44 * finance.debt_fraction_repaid_annually / 100.0f);
00631 
00632     <span class="keywordtype">int</span> beginCapitalReserve = int(finance.last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>]);
00633 
00634     <span class="comment">//askbill update frequency for this two</span>
00635     <span class="keywordtype">int</span> interestReceived = int(beginCapitalReserve * (finance.inflation_rate + finance.short_term_debt_interest ) / 100.0f );
00636 
00637     <span class="keywordtype">int</span> transferFromBudget = int(finance.budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>].total);
00638 
00639     <span class="comment">// calc after player change (budget change)</span>
00640     <span class="comment">// should tell user it's at least zero</span>
00641     <span class="keywordflow">if</span> ( transferFromBudget &lt; 0 )
00642         transferFromBudget = 0;
00643 
00644     <span class="comment">// calc after player change min_capital_reserve_balance</span>
00645 
00646     <span class="keywordtype">int</span> availableCapitalReserveFunds
00647         = beginCapitalReserve + interestReceived + transferFromBudget - min_capital_reserve_balance;
00648 
00649     <span class="comment">// need to reset this value if player don't change it!</span>
00650     <span class="comment">//  min_capital_reserve_balance = int(beginCapitalReserve * 0.6f);</span>
00651     min_capital_reserve_balance = 0.0f;
00652 
00653     <span class="comment">//askbill tell user about this:</span>
00654     <span class="keywordflow">if</span> ( availableCapitalReserveFunds &lt; 0 )
00655         availableCapitalReserveFunds = 0;
00656 
00657     <span class="comment">//----------------------//</span>
00658     <span class="comment">// New construction     //</span>
00659     <span class="comment">//----------------------//</span>
00660 
00661     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a> *deptInfo;
00662     <a class="code" href="classGeneralDepartment.html">GeneralDepartment</a>*  dept;
00663 
00664     <span class="keywordtype">int</span> deptCount = department_array.department_count;
00665     <span class="keywordtype">float</span> percentGap;                               <span class="comment">// 30% -&gt; 0.3f</span>
00666     <span class="keywordtype">int</span> sfGap;
00667     <span class="keywordtype">int</span> newSquareFoot;
00668     <span class="keywordtype">float</span> actualInvest,                             <span class="comment">// $000</span>
00669         actualDrawOnCapitalReserve,
00670         totalActualInvest = 0,
00671         totalAdditionalDebt = 0,
00672         totalRequiredDrawOnCapitalReserve = 0;        <span class="comment">// $000</span>
00673 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00674 <span class="preprocessor"></span>    <span class="keywordtype">int</span> totalAvailableSpace=0;
00675 <span class="preprocessor">#endif</span>
00676 <span class="preprocessor"></span>
00677     <span class="comment">//------ read in active department array -------//</span>
00678 
00679     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;=deptCount; i++ ) {
00680         <span class="keywordflow">if</span> ( i ) {
00681             dept    = department_array[i];
00682             deptInfo  = (department_res.info_array+department_array[i]-&gt;department_id - 1);
00683         }
00684         <span class="keywordflow">else</span> {
00685             <span class="comment">// code to handle general deparment</span>
00686             dept    = &amp;department_res.general_dept;
00687             deptInfo = &amp;department_res.general_dept_info;
00688         }
00689 
00690         sfGap = max(0, deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a> - deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a> - dept-&gt;<a class="code" href="classGeneralDepartment.html#a10">get_constructing_sf</a>());
00691 
00692 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00693 <span class="preprocessor"></span>        totalAvailableSpace += sfGap;
00694 <span class="preprocessor">#endif</span>
00695 <span class="preprocessor"></span>
00696         percentGap = float(sfGap) / deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a>;
00697 
00698         deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m23">invest_close_gap</a> = ( percentGap &gt; percent_gap_required_before_new_construction_is_considered )
00699             ? (float(sfGap) * deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m6">replacement_cost</a> / 1000) : 0;
00700 
00701         deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m24">additional_debt</a> = (deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m23">invest_close_gap</a> * float(percent_project_funded_with_debt) / 100.0f );
00702         totalAdditionalDebt += deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m24">additional_debt</a>;
00703 
00704         <a class="code" href="ALL_8H.html#a0">err_when</a>(deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m23">invest_close_gap</a>&lt;0 || deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m24">additional_debt</a> &lt; 0);
00705         <a class="code" href="ALL_8H.html#a0">err_when</a>(deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m23">invest_close_gap</a> &lt; deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m24">additional_debt</a> );
00706     }
00707 
00708     total_actual_new_debt = 0;
00709 
00710     <span class="comment">//min &amp; max bug chea</span>
00711     <span class="keywordtype">float</span> maxDebt = max(0.0f,min((<span class="keywordtype">float</span>)maxNewDebt, totalAdditionalDebt));
00712 
00713     <span class="keywordflow">for</span>( i=0 ; i&lt;=deptCount; i++ ) {
00714         <span class="keywordflow">if</span> ( i ) {
00715             dept    = department_array[i];
00716             deptInfo  = (department_res.info_array+department_array[i]-&gt;department_id - 1);
00717         }
00718         <span class="keywordflow">else</span>
00719             <span class="comment">// code to handle general deparment</span>
00720             deptInfo = &amp;department_res.general_dept_info;
00721 
00722         <span class="keywordflow">if</span> ( totalAdditionalDebt ) {
00723             <span class="comment">// avoid overflow</span>
00724             deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m21">actual_new_debt</a> = (float(deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m24">additional_debt</a>) * float(maxDebt) / totalAdditionalDebt);
00725             total_actual_new_debt += deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m21">actual_new_debt</a>;
00726             <a class="code" href="ALL_8H.html#a0">err_when</a>(deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m21">actual_new_debt</a> &lt; 0 );
00727         }
00728         <span class="keywordflow">else</span>
00729             deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m21">actual_new_debt</a> = 0;
00730 
00731         deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m22">required_draw_on_capital_reserve</a> = deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m23">invest_close_gap</a> - deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m21">actual_new_debt</a>;
00732 
00733         <span class="comment">//              if ( deptInfo-&gt;required_draw_on_capital_reserve &lt; 0 )</span>
00734         <span class="keywordflow">if</span> ( deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m22">required_draw_on_capital_reserve</a> &lt; 0 ) {
00735             deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m21">actual_new_debt</a> = deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m23">invest_close_gap</a>;
00736             <span class="comment">// 990419</span>
00737             total_actual_new_debt += deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m22">required_draw_on_capital_reserve</a>;
00738             deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m22">required_draw_on_capital_reserve</a> = 0;
00739         }
00740         <span class="keywordflow">else</span>
00741             totalRequiredDrawOnCapitalReserve += deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m22">required_draw_on_capital_reserve</a>;
00742 
00743         <a class="code" href="ALL_8H.html#a0">err_when</a>(deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m22">required_draw_on_capital_reserve</a> &lt; 0);
00744 
00745         <a class="code" href="ALL_8H.html#a0">err_when</a>(deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m23">invest_close_gap</a> &gt;= 10
00746                  &amp;&amp; deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m23">invest_close_gap</a> &lt; deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m21">actual_new_debt</a> + deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m22">required_draw_on_capital_reserve</a> - 10 );
00747     }
00748 
00749     <a class="code" href="ALL_8H.html#a0">err_when</a>(totalAdditionalDebt &lt; 0 || totalRequiredDrawOnCapitalReserve &lt; 0 || total_actual_new_debt &lt; 0);
00750 
00751     <span class="comment">//----- rows 62:67 -----//</span>
00752     <span class="keywordtype">bool</span> newConstructionAdded = <span class="keyword">false</span>;
00753 
00754 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00755 <span class="preprocessor"></span>    <span class="keywordtype">float</span> fundedByDebt = facility_office.debt_spinner_var1/100;
00756     <span class="keywordtype">int</span> investmentRequirement = int(facility_office.spinner_var4*department_res.general_dept_info.replacement_cost);
00757 
00758     <span class="keywordtype">int</span> facilityReserveRequired = investmentRequirement*(1-fundedByDebt);
00759 
00760     <span class="keywordtype">int</span> debtRequirement = investmentRequirement*fundedByDebt;
00761 <span class="preprocessor">#endif</span>
00762 <span class="preprocessor"></span>
00763     <span class="keywordflow">for</span>( i=0 ; i&lt;=deptCount; i++ ) {
00764         <span class="keywordflow">if</span> ( i ) {
00765             dept    = department_array[i];
00766             deptInfo  = (department_res.info_array+department_array[i]-&gt;department_id - 1);
00767         }
00768         <span class="keywordflow">else</span> {
00769             <span class="comment">// code to handle general deparment</span>
00770             dept    = &amp;department_res.general_dept;
00771             deptInfo = &amp;department_res.general_dept_info;
00772         }
00773 
00774         <span class="comment">//## chea 160899 (9 August 99) 10.3.3</span>
00775         <span class="keywordflow">if</span> ( totalRequiredDrawOnCapitalReserve &amp;&amp; availableCapitalReserveFunds ) {
00776             <span class="keywordtype">float</span> avaltRatio = min( 1.0f, availableCapitalReserveFunds / totalRequiredDrawOnCapitalReserve );
00777 
00778             actualDrawOnCapitalReserve = float(deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m22">required_draw_on_capital_reserve</a>) * avaltRatio;
00779         }
00780         <span class="keywordflow">else</span>
00781             actualDrawOnCapitalReserve = 0;
00782 
00783         actualDrawOnCapitalReserve = min( actualDrawOnCapitalReserve, deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m23">invest_close_gap</a> - deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m21">actual_new_debt</a>);
00784 
00785         actualInvest = actualDrawOnCapitalReserve + deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m21">actual_new_debt</a>;
00786         totalActualInvest += actualInvest;
00787 
00788 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00789 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( totalAvailableSpace != 0 )
00790             newSquareFoot = facility_office.spinner_var4*1000*max(0, deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a> - deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m19">actual_sf</a> - dept-&gt;<a class="code" href="classGeneralDepartment.html#a10">get_constructing_sf</a>())/totalAvailableSpace;
00791         <span class="keywordflow">else</span>
00792             <span class="comment">// In case totalAvailable space is 0, build space divide evenly</span>
00793             newSquareFoot = facility_office.spinner_var4*1000/(deptCount+1);
00794 <span class="preprocessor">#else</span>
00795 <span class="preprocessor"></span>        newSquareFoot = int(actualInvest * 1000 / deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m6">replacement_cost</a>);
00796 <span class="preprocessor">#endif</span>
00797 <span class="preprocessor"></span>
00798         <a class="code" href="ALL_8H.html#a0">err_when</a>(newSquareFoot&lt;0 || deptInfo-&gt;replacement_cost &lt;=0);
00799 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00800 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00801 <span class="preprocessor"></span>        <a class="code" href="ALL_8H.html#a0">err_when</a>(newSquareFoot &gt; 1.5 * deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m18">normal_sf</a>);
00802 <span class="preprocessor">#endif</span>
00803 <span class="preprocessor"></span>
00804         <span class="comment">// add this new construction into array of new construction, for each dept</span>
00805         <span class="comment">//</span>
00806 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00807 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( newSquareFoot &gt; 0 )
00808 <span class="preprocessor">#else</span>
00809 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( newSquareFoot &gt;0 &amp;&amp; actualInvest &gt;0 )
00810 <span class="preprocessor">#endif</span>
00811 <span class="preprocessor"></span>            {
00812                 <span class="comment">//</span>
00813                 construction_project_spending[THIS_YEAR] += actualInvest;
00814 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00815 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00816 <span class="preprocessor"></span>                captial_reserve_expense[<a class="code" href="Gamedef_8h.html#a82a49">H_THIS_YEAR</a>] += actualDrawOnCapitalReserve;
00817 <span class="preprocessor">#endif</span>
00818 <span class="preprocessor"></span>
00819                 <span class="comment">//</span>
00820                 dept-&gt;<a class="code" href="classGeneralDepartment.html#a8">add_construction</a>(newSquareFoot, max(1,(<span class="keywordtype">int</span>)actualInvest));
00821                 newConstructionAdded = <span class="keyword">true</span>;
00822             }
00823 
00824         <a class="code" href="ALL_8H.html#a0">err_when</a>(actualDrawOnCapitalReserve &lt; 0 || deptInfo-&gt;actual_new_debt &lt; 0);
00825     }
00826 
00827 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00828 <span class="preprocessor"></span>    captial_reserve_expense[<a class="code" href="Gamedef_8h.html#a82a49">H_THIS_YEAR</a>] += facilityReserveRequired;
00829 <span class="preprocessor">#endif</span>
00830 <span class="preprocessor"></span>
00831     <span class="comment">//-- captial_reserve_expense[H_NEXT_YEAR] has not been initalized yet, initialize it now ---//</span>
00832 
00833     <span class="keywordflow">if</span>( captial_reserve_expense[<a class="code" href="Gamedef_8h.html#a82a50">H_NEXT_YEAR</a>] == 0 )
00834         captial_reserve_expense[<a class="code" href="Gamedef_8h.html#a82a50">H_NEXT_YEAR</a>] = captial_reserve_expense[<a class="code" href="Gamedef_8h.html#a82a49">H_THIS_YEAR</a>];
00835 
00836     <span class="comment">//---------------------------//</span>
00837 
00838     <span class="keywordflow">if</span> ( newConstructionAdded ) {
00839         <span class="keywordflow">if</span> ( totalActualInvest &gt; 0 )
00840             finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a23">AC_BUILDINGS</a>] <span class="comment">// = E76 (year-end replacement cost)</span>
00841                 = finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a23">AC_BUILDINGS</a>] + totalActualInvest;
00842 
00843 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00844 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( facilityReserveRequired &gt; 0 ) {
00845             <span class="comment">//                  finance.this_year.asset_array[AC_CAPITAL_RESERVE] -= totalRequiredDrawOnCapitalReserve;  //## this should be wrong from fed</span>
00846             finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>] -= captial_reserve_expense[<a class="code" href="Gamedef_8h.html#a82a49">H_THIS_YEAR</a>];
00847             <span class="comment">//       finance.this_year.asset_array[AC_CAPITAL_RESERVE] -= actualDrawOnCapitalReserve; //## chea 160899</span>
00848         }
00849 <span class="preprocessor">#else</span>
00850 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( totalRequiredDrawOnCapitalReserve &gt; 0 ) {
00851             <span class="comment">//                  finance.this_year.asset_array[AC_CAPITAL_RESERVE] -= totalRequiredDrawOnCapitalReserve;  //## this should be wrong from fed</span>
00852             finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>] -= captial_reserve_expense[<a class="code" href="Gamedef_8h.html#a82a49">H_THIS_YEAR</a>];
00853             <span class="comment">//       finance.this_year.asset_array[AC_CAPITAL_RESERVE] -= actualDrawOnCapitalReserve; //## chea 160899</span>
00854         }
00855 <span class="preprocessor">#endif</span>
00856 <span class="preprocessor"></span>
00857 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00858 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( debtRequirement &gt; 0 ) {
00859             <span class="comment">// update the amount of debt immediately</span>
00860             finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a27">AC_GENERAL_PLANT_DEBT</a>] += debtRequirement;
00861             facility_office.outstanding_debt_balance[THIS_YEAR] = finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a27">AC_GENERAL_PLANT_DEBT</a>];
00862         }
00863 <span class="preprocessor">#else</span>
00864 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( total_actual_new_debt &gt; 0 )
00865             finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a27">AC_GENERAL_PLANT_DEBT</a>] += total_actual_new_debt;
00866 <span class="preprocessor">#endif</span>
00867 <span class="preprocessor"></span>    }
00868 
00869     finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a29">AC_LIABILITY_TOTAL</a>] = 0;
00870     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a98a26">LIABILITY_ITEM_COUNT</a>-1 ; i++ ) {
00871         finance.this_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a29">AC_LIABILITY_TOTAL</a>] += finance.this_year.liability_array[i];
00872     }
00873 
00874     <span class="comment">// assume this func called monthly</span>
00875 
00876 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00877 <span class="preprocessor"></span>    <span class="comment">// called in finance.updated_history(YEAR)</span>
00878 <span class="preprocessor">#else</span>
00879 <span class="preprocessor"></span>    <span class="comment">// 1022</span>
00880     <span class="keywordtype">double</span> bank_deposit_rate_per_month = finance.inflation_rate + .01;
00881     <span class="comment">// *12 for converting monthly rate to yearly rate as this function is called yearly</span>
00882     finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>] += bank_deposit_rate_per_month * 12 * finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>];
00883 <span class="preprocessor">#endif</span>
00884 <span class="preprocessor"></span>}
00885 
00886 <span class="comment">//------------- End of function Facility::run_new_construction --------//</span>
00887 
00888 <span class="comment">//---------- Begin of function Facility::calc_facility_staff_morale -----------//</span>
00889 <span class="keywordtype">void</span> Facility::calc_facility_staff_morale() {
00890     <span class="keyword">const</span> <span class="keywordtype">int</span> VAR_COUNT = 3;
00891     <span class="keywordtype">int</span> i;
00892     <span class="keywordtype">float</span> input[VAR_COUNT];
00893     memset(input, 0, <span class="keyword">sizeof</span>(input));
00894 
00895     <span class="comment">//--------------//</span>
00896     input[0] = player_school.staff_morale;
00897 
00898     <span class="comment">//--------------//</span>
00899     input[1] = 100*float(<a class="code" href="classFacility.html#m26">onm_n_backlog_history</a>[<a class="code" href="Gamedef_8h.html#a82a56">SECOND_H_THIS_YEAR</a>]) / float(finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a23">AC_BUILDINGS</a>]);
00900 
00901     <span class="comment">//--------------//</span>
00902     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a> *deptInfo;
00903     <span class="keywordtype">int</span> deptCount = department_array.department_count;
00904     <a class="code" href="classFacility.html#m19">total_invest_close_gap</a> = 0;
00905 
00906     <span class="keywordflow">for</span>( i=0 ; i&lt;=deptCount; i++ ) {
00907         <span class="keywordflow">if</span> ( i ) {
00908             deptInfo  = (department_res.info_array+department_array[i]-&gt;department_id - 1 );
00909         }
00910         <span class="keywordflow">else</span> {
00911             deptInfo = &amp;department_res.general_dept_info;
00912         }
00913 
00914         <a class="code" href="classFacility.html#m19">total_invest_close_gap</a> += deptInfo-&gt;<a class="code" href="structGeneralDepartmentInfo.html#m23">invest_close_gap</a>;
00915     }
00916 
00917     input[2] = 100*float(<a class="code" href="classFacility.html#m19">total_invest_close_gap</a>) / float(finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a23">AC_BUILDINGS</a>]);
00918 
00919     <a class="code" href="ALL_8H.html#a0">err_when</a>( finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a23">AC_BUILDINGS</a>] &lt;= 0 );
00920 
00921     <span class="comment">//--------------//</span>
00922     input[1] = math.dual_response_func(0,60.74f,100,-7.15f,-5.94f,16.41f,3.95f, input[1]);
00923     input[2] = math.dual_response_func(0,68.17f,100,-13.40f,-7.24f,20.54f,4.32f, input[2]);
00924 
00925     <span class="keywordtype">float</span> weight[VAR_COUNT] = {0.50f, 0.30f, 0.2f, };
00926 
00927     <span class="keywordtype">float</span> newValue = 0;
00928     <span class="keywordflow">for</span>(i=0; i&lt;VAR_COUNT; i++)
00929         newValue += weight[i] * input[i];
00930 
00931     <span class="comment">//min &amp; max bug chea</span>
00932     <a class="code" href="classFacility.html#m17">facility_staff_morale</a> = max(0.0f,min(100.0f,player_school.latency_func( 0.1f, <a class="code" href="classFacility.html#m17">facility_staff_morale</a>, newValue)));
00933 
00934     <span class="comment">//--------------//</span>
00935     <a class="code" href="classFacility.html#m17">facility_staff_morale</a> *= (float) finance.cost_rise_policy_array[<a class="code" href="Ofinance_8h.html#a112a84">PL_OPERATIONS_AND_MAINTENANCE</a>].penalty_multiplier1;
00936 
00937     <span class="comment">//min &amp; max bug chea</span>
00938     <a class="code" href="classFacility.html#m17">facility_staff_morale</a> = max(0.0f,min(100.0f,<a class="code" href="classFacility.html#m17">facility_staff_morale</a>));
00939 }
00940 
00941 <span class="comment">//---------- End of function Facility::calc_facility_staff_morale -----------//</span>
00942 
00943 <span class="comment">//----------- Begin of function Facility::update_parking --------//</span>
<a name="l00945"></a><a class="code" href="classFacility.html#a14">00945</a> <span class="comment">void Facility::update_parking(bool init) {</span>
00946     <span class="comment">//------------------//</span>
00947     <span class="comment">//990104 Parking and Crime model; see design response 0805.</span>
00948 
00949     <span class="keywordtype">int</span> demandVar[<a class="code" href="Ofaci__st_8cpp.html#a2a1">COEF_COUNT</a>];
00950     <span class="keywordtype">int</span> totalDemand = 0;
00951 
00952     demandVar[0] = department_array.faculty_level_history[<a class="code" href="Ofaculty_8h.html#a26a8">FACULTY_RANK_LEVEL_COUNT</a>][THIS_YEAR];
00953     demandVar[1] = int(finance.total_expense.staff / 65000000);
00954 
00955     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; i++)
00956         demandVar[i+2] = department_array.student_level_history[i][THIS_YEAR];
00957 
00958     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x=0; x&lt;<a class="code" href="Ofaci__st_8cpp.html#a2a1">COEF_COUNT</a>; x++)
00959         totalDemand += int(parking_demand_coef[player_school.campus_environment][x] * demandVar[x]);
00960 
00961     <span class="comment">//------------------//</span>
00962 
00963     <span class="keywordflow">if</span> ( init ) {
00964         <span class="keyword">const</span> <span class="keywordtype">float</span> meanByEnvir[<a class="code" href="Opschool_8h.html#a62a20">ENVIRONMENT_COUNT</a>] = { 1.0f, 1.1f, 1.2f };
00965         <span class="keywordtype">float</span> mean = meanByEnvir[player_school.campus_environment];
00966 
00967         <span class="comment">// initialize as close-in supply</span>
00968         cur_parking_supply = int(totalDemand * math.get_random_snd(mean, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(mean*0.1f)));
00969         projected_parking_supply = cur_parking_supply;
00970 
00971         farout_capacity = int(cur_parking_supply * math.get_random_snd(1.3f , <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.1f)));
00972     }
00973 
00974     <span class="keywordflow">if</span> ( !init &amp;&amp; totalDemand &gt; cur_parking_supply ) {
00975         <span class="keywordflow">if</span> ( player_school.campus_environment == <a class="code" href="Opschool_8h.html#a62a19">RURAL</a> )
00976             cur_parking_supply = totalDemand;           <span class="comment">// add far-out lots</span>
00977         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( player_school.campus_environment == <a class="code" href="Opschool_8h.html#a62a18">SUBURBAN</a> &amp;&amp; farout_capacity &gt; 0 ) {
00978             <span class="keywordtype">int</span> newSpace = min(farout_capacity, totalDemand - cur_parking_supply);
00979 
00980             farout_capacity -= newSpace;
00981             cur_parking_supply += newSpace;             <span class="comment">// add far-out lots</span>
00982         }
00983         <span class="keywordflow">else</span> {                                        <span class="comment">// build close-in structure</span>
00984             <span class="comment">// option 1: build structure instantly</span>
00985 
00986             <span class="comment">// 30: $30,000 per space</span>
00987             finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>] -= 30 * (totalDemand - cur_parking_supply);
00988 
00989             projected_parking_supply = totalDemand;
00990             cur_parking_supply = projected_parking_supply;
00991 
00992             <span class="comment">// option 2: use normal facilities construction procedure</span>
00993         }
00994     }
00995 
00996     <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(parking_demand, HISTORY_YEAR_COUNT);
00997     <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(parking_supply, HISTORY_YEAR_COUNT);
00998 
00999     parking_demand[THIS_YEAR] = cur_parking_supply;
01000     parking_supply[THIS_YEAR] = totalDemand;
01001 
01002     <span class="keywordflow">if</span> ( init ) {
01003         <a class="code" href="ALL_8H.html#a0">err_when</a>(totalDemand &lt;= 0);
01004         <a class="code" href="ALL_8H.html#a0">err_when</a>(cur_parking_supply &lt;= 0);
01005 
01006         <span class="keywordflow">for</span> (i = THIS_YEAR; i&gt;=THIS_YEAR-1; i--) {
01007             parking_demand[i-1] = parking_demand[i];
01008             parking_supply[i-1] = parking_supply[i];
01009         }
01010     }
01011 }
01012 
01013 <span class="comment">//------------- End of function Facility::update_parking --------//</span>
01014 
01015 <span class="comment">//----------- Begin of function Facility::update_crime --------//</span>
<a name="l01017"></a><a class="code" href="classFacility.html#a15">01017</a> <span class="comment">void Facility::update_crime(bool init) {</span>
01018     <span class="keyword">static</span> <span class="keywordtype">float</span> initAdminRatio = float(finance.projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].this_year.total / finance.projected_total_operating_expense.this_year.total ) ;
01019 
01020     <span class="comment">//------------------//</span>
01021     <span class="comment">//990106 Parking and Crime model; see design response 0805.</span>
01022 
01023     <span class="comment">// var 40 in response_func</span>
01024 
01025     <span class="keyword">static</span> <span class="keywordtype">float</span> currCrime=0;
01026     <span class="keywordtype">int</span> i;
01027 
01028     <span class="comment">//------------------//</span>
01029     <span class="keyword">const</span> <span class="keywordtype">int</span> VAR_COUNT = 4;
01030     <span class="keywordtype">float</span> input[VAR_COUNT];
01031 
01032     <span class="comment">//------------------//</span>
01033     <span class="keyword">const</span> <span class="keywordtype">int</span> remap[<a class="code" href="Opschool_8h.html#a62a20">ENVIRONMENT_COUNT</a>]={3,2,1};
01034     input[0] = 25 * (float) remap[player_school.campus_environment];
01035 
01036     <span class="comment">//------------------//</span>
01037     input[1] = (float) ((finance.projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].this_year.total / finance.projected_total_operating_expense.this_year.total ) / initAdminRatio);
01038 
01039     <span class="comment">//------------------//</span>
01040     input[2] = player_school.sub_score[<a class="code" href="Opschool_8h.html#a65a46">S_STUDENT_MORALE</a>][THIS_MONTH];
01041 
01042     <span class="comment">//------------------//</span>
01043     input[3] = player_school.staff_morale;
01044 
01045     <span class="comment">//------------------//</span>
01046     input[1] = math.single_response_func(1,100,1.900f, 1.047f, input[1]);
01047     input[2] = math.dual_response_func(1, 50.1f, 100, -40.21f, -24.36f, 69.78f, 20.19f, input[2]);
01048     input[3] = math.dual_response_func(1, 51.5f, 100, -51.33f, -27.54f, 62.25f, 16.38f, input[3]);
01049 
01050     <span class="keyword">const</span> <span class="keywordtype">float</span> weight[VAR_COUNT] = { 0.40f,0.35f,0.15f,0.10f };
01051     <span class="keywordtype">float</span> newValue=0;
01052 
01053     <span class="keywordflow">for</span> (i=0;i&lt;VAR_COUNT;i++)
01054         newValue  += weight[i] * input[i];
01055 
01056     currCrime = player_school.latency_func(0.1f, newValue, currCrime);
01057 
01058     <span class="comment">//------------------//</span>
01059 
01060     <span class="comment">//min &amp; max bug chea</span>
01061     currCrime = m.fmin(100.0f, m.fmax(0.0f,math.get_random_snd(currCrime, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(currCrime * 0.075f))));
01062 
01063     <a class="code" href="Gamedef_8h.html#a14">shift_history</a>(crime_index, HISTORY_MONTH_COUNT);
01064     crime_index[THIS_MONTH] = (char) player_school.latency_func(0.5f, currCrime, crime_index[THIS_MONTH]);
01065 
01066     <span class="keywordflow">if</span> ( init ) {
01067         <span class="keywordflow">for</span> (i = THIS_MONTH; i&gt;=THIS_MONTH-1; i--) {
01068             crime_index[i-1] = crime_index[i];
01069         }
01070     }
01071 }
01072 
01073 <span class="comment">//------------- End of function Facility::update_crime --------//</span>
01074 
01075 <span class="comment">// ##### Begin Marco ##### //</span>
01076 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01077 <span class="preprocessor"></span><span class="comment">// --------- Begin of function Facility::save_initial_data ------- //</span>
01078 <span class="keywordtype">void</span> Facility::save_initial_data() {
01079     initial_total_invest_close_gap = <a class="code" href="classFacility.html#m19">total_invest_close_gap</a>;
01080 
01081     <span class="comment">//  for (int i = 0; i &lt; HISTORY_YEAR_COUNT; i++)</span>
01082     <span class="comment">//          initial_captial_reserve_expense[i] = captial_reserve_expense[i];</span>
01083     initial_captial_reserve_expense = <a class="code" href="classFacility.html#m29">captial_reserve_expense</a>[<a class="code" href="Gamedef_8h.html#a82a48">H_PREV_YEAR</a>];
01084     initial_crime_index = <a class="code" href="classFacility.html#m35">crime_index</a>[THIS_MONTH];  <span class="comment">// 0-100</span>
01085     initial_normal_area = <a class="code" href="classFacility.html#m20">normal_area</a>[THIS_MONTH];
01086     initial_actual_area = <a class="code" href="classFacility.html#m21">actual_area</a>[THIS_MONTH];
01087     initial_projected_area = <a class="code" href="classFacility.html#m22">projected_area</a>[THIS_MONTH];
01088 }
01089 
01090 <span class="comment">// --------- End of function Facility::save_initial_data ------- //</span>
01091 <span class="preprocessor">#endif</span>
01092 <span class="preprocessor"></span><span class="comment">// ##### End Marco ##### //</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:31 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
