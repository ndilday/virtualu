<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Oprint.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Oprint.cpp</h1><a href="Oprint_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OPRINT.CPP</span>
00002 <span class="comment">//Description : A collection of print objects</span>
00003 
00004 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00005 <span class="preprocessor">#include &lt;string.h&gt;</span>
00006 <span class="preprocessor">#include &lt;commdlg.h&gt;</span>
00007 <span class="preprocessor">#include "oprint.h"</span>
00008 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="OCOLTBL_8H.html">OCOLTBL.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00012 
00013 <span class="comment">//printint order:</span>
00014 <span class="comment">//step1: use start_print(); to start printing doc.</span>
00015 <span class="comment">//step2: use open_page(); to start a new page</span>
00016 <span class="comment">//step3: set font by using dfont(); and put_? functions to add text or bmp</span>
00017 <span class="comment">//setp4: use end_page();to end a page</span>
00018 <span class="comment">//step5: use endprint(); to end printing doc</span>
00019 
00020 <span class="comment">// ###### begin Gilbert 27/04/2001 ######//</span>
<a name="l00021"></a><a class="code" href="classPrint.html#a0">00021</a> <a class="code" href="classPrint.html#a0">Print::Print</a>() {
00022     memset(<span class="keyword">this</span>, 0, <span class="keyword">sizeof</span>(*<span class="keyword">this</span>) );
00023 }
00024 
<a name="l00025"></a><a class="code" href="classPrint.html#a1">00025</a> <a class="code" href="classPrint.html#a1">Print::~Print</a>() {
00026     <a class="code" href="classPrint.html#a3">deinit</a>();
00027 }
00028 
<a name="l00029"></a><a class="code" href="classPrint.html#a2">00029</a> <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a2">Print::init</a>() {
00030     <a class="code" href="classPrint.html#a3">deinit</a>();
00031 }
00032 
<a name="l00033"></a><a class="code" href="classPrint.html#a3">00033</a> <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a3">Print::deinit</a>() {
00034     <span class="keywordflow">if</span>( hImage )
00035         DeleteObject(hImage);
00036     hImage = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00037 
00038     <span class="keywordflow">if</span>( printdlg.hDC )
00039         DeleteDC(printdlg.hDC);
00040     printdlg.hDC = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00041 
00042     <span class="keywordflow">if</span>( memDC )
00043         DeleteDC(memDC);
00044     memDC = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00045 
00046     <span class="keywordflow">if</span>( hdc &amp;&amp; hwnd_of_hdc ) {
00047         ReleaseDC(hwnd_of_hdc, hdc);
00048         hdc = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00049     }
00050 
00051     <span class="keywordflow">if</span>( hfont )
00052         DeleteObject(hfont);
00053     hfont = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00054 }
00055 
00056 <span class="comment">// ###### end Gilbert 27/04/2001 ######//</span>
00057 
00058 <span class="comment">//Initialize PRINTDLG structure.</span>
00059 <span class="comment">// #### begin Gilbert 27/04/2001 #####//</span>
00060 <span class="comment">// rename var printdlg to printDlg to avoid collision with member</span>
00061 <span class="keywordtype">void</span> Print::print_init(PRINTDLG *printDlg, HWND hwnd,HINSTANCE hThisins) {
00062     printDlg-&gt;lStructSize = <span class="keyword">sizeof</span>(PRINTDLG);
00063     printDlg-&gt;hwndOwner = hwnd;
00064     printDlg-&gt;hDevMode = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00065     printDlg-&gt;hDevNames =<a class="code" href="OHELP_8H.html#a0">NULL</a>;
00066     printDlg-&gt;hDC = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00067     printDlg-&gt;Flags = PD_RETURNDC|PD_RETURNDEFAULT|PD_PRINTSETUP|PD_HIDEPRINTTOFILE|PD_ENABLESETUPTEMPLATE;
00068     printDlg-&gt;nFromPage = 0;
00069     printDlg-&gt;nToPage = 0;
00070     printDlg-&gt;nMinPage = 0;
00071     printDlg-&gt;nMaxPage = 0;
00072     printDlg-&gt;nCopies = 1;
00073     printDlg-&gt;hInstance =hThisins;
00074     printDlg-&gt;lCustData = 0;
00075     printDlg-&gt;lpfnPrintHook = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00076     printDlg-&gt;lpfnSetupHook = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00077     printDlg-&gt;lpPrintTemplateName = <span class="stringliteral">"mydlg"</span>;
00078     printDlg-&gt;lpSetupTemplateName = <span class="stringliteral">"mydlg"</span>;
00079     printDlg-&gt;hPrintTemplate = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00080     printDlg-&gt;hSetupTemplate =<a class="code" href="OHELP_8H.html#a0">NULL</a>;
00081 }
00082 
00083 <span class="comment">// #### end Gilbert 27/04/2001 #####//</span>
00084 
<a name="l00085"></a><a class="code" href="classPrint.html#a4">00085</a> <span class="keywordtype">int</span> <a class="code" href="classPrint.html#a4">Print::start_print</a>(HWND ohwnd,HINSTANCE hThis) {
00086     hdc = GetDC(ohwnd);
00087     <span class="comment">// ##### begin Gilbert 27/04/2001 ######//</span>
00088     hwnd_of_hdc = ohwnd;
00089     <span class="comment">// ##### end Gilbert 27/04/2001 ######//</span>
00090     memDC = CreateCompatibleDC(hdc);
00091 
00092     print_init(&amp;printdlg, ohwnd, hThis);
00093     <span class="keywordflow">if</span>(!PrintDlg(&amp;printdlg))
00094         <span class="keywordflow">return</span> 0;
00095 
00096     docinfo.cbSize = <span class="keyword">sizeof</span>(DOCINFO);
00097     docinfo.lpszDocName = <span class="stringliteral">"Printing bitmaps"</span>;
00098     docinfo.lpszOutput = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00099     docinfo.lpszDatatype = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00100     docinfo.fwType = 0;
00101 
00102     <span class="keywordflow">if</span>(!(GetDeviceCaps(printdlg.hDC, RASTERCAPS)  &amp; (RC_BITBLT | RC_STRETCHBLT|RC_BITMAP64 |
00103                                                      RC_DI_BITMAP| RC_DIBTODEV |RC_PALETTE |RC_SCALING |RC_STRETCHBLT|RC_STRETCHDIB))) {
00104         <span class="comment">// MessageBox(ohwnd, "Cannot Print Raster Images", "Error", MB_OK);</span>
00105         <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00106     }
00107 
00108     StartDoc(printdlg.hDC, &amp;docinfo);
00109 
00110     <span class="keywordflow">return</span> 1;
00111 }
00112 
<a name="l00113"></a><a class="code" href="classPrint.html#a5">00113</a> <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a5">Print::open_page</a>() {
00114     <span class="comment">//obtain pixels-per-inch</span>
00115     VidXPPI = GetDeviceCaps(memDC, LOGPIXELSX);
00116     VidYPPI = GetDeviceCaps(memDC, LOGPIXELSY);
00117     PrXPPI = GetDeviceCaps(printdlg.hDC, LOGPIXELSX);
00118     PrYPPI = GetDeviceCaps(printdlg.hDC, LOGPIXELSY);
00119 
00120     <span class="comment">//get scaling ratios</span>
00121     Xratio = (PrXPPI / VidXPPI)*2/3;
00122     Yratio = (PrYPPI / VidYPPI)*2/3;
00123 
00124     StartPage(printdlg.hDC);
00125 }
00126 
<a name="l00127"></a><a class="code" href="classPrint.html#a6">00127</a> <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a6">Print::put_bitmap_center</a>(<span class="keywordtype">char</span>* name,<span class="keywordtype">int</span> BMPWIDTH,<span class="keywordtype">int</span> BMPHEIGHT,<span class="keywordtype">double</span> pageprotion,<span class="keywordtype">int</span> xcor,<span class="keywordtype">int</span> ycor) {
00128     <span class="comment">//Load Bitmap into hImage</span>
00129     hImage = (HBITMAP)LoadImage(0, name, IMAGE_BITMAP, 0, 0,
00130                                 LR_LOADFROMFILE|LR_CREATEDIBSECTION|LR_DEFAULTCOLOR|LR_LOADMAP3DCOLORS );
00131 
00132     <span class="comment">// put bitmap image into memory DC</span>
00133 
00134     SelectObject(memDC, hImage); {
00135         <span class="comment">// in some machine, StretchBlt cut area from bottom to top, may related to SetMapMode</span>
00136 
00137         <span class="keyword">static</span> writeMapMode = 0;
00138         FILE *mapModeLog = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00139         <span class="keywordtype">int</span> mapMode;
00140         SIZE windowExt, viewportExt;
00141         <span class="keywordflow">if</span>( !writeMapMode )
00142             mapModeLog = fopen(<span class="stringliteral">"mapmode.log"</span>, <span class="stringliteral">"w"</span>);
00143 
00144         <span class="keywordflow">if</span>( mapModeLog )
00145             fprintf( mapModeLog, <span class="stringliteral">"memDC map mode : %x\n"</span>, (mapMode = GetMapMode(memDC)) );
00146         <span class="keywordflow">if</span>( mapMode == MM_ANISOTROPIC || mapMode == MM_ISOTROPIC ) {
00147             GetWindowExtEx(memDC, &amp;windowExt);
00148             GetViewportExtEx(memDC, &amp;viewportExt);
00149             <span class="keywordflow">if</span>( mapModeLog ) {
00150                 fprintf( mapModeLog, <span class="stringliteral">"memDC WindowExt : %d, %d\n"</span>, windowExt.cx, windowExt.cy );
00151                 fprintf( mapModeLog, <span class="stringliteral">"memDC ViewportExt : %d, %d\n"</span>, viewportExt.cx, viewportExt.cy );
00152             }
00153         }
00154         <span class="keywordflow">if</span>( mapModeLog )
00155             fprintf( mapModeLog, <span class="stringliteral">"memDC LOGPIXELSX, LOGPIXELSY: %d, %d\n"</span>, GetDeviceCaps(memDC,LOGPIXELSX), GetDeviceCaps(memDC,LOGPIXELSY) );
00156 
00157         <span class="keywordflow">if</span>( mapModeLog )
00158             fprintf( mapModeLog, <span class="stringliteral">"printdlg.hDC map mode : %x\n"</span>, (mapMode = GetMapMode(printdlg.hDC)) );
00159         <span class="keywordflow">if</span>( mapMode == MM_ANISOTROPIC || mapMode == MM_ISOTROPIC ) {
00160             GetWindowExtEx(printdlg.hDC, &amp;windowExt);
00161             GetViewportExtEx(printdlg.hDC, &amp;viewportExt);
00162             <span class="keywordflow">if</span>( mapModeLog ) {
00163                 fprintf( mapModeLog, <span class="stringliteral">"printdlg.hDC WindowExt : %d, %d\n"</span>, windowExt.cx, windowExt.cy );
00164                 fprintf( mapModeLog, <span class="stringliteral">"printdlg.hDC ViewportExt : %d, %d\n"</span>, viewportExt.cx, viewportExt.cy );
00165             }
00166         }
00167         <span class="keywordflow">if</span>( mapModeLog )
00168             fprintf( mapModeLog, <span class="stringliteral">"printdlg.hDC LOGPIXELSX, LOGPIXELSY: %d, %d\n"</span>, GetDeviceCaps(printdlg.hDC, LOGPIXELSX), GetDeviceCaps(printdlg.hDC, LOGPIXELSY) );
00169 
00170         <span class="keywordflow">if</span>( mapModeLog )
00171             fclose(mapModeLog);
00172         writeMapMode = 1;
00173     }
00174 
00175     <span class="comment">// copy bitmap while maintaining perspective</span>
00176     <span class="keywordtype">int</span> xpagepos,ypagepos,pagew,pageh;
00177 
00178     pagew = GetDeviceCaps(printdlg.hDC,PHYSICALWIDTH);
00179     xpagepos = (int)((pagew-(BMPWIDTH*Xratio))/2);  <span class="comment">/*1.3*/</span>
00180     pageh = GetDeviceCaps(printdlg.hDC,PHYSICALHEIGHT);
00181     ypagepos = (int)(pageh*pageprotion);
00182     StretchBlt(printdlg.hDC,xpagepos,ypagepos,
00183                (<span class="keywordtype">int</span>) (BMPWIDTH*Xratio),                      <span class="comment">//*1.3),</span>
00184                (<span class="keywordtype">int</span>) (BMPHEIGHT*Yratio),                     <span class="comment">//*1.2),</span>
00185                memDC, xcor, ycor,
00186                BMPWIDTH, BMPHEIGHT,
00187                SRCCOPY);
00188 
00189     <span class="comment">// ##### begin Gilbert 24/04/2001</span>
00190     <span class="comment">// free hImage</span>
00191     DeleteObject(hImage);
00192     hImage = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00193     <span class="comment">// ##### end Gilbert 24/04/2001</span>
00194 }
00195 
<a name="l00196"></a><a class="code" href="classPrint.html#a7">00196</a> <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a7">Print::put_bitmap</a>(<span class="keywordtype">char</span>* name,<span class="keywordtype">int</span> BMPWIDTH,<span class="keywordtype">int</span> BMPHEIGHT,<span class="keywordtype">double</span> xposition,<span class="keywordtype">double</span> yposition,<span class="keywordtype">int</span> xcor,<span class="keywordtype">int</span> ycor) {
00197     <span class="comment">//Load Bitmap into hImage</span>
00198     <span class="comment">//hImage = (HBITMAP)LoadImage(0, name, IMAGE_BITMAP, 0, 0,</span>
00199     <span class="comment">//  LR_LOADFROMFILE|LR_CREATEDIBSECTION|LR_DEFAULTCOLOR|LR_LOADMAP3DCOLORS );</span>
00200 
00201     <span class="comment">// put bitmap image into memory DC</span>
00202     <span class="comment">//SelectObject(memDC, hImage);</span>
00203 
00204     <span class="comment">// copy bitmap while maintaining perspective</span>
00205 
00206     <span class="keywordtype">int</span> xpagepos,ypagepos,pagew,pageh;
00207 
00208     <span class="comment">// pagew= GetDeviceCaps(printdlg.hDC,ASPECTX);</span>
00209     pagew= GetDeviceCaps(printdlg.hDC,PHYSICALWIDTH);
00210     xpagepos=(int)(xposition*pagew);
00211     <span class="comment">// pageh= GetDeviceCaps(printdlg.hDC,ASPECTY);</span>
00212     pageh= GetDeviceCaps(printdlg.hDC,PHYSICALHEIGHT);
00213     ypagepos=(int)(yposition*pageh);
00214 
00215     StretchBlt(printdlg.hDC,xpagepos,ypagepos,
00216                (<span class="keywordtype">int</span>) (BMPWIDTH*Xratio),                      <span class="comment">//*1.3),</span>
00217                (<span class="keywordtype">int</span>) (BMPHEIGHT*Yratio),                     <span class="comment">//*1.2),</span>
00218                memDC, xcor, ycor,
00219                BMPWIDTH, BMPHEIGHT,
00220                SRCCOPY);
00221 
00222     <span class="comment">// ##### begin Gilbert 24/04/2001 ######//</span>
00223     <span class="comment">// free hImage</span>
00224     <span class="comment">//DeleteObject(hImage);</span>
00225     <span class="comment">//hImage = NULL;</span>
00226     <span class="comment">// ##### end Gilbert 24/04/2001 ######//</span>
00227 }
00228 
00229 <span class="comment">/*</span>
00230 <span class="comment">void Print::put_bitmap_bot(char* name,int BMPWIDTH,int BMPHEIGHT,double xprotion,double yprotion,int xcor,int ycor)</span>
00231 <span class="comment">{</span>
00232 <span class="comment">  //Load Bitmap into hImage</span>
00233 <span class="comment">  hImage = LoadImage(0, name, IMAGE_BITMAP, 0, 0,LR_LOADFROMFILE|LR_CREATEDIBSECTION);</span>
00234 <span class="comment">  // put bitmap image into memory DC</span>
00235 <span class="comment">  SelectObject(memDC, hImage);</span>
00236 <span class="comment"></span>
00237 <span class="comment">  // copy bitmap while maintaining perspective</span>
00238 <span class="comment">  int xpagepos,ypagepos,pagew,pageh;</span>
00239 <span class="comment"></span>
00240 <span class="comment">pagew = GetDeviceCaps(printdlg.hDC,PHYSICALWIDTH);</span>
00241 <span class="comment">xpagepos = (int)(pagew-(pagew/xprotion));</span>
00242 <span class="comment"></span>
00243 <span class="comment">pageh = GetDeviceCaps(printdlg.hDC,PHYSICALHEIGHT);</span>
00244 <span class="comment">ypagepos = (int)(pageh-(pageh/yprotion));</span>
00245 <span class="comment"></span>
00246 <span class="comment">StretchBlt(printdlg.hDC,xpagepos,ypagepos,</span>
00247 <span class="comment">(int) (BMPWIDTH*Xratio*1.3),</span>
00248 <span class="comment">(int) (BMPHEIGHT*Yratio*1.2),</span>
00249 <span class="comment">memDC, xcor, ycor,</span>
00250 <span class="comment">BMPWIDTH, BMPHEIGHT,</span>
00251 <span class="comment">SRCCOPY);</span>
00252 <span class="comment"></span>
00253 <span class="comment">// ###### begin Gilbert 27/04/2001 ######//</span>
00254 <span class="comment">DeleteObject(hImage);</span>
00255 <span class="comment">hImage = NULL;</span>
00256 <span class="comment">// ###### end Gilbert 27/04/2001 ######//</span>
00257 <span class="comment">}</span>
00258 <span class="comment">*/</span>
00259 
<a name="l00260"></a><a class="code" href="classPrint.html#a8">00260</a> <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a8">Print::put_vga_back_center</a>(<span class="keywordtype">char</span>* name,<span class="keywordtype">int</span> BMPWIDTH,<span class="keywordtype">int</span> BMPHEIGHT,<span class="keywordtype">double</span> pageprotion,<span class="keywordtype">int</span> xcor,<span class="keywordtype">int</span> ycor) {
00261     <a class="code" href="classVgaBuf.html">VgaBuf</a> *vgaBuf = &amp;vga_back;
00262 
00263 <span class="preprocessor">#if(0)</span>
00264 <span class="preprocessor"></span>
00265     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a25">write_bmp_file</a>( name );                 <span class="comment">// capture whole screen, but some computers have bug, capture from bottom to top in stretchBit</span>
00266     <a class="code" href="classPrint.html#a6">put_bitmap_center</a>(name, BMPWIDTH, BMPHEIGHT, pageprotion, xcor, ycor);
00267 
00268 <span class="preprocessor">#elif(0)                                        // use capture screen, but need write to harddisk</span>
00269 <span class="preprocessor"></span>
00270     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a26">write_bmp_file_area</a>( name, xcor, ycor, xcor+BMPWIDTH-1, ycor+BMPHEIGHT-1 );
00271     <span class="comment">// (0,0), not (xcor,ycor)</span>
00272     <a class="code" href="classPrint.html#a6">put_bitmap_center</a>(name, BMPWIDTH, BMPHEIGHT, pageprotion, 0, 0);
00273 
00274 <span class="preprocessor">#elif(1)</span>
00275 <span class="preprocessor"></span>
00276     <span class="keyword">const</span> bytePerPixel = 3;
00277     <span class="comment">// 3 byte per pixel, round-up to next DWORD boundary</span>
00278     <span class="keywordtype">long</span> bitmapPitch = (BMPWIDTH * bytePerPixel + 3) &amp; ~3;
00279     BYTE *bitmapDataBuf = (BYTE *)<a class="code" href="ALL_8H.html#a5">mem_add</a>( bitmapPitch * BMPHEIGHT );
00280 
00281     <span class="comment">// BITMAPINFO *bitmapInfo = (BITMAPINFO *)mem_add( sizeof(BITMAPINFOHEADER) + 256 * sizeof(RGBQUAD) ); // paletted bitmap</span>
00282     BITMAPINFO *bitmapInfo = (BITMAPINFO *)<a class="code" href="ALL_8H.html#a5">mem_add</a>( <span class="keyword">sizeof</span>(BITMAPINFOHEADER) );
00283 
00284     memset( &amp;bitmapInfo-&gt;bmiHeader, 0, <span class="keyword">sizeof</span>(BITMAPINFOHEADER) );
00285     bitmapInfo-&gt;bmiHeader.biSize = <span class="keyword">sizeof</span>(BITMAPINFOHEADER);
00286     bitmapInfo-&gt;bmiHeader.biWidth = BMPWIDTH;
00287     bitmapInfo-&gt;bmiHeader.biHeight = BMPHEIGHT;
00288     bitmapInfo-&gt;bmiHeader.biPlanes = 1;
00289     bitmapInfo-&gt;bmiHeader.biBitCount = bytePerPixel * 8;
00290     bitmapInfo-&gt;bmiHeader.biCompression = BI_RGB;
00291     bitmapInfo-&gt;bmiHeader.biSizeImage = bitmapPitch * BMPHEIGHT;
00292     bitmapInfo-&gt;bmiHeader.biXPelsPerMeter = 0;
00293     bitmapInfo-&gt;bmiHeader.biYPelsPerMeter = 0;
00294     bitmapInfo-&gt;bmiHeader.biClrUsed = 0;
00295     bitmapInfo-&gt;bmiHeader.biClrImportant = 0;
00296 
00297     <span class="comment">// set from bottom to top</span>
00298 
00299     BYTE *rowPtr = (BYTE *)bitmapDataBuf;
00300     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> cy = ycor+BMPHEIGHT-1; cy &gt;= ycor; --cy, rowPtr+=bitmapPitch ) {
00301         <span class="keywordtype">short</span> *readPtr = vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a0">buf_ptr</a>( xcor, cy);
00302         BYTE *writePtr = rowPtr;
00303         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> cx = xcor; cx &lt; xcor+BMPWIDTH; ++cx, ++readPtr, writePtr+=bytePerPixel ) {
00304             <a class="code" href="structRGBColor.html">RGBColor</a> rgbColor;
00305             <span class="comment">// only for bytePerPixel is 3</span>
00306             vga.decode_pixel( *readPtr, &amp;rgbColor );
00307             <span class="comment">// to make the printing output clearer</span>
00308             writePtr[0] = rgbColor.<a class="code" href="structRGBColor.html#m2">blue</a>&gt;=0xf8 ? 0xff : rgbColor.<a class="code" href="structRGBColor.html#m2">blue</a>;
00309             writePtr[1] = rgbColor.<a class="code" href="structRGBColor.html#m1">green</a>&gt;=0xf8 ? 0xff : rgbColor.<a class="code" href="structRGBColor.html#m1">green</a>;
00310             writePtr[2] = rgbColor.<a class="code" href="structRGBColor.html#m0">red</a>&gt;=0xf8 ? 0xff : rgbColor.<a class="code" href="structRGBColor.html#m0">red</a>;
00311         }
00312         <span class="comment">// pad zero until bitmapPitch</span>
00313         memset( writePtr, 0, rowPtr+bitmapPitch-writePtr);
00314     }
00315 
00316     <span class="comment">// copy bitmap while maintaining perspective</span>
00317     <span class="keywordtype">int</span> xpagepos,ypagepos,pagew,pageh;
00318 
00319     pagew = GetDeviceCaps(printdlg.hDC,PHYSICALWIDTH);
00320     xpagepos = (int)((pagew-(BMPWIDTH*Xratio))/2);  <span class="comment">/*1.3*/</span>
00321     pageh = GetDeviceCaps(printdlg.hDC,PHYSICALHEIGHT);
00322     ypagepos = (int)(pageh*pageprotion);
00323 
00324     StretchDIBits(printdlg.hDC,xpagepos,ypagepos,
00325                   (<span class="keywordtype">int</span>) (BMPWIDTH*Xratio),                      <span class="comment">//*1.3),</span>
00326                   (<span class="keywordtype">int</span>) (BMPHEIGHT*Yratio),                     <span class="comment">//*1.2),</span>
00327                   0, 0,                                         <span class="comment">// not xcor, ycor, as the (0,0)bitmapDataPtr is (xcor, ycor) of vgaBuf</span>
00328                   BMPWIDTH, BMPHEIGHT,
00329                   bitmapDataBuf, bitmapInfo, DIB_RGB_COLORS,
00330                   SRCCOPY);
00331 
00332     <span class="comment">// free memory</span>
00333     <a class="code" href="ALL_8H.html#a8">mem_del</a>( bitmapDataBuf );
00334     <a class="code" href="ALL_8H.html#a8">mem_del</a>( bitmapInfo );
00335 <span class="preprocessor">#else</span>
00336 <span class="preprocessor"></span><span class="preprocessor">#error</span>
00337 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00338 <span class="preprocessor"></span>}
00339 
<a name="l00340"></a><a class="code" href="classPrint.html#a9">00340</a> <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a9">Print::put_vga_back</a>(<span class="keywordtype">char</span>* name,<span class="keywordtype">int</span> BMPWIDTH,<span class="keywordtype">int</span> BMPHEIGHT,<span class="keywordtype">double</span> xposition,<span class="keywordtype">double</span> yposition,<span class="keywordtype">int</span> xcor,<span class="keywordtype">int</span> ycor) {
00341     <a class="code" href="classVgaBuf.html">VgaBuf</a> *vgaBuf = &amp;vga_back;
00342 
00343 <span class="preprocessor">#if(0)</span>
00344 <span class="preprocessor"></span>
00345     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a25">write_bmp_file</a>( name );
00346     <a class="code" href="classPrint.html#a7">put_bitmap</a>(name, BMPWIDTH, BMPHEIGHT, xposition, yposition, xcor, ycor);
00347 
00348 <span class="preprocessor">#elif(0)                                        // use capture screen, but need write to harddisk</span>
00349 <span class="preprocessor"></span>
00350     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a26">write_bmp_file_area</a>( name, xcor, ycor, xcor+BMPWIDTH-1, ycor+BMPHEIGHT-1 );
00351     <span class="comment">// (0,0) not (xcor,ycor)</span>
00352     <a class="code" href="classPrint.html#a7">put_bitmap</a>(name, BMPWIDTH, BMPHEIGHT, xposition, yposition, 0, 0);
00353 
00354 <span class="preprocessor">#elif(1)</span>
00355 <span class="preprocessor"></span>
00356     <span class="keyword">const</span> bytePerPixel = 3;
00357     <span class="comment">// 3 byte per pixel, round-up to next DWORD boundary</span>
00358     <span class="keywordtype">long</span> bitmapPitch = (BMPWIDTH * bytePerPixel + 3) &amp; ~3;
00359     BYTE *bitmapDataBuf = (BYTE *)<a class="code" href="ALL_8H.html#a5">mem_add</a>( bitmapPitch * BMPHEIGHT );
00360 
00361     <span class="comment">// BITMAPINFO *bitmapInfo = (BITMAPINFO *)mem_add( sizeof(BITMAPINFOHEADER) + 256 * sizeof(RGBQUAD) ); // paletted bitmap</span>
00362     BITMAPINFO *bitmapInfo = (BITMAPINFO *)<a class="code" href="ALL_8H.html#a5">mem_add</a>( <span class="keyword">sizeof</span>(BITMAPINFOHEADER) );
00363 
00364     memset( &amp;bitmapInfo-&gt;bmiHeader, 0, <span class="keyword">sizeof</span>(BITMAPINFOHEADER) );
00365     bitmapInfo-&gt;bmiHeader.biSize = <span class="keyword">sizeof</span>(BITMAPINFOHEADER);
00366     bitmapInfo-&gt;bmiHeader.biWidth = BMPWIDTH;
00367     bitmapInfo-&gt;bmiHeader.biHeight = BMPHEIGHT;
00368     bitmapInfo-&gt;bmiHeader.biPlanes = 1;
00369     bitmapInfo-&gt;bmiHeader.biBitCount = bytePerPixel * 8;
00370     bitmapInfo-&gt;bmiHeader.biCompression = BI_RGB;
00371     bitmapInfo-&gt;bmiHeader.biSizeImage = bitmapPitch * BMPHEIGHT;
00372     bitmapInfo-&gt;bmiHeader.biXPelsPerMeter = 0;
00373     bitmapInfo-&gt;bmiHeader.biYPelsPerMeter = 0;
00374     bitmapInfo-&gt;bmiHeader.biClrUsed = 0;
00375     bitmapInfo-&gt;bmiHeader.biClrImportant = 0;
00376 
00377     <span class="comment">// set from bottom to top</span>
00378 
00379     BYTE *rowPtr = (BYTE *)bitmapDataBuf;
00380     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> cy = ycor+BMPHEIGHT-1; cy &gt;= ycor; --cy, rowPtr+=bitmapPitch ) {
00381         <span class="keywordtype">short</span> *readPtr = vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a0">buf_ptr</a>( xcor, cy);
00382         BYTE *writePtr = rowPtr;
00383         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> cx = xcor; cx &lt; xcor+BMPWIDTH; ++cx, ++readPtr, writePtr+=bytePerPixel ) {
00384             <a class="code" href="structRGBColor.html">RGBColor</a> rgbColor;
00385             <span class="comment">// only for bytePerPixel is 3</span>
00386             vga.decode_pixel( *readPtr, &amp;rgbColor );
00387             <span class="comment">// to make the printing output clearer</span>
00388             writePtr[0] = rgbColor.<a class="code" href="structRGBColor.html#m2">blue</a>&gt;=0xf8 ? 0xff : rgbColor.<a class="code" href="structRGBColor.html#m2">blue</a>;
00389             writePtr[1] = rgbColor.<a class="code" href="structRGBColor.html#m1">green</a>&gt;=0xf8 ? 0xff : rgbColor.<a class="code" href="structRGBColor.html#m1">green</a>;
00390             writePtr[2] = rgbColor.<a class="code" href="structRGBColor.html#m0">red</a>&gt;=0xf8 ? 0xff : rgbColor.<a class="code" href="structRGBColor.html#m0">red</a>;
00391         }
00392         <span class="comment">// pad zero until bitmapPitch</span>
00393         memset( writePtr, 0, rowPtr+bitmapPitch-writePtr);
00394     }
00395 
00396     <span class="comment">// copy bitmap while maintaining perspective</span>
00397 
00398     <span class="keywordtype">int</span> xpagepos,ypagepos,pagew,pageh;
00399 
00400     <span class="comment">// pagew= GetDeviceCaps(printdlg.hDC,ASPECTX);</span>
00401     pagew= GetDeviceCaps(printdlg.hDC,PHYSICALWIDTH);
00402     xpagepos=(int)(xposition*pagew);
00403     <span class="comment">// pageh= GetDeviceCaps(printdlg.hDC,ASPECTY);</span>
00404     pageh= GetDeviceCaps(printdlg.hDC,PHYSICALHEIGHT);
00405     ypagepos=(int)(yposition*pageh);
00406 
00407     StretchDIBits(printdlg.hDC,xpagepos,ypagepos,
00408                   (<span class="keywordtype">int</span>) (BMPWIDTH*Xratio),                      <span class="comment">//*1.3),</span>
00409                   (<span class="keywordtype">int</span>) (BMPHEIGHT*Yratio),                     <span class="comment">//*1.2),</span>
00410                   0, 0,                                         <span class="comment">// not xcor, ycor, as the (0,0)bitmapDataPtr is (xcor, ycor) of vgaBuf</span>
00411                   BMPWIDTH, BMPHEIGHT,
00412                   bitmapDataBuf, bitmapInfo, DIB_RGB_COLORS,
00413                   SRCCOPY);
00414 
00415     <span class="comment">// free memory</span>
00416     <a class="code" href="ALL_8H.html#a8">mem_del</a>( bitmapDataBuf );
00417     <a class="code" href="ALL_8H.html#a8">mem_del</a>( bitmapInfo );
00418 <span class="preprocessor">#else</span>
00419 <span class="preprocessor"></span><span class="preprocessor">#error</span>
00420 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00421 <span class="preprocessor"></span>}
00422 
<a name="l00423"></a><a class="code" href="classPrint.html#a10">00423</a> <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a10">Print::put_text</a>(<span class="keywordtype">char</span>* string,<span class="keywordtype">int</span> xpos,<span class="keywordtype">int</span> ypos) {
00424     SelectObject(printdlg.hDC,hfont);
00425     GetTextMetrics(printdlg.hDC, &amp;tm);
00426     SetMapMode(printdlg.hDC,MM_TEXT);
00427     xpos = xpos*tm.tmAveCharWidth;
00428     ypos = ypos*(tm.tmHeight + tm.tmExternalLeading);
00429 
00430     <span class="comment">// output to printer</span>
00431     TextOut(printdlg.hDC,xpos, ypos, string, strlen(string));
00432 }
00433 
00434 <span class="comment">//create font</span>
00435 
00436                                                   <span class="comment">/*bold=700*/</span>
<a name="l00437"></a><a class="code" href="classPrint.html#a11">00437</a> <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a11">Print::dfont</a>(<span class="keywordtype">int</span> PointSize,<span class="keywordtype">bool</span> italic,<span class="keywordtype">bool</span> under,<span class="keywordtype">int</span> weight) {
00438     <span class="comment">// ##### begin Gilbert 27/04/2001 ######//</span>
00439     <span class="comment">// free previous font</span>
00440     <span class="keywordflow">if</span>( hfont ) {
00441         DeleteObject(hfont);
00442         hfont = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00443     }
00444     <span class="comment">// ##### emd Gilbert 27/04/2001 ######//</span>
00445     hfont = CreateFont(
00446         (-MulDiv(PointSize, GetDeviceCaps(printdlg.hDC, LOGPIXELSY), 72)),
00447         0,                                            <span class="comment">// logical average character width</span>
00448         0,                                            <span class="comment">// angle of escapement</span>
00449         0,                                            <span class="comment">// base-line orientation angle</span>
00450         weight,                                       <span class="comment">// font weight</span>
00451         italic,                                       <span class="comment">// italic attribute flag</span>
00452         under,                                        <span class="comment">// underline attribute flag</span>
00453         <span class="keyword">false</span>,                                        <span class="comment">// strikeout attribute flag</span>
00454         DEFAULT_CHARSET,                              <span class="comment">// character set identifier</span>
00455         OUT_CHARACTER_PRECIS,                         <span class="comment">// output precision</span>
00456         CLIP_DEFAULT_PRECIS,                          <span class="comment">// clipping precision</span>
00457         DEFAULT_QUALITY,                              <span class="comment">// output quality</span>
00458         FF_ROMAN,                                     <span class="comment">//DEFAULT_PITCH, // pitch and family</span>
00459         <a class="code" href="OHELP_8H.html#a0">NULL</a>                                          <span class="comment">// pointer to typeface name string</span>
00460         );
00461 };
00462 
<a name="l00463"></a><a class="code" href="classPrint.html#a12">00463</a> <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a12">Print::end_page</a>() {
00464     EndPage(printdlg.hDC);
00465 }
00466 
<a name="l00467"></a><a class="code" href="classPrint.html#a13">00467</a> <span class="keywordtype">void</span> <a class="code" href="classPrint.html#a13">Print::endprint</a>(HWND ohwnd) {                <span class="comment">//put the hwnd here</span>
00468     EndDoc(printdlg.hDC);
00469     <span class="comment">// ##### begin Gilbert 27/04/2001 #######//</span>
00470     DeleteDC(memDC);
00471     memDC = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00472     DeleteDC(printdlg.hDC);
00473     printdlg.hDC = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00474     <span class="comment">// err_when( hwnd_of_hdc != ohwnd );</span>
00475     ReleaseDC(ohwnd, hdc);
00476     hdc = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00477     <span class="comment">// ##### end Gilbert 27/04/2001 #######//</span>
00478 }
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:11 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
