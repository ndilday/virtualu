<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Ogfilea.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Ogfilea.cpp</h1><a href="Ogfilea_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OGFILEA.CPP</span>
00002 <span class="comment">//Description : Game File Array</span>
00003 
00004 <span class="preprocessor">#include &lt;IO.H&gt;</span>
00005 <span class="preprocessor">#include &lt;<a class="code" href="ODIR_8H.html">ODIR.H</a>&gt;</span>
00006 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="ODATE_8H.html">ODATE.H</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;OMOUSE.H&gt;</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="OMOUSECR_8H.html">OMOUSECR.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="OPOWER_8H.html">OPOWER.H</a>&gt;</span>
00011 
00012 <span class="preprocessor">#include &lt;<a class="code" href="OBOX_8H.html">OBOX.H</a>&gt;</span>
00013 <span class="preprocessor">#include &lt;OFONT.H&gt;</span>
00014 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00015 <span class="preprocessor">#include &lt;<a class="code" href="OGAME_8H.html">OGAME.H</a>&gt;</span>
00016 <span class="preprocessor">#include &lt;<a class="code" href="OGAMESET_8H.html">OGAMESET.H</a>&gt;</span>
00017 <span class="preprocessor">#include &lt;OGFILE.H&gt;</span>
00018 
00019 <span class="comment">//--------- Define constant ---------//</span>
00020 <span class="comment">//----- File name of the game file array --------//</span>
00021 
<a name="l00022"></a><a class="code" href="Ogfilea_8cpp.html#a0">00022</a> <span class="preprocessor">#define MAX_BROWSE_DISP_REC    5                  // max. no. of records can be displayed in the saved game browser</span>
00023 <span class="preprocessor"></span>
<a name="l00024"></a><a class="code" href="Ogfilea_8cpp.html#a1">00024</a> <span class="preprocessor">#define HALL_OF_FAME_FILE_NAME  "HALLFAME.DAT"</span>
00025 <span class="preprocessor"></span>
00026 <span class="comment">//------- Declare static vars &amp; functions ----------//</span>
00027 
00028 <span class="keyword">static</span> <span class="keywordtype">int</span>     sort_game_file_function( <span class="keyword">const</span> <span class="keywordtype">void</span> *a, <span class="keyword">const</span> <span class="keywordtype">void</span> *b );
00029 <span class="comment">//static int     last_game_recno();</span>
00030 
00031 <span class="comment">//------ Begin of function GameFileArray constuctor ------//</span>
00032 
<a name="l00033"></a><a class="code" href="classGameFileArray.html#a0">00033</a> <a class="code" href="classGameFileArray.html#a0">GameFileArray::GameFileArray</a>() : <a class="code" href="classDynArray.html">DynArray</a>( sizeof(<a class="code" href="classGameFile.html">GameFile</a>), 10 ) {
00034     <a class="code" href="classGameFileArray.html#m0">demo_format</a> = 0;
00035 
00036 <span class="preprocessor">#ifdef DEMO</span>
00037 <span class="preprocessor"></span>    <a class="code" href="classGameFileArray.html#m0">demo_format</a> = 1;
00038 <span class="preprocessor">#endif</span>
00039 <span class="preprocessor"></span>
00040 <span class="preprocessor">#ifdef DEMO_DESIGN</span>
00041 <span class="preprocessor"></span>    <a class="code" href="classGameFileArray.html#m0">demo_format</a> = 1;
00042 <span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044     <a class="code" href="classGameFileArray.html#m2">last_file_name</a>[0] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00045     <a class="code" href="classGameFileArray.html#m1">has_read_hall_of_fame</a> = 0;
00046 
00047     memset( <a class="code" href="classGameFileArray.html#m3">hall_fame_array</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="structHallFame.html">HallFame</a>)*<a class="code" href="Ogfile_8h.html#a4a3">HALL_FAME_NUM</a> );
00048 }
00049 
00050 <span class="comment">//-------- End of function GameFileArray constuctor ------//</span>
00051 
00052 <span class="comment">//------ Begin of function GameFileArray::init ------//</span>
00053 
<a name="l00054"></a><a class="code" href="classGameFileArray.html#a1">00054</a> <span class="keywordtype">void</span> <a class="code" href="classGameFileArray.html#a1">GameFileArray::init</a>(<span class="keywordtype">char</span> *extStr) {
00055     <span class="comment">//------------- Read Hall of Fame ------------//</span>
00056 
00057     <span class="keywordflow">if</span>( !<a class="code" href="classGameFileArray.html#m1">has_read_hall_of_fame</a> ) {                  <span class="comment">// only read once, GameFileArray::init() is called every time the load/save game menu is brought up.</span>
00058         <a class="code" href="classGameFileArray.html#a6">read_hall_of_fame</a>();
00059         <a class="code" href="classGameFileArray.html#m1">has_read_hall_of_fame</a> = 1;
00060     }
00061 
00062     <span class="comment">//-- Load all headers of all saved game files in current directory --//</span>
00063 
00064     load_all_game_header(extStr,
00065 #<span class="keywordflow">if</span>(<a class="code" href="Gamedef_8h.html#a0">GAME_VERSION</a>&gt;=200)
00066                          stricmp(extStr,<span class="stringliteral">"*.SAV"</span>)==0                    <span class="comment">// load auto save as well if extension is numeric</span>
00067 #<span class="keywordflow">else</span>
00068                          0
00069 #endif
00070         );
00071 }
00072 
00073 <span class="comment">//-------- End of function GameFileArray::init ------//</span>
00074 
00075 <span class="comment">//------ Begin of function GameFileArray::deinit ------//</span>
00076 
<a name="l00077"></a><a class="code" href="classGameFileArray.html#a2">00077</a> <span class="keywordtype">void</span> <a class="code" href="classGameFileArray.html#a2">GameFileArray::deinit</a>() {
00078     <a class="code" href="classGameFileArray.html#m1">has_read_hall_of_fame</a> = 0;                      <span class="comment">// 0228</span>
00079 }
00080 
00081 <span class="comment">//-------- End of function GameFileArray::deinit ------//</span>
00082 
00083 <span class="comment">//-------- Begin of function GameFileArray::save_new_game -----//</span>
<a name="l00092"></a><a class="code" href="classGameFileArray.html#a3">00092</a> <span class="comment">void GameFileArray::save_new_game(char* fileName) {</span>
00093     <a class="code" href="classGameFile.html">GameFile</a>  gameFile;
00094     <a class="code" href="classGameFile.html">GameFile</a>* gameFilePtr;
00095     <span class="keywordtype">int</span>       addFlag=1;
00096     <span class="keywordtype">int</span>       gameFileRecno;
00097 
00098     memset( &amp;gameFile, 0, <span class="keyword">sizeof</span>(<a class="code" href="classGameFile.html">GameFile</a>) );
00099 
00100     <span class="keywordflow">if</span>( fileName ) {
00101         <span class="comment">//----- check for overwriting an existing file ----//</span>
00102 
00103         <span class="keywordflow">for</span>( gameFileRecno=1 ; gameFileRecno&lt;=game_file_array.size() ; gameFileRecno++ ) {
00104             gameFilePtr = game_file_array[gameFileRecno];
00105 
00106             <span class="comment">// if this file name already exist</span>
00107             <span class="keywordflow">if</span>( strcmp(gameFilePtr-&gt;<a class="code" href="classGameFile.html#m1">file_name</a>, fileName)==0 ) {
00108                 addFlag=0;
00109                 <span class="keywordflow">break</span>;
00110             }
00111         }
00112 
00113         strcpy( gameFile.<a class="code" href="classGameFile.html#m1">file_name</a>, fileName );
00114     }
00115     <span class="keywordflow">else</span> {
00116         gameFile.<a class="code" href="classGameFile.html#a5">set_file_name</a>();                     <span class="comment">// give it a new game_file_name based on current group name</span>
00117     }
00118 
00119     <span class="comment">//----------- save game now ------------//</span>
00120 
00121     <span class="keywordflow">if</span>( gameFile.<a class="code" href="classGameFile.html#a1">save_game</a>(fileName) ) {
00122         strcpy( last_file_name, gameFile.<a class="code" href="classGameFile.html#m1">file_name</a> );
00123 
00124         <span class="keywordflow">if</span>( addFlag ) {
00125             linkin(&amp;gameFile);
00126 
00127             quick_sort( sort_game_file_function );
00128         }
00129         <span class="keywordflow">else</span> {
00130             <span class="comment">// dynarr's func</span>
00131             game_file_array.update(&amp;gameFile, gameFileRecno);
00132         }
00133     }
00134 }
00135 
00136 <span class="comment">//-------- End of function GameFileArray::save_new_game -------//</span>
00137 
00138 <span class="comment">//------- Begin of function GameFileArray::del_game ------//</span>
<a name="l00140"></a><a class="code" href="classGameFileArray.html#a4">00140</a> <span class="comment">void GameFileArray::del_game(int recNo) {</span>
00141     <span class="keywordflow">if</span>( !box.ask( <span class="stringliteral">"This saved game will be deleted, proceed ?"</span> ) )
00142         <span class="keywordflow">return</span>;
00143 
00144     <span class="comment">//---------------------------------------------------//</span>
00145 
00146     unlink(game_file_array[recNo]-&gt;file_name);      <span class="comment">// unlink() is a C standard function in io.h, for delete file</span>
00147 
00148     go(recNo);
00149     linkout();
00150 
00151     go(recNo-1);                                    <span class="comment">// skip back one record</span>
00152 }
00153 
00154 <span class="comment">//--------- End of function GameFileArray::del_game ------//</span>
00155 
00156 <span class="comment">//------- Begin of function GameFileArray::del_express_game ------//</span>
<a name="l00158"></a><a class="code" href="classGameFileArray.html#a5">00158</a> <span class="comment">void GameFileArray::del_express_game(int recNo) {</span>
00159     <span class="keywordflow">if</span>( !box.ask( <span class="stringliteral">"This express game will be deleted, proceed ?"</span> ) )
00160         <span class="keywordflow">return</span>;
00161 
00162     <span class="comment">//---------------------------------------------------//</span>
00163 
00164     unlink(game_file_array[recNo]-&gt;file_name);      <span class="comment">// unlink() is a C standard function in io.h, for delete file</span>
00165 
00166     go(recNo);
00167     linkout();
00168 
00169     go(recNo-1);                                    <span class="comment">// skip back one record</span>
00170 }
00171 
00172 <span class="comment">//--------- End of function GameFileArray::del_express_game ------//</span>
00173 
00174 <span class="comment">//-------- Begin of function GameFileArray::load_all_game_header --------//</span>
00180 <span class="comment"></span>
00181 <span class="keywordtype">void</span> GameFileArray::load_all_game_header(<span class="keywordtype">char</span> *extStr, <span class="keywordtype">int</span> readAutoSave) {
00182     <span class="keywordtype">int</span>       i;
00183     <a class="code" href="classDirectory.html">Directory</a> gameDir;
00184     <a class="code" href="classGameFile.html">GameFile</a>  gameFile;
00185     <a class="code" href="classFile.html">File</a>      file;
00186 
00187 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00188 <span class="preprocessor"></span>    <span class="keywordflow">if</span>( readAutoSave ) {
00189         <span class="comment">// see config.auto_save, config.auto_save_file_name</span>
00190         <span class="comment">// auto save file name has numeric extension</span>
00191 
00192         <span class="comment">// BUGHERE : need to check extStr is not numeric extension</span>
00193         gameDir.<a class="code" href="classDirectory.html#a1">read</a>( <span class="stringliteral">"*.*"</span>, 1 );
00194         <span class="keywordflow">for</span>( i = gameDir.<a class="code" href="classDynArray.html#a28">size</a>(); i &gt; 0; --i ) {
00195             <span class="keywordtype">char</span> ext[_MAX_EXT];
00196             _splitpath( gameDir[i]-&gt;name, <a class="code" href="OHELP_8H.html#a0">NULL</a>, <a class="code" href="OHELP_8H.html#a0">NULL</a>, <a class="code" href="OHELP_8H.html#a0">NULL</a>, ext );
00197             <span class="comment">// check for numeric extension</span>
00198             <span class="keywordflow">if</span>( ext[0] == <span class="charliteral">'.'</span>
00199                 &amp;&amp; ext[1] &gt;= <span class="charliteral">'0'</span> &amp;&amp; ext[1] &lt;= <span class="charliteral">'9'</span>
00200                 &amp;&amp; ext[2] &gt;= <span class="charliteral">'0'</span> &amp;&amp; ext[2] &lt;= <span class="charliteral">'9'</span>
00201                 &amp;&amp; ext[3] &gt;= <span class="charliteral">'0'</span> &amp;&amp; ext[3] &lt;= <span class="charliteral">'9'</span>
00202                 &amp;&amp; ext[4] == <span class="charliteral">'\0'</span> ) {
00203                 <span class="keywordflow">continue</span>;                                 <span class="comment">// keep this file name</span>
00204             }
00205             gameDir.<a class="code" href="classDynArray.html#a6">linkout</a>(i);                         <span class="comment">// filter out this file</span>
00206         }
00207     }
00208 
00209     <span class="comment">// next gameDir.read will append other file name</span>
00210     <span class="keywordflow">if</span>( extStr )
00211         gameDir.<a class="code" href="classDirectory.html#a1">read</a>( extStr, 1 );                    <span class="comment">// 1-Sort file names</span>
00212 <span class="preprocessor">#else</span>
00213 <span class="preprocessor"></span>
00214     gameDir.<a class="code" href="classDirectory.html#a1">read</a>( extStr, 1 );                      <span class="comment">// 1-Sort file names</span>
00215 <span class="preprocessor">#endif</span>
00216 <span class="preprocessor"></span>
00217     <span class="comment">//-------- read in the headers of all game sets -------//</span>
00218 
00219     <a class="code" href="classDynArray.html#a38">zap</a>();
00220 
00221     <span class="keywordflow">for</span>( i=1 ; i&lt;=gameDir.<a class="code" href="classDynArray.html#a28">size</a>() ; i++ ) {
00222         <span class="keywordflow">if</span>( file.<a class="code" href="classFile.html#a2">file_open</a>( gameDir[i]-&gt;name, 1, 1 )  <span class="comment">// last 1=allow varying read &amp; write size</span>
00223             &amp;&amp; file.<a class="code" href="classFile.html#a9">file_read</a>(&amp;gameFile, <span class="keyword">sizeof</span>(<a class="code" href="classGameFile.html">GameFile</a>))
00224             &amp;&amp; gameFile.<a class="code" href="classGameFile.html#a6">validate_header</a>() ) {
00225             <span class="comment">// in case that the name may be different</span>
00226             strcpy( gameFile.<a class="code" href="classGameFile.html#m1">file_name</a>, gameDir[i]-&gt;name );
00227             gameFile.<a class="code" href="classGameFile.html#m4">file_date</a> = gameDir[i]-&gt;time;
00228             <a class="code" href="classDynArray.html#a4">linkin</a>(&amp;gameFile);
00229         }
00230         file.<a class="code" href="classFile.html#a5">file_close</a>();
00231     }
00232 }
00233 
00234 <span class="comment">//------ End of function GameFileArray::load_all_game_header --------//</span>
00235 
00236 <span class="comment">//------ Begin of function sort_game_file_function ------//</span>
00238 <span class="comment">static int sort_game_file_function( const void *a, const void *b ) {</span>
00239     <span class="keywordflow">return</span> strcmp( ((<a class="code" href="classGameFile.html">GameFile</a>*)a)-&gt;file_name, ((<a class="code" href="classGameFile.html">GameFile</a>*)b)-&gt;file_name );
00240 }
00241 
00242 <span class="comment">//------- End of function sort_game_file_function ------//</span>
00243 
00244 <span class="comment">//------ Begin of function last_game_recno ------//</span>
00246 <span class="comment">static int last_game_recno() {</span>
00247     <span class="keywordtype">int</span> i;
00248 
00249     <span class="keywordflow">for</span>( i=game_file_array.size() ; i&gt;0 ; i-- ) {
00250         <span class="keywordflow">if</span>( strcmp(game_file_array[i]-&gt;file_name, game_file_array.last_file_name)==0 )
00251             <span class="keywordflow">return</span> i;
00252     }
00253 
00254     <span class="keywordflow">return</span> 0;                                       <span class="comment">// if none of them match, return 1 as the first record</span>
00255 }
00256 
00257 <span class="comment">//------- End of function last_game_recno ------//</span>
00258 
00259 <span class="comment">//------- Begin of function GameFileArray::operator[] -----//</span>
00260 
<a name="l00261"></a><a class="code" href="classGameFileArray.html#a9">00261</a> <a class="code" href="classGameFile.html">GameFile</a>* <a class="code" href="classGameFileArray.html#a9">GameFileArray::operator[]</a>(<span class="keywordtype">int</span> recNo) {
00262     <a class="code" href="classGameFile.html">GameFile</a>* gameFile = (<a class="code" href="classGameFile.html">GameFile</a>*) <a class="code" href="classDynArray.html#a13">get</a>(recNo);
00263 
00264     <span class="comment">//  err_when(gameFile == NULL);  Let it return NULL value</span>
00265 
00266     <span class="keywordflow">return</span> gameFile;
00267 }
00268 
00269 <span class="comment">//--------- End of function GameFileArray::operator[] ----//</span>
00270 
00271 <span class="comment">//--------------------------------------------------------------------//</span>
00272 <span class="comment">//--------------------------------------------------------------------//</span>
00273 <span class="comment">//--------------------------------------------------------------------//</span>
00274 <span class="comment">//--------------------------------------------------------------------//</span>
00275 <span class="comment">//--------------------------------------------------------------------//</span>
00276 
00277 <span class="comment">//------- Begin of function GameFileArray::write_hall_of_fame ------//</span>
<a name="l00279"></a><a class="code" href="classGameFileArray.html#a7">00279</a> <span class="comment">int GameFileArray::write_hall_of_fame() {</span>
00280     <span class="keywordtype">int</span>  rc;
00281     <a class="code" href="classFile.html">File</a> file;
00282 
00283     <span class="comment">// 0=don't handle error itself</span>
00284     rc = file.<a class="code" href="classFile.html#a3">file_create</a>( <a class="code" href="Ogfilea_8cpp.html#a1">HALL_OF_FAME_FILE_NAME</a>, 0, 1 );
00285 
00286     <span class="keywordflow">if</span>( !rc )
00287         <span class="keywordflow">return</span> 0;
00288     <span class="comment">// 1=allow the writing size and the read size to be different</span>
00289     <span class="comment">//--------- Write Hall of Fame ----------//</span>
00290 
00291     <span class="keywordflow">if</span>( rc )
00292         rc = file.<a class="code" href="classFile.html#a10">file_write</a>( hall_fame_array, <span class="keyword">sizeof</span>(<a class="code" href="structHallFame.html">HallFame</a>) * <a class="code" href="Ogfile_8h.html#a4a3">HALL_FAME_NUM</a> );
00293 
00294     <span class="comment">//------ write last saved game file name ------//</span>
00295 
00296     <span class="keywordflow">if</span>( rc )
00297         rc = file.<a class="code" href="classFile.html#a10">file_write</a>( last_file_name, MAX_PATH+1 );
00298 
00299     file.<a class="code" href="classFile.html#a5">file_close</a>();
00300 
00301     <span class="keywordflow">return</span> rc;
00302 }
00303 
00304 <span class="comment">//--------- End of function GameFileArray::write_hall_of_fame ------//</span>
00305 
00306 <span class="comment">//------- Begin of function GameFileArray::read_hall_of_fame ------//</span>
<a name="l00308"></a><a class="code" href="classGameFileArray.html#a6">00308</a> <span class="comment">int GameFileArray::read_hall_of_fame() {</span>
00309     <span class="keywordflow">if</span>( !m.is_file_exist(<a class="code" href="Ogfilea_8cpp.html#a1">HALL_OF_FAME_FILE_NAME</a>) )
00310         <span class="keywordflow">return</span> 0;
00311 
00312     <span class="keywordtype">int</span>  rc;
00313     <a class="code" href="classFile.html">File</a> file;
00314 
00315     <span class="comment">// 0=don't handle error itself</span>
00316     rc = file.<a class="code" href="classFile.html#a2">file_open</a>( <a class="code" href="Ogfilea_8cpp.html#a1">HALL_OF_FAME_FILE_NAME</a>, 0, 1 );
00317     <span class="comment">// 1=allow the writing size and the read size to be different</span>
00318     <span class="keywordflow">if</span>( !rc )
00319         <span class="keywordflow">return</span> 0;
00320     <span class="comment">// 1=allow the writing size and the read size to be different</span>
00321     <span class="comment">//--------- Read Hall of Fame ----------//</span>
00322 
00323     <span class="keywordflow">if</span>( rc )
00324         rc = file.<a class="code" href="classFile.html#a9">file_read</a>( hall_fame_array, <span class="keyword">sizeof</span>(<a class="code" href="structHallFame.html">HallFame</a>) * <a class="code" href="Ogfile_8h.html#a4a3">HALL_FAME_NUM</a> );
00325 
00326     <span class="comment">//------ read last saved game file name ------//</span>
00327 
00328     <span class="keywordflow">if</span>( rc )
00329         rc = file.<a class="code" href="classFile.html#a9">file_read</a>( last_file_name, MAX_PATH+1);
00330 
00331     file.<a class="code" href="classFile.html#a5">file_close</a>();
00332 
00333     <span class="keywordflow">return</span> rc;
00334 }
00335 
00336 <span class="comment">//--------- End of function GameFileArray::read_hall_of_fame ------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:47 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
