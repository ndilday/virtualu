<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Oenrolsl.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Oenrolsl.cpp</h1><a href="Oenrolsl_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename              : OEnrolsl.cpp</span>
00002 <span class="comment">//Description   : EnrollRes Class Definition</span>
00003 <span class="comment">//                                              - handle enrollment of sl-2 to sl-5 (NONTRADTION to DISTANCE_LEARN)</span>
00004 <span class="comment">//                                              - calc aid and talent for all levels</span>
00005 <span class="comment">//Owner                 : Fred</span>
00006 
00007 <span class="preprocessor">#include &lt;stdio.h&gt;</span>                                <span class="comment">// for DEBUG</span>
00008 
00009 <span class="comment">// ES library header file</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;<a class="code" href="OGAMESET_8H.html">OGAMESET.H</a>&gt;</span>
00012 <span class="preprocessor">#include &lt;OMATH.H&gt;</span>                                <span class="comment">// average_float, gammaCDF</span>
00013 <span class="preprocessor">#include &lt;OSTR.h&gt;</span>                                 <span class="comment">// strcmp</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="OLINALG_8H.html">OLINALG.H</a>&gt;</span>                              <span class="comment">// for this calc_enroll_offers</span>
00015 
00016 <span class="comment">// CU header file</span>
00017 <span class="preprocessor">#include &lt;GAMEDEF.H&gt;</span>                              <span class="comment">// enum { NONMINORITY_MALE, NONMINORITY_FEMALE, MINORITY_MALE, MINORITY_FEMALE };</span>
00018 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>
00019 <span class="preprocessor">#include &lt;<a class="code" href="OPEERSCH_8H.html">OPEERSCH.H</a>&gt;</span>
00020 <span class="preprocessor">#include &lt;<a class="code" href="OSCHLRES_8H.html">OSCHLRES.H</a>&gt;</span>
00021 <span class="preprocessor">#include &lt;<a class="code" href="ODEPTRES_8H.html">ODEPTRES.H</a>&gt;</span>
00022 <span class="preprocessor">#include &lt;ODEPT.H&gt;</span>
00023 <span class="preprocessor">#include &lt;OLIBTECH.H&gt;</span>                             <span class="comment">//## chea 270999</span>
00024 
00025 <span class="preprocessor">#include "OEnroll.h"</span>
00026 
00027 <span class="comment">//----------- Define helper static functions ------//</span>
00028 
00029 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">bool</span> is_minority_group(<span class="keywordtype">char</span> group) {
00030     <span class="keywordflow">return</span> group == <a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a> || group == <a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a>;
00031 }
00032 
00033 <span class="keyword">static</span> <span class="keywordtype">float</span> multipler_special_ug(<span class="keywordtype">char</span> sl, <span class="keywordtype">char</span> subSeg) {
00034     <a class="code" href="ALL_8H.html#a0">err_when</a>(sl==<a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>);
00035     <span class="keywordtype">float</span> avg = is_minority_group(subSeg) ? 0.8f : 0.9f;
00036 
00037     <span class="keywordflow">return</span> is_nontradition_ug_group(sl) ? math.get_random_snd(avg, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.05f)) : 1.0f;
00038 }
00039 
00040 <span class="comment">//----------- Begin of function EnrollRes::load_db_student_pref2 ------//</span>
00044 <span class="comment">void EnrollRes::init_data_sls(char sl) {</span>
00045     <span class="keywordtype">char</span> arrSL = sl-1;                              <span class="comment">// for array access</span>
00046     <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a> != 1);
00047 
00048     <span class="comment">//----------------------------------------------------//</span>
00049     <span class="comment">//-- initialization: td3.4 section 3.2                                      ---//</span>
00050     <span class="comment">//----------------------------------------------------//</span>
00051 
00052     <span class="comment">//---- STEP 1. calc enroll_data_sls[][].student_pref -----//</span>
00053 
00054     <span class="keyword">const</span> <span class="keywordtype">float</span> STU_PREF_SCALE = 4.0f;
00055 
00056     <span class="keywordtype">float</span> prefVarsArray[<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>];         <span class="comment">// column Q</span>
00057     <span class="keywordtype">int</span> i, j;
00058 
00059     <a class="code" href="classPeerSchool.html">PeerSchool</a>* player = school_res.player_peer_school;
00060     memcpy(prefVarsArray, player-&gt;<a class="code" href="classPeerSchool.html#m7">pref_vars_array</a>, <span class="keyword">sizeof</span>(prefVarsArray));
00061 
00062     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>; i++) {
00063         <span class="keywordflow">if</span> ( i &lt; <a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a> - 4 )
00064             prefVarsArray[i] = math.safe_divide(prefVarsArray[i], <a class="code" href="classPeerSchool.html#p0">PeerSchool::pref_vars_average_array</a>[i]);
00065         <span class="keywordflow">else</span> {
00066             <span class="keywordflow">if</span> (  ( sl == <a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a> &amp;&amp; fraction_sl2_offered_aid &gt; 0 )
00067                   || ( sl == <a class="code" href="Ostudent_8h.html#a32a7">DISTANCE_LEARN</a> &amp;&amp; fraction_sl5_offered_aid &gt; 0 )
00068                 )
00069                 prefVarsArray[i] = math.safe_divide(player-&gt;<a class="code" href="classPeerSchool.html#m8">pref_vars_array_last</a>[i], <a class="code" href="classPeerSchool.html#p1">PeerSchool::pref_vars_average_array_last</a>[i]);
00070             <span class="keywordflow">else</span>
00071                 prefVarsArray[i] = 0;
00072         }
00073     }
00074 
00075     <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a> != 1);
00076 
00077     <span class="keywordtype">char</span>  isPublic = player_school.control == <a class="code" href="Opschool_8h.html#a61a16">PUBLIC</a>;
00078     <span class="keywordtype">float</span> finalRatio[<a class="code" href="Oenroll_8h.html#a32a12">MINORITY_GROUP_COUNT</a>];         <span class="comment">// stuPrefs</span>
00079     <span class="keywordtype">float</span> tmpRatio;
00080     <span class="keywordtype">float</span> tmp, <a class="code" href="NEWMATRM_8H.html#a2">sign</a>;
00081 
00082     <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="Oenroll_8h.html#a32a12">MINORITY_GROUP_COUNT</a>; j++) {
00083         finalRatio[j] = 1;
00084 
00085         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Oenroll_8h.html#a30a6">PREFERECNE_COUNT2</a>; i++) {
00086             <a class="code" href="NEWMATRM_8H.html#a2">sign</a> = (pref_special_case(i))? -1.0f: 1.0f;
00087 
00088             <span class="comment">// 1</span>
00089             tmp = enroll_res.preference_array2_sls[arrSL][isPublic][j][i];
00090 
00091             <span class="keywordflow">if</span> ( tmp &lt;= 0.0 || prefVarsArray[i] == 0)
00092                 tmpRatio = 1.0f;
00093             <span class="keywordflow">else</span>
00094                 tmpRatio = math.safe_pow(prefVarsArray[i], <a class="code" href="NEWMATRM_8H.html#a2">sign</a> * tmp);
00095 
00096 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00097 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( arrSL == 3 ) {                         <span class="comment">// special setting for Distance Learning</span>
00098                 <span class="comment">//                              tmpRatio = math.safe_pow(               Kenneth</span>
00099             }
00100 <span class="preprocessor">#endif</span>
00101 <span class="preprocessor"></span>
00102             <span class="comment">// 2</span>
00103             finalRatio[j] *= tmpRatio;
00104             <a class="code" href="ALL_8H.html#a0">err_when</a>( finalRatio[j] &lt; 0 );
00105         }
00106 
00107         <span class="keywordflow">if</span> ( !(1+ (float) exp(-s_slope*(finalRatio[j]-1))) )
00108             finalRatio[j] = 1;
00109         <span class="keywordflow">else</span>
00110             finalRatio[j] = s_lower_bound+(s_upper_bound-s_lower_bound)/(1+ (float) exp(-s_slope*(finalRatio[j]-1)));
00111 
00112         <span class="comment">//---- save the student preference for future use ----//</span>
00113 
00114         <span class="keywordflow">if</span> ( j == <a class="code" href="Oenroll_8h.html#a32a14">MINORITY</a> ) {
00115             enroll_data_sls[arrSL][<a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a>].student_pref = finalRatio[j];
00116             enroll_data_sls[arrSL][<a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a>].student_pref = finalRatio[j];
00117         }
00118         <span class="keywordflow">else</span> {
00119             enroll_data_sls[arrSL][<a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a>].student_pref = finalRatio[j];
00120             enroll_data_sls[arrSL][<a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a>].student_pref = finalRatio[j];
00121         }
00122 
00123         <a class="code" href="ALL_8H.html#a0">err_when</a>( finalRatio[j] &lt; 0 );
00124     }
00125 
00126     <span class="comment">//-------//</span>
00127     <a class="code" href="structEnrollDataSL1.html">EnrollDataSL1</a>* ed;
00128     <a class="code" href="structEnrollData.html">EnrollData</a>* edSL;
00129     <span class="keywordtype">char</span> subSeg, seg;
00130     <span class="comment">// 0.3 -&gt; 30%</span>
00131     <span class="keywordtype">float</span> studentGenderPct[<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>]; {
00132 
00133         <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="Gamedef_8h.html#a74a26">GENDER_ETHNIC_TYPE_COUNT</a> != <a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>);
00134         <span class="keywordtype">float</span> femalePercent = student_female_percent[sl] / 100.0f;
00135         <span class="keywordtype">float</span> minorityPercent = student_minority_percent[sl] / 100.0f;
00136 
00137         <span class="comment">//askbill inital gender percent affect future enrollment?  BUG? = 0 when sl=5</span>
00138         studentGenderPct[<a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a>] = femalePercent*minorityPercent;
00139         studentGenderPct[<a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a>] = femalePercent*(1.0f - minorityPercent);
00140         studentGenderPct[<a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a>] = (1.0f - femalePercent)*minorityPercent;
00141         studentGenderPct[<a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a>] = (1.0f - femalePercent)*(1.0f - minorityPercent);
00142 
00143         <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ )
00144             enroll_data_sls[arrSL][subSeg].fraction_matrics = studentGenderPct[subSeg];
00145     }
00146 
00147     <span class="comment">//---- STEP 2 -----//</span>
00148 
00149     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
00150         <span class="keywordtype">float</span> appTmp, totalFraction;
00151         <a class="code" href="structTalent.html">Talent</a> acaTmp;
00152 
00153         <span class="keywordflow">for</span> ( seg=0, appTmp=0, acaTmp.<a class="code" href="structTalent.html#m0">average</a>=0, totalFraction=0; seg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; seg++ ) {
00154             ed = &amp;enroll_data_sl1[subSeg][seg];
00155 
00156             appTmp += ed-&gt;<a class="code" href="structEnrollDataSL1.html#m0">apps_ratio</a> * ed-&gt;<a class="code" href="structEnrollDataSL1.html#m4">fraction_matrics</a>;
00157             acaTmp.<a class="code" href="structTalent.html#m0">average</a> += talent_array[subSeg][seg][<a class="code" href="Ostudent_8h.html#a39a26">ACADEMIC</a>].average * ed-&gt;<a class="code" href="structEnrollDataSL1.html#m4">fraction_matrics</a>;
00158 
00159             totalFraction += ed-&gt;<a class="code" href="structEnrollDataSL1.html#m4">fraction_matrics</a>;
00160         }
00161 
00162         <span class="comment">//--------- calc enroll_data_sls[][].apps_ratio, applications and conversion_rate ---------//</span>
00163         edSL = &amp;enroll_data_sls[arrSL][subSeg];
00164 
00165         edSL-&gt;<a class="code" href="structEnrollData.html#m0">apps_ratio</a>
00166             <span class="comment">//BUGHERE</span>
00167             = math.safe_pow(edSL-&gt;<a class="code" href="structEnrollData.html#m5">student_pref</a>, 1.0f) * appTmp / totalFraction
00168             <span class="comment">//                  = math.safe_pow(edSL-&gt;student_pref, STU_PREF_SCALE) * appTmp / totalFraction</span>
00169             ;                                           <span class="comment">//+ math.get_random_snd(0, 0.1f * enroll_data_sls[sl][subSeg].apps_ratio);//askbill</span>
00170 
00171         edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a>
00172             = enroll_data_sls[arrSL][subSeg].base_apps
00173             = int(edSL-&gt;<a class="code" href="structEnrollData.html#m0">apps_ratio</a>
00174                   <span class="comment">// 0.5: rounding</span>
00175                   * studentGenderPct[subSeg] * target_student_intake[sl] + 0.5);
00176 
00177         edSL-&gt;<a class="code" href="structEnrollData.html#m6">conversion_rate</a>
00178             = enroll_data_sls[arrSL][subSeg].base_conversion_rate
00179             <span class="comment">//990514</span>
00180             = m.fmin(1.0f, math.safe_divide(1.0f, edSL-&gt;<a class="code" href="structEnrollData.html#m0">apps_ratio</a>));
00181 
00182         <span class="keywordflow">if</span> ( sl == <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a> )                           <span class="comment">// 990514</span>
00183             edSL-&gt;<a class="code" href="structEnrollData.html#m6">conversion_rate</a> =
00184                 <span class="comment">//min &amp; max bug chea (max)</span>
00185                 m.fmin(m.fmax(0.0f,math.get_random_snd(0.5f,<a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.07f))), math.safe_divide(1.0f, edSL-&gt;<a class="code" href="structEnrollData.html#m0">apps_ratio</a>));
00186 
00187         <a class="code" href="ALL_8H.html#a2">err_if</a> ( sl == <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a> &amp;&amp; edSL-&gt;<a class="code" href="structEnrollData.html#m6">conversion_rate</a> &gt; 0.99 )
00188             <a class="code" href="ALL_8H.html#a1">err_here</a>();                                 <span class="comment">//int x=0;</span>
00189 
00190         <span class="comment">//--------- calc enroll_data_sls[][].academic ratings: average and variance ---------//</span>
00191 
00192         <span class="comment">// means[sL,geg],variances[sL,geg]</span>
00193 
00194         edSL-&gt;<a class="code" href="structEnrollData.html#m8">academic</a>.<a class="code" href="structTalent.html#m0">average</a>
00195             = ( multipler_special_ug(sl, subSeg) )
00196             * math.safe_pow(edSL-&gt;<a class="code" href="structEnrollData.html#m5">student_pref</a>, STU_PREF_SCALE) * acaTmp.<a class="code" href="structTalent.html#m0">average</a> / totalFraction
00197             ;                                           <span class="comment">//+ math.get_random_snd(0, 0.1f * enroll_data_sls[sl][subSeg].academic.average);//askbill</span>
00198 
00199         <span class="keywordflow">if</span> ( sl == <a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a> ) {
00200             <span class="keywordflow">for</span> ( seg=0, acaTmp.<a class="code" href="structTalent.html#m1">variance</a> = 0; seg&lt;<a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>; seg++ ) {
00201                 ed = &amp;enroll_data_sl1[subSeg][seg];
00202 
00203                 acaTmp.<a class="code" href="structTalent.html#m1">variance</a> +=
00204                     ( talent_array[subSeg][seg][<a class="code" href="Ostudent_8h.html#a39a26">ACADEMIC</a>].variance
00205                       + (float) math.safe_pow( multipler_special_ug(sl, subSeg) * talent_array[subSeg][seg][<a class="code" href="Ostudent_8h.html#a39a26">ACADEMIC</a>].average
00206                                                - enroll_data_sls[arrSL][subSeg].academic.average, 2)
00207                         ) * ed-&gt;<a class="code" href="structEnrollDataSL1.html#m4">fraction_matrics</a>;
00208             }
00209 
00210             edSL-&gt;<a class="code" href="structEnrollData.html#m8">academic</a>.<a class="code" href="structTalent.html#m1">variance</a>
00211                 = acaTmp.<a class="code" href="structTalent.html#m1">variance</a> / totalFraction;
00212         }
00213         <span class="keywordflow">else</span>
00214             edSL-&gt;<a class="code" href="structEnrollData.html#m8">academic</a>.<a class="code" href="structTalent.html#m1">variance</a> = enroll_data_sls[<a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>-1][subSeg].academic.variance;
00215 
00216         <a class="code" href="ALL_8H.html#a0">err_when</a>(edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a> &lt; 0);
00217         <a class="code" href="ALL_8H.html#a0">err_when</a>(edSL-&gt;<a class="code" href="structEnrollData.html#m8">academic</a>.<a class="code" href="structTalent.html#m0">average</a> &lt; 0);
00218     }
00219 
00220     <span class="comment">//-----------------//</span>
00221 
00222     calc_enroll_aid_sls(sl);
00223 }
00224 
00225 <span class="comment">//------------- End of function EnrollRes::load_db_student_pref2 ------//</span>
00226 
00227 <span class="comment">//----------- Begin of function EnrollRes::calc_enroll_aid_sls ------//</span>
00231 <span class="comment">void EnrollRes::calc_enroll_aid_sls(char sl) {</span>
00232     <span class="keywordtype">float</span> fractionOfferedMeritAid = 0;
00233 
00234     <span class="keywordflow">if</span> (  ( sl == <a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a> ) ) {
00235         adjust_fraction_merit_aid(fraction_sl2_offered_aid);
00236 
00237         <span class="keywordflow">if</span> ( fraction_sl2_offered_aid &lt;= 0 ) {
00238             merit_lower[sl] = 1;
00239             merit_upper[sl] = 0;
00240             <span class="keywordflow">return</span>;
00241         }
00242 
00243         fractionOfferedMeritAid = fraction_sl2_offered_aid;
00244     }
00245     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( sl == <a class="code" href="Ostudent_8h.html#a32a7">DISTANCE_LEARN</a> ) {
00246         adjust_fraction_merit_aid(fraction_sl5_offered_aid);
00247 
00248         <span class="keywordflow">if</span> ( fraction_sl5_offered_aid &lt;= 0 ) {
00249             merit_lower[sl] = 1;
00250             merit_upper[sl] = 0;
00251             <span class="keywordflow">return</span>;
00252         }
00253 
00254         fractionOfferedMeritAid = fraction_sl5_offered_aid;
00255     }
00256     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( sl == <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a> ) {
00257         merit_lower[sl] = max_aid;
00258         merit_upper[sl] = max_aid;
00259         <span class="keywordflow">return</span>;
00260     }
00261     <span class="keywordflow">else</span> {
00262         merit_lower[sl] = 1;
00263         merit_upper[sl] = 0;
00264         <span class="keywordflow">return</span>;
00265     }
00266 
00267     <span class="comment">//-------------------//</span>
00268     <span class="comment">//---- Merit Aid ----//</span>
00269     <span class="comment">//-------------------//</span>
00270 
00271     <span class="comment">/*</span>
00272 <span class="comment"></span>
00273 <span class="comment">      mL2 = With[{tmp = frNonTradStudentsOfferedAid*</span>
00274 <span class="comment">      Plus@@((conversionRate[sL2,#]*frPriorMatrics[sL2,#])&amp;/@gegs)},</span>
00275 <span class="comment">      FindMinimum[(meritFrObj[sL2,x]-tmp)^2,{x,5}][[2,1,2]]];</span>
00276 <span class="comment">    */</span>
00277 
00278     <span class="keywordtype">float</span> adjustRatio=0;
00279     <span class="keywordtype">char</span> subSeg, arrSL = sl-1;
00280 
00281     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
00282         adjustRatio
00283             += enroll_data_sls[arrSL][subSeg].conversion_rate
00284             * enroll_data_sls[arrSL][subSeg].fraction_matrics;
00285     }
00286 
00287     <span class="keywordtype">float</span> x = 5, deviate, lastDeviate;
00288     <span class="keywordtype">float</span> inc = x / 100.f;
00289     <span class="keywordtype">float</span> offset = fractionOfferedMeritAid * adjustRatio;
00290 
00291     <span class="keywordflow">if</span> ( calc_merit_aid_sls(sl, x+inc, offset)
00292          &gt; calc_merit_aid_sls(sl, x-inc, offset) )
00293         inc *= -1;
00294 
00295     deviate = calc_merit_aid_sls(sl, x, offset);
00296 
00297     <span class="keywordflow">do</span> {
00298         x += inc;
00299         lastDeviate = deviate;
00300         deviate = calc_merit_aid_sls(sl, x, offset);
00301     }
00302     <span class="keywordflow">while</span> ( deviate &lt; lastDeviate &amp;&amp; deviate &gt; 0 );
00303 
00304     merit_lower[sl] = x;
00305 
00306     <span class="comment">/*</span>
00307 <span class="comment">      mH2 =  With[{tmp = frMeritTop*</span>
00308 <span class="comment">      Plus@@((conversionRate[sL2,#]*frPriorMatrics[sL2,#])&amp;/@gegs)},</span>
00309 <span class="comment">      FindMinimum[(meritFrObj[sL2,x]-tmp)^2,{x,6}][[2,1,2]]],</span>
00310 <span class="comment">    */</span>
00311 
00312     x = 6;
00313     inc = x / 100.f;
00314     offset = fraction_merit_top * adjustRatio;
00315 
00316     <span class="keywordflow">if</span> ( calc_merit_aid_sls(sl, x+inc, offset)
00317          &gt; calc_merit_aid_sls(sl, x-inc, offset) )
00318         inc *= -1;
00319 
00320     deviate = calc_merit_aid_sls(sl, x, offset);
00321 
00322     <span class="keywordflow">do</span> {
00323         x += inc;
00324         lastDeviate = deviate;
00325         deviate = calc_merit_aid_sls(sl, x, offset);
00326     }
00327     <span class="keywordflow">while</span> ( deviate &lt; lastDeviate &amp;&amp; deviate &gt; 0 );
00328 
00329     merit_upper[sl] = x;
00330 }
00331 
00332 <span class="comment">//------------- End of function EnrollRes::calc_enroll_aid_sls ------//</span>
00333 
00334 <span class="comment">//----------- Begin of function EnrollRes::calc_merit_aid_sls --------//</span>
00339 <span class="comment">float EnrollRes::calc_merit_aid_sls(char sl, float aid, float base) {</span>
00340     <span class="keywordtype">float</span> deviate = 0, cdfTmp;
00341 
00342     <span class="keywordtype">float</span> aidMinMultiplier;
00343     <span class="keywordtype">char</span>  subSeg, arrSL=sl-1;
00344     <a class="code" href="structEnrollData.html">EnrollData</a>  *ed;
00345 
00346     <span class="comment">// meritFrObj[sL2,mL_] := Plus@@Flatten[meritFrObj[sL2,mL,#]&amp;/@gegs];</span>
00347     <span class="comment">// meritFrObj[sL2,mL_,geg_] := (1-cdf[acadR,sL2,geg,mL])*frPriorMatrics[sL2,geg];</span>
00348 
00349     <span class="comment">// cdf[acadR,sL_,geg_,x_] := gammaCDF[minMultF[aid,geg]*means[sL,geg],variances[sL,geg],x];</span>
00350 
00351     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
00352         <span class="keywordflow">if</span> ( !is_minority_group(subSeg) )
00353             aidMinMultiplier = 1.0f;
00354         <span class="keywordflow">else</span>
00355             aidMinMultiplier = aidMinMultipliers[minority_aid_special];
00356 
00357         ed = &amp;enroll_data_sls[arrSL][subSeg];
00358 
00359         cdfTmp = math.get_random_gamma_CDF( aidMinMultiplier * ed-&gt;<a class="code" href="structEnrollData.html#m8">academic</a>.<a class="code" href="structTalent.html#m0">average</a>,
00360                                             <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(ed-&gt;<a class="code" href="structEnrollData.html#m8">academic</a>.<a class="code" href="structTalent.html#m1">variance</a>), aid );
00361 
00362         deviate += (1-cdfTmp) * ed-&gt;<a class="code" href="structEnrollData.html#m2">fraction_matrics</a>;
00363     }
00364 
00365     <span class="keywordflow">return</span> math.safe_pow(deviate - base, 2);
00366 }
00367 
00368 <span class="comment">//----------- End of function EnrollRes::calc_merit_aid_sls --------//</span>
00369 
00370 <span class="comment">//----------- Begin of function EnrollRes::enroll_main_sls ------//</span>
<a name="l00374"></a><a class="code" href="classEnrollRes.html#a17">00374</a> <span class="comment">void EnrollRes::enroll_main_sls(char sl) {</span>
00375     <span class="comment">//----------------------------------------------------//</span>
00376     <span class="comment">//-- main procedures: td3.4 section 3.3                             ---//</span>
00377     <span class="comment">//----------------------------------------------------//</span>
00378 
00379     <span class="comment">/*</span>
00380 <span class="comment">      getApps[sL_] := ((applications[sL,#] =</span>
00381 <span class="comment">      Round[(1-matsLatency[sL])*stuPrefs[sL,#]*baseApps[sL,#] +</span>
00382 <span class="comment">      matsLatency[sL]*applications[sL,#]])&amp;/@gegs;</span>
00383 <span class="comment"></span>
00384 <span class="comment">      totalApps[sL] = Plus@@Flatten[applications[sL,#]&amp;/@gegs]);</span>
00385 <span class="comment">    */</span>
00386 
00387     <span class="keywordtype">char</span>  subSeg, arrSL=sl-1;
00388     <a class="code" href="structEnrollData.html">EnrollData</a>  *edSL;
00389     <span class="keywordtype">float</span> idealMatrics = 0;
00390     <span class="keywordtype">float</span> totalMatrics = 0;
00391 
00392     total_applications[sl] = 0;
00393 
00394     <span class="comment">//## chea 110899 avoid 0 Matrics</span>
00395 
00396     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
00397         <span class="keywordflow">if</span>(enroll_data_sls[arrSL][subSeg].conversion_rate &lt;= 0 &amp;&amp; target_student_intake[sl] &gt; 0) {
00398             enroll_data_sls[arrSL][subSeg].<a class="code" href="structEnrollData.html#m6">conversion_rate</a>=1;
00399         }
00400     }
00401 
00402     <span class="comment">/*  // this is the org. idea</span>
00403 <span class="comment">        for ( subSeg=0; subSeg&lt;STUDENT_SUBSEGMENT_COUNT; subSeg++ )</span>
00404 <span class="comment">        {</span>
00405 <span class="comment">        edSL = &amp;enroll_data_sls[arrSL][subSeg];</span>
00406 <span class="comment"></span>
00407 <span class="comment">        edSL-&gt;applications = int( 0.5 + math.get_random_snd(chance_avg, chance_sd, true)</span>
00408 <span class="comment">        + (1-apps_latency[sl]) * app_multiplier[arrSL] * edSL-&gt;student_pref * edSL-&gt;base_apps</span>
00409 <span class="comment">        + apps_latency[sl] * edSL-&gt;applications );</span>
00410 <span class="comment"></span>
00411 <span class="comment">        total_applications[sl] += edSL-&gt;applications;</span>
00412 <span class="comment">        idealMatrics += edSL-&gt;applications * edSL-&gt;conversion_rate;</span>
00413 <span class="comment"></span>
00414 <span class="comment">        err_when(edSL-&gt;applications &lt; 0);</span>
00415 <span class="comment">        }</span>
00416 <span class="comment">    */</span>
00417 
00418     <span class="comment">//## chea 270999 my idea</span>
00419     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
00420         edSL = &amp;enroll_data_sls[arrSL][subSeg];
00421 
00422         <span class="keywordflow">if</span>(sl ==2 || sl ==3 || sl ==1) {
00423             edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a> = int( 0.5 + math.get_random_snd(chance_avg, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(chance_sd), <span class="keyword">true</span>)
00424                                       + (1-apps_latency[sl]) * app_multiplier[arrSL] * edSL-&gt;<a class="code" href="structEnrollData.html#m5">student_pref</a> * edSL-&gt;<a class="code" href="structEnrollData.html#m1">base_apps</a>
00425                                       + apps_latency[sl] * edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a> );
00426         }
00427         <span class="comment">/*</span>
00428 <span class="comment">          else if(sl==4 &amp;&amp; player_school.school_type == 1 &amp;&amp; info.prerun_year == 1)</span>
00429 <span class="comment">          {</span>
00430 <span class="comment">          edSL-&gt;applications = 10;</span>
00431 <span class="comment">          }</span>
00432 <span class="comment">        */</span>
00433         <span class="keywordflow">else</span> {
00434             edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a> = int( 0.5 + math.get_random_snd(chance_avg, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(chance_sd), <span class="keyword">true</span>)
00435                                       + (1-apps_latency[sl]) * app_multiplier[arrSL] * edSL-&gt;<a class="code" href="structEnrollData.html#m5">student_pref</a> * edSL-&gt;<a class="code" href="structEnrollData.html#m1">base_apps</a>
00436                                       + apps_latency[sl] * edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a>);
00437         }
00438 
00439         total_applications[sl] += edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a>;
00440         totalMatrics += edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a> * edSL-&gt;<a class="code" href="structEnrollData.html#m6">conversion_rate</a>;
00441 
00442         <a class="code" href="ALL_8H.html#a0">err_when</a>(edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a> &lt; 0);
00443     }
00444 
00445     idealMatrics = math.safe_divide( (<span class="keywordtype">float</span>) target_student_intake[sl], totalMatrics);
00446 
00447 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00448 <span class="preprocessor"></span>    <span class="comment">// no need bound by 1</span>
00449 <span class="preprocessor">#else</span>
00450 <span class="preprocessor"></span>    <span class="comment">//990514</span>
00451     <span class="keywordflow">if</span> ( sl == <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a> )
00452         idealMatrics = min(1.0f,idealMatrics);        <span class="comment">//min &amp; max bug chea</span>
00453 <span class="preprocessor">#endif</span>
00454 <span class="preprocessor"></span>
00455     <span class="comment">//----------------------------------------------------//</span>
00456 
00457     <span class="comment">//if ( sl == DOCTOR &amp;&amp; idealMatrics &lt;= 0 )</span>
00458     <span class="comment">//  err_here();     //int x=0;</span>
00459 
00460     total_matrics[sl] = 0;
00461 
00462     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
00463         edSL = &amp;enroll_data_sls[arrSL][subSeg];
00464 
00465         edSL-&gt;<a class="code" href="structEnrollData.html#m4">matrics</a> = int ( 0.5 + min(
00466             <span class="comment">//min &amp; max bug chea</span>
00467             (<span class="keywordtype">float</span>)(edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a>), idealMatrics * edSL-&gt;<a class="code" href="structEnrollData.html#m6">conversion_rate</a> * edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a> ));
00468 
00469         total_matrics[sl] += edSL-&gt;<a class="code" href="structEnrollData.html#m4">matrics</a>;
00470 
00471         <a class="code" href="ALL_8H.html#a0">err_when</a>(edSL-&gt;<a class="code" href="structEnrollData.html#m4">matrics</a> &lt; 0);
00472         <span class="comment">//if ( sl == DOCTOR &amp;&amp; edSL-&gt;conversion_rate &gt; 0.99 )</span>
00473         <span class="comment">//      err_here();     //int x=0;</span>
00474     }
00475 
00476 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00477 <span class="preprocessor"></span>    <span class="comment">// Item 8d i)</span>
00478     <span class="keywordflow">if</span> ( sl == 4 ) {
00479         <span class="keywordtype">int</span> input1;
00480         <span class="keywordflow">switch</span> ( distance_learner_acceptance ) {
00481         <span class="keywordflow">case</span> 0: input1 = 0;             <span class="keywordflow">break</span>;
00482         <span class="keywordflow">case</span> 1: input1 = 8 * edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a>;  <span class="keywordflow">break</span>;
00483         <span class="keywordflow">case</span> 2: input1 = 16 * edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a>;
00484         }
00485 
00486         total_matrics[sl] = player_school.latency_func( 0.7f, total_matrics[sl], input1 );
00487     }
00488 <span class="preprocessor">#endif</span>
00489 <span class="preprocessor"></span>
00490     <span class="comment">//  if ( idealMatrics &gt;= total_matrics[sl] )</span>
00491     <span class="comment">//          err_here();     //int x=0;</span>
00492 
00493     <span class="comment">//----------------------------------------------------//</span>
00494 
00495     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
00496         edSL = &amp;enroll_data_sls[arrSL][subSeg];
00497 
00498         edSL-&gt;<a class="code" href="structEnrollData.html#m2">fraction_matrics</a> = math.safe_divide((edSL-&gt;<a class="code" href="structEnrollData.html#m4">matrics</a>), total_matrics[sl]);
00499         edSL-&gt;<a class="code" href="structEnrollData.html#m6">conversion_rate</a> = math.safe_divide((edSL-&gt;<a class="code" href="structEnrollData.html#m4">matrics</a>), edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a>);
00500 
00501         <a class="code" href="ALL_8H.html#a0">err_when</a>(edSL-&gt;<a class="code" href="structEnrollData.html#m6">conversion_rate</a> &lt; 0 || edSL-&gt;<a class="code" href="structEnrollData.html#m6">conversion_rate</a> &gt; 1);
00502     }
00503 
00504     <span class="comment">//----------------------------------------------------//</span>
00505     <span class="comment">// calc getMinAcadRating</span>
00506 
00507     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
00508         edSL = &amp;enroll_data_sls[arrSL][subSeg];
00509 
00510         <span class="keywordtype">float</span> x = 5, deviate, lastDeviate;
00511         <span class="keywordtype">float</span> inc = x / 100.f;
00512         <span class="keywordtype">float</span> offset = 1 - edSL-&gt;<a class="code" href="structEnrollData.html#m6">conversion_rate</a>;
00513 
00514         <span class="keywordflow">if</span> ( calc_academic_rating(sl, subSeg, x+inc, offset)
00515              &gt; calc_academic_rating(sl, subSeg, x-inc, offset) )
00516             inc *= -1;
00517 
00518         deviate = calc_academic_rating(sl, subSeg, x, offset);
00519 
00520         <span class="keywordflow">do</span> {
00521             x += inc;
00522             lastDeviate = deviate;
00523             deviate = calc_academic_rating(sl, subSeg, x, offset);
00524         }
00525         <span class="keywordflow">while</span> ( deviate &lt; lastDeviate &amp;&amp; deviate &gt; 0 );
00526 
00527         min_academic_rating[arrSL] = min(x, 10.0f);   <span class="comment">//min &amp; max bug chea</span>
00528     }
00529 
00530     <span class="comment">/*</span>
00531 <span class="comment">      getMinAcadRating[sL_,geg_,y_] := FindMinimum[(cdf[acadR,sL,geg,x]-(1-y))^2,{x,5}][[2,1,2]];</span>
00532 <span class="comment"></span>
00533 <span class="comment">      getAcadRatings[sL_] := (</span>
00534 <span class="comment">      (minAcadRating[sL,#] = Min[getMinAcadRating[sL,#,conversionRate[sL,#]],10])&amp;/@gegs;</span>
00535 <span class="comment">      minAcadRating[sL]   = Min[minAcadRating[sL,#]&amp;/@gegs];    )</span>
00536 <span class="comment">    */</span>
00537 }
00538 
00539 <span class="comment">//------------- End of function EnrollRes::enroll_main_sls ------//</span>
00540 
00541 <span class="comment">//----------- Begin of function EnrollRes::calc_academic_rating --------//</span>
00545 <span class="comment">float EnrollRes::calc_academic_rating(char sl, char subSeg, float academicRating, float base) {</span>
00546     <span class="keywordtype">float</span> deviate = 0, cdfTmp, aidMinMultiplier;
00547 
00548     <span class="keywordtype">char</span>  arrSL=sl-1;
00549     <a class="code" href="structEnrollData.html">EnrollData</a>  *ed;
00550 
00551     <span class="comment">// cdf[acadR,sL_,geg_,x_] := gammaCDF[minMultF[aid,geg]*means[sL,geg],variances[sL,geg],x];</span>
00552 
00553     <span class="keywordflow">if</span> ( !is_minority_group(subSeg) )
00554         aidMinMultiplier = 1.0f;
00555     <span class="keywordflow">else</span>
00556         aidMinMultiplier = aidMinMultipliers[minority_aid_special];
00557 
00558     ed = &amp;enroll_data_sls[arrSL][subSeg];
00559 
00560     cdfTmp = math.get_random_gamma_CDF( aidMinMultiplier * ed-&gt;<a class="code" href="structEnrollData.html#m8">academic</a>.<a class="code" href="structTalent.html#m0">average</a>,
00561                                         <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(ed-&gt;<a class="code" href="structEnrollData.html#m8">academic</a>.<a class="code" href="structTalent.html#m1">variance</a>), academicRating);
00562 
00563     deviate = cdfTmp;
00564 
00565     <span class="keywordflow">return</span> math.safe_pow(deviate - base, 2);
00566 }
00567 
00568 <span class="comment">//----------- End of function EnrollRes::calc_academic_rating --------//</span>
00569 
00570 <span class="comment">//----------- Begin of function EnrollRes::calc_post_enroll_sls --------//</span>
00574 <span class="comment">void EnrollRes::calc_post_enroll_sls(char sl) {</span>
00575     <span class="comment">//-------------------------//</span>
00576     <span class="comment">//           generate student               //</span>
00577     <span class="comment">//-------------------------//</span>
00578 
00579     <a class="code" href="structEnrollData.html">EnrollData</a> *edSL;
00580     <span class="keywordtype">char</span>  subSeg, seg=-1;
00581     <span class="keywordtype">int</span> newStudentCount, i, arrSL=sl-1;
00582 
00583     <span class="comment">// temp vars storing new sim properties</span>
00584     <span class="keywordtype">float</span> talentArr[<a class="code" href="Ostudent_8h.html#a39a25">TALENT_VAR_COUNT</a>];
00585     <span class="keywordtype">int</span> aid=0;
00586 
00587     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
00588         edSL = &amp;enroll_data_sls[arrSL][subSeg];
00589         newStudentCount = edSL-&gt;<a class="code" href="structEnrollData.html#m4">matrics</a>;
00590 
00591         <span class="keywordflow">for</span> (i=0; i&lt;newStudentCount; i++) {
00592             <span class="keywordtype">char</span> subSegStu = subSeg;
00593 
00594             <span class="keywordflow">if</span> ( info.year_passed == 1 &amp;&amp; player_school.scenario_id == <a class="code" href="Opschool_8h.html#a63a29">SCN_STUDENT_DIVERSITY</a> ) {
00595                 <span class="keywordflow">if</span> ( is_minority_group(subSeg) &amp;&amp; math.get_random_float () &gt; 0.571f ) {
00596                     <span class="keywordflow">if</span> (subSegStu == <a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a> )
00597                         subSegStu = <a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a>;
00598                     <span class="keywordflow">else</span>
00599                         subSegStu = <a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a>;
00600                 }
00601             }
00602 
00603             <span class="comment">//------- calc 3 talent values and aid</span>
00604 
00605             calc_a_talent(talentArr, sl, subSegStu);
00606 
00607             <span class="comment">// 990408</span>
00608             <span class="comment">/*if ( sl == DOCTOR &amp;&amp; talentArr[ACADEMIC] &lt; min_academic_rating[arrSL] )</span>
00609 <span class="comment">              {</span>
00610 <span class="comment">              // if acadRating &lt; minAcadRating, then discard this applicant</span>
00611 <span class="comment">              edSL-&gt;matrics--;</span>
00612 <span class="comment">              continue;</span>
00613 <span class="comment">              }*/</span>
00614 
00615             <span class="comment">//-------  Generate student; see also PlayerSchool::generate_student()</span>
00616             <span class="comment">//</span>
00617 
00618             <span class="keywordflow">if</span> ( is_nontradition_ug_group(sl) ) {
00619                 <span class="comment">// all year 1 ug students start without major</span>
00620                 department_res.general_dept.student_array.add( sl, 1, subSegStu, seg, 0, <span class="keywordtype">int</span>(aid), talentArr );
00621             }
00622             <span class="keywordflow">else</span> {
00623                 <span class="keywordtype">int</span> major = player_school.get_random_major(sl);
00624                 department_array[major]-&gt;student_array.add( sl, 1, subSegStu, seg, major, <span class="keywordtype">int</span>(aid), talentArr );
00625             }
00626 
00627             <span class="comment">//-------  update vars for calc average later</span>
00628 
00629             talent_average[sl][<a class="code" href="Ostudent_8h.html#a39a26">ACADEMIC</a>] += int( 10 * talentArr[<a class="code" href="Ostudent_8h.html#a39a26">ACADEMIC</a>]);
00630         }
00631     }
00632 
00633     <span class="comment">//----------------------------------------------------//</span>
00634 
00635     <span class="comment">// recalc matrics since some are discarded above</span>
00636 
00637     <span class="comment">//----------------------------------------------------//</span>
00638 
00639 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00640 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( sl != 4 ) {                                <span class="comment">// Not distance learning</span>
00641 <span class="preprocessor">#endif</span>
00642 <span class="preprocessor"></span>        total_matrics[sl] = 0;
00643 
00644         <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
00645             edSL = &amp;enroll_data_sls[arrSL][subSeg];
00646 
00647             total_matrics[sl] += edSL-&gt;<a class="code" href="structEnrollData.html#m4">matrics</a>;
00648 
00649             <a class="code" href="ALL_8H.html#a0">err_when</a>(edSL-&gt;<a class="code" href="structEnrollData.html#m4">matrics</a> &lt; 0);
00650         }
00651 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00652 <span class="preprocessor"></span>    }
00653 <span class="preprocessor">#endif</span>
00654 <span class="preprocessor"></span>    <span class="comment">//----------------------------------------------------//</span>
00655 
00656     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
00657         edSL = &amp;enroll_data_sls[arrSL][subSeg];
00658 
00659         edSL-&gt;<a class="code" href="structEnrollData.html#m2">fraction_matrics</a> = math.safe_divide((edSL-&gt;<a class="code" href="structEnrollData.html#m4">matrics</a>), total_matrics[sl]);
00660         edSL-&gt;<a class="code" href="structEnrollData.html#m6">conversion_rate</a> = math.safe_divide((edSL-&gt;<a class="code" href="structEnrollData.html#m4">matrics</a>), edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a>);
00661 
00662         <a class="code" href="ALL_8H.html#a0">err_when</a>(edSL-&gt;<a class="code" href="structEnrollData.html#m6">conversion_rate</a> &lt; 0 || edSL-&gt;<a class="code" href="structEnrollData.html#m6">conversion_rate</a> &gt; 1);
00663     }
00664 
00665     <span class="comment">//----------------------------------------------------//</span>
00666     <span class="comment">//990408</span>
00667 
00668     <span class="keywordtype">int</span> subOffer = 0;
00669 
00670     <span class="keywordflow">for</span> ( subSeg=0; subSeg&lt;<a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>; subSeg++ ) {
00671         edSL = &amp;enroll_data_sls[arrSL][subSeg];
00672 
00673         subOffer += int( edSL-&gt;<a class="code" href="structEnrollData.html#m4">matrics</a> + (edSL-&gt;<a class="code" href="structEnrollData.html#m3">applications</a> - edSL-&gt;<a class="code" href="structEnrollData.html#m4">matrics</a> ) *
00674                          m.fmin(1.0f, m.fmax(0.0f,math.get_random_snd(edSL-&gt;<a class="code" href="structEnrollData.html#m6">conversion_rate</a>,
00675                                                                       <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(edSL-&gt;<a class="code" href="structEnrollData.html#m6">conversion_rate</a> * 0.1f)))) ); <span class="comment">//min &amp; max bug chea</span>
00676     }
00677 
00678     <span class="comment">//total_offers[sl] = int(total_matrics[sl] * 1.4f);</span>
00679     total_offers[sl] = subOffer;
00680 }
00681 
00682 <span class="comment">//----------- End of function EnrollRes::calc_post_enroll_sls --------//</span>
00683 
00684 <span class="comment">//----------- Begin of function EnrollRes::calc_an_aid --------//</span>
<a name="l00689"></a><a class="code" href="classEnrollRes.html#a15">00689</a> <span class="comment">float EnrollRes::calc_an_aid(Student *stuPtr) {</span>
00690     <span class="keywordtype">char</span> sl = stuPtr-&gt;student_level;
00691     <span class="keywordtype">char</span> subSeg = stuPtr-&gt;gender_ethnic_group;
00692     <span class="keywordtype">char</span> seg = stuPtr-&gt;student_segment;
00693 
00694     <span class="comment">//------- calc need and merit aid</span>
00695     <a class="code" href="structEnrollDataSL1.html">EnrollDataSL1</a> *ed;
00696     <a class="code" href="structTalent.html">Talent</a> *talentPtr;
00697     <span class="keywordtype">float</span> utility, needAid, meritAid, income;
00698     <span class="keywordtype">float</span> aid;
00699 
00700     <span class="keywordflow">if</span> ( sl == 0 ) {
00701         <a class="code" href="ALL_8H.html#a0">err_when</a>(seg &lt; 0 || seg &gt;= <a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>);
00702 
00703         ed = &amp;enroll_data_sl1[subSeg][seg];
00704         talentPtr = &amp;(talent_array[subSeg][seg][<a class="code" href="Ostudent_8h.html#a39a26">ACADEMIC</a>]);
00705 
00706         <span class="comment">// ## chea 100899 use small variance to change aid</span>
00707         <span class="comment">//              income = math.get_random_snd(talentPtr[INCOME].average, float(sqrt(talentPtr[INCOME].variance)), true );</span>
00708         <span class="comment">//              utility = math.get_random_snd(ed-&gt;util, float(sqrt(ed-&gt;util_variance)), true );</span>
00709 
00710         income = math.get_random_snd(talentPtr[<a class="code" href="Ostudent_8h.html#a39a29">INCOME</a>].average, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(<span class="keywordtype">float</span>(sqrt(talentPtr[<a class="code" href="Ostudent_8h.html#a39a29">INCOME</a>].variance))/4.0f), <span class="keyword">true</span> );
00711         utility = math.get_random_snd(ed-&gt;<a class="code" href="structEnrollDataSL1.html#m8">util</a>, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(<span class="keywordtype">float</span>(sqrt(ed-&gt;<a class="code" href="structEnrollDataSL1.html#m9">util_variance</a>))/4.0f), <span class="keyword">true</span> );
00712 
00713         <span class="comment">// adjust utility</span>
00714 
00715         <span class="keywordflow">if</span> ( seg == <a class="code" href="Oenroll_8h.html#a31a11">STUDENT_SEGMENT_ATHLETE</a> ) {
00716             <span class="keywordflow">switch</span> (athlete_offers_special) {
00717             <span class="keywordflow">case</span> <a class="code" href="Oenroll_8h.html#a35a29">SET_HIGH</a>:
00718                 utility = max(utility,10.0f);           <span class="comment">// min &amp; max bug chea</span>
00719                 <span class="keywordflow">break</span>;
00720             <span class="keywordflow">case</span> <a class="code" href="Oenroll_8h.html#a35a28">SET_MID</a>:
00721                 utility = ( 10 + utility ) / 2;
00722                 <span class="keywordflow">break</span>;
00723             <span class="keywordflow">default</span>:
00724                 <span class="keywordflow">break</span>;
00725             }
00726         }
00727 
00728         <span class="comment">//---- calc need and merit aid ---------//</span>
00729 
00730         <span class="keywordflow">if</span> ( income &lt; need_lower )
00731             needAid = fraction_need_covered * max_aid;
00732         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( income &lt; need_upper )
00733             needAid = fraction_need_covered * max_aid * (need_upper-income) / (need_upper - need_lower);
00734         <span class="keywordflow">else</span>
00735             needAid = 0;
00736 
00737         <span class="keywordflow">if</span> ( fraction_sl1_offered_merit_aid &lt;= 0 )
00738             merit_upper[sl] = 10;
00739 
00740         <span class="keywordflow">if</span> ( utility &gt; merit_upper[sl] )
00741             meritAid = max_aid - needAid;
00742         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( utility &gt; merit_lower[sl] )
00743             <span class="comment">// min &amp; max bug chea</span>
00744             meritAid = max( max_aid * <span class="keywordtype">float</span>(utility - merit_lower[sl]) / (merit_upper[sl] - merit_lower[sl]) - needAid, 0.0f );
00745         <span class="keywordflow">else</span>
00746             meritAid = 0;
00747 
00748         <span class="comment">//meritAid = 0;         //990408</span>
00749         <a class="code" href="ALL_8H.html#a0">err_when</a>(need_upper == need_lower);
00750         <a class="code" href="ALL_8H.html#a0">err_when</a>(merit_upper[sl] == merit_lower[sl]);
00751 
00752         <span class="comment">//------------------ calc final aid</span>
00753 
00754         <a class="code" href="ALL_8H.html#a0">err_when</a>(needAid + meritAid &gt; max_aid + 0.15);
00755 
00756         aid = ((needAid + meritAid));
00757 
00758         <span class="keywordflow">if</span> ( seg == <a class="code" href="Oenroll_8h.html#a31a11">STUDENT_SEGMENT_ATHLETE</a> ) {
00759             <span class="keywordflow">switch</span> (athlete_aid_special) {
00760             <span class="keywordflow">case</span> <a class="code" href="Oenroll_8h.html#a35a29">SET_HIGH</a>:
00761                 aid = ( max_aid);
00762                 <span class="keywordflow">break</span>;
00763             <span class="keywordflow">case</span> <a class="code" href="Oenroll_8h.html#a35a28">SET_MID</a>:
00764                 aid = ( (max_aid+aid) / 2.0f);
00765                 <span class="keywordflow">break</span>;
00766             <span class="keywordflow">default</span>:
00767                 <span class="keywordflow">break</span>;
00768             }
00769         }
00770     }
00771 
00772     <span class="comment">//-------- sl2-5 -----------//</span>
00773 
00774     <span class="keywordflow">else</span> {
00775         <span class="comment">//--- mertiAid only</span>
00776         <span class="comment">// utility = academic rating in sl2-5</span>
00777         utility = float(stuPtr-&gt;talent_academic) / 10;
00778 
00779         <span class="keywordflow">if</span> ( sl == <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a> )
00780             meritAid = max_aid;
00781         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( merit_upper[sl] &lt; merit_lower[sl] )
00782             meritAid = 0;
00783         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( utility &gt; merit_upper[sl] )
00784             meritAid = max_aid;                         <span class="comment">//0223</span>
00785         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( utility &gt; merit_lower[sl] )
00786             <span class="comment">// min &amp; max bug chea</span>
00787             meritAid = max( max_aid * <span class="keywordtype">float</span>(utility - merit_lower[sl]) / (merit_upper[sl] - merit_lower[sl]), 0.0f );
00788         <span class="keywordflow">else</span>
00789             meritAid = 0;
00790 
00791         aid = (meritAid);
00792     }
00793 
00794     <a class="code" href="ALL_8H.html#a0">err_when</a>(aid &gt; (max_aid + 0.10));
00795     total_aid += aid;
00796 
00797     <span class="keywordflow">return</span> aid;
00798 }
00799 
00800 <span class="comment">//----------- End of function EnrollRes::calc_an_aid --------//</span>
00801 
00802 <span class="comment">//----------- Begin of function EnrollRes::calc_a_talent --------//</span>
<a name="l00805"></a><a class="code" href="classEnrollRes.html#a16">00805</a> <span class="comment">void EnrollRes::calc_a_talent(float talentArr[TALENT_VAR_COUNT], char sl, char subSeg, char seg) {</span>
00806     <a class="code" href="ALL_8H.html#a0">err_when</a>(subSeg &lt; 0 || subSeg &gt;= <a class="code" href="Oenroll_8h.html#a31a10">STUDENT_SUBSEGMENT_COUNT</a>);
00807 
00808     <span class="keywordflow">if</span> ( sl == <a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a> ) {
00809         <a class="code" href="ALL_8H.html#a0">err_when</a>(seg &lt; 0 || seg &gt;= <a class="code" href="Oenroll_8h.html#a31a9">STUDENT_SEGMENT_COUNT</a>);
00810 
00811         <a class="code" href="structTalent.html">Talent</a> *talentPtr;
00812         talentPtr = &amp;(talent_array[subSeg][seg][<a class="code" href="Ostudent_8h.html#a39a26">ACADEMIC</a>]);
00813 
00814         <span class="keywordflow">for</span> (<span class="keywordtype">char</span> t=0; t&lt;<a class="code" href="Ostudent_8h.html#a39a25">TALENT_VAR_COUNT</a>; t++)
00815             talentArr[t] = math.get_random_snd(talentPtr[t].average, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(<span class="keywordtype">float</span>(sqrt(talentPtr[t].variance))), <span class="keyword">true</span> );
00816     }
00817     <span class="keywordflow">else</span> {
00818         <span class="keywordtype">char</span> arrSL = sl-1;
00819         <a class="code" href="structEnrollData.html">EnrollData</a> *edSL;
00820 
00821         edSL = &amp;enroll_data_sls[arrSL][subSeg];       <span class="comment">// enroll_data_sls[MAX_STUDENT_LEVEL_NO_SL1][STUDENT_SUBSEGMENT_COUNT];</span>
00822 
00823         <span class="keywordflow">if</span> ( sl == <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a> )
00824             <span class="comment">// min &amp; max bug chea</span>
00825             talentArr[<a class="code" href="Ostudent_8h.html#a39a26">ACADEMIC</a>] = m.fmin(100.0f, math.get_random_snd(math.single_response_func(0.7f, 1.3f, 100, 50, edSL-&gt;<a class="code" href="structEnrollData.html#m8">academic</a>.<a class="code" href="structTalent.html#m0">average</a>), <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(<span class="keywordtype">float</span>(sqrt(edSL-&gt;<a class="code" href="structEnrollData.html#m8">academic</a>.<a class="code" href="structTalent.html#m1">variance</a>))), <span class="keyword">true</span> ));
00826         <span class="keywordflow">else</span>
00827             talentArr[<a class="code" href="Ostudent_8h.html#a39a26">ACADEMIC</a>] = math.get_random_snd(edSL-&gt;<a class="code" href="structEnrollData.html#m8">academic</a>.<a class="code" href="structTalent.html#m0">average</a>, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(<span class="keywordtype">float</span>(sqrt(edSL-&gt;<a class="code" href="structEnrollData.html#m8">academic</a>.<a class="code" href="structTalent.html#m1">variance</a>))), <span class="keyword">true</span> );
00828         talentArr[<a class="code" href="Ostudent_8h.html#a39a27">EXTRA_CURRI</a>] = talentArr[<a class="code" href="Ostudent_8h.html#a39a28">ATHLETIC</a>] = 0;
00829 
00830     }
00831 
00832     <span class="comment">//## chea 161299 testing only</span>
00833     <span class="comment">//  talentArr[0]=talentArr[1]=talentArr[2] = 3.3f;</span>
00834 
00835 }
00836 
00837 <span class="comment">//----------- End of function EnrollRes::calc_a_talent --------//</span>
00838 
00839 <span class="comment">//------------- End of function EnrollRes::calc_talent_student_db --------//</span>
00840 <span class="comment">//</span>
00841 <span class="comment">// calc talent of students in db: returning student</span>
00842 <span class="comment">//</span>
00843 <span class="keywordtype">void</span> EnrollRes::calc_talent_student_db() {
00844     <a class="code" href="classStudentArray.html">StudentArray</a>* stuArr;
00845     <a class="code" href="classStudent.html">Student</a> *stuPtr;
00846     <span class="keywordtype">float</span> talentArr[<a class="code" href="Ostudent_8h.html#a39a25">TALENT_VAR_COUNT</a>];
00847     <span class="keywordtype">int</span> stuCount=0, i, j;
00848 
00849     <a class="code" href="ALL_8H.html#a0">err_when</a>( department_array.size() == 0 );
00850     <span class="keywordflow">for</span> ( i=department_array.size(); i&gt;=0; i-- ) {
00851         <span class="keywordflow">if</span> (i) {
00852             <span class="keywordflow">if</span> ( department_array.is_deleted(i) )
00853                 <span class="keywordflow">continue</span>;
00854 
00855             stuArr = &amp;(department_array[i]-&gt;student_array);
00856         }
00857         <span class="keywordflow">else</span>
00858             stuArr = &amp;(department_res.general_dept.student_array);
00859 
00860         <span class="comment">// loop student</span>
00861         <span class="keywordflow">for</span> (j=stuArr-&gt;<a class="code" href="classDynArray.html#a28">size</a>(); j&gt;0; j--) {
00862             <span class="keywordflow">if</span> ( stuArr-&gt;<a class="code" href="classStudentArray.html#a9">is_deleted</a>(j) )
00863                 <span class="keywordflow">continue</span>;
00864 
00865             stuPtr = stuArr-&gt;operator[](j);
00866 
00867             <span class="keywordtype">char</span> studentLevel = stuPtr-&gt;<a class="code" href="classStudent.html#m2">student_level</a>;
00868             <span class="keywordtype">char</span> stuSeg = stuPtr-&gt;<a class="code" href="classStudent.html#m4">student_segment</a>;
00869             <span class="keywordtype">char</span> genderEthnicGroup = stuPtr-&gt;<a class="code" href="classStudent.html#m3">gender_ethnic_group</a>;
00870 
00871             <span class="keywordflow">if</span> ( studentLevel == <a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a> ) {
00872                 <span class="comment">//-------- assume: enroll_res.init() (dbf init) called --------//</span>
00873                 <a class="code" href="classEnrollRes.html#a16">calc_a_talent</a>(talentArr, studentLevel, genderEthnicGroup, stuSeg);
00874             }
00875             <span class="keywordflow">else</span> {
00876                 <span class="comment">//-------- assume: value will be assigned after enroll_res.init_data() called</span>
00877                 <a class="code" href="classEnrollRes.html#a16">calc_a_talent</a>(talentArr, studentLevel, genderEthnicGroup);
00878             }
00879             <span class="comment">//## 071299 chea 1.12.1</span>
00880             <span class="comment">// min &amp; max bug chea</span>
00881             stuPtr-&gt;<a class="code" href="classStudent.html#m20">talent_academic</a>       = (char) max(0.0f,min(100.0f, talentArr[<a class="code" href="Ostudent_8h.html#a39a26">ACADEMIC</a>] * 10));
00882             <span class="comment">//                  stuPtr-&gt;talent_academic                         = 33; //##200100 cHEA</span>
00883 
00884             <span class="comment">// min &amp; max bug chea</span>
00885             stuPtr-&gt;<a class="code" href="classStudent.html#m21">talent_extracurricular</a>  = (char) max(0.0f,min(100.0f, talentArr[<a class="code" href="Ostudent_8h.html#a39a27">EXTRA_CURRI</a>] * 10));
00886             <span class="comment">// min &amp; max bug chea</span>
00887             stuPtr-&gt;<a class="code" href="classStudent.html#m22">talent_athletics</a>      = (char) max(0.0f,min(100.0f, talentArr[<a class="code" href="Ostudent_8h.html#a39a28">ATHLETIC</a>] * 10));
00888 
00889             <span class="comment">//                  stuPtr-&gt;talent_academic                         = (char) max(0.0f,min(100.0f, talentArr[ACADEMIC])); // min &amp; max bug chea</span>
00890             <span class="comment">//                  stuPtr-&gt;talent_extracurricular  = (char) max(0.0f,min(100.0f, talentArr[EXTRA_CURRI])); // min &amp; max bug chea</span>
00891             <span class="comment">//                  stuPtr-&gt;talent_athletics                        = (char) max(0.0f,min(100.0f, talentArr[ATHLETIC])); // min &amp; max bug chea</span>
00892 
00893             stuCount++;
00894         }
00895     }
00896 
00897     <a class="code" href="ALL_8H.html#a0">err_when</a>(stuCount != <a class="code" href="classEnrollRes.html#m4">total_student_count</a>);
00898 }
00899 
00900 <span class="comment">//------------- End of function EnrollRes::calc_talent_student_db--------//</span>
00901 
00902 <span class="comment">// ##### Begin Marco #### //</span>
00903 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00904 <span class="preprocessor"></span><span class="comment">// ----------- Begin of function EnrollRes::save_initial_data --------//</span>
00905 <span class="keywordtype">void</span> EnrollRes::save_initial_data() {
00906     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; i++) {
00907         initial_offers_rate[i] = <a class="code" href="classEnrollRes.html#m18">offers_rate</a>[i];
00908         initial_cur_yield_rate[i] = <a class="code" href="classEnrollRes.html#m17">cur_yield_rate</a>[i];
00909     }
00910 
00911     initial_matrics_top_athletes = <a class="code" href="classEnrollRes.html#m11">matrics_top_athletes</a>;
00912 }
00913 
00914 <span class="comment">// ----------- End of function EnrollRes::save_initial_data --------//</span>
00915 <span class="preprocessor">#endif</span>
00916 <span class="preprocessor"></span><span class="comment">// ##### End Marco #### //</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:28 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
