<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Ofin_s3.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Ofin_s3.cpp</h1><a href="Ofin__s3_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OFINANCE.CPP</span>
00002 <span class="comment">//Description : Finance class: stage3.  Algorithm from email Q32* and reQ32*</span>
00003 <span class="comment">//Owner       : Fred</span>
00004 
00005 <span class="preprocessor">#include &lt;STDIO.H&gt;</span>                                <span class="comment">//temp for debug matrix</span>
00006 <span class="preprocessor">#include &lt;<a class="code" href="OLOG_8H.html">OLOG.H</a>&gt;</span>                                 <span class="comment">// for debug matrix</span>
00007 <span class="preprocessor">#include &lt;OMATH.H&gt;</span>
00008 
00009 <span class="preprocessor">#include &lt;ODEPT.H&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="ODEPTRES_8H.html">ODEPTRES.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;OFACURES.H&gt;</span>
00012 
00013 <span class="comment">// CU header file</span>
00014 <span class="preprocessor">#include &lt;OLinAlg.h&gt;</span>                              <span class="comment">// for its quadratic_prog() and class Matrix</span>
00015 <span class="preprocessor">#include &lt;OFINANCE.H&gt;</span>
00016 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>                                 <span class="comment">//## chea</span>
00017 <span class="preprocessor">#include &lt;<a class="code" href="OBOX_8H.html">OBOX.H</a>&gt;</span>                                 <span class="comment">//## chea</span>
00018 
00019 <span class="comment">//#define DEBUG_VC</span>
00020 <span class="comment">//#define TEST_MATHCA</span>
00021 
00022 <span class="comment">//---------- Begin of static function prt_vector -----------//</span>
00023 <span class="keyword">static</span> <span class="keywordtype">void</span> print_vector(<span class="keyword">const</span> ColumnVector &amp;xNames) {
00024 <span class="preprocessor">#ifdef DEBUG_VC</span>
00025 <span class="preprocessor"></span>    <span class="keywordtype">char</span> s[300];
00026     sprintf(s, <span class="stringliteral">"%f, %f, %f, %f, %f, %f, %f, %f, %f, %f"</span>,
00027             xNames(1),xNames(2),xNames(3),
00028             xNames(4),xNames(5),xNames(6),
00029             xNames(7),xNames(8),xNames(9),xNames(10));
00030     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(s);
00031 <span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span>}
00033 
00034 <span class="keyword">static</span> <span class="keywordtype">void</span> print_vector2(<span class="keyword">const</span> ColumnVector &amp;xNames) {
00035 <span class="preprocessor">#ifdef DEBUG_VC</span>
00036 <span class="preprocessor"></span>    <span class="keywordtype">int</span> count = xNames.Storage();
00037     <a class="code" href="classString.html">String</a> s = <span class="stringliteral">"-&gt;"</span>;
00038     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i&lt;=count; i++ ) {
00039         s += <span class="stringliteral">", "</span>;
00040         s += m.format(xNames(i),0);
00041     }
00042     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(s);
00043 <span class="preprocessor">#endif</span>
00044 <span class="preprocessor"></span>}
00045 
00046 <span class="comment">//------ Begin of function sort_teaching_load_function ------//</span>
00050 <span class="comment">static int sort_teaching_load_function( const void *a, const void *b ) {</span>
00051     <span class="comment">// 1st sort key</span>
00052 
00053     <span class="keywordtype">float</span> valueA = department_array[*((<span class="keywordtype">char</span>*)a)]-&gt;faculty_array.teaching_contact_hour[THIS_TRIMESTER-1];
00054     <span class="keywordtype">float</span> valueB = department_array[*((<span class="keywordtype">char</span>*)b)]-&gt;faculty_array.teaching_contact_hour[THIS_TRIMESTER-1];
00055 
00056     <span class="keywordtype">float</span> rc = valueA - valueB;
00057 
00058     <span class="keywordflow">if</span>( rc &lt; 0 )
00059         <span class="keywordflow">return</span> 1;
00060     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( rc &gt; 0 )
00061         <span class="keywordflow">return</span> -1;
00062     <span class="keywordflow">else</span>
00063         <span class="keywordflow">return</span> 0;
00064 }
00065 
00066 <span class="comment">//------- End of function sort_teaching_load_function ------//</span>
00067 
00068 <span class="comment">//---------- Begin of function Finance::calc_max_hires -----------//</span>
<a name="l00073"></a><a class="code" href="classFinance.html#a1">00073</a> <span class="comment">void Finance::calc_max_hires() {</span>
00074 <span class="preprocessor">#if(GAME_VERSION&gt;=200)                          // remove stage1_revenue, stage1_expense, stage2_expense</span>
00075 <span class="preprocessor"></span>
00076     <span class="keywordtype">double</span> growthRate, newValue; {
00077 
00078         <span class="comment">// = F203/100</span>
00079         growthRate = cost_rise_policy_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].result_value / 100;
00080 
00081         <span class="keywordtype">double</span> researchNewValue = 0.0;                <span class="comment">// will be canceled out, so no need to find stage1_revenue[S1_DIRECT_SPONSORED_RESEARCH].new_value</span>
00082         <span class="keywordtype">double</span> dept_faculty_new_price = prior_dept_fac_exp * (1+inflation_rate/100.0+expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a70">PL_FACULTY_SALARY_INCREASES</a>].result_value/100.0);
00083         <span class="comment">//double change_value = dept_faculty_new_price * cost_rise_policy_array[AC_ACADEMIC_DEPARTMENTS].result_value + researchNewValue;</span>
00084         <span class="keywordtype">double</span> change_value = dept_faculty_new_price * cost_rise_policy_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].result_value/100.0 + researchNewValue;
00085         newValue = dept_faculty_new_price + change_value - researchNewValue;
00086     }
00087 <span class="preprocessor">#else</span>
00088 <span class="preprocessor"></span>
00089     <span class="comment">// = F203/100</span>
00090     <span class="keywordtype">double</span> growthRate = finance.stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a28">S2_DEPARTMENTAL_FACULTY</a>].computed_growthrate / 100;
00091 
00092     <span class="keywordtype">double</span> newValue = finance.stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a28">S2_DEPARTMENTAL_FACULTY</a>].new_value;
00093 <span class="preprocessor">#endif</span>
00094 <span class="preprocessor"></span>
00095     <span class="comment">// growthAmount = newValue - oldValue</span>
00096     <span class="keywordtype">double</span> growthAmount = newValue - newValue / (1.0+growthRate);
00097 
00098     <span class="comment">//------- calculate the average salary ---------//</span>
00099 
00100     <span class="keywordtype">int</span> totalSalary = 0;
00101     <span class="keywordtype">int</span> facCount = 0;
00102 
00103     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=department_array.department_count; i&gt;0; i--) {
00104         <a class="code" href="classDepartment.html">Department</a>* deptPtr = department_array[i];
00105 
00106 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00107 <span class="preprocessor"></span>        <span class="keywordtype">int</span> facultyNo = deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#m1">faculty_count</a>;
00108 
00109         <span class="comment">// get the total salary among all of the faculty</span>
00110         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=facultyNo; i&gt;0; i-- ) {
00111             <span class="keywordflow">if</span> ( deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#a10">is_deleted</a>(i) )
00112                 <span class="keywordflow">continue</span>;
00113 
00114             <a class="code" href="classFaculty.html">Faculty</a>* facPtr = deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>[i];
00115 
00116             totalSalary += facPtr-&gt;<a class="code" href="classFaculty.html#m11">salary</a>;
00117         }
00118 <span class="preprocessor">#else</span>
00119 <span class="preprocessor"></span>        totalSalary += ( (deptPtr-&gt;<a class="code" href="classDepartment.html#m33">buget_average_salary</a>&gt;0) ? deptPtr-&gt;<a class="code" href="classDepartment.html#m33">buget_average_salary</a>:
00120                          int(deptPtr-&gt;<a class="code" href="classDepartment.html#m30">peer_numeraire_salary</a> * deptPtr-&gt;<a class="code" href="classDepartment.html#m28">peer_salary_multiplier_rank</a>[<a class="code" href="Ofaculty_8h.html#a27a9">ASST_PROF</a>])
00121             ) * deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#m1">faculty_count</a>;
00122 <span class="preprocessor">#endif</span>
00123 <span class="preprocessor"></span>
00124         facCount += deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#m1">faculty_count</a>;
00125     }
00126 
00127     <span class="keywordtype">int</span> avgSalary = totalSalary / facCount;
00128 
00129     <span class="comment">//----- calc # of departures in the past year ------//</span>
00130 
00131     <span class="keywordtype">int</span> departureCount = max(0, department_array.faculty_level_history[<a class="code" href="Ofaculty_8h.html#a26a8">FACULTY_RANK_LEVEL_COUNT</a>][THIS_YEAR]
00132                              - facCount);
00133 
00134     <span class="comment">//-------------------------------------//</span>
00135 
00136     <span class="comment">//#if(GAME_VERSION&gt;=200)</span>
00137     <span class="comment">//  max_hires = growthAmount*facCount + departureCount;</span>
00138     <span class="comment">//#else</span>
00139     max_hires = int(growthAmount*1000) / avgSalary + departureCount;
00140     <span class="comment">//#endif</span>
00141 
00142     max_hires = max(0, max_hires);
00143     <span class="comment">// 0116</span>
00144     max_hires = min(<a class="code" href="Ofinanc2_8h.html#a4">MAX_S3_SLIDER</a> * department_array.department_count, max_hires);
00145 
00146     <span class="comment">/*</span>
00147 <span class="comment">      //        maxHires = costLimit /</span>
00148 <span class="comment">      //                ( sum_over_depts{{E153*(1+F203)}[d]*target[d]}/sum_over_depts{TARGET[d]} )</span>
00149 <span class="comment">      // where E153 is the average salary for fullProf2 in the department.</span>
00150 <span class="comment"></span>
00151 <span class="comment">      //-------//</span>
00152 <span class="comment"></span>
00153 <span class="comment">      int totalSalary = 0;</span>
00154 <span class="comment">      int avgSalary = 0;</span>
00155 <span class="comment">      int facCount = 0;</span>
00156 <span class="comment">      max_hires = 0; //## chea to remove the pervious value</span>
00157 <span class="comment"></span>
00158 <span class="comment">      for (int i=department_array.department_count; i&gt;0; i--)</span>
00159 <span class="comment">      {</span>
00160 <span class="comment">      Department* deptPtr = department_array[i];</span>
00161 <span class="comment"></span>
00162 <span class="comment">      totalSalary += (deptPtr-&gt;buget_average_salary&gt;0) ? deptPtr-&gt;buget_average_salary: int(deptPtr-&gt;peer_numeraire_salary * deptPtr-&gt;peer_salary_multiplier_rank[ASST_PROF]) *</span>
00163 <span class="comment">      deptPtr-&gt;faculty_array.faculty_count;</span>
00164 <span class="comment"></span>
00165 <span class="comment">      facCount += deptPtr-&gt;faculty_array.faculty_count;</span>
00166 <span class="comment">      }</span>
00167 <span class="comment"></span>
00168 <span class="comment">      //-------//</span>
00169 <span class="comment"></span>
00170 <span class="comment">      int departureCount=0;</span>
00171 <span class="comment"></span>
00172 <span class="comment">      departureCount = max(0, department_array.faculty_level_history[FACULTY_RANK_LEVEL_COUNT][THIS_YEAR]</span>
00173 <span class="comment">      - facCount);</span>
00174 <span class="comment"></span>
00175 <span class="comment">      //-------//</span>
00176 <span class="comment"></span>
00177 <span class="comment">      avgSalary = totalSalary / facCount;</span>
00178 <span class="comment"></span>
00179 <span class="comment">      // 990524 max_hires = (int) max(*0, departureCount + math.safe_divide(cost_limit*1000, (float)avgSalary));//## chea old max_hires calc</span>
00180 <span class="comment">      max_hires = (int) max(0.0f, math.safe_divide(cost_limit*1000, (float)avgSalary)); //min &amp; max bug chea //## BUGHERE alg. has got A PROBLEMS</span>
00181 <span class="comment"></span>
00182 <span class="comment">      max_hires = min(MAX_S3_SLIDER * department_array.department_count, max_hires);    // 0116</span>
00183 <span class="comment">    */</span>
00184 }
00185 
00186 <span class="comment">//---------- End of function Finance::calc_max_hires -----------//</span>
00187 
00188 <span class="comment">//---------- Begin of function Finance::pre_optimization_stage_3 -----------//</span>
<a name="l00192"></a><a class="code" href="classFinance.html#a10">00192</a> <span class="comment">bool Finance::pre_optimization_stage_3(bool init) {</span>
00193 
00194     <span class="comment">// 990507</span>
00195     <span class="comment">//  if ( !init )</span>
00196     <span class="comment">//## chea 081099 this can't be called during opt. because it alter tuition_rate but may cause bug.BUGHERE</span>
00197     <span class="comment">//          finance.calc_budget_report();           //BUGHER double-check the call order!</span>
00198 
00199     <span class="comment">//---- init ----//</span>
00200 
00201     <a class="code" href="classDepartment.html">Department</a> *deptPtr;
00202     <span class="keywordtype">int</span> i, openToHire = 10, max = 0;
00203 
00204     total_hires = 0;
00205     <span class="comment">/*</span>
00206 <span class="comment">      for (i=department_array.department_count-1; i&gt;=0; i--)</span>
00207 <span class="comment">      {</span>
00208 <span class="comment">      //finance.hiring_policy_array[i].upper_bound = 0;</span>
00209 <span class="comment">      //finance.hiring_policy_array[i].target_value = 0;</span>
00210 <span class="comment">      //finance.hiring_policy_array[i].result_value = 0;</span>
00211 <span class="comment">      //finance.hiring_policy_array[i].weight = OPT_MID_WEIGHT;</span>
00212 <span class="comment">      }</span>
00213 <span class="comment">    */</span>
00214 
00215     <span class="comment">//---------------------------------//</span>
00216 
00217     <span class="comment">// 990507 department_array.salary_setting();                // bug if it runs more than once each year.</span>
00218 
00219     <span class="comment">//---------------------------------//</span>
00220 
00221     <span class="comment">/*</span>
00222 <span class="comment">      In email 990525:</span>
00223 <span class="comment"></span>
00224 <span class="comment">      5. The basic theory of this part of the model is fairly simple. Here it is</span>
00225 <span class="comment">      in my terms, not the variable names in the code. It's possible I made a</span>
00226 <span class="comment">      mistake somewhere in the specs (perhaps involving sponsored research), so</span>
00227 <span class="comment">      please check that the code does this job and change it if it doesn't.</span>
00228 <span class="comment"></span>
00229 <span class="comment">      prior_dept_fac_exp = prior year's departmental faculty salary actual</span>
00230 <span class="comment"></span>
00231 <span class="comment">      budget_for_old_billets_at_new_salaries =</span>
00232 <span class="comment">      prior_dept_fac_exp*(1+S1.fac_sal_gr%/100) [from S1]</span>
00233 <span class="comment"></span>
00234 <span class="comment">      adj_for_change_in_billets_at_new_salaries =</span>
00235 <span class="comment">      prior_dept_fac_exp*(S2.pct_change_in_fac/100)*(1+S1.fac_sal_gr%/100)</span>
00236 <span class="comment"></span>
00237 <span class="comment">      (note that S2.pct_change_in_fac can be positive or negative).</span>
00238 <span class="comment"></span>
00239 <span class="comment">      new_deptl_fac_sal_budget =</span>
00240 <span class="comment">      budget_for_old_billets_at_new_prices + adj_for_change_in_billets_at_new_salaries</span>
00241 <span class="comment"></span>
00242 <span class="comment">      S3.costLimit = new_deptl_fac_sal_budget -</span>
00243 <span class="comment">      new_salaries_of_continuing_faculty</span>
00244 <span class="comment"></span>
00245 <span class="comment">      (Continuing faculty are those remaining after attrition.)</span>
00246 <span class="comment"></span>
00247 <span class="comment">    */</span>
00248 
00249     <span class="keyword">const</span> <span class="keywordtype">double</span>&amp; s1Change = expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a70">PL_FACULTY_SALARY_INCREASES</a>].result_value;
00250     <span class="keyword">const</span> <span class="keywordtype">double</span>&amp; s2Change = cost_rise_policy_array[<a class="code" href="Ofinance_8h.html#a112a76">PL_FACULTY_FTE</a>].result_value;
00251 
00252     <span class="keywordtype">double</span> budgetForOldBilletsAtNewSalaries =
00253         prior_dept_fac_exp * (1 + s1Change/100);
00254 
00255     <span class="keywordtype">double</span> adjForChangeInBilletsAtNewSalaries =
00256         prior_dept_fac_exp * (s2Change/100) * (1 + s1Change/100);
00257 
00258     <span class="comment">//---------------------------------//</span>
00259     <span class="comment">// update for optimize_policy_3</span>
00260 
00261     <span class="keywordtype">float</span> totalCost = 0;                            <span class="comment">// not $000</span>
00262     <span class="keywordtype">int</span> totalFacCount = 0;
00263 
00264     <span class="keywordflow">for</span> (i=department_array.size(); i&gt;0; i--) {
00265         <span class="keywordflow">if</span> ( department_array.is_deleted(i) )
00266             <span class="keywordflow">continue</span>;
00267 
00268         <span class="keywordtype">int</span> facCount=0;
00269         <span class="keywordtype">float</span> total2FacultySalary = 0;                <span class="comment">// not $000</span>
00270 
00271         deptPtr = department_array[i];
00272 
00273         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> f=deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classDynArray.html#a28">size</a>(), totalFacultySalary=0; f&gt;0; f-- ) {
00274             <span class="keywordflow">if</span> ( deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#a10">is_deleted</a>(f) )
00275                 <span class="keywordflow">continue</span>;
00276 
00277             totalFacCount++;
00278 
00279             <a class="code" href="classFaculty.html">Faculty</a>* facPtr = deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>[f]; {
00280 
00281                 <span class="comment">//0407  if ( deptPtr-&gt;faculty_array[f]-&gt;rank_age_group() == FULL_PROF+1 )               // fullProf2</span>
00282                 total2FacultySalary += facPtr-&gt;<a class="code" href="classFaculty.html#m11">salary</a>;
00283                 facCount++;
00284             }
00285 
00286             totalCost += facPtr-&gt;<a class="code" href="classFaculty.html#m11">salary</a>;
00287         }
00288 
00289         <span class="comment">// avg_salary: $000</span>
00290         finance.hiring_policy_array[i-1].avg_salary = math.safe_divide(total2FacultySalary, facCount * 1000.0f);
00291 
00292         finance.hiring_policy_array[i-1].fac_count = deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#m1">faculty_count</a>;
00293 
00294         <span class="comment">//finance.hiring_policy_array[i-1].target_value = facCount;</span>
00295     }
00296 
00297     <span class="comment">// totalFacCount != 0</span>
00298     <a class="code" href="ALL_8H.html#a0">err_when</a>(totalCost&lt;=0);
00299 
00300     totalCost /= 1000.0f;
00301     <span class="comment">//990518 cost_limit = max(0, float(budget_expense_array[AC_ACADEMIC_DEPARTMENTS].faculty - totalCost ));</span>
00302     <span class="comment">//990525 cost_limit = float(budget_expense_array[AC_ACADEMIC_DEPARTMENTS].faculty - totalCost );</span>
00303     cost_limit = float(budgetForOldBilletsAtNewSalaries + adjForChangeInBilletsAtNewSalaries
00304                        -totalCost);
00305 
00306     <span class="comment">//-------------------------//</span>
00307     calc_max_hires();
00308 
00309     total_hires = max_hires;                        <span class="comment">// 0116</span>
00310 
00311 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00312 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00313 <span class="preprocessor"></span>
00314     <span class="comment">//---------// 0423 0507</span>
00315     <span class="comment">/*</span>
00316 <span class="comment">      for (i=department_array.size(); i&gt;0; i--)</span>
00317 <span class="comment">      {</span>
00318 <span class="comment">      if ( department_array.is_deleted(i) )</span>
00319 <span class="comment">      continue;</span>
00320 <span class="comment"></span>
00321 <span class="comment">      int* targetV = &amp;(finance.hiring_policy_array[i-1].target_value);</span>
00322 <span class="comment">      *targetV = int(0.99 + max_hires * (*targetV) / totalFacCount);</span>
00323 <span class="comment">      }</span>
00324 <span class="comment">    */</span>
00325     <span class="comment">//-------------// 990507</span>
00326 
00327     <span class="comment">//## chea set upper bound to max</span>
00328     <span class="comment">//          for (int r=0; r&lt;department_array.department_count; r++ )        // give new hire to the dept(s) with largest teaching-load</span>
00329     <span class="comment">//  {</span>
00330     <span class="comment">//          HiringPolicy* finPr2 = &amp;(finance.hiring_policy_array[r]);</span>
00331     <span class="comment">//          finPr2 -&gt; upper_bound = 10;</span>
00332     <span class="comment">//  }</span>
00333 
00334     <span class="keyword">const</span> <span class="keywordtype">int</span> minPerDept = max_hires / department_array.department_count;
00335     <span class="keyword">const</span> <span class="keywordtype">int</span> remainedHires = max_hires % department_array.department_count;
00336 
00337     <span class="comment">/*</span>
00338 <span class="comment">      for (i=department_array.size(); i&gt;0; i--)</span>
00339 <span class="comment">      {</span>
00340 <span class="comment">      if ( department_array.is_deleted(i) )</span>
00341 <span class="comment">      continue;</span>
00342 <span class="comment"></span>
00343 <span class="comment">      int* targetV = &amp;(finance.hiring_policy_array[i-1].target_value);</span>
00344 <span class="comment">      *targetV = minPerDept;</span>
00345 <span class="comment">      }</span>
00346 <span class="comment">    */</span>
00347 
00348     <span class="keywordflow">if</span> ( remainedHires &gt;= 0 ) {
00349         <span class="keywordtype">char</span>* deptSortArray;
00350 
00351         deptSortArray = (<span class="keywordtype">char</span>*) <a class="code" href="ALL_8H.html#a5">mem_add</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * department_array.department_count);
00352 
00353         <span class="keywordflow">for</span> (i=department_array.department_count; i&gt;0; i--)
00354             deptSortArray[i-1] = i;
00355         qsort( deptSortArray, department_array.department_count, <span class="keyword">sizeof</span>(deptSortArray[0]), sort_teaching_load_function );
00356 
00357         i=0;
00358 
00359         <span class="comment">//## ho 290799 BUGHERE</span>
00360 
00361         <span class="comment">/*</span>
00362 <span class="comment">          for (int j=remainedHires; j&gt;0 &amp;&amp; i&lt;department_array.department_count; j--, i++ )      // give new hire to the dept(s) with largest teaching-load</span>
00363 <span class="comment">          {</span>
00364 <span class="comment">          HiringPolicy* finP = &amp;(finance.hiring_policy_array[ deptSortArray[i] - 1 ]);</span>
00365 <span class="comment"></span>
00366 <span class="comment">          if ( finP-&gt;target_value &gt;= finP-&gt;upper_bound )</span>
00367 <span class="comment">          {</span>
00368 <span class="comment">          j++;</span>
00369 <span class="comment">          }</span>
00370 <span class="comment">          else</span>
00371 <span class="comment">          finP-&gt;target_value++;</span>
00372 <span class="comment"></span>
00373 <span class="comment">          }</span>
00374 <span class="comment">        */</span>
00375 
00376         <span class="comment">//## chea set upper bound to target</span>
00377         <span class="comment">// give new hire to the dept(s) with largest teaching-load</span>
00378         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> r=0; r&lt;department_array.department_count; r++ ) {
00379             <a class="code" href="structHiringPolicy.html">HiringPolicy</a>* finPr2 = &amp;(finance.hiring_policy_array[r]);
00380             <span class="keywordflow">if</span>(finPr2 -&gt; target_value &gt;= finPr2 -&gt; upper_bound)
00381                 finPr2 -&gt; target_value = finPr2 -&gt; upper_bound;
00382             finPr2 -&gt; result_value = finPr2 -&gt; target_value;
00383         }
00384 
00385         <a class="code" href="ALL_8H.html#a8">mem_del</a>(deptSortArray);
00386     }
00387 
00388     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00389 }
00390 
00391 <span class="comment">//---------- End of function Finance::pre_optimization_stage_3 -----------//</span>
00392 
00393 <span class="comment">//---------- Begin of function Finance::optimize_policy_3 -----------//</span>
<a name="l00395"></a><a class="code" href="classFinance.html#a13">00395</a> <span class="comment">bool Finance::optimize_policy_3() {</span>
00396     <a class="code" href="classDepartment.html">Department</a> *deptPtr;
00397     <span class="keywordtype">int</span> i;
00398     <span class="keywordtype">int</span> deptCount = department_array.department_count;
00399 
00400 <span class="preprocessor">#ifdef TEST_MATHCA</span>
00401 <span class="preprocessor"></span>    deptCount = 10;
00402 <span class="preprocessor">#endif</span>
00403 <span class="preprocessor"></span>
00404     <span class="keyword">const</span> <span class="keywordtype">double</span> weight_intrinsic = 0.45f;          <span class="comment">// c148 Weight on intrinsic value (v. TL)</span>
00405     <span class="comment">//const double weight_response = 0.7f;      // c149 Weight on responsiveness (v. stability)</span>
00406 
00407     <a class="code" href="ALL_8H.html#a0">err_when</a>(deptCount&lt;=0);
00408 
00409     <span class="comment">//----------------------------//</span>
00410 
00411     <span class="comment">//ColumnVector avgSalary(deptCount);                // column E 153:162             // $000</span>
00412     <span class="comment">//ColumnVector facCount(deptCount);         // column I 153:162</span>
00413 
00414     <span class="comment">//----------------------------// check player input</span>
00415 
00416     <span class="comment">//## chea check the total_hires &amp; totaltarget</span>
00417     <span class="keywordtype">int</span> totalupper = 0;
00418     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> r=0; r&lt;department_array.department_count; r++ ) {
00419         <a class="code" href="structHiringPolicy.html">HiringPolicy</a>* finPr2 = &amp;(finance.hiring_policy_array[r]);
00420         totalupper += finPr2 -&gt; upper_bound;
00421     }
00422 
00423     <span class="keywordflow">if</span> (totalupper &lt; total_hires) {
00424         box.msg(<span class="stringliteral">"The total of your upper bound values is less than the total faculty you wanted to be hired. "</span>);
00425         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00426     }
00427     <span class="comment">//## chea check the total_hires &amp; totaltarget</span>
00428 
00429     ColumnVector targetHire(deptCount), weightsIV3(deptCount), upperBound(deptCount);
00430 
00431     <span class="keywordflow">for</span> (i=deptCount; i&gt;0; i--) {
00432         <a class="code" href="ALL_8H.html#a2">err_if</a> ( department_array.is_deleted(i) )
00433             <a class="code" href="ALL_8H.html#a1">err_here</a>();
00434 
00435         deptPtr = department_array[i];
00436 
00437         <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a>* deptInfo = department_res[deptPtr-&gt;<a class="code" href="classGeneralDepartment.html#m2">department_id</a>];
00438 
00439 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00440 <span class="preprocessor"></span>        weightsIV3(i) = (double)1/(double)max( 1,deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classDynArray.html#a28">size</a>() );
00441 <span class="preprocessor">#else</span>
00442 <span class="preprocessor"></span>        weightsIV3(i) = weight_intrinsic * finance.hiring_policy_array[i-1].weight + 1 - weight_intrinsic;
00443 <span class="preprocessor">#endif</span>
00444 <span class="preprocessor"></span>
00445         <span class="comment">//## chea try to avoid the bug below</span>
00446         <span class="keywordflow">if</span> (finance.hiring_policy_array[i-1].upper_bound&lt; finance.hiring_policy_array[i-1].target_value) {
00447             finance.hiring_policy_array[i-1].upper_bound = finance.hiring_policy_array[i-1].target_value;
00448         }
00449 
00450         upperBound(i) = finance.hiring_policy_array[i-1].upper_bound;
00451 
00452         targetHire(i) = finance.hiring_policy_array[i-1].target_value;
00453 
00454         <a class="code" href="ALL_8H.html#a0">err_when</a>(upperBound(i) &lt; targetHire(i));
00455     }
00456 
00457 <span class="preprocessor">#ifdef TEST_MATHCA</span>
00458 <span class="preprocessor"></span>    <span class="keywordtype">double</span> dummyArr[] = {3,7,13,2,2, 1,5,0,1,4};
00459     <span class="keywordtype">double</span> dummyW[] = {1.000,1.135,1.450,1.000,0.955,1.000,1.000,0.775,1.000,1.000};
00460 
00461     targetHire &lt;&lt; dummyArr;
00462     upperBound &lt;&lt; dummyArr;
00463     weightsIV3 &lt;&lt; dummyW;
00464 <span class="preprocessor">#endif</span>
00465 <span class="preprocessor"></span>
00466     <span class="comment">//----------------------------// construct quad_program input matrices PART A</span>
00467 
00468     ColumnVector c(deptCount);
00469     DiagonalMatrix Q(deptCount);
00470 
00471     c = -SP(targetHire, weightsIV3);
00472     Q.set_diagonal(weightsIV3);
00473 
00474     <span class="comment">//----------------------------//    PART B</span>
00475 
00476     <span class="comment">//  for (i=1; i &lt;=deptCount; i++)</span>
00477     <span class="comment">//  {</span>
00478     <span class="comment">//          surplusRHS(1) += avgSalary(i) * facCount(i)  * (1+growthRate);</span>
00479     <span class="comment">//          surplusCoefs3(i) = avgSalary(i) * (1+growthRate);</span>
00480     <span class="comment">//  }</span>
00481 
00482     <span class="comment">//  {</span>
00483     <span class="comment">//          double maxSavingAtNewSalary = 0;                // J177</span>
00484 
00485     <span class="comment">//          for (i=1; i &lt;=deptCount; i++)</span>
00486     <span class="comment">//          {</span>
00487     <span class="comment">//                  maxSavingAtNewSalary += (lowerBound3(i) - facCount(i)) * avgSalary(i) * (1+growthRate);</span>
00488     <span class="comment">//          }</span>
00489 
00490     <span class="comment">//          double C136 = finance.cost_rise_policy_array[PL_FACULTY_FTE].result_value / 100;</span>
00491     <span class="comment">//          double C203 = finance.stage1_expense[S1_FACULTY_SALARY_INCREASES].base_value;</span>
00492     <span class="comment">//</span>
00493     <span class="comment">//          #ifdef TEST_MATHCA</span>
00494     <span class="comment">//          surplusRHS(1) += -520.327f;</span>
00495     <span class="comment">//          #else</span>
00496     <span class="comment">//          surplusRHS(1) += max(C136*C203,maxSavingAtNewSalary);   // += i178 where i178=MAX(C136*C203,J177)</span>
00497     <span class="comment">//          #endif</span>
00498     <span class="comment">//  }</span>
00499 
00500     DiagonalMatrix I(deptCount);  I = 1;
00501     <a class="code" href="classMatrix.html">Matrix</a> A = -I;
00502     ColumnVector b = -upperBound;
00503 
00504     <a class="code" href="ALL_8H.html#a0">err_when</a>(total_hires&lt;0);                        <span class="comment">// check player input</span>
00505 
00506     RowVector tmpList(deptCount); tmpList = 1;
00507     ColumnVector totalHires(1); totalHires(1) = total_hires;
00508 
00509 <span class="preprocessor">#ifdef TEST_MATHCA</span>
00510 <span class="preprocessor"></span>    <a class="code" href="ALL_8H.html#a1">err_here</a>();
00511     totalHires(1) = -10;
00512     <span class="keywordflow">for</span> (i=1;i&lt;=deptCount;i++)
00513         totalHires(1) += targetHire(i);
00514 <span class="preprocessor">#endif</span>
00515 <span class="preprocessor"></span>
00516 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00517 <span class="preprocessor"></span>    A = A &amp; -tmpList;
00518     b = b &amp; -totalHires;
00519 <span class="preprocessor">#else</span>
00520 <span class="preprocessor"></span>    A = A &amp; tmpList &amp; -tmpList;
00521     b = b &amp; totalHires &amp; -totalHires;
00522 <span class="preprocessor">#endif</span>
00523 <span class="preprocessor"></span>
00524     <span class="comment">//----------------------------//    Go run it!</span>
00525 
00526     ColumnVector xNames(deptCount);
00527     <span class="keywordflow">if</span> (!<a class="code" href="classLinearAlgebra.html#d0">LinearAlgebra::quadratic_prog</a>(c,Q,A,b,xNames))
00528         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00529 
00530     print_vector2(xNames);
00531 
00532     <span class="comment">//----------------------------//</span>
00533 
00534     <span class="comment">//int deptCount = department_array.size();</span>
00535     <span class="keywordtype">int</span> resultTotal = 0;                            <span class="comment">// 990423</span>
00536     <span class="comment">//int resultArr[MAX_DEPARTMENT];</span>
00537 
00538 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00539 <span class="preprocessor"></span>    <span class="comment">// use following procedures :</span>
00540     <span class="comment">// i) find the largest (remaining) value in xNames and round it to the nearest integer.</span>
00541     <span class="comment">//    For ties, just use the department that comes up first in the search</span>
00542     <span class="comment">// ii) if that integer &gt;= 1 put it into the Results vector ELSE put 1 in the result vector</span>
00543     <span class="comment">// iii) repeat from (i) until sum of results equals maxHires. If the value in the (ii)</span>
00544     <span class="comment">// is greate than the remaining hires, use the remaining hires instead of (ii)</span>
00545 
00546     <span class="keywordtype">int</span> deptRank;
00547     <span class="keywordtype">double</span> lastXNames;
00548     <span class="keywordtype">int</span> lastDept=0;
00549 
00550     <span class="keywordflow">for</span>(deptRank=0; deptRank&lt;deptCount; ++deptRank) {
00551         <span class="keywordtype">int</span> curDept=0;
00552         <span class="keywordtype">double</span> curXNames;
00553         <span class="keywordflow">for</span>( i=1; i&lt;=deptCount; ++i ) {
00554             <span class="keywordtype">double</span> xNamesValue = xNames(i);
00555 
00556             <span class="comment">// this department has been searched</span>
00557             <span class="keywordflow">if</span>( lastDept != 0
00558                 &amp;&amp; (xNamesValue &gt; lastXNames || xNamesValue == lastXNames &amp;&amp; i &lt;= lastDept) )
00559                 <span class="keywordflow">continue</span>;
00560 
00561             <span class="comment">// find the department with maximum xNames</span>
00562             <span class="keywordflow">if</span>( curDept != 0 &amp;&amp; xNamesValue &lt;= curXNames )
00563                 <span class="keywordflow">continue</span>;
00564 
00565             curDept = i;
00566             curXNames = xNamesValue;
00567         }
00568 
00569         <span class="comment">// find a department, mark it so next for(deptRank) won't scan it again</span>
00570         i = lastDept = curDept;
00571         lastXNames = curXNames;
00572 
00573         <span class="keywordtype">int</span> xNamesInt = int( curXNames + 0.5 );       <span class="comment">//round to integer</span>
00574 
00575         <span class="comment">// at least get 1 place</span>
00576         <span class="comment">// or use ceil((total_hires-resultTotal)/(deptCount-deptRank)), if 1 can't fill up all the vacancies</span>
00577         xNamesInt = max( xNamesInt, 1 );
00578 
00579         <span class="comment">// check remaining</span>
00580         <a class="code" href="ALL_8H.html#a0">err_when</a>( resultTotal &gt; total_hires );
00581         <span class="keywordflow">if</span>( xNamesInt &gt; total_hires - resultTotal )
00582             xNamesInt = total_hires - resultTotal;
00583 
00584         <span class="comment">// place the result and add the total</span>
00585 
00586         finance.hiring_policy_array[curDept-1].result_value = xNamesInt;
00587         resultTotal += xNamesInt;
00588     }
00589 
00590 <span class="preprocessor">#else</span>
00591 <span class="preprocessor"></span>
00592     <span class="keywordflow">for</span> (i=deptCount; i&gt;0; i--) {
00593         <span class="keywordflow">if</span> ( department_array.is_deleted(i) )
00594             <span class="keywordflow">continue</span>;
00595 
00596         <span class="comment">//990423 finance.hiring_policy_array[i-1].result_value = (int) (xNames(i) +0.5);</span>
00597         <span class="keywordtype">float</span> tmpR = (float) (xNames(i));
00598 
00599         <span class="keywordflow">if</span> ( tmpR &lt; 1 )
00600             tmpR = (float) int(tmpR);
00601         <span class="keywordflow">else</span>
00602             tmpR = (float) int(tmpR + 0.5f);
00603 
00604         finance.hiring_policy_array[i-1].result_value = (int) tmpR;
00605         resultTotal += (int) tmpR;
00606     }
00607 <span class="preprocessor">#endif</span>
00608 <span class="preprocessor"></span>
00609     <span class="comment">//## chea fix the rounding error</span>
00610 
00611     <span class="keywordtype">int</span> counter =0;
00612 
00613     <span class="keywordflow">if</span> (resultTotal &gt; total_hires) {
00614         counter = resultTotal - total_hires;
00615 
00616         <span class="comment">//## chea set upper bound to target</span>
00617         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> q=0; q&lt;department_array.department_count; q++ ) {
00618             <a class="code" href="structHiringPolicy.html">HiringPolicy</a>* finPr5 = &amp;(finance.hiring_policy_array[q]);
00619 
00620             <span class="keywordflow">if</span> (finPr5 -&gt; result_value &gt;=1) {
00621                 finPr5 -&gt; result_value --;
00622                 counter--;
00623             }
00624 
00625             <span class="keywordflow">if</span> (counter == 0) <span class="keywordflow">break</span>;
00626 
00627         }
00628 
00629         resultTotal = total_hires;
00630     }
00631 
00632     <span class="comment">// readjust result_value may cause bug</span>
00633 
00634     <span class="keywordtype">int</span> diff = total_hires - resultTotal;
00635     <span class="keywordtype">int</span> deptRecno = 0;
00636 
00637     <span class="keywordflow">for</span> (i=0; i&lt;diff; i++) {
00638 
00639         finance.hiring_policy_array[deptRecno].<a class="code" href="structHiringPolicy.html#m3">result_value</a> ++;
00640 
00641         <span class="keywordflow">if</span>(finance.hiring_policy_array[deptRecno].result_value &gt; 10) {
00642             finance.hiring_policy_array[deptRecno].result_value --;
00643             diff++;
00644         }
00645 
00646         <span class="keywordflow">if</span> ( ++deptRecno == deptCount )
00647             deptRecno = 0;
00648     }
00649 
00650     <span class="comment">//## chea set upper bound to target</span>
00651     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> cq=0; cq&lt;department_array.department_count; cq++ ) {
00652         <a class="code" href="structHiringPolicy.html">HiringPolicy</a>* finPr3 = &amp;(finance.hiring_policy_array[cq]);
00653         <span class="comment">//              finPr3 -&gt; target_value = finPr3 -&gt; result_value;                                //BUGHERE</span>
00654         <span class="keywordflow">if</span> (finPr3 -&gt; upper_bound &lt; finPr3 -&gt; result_value)
00655             finPr3 -&gt; upper_bound = finPr3 -&gt; result_value;
00656     }
00657 
00658     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00659 }
00660 
00661 <span class="comment">//---------- End of function Finance::optimize_policy_3 -----------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:37 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
