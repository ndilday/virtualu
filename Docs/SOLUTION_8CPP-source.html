<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SOLUTION.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>SOLUTION.CPP</h1><a href="SOLUTION_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Owner: Fred</span>
00002 <span class="comment">//$$ solution.cpp                    // solve routines</span>
00003 
00004 <span class="comment">// Copyright (C) 1994: R B Davies</span>
00005 
<a name="l00006"></a><a class="code" href="SOLUTION_8CPP.html#a0">00006</a> <span class="preprocessor">#define WANT_STREAM                               // include.h will get stream fns</span>
<a name="l00007"></a><a class="code" href="SOLUTION_8CPP.html#a1">00007</a> <span class="preprocessor"></span><span class="preprocessor">#define WANT_MATH                                 // include.h will get math fns</span>
00008 <span class="preprocessor"></span>
00009 <span class="preprocessor">#include "include.h"</span>
00010 <span class="comment">//#include "boolean.h"</span>
00011 <span class="preprocessor">#include "myexcept.h"</span>
00012 
00013 <span class="preprocessor">#include "solution.h"</span>
00014 
00015 <span class="preprocessor">#ifdef use_namespace</span>
00016 <span class="preprocessor"></span><span class="keyword">namespace </span>RBD_COMMON {
00017 <span class="preprocessor">#endif</span>
00018 <span class="preprocessor"></span>
00019     <span class="keywordtype">void</span> <a class="code" href="classR1__R1.html#a2">R1_R1::Set</a>(<a class="code" href="namespaceRBD__COMMON.html#a0">Real</a> X) {
00020         <span class="keywordflow">if</span> ((!minXinf &amp;&amp; X &lt;= minX) || (!maxXinf &amp;&amp; X &gt;= maxX))
00021             Throw(<a class="code" href="classSolutionException.html">SolutionException</a>(<span class="stringliteral">"X value out of range"</span>));
00022         x = X; xSet = <span class="keyword">true</span>;
00023     }
00024 
00025     <a class="code" href="classR1__R1.html#a5">R1_R1::operator Real</a>() {
00026         <span class="keywordflow">if</span> (!xSet) Throw(<a class="code" href="classSolutionException.html">SolutionException</a>(<span class="stringliteral">"Value of X not set"</span>));
00027         <a class="code" href="namespaceRBD__COMMON.html#a0">Real</a> y = operator()();
00028         <span class="keywordflow">return</span> y;
00029     }
00030 
00031     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="classSolutionException.html#p0">SolutionException::Select</a>;
00032 
00033     <a class="code" href="classSolutionException.html#a0">SolutionException::SolutionException</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* a_what) : <a class="code" href="classException.html">Exception</a>() {
00034         Select = <a class="code" href="classException.html#p0">Exception::Select</a>;
00035         AddMessage(<span class="stringliteral">"Error detected by solution package\n"</span>);
00036         AddMessage(a_what); AddMessage(<span class="stringliteral">"\n"</span>);
00037         <span class="keywordflow">if</span> (a_what) <a class="code" href="classTracer.html#d1">Tracer::AddTrace</a>();
00038     };
00039 
<a name="l00040"></a><a class="code" href="namespaceRBD__COMMON.html#a3">00040</a>     <span class="keyword">inline</span> <a class="code" href="namespaceRBD__COMMON.html#a0">Real</a> <a class="code" href="NEWMATRM_8H.html#a1">square</a>(<a class="code" href="namespaceRBD__COMMON.html#a0">Real</a> x) { <span class="keywordflow">return</span> x*x; }
00041 
00042     <span class="keywordtype">void</span> OneDimSolve::LookAt(<span class="keywordtype">int</span> V) {
00043         lim--;
00044         <span class="keywordflow">if</span> (!lim) Throw(<a class="code" href="classSolutionException.html">SolutionException</a>(<span class="stringliteral">"Does not converge"</span>));
00045         Last = V;
00046         <a class="code" href="namespaceRBD__COMMON.html#a0">Real</a> yy = function(x[V]) - YY;
00047         Finish = (<a class="code" href="OLINALG_8CPP.html#a2">fabs</a>(yy) &lt;= accY) || (Captured &amp;&amp; <a class="code" href="OLINALG_8CPP.html#a2">fabs</a>(x[L]-x[U]) &lt;= accX );
00048         y[V] = vpol*yy;
00049     }
00050 
00051     <span class="keywordtype">void</span> OneDimSolve::HFlip() { hpol=-hpol; <a class="code" href="OVIDEO_8H.html#a0">State</a>(U,C,L); }
00052 
00053     <span class="keywordtype">void</span> OneDimSolve::VFlip()
00054     { vpol = -vpol; y[0] = -y[0]; y[1] = -y[1]; y[2] = -y[2]; }
00055 
00056     <span class="keywordtype">void</span> OneDimSolve::Flip() {
00057         hpol=-hpol; vpol=-vpol; <a class="code" href="OVIDEO_8H.html#a0">State</a>(U,C,L);
00058         y[0] = -y[0]; y[1] = -y[1]; y[2] = -y[2];
00059     }
00060 
00061     <span class="keywordtype">void</span> <a class="code" href="OVIDEO_8H.html#a0">OneDimSolve::State</a>(<span class="keywordtype">int</span> I, <span class="keywordtype">int</span> J, <span class="keywordtype">int</span> K) { L=I; C=J; U=K; }
00062 
00063     <span class="keywordtype">void</span> OneDimSolve::Linear(<span class="keywordtype">int</span> I, <span class="keywordtype">int</span> J, <span class="keywordtype">int</span> K) {
00064         x[J] = (x[I]*y[K] - x[K]*y[I])/(y[K] - y[I]);
00065         <span class="comment">// cout &lt;&lt; "Linear\n";</span>
00066     }
00067 
00068     <span class="keywordtype">void</span> OneDimSolve::Quadratic(<span class="keywordtype">int</span> I, <span class="keywordtype">int</span> J, <span class="keywordtype">int</span> K) {
00069         <span class="comment">// result to overwrite I</span>
00070         <a class="code" href="namespaceRBD__COMMON.html#a0">Real</a> YJK, YIK, YIJ, XKI, XKJ;
00071         YJK = y[J] - y[K]; YIK = y[I] - y[K]; YIJ = y[I] - y[J];
00072         XKI = (x[K] - x[I]);
00073         XKJ = (x[K]*y[J] - x[J]*y[K])/YJK;
00074         <span class="keywordflow">if</span> ( <a class="code" href="namespaceRBD__COMMON.html#a3">square</a>(YJK/YIK)&gt;(x[K] - x[J])/XKI ||
00075              <a class="code" href="namespaceRBD__COMMON.html#a3">square</a>(YIJ/YIK)&gt;(x[J] - x[I])/XKI ) {
00076             x[I] = XKJ;
00077             <span class="comment">// cout &lt;&lt; "Quadratic - exceptional\n";</span>
00078         }
00079         <span class="keywordflow">else</span> {
00080             XKI = (x[K]*y[I] - x[I]*y[K])/YIK;
00081             x[I] = (XKJ*y[I] - XKI*y[J])/YIJ;
00082             <span class="comment">// cout &lt;&lt; "Quadratic - normal\n";</span>
00083         }
00084     }
00085 
00086     <a class="code" href="namespaceRBD__COMMON.html#a0">Real</a> <a class="code" href="classOneDimSolve.html#a1">OneDimSolve::Solve</a>(<a class="code" href="namespaceRBD__COMMON.html#a0">Real</a> Y, <a class="code" href="namespaceRBD__COMMON.html#a0">Real</a> X, <a class="code" href="namespaceRBD__COMMON.html#a0">Real</a> Dev, <span class="keywordtype">int</span> Lim) {
00087         <span class="keyword">enum</span> Loop { start, captured1, captured2, binary, finish };
00088         <a class="code" href="classTracer.html">Tracer</a> et(<span class="stringliteral">"OneDimSolve::Solve"</span>);
00089         lim=Lim; Captured = <span class="keyword">false</span>;
00090         <span class="keywordflow">if</span> (Dev==0.0) Throw(<a class="code" href="classSolutionException.html">SolutionException</a>(<span class="stringliteral">"Dev is zero"</span>));
00091         L=0; C=1; U=2; vpol=1; hpol=1; y[C]=0.0; y[U]=0.0;
00092         <span class="keywordflow">if</span> (Dev&lt;0.0) { hpol=-1; Dev = -Dev; }
00093         YY=Y;                                         <span class="comment">// target value</span>
00094         x[L] = X;                                     <span class="comment">// initial trial value</span>
00095         <span class="keywordflow">if</span> (!function.IsValid(X))
00096             Throw(<a class="code" href="classSolutionException.html">SolutionException</a>(<span class="stringliteral">"Starting value is invalid"</span>));
00097         Loop TheLoop = start;
00098         <span class="keywordflow">for</span> (;;) {
00099             <span class="keywordflow">switch</span> (TheLoop) {
00100             <span class="keywordflow">case</span> start:
00101                 LookAt(L); <span class="keywordflow">if</span> (Finish) { TheLoop = finish; <span class="keywordflow">break</span>; }
00102                 <span class="keywordflow">if</span> (y[L]&gt;0.0) VFlip();                  <span class="comment">// so Y[L] &lt; 0</span>
00103 
00104                 x[U] = X + Dev * hpol;
00105                 <span class="keywordflow">if</span> (!function.maxXinf &amp;&amp; x[U] &gt; function.maxX)
00106                     x[U] = (function.maxX + X) / 2.0;
00107                 <span class="keywordflow">if</span> (!function.minXinf &amp;&amp; x[U] &lt; function.minX)
00108                     x[U] = (function.minX + X) / 2.0;
00109 
00110                 LookAt(U); <span class="keywordflow">if</span> (Finish) { TheLoop = finish; <span class="keywordflow">break</span>; }
00111                 <span class="keywordflow">if</span> (y[U] &gt; 0.0) { TheLoop = captured1; Captured = <span class="keyword">true</span>; <span class="keywordflow">break</span>; }
00112                 <span class="keywordflow">if</span> (y[U] == y[L])
00113                     Throw(<a class="code" href="classSolutionException.html">SolutionException</a>(<span class="stringliteral">"Function is flat"</span>));
00114                 <span class="keywordflow">if</span> (y[U] &lt; y[L]) HFlip();               <span class="comment">// Change direction</span>
00115                 <a class="code" href="OVIDEO_8H.html#a0">State</a>(L,U,C);
00116                 <span class="keywordflow">for</span> (i=0; i&lt;20; i++) {
00117                     <span class="comment">// cout &lt;&lt; "Searching for crossing point\n";</span>
00118                     <span class="comment">// Have L C then crossing point, Y[L]&lt;Y[C]&lt;0</span>
00119                     x[U] = x[C] + Dev * hpol;
00120                     <span class="keywordflow">if</span> (!function.maxXinf &amp;&amp; x[U] &gt; function.maxX)
00121                         x[U] = (function.maxX + x[C]) / 2.0;
00122                     <span class="keywordflow">if</span> (!function.minXinf &amp;&amp; x[U] &lt; function.minX)
00123                         x[U] = (function.minX + x[C]) / 2.0;
00124 
00125                     LookAt(U); <span class="keywordflow">if</span> (Finish) { TheLoop = finish; <span class="keywordflow">break</span>; }
00126                     <span class="keywordflow">if</span> (y[U] &gt; 0) { TheLoop = captured2; Captured = <span class="keyword">true</span>; <span class="keywordflow">break</span>; }
00127                     <span class="keywordflow">if</span> (y[U] &lt; y[C])
00128                         Throw(<a class="code" href="classSolutionException.html">SolutionException</a>(<span class="stringliteral">"Function is not monotone"</span>));
00129                     Dev *= 2.0;
00130                     <a class="code" href="OVIDEO_8H.html#a0">State</a>(C,U,L);
00131                 }
00132                 <span class="keywordflow">if</span> (TheLoop != start ) <span class="keywordflow">break</span>;
00133                 Throw(<a class="code" href="classSolutionException.html">SolutionException</a>(<span class="stringliteral">"Can't locate a crossing point"</span>));
00134 
00135             <span class="keywordflow">case</span> captured1:
00136                 <span class="comment">// cout &lt;&lt; "Captured - 1\n";</span>
00137                 <span class="comment">// We have 2 points L and U with crossing between them</span>
00138                 Linear(L,C,U);                          <span class="comment">// linear interpolation</span>
00139                 <span class="comment">// - result to C</span>
00140                 LookAt(C); <span class="keywordflow">if</span> (Finish) { TheLoop = finish; <span class="keywordflow">break</span>; }
00141                 <span class="keywordflow">if</span> (y[C] &gt; 0.0) Flip();                 <span class="comment">// Want y[C] &lt; 0</span>
00142                 <span class="keywordflow">if</span> (y[C] &lt; 0.5*y[L]) { <a class="code" href="OVIDEO_8H.html#a0">State</a>(C,L,U); TheLoop = binary; <span class="keywordflow">break</span>; }
00143 
00144             <span class="keywordflow">case</span> captured2:
00145                 <span class="comment">// cout &lt;&lt; "Captured - 2\n";</span>
00146                 <span class="comment">// We have L,C before crossing, U after crossing</span>
00147                 Quadratic(L,C,U);                       <span class="comment">// quad interpolation</span>
00148                 <span class="comment">// - result to L</span>
00149                 <a class="code" href="OVIDEO_8H.html#a0">State</a>(C,L,U);
00150                 <span class="keywordflow">if</span> ((x[C] - x[L])*hpol &lt;= 0.0 || (x[C] - x[U])*hpol &gt;= 0.0)
00151                 { TheLoop = captured1; <span class="keywordflow">break</span>; }
00152                 LookAt(C); <span class="keywordflow">if</span> (Finish) { TheLoop = finish; <span class="keywordflow">break</span>; }
00153                 <span class="comment">// cout &lt;&lt; "Through first stage\n";</span>
00154                 <span class="keywordflow">if</span> (y[C] &gt; 0.0) Flip();
00155                 <span class="keywordflow">if</span> (y[C] &gt; 0.5*y[L]) { TheLoop = captured2; <span class="keywordflow">break</span>; }
00156                 <span class="keywordflow">else</span> { <a class="code" href="OVIDEO_8H.html#a0">State</a>(C,L,U); TheLoop = captured1; <span class="keywordflow">break</span>; }
00157 
00158             <span class="keywordflow">case</span> binary:
00159                 <span class="comment">// We have L, U around crossing - do binary search</span>
00160                 <span class="comment">// cout &lt;&lt; "Binary\n";</span>
00161                 <span class="keywordflow">for</span> (i=3; i; i--) {
00162                     x[C] = 0.5*(x[L]+x[U]);
00163                     LookAt(C); <span class="keywordflow">if</span> (Finish) { TheLoop = finish; <span class="keywordflow">break</span>; }
00164                     <span class="keywordflow">if</span> (y[C]&gt;0.0) <a class="code" href="OVIDEO_8H.html#a0">State</a>(L,U,C); <span class="keywordflow">else</span> <a class="code" href="OVIDEO_8H.html#a0">State</a>(C,L,U);
00165                 }
00166                 <span class="keywordflow">if</span> (TheLoop != binary) <span class="keywordflow">break</span>;
00167                 TheLoop = captured1; <span class="keywordflow">break</span>;
00168 
00169             <span class="keywordflow">case</span> finish:
00170                 <span class="keywordflow">return</span> x[Last];
00171 
00172             }
00173         }
00174     }
00175 
00176     <span class="keywordtype">bool</span> <a class="code" href="classR1__R1.html#a4">R1_R1::IsValid</a>(<a class="code" href="namespaceRBD__COMMON.html#a0">Real</a> X) {
00177         Set(X);
00178         <span class="keywordflow">return</span> (minXinf || x &gt; minX) &amp;&amp; (maxXinf || x &lt; maxX);
00179     }
00180 
00181 <span class="preprocessor">#ifdef use_namespace</span>
00182 <span class="preprocessor"></span>}
00183 <span class="preprocessor">#endif</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:37 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
