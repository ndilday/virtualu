<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OBATTLE.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>OBATTLE.CPP</h1><a href="OBATTLE_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OBATTLE.CPP</span>
00002 <span class="comment">//Description : Battle Object</span>
00003 <span class="comment">//Owner       : Fred</span>
00004 
00005 <span class="preprocessor">#include &lt;<a class="code" href="OBATTLE_8H.html">OBATTLE.H</a>&gt;</span>
00006 <span class="preprocessor">#include &lt;<a class="code" href="OMUSIC_8H.html">OMUSIC.H</a>&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="OBOX_8H.html">OBOX.H</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;<a class="code" href="OGAME_8H.html">OGAME.H</a>&gt;</span>
00009 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00010 <span class="preprocessor">#include &lt;OMISC.H&gt;</span>
00011 <span class="preprocessor">#include &lt;OMOUSE.H&gt;</span>
00012 <span class="preprocessor">#include &lt;<a class="code" href="OMOUSECR_8H.html">OMOUSECR.H</a>&gt;</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="OSCHLRES_8H.html">OSCHLRES.H</a>&gt;</span>
00014 <span class="preprocessor">#include &lt;ODEPT.H&gt;</span>
00015 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00016 <span class="preprocessor">#include &lt;<a class="code" href="OWORLD_8H.html">OWORLD.H</a>&gt;</span>
00017 <span class="preprocessor">#include &lt;ORECT.h&gt;</span>
00018 <span class="preprocessor">#include &lt;OFIRM.H&gt;</span>
00019 <span class="preprocessor">#include &lt;<a class="code" href="OROAD_8H.html">OROAD.H</a>&gt;</span>
00020 <span class="preprocessor">#include &lt;<a class="code" href="OPLANT_8H.html">OPLANT.H</a>&gt;</span>
00021 <span class="preprocessor">#include &lt;<a class="code" href="OFIRMRES_8H.html">OFIRMRES.H</a>&gt;</span>
00022 <span class="preprocessor">#include &lt;OLETTER.H&gt;</span>
00023 <span class="comment">//#include &lt;OSPRITEA.H&gt;</span>
00024 <span class="preprocessor">#include &lt;<a class="code" href="OSPRITE_8H.html">OSPRITE.H</a>&gt;</span>
00025 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>
00026 <span class="preprocessor">#include &lt;<a class="code" href="OPEERSCH_8H.html">OPEERSCH.H</a>&gt;</span>                             <span class="comment">// enrollment</span>
00027 <span class="preprocessor">#include &lt;OFINANCE.H&gt;</span>
00028 <span class="comment">//##### begin fred 980824 #####//</span>
00029 <span class="preprocessor">#include &lt;OFACULTY.H&gt;</span>
00030 <span class="preprocessor">#include &lt;OSTUDENT.H&gt;</span>
00031 <span class="preprocessor">#include &lt;<a class="code" href="ODEPTRES_8H.html">ODEPTRES.H</a>&gt;</span>
00032 
00033 <span class="preprocessor">#include &lt;OOPT.H&gt;</span>
00034 <span class="preprocessor">#include &lt;OATHLETI.H&gt;</span>
00035 <span class="preprocessor">#include &lt;ODEVELOP.H&gt;</span>
00036 <span class="preprocessor">#include &lt;OFacilit.H&gt;</span>                             <span class="comment">//##### fred 980810 #####//</span>
00037 <span class="preprocessor">#include &lt;OLibtech.H&gt;</span>                             <span class="comment">//##### fred 980828 #####//</span>
00038 <span class="preprocessor">#include &lt;OStuOff.H&gt;</span>                              <span class="comment">//##### fred 980918 #####//</span>
00039 <span class="preprocessor">#include &lt;OINVEST.H&gt;</span>                              <span class="comment">//##### fred 980923 #####//</span>
00040 <span class="preprocessor">#include &lt;OMATH.H&gt;</span>
00041 <span class="comment">//##### end fred 980824 #####//</span>
00042 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00043 
00044 <span class="comment">//#define DEBUG_LOG_LOCAL 1</span>
00045 <span class="comment">//#include &lt;OLOG.H&gt;</span>
00046 
00047 <span class="keyword">static</span> <span class="keywordtype">void</span> init_doctoral_target();
00048 
00049 <span class="comment">//-------- Begin of function Battle::init --------//</span>
<a name="l00051"></a><a class="code" href="classBattle.html#a0">00051</a> <span class="comment">void Battle::init() {</span>
00052 }
00053 
00054 <span class="comment">//-------- End of function Battle::init --------//</span>
00055 
00056 <span class="comment">//-------- Begin of function Battle::deinit --------//</span>
<a name="l00058"></a><a class="code" href="classBattle.html#a1">00058</a> <span class="comment">void Battle::deinit() {</span>
00059 }
00060 
00061 <span class="comment">//-------- End of function Battle::deinit --------//</span>
00062 
00063 <span class="comment">//-------- Begin of function Battle::run --------//</span>
<a name="l00068"></a><a class="code" href="classBattle.html#a2">00068</a> <span class="comment">void Battle::run(int scenId) {</span>
00069     <span class="comment">//DEBUG_LOG("Battle:: run()");</span>
00070 
00071     <span class="comment">// ## begin chwg072999</span>
00072     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a> + <a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; k++) {
00073         <span class="keywordflow">if</span>(optimization.opt1_button_group_array[k]!=<a class="code" href="OHELP_8H.html#a0">NULL</a>)
00074             optimization.opt1_button_group_array[k]-&gt;button_pressed=1;
00075         <span class="keywordflow">if</span>(optimization.opt1_slider_group[k].init_flag!=0)
00076             optimization.opt1_slider_group[k].enable_flag=1;
00077     }
00078     <span class="keywordflow">for</span> (k = 0; k &lt; <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; k++) {
00079         <span class="keywordflow">if</span>(optimization.opt2_button_group_array[k]!=<a class="code" href="OHELP_8H.html#a0">NULL</a>)
00080             optimization.opt2_button_group_array[k]-&gt;button_pressed=1;
00081         <span class="keywordflow">if</span>(optimization.opt2_slider_group[k].init_flag!=0)
00082             optimization.opt2_slider_group[k].enable_flag=1;
00083     }
00084     <span class="comment">// ## end chwg072999</span>
00085 
00086     <span class="keywordtype">int</span> oldCursor = mouse_cursor.get_icon();
00087 
00088     mouse_cursor.set_icon(<a class="code" href="OMOUSECR_8H.html#a6a5">CURSOR_WAITING</a>);
00089 
00090     info.prerun_year=1;                             <span class="comment">//## chea 150799 start prerun year here</span>
00091 
00092     info.init_random_seed(0);
00093 
00094     <span class="keywordflow">switch</span>( scenId ) {
00095     <span class="keywordflow">case</span> 0:
00096     <span class="keywordflow">default</span>:
00097         create_pregame_object();
00098         <span class="comment">//              letter.init_welcome_letter();                   //## chea 130899 move to info.next_day</span>
00099 
00100         <span class="comment">/*              break;</span>
00101 <span class="comment">                        case 1:</span>
00102 <span class="comment">                        create_pregame_object_scenario1();</span>
00103 <span class="comment">                        break;</span>
00104 <span class="comment">        */</span>
00105 
00106         <span class="comment">//      err_here();</span>
00107         <span class="keywordflow">break</span>;
00108     }
00109 
00110     <span class="keywordflow">if</span> ( info.prerun_year==1)                       <span class="comment">//## chea 150799 for going out of the prerun</span>
00111         mouse_cursor.set_icon(<a class="code" href="OMOUSECR_8H.html#a6a5">CURSOR_WAITING</a>);
00112 
00113     mouse_cursor.restore_icon(oldCursor);
00114 
00115     <span class="comment">//  int songId = music.random_bgm_track();</span>
00116     <span class="comment">//  music.play(songId, sys.cdrom_drive ? MUSIC_PLAY_CD : 0 );</span>
00117 
00118     <span class="comment">//DEBUG_LOG("Battle:: going to call sys.run()");</span>
00119 
00120     <span class="comment">//--- give the control to the system main loop, start the game now ---//</span>
00121 
00122     sys.run();
00123 }
00124 
00125 <span class="comment">//--------- End of function Battle::run ---------//</span>
00126 
00127 <span class="comment">//-------- Begin of function Battle::create_static_game_object --------//</span>
<a name="l00131"></a><a class="code" href="classBattle.html#a4">00131</a> <span class="comment">void Battle::create_static_game_object() {</span>
00132     <span class="comment">//---- generate roads ----//</span>
00133 
00134     generate_road();
00135 
00136     <span class="comment">//---- generate firms ----//</span>
00137 
00138     generate_firm();
00139 
00140     <span class="comment">//---- generate sprites ----//</span>
00141 
00142     <span class="comment">//  generate_sprite();</span>
00143 
00144     <span class="comment">//---- generate plant ----//</span>
00145 
00146     generate_plant();
00147 
00148 }
00149 
00150 <span class="comment">//-------- Begin of function Battle::create_static_game_object --------//</span>
00151 
00152 <span class="comment">//-------- Begin of function Battle::generate_road ---------//</span>
00153 
00154 <span class="keywordtype">void</span> Battle::generate_road() {
00155     <span class="keywordtype">int</span> blockWidth=10, blockHeight=8;
00156     <span class="keywordtype">int</span> firmId=0;
00157 
00158     <span class="comment">//------- lay horizontal roads -------//</span>
00159 
00160     <span class="comment">// only 3/4 of the area has roads - so that we can have a big area for placing stadium</span>
00161     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> yLoc=0 ; yLoc+blockHeight&lt;=<a class="code" href="Oworldmt_8h.html#a1">MAX_WORLD_Y_LOC</a>*3/4 ; yLoc+=blockHeight ) {
00162         road_res.build_road(0, yLoc, <a class="code" href="Oworldmt_8h.html#a0">MAX_WORLD_X_LOC</a>-2, yLoc );
00163     }
00164 
00165     <span class="comment">//------- lay vertical roads -------//</span>
00166 
00167     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> xLoc=0 ; xLoc+blockWidth&lt;=<a class="code" href="Oworldmt_8h.html#a0">MAX_WORLD_X_LOC</a> ; xLoc+=blockWidth ) {
00168         road_res.build_road(xLoc, 0, xLoc, <a class="code" href="Oworldmt_8h.html#a1">MAX_WORLD_Y_LOC</a>-32 );
00169     }
00170 }
00171 
00172 <span class="comment">//--------- End of function Battle::generate_road ---------//</span>
00173 
00174 <span class="comment">//-------- Begin of function Battle::generate_firm ---------//</span>
00176 <span class="comment">void Battle::generate_firm() {</span>
00177     <span class="keywordtype">int</span>    blockWidth=10, blockHeight=8;
00178     <span class="keywordtype">int</span>    firmId=0;
00179     <a class="code" href="structFirmInfo.html">FirmInfo</a>* firmInfo;
00180 
00181     <span class="keywordflow">while</span>(1) {
00182         <span class="keywordflow">if</span>( ++firmId &gt; firm_res.firm_count )
00183             <span class="keywordflow">break</span>;                                      <span class="comment">// complete creating all needed buildings</span>
00184 
00185         firmInfo = firm_res[firmId];
00186 
00187         <span class="comment">// don't add departmental buildings as they will be added in Battle::create_pregame_objects()</span>
00188         <span class="keywordflow">if</span>( !firmInfo-&gt;<a class="code" href="structFirmInfo.html#m2">field_id</a> &amp;&amp; firmInfo-&gt;<a class="code" href="structFirmInfo.html#a0">is_available</a>() ) {
00189             create_firm(firmId);
00190         }
00191     }
00192 
00193     <span class="comment">//----- add stadium, hard code because it will display across the border ---//</span>
00194 
00195     <span class="comment">//  firm_array.add_firm( 13, MAX_WORLD_Y_LOC-29, FIRM_PLAY_FIELD );         // play field</span>
00196     <span class="comment">// stadium</span>
00197     firm_array.add_firm( 28, <a class="code" href="Oworldmt_8h.html#a1">MAX_WORLD_Y_LOC</a>-29, <a class="code" href="OFIRMID_8H.html#a22a17">FIRM_STADIUM</a> );
00198     <span class="comment">// indoor sports center</span>
00199     firm_array.add_firm( 48, <a class="code" href="Oworldmt_8h.html#a1">MAX_WORLD_Y_LOC</a>-29, <a class="code" href="OFIRMID_8H.html#a22a19">FIRM_INDOOR_SPORTS</a> );
00200 }
00201 
00202 <span class="comment">//--------- End of function Battle::generate_firm ---------//</span>
00203 
00204 <span class="comment">//-------- Begin of function Battle::create_firm ---------//</span>
00205 
00206 <span class="keywordtype">void</span> Battle::create_firm(<span class="keywordtype">int</span> firmId) {
00207     <span class="keywordtype">int</span>    blockWidth=10, blockHeight=8;
00208     <a class="code" href="structFirmInfo.html">FirmInfo</a>* firmInfo = firm_res[firmId];
00209 
00210     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> yLoc=2, yCount=0 ; yLoc+blockHeight&lt;=<a class="code" href="Oworldmt_8h.html#a1">MAX_WORLD_Y_LOC</a> ; yLoc+=blockHeight, yCount++ ) {
00211         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> xLoc=2, xCount=0 ; xLoc+blockWidth&lt;=<a class="code" href="Oworldmt_8h.html#a0">MAX_WORLD_X_LOC</a> ; xLoc+=blockWidth, xCount++ ) {
00212             <span class="keywordflow">if</span>( firmInfo-&gt;<a class="code" href="structFirmInfo.html#m3">loc_width</a> &gt; blockWidth-<a class="code" href="OROAD_8H.html#a10a6">ROAD_WIDTH</a> ||
00213                 firmInfo-&gt;<a class="code" href="structFirmInfo.html#m4">loc_height</a> &gt; blockHeight-<a class="code" href="OROAD_8H.html#a10a7">ROAD_HEIGHT</a> ) {
00214                 <span class="keywordflow">continue</span>;
00215             }
00216 
00217             <span class="keywordtype">int</span> buildXLoc = xLoc + (blockWidth-<a class="code" href="OROAD_8H.html#a10a6">ROAD_WIDTH</a>-firmInfo-&gt;<a class="code" href="structFirmInfo.html#m3">loc_width</a>)/2;
00218             <span class="keywordtype">int</span> buildYLoc = yLoc + (blockHeight-<a class="code" href="OROAD_8H.html#a10a7">ROAD_HEIGHT</a>-firmInfo-&gt;<a class="code" href="structFirmInfo.html#m4">loc_height</a>)/2;
00219 
00220             <span class="keywordflow">if</span>( firmInfo-&gt;<a class="code" href="structFirmInfo.html#a1">can_build</a>(buildXLoc, buildYLoc) ) {
00221                 firm_array.add_firm( buildXLoc, buildYLoc, firmId );
00222                 <span class="keywordflow">return</span>;
00223             }
00224         }
00225     }
00226 }
00227 
00228 <span class="comment">//--------- End of function Battle::create_firm ---------//</span>
00229 
00230 <span class="comment">//-------- Begin of function Battle::generate_plant ---------//</span>
00231 
00232 <span class="keywordtype">void</span> Battle::generate_plant() {
00233     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> yLoc=0 ; yLoc&lt;<a class="code" href="Oworldmt_8h.html#a1">MAX_WORLD_Y_LOC</a> ; yLoc++ ) {
00234         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> xLoc=0 ; xLoc&lt;<a class="code" href="Oworldmt_8h.html#a0">MAX_WORLD_X_LOC</a> ; xLoc++ ) {
00235             <a class="code" href="classLocation.html">Location</a>* locPtr = world.get_loc(xLoc, yLoc);
00236 
00237             <span class="keywordflow">if</span>( !locPtr-&gt;<a class="code" href="classLocation.html#a9">is_empty</a>() )
00238                 <span class="keywordflow">continue</span>;
00239 
00240             <span class="keywordflow">if</span>( m.random(3)==0 ) {
00241                 <span class="keywordtype">int</span> plantId = m.random(plant_res.plant_count)+1;
00242 
00243                 locPtr-&gt;<a class="code" href="classLocation.html#a19">set_plant</a>(plantId, m.random(25), 75+m.random(25));
00244             }
00245         }
00246     }
00247 }
00248 
00249 <span class="comment">//--------- End of function Battle::generate_plant ---------//</span>
00250 
00251 <span class="comment">//--------- Begin of function Battle::generate_sprite --------//</span>
00253 <span class="comment">void Battle::generate_sprite() {</span>
00254     <span class="keywordtype">int</span> unitId = 1;
00255     <span class="keywordtype">int</span> xLoc, yLoc;
00256 
00257     <span class="comment">//TO only put sprite within the viewable area (area within mapview) but not the world</span>
00258     <span class="comment">//i.e. refer to Matrix::draw_objects()</span>
00259     <span class="comment">//</span>
00260     <span class="keywordflow">for</span>( xLoc=0 ; xLoc&lt;<a class="code" href="Oworldmt_8h.html#a0">MAX_WORLD_X_LOC</a> ; xLoc++ ) {
00261         <span class="keywordflow">for</span>( yLoc=0 ; yLoc&lt;<a class="code" href="Oworldmt_8h.html#a1">MAX_WORLD_Y_LOC</a> ; yLoc++ ) {
00262             <a class="code" href="classLocation.html">Location</a>* locPtr = world.get_loc(xLoc, yLoc);
00263 
00264             <span class="keywordflow">if</span>( !locPtr-&gt;<a class="code" href="classLocation.html#a24">is_road</a>() )                    <span class="comment">// place sprite on road</span>
00265                 <span class="keywordflow">continue</span>;
00266 
00267             <span class="comment">//temp: only road is set to be walkable</span>
00268             <a class="code" href="ALL_8H.html#a0">err_when</a>( locPtr-&gt;<a class="code" href="classLocation.html#a11">is_walkable</a>() &amp;&amp; !locPtr-&gt;<a class="code" href="classLocation.html#a24">is_road</a>() );
00269 
00270             <span class="keywordflow">if</span>( !m.random(6) ) {
00271                 locPtr-&gt;<a class="code" href="classLocation.html#a30">set_sprite</a>(unitId);
00272                 <span class="comment">//                              Sprite* spritePtr = new Sprite;</span>
00273                 <span class="comment">//                              spritePtr-&gt;init( unitId, xLoc, yLoc, 0, 0 );</span>
00274                 <span class="comment">//                              sprite_array.add(spritePtr);</span>
00275                 unitId++;
00276             }
00277 
00278         }                                             <span class="comment">// for yLoc</span>
00279     }
00280 
00281     <span class="comment">/*</span>
00282 <span class="comment">      for( xLoc=0 ; xLoc&lt;MAX_WORLD_X_LOC ; xLoc++ )</span>
00283 <span class="comment">      {</span>
00284 <span class="comment">      for( yLoc=0 ; yLoc&lt;MAX_WORLD_Y_LOC ; yLoc++ )</span>
00285 <span class="comment">      {</span>
00286 <span class="comment">      Location* locPtr = world.get_loc(xLoc, yLoc);</span>
00287 <span class="comment"></span>
00288 <span class="comment">      if ( locPtr-&gt;has_sprite() )</span>
00289 <span class="comment">      {</span>
00290 <span class="comment">      //        sprite_array[locPtr-&gt;sprite_recno()]</span>
00291 <span class="comment">      }</span>
00292 <span class="comment">      }</span>
00293 <span class="comment">      }*/</span>
00294 <span class="preprocessor">#ifdef DEBUG</span>
00295 <span class="preprocessor"></span>    debug_msg(<span class="stringliteral">"generate_sprite end: %d"</span>, unitId);
00296 <span class="preprocessor">#endif</span>
00297 <span class="preprocessor"></span>}
00298 
00299 <span class="comment">//---------- End of function Battle::generate_sprite ---------//</span>
00300 
00301 <span class="comment">//--------- Begin of function Battle::run_loaded --------//</span>
<a name="l00303"></a><a class="code" href="classBattle.html#a3">00303</a> <span class="comment">void Battle::run_loaded() {</span>
00304 }
00305 
00306 <span class="comment">//---------- End of function Battle::run_loaded ---------//</span>
00307 
00308 <span class="comment">//--------- Begin of function Battle::init_performance_indicator --------//</span>
00310 <span class="comment">void Battle::init_performance_indicator() {</span>
00311     <span class="keywordtype">int</span> i,j;
00312     <a class="code" href="classStudentArray.html">StudentArray</a>* stuArr;
00313     <a class="code" href="classDepartment.html">Department</a>* deptPtr;
00314 
00315     <span class="keywordflow">for</span> ( i=department_array.size(); i&gt;0; i-- ) {
00316         <span class="keywordflow">if</span> (department_array.is_deleted(i) )
00317             <span class="keywordflow">continue</span>;
00318 
00319         deptPtr = department_array[i];
00320 
00321         <span class="comment">// loop faculty</span>
00322         <span class="keywordflow">for</span> ( j=deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#m1">faculty_count</a>; j&gt;0; j-- ) {
00323             deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>[j]-&gt;<a class="code" href="classFacultyArray.html#a12">update_history</a>(UPDATE_ALL);
00324         }
00325         deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#a12">update_history</a>(UPDATE_ALL);
00326 
00327         <span class="comment">// loop student</span>
00328         stuArr = &amp;(department_array[i]-&gt;student_array);
00329 
00330         <span class="keywordflow">for</span> (j=stuArr-&gt;<a class="code" href="classDynArray.html#a28">size</a>(); j&gt;0; j--) {
00331             <span class="comment">//##        begin zhoubin 000329</span>
00332             <span class="keywordflow">if</span> ( stuArr-&gt;<a class="code" href="classStudentArray.html#a9">is_deleted</a>(j) )
00333                 <span class="keywordflow">continue</span>;
00334             <span class="comment">//##        end     zhoubin 000329</span>
00335             stuArr-&gt;operator[](j)-&gt;<a class="code" href="classStudentArray.html#a12">update_history</a>(UPDATE_ALL);
00336         }
00337         deptPtr-&gt;<a class="code" href="classGeneralDepartment.html#m0">student_array</a>.<a class="code" href="classStudentArray.html#a12">update_history</a>(UPDATE_ALL);
00338 
00339         deptPtr-&gt;<a class="code" href="classDepartment.html#m1">course_array</a>.<a class="code" href="classCourseArray.html#a8">update_history</a>();
00340 
00341         deptPtr-&gt;<a class="code" href="classDepartment.html#a26">update_history</a>(UPDATE_ALL);
00342     }
00343 
00344     department_array.update_history(UPDATE_ALL);
00345 
00346     <span class="comment">// special case for ug yr1 student:</span>
00347     <span class="comment">//</span>
00348     stuArr = &amp;(department_res.general_dept.student_array);
00349     <span class="keywordflow">for</span> (j=stuArr-&gt;<a class="code" href="classDynArray.html#a28">size</a>(); j&gt;0; j--) {
00350         <span class="comment">//##    begin zhoubin 000329</span>
00351         <span class="keywordflow">if</span> ( stuArr-&gt;<a class="code" href="classStudentArray.html#a9">is_deleted</a>(j) )
00352             <span class="keywordflow">continue</span>;
00353         <span class="comment">//##    end     zhoubin 000329</span>
00354         stuArr-&gt;operator[](j)-&gt;<a class="code" href="classStudentArray.html#a12">update_history</a>(UPDATE_ALL);
00355     }
00356 
00357     <span class="comment">// calc institutional-wide vars</span>
00358     <span class="comment">//</span>
00359     <span class="comment">//----------------//</span>
00360 
00361     <span class="keywordflow">for</span> (i=0; i&lt;school_res.peer_school_count; i++) {
00362         <span class="comment">//min &amp; max bug chea</span>
00363         school_res.peer_school_array[i].game_score = (float)m.fmax(20, math.get_random_snd(40,8));
00364     }
00365 
00366     <span class="comment">//---------------//</span>
00367     player_school.init_game_score = 0;
00368     player_school.cur_game_score = 0;
00369     player_school.ultimate_game_score = 0;
00370 
00371     player_school.init_pi();
00372     player_school.update_history(UPDATE_ALL);
00373 }
00374 
00375 <span class="comment">//---------- End of function Battle::init_performance_indicator ---------//</span>
00376 
00377 <span class="comment">//---------- Begin of function Battle::init_doctoral_target() ---------//</span>
00379 <span class="comment">void init_doctoral_target() {</span>
00380     <span class="keywordtype">int</span> i,j;
00381     <a class="code" href="classCourseArray.html">CourseArray</a>* courArr;
00382     <a class="code" href="classDepartment.html">Department</a>* deptPtr;
00383 
00384     <span class="keywordflow">for</span> ( i=department_array.size(); i&gt;0; i-- ) {
00385         <span class="keywordflow">if</span> (department_array.is_deleted(i) )
00386             <span class="keywordflow">continue</span>;
00387 
00388         deptPtr = department_array[i];
00389 
00390         <span class="comment">//-------- PART 1 of 2   //0405</span>
00391         <span class="comment">// deptPtr-&gt;init_doctor_count = deptPtr-&gt;student_level_history[DOCTOR][THIS_YEAR];</span>
00392 
00393         <span class="keywordtype">float</span> doctorPct = 0; {
00394             <span class="keywordtype">char</span> s = <a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a>;
00395             doctorPct = player_school.student_level_pct[s] - player_school.student_level_pct[<a class="code" href="Ostudent_8h.html#a32a5">MASTER</a>];
00396         }
00397 
00398         <span class="comment">// "/4" means 4 year to graduate for DOCTOR in average</span>
00399         deptPtr-&gt;<a class="code" href="classDepartment.html#m34">init_doctor_count</a> = (int) (player_school.get_player_expected_student_count() * doctorPct / 4);
00400 
00401         <span class="comment">//-------- PART 2 of 2</span>
00402 
00403         deptPtr-&gt;<a class="code" href="classDepartment.html#a25">calc_research_dollar</a>();
00404         deptPtr-&gt;<a class="code" href="classDepartment.html#m36">doctors_per_research_dollar</a> = math.safe_divide( deptPtr-&gt;<a class="code" href="classDepartment.html#m34">init_doctor_count</a>, deptPtr-&gt;<a class="code" href="classDepartment.html#m6">total_research_dollar_direct</a>*1000);
00405 
00406         <span class="comment">//-------- PART B</span>
00407 
00408         <span class="keywordtype">int</span> totalBreakoutSections = 0;
00409         courArr = &amp;(department_array[i]-&gt;course_array);
00410 
00411         <span class="keywordflow">for</span> (j=courArr-&gt;<a class="code" href="classDynArray.html#a28">size</a>(); j&gt;0; j--) {
00412             <span class="keywordflow">if</span> ( courArr-&gt;operator[](j)-&gt;teaching_method == <a class="code" href="Ocourse_8h.html#a40a34">BREAKOUT_LAB</a> )
00413                 totalBreakoutSections++;
00414         }
00415 
00416         deptPtr-&gt;<a class="code" href="classDepartment.html#m35">init_breakout_section_count</a> = totalBreakoutSections;
00417         <span class="comment">//min &amp; max bug chea</span>
00418         deptPtr-&gt;<a class="code" href="classDepartment.html#m37">breakout_section_by_doctor</a> = (float) min((<span class="keywordtype">float</span>)(totalBreakoutSections*<a class="code" href="Gamedef_8h.html#a78a35">TRIMESTER_PER_YEAR</a>), (<span class="keywordtype">float</span>)(<a class="code" href="Odept_8h.html#a0">DOCTORAL_AVERAGE_TEACHING_BREAKOUT_SECTIONS</a> * deptPtr-&gt;<a class="code" href="classDepartment.html#m34">init_doctor_count</a>));
00419     }
00420 }
00421 
00422 <span class="comment">//---------- End of function Battle::init_doctoral_target() ---------//</span>
00423 
00424 <span class="comment">//-------- Begin of function Battle::create_pregame_object --------//</span>
00425 <span class="comment">/*</span>
00426 <span class="comment"></span>
00427 <span class="comment">a) generate player school using game settings,</span>
00428 <span class="comment">b) generate DEPARTMENTS</span>
00429 <span class="comment">c) generate non-year-one STUDENT sims</span>
00430 <span class="comment">d) finance.init_data_pre_enroll()</span>
00431 <span class="comment">e) enrollment management: init_data() and enroll_main()</span>
00432 <span class="comment">f) course enrollment for old and newly matriculated students.</span>
00433 <span class="comment">f2) ini.talent for sl1  //later</span>
00434 <span class="comment">g1) generate FACULTY sims</span>
00435 <span class="comment">g2) simulate one-year research progress for FACULTY sims        // 990415</span>
00436 <span class="comment">h) facility_office.init_data_pre_finance()</span>
00437 <span class="comment">i) finance</span>
00438 <span class="comment">j) other small offices</span>
00439 <span class="comment">k) calc statistics: student/faculty count</span>
00440 <span class="comment"></span>
00441 <span class="comment">*/</span>
00442 <span class="comment">//</span>
00443 <span class="comment">// Initialize pre-game objects - departments, students, etc</span>
00444 <span class="comment">//</span>
00445 <span class="keywordtype">void</span> Battle::create_pregame_object() {
00446     <span class="keywordtype">int</span> i;
00447 
00448     <span class="comment">//--------------------------------------//</span>
00449     <span class="comment">//special case:</span>
00450 
00451     <span class="comment">//  box.progress_update(14);</span>
00452 
00453     <span class="comment">//chwg0111</span>
00454     sys.report_before_morerpt_or_deptlist=<a class="code" href="Osys_8h.html#a45a9">MODE_NORMAL</a>;
00455     sys.report_before_help=<a class="code" href="Osys_8h.html#a45a9">MODE_NORMAL</a>;             <span class="comment">//chwg0713</span>
00456 
00457     memset(&amp;athletics_office, 0, <span class="keyword">sizeof</span>(<a class="code" href="classAthletics.html">Athletics</a>));
00458 
00459     athletics_office.last_ncaa_level_input = player_school.athletic_program_intensity;
00460     <span class="comment">// assumed called before school_res.init_game()</span>
00461     athletics_office.input_2_ncaa_level(player_school.athletic_program_intensity);
00462 
00463     school_res.init_game();                         <span class="comment">// initialize school_res.player_peer_school and school_res.peer_school_array[]</span>
00464 
00465     <span class="comment">//---- generate testing departments ----//</span>
00466 
00467     <a class="code" href="classBattle.html#a4">create_static_game_object</a>();
00468 
00469     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Gamedef_8h.html#a10">MAX_DEPARTMENT</a>; i++) {
00470         <span class="keywordtype">int</span> deptId = player_school.selected_department_list[i];
00471         <span class="keywordflow">if</span> ( deptId &lt;= 0 )
00472             <span class="keywordflow">break</span>;
00473         <span class="keywordflow">else</span>
00474             department_array.add(deptId);
00475     }
00476 
00477     department_array.init_data();
00478 
00479     department_res.calc_total_elective_course_pref();
00480 
00481     <span class="comment">//----------------------------//</span>
00482     <span class="comment">//special case:</span>
00483     athletics_office.init_data_pre_finance();
00484 
00485     <span class="comment">//---- generate students ----//</span>
00486 
00487     <span class="keywordflow">for</span>( i=department_array.size() ; i&gt;0 ; i--) {
00488         <span class="keywordflow">if</span>( department_array.is_deleted(i) )
00489             <span class="keywordflow">continue</span>;
00490 
00491         <span class="comment">// clear course data in last trimester</span>
00492         department_array[i]-&gt;course_array.next_trimester();
00493         sys.yield();
00494     }
00495 
00496     box.progress_update(14);                        <span class="comment">//## chea 150799 start prerun year here</span>
00497 
00498     player_school.generate_student();               <span class="comment">// must after deparment_array.add(); this will select courses taken</span>
00499 
00500     <span class="comment">//----- Enrollment model -----//</span>
00501     <span class="comment">// must run after school_res.build_peer_school_array()</span>
00502     <span class="comment">// must run after player_school.generate_student to calc student_count</span>
00503 
00504     finance.init_data_pre_enroll();
00505 
00506     enroll_res.init_data();
00507 
00508     <span class="comment">//---------------------------//</span>
00509     <span class="comment">// whether do this serval times or not???</span>
00510     <span class="comment">//td3.4 section 2.6: overall model initialization</span>
00511 
00512     init_doctoral_target();                         <span class="comment">// before enroll_main</span>
00513     enroll_res.enroll_main(80);                     <span class="comment">// GENERATE student; required for athletics_office.init_data        //1: init_data</span>
00514 
00515     <span class="comment">//---------------------------------------//</span>
00516 
00517     <span class="comment">// g1) generate_faculty() called after course enrollment; see email req42_misc.txt</span>
00518 
00519     <span class="keywordflow">for</span>( i=department_array.size(); i&gt;0; i--) {
00520         <span class="keywordflow">if</span>( department_array.is_deleted(i) )
00521             <span class="keywordflow">continue</span>;
00522 
00523         <a class="code" href="classDepartment.html">Department</a>* deptPtr = department_array[i];
00524 
00525         deptPtr-&gt;<a class="code" href="classDepartment.html#a16">generate_faculty</a>();                  <span class="comment">// GENERATE faculty</span>
00526         deptPtr-&gt;<a class="code" href="classDepartment.html#a21">init_hiring</a>();                       <span class="comment">// must after generate_faculty()</span>
00527     }
00528 
00529     <span class="comment">// g2) simulate one-year research progress for all FACULTY sims     // 990421</span>
00530 
00531     department_array.init_research();               <span class="comment">// 990421</span>
00532 
00533     <span class="comment">//---------------------------------------//</span>
00534 
00535     <span class="comment">//----- Financial model -----//</span>
00536 
00537     facility_office.init_data_pre_finance();        <span class="comment">// 0119 calc normal onm; after course enroll and faculty gen.</span>
00538 
00539     finance.init_data();                            <span class="comment">// after generate faculty and student; also after enroll since requires enroll_res.total_student_count</span>
00540 
00541     <span class="comment">//---------------------------------------//</span>
00542 
00543     <span class="comment">// offices must called after finance.init_data</span>
00544     development_office.init_data();
00545     athletics_office.init_data();                   <span class="comment">// after enroll also</span>
00546 
00547     library_tech_office.init_data();
00548 
00549     student_office.init_data();
00550 
00551     investment_office.init_data();
00552 
00553     <span class="comment">//--- post init ------------------------------------//</span>
00554 
00555     init_performance_indicator();                   <span class="comment">// must after finance and enroll</span>
00556 
00557 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00558 <span class="preprocessor"></span>    info.update_distance_learning_variables(1);     <span class="comment">// need call this function after init_performance_indicator</span>
00559 <span class="preprocessor">#endif</span>
00560 <span class="preprocessor"></span>
00561     library_tech_office.init_data();                <span class="comment">// 990508 // after init_performance_indicator</span>
00562 
00563     facility_office.init_data();                    <span class="comment">// after department_array.add() and department_array.update_history(UPDATE_ALL);</span>
00564 
00565     <span class="comment">// must after finance and enroll</span>
00566     finance.post_init_data();                       <span class="comment">// 0218</span>
00567 
00568     <span class="comment">//-----------------//</span>
00569     <span class="comment">// 0130 scenario</span>
00570 
00571 <span class="preprocessor">#ifdef DEBUG</span>
00572 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (i=department_array.size(); i&gt;0; i--) {
00573         <a class="code" href="classDepartment.html">Department</a> *deptPtr;
00574 
00575         deptPtr = department_array[i];
00576         <a class="code" href="ALL_8H.html#a0">err_when</a>(i != deptPtr-&gt;<a class="code" href="classDepartment.html#m3">department_recno</a>);
00577     }
00578 <span class="preprocessor">#endif</span>
00579 <span class="preprocessor"></span>
00580 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00581 <span class="preprocessor"></span>    <span class="keywordflow">for</span> ( i=department_array.size(); i&gt;0; i-- ) {
00582         <span class="keywordflow">if</span> (department_array.is_deleted(i))
00583             <span class="keywordflow">continue</span>;
00584 
00585         <a class="code" href="classDepartment.html">Department</a>* deptPtr = department_array[i];
00586 
00587         <span class="keywordtype">int</span> arraySize = deptPtr-&gt;cur_faculty_array.size();
00588 
00589         <span class="keywordflow">if</span> ( arraySize != 0 )
00590             deptPtr-&gt;cur_faculty_array.zap();
00591     }
00592 <span class="preprocessor">#endif</span>
00593 <span class="preprocessor"></span>
00594     box.progress_update(28);                        <span class="comment">//## chea 150799 start prerun year here</span>
00595 }
00596 
00597 <span class="comment">//-------- End of function Battle::create_pregame_object --------//</span>
00598 
00599 <span class="comment">//-------- Begin of function Battle::create_pregame_object_scenario1 --------//</span>
00603 <span class="comment">void Battle::create_pregame_object_scenario1() {</span>
00604     create_pregame_object();
00605 }
00606 
00607 <span class="comment">//-------- End of function Battle::create_pregame_object_scenario1 --------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:14 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
