<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Odept_gf.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Odept_gf.cpp</h1><a href="Odept__gf_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename   : ODEPT_GF.CPP</span>
00002 <span class="comment">//Description: functions for generating faculty records in the department class</span>
00003 
00004 <span class="preprocessor">#include &lt;omath.h&gt;</span>
00005 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00006 <span class="preprocessor">#include &lt;OFACURES.H&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="ODEPTRES_8H.html">ODEPTRES.H</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;OFACULTY.H&gt;</span>                             <span class="comment">//##### fred 0919 #####//</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="OSCHLRES_8H.html">OSCHLRES.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>
00011 <span class="preprocessor">#include &lt;<a class="code" href="OPEERSCH_8H.html">OPEERSCH.H</a>&gt;</span>                             <span class="comment">//##### fred 0714 #####//</span>
00012 <span class="preprocessor">#include &lt;OFINANCE.H&gt;</span>
00013 <span class="preprocessor">#include &lt;ODEPT.H&gt;</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="ODATE_8H.html">ODATE.H</a>&gt;</span>
00015 
<a name="l00016"></a><a class="code" href="Odept__gf_8cpp.html#a0">00016</a> <span class="preprocessor">#define DEBUG_VC</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#ifdef DEBUG_VC</span>
00018 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="OLOG_8H.html">OLOG.H</a>&gt;</span>                                 <span class="comment">// for debug matrix</span>
00019 <span class="preprocessor">#include &lt;STDIO.H&gt;</span>                                <span class="comment">//temp for debug matrix</span>
00020 <span class="preprocessor">#endif</span>
00021 <span class="preprocessor"></span>
00022 <span class="comment">//-------- Define struct RankAgeGroup ---------//</span>
00023 
<a name="l00026"></a><a class="code" href="structRankAgeGroup.html">00026</a> <span class="keyword">struct </span><a class="code" href="structRankAgeGroup.html">RankAgeGroup</a> {
<a name="l00027"></a><a class="code" href="structRankAgeGroup.html#m0">00027</a>     <span class="keywordtype">char</span> <a class="code" href="structRankAgeGroup.html#m0">rank_id</a>;
<a name="l00028"></a><a class="code" href="structRankAgeGroup.html#m1">00028</a>     <span class="keywordtype">char</span> <a class="code" href="structRankAgeGroup.html#m1">min_age</a>;
<a name="l00029"></a><a class="code" href="structRankAgeGroup.html#m2">00029</a>     <span class="keywordtype">char</span> <a class="code" href="structRankAgeGroup.html#m2">max_age</a>;
00030 
00031     <span class="comment">//---- vars for storing intermediate results ---//</span>
00032 
<a name="l00033"></a><a class="code" href="structRankAgeGroup.html#m3">00033</a>     <span class="keywordtype">int</span>  <a class="code" href="structRankAgeGroup.html#m3">research_per_faculty</a>;
00034 };
00035 
00036 <span class="comment">//------- Define static vars -----------//</span>
00037 
00038 <span class="keyword">static</span> <a class="code" href="structRankAgeGroup.html">RankAgeGroup</a> rank_age_group_array[<a class="code" href="Ofacures_8h.html#a0">MAX_RANK_AGE_GROUP</a>] = {
00039     { <a class="code" href="Ofaculty_8h.html#a27a9">ASST_PROF</a> , 28, 33 },
00040     { <a class="code" href="Ofaculty_8h.html#a27a10">ASSOC_PROF</a>, 34, 40 }, {
00041         <span class="comment">//## chea 221199 use the old rank</span>
00042         <a class="code" href="Ofaculty_8h.html#a27a11">FULL_PROF</a> , 41, 50
00043     },
00044     { <a class="code" href="Ofaculty_8h.html#a27a11">FULL_PROF</a> , 51, 60 },
00045     { <a class="code" href="Ofaculty_8h.html#a27a11">FULL_PROF</a> , 61, 70 },
00046     { <a class="code" href="Ofaculty_8h.html#a27a12">LONG_TERM_ADJUNCT</a>, 34, 70 },
00047     { <a class="code" href="Ofaculty_8h.html#a27a13">SHORT_TERM_ADJUNCT</a>, 34, 50 },
00048 
00049     <span class="comment">//  { ASST_PROF , 27, 32 },</span>
00050     <span class="comment">//  { ASSOC_PROF, 33, 39 },</span>
00051     <span class="comment">//  { FULL_PROF , 40, 49 },</span>
00052     <span class="comment">//  { FULL_PROF , 50, 59 },</span>
00053     <span class="comment">//  { FULL_PROF , 60, 70 },</span>
00054     <span class="comment">//  { LONG_TERM_ADJUNCT, 33, 70 },</span>
00055     <span class="comment">//  { SHORT_TERM_ADJUNCT, 33, 49 },</span>
00056 };
00057 
00058 <span class="keyword">static</span> <span class="keywordtype">int</span>   average_research_project_size;
00059 <span class="keyword">static</span> <span class="keywordtype">float</span> total_faculty_to_be_added;           <span class="comment">// the total number of faculty ought to be in this department</span>
00060 <span class="keyword">static</span> <span class="keywordtype">float</span> k1=1, k2=1;
00061 
00062 <span class="keyword">static</span> <span class="keywordtype">bool</span> is_minority_group(<span class="keywordtype">char</span> group) {
00063     <span class="keywordflow">return</span> group == <a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a> || group == <a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a>;
00064 }
00065 
00066 <span class="comment">//-------- Begin of function Faculty::rank_age_group -------//</span>
<a name="l00070"></a><a class="code" href="classFaculty.html#d0">00070</a> <span class="comment">int Faculty::rank_age_group(char rank, int aage) {</span>
00071     <span class="keywordtype">int</span> rankAgeGroup;
00072 
00073     <span class="keywordflow">switch</span> (rank) {
00074     <span class="keywordflow">case</span> <a class="code" href="Ofaculty_8h.html#a27a9">ASST_PROF</a>:
00075         rankAgeGroup = 0;
00076         <span class="keywordflow">break</span>;
00077     <span class="keywordflow">case</span> <a class="code" href="Ofaculty_8h.html#a27a10">ASSOC_PROF</a>:
00078         rankAgeGroup = 1;
00079         <span class="keywordflow">break</span>;
00080     <span class="keywordflow">case</span> <a class="code" href="Ofaculty_8h.html#a27a11">FULL_PROF</a>:
00081         rankAgeGroup = 2;
00082 
00083         <span class="comment">// Comment to avoid bug here</span>
00084         <span class="comment">//              if ( aage &lt; rank_age_group_array[rankAgeGroup].min_age )</span>
00085         <span class="comment">//                      err_here();</span>
00086 
00087         <span class="keywordflow">if</span> ( aage &gt; rank_age_group_array[rankAgeGroup].<a class="code" href="structRankAgeGroup.html#m2">max_age</a> )
00088             rankAgeGroup++;
00089 
00090         <span class="keywordflow">if</span> ( aage &gt; rank_age_group_array[rankAgeGroup].<a class="code" href="structRankAgeGroup.html#m2">max_age</a> )
00091             rankAgeGroup++;
00092 
00093         <a class="code" href="ALL_8H.html#a0">err_when</a>(rankAgeGroup &gt; 4);                 <span class="comment">// above may change</span>
00094         <span class="keywordflow">break</span>;
00095     <span class="keywordflow">case</span> <a class="code" href="Ofaculty_8h.html#a27a12">LONG_TERM_ADJUNCT</a>:
00096         rankAgeGroup = 5;
00097         <span class="keywordflow">break</span>;
00098     <span class="keywordflow">case</span> <a class="code" href="Ofaculty_8h.html#a27a13">SHORT_TERM_ADJUNCT</a>:
00099         rankAgeGroup = 6;
00100         <span class="keywordflow">break</span>;
00101     <span class="keywordflow">default</span>:
00102         <a class="code" href="ALL_8H.html#a1">err_here</a>();
00103         <span class="keywordflow">break</span>;
00104     }
00105 
00106     <span class="keywordflow">return</span> rankAgeGroup;
00107 }
00108 
<a name="l00109"></a><a class="code" href="classFaculty.html#d1">00109</a> <span class="keywordtype">int</span> <a class="code" href="classFaculty.html#d1">Faculty::rank_age_group_2_rank</a>(<span class="keywordtype">int</span> rag) {
00110     <span class="keywordflow">return</span> rank_age_group_array[rag].<a class="code" href="structRankAgeGroup.html#m0">rank_id</a>;
00111 }
00112 
<a name="l00113"></a><a class="code" href="classFaculty.html#d3">00113</a> <span class="keywordtype">int</span> <a class="code" href="classFaculty.html#d3">Faculty::get_min_age</a>(<span class="keywordtype">int</span> rankAgeGroup) {
00114     <span class="keywordflow">return</span> rank_age_group_array[rankAgeGroup].<a class="code" href="structRankAgeGroup.html#m1">min_age</a>;
00115 }
00116 
00117 <span class="keyword">static</span> <span class="keywordtype">int</span> is_regular_faculty(<span class="keywordtype">char</span> rank) {
00118     <span class="keywordflow">return</span> (rank==<a class="code" href="Ofaculty_8h.html#a27a9">ASST_PROF</a> || rank==<a class="code" href="Ofaculty_8h.html#a27a10">ASSOC_PROF</a> || rank==<a class="code" href="Ofaculty_8h.html#a27a11">FULL_PROF</a>);
00119 }
00120 
<a name="l00121"></a><a class="code" href="classFaculty.html#a3">00121</a> <span class="keywordtype">bool</span> <a class="code" href="classFaculty.html#a3">Faculty::is_regular</a>() {
00122     <span class="keywordflow">return</span> is_regular_faculty(<a class="code" href="classFaculty.html#m6">rank_level</a>) == 1;
00123 }
00124 
00125 <span class="comment">//---------- End of function Faculty::rank_age_group -----------//</span>
00126 
00127 <span class="comment">//-------- Begin of function Department::generate_faculty -------//</span>
<a name="l00129"></a><a class="code" href="classDepartment.html#a16">00129</a> <span class="comment">void Department::generate_faculty() {</span>
00130     <a class="code" href="ALL_8H.html#a0">err_when</a>(faculty_array.faculty_count != 0);
00131 
00132     generate_faculty_calc_vars();
00133 
00134     <span class="keywordflow">if</span> ( total_faculty_to_be_added &lt; 5 )            <span class="comment">// 990414</span>
00135         total_faculty_to_be_added += 5;
00136 
00137 <span class="preprocessor">#ifdef DEBUG_VC</span>
00138 <span class="preprocessor"></span>
00139     <span class="keywordtype">float</span> facultyCount[<a class="code" href="Ofacures_8h.html#a0">MAX_RANK_AGE_GROUP</a>];
00140     <span class="keywordtype">float</span> sum=0;
00141 
00142     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;<a class="code" href="Ofacures_8h.html#a0">MAX_RANK_AGE_GROUP</a> ; i++ ) {
00143         facultyCount[i] = (float) faculty_to_be_added(i);
00144         sum += facultyCount[i];
00145 
00146         <a class="code" href="ALL_8H.html#a0">err_when</a>(facultyCount[i] &lt; 0);
00147     }
00148 
00149     <a class="code" href="ALL_8H.html#a0">err_when</a>(sum &lt;= 0);
00150 
00151     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofacures_8h.html#a0">MAX_RANK_AGE_GROUP</a> ; i++ ) {
00152         facultyCount[i] = (facultyCount[i]*total_faculty_to_be_added / sum);
00153 
00154         facultyCount[i] += 1.0f;                      <span class="comment">// round up // 990414</span>
00155     }
00156 
00157     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofacures_8h.html#a0">MAX_RANK_AGE_GROUP</a> ; i++ )
00158         generate_faculty_one_group(i, (<span class="keywordtype">int</span>) (facultyCount[i]) );
00159 
00160     <span class="comment">//----------------------------------//</span>
00161     <span class="comment">// calc statistics</span>
00162 
00163     <span class="comment">// 1203</span>
00164     <span class="comment">/* Subject: Re: Q34. letter and hiring</span>
00165 <span class="comment"></span>
00166 <span class="comment">       "Number of faculty on tenure line" equals the total number of assist,</span>
00167 <span class="comment">       associate, and full professors (all three groups); i.e., it excludes the</span>
00168 <span class="comment">       two adjunct categories.</span>
00169 <span class="comment"></span>
00170 <span class="comment">       "number of faculty tenured" equals the total of associate and full</span>
00171 <span class="comment">       professors: i.e., the above minus the assistant professors.</span>
00172 <span class="comment"></span>
00173 <span class="comment">    */</span>
00174 
00175     <span class="comment">//## chea 221099 for testing only</span>
00176 
00177     <span class="comment">//  int test =0;</span>
00178     <span class="comment">//  for (i = faculty_array.size(); i&gt;0; i--)</span>
00179     <span class="comment">//  {</span>
00180     <span class="comment">//          if (faculty_array.is_deleted(i))</span>
00181     <span class="comment">//                  continue;</span>
00182 
00183     <span class="comment">//          test++;</span>
00184 
00185     <span class="comment">//          switch(faculty_array[i]-&gt;rank_level)</span>
00186     <span class="comment">//          {</span>
00187     <span class="comment">//          case ASSOC_PROF:</span>
00188     <span class="comment">//          case FULL_PROF:</span>
00189     <span class="comment">//                  department_array.faculty_count_tenured++;</span>
00190     <span class="comment">//          case ASST_PROF:</span>
00191     <span class="comment">//                  department_array.faculty_count_on_tenure_line++;</span>
00192     <span class="comment">//                  break;</span>
00193     <span class="comment">//          }</span>
00194     <span class="comment">//  }</span>
00195 
00196     <span class="keywordtype">int</span> facCount = faculty_array.faculty_count;
00197 
00198     <a class="code" href="ALL_8H.html#a0">err_when</a>(total_faculty_to_be_added &gt; 0 &amp;&amp; facCount &lt;= 0);
00199     <a class="code" href="ALL_8H.html#a0">err_when</a>(facCount &gt;= 10.0 * total_faculty_to_be_added);
00200 
00201     <span class="keywordtype">char</span> s[300];
00202 
00203     sprintf(s, <span class="stringliteral">"===&gt; dept #%d has %d faculty instead of %f."</span>,
00204             department_recno, facCount, total_faculty_to_be_added );
00205     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(s);
00206 <span class="preprocessor">#endif</span>
00207 <span class="preprocessor"></span>
00208 }
00209 
00210 <span class="comment">//---------- End of function Department::generate_faculty -----------//</span>
00211 
00212 <span class="comment">//-------- Begin of function Department::generate_faculty_one_group -------//</span>
00214 <span class="comment">void Department::generate_faculty_one_group(int rankAgeGroup, int facultyCount ) {</span>
00215     <span class="keywordtype">int</span> totalFacAdded = 0;
00216     <span class="keywordtype">int</span> facutlyRecnoArray[300];                     <span class="comment">// should use mem_add...</span>
00217 
00218     <a class="code" href="ALL_8H.html#a0">err_when</a>(facultyCount &gt; 300 );
00219 
00220     <span class="comment">// = faculty_to_be_added(rankAgeGroup);             // the number of faculty of this rank age group needed to be generated.</span>
00221 
00222     <span class="comment">//----- calculate the percent of minority female -----//</span>
00223 
00224     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a>* deptInfo = department_res[department_id];
00225 
00226     <a class="code" href="structFacultyTemplate.html">FacultyTemplate</a>* facultyTemplate = faculty_res.get_faculty_template( deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m18">template_gender_ethnic</a>, rankAgeGroup );
00227 
00228     <span class="comment">//----- get female and minority percentages from player_school_ex -----//</span>
00229 
00230     <span class="keywordtype">int</span> curRank = rank_age_group_array[rankAgeGroup].<a class="code" href="structRankAgeGroup.html#m0">rank_id</a>;
00231 
00232     <a class="code" href="classPeerSchool.html">PeerSchool</a> *plSch = school_res.player_peer_school;
00233 
00234     <span class="keywordtype">float</span> femalePercent = plSch-&gt;<a class="code" href="classSchoolEx.html#m50">school_faculty_array_ex</a>[curRank].<a class="code" href="structSchoolFaculty.html#m2">female_percent</a>;
00235     <span class="keywordtype">float</span> minorityPercent = plSch-&gt;<a class="code" href="classSchoolEx.html#m50">school_faculty_array_ex</a>[curRank].<a class="code" href="structSchoolFaculty.html#m3">minority_percent</a> ;
00236 
00237     <span class="keywordtype">float</span> percent_faculty_array[<a class="code" href="Gamedef_8h.html#a74a26">GENDER_ETHNIC_TYPE_COUNT</a>];
00238 
00239     <span class="comment">//----- calculate percentage of minority female faculty -----//</span>
00240 
00241     percent_faculty_array[<a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a>] = deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m6">female_multiplier</a> * deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m7">minority_multiplier</a>
00242         * facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m3">female_multiplier</a> * facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m4">minority_multiplier</a>
00243         * femalePercent * minorityPercent / 100
00244         /1.5f;                                        <span class="comment">//## chea 221099 to pull down the minority rate</span>
00245 
00246     <span class="comment">//----- calculate percentage of minority male faculty -----//</span>
00247 
00248     percent_faculty_array[<a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a>] = deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m7">minority_multiplier</a>
00249         * facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m4">minority_multiplier</a>
00250         * minorityPercent
00251         /3;                                           <span class="comment">//## chea 221099 to pull down the minority rate</span>
00252 
00253     <span class="comment">//----- calculate percentage of non-minority female faculty -----//</span>
00254 
00255     <span class="comment">//## chea 061299 BUGHERE</span>
00256     <span class="comment">//  percent_faculty_array[NONMINORITY_FEMALE] = femalePercent;</span>
00257     percent_faculty_array[<a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a>] = femalePercent - percent_faculty_array[<a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a>];
00258 
00259     <span class="comment">//----- calculate percentage of non-minority male faculty -----//</span>
00260 
00261     <span class="comment">//## chea 061299 just for check sum</span>
00262     percent_faculty_array[<a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a>] = 100-percent_faculty_array[<a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a>]
00263         -percent_faculty_array[<a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a>]-percent_faculty_array[<a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a>];
00264 
00265     <span class="comment">//-------- calculate faculty salary --------//</span>
00266 
00267     facultyTemplate = faculty_res.get_faculty_template( deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m19">template_salary</a>, rankAgeGroup );
00268 
00269     <span class="keywordtype">int</span> facultySalary = int( deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m3">salary_multiplier</a> * facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m5">overall_salary_multiplier</a> *
00270                              plSch-&gt;<a class="code" href="classSchoolEx.html#m50">school_faculty_array_ex</a>[curRank].<a class="code" href="structSchoolFaculty.html#m1">salary</a> );
00271 
00272     <span class="comment">//------- calculate faculty talent indices ------//</span>
00273 
00274     facultyTemplate = faculty_res.get_faculty_template( deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m20">template_talent</a>, rankAgeGroup );
00275 
00276     <span class="keywordtype">float</span> talentTeaching    = deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m12">talent_teaching</a> * facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m8">talent_teaching_multiplier</a>;
00277     <span class="comment">//## chea 221099 talentTeaching had not been properly init yet! but if added here will only gen a group of fact.with the same teaching talent</span>
00278     <span class="comment">//   talentTeaching = 20.0f + m.random(79);</span>
00279     <span class="comment">//  if(talentTeaching&gt;=100)</span>
00280     <span class="comment">//          talentTeaching =100;</span>
00281 
00282     <span class="keywordtype">float</span> talentScholarship = deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m13">talent_scholarship</a> * facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m9">talent_scholarship_multiplier</a>;
00283     <span class="keywordtype">float</span> talentResearch    = deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m14">talent_research</a> * facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m10">talent_research_multiplier</a>;
00284 
00285     <span class="comment">//  if (talentResearch==0)</span>
00286     <span class="comment">//  {</span>
00287     <span class="comment">//          int dfhd=0;</span>
00288     <span class="comment">//          talentResearch=13;</span>
00289     <span class="comment">//  }</span>
00290     <span class="comment">//------ calculate the number of minority female faculty -----//</span>
00291 
00292     <span class="keywordtype">float</span> addCount;                                 <span class="comment">// number of faculty needed to be added</span>
00293     <span class="keywordtype">int</span> genderEth;
00294 
00295     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;<a class="code" href="Gamedef_8h.html#a74a26">GENDER_ETHNIC_TYPE_COUNT</a> ; i++ ) {
00296 
00297         <span class="comment">//## chea 201299 unused_faculty_count_array not use here</span>
00298         addCount = (float) facultyCount * percent_faculty_array[i] / 100 + faculty_res.unused_faculty_count_array[i];
00299         <span class="comment">//              addCount = (float) facultyCount * percent_faculty_array[i] / 100;</span>
00300 
00301         <span class="keywordflow">for</span>( ; addCount&gt;=1 ; addCount-- ) {
00302             <span class="keywordflow">if</span> ( totalFacAdded &gt; 1.8 * facultyCount )   <span class="comment">// 990417</span>
00303                 <span class="keywordflow">break</span>;
00304 
00305             <span class="comment">//----- determine the age of the new faculty -----//</span>
00306 
00307             <span class="comment">//## fred ##//</span>
00308             <span class="keywordtype">int</span> facultyAge = rank_age_group_array[rankAgeGroup].<a class="code" href="structRankAgeGroup.html#m1">min_age</a> +
00309                 m.random( rank_age_group_array[rankAgeGroup].max_age
00310                           <span class="comment">//                                                              - rank_age_group_array[rankAgeGroup].min_age + 1 ); //## chea 221199 can't +1 because it may exceed the age group</span>
00311                           - rank_age_group_array[rankAgeGroup].min_age );
00312             <span class="comment">//## fred ##//</span>
00313 
00314             <span class="comment">//------ determine the starting teaching date -----//</span>
00315 
00316             <span class="comment">//## chea old idea totally wrong</span>
00317             <span class="comment">//          int startTeachingDate = info.game_start_date</span>
00318             <span class="comment">//                                                                          - m.random( facultyAge - rank_age_group_array[rankAgeGroup].min_age ) * 365</span>
00319             <span class="comment">//                                                                          - m.random( 365 );</span>
00320 
00321             <span class="comment">//## chea 221199 code 1.8.1  wfm review: 20 Nov 99</span>
00322             <span class="keywordtype">int</span> startTeachingDate = 0;
00323             <span class="keywordflow">if</span>(rankAgeGroup==0)
00324                 startTeachingDate = info.game_start_date - (1+m.random(6))*365;
00325             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rankAgeGroup==1)
00326                 startTeachingDate = info.game_start_date - (1+m.random(10))*365;
00327             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rankAgeGroup==2)
00328                 startTeachingDate = info.game_start_date - (1+m.random(10))*365;
00329             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rankAgeGroup==3)
00330                 startTeachingDate = info.game_start_date - (1+m.random(20))*365;
00331             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rankAgeGroup==4)
00332                 startTeachingDate = info.game_start_date - (1+m.random(30))*365;
00333             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rankAgeGroup==5)
00334                 startTeachingDate = info.game_start_date - (1+m.random(20))*365;
00335             <span class="keywordflow">else</span>
00336                 <span class="comment">//SHORT_TERM_ADJUNCT</span>
00337                 startTeachingDate = info.game_start_date - (1+m.random(5))*365;
00338 
00339             <span class="comment">//---- if the faculty is a female or a minority, apply the needed multiplier ----//</span>
00340 
00341             <span class="keywordtype">int</span> thisFacultySalary = facultySalary;      <span class="comment">// not ($000)</span>
00342 
00343             <span class="keywordflow">if</span>( i==<a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a> || i==<a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a> )
00344                 thisFacultySalary = int( (<span class="keywordtype">float</span>)thisFacultySalary * facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m6">female_salary_multiplier</a> );
00345 
00346             <span class="keywordflow">if</span>( i==<a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a> || i==<a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a> )
00347                 thisFacultySalary = int( (<span class="keywordtype">float</span>)thisFacultySalary * facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m7">minority_salary_multiplier</a> );
00348 
00349             thisFacultySalary = int(thisFacultySalary * math.get_random_snd(1, 0.015f));
00350 
00351             <a class="code" href="ALL_8H.html#a0">err_when</a>(thisFacultySalary&lt;=0);
00352 
00353             <span class="comment">//--------- add a new faculty now ---------//</span>
00354 
00355             genderEth = i;
00356 
00357             <span class="comment">//askbill: do this for new fac sims OR(?) for ALL fac sim generated in a game battle</span>
00358             <span class="keywordflow">if</span> ( player_school.scenario_id == <a class="code" href="Opschool_8h.html#a63a30">SCN_FACULTY_DIVERSITY</a> ) {
00359                 <span class="keywordflow">if</span> ( is_minority_group(genderEth) &amp;&amp; math.get_random_float () &gt; 0.667f ) {
00360                     <span class="keywordflow">if</span> (genderEth == <a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a> )
00361                         genderEth = <a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a>;
00362                     <span class="keywordflow">else</span>
00363                         genderEth = <a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a>;
00364                 }
00365                 <span class="keywordflow">if</span> ( genderEth == <a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a> &amp;&amp; math.get_random_float () &gt; 0.80f )
00366                     genderEth = <a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a>;
00367                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( genderEth == <a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a> &amp;&amp; math.get_random_float () &gt; 0.80f )
00368                     genderEth = <a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a>;
00369             }
00370 
00371             <span class="keywordtype">int</span> facultyRecno = faculty_array.add( department_recno, curRank, genderEth,
00372                                                   facultyAge, startTeachingDate, thisFacultySalary,
00373                                                   (<span class="keywordtype">int</span>) talentTeaching, (<span class="keywordtype">int</span>) talentScholarship, (<span class="keywordtype">int</span>) talentResearch );
00374 
00375             <span class="comment">//--------- initialize pi (principal investigator) for this faculty -------//</span>
00376 
00377             <a class="code" href="classFaculty.html">Faculty</a>* facultyPtr = faculty_array[facultyRecno];
00378 
00379             facultyPtr-&gt;<a class="code" href="classFaculty.html#m19">is_investigator</a> = (math.get_random_float() &lt; deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m15">percent_pi_faculty</a> * deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m14">talent_research</a> / 10000.0f);
00380 
00381             <span class="comment">//## chea 041199 new request</span>
00382             facultyPtr-&gt;<a class="code" href="classFaculty.html#m39">proj_count_mult</a> = (0.8f+0.4f*facultyPtr-&gt;<a class="code" href="classFaculty.html#m29">talent_research</a>/100);
00383             facultyPtr-&gt;<a class="code" href="classFaculty.html#m40">proj_size_mult</a> = (0.7f+0.6f*facultyPtr-&gt;<a class="code" href="classFaculty.html#m29">talent_research</a>/100);
00384 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00385 <span class="preprocessor"></span>            <span class="comment">//facultyPtr-&gt;award_prob = (0.01f+0.5f*facultyPtr-&gt;talent_research/100);</span>
00386             <span class="comment">// change in 18/03/2002</span>
00387             <span class="keywordtype">float</span> oRate = finance.get_research_overhead_rate() / 100.0f;
00388             <span class="keywordtype">float</span> qualityDriver = facultyPtr-&gt;<a class="code" href="classFaculty.html#a23">get_quality_driver</a>();
00389             <span class="keywordtype">float</span> awardProb = 2.0f * (qualityDriver * 0.01f) / math.safe_pow( (1.0f + oRate), 3.0f );
00390             facultyPtr-&gt;<a class="code" href="classFaculty.html#m41">award_prob</a> = m.fmin( 0.85f, m.fmax(0.10f, awardProb) );
00391 <span class="preprocessor">#else</span>
00392 <span class="preprocessor"></span>            facultyPtr-&gt;<a class="code" href="classFaculty.html#m41">award_prob</a> = (0.01f+0.9f*facultyPtr-&gt;<a class="code" href="classFaculty.html#m29">talent_research</a>/100);
00393 <span class="preprocessor">#endif</span>
00394 <span class="preprocessor"></span>
00395             <span class="comment">//----------//</span>
00396 
00397             <span class="comment">// 990412</span>
00398             facutlyRecnoArray[totalFacAdded] = facultyRecno;
00399             totalFacAdded++;
00400         }
00401 
00402         <span class="comment">// store the unused non-integer count for later use</span>
00403         faculty_res.unused_faculty_count_array[i] = addCount;
00404     }
00405 
00406     <span class="comment">//---------- 990412 ----------//</span>
00407 
00408     <span class="comment">// Revision to procedures for handling research projects and proposals (WFM: 6 April 1999); replaces procedures in HE.RespF.</span>
00409     <span class="comment">// k1 = 1/(sum over sims in k of proj_count_mult)</span>
00410     <span class="comment">// k2 = 1/(sum over sims in k of (proj_size_mult*k1* proj_count_mult))</span>
00411 
00412     k1=0, k2=0;
00413 
00414     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j=0; j&lt;totalFacAdded; j++ ) {
00415         <a class="code" href="classFaculty.html">Faculty</a>* facultyPtr = faculty_array[ facutlyRecnoArray[j] ];
00416 
00417         k1 += facultyPtr-&gt;<a class="code" href="classFaculty.html#m39">proj_count_mult</a>;
00418     }
00419 
00420     <span class="keywordtype">float</span> <a class="code" href="OTEST_8H.html#a0">test</a> = (float)totalFacAdded;
00421 
00422     <span class="comment">//## chea 301199 new way to do k1&amp;k2</span>
00423     k1 = math.safe_divide(1.0f, k1);
00424     <span class="comment">//  k1 = math.safe_divide(test, k1);</span>
00425     <span class="comment">//  k1 = math.safe_divide(1.0f, k1);</span>
00426 
00427     <span class="comment">//## chea 161099</span>
00428     department_array.k1con = k1;
00429 
00430     <span class="keywordflow">for</span> ( j=0; j&lt;totalFacAdded; j++ ) {
00431         <a class="code" href="classFaculty.html">Faculty</a>* facultyPtr = faculty_array[ facutlyRecnoArray[j] ];
00432 
00433         <span class="comment">//## chea 161099</span>
00434         <span class="comment">//              k2 += facultyPtr-&gt;proj_size_mult * k1 * facultyPtr-&gt;proj_count_mult;</span>
00435         k2 += facultyPtr-&gt;<a class="code" href="classFaculty.html#m40">proj_size_mult</a> * facultyPtr-&gt;<a class="code" href="classFaculty.html#m39">proj_count_mult</a>;
00436         <span class="comment">//## chea 301199 guess how the proj_size_mult works</span>
00437         <span class="comment">//              k2 += facultyPtr-&gt;proj_size_mult;</span>
00438     }
00439 
00440     <span class="comment">//## chea 301199 new way to do k1&amp;k2</span>
00441     k2 = math.safe_divide(1.0f, k2);
00442     <span class="comment">//  k2 = math.safe_divide(test, k2);</span>
00443     <span class="comment">//  k2 = math.safe_divide(1.0f, k2);</span>
00444 
00445     <span class="comment">//## chea 251099</span>
00446     <span class="comment">//   k1 = 1;</span>
00447     <span class="comment">//   k2 = 2;</span>
00448 
00449     <span class="comment">//## chea 161099</span>
00450     department_array.k2con = k2;
00451 
00452     <span class="comment">//-----------//</span>
00453 
00454     <span class="keywordflow">for</span> ( j=0; j&lt;totalFacAdded; j++ )
00455         generate_faculty_research_project(facutlyRecnoArray[j], rankAgeGroup);
00456 }
00457 
00458 <span class="comment">//---------- End of function Department::generate_faculty_one_group -----------//</span>
00459 
00460 <span class="comment">//-------- Begin of function Department::generate_faculty_calc_vars -------//</span>
00464 <span class="comment">void Department::generate_faculty_calc_vars() {</span>
00465     <span class="comment">//  1230; by email req42_misc_course.txt</span>
00466 
00467     <a class="code" href="classPeerSchool.html">PeerSchool</a> *player = school_res.player_peer_school;
00468 
00469     <span class="keywordtype">float</span> normalTeachingLoad = 3.5f-1.75f / (1+(float)exp(0.5f*
00470                                                           (10-player-&gt;<a class="code" href="classSchool.html#m123">doctoral_degres_per_faculty_rating</a>-1.5f*player-&gt;<a class="code" href="classSchool.html#m122">sponsored_research_rating</a>)));
00471 
00472     <span class="comment">//---- calculate research per faculty for all rank age group ---//</span>
00473 
00474     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;<a class="code" href="Ofacures_8h.html#a0">MAX_RANK_AGE_GROUP</a> ; i++ )
00475         rank_age_group_array[i].<a class="code" href="structRankAgeGroup.html#m3">research_per_faculty</a> = research_per_faculty(i);
00476 
00477     <span class="comment">//---- calculate avg research project size, which equals one-half weighted average res/faculty of full prof group 1 and 2 ---//</span>
00478 
00479     average_research_project_size = ( rank_age_group_array[<a class="code" href="Ofacures_8h.html#a2">FIRST_RANK_AGE_GROUP</a>+2].research_per_faculty
00480                                       + rank_age_group_array[<a class="code" href="Ofacures_8h.html#a2">FIRST_RANK_AGE_GROUP</a>+3].research_per_faculty ) / 4;
00481 
00482     <span class="comment">//---- calculate the total weighted adjusted teaching load ----//</span>
00483 
00484 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00485 <span class="preprocessor"></span>    <span class="comment">//  err_when( average_research_project_size == 0 ); // cause error in weighted_adjusted_teaching_load</span>
00486 <span class="preprocessor">#endif</span>
00487 <span class="preprocessor"></span>
00488     <span class="keywordtype">float</span> totalWeightedAdjustedTeachingLoad = 0;
00489 
00490     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofacures_8h.html#a0">MAX_RANK_AGE_GROUP</a> ; i++ )
00491         totalWeightedAdjustedTeachingLoad += weighted_adjusted_teaching_load(i);
00492 
00493     totalWeightedAdjustedTeachingLoad /= <a class="code" href="Ofacures_8h.html#a0">MAX_RANK_AGE_GROUP</a>;
00494 
00495     <span class="comment">//err_when(totalWeightedAdjustedTeachingLoad &lt;= 0);</span>
00496 
00497     <span class="comment">//## chea 061299 don't know what bug happen here</span>
00498     <span class="keywordflow">if</span> ( totalWeightedAdjustedTeachingLoad &lt; 2 )    <span class="comment">// fix bug on fly; error when "add" some depts on game setting</span>
00499         totalWeightedAdjustedTeachingLoad = 2.0;
00500 
00501     <span class="comment">//---- calculate the total number of faculty ought to be in this department ----//</span>
00502 
00503     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a> *deptInfo = department_res[department_id];
00504     <span class="keywordtype">int</span> total=0;
00505 
00506     <span class="keywordflow">for</span> (i=course_array.size(); i&gt;0; i--) {
00507 
00508         <span class="comment">//-----------------------------------------------------------------------//</span>
00509         <span class="comment">//</span>
00510         <span class="comment">// Battle::init_course_all_student() will produce a bug in student graudation drop</span>
00511         <span class="comment">// as it resets variables in course inproperly. When the function is commented out,</span>
00512         <span class="comment">// the bug disappear.</span>
00513         <span class="comment">//</span>
00514         <span class="comment">// The bugs with the teaching load and total faculty number is due to the initialization</span>
00515         <span class="comment">// of the course. The program call student course selection function many times to process</span>
00516         <span class="comment">// course selection in 4 year in just one function. The drawback is that without properly</span>
00517         <span class="comment">// updating variables in course during the process (in fact it should do each trimester</span>
00518         <span class="comment">// during the 4 year process), the class section count will increase many folds. Simply</span>
00519         <span class="comment">// put, this is like 4 times the students trying to attend courses in a single year, the</span>
00520         <span class="comment">// course section count will increase abnormally.</span>
00521         <span class="comment">//</span>
00522         <span class="comment">// To fix the problem, in dept_gf.cpp's Department::generate_faculty_calc_vars() function,</span>
00523         <span class="comment">// the input course_array[i]-&gt;class_section_count is divided by 4 before it is used in the</span>
00524         <span class="comment">// calculation.</span>
00525         <span class="comment">//</span>
00526         <span class="comment">//-----------------------------------------------------------------------//</span>
00527 
00528         <span class="comment">// assume course enroll</span>
00529         total += course_array[i]-&gt;class_section_count/4;
00530     }
00531 
00532     <span class="comment">//990406 total = max(total, deptInfo-&gt;total_courses_taught);</span>
00533     <span class="comment">//err_when(totalWeightedAdjustedTeachingLoad &gt;= 3);</span>
00534 
00535     total_faculty_to_be_added = total
00536         / (totalWeightedAdjustedTeachingLoad );       <span class="comment">// 1230: comment out (2*total)</span>
00537 
00538     <span class="comment">//fred0615</span>
00539     <span class="keywordflow">if</span>(total_faculty_to_be_added==0)total_faculty_to_be_added=1;
00540 
00541     <a class="code" href="ALL_8H.html#a0">err_when</a>(total_faculty_to_be_added&lt;=0);
00542 }
00543 
00544 <span class="comment">//---------- End of function Department::generate_faculty_calc_vars -----------//</span>
00545 
00546 <span class="comment">//-------- Begin of function Department::init_proj_vars -------//</span>
<a name="l00548"></a><a class="code" href="classDepartment.html#a24">00548</a> <span class="comment">void Department::init_proj_vars(Faculty* facultyPtr) {</span>
00549     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a>* deptInfo = department_res[this-&gt;department_id];
00550     <a class="code" href="structFacultyTemplate.html">FacultyTemplate</a>* templ = faculty_res.get_faculty_template(deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m22">template_discretionary_time</a>, facultyPtr-&gt;rank_age_group() );
00551 
00552     <a class="code" href="classPeerSchool.html">PeerSchool</a> *playerSchool = school_res.player_peer_school;
00553 
00554     <span class="comment">//Test deptInfo-&gt;research_per_faculty_multiplier</span>
00555     <span class="comment">//  float researchPerFaculty = ( (float) playerSchool-&gt;school_faculty_array_ex[facultyPtr-&gt;rank_level].active_research_dollars * templ-&gt;talent_research_multiplier );</span>
00556 
00557     <span class="comment">//## chea 021299 1.8.3</span>
00558     <span class="comment">//  float researchPerFaculty = ( (float) playerSchool-&gt;school_faculty_array_ex[facultyPtr-&gt;rank_level].active_research_dollars * deptInfo-&gt;research_per_faculty_multiplier *</span>
00559     <span class="comment">//                                                           templ-&gt;talent_research_multiplier );</span>
00560     <span class="keywordtype">float</span> researchPerFaculty = ( (float) playerSchool-&gt;<a class="code" href="classSchoolEx.html#m50">school_faculty_array_ex</a>[facultyPtr-&gt;rank_level].<a class="code" href="classSchoolFacultyEx.html#m0">active_research_dollars</a> * deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m5">research_per_faculty_multiplier</a>);
00561 
00562     <span class="comment">//## chea 171199 try to higher thje SR</span>
00563     <span class="comment">//  if(player_school.sponsored_research_intensity &gt; 5)</span>
00564     <span class="comment">//          researchPerFaculty = researchPerFaculty * player_school.sponsored_research_intensity/5;</span>
00565     <span class="comment">//          researchPerFaculty = researchPerFaculty * player_school.sponsored_research_intensity/7;</span>
00566 
00567     <span class="keywordflow">if</span>(player_school.sponsored_research_intensity == 5)
00568         researchPerFaculty = (float)(researchPerFaculty );
00569     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(player_school.sponsored_research_intensity == 6)
00570         researchPerFaculty = (float)(researchPerFaculty * 1.1);
00571     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(player_school.sponsored_research_intensity == 7)
00572         researchPerFaculty = (float)(researchPerFaculty * 1.2);
00573     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(player_school.sponsored_research_intensity == 8)
00574         researchPerFaculty = (float)(researchPerFaculty * 1.3);
00575     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(player_school.sponsored_research_intensity == 9)
00576         researchPerFaculty = (float)(researchPerFaculty * 1.4);
00577     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(player_school.sponsored_research_intensity == 10)
00578         researchPerFaculty = (float)(researchPerFaculty * 1.5);
00579 
00580     <span class="comment">//int expProjs = (int) max(0.0f,min(4.0f,  //## chea 140899  should be wrong min max</span>
00581 
00582     <span class="keywordtype">float</span> <a class="code" href="OTEST_8H.html#a0">test</a> = (float)(researchPerFaculty/(deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m15">percent_pi_faculty</a>/100.0f))/deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m16">normal_research_project_size</a>;
00583 
00584     <span class="keywordtype">float</span> expProjs = (float) max(0.0f,min(4.0f,
00585                                           <span class="comment">//min &amp; max bug chea//## chea 140899 change to float cal</span>
00586                                           (<span class="keywordtype">float</span>)(researchPerFaculty/(deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m15">percent_pi_faculty</a>/100.0f))/deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m16">normal_research_project_size</a>));
00587 
00588     <span class="keywordflow">if</span> ( department_id == 3 )                       <span class="comment">// business dept</span>
00589         <span class="keywordtype">int</span> prob = 0;
00590 
00591     <span class="comment">//## chea 161099 help on changing ave_proj_count &amp; facultyPtr-&gt;ave_proj_size</span>
00592     <span class="comment">//  exp_no_projs_per_PI[k]       = expProjs</span>
00593     <span class="comment">//  adj_res_per_fac[k]           = researchPerFaculty</span>
00594     <span class="comment">//  (pct_fac_who_are_PIs[k]/100) = (deptInfo-&gt;percent_pi_faculty/100.0f);</span>
00595 
00596     <span class="comment">//  facultyPtr-&gt;ave_proj_count = min(MAX_RESEARCH_PROPOSAL, k1 * facultyPtr-&gt;proj_count_mult * researchPerFaculty);   //tryttt</span>
00597     <span class="comment">//  facultyPtr-&gt;ave_proj_count = min((float)(MAX_RESEARCH_PROPOSAL), (float)(k1 * facultyPtr-&gt;proj_count_mult * expProjs)); // min &amp; max bug</span>
00598     <span class="comment">//  facultyPtr-&gt;ave_proj_count = min((float)(MAX_RESEARCH_PROPOSAL), (float)(k1 * facultyPtr-&gt;proj_count_mult * expProjs * (deptInfo-&gt;percent_pi_faculty/100.0f))); //## chea 161099</span>
00599     <span class="comment">//## chea 191199</span>
00600     facultyPtr-&gt;ave_proj_count = min((<span class="keywordtype">float</span>)(<a class="code" href="Ofaculty_8h.html#a5">MAX_RESEARCH_PROPOSAL</a>), (<span class="keywordtype">float</span>)(k1 * facultyPtr-&gt;proj_count_mult * expProjs / (deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m15">percent_pi_faculty</a>/100.0f)));
00601 
00602     <span class="comment">//  facultyPtr-&gt;ave_proj_size = k2* facultyPtr-&gt;proj_size_mult * researchPerFaculty / (deptInfo-&gt;percent_pi_faculty/100.0f);</span>
00603     <span class="comment">//  facultyPtr-&gt;ave_proj_size = k2* facultyPtr-&gt;proj_size_mult * researchPerFaculty;  //## chea240899</span>
00604     <span class="comment">//## chea 161099</span>
00605     facultyPtr-&gt;ave_proj_size = k2* facultyPtr-&gt;proj_size_mult * researchPerFaculty;
00606     <span class="comment">//## chea 301199 test new idea</span>
00607     <span class="comment">//  facultyPtr-&gt;ave_proj_size = k2* facultyPtr-&gt;proj_size_mult * deptInfo-&gt;normal_research_project_size;</span>
00608 
00609     <span class="keywordflow">if</span> ( facultyPtr-&gt;ave_proj_size &lt;= 0 ) {
00610         <span class="keywordtype">float</span> base = math.safe_divide(researchPerFaculty, ((deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m15">percent_pi_faculty</a>/100.0f) * expProjs));
00611         <span class="keywordtype">float</span> tmp = m.fmax(0.0f,(0.5f + 2*math.safe_pow(facultyPtr-&gt;talent_research/100.0f,2)) * base
00612                            <span class="comment">//min &amp; max bug chea</span>
00613                            + m.fmax(0.25f*base, (<span class="keywordtype">float</span>)(math.get_random_snd(0, 0.2f*base))));
00614 
00615         facultyPtr-&gt;ave_proj_size = tmp;
00616     }
00617 
00618     <span class="comment">//------//</span>
00619 
00620     facultyPtr-&gt;research_proposal_count = 0;
00621 }
00622 
00623 <span class="comment">//-------- End of function Department::init_proj_vars -------//</span>
00624 
00625 <span class="comment">//-------- Begin of function Department::generate_faculty_research_project -------//</span>
00629 <span class="comment">void Department::generate_faculty_research_project(int facultyRecno, int rankAgeGroup) {</span>
00630     <span class="comment">// 990604</span>
00631     <span class="keywordflow">if</span> ( player_school.sponsored_research_intensity &lt;= 0 )
00632         <span class="keywordflow">return</span>;
00633 
00634     <a class="code" href="classFaculty.html">Faculty</a>* facultyPtr = faculty_array[facultyRecno];
00635     <span class="keywordtype">int</span> i;
00636     <span class="comment">//## chea 230899</span>
00637     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a>* deptInfo = department_res[this-&gt;department_id];
00638 
00639     <span class="comment">/*</span>
00640 <span class="comment"></span>
00641 <span class="comment">      // 990412</span>
00642 <span class="comment"></span>
00643 <span class="comment">      3. For each faculty sim, calculate:</span>
00644 <span class="comment">      ave_proj_count    = k1* proj_count_mult*exp_no_projs_per_PI[k]</span>
00645 <span class="comment">      ave_proj_size     = k2* proj_size_mult*adj_res_per_fac[k]/(pct_fac_who_are_PIs[k]/100)</span>
00646 <span class="comment"></span>
00647 <span class="comment">      4. For each faculty sim, determine the active projects at initialization:</span>
00648 <span class="comment">      prob (n, ave_proj_count) for n = 0 to max_n</span>
00649 <span class="comment">      Number of active projects is determined according to this probability vector (many faculty will have no projects). Then, for each project:</span>
00650 <span class="comment">      project_size = ave_proj_size *random_normal_deviate(1.0, 0.12),</span>
00651 <span class="comment">      direct = project_size/(1.0+ind_cost_rate); indirect = project_size - direct; and</span>
00652 <span class="comment">      number of months remaining = rand_int[1, 4 + rand_int[0,8]]. ("1" means the project will expire at the end of the first month of play.)</span>
00653 <span class="comment"></span>
00654 <span class="comment">      5. For each faculty sim, determine the outstanding proposals at initialization:</span>
00655 <span class="comment">      prob (n, (ave_prop_dur/ave_proj_dur)*(ave_proj_count/ award_prob)) for n = 0 to max_n</span>
00656 <span class="comment">      Number of outstanding proposals is determined according to this probability vector (many faculty will have no proposals). Then, for each proposal:</span>
00657 <span class="comment">      proposal_size = ave_proj_size *random_normal_deviate(1.0, 0.12) and</span>
00658 <span class="comment">      direct = project_size/(1.0+ind_cost_rate); indirect = project_size - direct; and</span>
00659 <span class="comment">      number of months remaining = rand_int[1, 2 + rand_int[0,4]].</span>
00660 <span class="comment"></span>
00661 <span class="comment">    */</span>
00662 
00663     init_proj_vars(facultyPtr);
00664 
00665     <span class="comment">//return;   //BUGHERE 990422</span>
00666 
00667     <span class="keywordflow">if</span> ( facultyPtr-&gt;<a class="code" href="classFaculty.html#m43">ave_proj_size</a> &lt;= 0 )           <span class="comment">//990414</span>
00668         <span class="keywordflow">return</span>;
00669 
00670     <span class="keywordtype">float</span> prob=0;
00671     <span class="keywordtype">int</span> projectCount = <a class="code" href="Ofaculty_8h.html#a5">MAX_RESEARCH_PROPOSAL</a>;
00672 
00673     <span class="keywordflow">if</span> ( department_id == 3 )                       <span class="comment">// business dept</span>
00674         prob = 0;
00675 
00676     <span class="keywordtype">float</span> randNum = math.get_random_float();
00677     <span class="keywordflow">for</span> ( i=0; i&lt;=<a class="code" href="Ofaculty_8h.html#a5">MAX_RESEARCH_PROPOSAL</a>; i++) {
00678         <span class="comment">//## chea 251099 change back to original</span>
00679         <span class="comment">//              prob += math.double_poisson(i, facultyPtr-&gt;ave_proj_count); // suppose HAVE K1 in it as well //tryttt</span>
00680         <span class="comment">//              prob += math.double_poisson(i, (facultyPtr-&gt;ave_proj_count * deptInfo-&gt;percent_pi_faculty/100.0f));     //## chea 230899</span>
00681         <span class="comment">// suppose HAVE K1 in it as well //tryttt</span>
00682         prob += math.double_poisson(i, facultyPtr-&gt;<a class="code" href="classFaculty.html#m41">award_prob</a>);
00683 
00684         <span class="keywordflow">if</span> ( randNum &lt; prob ) {
00685             projectCount = i;
00686             <span class="keywordflow">break</span>;
00687         }
00688     }
00689 
00690     <span class="comment">//----- add active projects -----//</span>
00691 
00692     <span class="keywordtype">float</span> oRate = finance.get_research_overhead_rate() / 100.0f;
00693 
00694     <span class="keywordflow">for</span>( ; projectCount &gt; 0;
00695          projectCount--, facultyPtr-&gt;<a class="code" href="classFaculty.html#m20">research_proposal_count</a>++ ) {
00696         <span class="comment">// project_size = ave_proj_size *random_normal_deviate(1.0, 0.12),</span>
00697         <span class="comment">// direct = project_size/(1.0+ind_cost_rate); indirect = project_size - direct; and</span>
00698         <span class="comment">// number of months remaining = rand_int[1, 4 + rand_int[0,8]]. ("1" means the project will expire at the end of the first month of play.)</span>
00699 
00700         <a class="code" href="structResearchProposal.html">ResearchProposal</a>* researchProposal = facultyPtr-&gt;<a class="code" href="classFaculty.html#m18">research_proposal_array</a> + facultyPtr-&gt;<a class="code" href="classFaculty.html#m20">research_proposal_count</a>;
00701 
00702         <span class="comment">//## chea 251099</span>
00703         <span class="comment">//              int tmp = (int) max(0.0f, facultyPtr-&gt;ave_proj_size * math.get_random_snd(1.0f, 0.05f));  //min &amp; max bug chea</span>
00704         <span class="comment">//              int tmp = (int) max(0.2f, facultyPtr-&gt;ave_proj_size * math.get_random_snd(1.0f, 0.20f));  //min &amp; max bug chea</span>
00705         <span class="comment">//## chea 221199</span>
00706         <span class="comment">//min &amp; max bug chea</span>
00707         <span class="keywordtype">int</span> tmp = (int) m.fmax(0.0f, facultyPtr-&gt;<a class="code" href="classFaculty.html#m43">ave_proj_size</a> * 1000 * math.get_random_snd(1.0f, 0.05f));
00708 
00709         <span class="comment">//## chea 151199 try to make the research projet non 0</span>
00710         <span class="comment">//              if(tmp &gt;=0 &amp;&amp; tmp &lt;= 1)</span>
00711         <span class="comment">//                      tmp =1;</span>
00712 
00713         <span class="comment">//## chea 191199 1.8.3</span>
00714         <span class="comment">//              if(tmp &gt;=50)</span>
00715         <span class="comment">//                      tmp = 50;</span>
00716 
00717         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> = tmp;
00718 
00719         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m1">overhead_rate</a> = oRate;
00720 
00721         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m2">status</a> = <a class="code" href="Ofaculty_8h.html#a31a25">RESEARCH_ACTIVE</a>;
00722         <span class="comment">//              researchProposal-&gt;date_to_next_status = info.game_date + (4 + m.random(9)) * 30;                // draw a random number from 4 to 12 months</span>
00723         <span class="comment">//              researchProposal-&gt;date_to_next_status = info.game_date + (m.random(6)) * 30;    //## chea 240899        // draw a random number from 0 to 6 months //## 251099 shoild draw a bigger no. since init</span>
00724         <span class="comment">//              researchProposal-&gt;date_to_next_status = info.game_date + (1) * 30;              //## chea 251099 test</span>
00725         <span class="comment">// draw a random number from 2 to 6 months</span>
00726         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m3">date_to_next_status</a> = info.game_date + (2 + m.random(5)) * 30;
00727 
00728         <span class="comment">//## chea 151199 try my cal. method 1.4.1</span>
00729         facultyPtr-&gt;<a class="code" href="classFaculty.html#m21">research_month_expense</a> += tmp / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a>;
00730         facultyPtr-&gt;<a class="code" href="classFaculty.html#m22">research_month_expense_direct</a> += int( ( tmp / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a> ) / ( 1+oRate ));
00731 
00732     }
00733 
00734     <span class="comment">// 5. For each faculty sim, determine the outstanding proposals at initialization:</span>
00735 
00736 <span class="preprocessor">#define AVE_PROP_DUR    3.5f</span>
00737 <span class="preprocessor"></span><span class="preprocessor">#define AVE_PROJ_DUR    8.5f</span>
00738 <span class="preprocessor"></span>
00739     <span class="comment">//  const float forCalcProb = (AVE_PROP_DUR / AVE_PROJ_DUR) * (facultyPtr-&gt;ave_proj_count / facultyPtr-&gt;award_prob );  //tryttt</span>
00740     <span class="comment">//  const float forCalcProb = (AVE_PROP_DUR / AVE_PROJ_DUR) * (facultyPtr-&gt;ave_proj_count * deptInfo-&gt;percent_pi_faculty/100.0f / facultyPtr-&gt;award_prob );  //## chea 230899</span>
00741     <span class="comment">//tryttt</span>
00742     <span class="keyword">const</span> <span class="keywordtype">float</span> forCalcProb = (facultyPtr-&gt;<a class="code" href="classFaculty.html#m41">award_prob</a>);
00743 
00744     randNum = math.get_random_float();
00745     <span class="keywordflow">for</span> ( i=0, prob=0; i&lt;=<a class="code" href="Ofaculty_8h.html#a5">MAX_RESEARCH_PROPOSAL</a>; i++) {
00746         prob += math.double_poisson(i, forCalcProb);
00747 
00748         <span class="keywordflow">if</span> ( randNum &lt; prob ) {
00749             projectCount = i;
00750             <span class="keywordflow">break</span>;
00751         }
00752     }
00753 
00754     <span class="comment">//----- add research proposals -----//</span>
00755 
00756     <span class="keywordflow">for</span>( ; projectCount &gt; 0 &amp;&amp; facultyPtr-&gt;<a class="code" href="classFaculty.html#m20">research_proposal_count</a> &lt; <a class="code" href="Ofaculty_8h.html#a5">MAX_RESEARCH_PROPOSAL</a>;
00757          projectCount--, facultyPtr-&gt;<a class="code" href="classFaculty.html#m20">research_proposal_count</a>++ ) {
00758         <span class="comment">// proposal_size = ave_proj_size *random_normal_deviate(1.0, 0.12) and</span>
00759         <span class="comment">// direct = project_size/(1.0+ind_cost_rate); indirect = project_size - direct; and</span>
00760         <span class="comment">// number of months remaining = rand_int[1, 2 + rand_int[0,4]].</span>
00761 
00762         <a class="code" href="structResearchProposal.html">ResearchProposal</a>* researchProposal = facultyPtr-&gt;<a class="code" href="classFaculty.html#m18">research_proposal_array</a> + facultyPtr-&gt;<a class="code" href="classFaculty.html#m20">research_proposal_count</a>;
00763 
00764         <span class="comment">//## chea 251099</span>
00765         <span class="comment">//              int tmp = (int) max(0.0f, facultyPtr-&gt;ave_proj_size * math.get_random_snd(1.0f, 0.05f)); //min &amp; max bug chea</span>
00766         <span class="comment">//              int tmp = (int) max(0.2f, facultyPtr-&gt;ave_proj_size * math.get_random_snd(1.0f, 0.20f)); //min &amp; max bug chea</span>
00767         <span class="comment">//              int tmp = (int) max(0.2f, facultyPtr-&gt;ave_proj_size ); //## chea 251099 test</span>
00768         <span class="comment">//## chea 221199</span>
00769         <span class="comment">//min &amp; max bug chea</span>
00770         <span class="keywordtype">int</span> tmp = (int) m.fmax(0.0f, facultyPtr-&gt;<a class="code" href="classFaculty.html#m43">ave_proj_size</a> * 1000 * math.get_random_snd(1.0f, 0.05f));
00771 
00772         <span class="comment">//## chea 151199 try to make the research projet non 0</span>
00773         <span class="comment">//              if(tmp &gt;=0 &amp;&amp; tmp &lt;= 1)</span>
00774         <span class="comment">//                      tmp =1;</span>
00775 
00776         <span class="comment">//## chea 191199 1.8.3</span>
00777         <span class="comment">//              if(tmp &gt;=50)</span>
00778         <span class="comment">//                      tmp = 50;</span>
00779 
00780         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> = tmp;
00781 
00782         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m1">overhead_rate</a> = oRate;
00783 
00784         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m2">status</a> = <a class="code" href="Ofaculty_8h.html#a31a24">RESEARCH_PROPOSED</a>;
00785 
00786         <span class="comment">// draw a random number from 2 to 6 months //## not include in old alg.</span>
00787         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m3">date_to_next_status</a> = info.game_date + (2 + m.random(5)) * 30;
00788         <span class="comment">//              researchProposal-&gt;date_to_next_status = info.game_date + (m.random(7)) * 30;            //## 251099 since this is init // draw a random number from 2 to 6 months</span>
00789         <span class="comment">//              researchProposal-&gt;date_to_next_status = info.game_date + (1) * 30;              //## chea 251099 test</span>
00790 
00791     }
00792 
00793     <span class="comment">/*</span>
00794 <span class="comment">      if ( math.get_random_float() &gt; deptInfo-&gt;percent_pi_faculty/100.0f )</span>
00795 <span class="comment">      return;</span>
00796 <span class="comment"></span>
00797 <span class="comment">      //----- add active projects -----//</span>
00798 <span class="comment"></span>
00799 <span class="comment">      float oRate = finance.get_research_overhead_rate() / 100.0f;</span>
00800 <span class="comment">      float projectCount = (float) rank_age_group_array[rankAgeGroup].research_per_faculty / average_research_project_size;</span>
00801 <span class="comment"></span>
00802 <span class="comment">      projectCount *= 1.5;              // 0219</span>
00803 <span class="comment"></span>
00804 <span class="comment">      //----</span>
00805 <span class="comment"></span>
00806 <span class="comment">      float researchPerFaculty = ( (float) playerSchool-&gt;school_faculty_array_ex[facultyPtr-&gt;rank_level].active_research_dollars * deptInfo-&gt;research_per_faculty_multiplier *</span>
00807 <span class="comment">      templ-&gt;talent_research_multiplier );</span>
00808 <span class="comment"></span>
00809 <span class="comment">      int expProjs = (int) max(0,min(4,(researchPerFaculty/(deptInfo-&gt;percent_pi_faculty/100.0f))/deptInfo-&gt;normal_research_project_size));</span>
00810 <span class="comment"></span>
00811 <span class="comment">      float base = math.safe_divide(researchPerFaculty, ((deptInfo-&gt;percent_pi_faculty/100.0f) * expProjs));</span>
00812 <span class="comment"></span>
00813 <span class="comment">      for( ; projectCount &gt; 0 &amp;&amp; facultyPtr-&gt;research_proposal_count &lt; MAX_RESEARCH_PROPOSAL  ;</span>
00814 <span class="comment">      projectCount--, facultyPtr-&gt;research_proposal_count++ )           // number of active projects = random integer, based on research per faculty / average project size</span>
00815 <span class="comment">      {</span>
00816 <span class="comment">      //--- if projectCount &gt; 0 &amp;&amp; projectCount &lt; 1, randomly decide whether a new project needs to be added or not ---//</span>
00817 <span class="comment"></span>
00818 <span class="comment">      if( projectCount &lt; 1 &amp;&amp; m.random(10) &gt; projectCount*10 )</span>
00819 <span class="comment">      break;</span>
00820 <span class="comment"></span>
00821 <span class="comment">      //-----------------------------------------------//</span>
00822 <span class="comment"></span>
00823 <span class="comment">      ResearchProposal* researchProposal = facultyPtr-&gt;research_proposal_array + facultyPtr-&gt;research_proposal_count;</span>
00824 <span class="comment"></span>
00825 <span class="comment">      //0405 researchProposal-&gt;total_dollars = average_research_project_size * (100+m.random(10)-5) / 100;              // -5 to +5 randomness</span>
00826 <span class="comment"></span>
00827 <span class="comment">      float tmp = max(0,(0.5f + 2*math.safe_pow(facultyPtr-&gt;talent_research/100.0f,2)) * base</span>
00828 <span class="comment">      + max(0.25f*base, math.get_random_snd(0, 0.2f*base)));</span>
00829 <span class="comment">      researchProposal-&gt;total_dollars = (int) tmp;</span>
00830 <span class="comment"></span>
00831 <span class="comment">      researchProposal-&gt;overhead_rate = oRate;</span>
00832 <span class="comment"></span>
00833 <span class="comment">      researchProposal-&gt;status = RESEARCH_ACTIVE;</span>
00834 <span class="comment">      researchProposal-&gt;date_to_next_status = info.game_date + (4 + m.random(9)) * 30;          // draw a random number from 4 to 12 months</span>
00835 <span class="comment"></span>
00836 <span class="comment">      facultyPtr-&gt;research_month_expense += researchProposal-&gt;total_dollars / MAX_ACTIVE_RESEARCH_MONTH;</span>
00837 <span class="comment">      facultyPtr-&gt;research_month_expense_direct = int(facultyPtr-&gt;research_month_expense / ( 1+oRate));</span>
00838 <span class="comment">      }</span>
00839 <span class="comment"></span>
00840 <span class="comment">      //----- add proposed projects -----//</span>
00841 <span class="comment"></span>
00842 <span class="comment">      projectCount = (float) rank_age_group_array[rankAgeGroup].research_per_faculty / average_research_project_size / 2;</span>
00843 <span class="comment"></span>
00844 <span class="comment">      projectCount *= 1.5;              // 0219</span>
00845 <span class="comment"></span>
00846 <span class="comment">      for( ; projectCount &gt; 0 &amp;&amp; facultyPtr-&gt;research_proposal_count &lt; MAX_RESEARCH_PROPOSAL  ;</span>
00847 <span class="comment">      projectCount--, facultyPtr-&gt;research_proposal_count++ )</span>
00848 <span class="comment">      {</span>
00849 <span class="comment">      //--- if projectCount &gt; 0 &amp;&amp; projectCount &lt; 1, randomly decide whether a new project needs to be added or not ---//</span>
00850 <span class="comment"></span>
00851 <span class="comment">      if( projectCount &lt; 1 &amp;&amp; m.random(10) &gt; projectCount*10 )</span>
00852 <span class="comment">      break;</span>
00853 <span class="comment"></span>
00854 <span class="comment">      //-----------------------------------------------//</span>
00855 <span class="comment"></span>
00856 <span class="comment">      ResearchProposal* researchProposal = facultyPtr-&gt;research_proposal_array + facultyPtr-&gt;research_proposal_count;</span>
00857 <span class="comment"></span>
00858 <span class="comment">      //researchProposal-&gt;total_dollars = average_research_project_size * (100+m.random(10)-5) / 100;           // -5 to +5 randomness</span>
00859 <span class="comment"></span>
00860 <span class="comment">      float tmp = max(0,(0.5f + 2*math.safe_pow(facultyPtr-&gt;talent_research/100.0f,2)) * base</span>
00861 <span class="comment">      + max(0.25f*base, math.get_random_snd(0, 0.2f*base)));</span>
00862 <span class="comment">      researchProposal-&gt;total_dollars = (int) tmp;</span>
00863 <span class="comment"></span>
00864 <span class="comment">      researchProposal-&gt;overhead_rate = oRate;</span>
00865 <span class="comment"></span>
00866 <span class="comment">      researchProposal-&gt;status = RESEARCH_PROPOSED;</span>
00867 <span class="comment">      researchProposal-&gt;date_to_next_status = info.game_date + (2 + m.random(5)) * 30;          // draw a random number from 2 to 6 months</span>
00868 <span class="comment">      }</span>
00869 <span class="comment">    */</span>
00870 }
00871 
00872 <span class="comment">//---------- End of function Department::generate_faculty_research_project -----------//</span>
00873 
00874 <span class="comment">//-------- Begin of function Department::research_per_faculty -------//</span>
00878 <span class="comment">int Department::research_per_faculty(int rankAgeGroup) {</span>
00879     <span class="comment">//---- calculate research per faculty -----//</span>
00880 
00881     <a class="code" href="classPeerSchool.html">PeerSchool</a> *playerSchoolEx = school_res.player_peer_school;
00882 
00883     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a>* deptInfo = department_res[department_id];
00884 
00885     <span class="comment">// get the talent template</span>
00886     <a class="code" href="structFacultyTemplate.html">FacultyTemplate</a>* facultyTemplate = faculty_res.get_faculty_template( deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m20">template_talent</a>, rankAgeGroup );
00887 
00888     <span class="keywordtype">int</span> facultyRank = rank_age_group_array[rankAgeGroup].<a class="code" href="structRankAgeGroup.html#m0">rank_id</a>;
00889 
00890     <span class="keywordtype">int</span> researchPerFaculty = (int) ( (float) playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m50">school_faculty_array_ex</a>[facultyRank].<a class="code" href="classSchoolFacultyEx.html#m0">active_research_dollars</a> * deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m5">research_per_faculty_multiplier</a> *
00891                                      facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m10">talent_research_multiplier</a> );<span class="comment">// ($000)</span>
00892 
00893     <span class="keywordflow">return</span> researchPerFaculty;
00894 }
00895 
00896 <span class="comment">//---------- End of function Department::research_per_faculty -----------//</span>
00897 
00898 <span class="comment">//-------- Begin of function Department::weighted_adjusted_teaching_load -------//</span>
00903 <span class="comment">float Department::weighted_adjusted_teaching_load(int rankAgeGroup) {</span>
00904     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a>* deptInfo = department_res[department_id];
00905 
00906     <span class="comment">//---- get normal course load of the current department ----//</span>
00907 
00908     <a class="code" href="structFacultyTemplate.html">FacultyTemplate</a>* facultyTemplate;
00909 
00910     facultyTemplate = faculty_res.get_faculty_template( deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m21">template_course_load</a>, rankAgeGroup );
00911 
00912     <span class="comment">//----//</span>
00913 
00914     <a class="code" href="classPeerSchool.html">PeerSchool</a> *player = school_res.player_peer_school;
00915 
00916     <span class="comment">// unit: courses/semester</span>
00917     <span class="comment">//  float normalTeachingLoad = float(3.5-1.75/(1+exp(0.5*(10-player-&gt;doctoral_degres_per_faculty_rating-1.5*player-&gt;sponsored_research_rating ))));</span>
00918     <span class="keywordtype">float</span> normalTeachingLoad = float(3.5-3.5/(1+exp(0.5*(10-player-&gt;<a class="code" href="classSchool.html#m123">doctoral_degres_per_faculty_rating</a>-1.5*player-&gt;<a class="code" href="classSchool.html#m122">sponsored_research_rating</a> ))));
00919 
00920     <a class="code" href="ALL_8H.html#a0">err_when</a>( normalTeachingLoad &lt;=0 );
00921 
00922     normalTeachingLoad *= facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m11">normal_teaching_load_multiplier</a>
00923         * deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m4">teaching_load_multiplier</a>;
00924 
00925     <span class="comment">//----- Scenario special handling ---------//</span>
00926 
00927     <span class="keywordflow">if</span>(player_school.scenario_id==<a class="code" href="Opschool_8h.html#a63a24">SCN_TEACHING_QUALITY</a>) {
00928         <span class="keywordflow">if</span>( player_school.scen_dept_selected_array[department_recno-1] )
00929             normalTeachingLoad *=0.333f;
00930     }
00931 
00932     <span class="keywordflow">if</span>(player_school.scenario_id==<a class="code" href="Opschool_8h.html#a63a25">SCN_RESEARCH_QUALITY</a>) {
00933         <span class="keywordflow">if</span>( player_school.scen_dept_selected_array[department_recno-1] )
00934             normalTeachingLoad *=2.0f;
00935     }
00936 
00937     <span class="comment">//---- calculate research per faculty -----//</span>
00938 
00939     <span class="keywordtype">int</span> researchPerFaculty = rank_age_group_array[rankAgeGroup].<a class="code" href="structRankAgeGroup.html#m3">research_per_faculty</a>;
00940 
00941     <span class="comment">//-------- calculate adjusted teaching load --------//</span>
00942 
00943     <span class="comment">//1230 note: this part is not the same in faculty_initialization</span>
00944     <span class="comment">// adjustedTeachingLoad = 4 roughly.</span>
00945     <span class="keywordtype">float</span> adjustedTeachingLoad = (float)( 0.6 * normalTeachingLoad + 0.4 * normalTeachingLoad
00946                                           / ( 1 + exp(-4.39 + 2.2 * researchPerFaculty
00947                                                       / average_research_project_size) ));
00948 
00949     facultyTemplate = faculty_res.get_faculty_template( deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m17">template_rank_and_age</a>, rankAgeGroup );
00950 
00951     <span class="comment">//---- calculate and return weighted adjusted teaching load -----//</span>
00952 
00953     <span class="comment">// 990415 return adjustedTeachingLoad * facultyTemplate-&gt;rank_age_multiplier;</span>
00954 
00955     <span class="keywordflow">return</span> adjustedTeachingLoad * facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m2">rank_age_multiplier</a> * 0.9f;
00956 }
00957 
00958 <span class="comment">//---------- End of function Department::weighted_adjusted_teaching_load -----------//</span>
00959 
00960 <span class="comment">//-------- Begin of function Department::faculty_to_be_added -------//</span>
00964 <span class="comment">int Department::faculty_to_be_added(int rankAgeGroup) {</span>
00965     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a>* deptInfo = department_res[department_id];
00966     <a class="code" href="structFacultyTemplate.html">FacultyTemplate</a>* facultyTemplate;
00967 
00968     <span class="comment">//----- calculate raw % faculty from database (player_peer_school) -----//</span>
00969 
00970     <span class="keywordtype">int</span> totalProfCount = 0;
00971 
00972     <a class="code" href="classPeerSchool.html">PeerSchool</a> *playerSchoolEx = school_res.player_peer_school;
00973 
00974     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;<a class="code" href="Ofaculty_8h.html#a26a8">FACULTY_RANK_LEVEL_COUNT</a> ; i++ )
00975         totalProfCount += playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m50">school_faculty_array_ex</a>[i].<a class="code" href="structSchoolFaculty.html#m0">faculty_count</a>;
00976 
00977     <span class="keywordtype">int</span> curRank = rank_age_group_array[rankAgeGroup].<a class="code" href="structRankAgeGroup.html#m0">rank_id</a>;
00978 
00979     <span class="keywordtype">float</span> rawPercentFaculty = (float) playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m50">school_faculty_array_ex</a>[curRank].<a class="code" href="structSchoolFaculty.html#m0">faculty_count</a> / totalProfCount;
00980 
00981     <span class="comment">//---- calculate adjusted % faculty -------//</span>
00982 
00983     <span class="comment">//1230 note: this part is not the same in faculty_initialization</span>
00984 
00985     <span class="keywordtype">float</span> templateWeight = 2;                       <span class="comment">// define template weight relative to db weight</span>
00986 
00987     facultyTemplate = faculty_res.get_faculty_template( deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m17">template_rank_and_age</a>, rankAgeGroup );
00988 
00989     <span class="keywordtype">float</span> adjustedPercentFaculty = (templateWeight * facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m2">rank_age_multiplier</a> + rawPercentFaculty) / (templateWeight + 1);
00990 
00991     <span class="comment">//----- calculate the number of faculty of this rank age group -----//</span>
00992 
00993     <a class="code" href="ALL_8H.html#a0">err_when</a>(total_faculty_to_be_added &lt;= 0 || adjustedPercentFaculty &gt; 1.5);
00994 
00995     <span class="keywordflow">return</span> int( total_faculty_to_be_added * adjustedPercentFaculty );
00996 }
00997 
00998 <span class="comment">//---------- End of function Department::faculty_to_be_added -----------//</span>
00999 
01000 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01001 <span class="preprocessor"></span><span class="comment">// --- Begin of Department::faculty_new_hires_number --- //</span>
01002 <span class="comment">//</span>
01003 <span class="keywordtype">int</span> Department::faculty_new_hires_number() {
01004     <span class="keywordtype">int</span> hiresCount = 0;
01005     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=1; i&lt;=display_faculty_array.size(); i++) {
01006         <a class="code" href="classFaculty.html">Faculty</a>* facPtr = (<a class="code" href="classFaculty.html">Faculty</a>*) display_faculty_array.get(i);
01007         <span class="keywordflow">if</span> ( facPtr-&gt;employ_status == 0 )
01008             hiresCount++;
01009     }
01010     <span class="keywordflow">return</span> hiresCount;
01011 }
01012 
01013 <span class="comment">//</span>
01014 <span class="comment">// --- End of Department::faculty_new_hires_number --- //</span>
01015 
01016 <span class="comment">// --- Begin of Department::faculty_departures_number --- //</span>
01017 <span class="comment">//</span>
01018 <span class="keywordtype">int</span> Department::faculty_departures_number() {
01019     <span class="keywordtype">int</span> departureCount = 0;
01020     <span class="keywordflow">if</span> ( faculty_res.is_year_end_report ) {
01021         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=1; i&lt;=cur_faculty_array.size(); i++ ) {
01022             <a class="code" href="classFaculty.html">Faculty</a>* facPtr = (<a class="code" href="classFaculty.html">Faculty</a>*) cur_faculty_array.get(i);
01023             <span class="keywordflow">if</span> ( facPtr-&gt;employ_status == 1 )
01024                 departureCount++;
01025         }
01026     }
01027     <span class="keywordflow">else</span> {
01028         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=1; i&lt;=display_faculty_array.size(); i++ ) {
01029             <a class="code" href="classFaculty.html">Faculty</a>* facPtr = (<a class="code" href="classFaculty.html">Faculty</a>*) display_faculty_array.get(i);
01030             <span class="keywordflow">if</span> ( facPtr-&gt;employ_status == 1 )
01031                 departureCount++;
01032         }
01033     }
01034 
01035     <span class="keywordflow">return</span> departureCount;
01036 }
01037 
01038 <span class="comment">//</span>
01039 <span class="comment">// --- End of Department::faculty_departures_number --- //</span>
01040 
01041 <span class="comment">// --- Begin of Department::faculty_promotions_number --- //</span>
01042 <span class="comment">//</span>
01043 <span class="keywordtype">int</span> Department::faculty_promotions_number() {
01044     <span class="keywordtype">int</span> promotionCount = 0;
01045     <span class="keywordflow">if</span> ( faculty_res.is_year_end_report ) {
01046         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=1; i&lt;=cur_faculty_array.size(); i++ ) {
01047             <a class="code" href="classFaculty.html">Faculty</a>* facPtr = (<a class="code" href="classFaculty.html">Faculty</a>*) cur_faculty_array.get(i);
01048             <span class="keywordflow">if</span> ( facPtr-&gt;employ_status == 2 )
01049                 promotionCount++;
01050         }
01051     }
01052     <span class="keywordflow">else</span> {
01053         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=1; i&lt;=display_faculty_array.size(); i++ ) {
01054             <a class="code" href="classFaculty.html">Faculty</a>* facPtr = (<a class="code" href="classFaculty.html">Faculty</a>*) display_faculty_array.get(i);
01055             <span class="keywordflow">if</span> ( facPtr-&gt;employ_status == 2 )
01056                 promotionCount++;
01057         }
01058     }
01059 
01060     <span class="keywordflow">return</span> promotionCount;
01061 }
01062 <span class="preprocessor">#endif</span>
01063 <span class="preprocessor"></span>
01064 <span class="comment">//#### begin fred 0919 ###//</span>
01065 <span class="comment">//---------- Begin of function Department::calc_faculty_count_by_rank_age -----------//</span>
01067 <span class="comment">void Department::calc_faculty_count_by_rank_age(int *facultyCountArray) {</span>
01068     <span class="keywordtype">int</span> totalCount=0;
01069 
01070     memset(facultyCountArray,0,<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * <a class="code" href="Ofacures_8h.html#a0">MAX_RANK_AGE_GROUP</a> );
01071 
01072     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=faculty_array.size() ; i&gt;0 ; i-- ) {
01073         <span class="keywordflow">if</span>( faculty_array.is_deleted(i) )
01074             <span class="keywordflow">continue</span>;
01075 
01076         <a class="code" href="classFaculty.html">Faculty</a> *facPtr = faculty_array[i];
01077         <span class="keywordtype">int</span> rankAgeGroup = <a class="code" href="classFaculty.html#a2">Faculty::rank_age_group</a>(facPtr-&gt;<a class="code" href="classFaculty.html#m6">rank_level</a>, facPtr-&gt;<a class="code" href="classFaculty.html#a1">age</a>());
01078 
01079         facultyCountArray[rankAgeGroup]++;
01080         totalCount++;
01081     }
01082 
01083     <a class="code" href="ALL_8H.html#a0">err_when</a>(totalCount != faculty_array.faculty_count);
01084 }
01085 
01086 <span class="comment">//---------- End of function Department::calc_faculty_count_by_rank_age -----------//</span>
01087 
01088 <span class="comment">//------ Begin of function Department::calc_research_dollar -------//</span>
<a name="l01090"></a><a class="code" href="classDepartment.html#a25">01090</a> <span class="comment">void Department::calc_research_dollar() {</span>
01091     total_research_dollar = 0;    total_research_dollar_direct = 0;
01092 
01093     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=faculty_array.size() ; i&gt;0 ; i-- ) {
01094         <span class="keywordflow">if</span>( faculty_array.is_deleted(i) )
01095             <span class="keywordflow">continue</span>;
01096 
01097         total_research_dollar += faculty_array[i]-&gt;<a class="code" href="classFaculty.html#m21">research_month_expense</a>;
01098         total_research_dollar_direct += faculty_array[i]-&gt;<a class="code" href="classFaculty.html#m22">research_month_expense_direct</a>;
01099     }
01100 }
01101 
01102 <span class="comment">//------ End of function Department::calc_research_dollar -------//</span>
01103 
01104 <span class="comment">//------ Begin of function Department::calc_research_norm -------//</span>
01106 <span class="comment">void Department::calc_research_norm() {</span>
01107     <span class="comment">//---------------------//</span>
01108     research_dollar_norm = 0;
01109 
01110     <span class="comment">// research_dollar_norm -</span>
01111     <span class="comment">// "Global ave. research per faculty" is calculated by a formula like</span>
01112     <span class="comment">// the one in cells B18:B24 of HE.GDB.init:Faculty_Initialization.</span>
01113     <span class="comment">//</span>
01114     <span class="comment">// To make the calculation replace the qualtity defined in Column BW1238</span>
01115     <span class="comment">// of the initialization database (the first term in the formula) with the</span>
01116     <span class="comment">// average of this quantity over all the institutions in the</span>
01117     <span class="comment">// database (all 1100 institutions, not just the initialization or peer institutions).</span>
01118     <span class="comment">//</span>
01119     <span class="comment">// The figure is determined once and for all at initialization. It is age-rank</span>
01120     <span class="comment">// as well as department-specific. At the beginning of each year (after</span>
01121     <span class="comment">// departures and hires), calculate a weighted average over the regular faculty</span>
01122     <span class="comment">// age-rank categories using the number of faculty as weights.</span>
01123 
01124     <span class="comment">//PeerSchool *playerSchoolEx = school_res.player_peer_school;</span>
01125     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a>* deptInfo = department_res[department_id];
01126     <span class="keywordtype">int</span> facultyCount[<a class="code" href="Ofacures_8h.html#a0">MAX_RANK_AGE_GROUP</a>];
01127     <span class="keywordtype">int</span> totalRegFacCount=0;
01128 
01129     calc_faculty_count_by_rank_age(facultyCount);
01130 
01131     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> rankAgeGroup=0 ; rankAgeGroup&lt;<a class="code" href="Ofacures_8h.html#a0">MAX_RANK_AGE_GROUP</a> ; rankAgeGroup++ ) {
01132         <span class="comment">// get the talent template</span>
01133         <a class="code" href="structFacultyTemplate.html">FacultyTemplate</a>* facultyTemplate = faculty_res.get_faculty_template( deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m20">template_talent</a>, rankAgeGroup );
01134 
01135         <span class="keywordtype">int</span> facultyRank = rank_age_group_array[rankAgeGroup].<a class="code" href="structRankAgeGroup.html#m0">rank_id</a>;
01136 
01137         <span class="keywordflow">if</span> ( !is_regular_faculty(facultyRank) )
01138             <span class="keywordflow">continue</span>;
01139 
01140         <span class="keywordtype">int</span> researchPerFaculty = (int) ( (float) department_array.average_research_dollars[facultyRank]
01141                                          * facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m10">talent_research_multiplier</a> * deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m5">research_per_faculty_multiplier</a> );
01142         <span class="comment">/*</span>
01143 <span class="comment">          int researchPerFaculty = (int) ( (PeerSchool::average_faculty_salary[facultyRank] / 1000.0)</span>
01144 <span class="comment">          * facultyTemplate-&gt;talent_research_multiplier * deptInfo-&gt;research_per_faculty_multiplier );</span>
01145 <span class="comment"></span>
01146 <span class="comment">          int researchPerFaculty = (int) ( (PeerSchool::average_faculty_salary[facultyRank] / 1000.0)</span>
01147 <span class="comment">          * facultyTemplate-&gt;talent_research_multiplier * deptInfo-&gt;research_per_faculty_multiplier );</span>
01148 <span class="comment">          */</span>
01149         <span class="keywordtype">int</span> count = facultyCount[rankAgeGroup];
01150 
01151         research_dollar_norm += researchPerFaculty * count;
01152         totalRegFacCount += count;
01153     }
01154 
01155     <a class="code" href="ALL_8H.html#a0">err_when</a>(totalRegFacCount != get_regular_faculty_count());
01156 
01157     <span class="keywordflow">if</span> ( research_dollar_norm &gt; 0 )
01158         research_dollar_norm /= totalRegFacCount;
01159     <span class="keywordflow">else</span>
01160         research_dollar_norm = 0;
01161 }
01162 
01163 <span class="comment">//------- End of function Department::calc_research_norm --------//</span>
01164 <span class="comment">//#### end fred 0919 ###//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:22 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
