<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OTRANSL.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>OTRANSL.CPP</h1><a href="OTRANSL_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OTRANSL.CPP</span>
00002 <span class="comment">//Description : Multi-lingual Translation Class</span>
00003 
00004 <span class="preprocessor">#include &lt;string.h&gt;</span>
00005 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00006 
00007 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;<a class="code" href="OGAME_8H.html">OGAME.H</a>&gt;</span>
00009 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="OFILETXT_8H.html">OFILETXT.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;<a class="code" href="OTRANSL_8H.html">OTRANSL.H</a>&gt;</span>
00012 
00013 <span class="comment">//--------- Define constant ---------//</span>
00014 
<a name="l00015"></a><a class="code" href="OTRANSL_8CPP.html#a0">00015</a> <span class="preprocessor">#define TRANSLATE_FILE_NAME   DIR_RES"TRANSLAT.RES"</span>
00016 <span class="preprocessor"></span>
00017 <span class="comment">//------- Format of the translation resource file --------//</span>
00018 <span class="comment">//</span>
00019 <span class="comment">// &lt;Original Text&gt;|&lt;Translated Text&gt;~</span>
00020 <span class="comment">//</span>
00021 <span class="comment">// | - separator between the original and the translated text</span>
00022 <span class="comment">// ~ - separator between text blocks</span>
00023 <span class="comment">//</span>
00024 <span class="comment">//--------------------------------------------------------//</span>
00025 
00026 <span class="comment">//----------- Define static functions --------------//</span>
00027 
00028 <span class="keyword">static</span> <span class="keywordtype">int</span> sort_translate_table( <span class="keyword">const</span> <span class="keywordtype">void</span> *a, <span class="keyword">const</span> <span class="keywordtype">void</span> *b );
00029 
00030 <span class="comment">//--------- Begin of function Translate:Translate --------//</span>
00031 
<a name="l00032"></a><a class="code" href="classTranslate.html#a0">00032</a> <a class="code" href="classTranslate.html#a0">Translate::Translate</a>() {
00033     memset( <span class="keyword">this</span>, 0, <span class="keyword">sizeof</span>(<span class="keyword">this</span>) );
00034 }
00035 
00036 <span class="comment">//---------- End of function Translate::Translate --------//</span>
00037 
00038 <span class="comment">//--------- Begin of function Translate:init --------//</span>
00039 
<a name="l00040"></a><a class="code" href="classTranslate.html#a2">00040</a> <span class="keywordtype">void</span> <a class="code" href="classTranslate.html#a2">Translate::init</a>() {
00041     <span class="comment">//---- read the whole file into the buf --------//</span>
00042 
00043     <span class="keywordflow">if</span>( !m.is_file_exist(<a class="code" href="OTRANSL_8CPP.html#a0">TRANSLATE_FILE_NAME</a>) )
00044         <span class="keywordflow">return</span>;
00045 
00046     <a class="code" href="classFile.html">File</a> fileTranslate;
00047 
00048     fileTranslate.<a class="code" href="classFile.html#a2">file_open</a>(<a class="code" href="OTRANSL_8CPP.html#a0">TRANSLATE_FILE_NAME</a>);
00049 
00050     <span class="keywordtype">int</span> textBufSize=fileTranslate.<a class="code" href="classFile.html#a6">file_size</a>();
00051 
00052     translate_text_buf = <a class="code" href="ALL_8H.html#a5">mem_add</a>(textBufSize);
00053 
00054     fileTranslate.<a class="code" href="classFile.html#a9">file_read</a>(translate_text_buf, textBufSize);
00055 
00056     fileTranslate.<a class="code" href="classFile.html#a5">file_close</a>();
00057 
00058     <span class="comment">//----- count the no. of records ----------//</span>
00059 
00060     <span class="keywordtype">char</span>* textPtr=translate_text_buf;
00061     <span class="keywordtype">int</span>   i;
00062 
00063     <span class="keywordflow">for</span>( i=0, rec_count=0 ; i&lt;textBufSize ; i++, textPtr++ ) {
00064         <span class="keywordflow">if</span>( *textPtr == <span class="charliteral">'|'</span> )
00065             rec_count++;
00066     }
00067 
00068     <span class="comment">//------ allocate the translation table ------//</span>
00069 
00070     translate_table = (<a class="code" href="structTranslateRec.html">TranslateRec</a>*) <a class="code" href="ALL_8H.html#a5">mem_add</a>( <span class="keyword">sizeof</span>(<a class="code" href="structTranslateRec.html">TranslateRec</a>) * rec_count );
00071 
00072     <span class="comment">//---- generate the translation table from the translation text ----//</span>
00073 
00074     <span class="keywordtype">int</span> recNo=1;
00075 
00076     textPtr=translate_text_buf;
00077 
00078     translate_table[recNo-1].<a class="code" href="structTranslateRec.html#m0">from_text_ptr</a> = textPtr;
00079 
00080     <span class="keywordflow">for</span>( i=0 ; i&lt;textBufSize ; i++, textPtr++ ) {
00081         <span class="keywordflow">if</span>( *textPtr == <span class="charliteral">'|'</span> ) {
00082             *textPtr = <a class="code" href="OHELP_8H.html#a0">NULL</a>;                            <span class="comment">// Nullify the sentence</span>
00083             translate_table[recNo-1].<a class="code" href="structTranslateRec.html#m1">to_text_ptr</a> = textPtr+1;
00084         }
00085 
00086         <span class="keywordflow">if</span>( *textPtr == <span class="charliteral">'~'</span> ) {
00087             *textPtr = <a class="code" href="OHELP_8H.html#a0">NULL</a>;                            <span class="comment">// Nullify the sentence</span>
00088 
00089             recNo++;
00090 
00091             <span class="keywordflow">if</span>( recNo&gt;rec_count )                       <span class="comment">// end of the file</span>
00092                 <span class="keywordflow">break</span>;
00093 
00094             <span class="comment">//------- skip to the next line ----------//</span>
00095 
00096             <span class="keywordflow">for</span>( ; *textPtr != <a class="code" href="OFILETXT_8H.html#a2">CHAR_RETURN</a> &amp;&amp; *textPtr != <a class="code" href="OFILETXT_8H.html#a0">CHAR_EOF</a> ; textPtr++ );
00097 
00098             <span class="keywordflow">if</span>( *textPtr == <a class="code" href="OFILETXT_8H.html#a2">CHAR_RETURN</a> )
00099                 textPtr++;
00100 
00101             <span class="keywordflow">if</span>( *textPtr == <a class="code" href="OFILETXT_8H.html#a3">CHAR_LINE_FEED</a> )
00102                 textPtr++;
00103 
00104             translate_table[recNo-1].<a class="code" href="structTranslateRec.html#m0">from_text_ptr</a> = textPtr;
00105         }
00106     }
00107 
00108     <span class="comment">//-------- sort the translation table ----------//</span>
00109 
00110     qsort( translate_table, rec_count, <span class="keyword">sizeof</span>(<a class="code" href="structTranslateRec.html">TranslateRec</a>), sort_translate_table );
00111 
00112     <span class="comment">//-------- create the quick_seek_table ----------//</span>
00113 
00114     memset( quick_seek_table, 0, <span class="keyword">sizeof</span>(quick_seek_table) );
00115 
00116     <span class="keywordtype">int</span> lastSeekChar=0;
00117 
00118     <span class="keywordflow">for</span>( i=0 ; i&lt;rec_count ; i++ ) {
00119         <span class="keywordflow">if</span>( translate_table[i].<a class="code" href="structTranslateRec.html#m0">from_text_ptr</a>[0] &gt; lastSeekChar ) {
00120             lastSeekChar = translate_table[i].<a class="code" href="structTranslateRec.html#m0">from_text_ptr</a>[0];
00121             quick_seek_table[lastSeekChar] = i+1;
00122         }
00123     }
00124 
00125     <span class="comment">//----------- set init_flag ------------//</span>
00126 
00127     init_flag=1;
00128 }
00129 
00130 <span class="comment">//---------- End of function Translate::init --------//</span>
00131 
00132 <span class="comment">//--------- Begin of function Translate:deinit --------//</span>
00133 
<a name="l00134"></a><a class="code" href="classTranslate.html#a3">00134</a> <span class="keywordtype">void</span> <a class="code" href="classTranslate.html#a3">Translate::deinit</a>() {
00135     <span class="keywordflow">if</span>( translate_text_buf ) {
00136         <a class="code" href="ALL_8H.html#a8">mem_del</a>( translate_text_buf );
00137         translate_text_buf = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00138     }
00139 
00140     <span class="keywordflow">if</span>( translate_table ) {
00141         <a class="code" href="ALL_8H.html#a8">mem_del</a>( translate_table );
00142         translate_table = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00143     }
00144 }
00145 
00146 <span class="comment">//---------- End of function Translate::deinit --------//</span>
00147 
00148 <span class="comment">//--------- Begin of function Translate:process --------//</span>
<a name="l00157"></a><a class="code" href="classTranslate.html#a4">00157</a> <span class="comment">char* Translate::process(char* originalText) {</span>
00158     <span class="keywordflow">if</span>( !init_flag )
00159         <span class="keywordflow">return</span> originalText;
00160 
00161     <span class="comment">//------ look up the quick_seek_table --------//</span>
00162 
00163     <span class="keywordtype">int</span> tableRecno = quick_seek_table[ *((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)originalText) ];
00164 
00165     <span class="keywordflow">if</span>( !tableRecno )                               <span class="comment">// not in the translation table</span>
00166         <span class="keywordflow">return</span> originalText;
00167 
00168     <span class="keywordtype">int</span> i;
00169 
00170     <span class="keywordflow">for</span>( i=tableRecno ; i&lt;=rec_count ; i++ ) {
00171         <span class="keywordflow">if</span>( strcmp(translate_table[i-1].from_text_ptr, originalText)==0 )
00172             <span class="keywordflow">return</span> translate_table[i-1].to_text_ptr;
00173         <span class="keywordflow">else</span> {
00174             <span class="comment">// all original text begins with this letter has been scanned and none has been found</span>
00175             <span class="keywordflow">if</span>( translate_table[i-1].from_text_ptr[0] != originalText[0] )
00176                 <span class="keywordflow">break</span>;
00177         }
00178     }
00179 
00180     <span class="keywordflow">return</span> originalText;
00181 }
00182 
00183 <span class="comment">//---------- End of function Translate::process --------//</span>
00184 
00185 <span class="comment">//------ Begin of function sort_translate_table ------//</span>
00187 <span class="comment">static int sort_translate_table( const void *a, const void *b ) {</span>
00188     <span class="keywordflow">return</span> strcmp( ((<a class="code" href="structTranslateRec.html">TranslateRec</a>*)a)-&gt;from_text_ptr, ((<a class="code" href="structTranslateRec.html">TranslateRec</a>*)b)-&gt;from_text_ptr );
00189 }
00190 
00191 <span class="comment">//------- End of function sort_translate_table ------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:31 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
