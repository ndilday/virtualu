<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OMOUSECR.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>OMOUSECR.CPP</h1><a href="OMOUSECR_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OMOUSECR.CPP</span>
00002 <span class="comment">//Description : Object Cursor Resource</span>
00003 
00004 <span class="preprocessor">#include &lt;<a class="code" href="OMOUSECR_8H.html">OMOUSECR.H</a>&gt;</span>
00005 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00006 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00007 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00008 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="ODB_8H.html">ODB.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;OMOUSE.H&gt;</span>
00011 <span class="preprocessor">#include &lt;OWORLDMT.H&gt;</span>
00012 <span class="preprocessor">#include &lt;<a class="code" href="OBLOB2W_8H.html">OBLOB2W.H</a>&gt;</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="OBOX_8H.html">OBOX.H</a>&gt;</span>
00014 
00015 <span class="comment">//---------- define constant ------------//</span>
00016 
<a name="l00017"></a><a class="code" href="OMOUSECR_8CPP.html#a0">00017</a> <span class="preprocessor">#define CURSOR_DBF    DIR_RES"CURSOR.RES"</span>
00018 <span class="preprocessor"></span>
00019 <span class="comment">//---------- Begin of function MouseCursor::MouseCursor --------//</span>
00020 
<a name="l00021"></a><a class="code" href="classMouseCursor.html#a0">00021</a> <a class="code" href="classMouseCursor.html#a0">MouseCursor::MouseCursor</a>() {
00022     memset( <span class="keyword">this</span>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classMouseCursor.html">MouseCursor</a>) );
00023 }
00024 
00025 <span class="comment">//----------- End of function MouseCursor::MouseCursor ------//</span>
00026 
00027 <span class="comment">//---------- Begin of function MouseCursor::~MouseCursor --------//</span>
00028 
<a name="l00029"></a><a class="code" href="classMouseCursor.html#a1">00029</a> <a class="code" href="classMouseCursor.html#a1">MouseCursor::~MouseCursor</a>() {
00030     <a class="code" href="classMouseCursor.html#a3">deinit</a>();
00031 }
00032 
00033 <span class="comment">//----------- End of function MouseCursor::~MouseCursor ------//</span>
00034 
00035 <span class="comment">//---------- Begin of function MouseCursor::init --------//</span>
<a name="l00037"></a><a class="code" href="classMouseCursor.html#a2">00037</a> <span class="comment">void MouseCursor::init() {</span>
00038     <span class="comment">//----- open plant material bitmap resource file -------//</span>
00039 
00040     <a class="code" href="classString.html">String</a> str;
00041 
00042     str  = <a class="code" href="Gamedef_8h.html#a4">DIR_RES</a>;
00043     str += <span class="stringliteral">"I_CURSOR.RES"</span>;
00044 
00045     res_bitmap.init_imported(str,1);                <span class="comment">// 1-read all into buffer</span>
00046 
00047     <span class="comment">//------- load database information --------//</span>
00048 
00049     load_cursor_info();
00050 
00051     <span class="comment">// ------ init save_scr, save_back_scr, merge_buf -------//</span>
00052 
00053     save_scr = <span class="keyword">new</span> <a class="code" href="classBlob2DW.html">Blob2DW</a>;
00054     save_back_scr = <span class="keyword">new</span> <a class="code" href="classBlob2DW.html">Blob2DW</a>;
00055     merge_buf = <span class="keyword">new</span> <a class="code" href="classBlob2DW.html">Blob2DW</a>;
00056 
00057     init_flag=1;
00058 }
00059 
00060 <span class="comment">//----------- End of function MouseCursor::init ------//</span>
00061 
00062 <span class="comment">//---------- Begin of function MouseCursor::deinit --------//</span>
00063 
<a name="l00064"></a><a class="code" href="classMouseCursor.html#a3">00064</a> <span class="keywordtype">void</span> <a class="code" href="classMouseCursor.html#a3">MouseCursor::deinit</a>() {
00065     <span class="keywordflow">if</span>( init_flag ) {
00066         <a class="code" href="ALL_8H.html#a8">mem_del</a>(cursor_info_array);
00067 
00068         <span class="keywordflow">if</span>( save_scr ) {
00069             <span class="keyword">delete</span> <a class="code" href="classMouseCursor.html#m21">save_scr</a>;
00070             <a class="code" href="classMouseCursor.html#m21">save_scr</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00071         }
00072 
00073         <span class="keywordflow">if</span>( save_back_scr ) {
00074             <span class="keyword">delete</span> <a class="code" href="classMouseCursor.html#m22">save_back_scr</a>;
00075             <a class="code" href="classMouseCursor.html#m22">save_back_scr</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00076         }
00077 
00078         <span class="keywordflow">if</span>( merge_buf ) {                             <span class="comment">// buffer for merging save screen from the front and back buffers</span>
00079             <span class="keyword">delete</span> <a class="code" href="classMouseCursor.html#m23">merge_buf</a>;
00080             <a class="code" href="classMouseCursor.html#m23">merge_buf</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00081         }
00082 
00083         <a class="code" href="classMouseCursor.html#m0">init_flag</a> = 0;
00084         <a class="code" href="classMouseCursor.html#m19">icon_ptr</a>  = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00085         <span class="comment">// ###### begin Gilbert 18/8 #####//</span>
00086         <a class="code" href="classMouseCursor.html#m3">cur_icon</a> = 0;
00087         <span class="comment">// ###### end Gilbert 18/8 #####//</span>
00088     }
00089 }
00090 
00091 <span class="comment">//----------- End of function MouseCursor::deinit ------//</span>
00092 
00093 <span class="comment">//------- Begin of function MouseCursor::load_cursor_info -------//</span>
00095 <span class="comment">void MouseCursor::load_cursor_info() {</span>
00096     <a class="code" href="structCursorRec.html">CursorRec</a>     *cursorRec;
00097     <a class="code" href="structCursorInfo.html">CursorInfo</a>     *cursorInfo;
00098     <span class="keywordtype">int</span>         i;
00099     <span class="keywordtype">long</span>        bitmapOffset;
00100     <a class="code" href="classDatabase.html">Database</a>    dbCursor(<a class="code" href="OMOUSECR_8CPP.html#a0">CURSOR_DBF</a>, 1);            <span class="comment">// 1-read all into the buffer</span>
00101 
00102     cursor_count = (short) dbCursor.<a class="code" href="classDatabase.html#a7">rec_count</a>();
00103     cursor_info_array = (<a class="code" href="structCursorInfo.html">CursorInfo</a>*) <a class="code" href="ALL_8H.html#a5">mem_add</a>( <span class="keyword">sizeof</span>(<a class="code" href="structCursorInfo.html">CursorInfo</a>)*cursor_count );
00104 
00105     <span class="comment">//-------- read in PLANTBMP.DBF -------//</span>
00106 
00107     memset( cursor_info_array, 0, <span class="keyword">sizeof</span>(<a class="code" href="structCursorInfo.html">CursorInfo</a>) * cursor_count );
00108 
00109     <span class="keywordflow">for</span>( i=0 ; i&lt;cursor_count ; i++ ) {
00110         cursorRec  = (<a class="code" href="structCursorRec.html">CursorRec</a>*) dbCursor.<a class="code" href="classDatabase.html#a4">read</a>(i+1);
00111         cursorInfo = cursor_info_array+i;
00112 
00113         memcpy( &amp;bitmapOffset, cursorRec-&gt;<a class="code" href="structCursorRec.html#m3">bitmap_ptr</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>) );
00114 
00115         cursorInfo-&gt;<a class="code" href="structCursorInfo.html#m2">bitmap_ptr</a> = res_bitmap.read_imported(bitmapOffset);
00116 
00117         cursorInfo-&gt;<a class="code" href="structCursorInfo.html#m0">hot_spot_x</a> = m.atoi( cursorRec-&gt;<a class="code" href="structCursorRec.html#m1">hot_spot_x</a>, cursorRec-&gt;<a class="code" href="structCursorRec.html#s3s0">HOT_SPOT_LEN</a> );
00118         cursorInfo-&gt;<a class="code" href="structCursorInfo.html#m1">hot_spot_y</a> = m.atoi( cursorRec-&gt;<a class="code" href="structCursorRec.html#m2">hot_spot_y</a>, cursorRec-&gt;<a class="code" href="structCursorRec.html#s3s0">HOT_SPOT_LEN</a> );
00119     }
00120 }
00121 
00122 <span class="comment">//--------- End of function MouseCursor::load_cursor_info ---------//</span>
00123 
00124 <span class="comment">//--------- Begin of function MouseCursor::set_icon ------------//</span>
<a name="l00130"></a><a class="code" href="classMouseCursor.html#a4">00130</a> <span class="comment">void MouseCursor::set_icon(int cursorId) {</span>
00131     <span class="keywordflow">if</span>(box.progress_val&gt;0)
00132         <span class="keywordflow">if</span>(info.prerun_year==1) {
00133             cursorId=<a class="code" href="OMOUSECR_8H.html#a6a5">CURSOR_WAITING</a>;
00134         }
00135 
00136     <span class="keywordflow">if</span>( !init_flag )
00137         <span class="keywordflow">return</span>;
00138 
00139     <span class="comment">//-------- hide the cursor first ----------//</span>
00140 
00141     <span class="keywordtype">int</span> hideAllFlag = hide_all_flag;
00142 
00143     <span class="keywordflow">if</span>( !hideAllFlag )                              <span class="comment">// if the mouse has been hiden before, don't hide and show it</span>
00144         mouse.hide();
00145 
00146     <span class="comment">//------------ set cursor icon ------------//</span>
00147 
00148     <a class="code" href="structCursorInfo.html">CursorInfo</a>* cursorInfo = cursor_info_array+cursorId-1;
00149 
00150     icon_ptr   = cursorInfo-&gt;<a class="code" href="structCursorInfo.html#m2">bitmap_ptr</a>;
00151     hot_spot_x = cursorInfo-&gt;<a class="code" href="structCursorInfo.html#m0">hot_spot_x</a>;
00152     hot_spot_y = cursorInfo-&gt;<a class="code" href="structCursorInfo.html#m1">hot_spot_y</a>;
00153 
00154     <a class="code" href="ALL_8H.html#a0">err_when</a>( !icon_ptr );
00155 
00156     icon_width  = *((<span class="keywordtype">short</span>*)icon_ptr);
00157     icon_height = *((<span class="keywordtype">short</span>*)icon_ptr+1);
00158 
00159     <span class="comment">// ###### begin Gilbert 18/8 #####//</span>
00160     cur_icon = cursorId;
00161     <span class="comment">// ###### end Gilbert 18/8 #####//</span>
00162 
00163     <span class="comment">//------- allocate buffer for screen saving ------//</span>
00164 
00165     save_scr-&gt;clear();
00166     save_scr-&gt;resize( 0, 0, icon_width, icon_height );
00167     save_back_scr-&gt;clear();
00168     save_back_scr-&gt;resize(0, 0, icon_width, icon_height);
00169     merge_buf-&gt;clear();
00170     merge_buf-&gt;resize(0, 0, icon_width,icon_height);
00171 
00172     <span class="comment">//------------ redisplay cursor -----------//</span>
00173 
00174     <span class="keywordflow">if</span>( !hideAllFlag ) {
00175         <span class="keywordflow">if</span>( vga_front.dd_buf ) {
00176             mouse.show();
00177             sys.blt_virtual_buf();
00178         }
00179     }
00180 }
00181 
00182 <span class="comment">//----------- End of function MouseCursor::set_icon -------------//</span>
00183 
00184 <span class="comment">//----------- Begin of function MouseCursor::set_frame --------//</span>
<a name="l00191"></a><a class="code" href="classMouseCursor.html#a5">00191</a> <span class="comment">void MouseCursor::set_frame(char frameFlag, char buildTrack) {</span>
00192     <span class="keywordflow">if</span>( frame_flag == frameFlag )
00193         <span class="keywordflow">return</span>;
00194 
00195     frame_flag  = frameFlag;
00196     frame_shown = 0;
00197 }
00198 
00199 <span class="comment">//----------- End of function MouseCursor::set_frame -------//</span>
00200 
00201 <span class="comment">//----------- Begin of function MouseCursor::set_frame_border --------//</span>
00202 
<a name="l00203"></a><a class="code" href="classMouseCursor.html#a6">00203</a> <span class="keywordtype">void</span> <a class="code" href="classMouseCursor.html#a6">MouseCursor::set_frame_border</a>(<span class="keywordtype">int</span> borderX1, <span class="keywordtype">int</span> borderY1, <span class="keywordtype">int</span> borderX2, <span class="keywordtype">int</span> borderY2) {
00204     <a class="code" href="classMouseCursor.html#m32">frame_border_x1</a> = borderX1;
00205     <a class="code" href="classMouseCursor.html#m33">frame_border_y1</a> = borderY1;
00206     <a class="code" href="classMouseCursor.html#m34">frame_border_x2</a> = borderX2;
00207     <a class="code" href="classMouseCursor.html#m35">frame_border_y2</a> = borderY2;
00208 }
00209 
00210 <span class="comment">//----------- End of function MouseCursor::set_frame_border -------//</span>
00211 
00212 <span class="comment">//----------- Begin of function MouseCursor::process --------//</span>
00213 
<a name="l00214"></a><a class="code" href="classMouseCursor.html#a7">00214</a> <span class="keywordtype">void</span> <a class="code" href="classMouseCursor.html#a7">MouseCursor::process</a>(<span class="keywordtype">int</span> curX, <span class="keywordtype">int</span> curY) {
00215     <span class="keywordflow">if</span>( <a class="code" href="classMouseCursor.html#m17">processing_flag</a> || !<a class="code" href="classMouseCursor.html#m19">icon_ptr</a>)               <span class="comment">// it is being nested call by interrupt</span>
00216         <span class="keywordflow">return</span>;                                       <span class="comment">// when another instance of process is</span>
00217     <span class="comment">// being run.</span>
00218     <span class="keywordflow">if</span>( !vga_front.dd_buf )
00219         <span class="keywordflow">return</span>;
00220 
00221     <a class="code" href="classMouseCursor.html#m17">processing_flag</a> = 1;                            <span class="comment">// Prevent nested call</span>
00222 
00223     <span class="comment">//---------- store screen area ------------//</span>
00224 
00225     <span class="keywordflow">if</span>( cursor_shown )                              <span class="comment">// restore screen</span>
00226         vga_front.put_bitmapW( max(<a class="code" href="classMouseCursor.html#m8">cur_x1</a>,0), max(<a class="code" href="classMouseCursor.html#m9">cur_y1</a>,0), <a class="code" href="classMouseCursor.html#m21">save_scr</a>-&gt;<a class="code" href="classBlob2DW.html#a7">bitmap_ptr</a>() );
00227 
00228     <span class="comment">//Kevin ::0909 restore the stored area to back buffer</span>
00230 <span class="comment"></span>
00231     <span class="comment">//---- only the zoom map can be framed, limit the frame inside that area ----//</span>
00232 
00233     <span class="keywordflow">if</span>( frame_flag ) {
00234         curX = max(curX, <a class="code" href="Oworldmt_8h.html#a12">ZOOM_X1</a>);
00235         curY = max(curY, <a class="code" href="Oworldmt_8h.html#a13">ZOOM_Y1</a>);
00236         curX = min(curX, <a class="code" href="Oworldmt_8h.html#a14">ZOOM_X2</a>);
00237         curY = min(curY, <a class="code" href="Oworldmt_8h.html#a15">ZOOM_Y2</a>);
00238 
00239         process_frame(curX, curY);
00240     }
00241 
00242     <span class="comment">//------- update cursor postions ----------//</span>
00243 
00244     <a class="code" href="classMouseCursor.html#m8">cur_x1</a> = curX - <a class="code" href="classMouseCursor.html#m12">hot_spot_x</a>;                     <span class="comment">// handle the offset of the hot site</span>
00245     <a class="code" href="classMouseCursor.html#m9">cur_y1</a> = curY - <a class="code" href="classMouseCursor.html#m13">hot_spot_y</a>;
00246     <a class="code" href="classMouseCursor.html#m10">cur_x2</a> = <a class="code" href="classMouseCursor.html#m8">cur_x1</a> + <a class="code" href="classMouseCursor.html#m14">icon_width</a>  - 1;
00247     <a class="code" href="classMouseCursor.html#m11">cur_y2</a> = <a class="code" href="classMouseCursor.html#m9">cur_y1</a> + <a class="code" href="classMouseCursor.html#m15">icon_height</a> - 1;
00248 
00249     <span class="comment">//------- save screen and put cursor -------//</span>
00250 
00251     <span class="keywordflow">if</span>( <a class="code" href="classMouseCursor.html#m1">hide_all_flag</a> || ( <a class="code" href="classMouseCursor.html#m2">hide_area_flag</a> &amp;&amp;
00252                            is_touch( <a class="code" href="classMouseCursor.html#m4">hide_x1</a>, <a class="code" href="classMouseCursor.html#m5">hide_y1</a>, <a class="code" href="classMouseCursor.html#m6">hide_x2</a>, <a class="code" href="classMouseCursor.html#m7">hide_y2</a> ) ) ) {
00253         <a class="code" href="classMouseCursor.html#m16">cursor_shown</a> = 0;
00254     }
00255     <span class="keywordflow">else</span> {
00256         <span class="comment">//---- if the cursor is across the screen border -----//</span>
00257 
00258         <span class="keywordflow">if</span>( cur_x1 &lt; 0 || cur_x2 &gt;= <a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a> || cur_y1 &lt; 0 || cur_y2 &gt;= <a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a> ) {
00259             vga_front.read_bitmapW( max(<a class="code" href="classMouseCursor.html#m8">cur_x1</a>,0), max(<a class="code" href="classMouseCursor.html#m9">cur_y1</a>,0),
00260                                     min(<a class="code" href="classMouseCursor.html#m10">cur_x2</a>,<a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a>-1), min(<a class="code" href="classMouseCursor.html#m11">cur_y2</a>,<a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a>-1), <a class="code" href="classMouseCursor.html#m21">save_scr</a>-&gt;<a class="code" href="classBlob2DW.html#a7">bitmap_ptr</a>() );
00261 
00262             vga_front.put_bitmap_area_trans( <a class="code" href="classMouseCursor.html#m8">cur_x1</a>, <a class="code" href="classMouseCursor.html#m9">cur_y1</a>, <a class="code" href="classMouseCursor.html#m19">icon_ptr</a>,
00263                                              max(0,<a class="code" href="classMouseCursor.html#m8">cur_x1</a>)-<a class="code" href="classMouseCursor.html#m8">cur_x1</a>, max(0,<a class="code" href="classMouseCursor.html#m9">cur_y1</a>)-<a class="code" href="classMouseCursor.html#m9">cur_y1</a>,
00264                                              min(<a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a>-1,<a class="code" href="classMouseCursor.html#m10">cur_x2</a>)-<a class="code" href="classMouseCursor.html#m8">cur_x1</a>, min(<a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a>-1,<a class="code" href="classMouseCursor.html#m11">cur_y2</a>)-<a class="code" href="classMouseCursor.html#m9">cur_y1</a> );
00265         }
00266         <span class="keywordflow">else</span> {                                        <span class="comment">//----- if the whole cursor is on the screen -----//</span>
00267             vga_front.read_bitmapW( <a class="code" href="classMouseCursor.html#m8">cur_x1</a>, <a class="code" href="classMouseCursor.html#m9">cur_y1</a>, <a class="code" href="classMouseCursor.html#m10">cur_x2</a>, <a class="code" href="classMouseCursor.html#m11">cur_y2</a>, <a class="code" href="classMouseCursor.html#m21">save_scr</a>-&gt;<a class="code" href="classBlob2DW.html#a7">bitmap_ptr</a>() );
00268             <span class="comment">// must use PutIcon instead of PutArea for background masking</span>
00269             vga_front.put_bitmap_trans( <a class="code" href="classMouseCursor.html#m8">cur_x1</a>, <a class="code" href="classMouseCursor.html#m9">cur_y1</a>, <a class="code" href="classMouseCursor.html#m19">icon_ptr</a> );
00270         }
00271 
00272         <a class="code" href="classMouseCursor.html#m16">cursor_shown</a> = 1;
00273     }
00274 
00275     <span class="comment">//------------------------------------------//</span>
00276 
00277     <a class="code" href="classMouseCursor.html#m17">processing_flag</a> = 0;                            <span class="comment">// cancel prevention of nested call</span>
00278 }
00279 
00280 <span class="comment">//----------- End of function MouseCursor::process -------//</span>
00281 
00282 <span class="comment">//-------- Begin of function MouseCursor::process_frame --------//</span>
00283 
00284 <span class="keywordtype">void</span> MouseCursor::process_frame(<span class="keywordtype">int</span> curX, <span class="keywordtype">int</span> curY) {
00285     <span class="comment">//---- restore the screen area overwritten by the last frame ---//</span>
00286 
00287     <span class="keywordflow">if</span>( frame_shown ) {
00288         vga_front.put_bitmapW( <a class="code" href="classMouseCursor.html#m26">frame_x1</a>, <a class="code" href="classMouseCursor.html#m27">frame_y1</a>, <a class="code" href="classMouseCursor.html#m36">frame_top_save_scr</a>    );
00289         vga_front.put_bitmapW( <a class="code" href="classMouseCursor.html#m26">frame_x1</a>, <a class="code" href="classMouseCursor.html#m29">frame_y2</a>, <a class="code" href="classMouseCursor.html#m37">frame_bottom_save_scr</a> );
00290         vga_front.put_bitmapW( <a class="code" href="classMouseCursor.html#m26">frame_x1</a>, <a class="code" href="classMouseCursor.html#m27">frame_y1</a>, <a class="code" href="classMouseCursor.html#m38">frame_left_save_scr</a>   );
00291         vga_front.put_bitmapW( <a class="code" href="classMouseCursor.html#m28">frame_x2</a>, <a class="code" href="classMouseCursor.html#m27">frame_y1</a>, <a class="code" href="classMouseCursor.html#m39">frame_right_save_scr</a>  );
00292     }
00293 
00294     <span class="comment">//---------- update frame position ----------//</span>
00295 
00296     <span class="keywordflow">if</span>( !<a class="code" href="classMouseCursor.html#m25">frame_shown</a> ) {                            <span class="comment">// a new frame</span>
00297         <a class="code" href="classMouseCursor.html#m30">frame_origin_x</a> = curX;
00298         <a class="code" href="classMouseCursor.html#m31">frame_origin_y</a> = curY;
00299 
00300         <a class="code" href="classMouseCursor.html#m26">frame_x1</a> = curX;
00301         <a class="code" href="classMouseCursor.html#m27">frame_y1</a> = curY;
00302         <a class="code" href="classMouseCursor.html#m28">frame_x2</a> = curX;
00303         <a class="code" href="classMouseCursor.html#m29">frame_y2</a> = curY;
00304     }
00305     <span class="keywordflow">else</span> {                                          <span class="comment">// update the postion of the existing frame</span>
00306         <span class="comment">//---------- update frame position ----------//</span>
00307 
00308         <span class="keywordflow">if</span>( curX &gt; <a class="code" href="classMouseCursor.html#m30">frame_origin_x</a> ) {
00309             <span class="keywordflow">if</span>( curY &gt; <a class="code" href="classMouseCursor.html#m31">frame_origin_y</a> ) {               <span class="comment">// stretching towards the lower right end</span>
00310                 <a class="code" href="classMouseCursor.html#m26">frame_x1</a> = <a class="code" href="classMouseCursor.html#m30">frame_origin_x</a>;
00311                 <a class="code" href="classMouseCursor.html#m27">frame_y1</a> = <a class="code" href="classMouseCursor.html#m31">frame_origin_y</a>;
00312                 <a class="code" href="classMouseCursor.html#m28">frame_x2</a> = curX;
00313                 <a class="code" href="classMouseCursor.html#m29">frame_y2</a> = curY;
00314             }
00315             <span class="keywordflow">else</span> {                                      <span class="comment">// stretching towards the upper right end</span>
00316                 <a class="code" href="classMouseCursor.html#m26">frame_x1</a> = <a class="code" href="classMouseCursor.html#m30">frame_origin_x</a>;
00317                 <a class="code" href="classMouseCursor.html#m27">frame_y1</a> = curY;
00318                 <a class="code" href="classMouseCursor.html#m28">frame_x2</a> = curX;
00319                 <a class="code" href="classMouseCursor.html#m29">frame_y2</a> = <a class="code" href="classMouseCursor.html#m31">frame_origin_y</a>;
00320             }
00321         }
00322         <span class="keywordflow">else</span> {
00323             <span class="keywordflow">if</span>( curY &gt; <a class="code" href="classMouseCursor.html#m31">frame_origin_y</a> ) {               <span class="comment">// stretching towards the lower left end</span>
00324                 <a class="code" href="classMouseCursor.html#m26">frame_x1</a> = curX;
00325                 <a class="code" href="classMouseCursor.html#m27">frame_y1</a> = <a class="code" href="classMouseCursor.html#m31">frame_origin_y</a>;
00326                 <a class="code" href="classMouseCursor.html#m28">frame_x2</a> =  <a class="code" href="classMouseCursor.html#m30">frame_origin_x</a>;
00327                 <a class="code" href="classMouseCursor.html#m29">frame_y2</a> = curY;
00328             }
00329             <span class="keywordflow">else</span> {                                      <span class="comment">// stretching towards the upper left end</span>
00330                 <a class="code" href="classMouseCursor.html#m26">frame_x1</a> = curX;
00331                 <a class="code" href="classMouseCursor.html#m27">frame_y1</a> = curY;
00332                 <a class="code" href="classMouseCursor.html#m28">frame_x2</a> = <a class="code" href="classMouseCursor.html#m30">frame_origin_x</a>;
00333                 <a class="code" href="classMouseCursor.html#m29">frame_y2</a> = <a class="code" href="classMouseCursor.html#m31">frame_origin_y</a>;
00334             }
00335         }
00336     }
00337 
00338     <span class="comment">//------- save the screen area and display the frame ------//</span>
00339 
00340     disp_frame(&amp;vga_front);
00341 }
00342 
00343 <span class="comment">//----------- End of function MouseCursor::process_frame -------//</span>
00344 
00345 <span class="comment">//----------- Begin of function MouseCursor::disp_frame --------//</span>
00346 
00347 <span class="keywordtype">void</span> MouseCursor::disp_frame(<a class="code" href="classVgaBuf.html">VgaBuf</a>* vgaBufPtr) {
00348     <span class="comment">//------- save the screen area that will be overwriteen -------//</span>
00349 
00350     vgaBufPtr-&gt;<a class="code" href="classVgaBuf.html#a83">read_bitmapW</a>( <a class="code" href="classMouseCursor.html#m26">frame_x1</a>, <a class="code" href="classMouseCursor.html#m27">frame_y1</a>, <a class="code" href="classMouseCursor.html#m28">frame_x2</a>, <a class="code" href="classMouseCursor.html#m27">frame_y1</a>, <a class="code" href="classMouseCursor.html#m36">frame_top_save_scr</a> );
00351     vgaBufPtr-&gt;<a class="code" href="classVgaBuf.html#a83">read_bitmapW</a>( <a class="code" href="classMouseCursor.html#m26">frame_x1</a>, <a class="code" href="classMouseCursor.html#m29">frame_y2</a>, <a class="code" href="classMouseCursor.html#m28">frame_x2</a>, <a class="code" href="classMouseCursor.html#m29">frame_y2</a>, <a class="code" href="classMouseCursor.html#m37">frame_bottom_save_scr</a> );
00352     vgaBufPtr-&gt;<a class="code" href="classVgaBuf.html#a83">read_bitmapW</a>( <a class="code" href="classMouseCursor.html#m26">frame_x1</a>, <a class="code" href="classMouseCursor.html#m27">frame_y1</a>, <a class="code" href="classMouseCursor.html#m26">frame_x1</a>, <a class="code" href="classMouseCursor.html#m29">frame_y2</a>, <a class="code" href="classMouseCursor.html#m38">frame_left_save_scr</a> );
00353     vgaBufPtr-&gt;<a class="code" href="classVgaBuf.html#a83">read_bitmapW</a>( <a class="code" href="classMouseCursor.html#m28">frame_x2</a>, <a class="code" href="classMouseCursor.html#m27">frame_y1</a>, <a class="code" href="classMouseCursor.html#m28">frame_x2</a>, <a class="code" href="classMouseCursor.html#m29">frame_y2</a>, <a class="code" href="classMouseCursor.html#m39">frame_right_save_scr</a> );
00354 
00355     <span class="comment">//---------- draw the rectagular frame now -----------//</span>
00356 
00357     vgaBufPtr-&gt;<a class="code" href="classVgaBuf.html#a39">rect</a>( <a class="code" href="classMouseCursor.html#m26">frame_x1</a>, <a class="code" href="classMouseCursor.html#m27">frame_y1</a>, <a class="code" href="classMouseCursor.html#m28">frame_x2</a>, <a class="code" href="classMouseCursor.html#m29">frame_y2</a>, 1, <a class="code" href="COLOR_8H.html#a28">OWN_SELECT_FRAME_COLOR</a> );
00358 
00359     <span class="comment">//---------- set frame flag ----------//</span>
00360 
00361     <a class="code" href="classMouseCursor.html#m25">frame_shown</a> = 1;
00362 }
00363 
00364 <span class="comment">//----------- End of function MouseCursor::disp_frame -------//</span>
00365 
00366 <span class="comment">//----------- Begin of function MouseCursor::disp_back_buf --------//</span>
<a name="l00370"></a><a class="code" href="classMouseCursor.html#a8">00370</a> <span class="comment">void MouseCursor::disp_back_buf(int bltX1, int bltY1, int bltX2, int bltY2) {</span>
00371     <span class="keywordflow">if</span>( !icon_ptr )
00372         <span class="keywordflow">return</span>;
00373 
00374     <span class="comment">//-------- display frame on the back buffer ----//</span>
00375 
00376     <span class="keywordflow">if</span>( frame_flag )
00377         disp_frame(&amp;vga_back);
00378 
00379     <span class="comment">//----- display mouse cursor on the back buffer ----//</span>
00380 
00381     <span class="keywordflow">if</span>( is_touch(bltX1, bltY1, bltX2, bltY2) ) {
00382         <span class="comment">//--- save the back buffer area which will be overwritten ---//</span>
00383 
00384         <span class="keywordtype">int</span> x1 = max(cur_x1,bltX1);
00385         <span class="keywordtype">int</span> y1 = max(cur_y1,bltY1);
00386         <span class="keywordtype">int</span> x2 = min(cur_x2,bltX2);
00387         <span class="keywordtype">int</span> y2 = min(cur_y2,bltY2);
00388 
00389         vga_back.read_bitmapW( x1, y1, x2, y2, save_back_scr-&gt;bitmap_ptr() );
00390 
00391         <span class="comment">//--- merge the save area of the back buf with the front buf's save area ---//</span>
00392 
00393         <span class="comment">// save_scr width  : min(cur_x2,VGA_WIDTH-1) -max(cur_x1,0)+1;</span>
00394         <span class="comment">// save_scr height : min(cur_y2,VGA_HEIGHT-1)-max(cur_y1,0)+1;</span>
00395 
00396         <span class="comment">// IMGbltW( save_scr-&gt;buf_ptr(), min(cur_x2,VGA_WIDTH-1) -max(cur_x1,0)+1, x1-max(cur_x1,0), y1-max(cur_y1,0), save_back_scr-&gt;bitmap_ptr() );           // +4 is the width &amp; height info</span>
00397         <span class="comment">// +4 is the width &amp; height info</span>
00398         <a class="code" href="IMGFUN_8H.html#a23">IMGbltW</a>( save_scr-&gt;buf_ptr(), <span class="keyword">sizeof</span>(short) * (min(cur_x2,<a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a>-1) -max(cur_x1,0)+1), x1-max(cur_x1,0), y1-max(cur_y1,0), save_back_scr-&gt;bitmap_ptr() );
00399 
00400         <span class="comment">//--------- display the mouse cursor now -----------//</span>
00401 
00402         <span class="keywordflow">if</span>( cur_x1 &lt; bltX1 || cur_x2 &gt; bltX2 || cur_y1 &lt; bltY1 || cur_y2 &gt; bltY2 ) {
00403             vga_back.put_bitmap_area_trans( cur_x1, cur_y1, icon_ptr,
00404                                             max(bltX1,cur_x1)-cur_x1, max(bltY1,cur_y1)-cur_y1,
00405                                             min(bltX2,cur_x2)-cur_x1, min(bltY2,cur_y2)-cur_y1 );
00406         }
00407 
00408         <span class="comment">//---- the whole sprite is inside the view area ------//</span>
00409 
00410         <span class="keywordflow">else</span> {
00411             vga_back.put_bitmap_trans(cur_x1, cur_y1, icon_ptr);
00412         }
00413 
00414         cursor_shown = 1;
00415     }
00416 }
00417 
00418 <span class="comment">//----------- End of function MouseCursor::disp_back_buf -------//</span>
00419 
00420 <span class="comment">//--------- Begin of function MouseCursor::is_touch ------------//</span>
00426 <span class="comment">int MouseCursor::is_touch(int x1, int y1, int x2, int y2) {</span>
00427     <span class="keywordflow">return</span> (( cur_y1 &lt;=  y1 &amp;&amp; cur_y2 &gt;=  y1 ) ||
00428             (  y1 &lt;= cur_y1 &amp;&amp;  y2 &gt;= cur_y1 )) &amp;&amp;
00429         (( cur_x1 &lt;=  x1 &amp;&amp; cur_x2 &gt;=  x1 ) ||
00430          (  x1 &lt;= cur_x1 &amp;&amp;  x2 &gt;= cur_x1 ));
00431 }
00432 
00433 <span class="comment">//--------- End of function MouseCursor::is_touch -----------//</span>
00434 
00435 <span class="comment">// ####### begin Gilbert 18/8 ########//</span>
00436 <span class="comment">//--------- Begin of function MouseCursor::restore_icon ------------//</span>
<a name="l00437"></a><a class="code" href="classMouseCursor.html#a10">00437</a> <span class="keywordtype">void</span> <a class="code" href="classMouseCursor.html#a10">MouseCursor::restore_icon</a>(<span class="keywordtype">int</span> newCursorId) {
00438     <span class="keywordflow">if</span>(box.progress_val&gt;0)
00439         <span class="keywordflow">if</span>(info.prerun_year==1) {
00440             newCursorId=<a class="code" href="OMOUSECR_8H.html#a6a5">CURSOR_WAITING</a>;
00441         }
00442 
00443     <span class="keywordflow">if</span>( newCursorId == 0) {
00444         <a class="code" href="ALL_8H.html#a1">err_here</a>();
00445 
00446         <span class="comment">// should restore to invisible cursor ?</span>
00447         <span class="keywordflow">if</span>( !<a class="code" href="classMouseCursor.html#m1">hide_all_flag</a> )
00448             mouse.hide();
00449         <a class="code" href="classMouseCursor.html#m3">cur_icon</a> = 0;
00450         <a class="code" href="classMouseCursor.html#m19">icon_ptr</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00451     }
00452     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="classMouseCursor.html#m3">cur_icon</a> == 0 || newCursorId != <a class="code" href="classMouseCursor.html#m3">cur_icon</a> ) {
00453         <a class="code" href="classMouseCursor.html#a4">set_icon</a>(newCursorId);
00454     }
00455 }
00456 
00457 <span class="comment">//--------- End of function MouseCursor::restore_icon ------------//</span>
00458 <span class="comment">// ####### end Gilbert 18/8 ########//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:07 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
