<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Ogfile.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Ogfile.cpp</h1><a href="Ogfile_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OGFILE.CPP</span>
00002 <span class="comment">//Description : Object Game file, save game and restore game</span>
00003 
00004 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00005 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00006 <span class="preprocessor">#include &lt;time.h&gt;</span>
00007 
00008 <span class="preprocessor">#include &lt;<a class="code" href="OBOX_8H.html">OBOX.H</a>&gt;</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="OSTR_8H.html">OSTR.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="ODATE_8H.html">ODATE.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;<a class="code" href="OMOUSECR_8H.html">OMOUSECR.H</a>&gt;</span>
00012 <span class="preprocessor">#include &lt;<a class="code" href="OWORLD_8H.html">OWORLD.H</a>&gt;</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="OPOWER_8H.html">OPOWER.H</a>&gt;</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="OGAME_8H.html">OGAME.H</a>&gt;</span>
00015 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00016 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00017 <span class="preprocessor">#include &lt;OAUDIO.H&gt;</span>
00018 <span class="preprocessor">#include &lt;<a class="code" href="OMUSIC_8H.html">OMUSIC.H</a>&gt;</span>
00019 
00020 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>
00021 
00022 <span class="preprocessor">#include &lt;OGFILE.H&gt;</span>
00023 
00024 <span class="comment">//-------- Begin of function GameFile::save_game --------//</span>
<a name="l00029"></a><a class="code" href="classGameFile.html#a1">00029</a> <span class="comment">int GameFile::save_game(char* fileName) {</span>
00030     <a class="code" href="classFile.html">File</a>   file;
00031     <a class="code" href="classString.html">String</a> errStr;
00032 
00033     <span class="comment">//### begin zb 02/25/99</span>
00034     game_speed=sys.save_speed;
00035     <span class="comment">//### end zb 02/25/99</span>
00036 
00037     power.win_opened=1;                             <span class="comment">// to disable power.mouse_handler()</span>
00038 
00039     <span class="keywordflow">if</span>( fileName )
00040         strcpy( file_name, fileName );
00041 
00042     <span class="keywordtype">int</span> rc = 1;
00043     <span class="keywordtype">char</span> lowDiskSpaceFlag = 0;
00044     DWORD sectorPerCluster = 0;
00045     DWORD bytePerSector = 0;
00046     DWORD freeCluster = 0;
00047     DWORD totalCluster = 0;
00048     <span class="keywordflow">if</span>( GetDiskFreeSpace( <a class="code" href="OHELP_8H.html#a0">NULL</a>,                     <span class="comment">// address of root path, NULL means the current root directory</span>
00049                           &amp;sectorPerCluster, &amp;bytePerSector, &amp;freeCluster, &amp;totalCluster)) {
00050         DWORD freeSpace = DWORD( (<span class="keywordtype">double</span>)freeCluster * sectorPerCluster * bytePerSector / 1024.0);
00051 
00052         <span class="keywordflow">if</span>( m.is_file_exist(file_name) ) {
00053             <span class="comment">// if overwritting existing file, count the file size of the existing file</span>
00054             file.<a class="code" href="classFile.html#a2">file_open</a>(file_name);
00055             freeSpace += file.<a class="code" href="classFile.html#a6">file_size</a>() / 1024;       <span class="comment">// count the existing space</span>
00056             file.<a class="code" href="classFile.html#a5">file_close</a>();
00057         }
00058         <span class="keywordflow">if</span>( !(rc = freeSpace &gt;= <a class="code" href="Ogfile_8h.html#a0">MIN_FREE_SPACE</a>) ) {
00059             errStr = <span class="stringliteral">"Insufficient disk space ! The game is not saved."</span>;
00060             lowDiskSpaceFlag = 1;
00061         }
00062     }
00063 
00064     <span class="keywordflow">if</span>( rc ) {
00065         rc = file.<a class="code" href="classFile.html#a3">file_create</a>( file_name, 0, 1 );     <span class="comment">// 0=tell File don't handle error itself</span>
00066         <span class="comment">// 1=allow the writing size and the read size to be different</span>
00067         <span class="keywordflow">if</span>( !rc )
00068             errStr = <span class="stringliteral">"Error creating saved game file."</span>;
00069     }
00070 
00071     <span class="keywordflow">if</span>( rc ) {
00072         save_process();                               <span class="comment">// process game data before saving the game</span>
00073 
00074         rc = write_game_header(&amp;file);                <span class="comment">// write saved game header information</span>
00075 
00076         <span class="keywordflow">if</span>( !rc )
00077             errStr = <span class="stringliteral">"Error creating saved game header."</span>;
00078 
00079         <span class="keywordflow">if</span>( rc ) {
00080             rc = write_file(&amp;file);                     <span class="comment">// write game data</span>
00081 
00082             <span class="keywordflow">if</span>( !rc )
00083                 errStr = <span class="stringliteral">"Error writing saved game data."</span>;
00084         }
00085     }
00086 
00087     file.<a class="code" href="classFile.html#a5">file_close</a>();
00088 
00089     power.win_opened=0;
00090 
00091     <span class="comment">//------- when saving error ---------//</span>
00092 
00093     <span class="keywordflow">if</span>( !rc ) {
00094         <span class="keywordflow">if</span>( !lowDiskSpaceFlag )
00095             remove( file_name );                        <span class="comment">// delete the file as it is not complete</span>
00096 
00097 <span class="preprocessor">#ifndef DEBUG</span>
00098 <span class="preprocessor"></span>        <span class="comment">// use this message for all types of error message in the release version</span>
00099         errStr = <span class="stringliteral">"Insufficient disk space ! The game is not saved."</span>;
00100 <span class="preprocessor">#endif</span>
00101 <span class="preprocessor"></span>
00102         box.msg( errStr );
00103     }
00104 
00105     <span class="keywordflow">return</span> rc;
00106 }
00107 
00108 <span class="comment">//--------- End of function GameFile::save_game --------//</span>
00109 
00110 <span class="comment">//-------- Begin of function GameFile::load_game --------//</span>
<a name="l00116"></a><a class="code" href="classGameFile.html#a2">00116</a> <span class="comment">int GameFile::load_game(char* fileName) {</span>
00117     <a class="code" href="classFile.html">File</a> file;
00118     <span class="keywordtype">int</span>  rc=0;
00119     <span class="keywordtype">char</span> *errMsg = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00120 
00121     power.win_opened=1;                             <span class="comment">// to disable power.mouse_handler()</span>
00122 
00123     <span class="keywordtype">int</span> oldCursor = mouse_cursor.get_icon();
00124     mouse_cursor.set_icon( <a class="code" href="OMOUSECR_8H.html#a6a5">CURSOR_WAITING</a> );
00125 
00126     <span class="keywordtype">int</span> powerEnableFlag = power.enable_flag;
00127 
00128     <span class="keywordflow">if</span>( fileName )
00129         strcpy( file_name, fileName );
00130 
00131     rc = 1;
00132     <span class="keywordflow">if</span>( !file.<a class="code" href="classFile.html#a2">file_open</a>( file_name, 0, 1 ) ) {      <span class="comment">// 0=tell File don't handle error itself</span>
00133         rc = 0;
00134         errMsg = <span class="stringliteral">"Cannot open save game file"</span>;
00135     }
00136 
00137     <span class="comment">//-------- read in the GameFile class --------//</span>
00138 
00139     <span class="keywordflow">if</span>( rc ) {
00140         <span class="keywordtype">char</span> gameFileName[MAX_PATH+1];
00141 
00142         strcpy( gameFileName, file_name );            <span class="comment">// save the file name actually read, in case that the file names are different</span>
00143 
00144         <span class="comment">// read_file_header: read the whole object from the saved game file</span>
00145         <span class="keywordflow">if</span>( !file.<a class="code" href="classFile.html#a9">file_read</a>(<span class="keyword">this</span>, <span class="keyword">sizeof</span>(<a class="code" href="classGameFile.html">GameFile</a>)) ) {
00146             rc = 0;
00147             errMsg = <span class="stringliteral">"Cannot read file header"</span>;
00148         }
00149 
00150         <span class="keywordflow">if</span>( rc ) {
00151             <a class="code" href="ALL_8H.html#a2">err_if</a> ( file.<a class="code" href="classFile.html#a11">file_get_short</a>() != 0x99 )    <span class="comment">// the end of header</span>
00152                 <a class="code" href="ALL_8H.html#a1">err_here</a>();
00153 
00154             <span class="keywordflow">if</span>( !validate_header() ) {
00155                 rc = 0;
00156                 errMsg = <span class="stringliteral">"Save game incompatible"</span>;
00157             }
00158             <span class="keywordflow">else</span>
00159                 strcpy( file_name, gameFileName );
00160         }
00161     }
00162 
00163     <span class="comment">//--------------------------------------------//</span>
00164     <span class="comment">// 1=allow the writing size and the read size to be different</span>
00165     <span class="keywordflow">if</span>( rc ) {
00166         player_school.school_type = school_type;
00167 
00168         game.deinit(1);                               <span class="comment">// deinit last game first, 1-it is called during loading of a game</span>
00169         game.init(1);                                 <span class="comment">// init game</span>
00170 
00171         <span class="comment">//-------- read in saved game ----------//</span>
00172 
00173         <span class="keywordflow">if</span>( !read_file(&amp;file) ) {
00174             rc = -1;
00175             errMsg = <span class="stringliteral">"Load game error"</span>;
00176         }
00177 
00178         <span class="keywordflow">if</span>( rc != -1 )
00179             load_process();                             <span class="comment">// process game data after loading the game</span>
00180     }
00181 
00182     file.<a class="code" href="classFile.html#a5">file_close</a>();
00183 
00184     power.enable_flag = powerEnableFlag;
00185 
00186     mouse_cursor.restore_icon( oldCursor );
00187 
00188     power.win_opened=0;
00189 
00190     <span class="comment">//---------------------------------------//</span>
00191 
00192     <span class="keywordflow">switch</span>(rc) {                                    <span class="comment">// don't display msg if loaded successfully (rc==1)</span>
00193     <span class="keywordflow">case</span> 0:
00194     <span class="keywordflow">case</span> -1:
00195         box.msg( errMsg );
00196         <span class="keywordflow">break</span>;
00197     }
00198 
00199     last_read_success_flag = rc;                    <span class="comment">// for external functions to read.</span>
00200 
00201     sys.save_speed=game_speed;
00202 
00203     <span class="comment">//-------- set music volume ---------//</span>
00204 
00205     <span class="keywordflow">if</span>( config.cd_music_volume ) {
00206         <span class="keywordflow">if</span>( music.is_playing() ) {
00207             music.change_volume(config.cd_music_volume);
00208         }
00209     }
00210     <span class="keywordflow">else</span>
00211         music.stop();
00212 
00213     <span class="keywordflow">return</span> rc;
00214 }
00215 
00216 <span class="comment">//--------- End of function GameFile::load_game --------//</span>
00217 
00218 <span class="comment">//------- Begin of function GameFile::set_file_name -------//</span>
<a name="l00225"></a><a class="code" href="classGameFile.html#a5">00225</a> <span class="comment">void GameFile::set_file_name() {</span>
00226     <span class="keyword">enum</span> {                                          <span class="comment">// Maximum 4 characters in name prefix, e.g. "ENLIG" for "Enlight Enterprise"</span>
00227         NAME_PREFIX_LEN = 4,
00228         NAME_NUMBER_LEN = 3
00229     };
00230 
00231     <a class="code" href="classString.html">String</a> str, str2;
00232     <span class="keywordtype">int</span>    i;
00233     <span class="keywordtype">char</span>   nameChar;
00234     <span class="keywordtype">char</span>*  baseName=<span class="stringliteral">"cc"</span>;                           <span class="comment">// player_school.player_last_name // the long name which the file name is based on</span>
00235     <span class="keywordtype">char</span>   addStr[] = <span class="stringliteral">"0"</span>;                          <span class="comment">// as a small string for adding to the large string</span>
00236 
00237     <span class="comment">//baseName = (~nation_array)-&gt;king_name();</span>
00238 
00239     <span class="comment">//--------- add the group name prfix ----------//</span>
00240 
00241     <span class="keywordflow">for</span>( i=0 ; i&lt;(int) strlen(baseName) &amp;&amp; (int) str.<a class="code" href="classString.html#a5">len</a>() &lt; NAME_PREFIX_LEN ; i++ ) {
00242         nameChar = m.upper(baseName[i]);
00243 
00244         <span class="keywordflow">if</span>( ( nameChar &gt;= <span class="charliteral">'A'</span> &amp;&amp; nameChar &lt;= <span class="charliteral">'Z'</span> ) ||
00245             ( nameChar &gt;= <span class="charliteral">'0'</span> &amp;&amp; nameChar &lt;= <span class="charliteral">'9'</span> ) ) {
00246             addStr[0] = nameChar;
00247 
00248             str += addStr;
00249         }
00250     }
00251 
00252     <span class="comment">//----- add tailing characters if prefix len &lt; NAME_PREFIX_LEN+1 ---//</span>
00253 
00254     <span class="keywordflow">while</span>( str.<a class="code" href="classString.html#a5">len</a>() &lt; NAME_PREFIX_LEN+1 )          <span class="comment">// +1 is the "_" between the name and the number</span>
00255         str += <span class="stringliteral">"_"</span>;
00256 
00257     <span class="comment">//---- find the saved game number for this saved game ----//</span>
00258 
00259     <span class="keywordtype">int</span>       curNumber, lastNumber=0;
00260     <a class="code" href="classGameFile.html">GameFile</a>* gameFile;
00261 
00262     <span class="keywordflow">for</span>( i=1 ; i&lt;=game_file_array.size() ; i++ ) {
00263         gameFile = game_file_array[i];
00264 
00265         <span class="comment">// ##### begin Gilbert 3/10 ########//</span>
00266         <span class="comment">// if( memcmp(gameFile-&gt;file_name, str, NAME_PREFIX_LEN)==0 )</span>
00267         <span class="keywordflow">if</span>( strnicmp(gameFile-&gt;<a class="code" href="classGameFile.html#m1">file_name</a>, str, NAME_PREFIX_LEN)==0 ) {
00268             <span class="comment">// ##### end Gilbert 3/10 ########//</span>
00269             <span class="comment">//------------------------------------------------//</span>
00270             <span class="comment">//</span>
00271             <span class="comment">// if there is a free number in the middle of the list</span>
00272             <span class="comment">// (left by being deleted game), use this number.</span>
00273             <span class="comment">//</span>
00274             <span class="comment">//------------------------------------------------//</span>
00275 
00276             <span class="comment">// +1 is to pass the "_" between the name and the number</span>
00277             curNumber = atoi( gameFile-&gt;<a class="code" href="classGameFile.html#m1">file_name</a>+NAME_PREFIX_LEN+1 );
00278 
00279             <span class="keywordflow">if</span>( curNumber &gt; lastNumber+1 )              <span class="comment">// normally, curNumber should be lastNumber+1</span>
00280                 <span class="keywordflow">break</span>;
00281 
00282             lastNumber = curNumber;
00283         }
00284     }
00285 
00286     <span class="comment">//------- add saved game number after the prefix --------//</span>
00287 
00288     str2 = lastNumber+1;                            <span class="comment">// use the next number after the last number</span>
00289 
00290     <span class="keywordflow">for</span>( i=NAME_NUMBER_LEN-str2.<a class="code" href="classString.html#a5">len</a>() ; i&gt;0 ; i-- ) <span class="comment">// add "0" before the number if the len of the number &lt; NAME_NUMBER_LEN</span>
00291         str += <span class="stringliteral">"0"</span>;
00292 
00293     str += str2;
00294     str += <span class="stringliteral">".SAV"</span>;
00295 
00296     <span class="comment">//----- copy the string to file_name ------//</span>
00297 
00298     strncpy( file_name, str, MAX_PATH );
00299 
00300     file_name[MAX_PATH] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00301 }
00302 
00303 <span class="comment">//--------- End of function GameFile::set_file_name -------//</span>
00304 
00305 <span class="comment">//-------- Begin of function GameFile::save_process -------//</span>
00311 <span class="comment">void GameFile::save_process() {</span>
00312     <span class="comment">//--------- set the total playing time --------//</span>
00313 
00314     info.total_play_time += m.get_time()-info.start_play_time;
00315 
00316     info.start_play_time  = m.get_time();
00317 }
00318 
00319 <span class="comment">//--------- End of function GameFile::save_process -------//</span>
00320 
00321 <span class="comment">//-------- Begin of function GameFile::load_process -------//</span>
00327 <span class="comment">void GameFile::load_process() {</span>
00328     info.start_play_time = m.get_time();            <span class="comment">// the time player start playing the game</span>
00329 
00330     <span class="comment">//-- if the player is in the diplomatic message screen, rebuild the talk choice list --//</span>
00331 
00332     <span class="comment">//if( sys.view_mode==MODE_NATION &amp;&amp; info.nation_report_mode==NATION_REPORT_TALK )</span>
00333     <span class="comment">//  talk_res.set_talk_choices();</span>
00334 
00335     mouse_cursor.set_frame(0);                      <span class="comment">// to fix a frame bug with loading game</span>
00336 
00337     <span class="comment">// reflect the effect of config.music_flag, config.wav_music_volume</span>
00338 }
00339 
00340 <span class="comment">//--------- End of function GameFile::load_process -------//</span>
00341 
00342 <span class="comment">//------- Begin of function GameFile::write_game_header -------//</span>
00349 <span class="comment">int GameFile::write_game_header(File* filePtr) {</span>
00350     class_size = <span class="keyword">sizeof</span>(GameFile);
00351 
00352     strncpy( player_name, player_school.player_last_name, <a class="code" href="classPlayerSchool.html#s3s2">PlayerSchool::LAST_NAME_LEN</a>);
00353     player_name[PLAYER_NAME_LEN] = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00354 
00355     <a class="code" href="ALL_8H.html#a0">err_when</a>(PLAYER_NAME_LEN &lt; <a class="code" href="classPlayerSchool.html#s3s2">PlayerSchool::LAST_NAME_LEN</a>);
00356 
00357     game_date = info.game_date;
00358 
00359     <span class="comment">//-----//</span>
00360 
00361     school_type = player_school.school_type;
00362 
00363     <span class="comment">//----- set the file date ------//</span>
00364 
00365     CoFileTimeNow(&amp;file_date);
00366 
00367     <span class="comment">//------- write GameFile to the saved game file -------//</span>
00368 
00369     <span class="comment">// write the whole object to the saved game file</span>
00370     <span class="keywordflow">if</span> ( !filePtr-&gt;file_write( <span class="keyword">this</span>, <span class="keyword">sizeof</span>(<a class="code" href="classGameFile.html">GameFile</a>) ) )
00371         <span class="keywordflow">return</span> 0;
00372 
00373     <span class="keywordflow">return</span> filePtr-&gt;file_put_short(0x99);           <span class="comment">// the end of header</span>
00374 }
00375 
00376 <span class="comment">//--------- End of function GameFile::write_game_header -------//</span>
00377 
00378 <span class="comment">//--------- Begin of function GameFile::validate_header -------//</span>
<a name="l00379"></a><a class="code" href="classGameFile.html#a6">00379</a> <span class="keywordtype">int</span> <a class="code" href="classGameFile.html#a6">GameFile::validate_header</a>() {
00380     <span class="keywordflow">return</span> <a class="code" href="classGameFile.html#m0">class_size</a> == <span class="keyword">sizeof</span>(GameFile);
00381 }
00382 
00383 <span class="comment">//--------- End of function GameFile::validate_header -------//</span>
00384 
00385 <span class="comment">//--------- Begin of function GameFile::get_save_name -------//</span>
<a name="l00387"></a><a class="code" href="classGameFile.html#a0">00387</a> <span class="comment">char* GameFile::get_save_name() {</span>
00388     <a class="code" href="classString.html">String</a> str(file_name);
00389 
00390 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00391 <span class="preprocessor"></span>    <span class="comment">// it is numeric extension, display full filename</span>
00392     <span class="keywordtype">int</span> len = strlen(file_name);
00393     <span class="keywordflow">if</span>( len &gt; 4 &amp;&amp; file_name[len-4] == <span class="charliteral">'.'</span>
00394         &amp;&amp; file_name[len-3] &gt;= <span class="charliteral">'0'</span> &amp;&amp; file_name[len-3] &lt;= <span class="charliteral">'9'</span>
00395         &amp;&amp; file_name[len-2] &gt;= <span class="charliteral">'0'</span> &amp;&amp; file_name[len-2] &lt;= <span class="charliteral">'9'</span>
00396         &amp;&amp; file_name[len-1] &gt;= <span class="charliteral">'0'</span> &amp;&amp; file_name[len-1] &lt;= <span class="charliteral">'9'</span> ) {
00397         <span class="keywordflow">return</span> file_name;
00398     }
00399 <span class="preprocessor">#endif</span>
00400 <span class="preprocessor"></span>
00401     <span class="keywordflow">return</span> str.<a class="code" href="classString.html#a8">left</a>(strlen(file_name)-4);
00402 }
00403 
00404 <span class="comment">//--------- End of function GameFile::get_save_name -------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:46 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
