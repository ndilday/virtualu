<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Ofinance.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Ofinance.cpp</h1><a href="Ofinance_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OFINANCE.CPP</span>
00002 <span class="comment">//Description : School class</span>
00003 <span class="comment">//Owner       : Fred</span>
00004 
00005 <span class="preprocessor">#include &lt;OMATH.H&gt;</span>
00006 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="OGAMESET_8H.html">OGAMESET.H</a>&gt;</span>
00008 
00009 <span class="preprocessor">#include &lt;<a class="code" href="OSCHLRES_8H.html">OSCHLRES.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="OPEERSCH_8H.html">OPEERSCH.H</a>&gt;</span>                             <span class="comment">// for init_data</span>
00011 <span class="preprocessor">#include &lt;OSTUDENT.H&gt;</span>                             <span class="comment">// MAX_STUDENT_LEVEL</span>
00012 <span class="preprocessor">#include &lt;ODEPT.H&gt;</span>                                <span class="comment">// facutly_count</span>
00013 <span class="preprocessor">#include &lt;OCHANCE.H&gt;</span>
00014 
00015 <span class="comment">// CU header file</span>
00016 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>
00017 <span class="preprocessor">#include &lt;OINVEST.H&gt;</span>
00018 <span class="preprocessor">#include &lt;OATHLETI.H&gt;</span>
00019 <span class="preprocessor">#include &lt;OFACILIT.H&gt;</span>
00020 <span class="preprocessor">#include &lt;ODEVELOP.H&gt;</span>                             <span class="comment">//990608</span>
00021 <span class="preprocessor">#include &lt;OOPT.H&gt;</span>
00022 
00023 <span class="preprocessor">#include &lt;OLinAlg.h&gt;</span>                              <span class="comment">// for its quadratic_prog() and class Matrix</span>
00024 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#include &lt;OQUADPRG.H&gt;</span>
00026 <span class="preprocessor">#endif</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#include &lt;OFINANCE.H&gt;</span>
00028 <span class="preprocessor">#include &lt;OCHANCE.H&gt;</span>                              <span class="comment">//## chea 230699</span>
00029 
00030 <span class="preprocessor">#include &lt;<a class="code" href="OSTUOFF_8H.html">OSTUOFF.H</a>&gt;</span>
00031 <span class="preprocessor">#include &lt;OLIBTECH.H&gt;</span>
00032 
00033 <span class="preprocessor">#ifdef DEBUG</span>
00034 <span class="preprocessor"></span><span class="comment">//#define _DEBUG_STAGE1</span>
00035 <span class="comment">//#define _DEBUG_STAGE2</span>
00036 <span class="preprocessor">#endif</span>
00037 <span class="preprocessor"></span>
<a name="l00038"></a><a class="code" href="Ofinance_8cpp.html#a0">00038</a> <span class="preprocessor">#define DEBUG_VC</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#ifdef DEBUG_VC</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#include &lt;STDIO.H&gt;</span>                                <span class="comment">//temp for debug matrix</span>
00041 <span class="preprocessor">#endif</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="OLOG_8H.html">OLOG.H</a>&gt;</span>                                 <span class="comment">// for debug matrix</span>
00043 
00044 <span class="comment">// --------- "Input from elsewhere in the model" --------- //</span>
00045 <span class="comment">//TO make these all to member variables or macro</span>
00046 
00047 <span class="comment">/*</span>
00048 <span class="comment">X       faculty_ftes = 320;</span>
00049 <span class="comment">  avg_faculty_compensation = $268</span>
00050 <span class="comment">  Indirect cost rate    50.0%</span>
00051 <span class="comment">  spons_research_for_AY_fac_sals = 20;</span>
00052 <span class="comment">  percent_of_sponsored_research_for_other_salaries = 40.00;</span>
00053 <span class="comment"></span>
00054 <span class="comment">X       tuition_rate = 18260;</span>
00055 <span class="comment">X       Room and board rate     $6,583</span>
00056 <span class="comment">X       Real growth of room &amp; board rate        0.00%</span>
00057 <span class="comment">  New building construction     $0</span>
00058 <span class="comment">New debt        $20,000</span>
00059 <span class="comment">*/</span>
00060 <span class="comment">//const int     faculty_ftes = 230;                                     // for stage2</span>
00061 <span class="comment">//const int     avg_faculty_compensation = 268; // for stage2; from resalloc.ex file: "This is an unrealisticly large number, caused by an inconsistency between the financial data used for testing this partof the model and the assumed bumber of faculty. Setting initial conditions from the game's database should take care of the problem."</span>
<a name="l00062"></a><a class="code" href="Ofinance_8cpp.html#a2">00062</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="Ofinance_8cpp.html#a2">percent_spons_research_for_AY_fac</a> = 20; <span class="comment">// c61</span>
00063 <span class="comment">// c62; for buget_report</span>
<a name="l00064"></a><a class="code" href="Ofinance_8cpp.html#a3">00064</a> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="Ofinance_8cpp.html#a3">percent_of_sponsored_research_for_other_salaries</a> = 40.00;
00065 
00066 <span class="comment">// constants for buget_revenue/expense</span>
00067 <span class="comment">//const int     library_acqs = 3780;</span>
00068 <span class="comment">//const int     utilities_expense       = 3285;</span>
00069 
00070 <span class="comment">//---------- Begin of static function prt_vector -----------//</span>
00071 <span class="keyword">static</span> <span class="keywordtype">void</span> print_vector(<span class="keyword">const</span> ColumnVector &amp;xNames) {
00072 <span class="preprocessor">#ifdef DEBUG_VC</span>
00073 <span class="preprocessor"></span>    <span class="keywordtype">char</span> s[300];
00074     sprintf(s, <span class="stringliteral">"%f, %f, %f, %f, %f, %f, %f, %f, %f"</span>,
00075             xNames(1),xNames(2),xNames(3),
00076             xNames(4),xNames(5),xNames(6),
00077             xNames(7),xNames(8),xNames(9));
00078     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(s);
00079 <span class="preprocessor">#endif</span>
00080 <span class="preprocessor"></span>}
00081 
00082 <span class="keyword">static</span> <span class="keywordtype">void</span> print_vector2(<span class="keyword">const</span> ColumnVector &amp;xNames) {
00083 <span class="preprocessor">#ifdef DEBUG_VC</span>
00084 <span class="preprocessor"></span>    <span class="keywordtype">int</span> count = xNames.Storage();
00085     <span class="keywordtype">char</span> t[30];
00086 
00087     <a class="code" href="classString.html">String</a> s = <span class="stringliteral">"-&gt; "</span>;
00088     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i&lt;=count; i++ ) {
00089         sprintf(t, <span class="stringliteral">"%.3f, "</span>, xNames(i));
00090         s+= t;
00091     }
00092     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(s);
00093 <span class="preprocessor">#endif</span>
00094 <span class="preprocessor"></span>}
00095 
00096 <span class="comment">//---------- Begin of static function prt_vector -----------//</span>
00097 
00098 <span class="comment">//---------- Begin of function FinancePolicy::bound_correction -----------//</span>
<a name="l00099"></a><a class="code" href="structFinancePolicy.html#a1">00099</a> <span class="keywordtype">void</span> <a class="code" href="structFinancePolicy.html#a1">FinancePolicy::bound_correction</a>() {
00100     <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="structFinancePolicy.html#m7">lower_limit</a> &gt; <a class="code" href="structFinancePolicy.html#m8">upper_limit</a>);
00101 
00102     <span class="keywordflow">if</span> (<a class="code" href="structFinancePolicy.html#m1">lower_bound</a> &gt; <a class="code" href="structFinancePolicy.html#m2">upper_bound</a>)
00103         <a class="code" href="structFinancePolicy.html#m1">lower_bound</a> = <a class="code" href="structFinancePolicy.html#m2">upper_bound</a>;
00104 
00105     <a class="code" href="structFinancePolicy.html#m1">lower_bound</a> = min(<a class="code" href="structFinancePolicy.html#m8">upper_limit</a>, max(<a class="code" href="structFinancePolicy.html#m1">lower_bound</a>, <a class="code" href="structFinancePolicy.html#m7">lower_limit</a>));
00106     <a class="code" href="structFinancePolicy.html#m2">upper_bound</a> = max(<a class="code" href="structFinancePolicy.html#m7">lower_limit</a>, min(<a class="code" href="structFinancePolicy.html#m2">upper_bound</a>, <a class="code" href="structFinancePolicy.html#m8">upper_limit</a>));
00107 
00108     <a class="code" href="structFinancePolicy.html#m0">target_value</a> = min(<a class="code" href="structFinancePolicy.html#m2">upper_bound</a>, max(<a class="code" href="structFinancePolicy.html#m1">lower_bound</a>, <a class="code" href="structFinancePolicy.html#m0">target_value</a>));
00109     <a class="code" href="structFinancePolicy.html#m5">result_value</a> = min(<a class="code" href="structFinancePolicy.html#m2">upper_bound</a>, max(<a class="code" href="structFinancePolicy.html#m1">lower_bound</a>, <a class="code" href="structFinancePolicy.html#m5">result_value</a>));
00110 }
00111 
00112 <span class="comment">//---------- End of function FinancePolicy::bound_correction -----------//</span>
00113 
00114 <span class="comment">//---------- Begin of function FinancePolicy::constraint_policy -----------//</span>
<a name="l00118"></a><a class="code" href="structFinancePolicy.html#a2">00118</a> <span class="comment">void FinancePolicy::set_constraint_policy(int saveLast) {</span>
00119     <span class="keywordflow">if</span>( saveLast ) {
00120         last_target_value = target_value;
00121         last_upper_bound  = upper_bound;
00122         last_lower_bound  = lower_bound;
00123     }
00124 
00125     lower_bound = min(upper_limit,max(lower_limit, target_value - <a class="code" href="Ofinanc2_8h.html#a3">OPT_MINIMUM_RANGE</a> ));
00126     upper_bound = max(lower_limit, min(upper_limit, target_value + <a class="code" href="Ofinanc2_8h.html#a3">OPT_MINIMUM_RANGE</a> ));
00127 
00128     target_value = min( max(target_value , lower_bound), upper_bound);
00129     bound_correction();                             <span class="comment">// ## 290699  //## chea 310899 try not using all the bound_correction</span>
00130 }
00131 
<a name="l00132"></a><a class="code" href="structFinancePolicy.html#a3">00132</a> <span class="keywordtype">void</span> <a class="code" href="structFinancePolicy.html#a3">FinancePolicy::reset_constraint_policy</a>() {
00133     <a class="code" href="structFinancePolicy.html#m0">target_value</a> = <a class="code" href="structFinancePolicy.html#m9">last_target_value</a>;
00134     <a class="code" href="structFinancePolicy.html#m2">upper_bound</a>  = <a class="code" href="structFinancePolicy.html#m10">last_upper_bound</a>;
00135     <a class="code" href="structFinancePolicy.html#m1">lower_bound</a>  = <a class="code" href="structFinancePolicy.html#m11">last_lower_bound</a>;
00136 
00137     <a class="code" href="structFinancePolicy.html#m0">target_value</a> = min( max(<a class="code" href="structFinancePolicy.html#m0">target_value</a> , <a class="code" href="structFinancePolicy.html#m1">lower_bound</a>), <a class="code" href="structFinancePolicy.html#m2">upper_bound</a>);
00138     <a class="code" href="structFinancePolicy.html#a1">bound_correction</a>();                             <span class="comment">// ## 290699 //## chea 310899 try not using all the bound_correction</span>
00139 }
00140 
00141 <span class="comment">//---------- End of function FinancePolicy::constraint_policy -----------//</span>
00142 
00143 <span class="comment">//---------- Begin of function FinancePolicy::reset_change -----------//</span>
<a name="l00145"></a><a class="code" href="structFinancePolicy.html#a0">00145</a> <span class="comment">void FinancePolicy::reset_change(bool resetAll) {</span>
00146     <span class="comment">//------- restore settings before Consider, Promise or Implement Now ---//</span>
00147 
00148     <span class="keywordflow">if</span> ( applied_flag &gt; <a class="code" href="Ofinanc2_8h.html#a38a5">P_NONE</a> ) {
00149         target_value = last_target_value ;
00150         upper_bound  = last_upper_bound;
00151         lower_bound  = last_lower_bound;
00152         import_weight = last_import_weight;
00153         required_flag = last_required_flag;
00154     }
00155 
00156     applied_flag = <a class="code" href="Ofinanc2_8h.html#a38a5">P_NONE</a>;
00157 
00158     <span class="comment">//-------- reset penality ---------//</span>
00159 
00160     <span class="keywordflow">if</span> ( resetAll ) {
00161         penalty_multiplier1 = 1;
00162         penalty_multiplier2 = 1;
00163     }
00164 }
00165 
00166 <span class="comment">//---------- End of function FinancePolicy::reset_change -----------//</span>
00167 
00168 <span class="comment">//---------- Begin of function FinancePolicy::set_policy_target -----------//</span>
<a name="l00170"></a><a class="code" href="classFinance.html#a32">00170</a> <span class="comment">void Finance::set_policy_target(bool isRevenue, char index) {</span>
00171     <a class="code" href="structFinancePolicy.html">FinancePolicy</a>&amp; policyP = isRevenue ? revenue_policy_array[index] : expense_policy_array[index];
00172 
00173     <span class="keywordtype">double</span> targetArr[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>] = {
00174         1.5, 1.5, 0, ( policyP.<a class="code" href="structFinancePolicy.html#m2">upper_bound</a> + policyP.<a class="code" href="structFinancePolicy.html#m1">lower_bound</a> ) / 2,
00175         1.0, 1.0, 0, 0, 0,
00176     };
00177 
00178     policyP.<a class="code" href="structFinancePolicy.html#m0">target_value</a> = targetArr[isRevenue?index:index+<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>];
00179 }
00180 
00181 <span class="comment">//---------- End of function FinancePolicy::set_policy_target -----------//</span>
00182 
00183 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00184 <span class="preprocessor"></span>
00186 <span class="keyword">struct </span>Revenue_and_Expense {
00187     <span class="keywordtype">double</span> Surplus_Deficit;
00188     <span class="keywordtype">double</span> Tuition_Rate;
00189     <span class="keywordtype">double</span> Revenue_Array[<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>][4];    <span class="comment">// max accessed [5][3] /[][1]=direct, [][2]=indirect, [][3]=total</span>
00190     <span class="keywordtype">double</span> Expense_Array[<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>][4];    <span class="comment">// max accessed [12][3] / [][0]=faculty [][1]=staff [][2]=other [][3]=total</span>
00191 
00192     <span class="keywordtype">double</span> calc_Surplus_Deficit() {
00193         <span class="keywordtype">int</span> i;
00194         Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>][3] = 0.0f;
00195         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>; ++i )
00196             Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>][3] += Revenue_Array[i][3];
00197         Surplus_Deficit = 0.0f;
00198         <span class="keywordflow">for</span>( i = <a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>; i &lt; <a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; ++i )
00199             Surplus_Deficit += Revenue_Array[i][3];
00200         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; ++i )
00201             Surplus_Deficit -= Expense_Array[i][3];
00202         <span class="keywordflow">return</span> Surplus_Deficit;
00203     }
00204 };
00205 
00206 <span class="keyword">static</span> <span class="keywordtype">void</span> Optimize_policy_ver2(
00207 <span class="comment">// output</span>
00208     Revenue_and_Expense &amp;Trial_Budget,
00209     Revenue_and_Expense &amp;Final_Budget,
00210     <span class="comment">// result of stage 1</span>
00211     <span class="keywordtype">float</span> Result_Vector_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>],
00212     <span class="keywordtype">float</span> Result_Vector_S2[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>],   <span class="comment">// result of stage 2</span>
00213 <span class="comment">// input</span>
00214     <span class="keywordtype">int</span> endStage,                                     <span class="comment">// finish in stage 1 or stage 2</span>
00215     <span class="keyword">const</span> Revenue_and_Expense &amp;Base_Budget,           <span class="comment">// Base_Budget is projected actual on 1st Aug</span>
00216     <span class="keyword">const</span> Revenue_and_Expense &amp;Base_Actual,           <span class="comment">// Base_Actual is actual at year end</span>
00217     <span class="comment">// PL_Policy_Array_S1 is slider in stage 1 optimization; [0] is target, [1] is lower bound [2] is upper bound [3] is preference (weight)</span>
00218     <span class="keyword">const</span> <span class="keywordtype">float</span> PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>][4],
00219     <span class="comment">// PL_Policy_Array_S2 is slider in stage 2 optimization; [0] is target, [1] is lower bound [2] is upper bound [3] is preference (weight)</span>
00220     <span class="keyword">const</span> <span class="keywordtype">float</span> PL_Policy_Array_S2[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>][4],
00221 
00222     <span class="keywordtype">double</span> inflation, <span class="keywordtype">double</span> Base_tuition_rate, <span class="keywordtype">double</span> Base_enrollment, <span class="keywordtype">double</span> Target_enrollment,
00223     <span class="keywordtype">double</span> Actual_enrollment, <span class="keywordtype">double</span> Base_endowmentMV, <span class="keywordtype">double</span> Base_OpResBalance, <span class="keywordtype">float</span> ST_int_rate_01Aug,
00224     <span class="keywordtype">float</span> ST_int_rate_31Aug, <span class="keywordtype">double</span> New_Debt_service );
00225 
00226 <span class="keyword">static</span> <span class="keywordtype">void</span> Calc_Budget( Revenue_and_Expense &amp;Budget_Obj, <span class="keywordtype">float</span> *Policy_Vector_S1, <span class="keywordtype">float</span> *Policy_Vector_S2,
00227                          <span class="keyword">const</span> Revenue_and_Expense &amp;Base_Budget,
00228                          <span class="keywordtype">double</span> New_State_approp, <span class="keywordtype">double</span> inflation, <span class="keywordtype">double</span> Base_tuition_rate, <span class="keywordtype">double</span> Target_enrollment,
00229                          <span class="keywordtype">double</span> Base_endowmentMV, <span class="keywordtype">double</span> Base_OpResBalance, <span class="keywordtype">double</span> ST_int_rate_01Aug, <span class="keywordtype">double</span> New_Debt_service );
00230 <span class="keyword">static</span> <span class="keywordtype">void</span> Write_Budget( Revenue_and_Expense &amp;, <span class="keywordtype">int</span>, <span class="keywordtype">int</span> );
00231 <span class="keyword">static</span> <span class="keywordtype">void</span> Calc_Matrices_S1( <span class="keywordtype">double</span> trial_Surplus_Deficit, ColumnVector &amp;c, DiagonalMatrix &amp;Q, <a class="code" href="classMatrix.html">Matrix</a> &amp;A, ColumnVector &amp;b,
00232                               <span class="keyword">const</span> <span class="keywordtype">float</span> PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>][4],
00233                               <span class="keyword">const</span> Revenue_and_Expense &amp;Base_Budget, <span class="keywordtype">double</span> Base_tuition_rate, <span class="keywordtype">double</span> Target_enrollment,
00234                               <span class="keywordtype">double</span> Base_endowmentMV, <span class="keywordtype">double</span> inflation );
00235 <span class="keyword">static</span> <span class="keywordtype">void</span> quadratic_prog( ColumnVector &amp;c, DiagonalMatrix &amp;Q, <a class="code" href="classMatrix.html">Matrix</a> &amp;A, ColumnVector &amp;b, ColumnVector &amp;xNames, <span class="keywordtype">int</span> );
00236 <span class="keyword">static</span> <span class="keywordtype">void</span> Calc_Matrices_S2( <span class="keywordtype">double</span> dollar_Constraint, ColumnVector &amp;c, DiagonalMatrix &amp;Q, <a class="code" href="classMatrix.html">Matrix</a> &amp;A, ColumnVector &amp;b,
00237                               <span class="keyword">const</span> Revenue_and_Expense &amp;Base_Budget,
00238                               <span class="keyword">const</span> <span class="keywordtype">float</span> PL_Policy_Array_S2[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>][4] );
00239 <span class="keyword">static</span> <span class="keywordtype">void</span> Calc_Actual( Revenue_and_Expense &amp;Actual_Obj, <span class="keyword">const</span> Revenue_and_Expense &amp;Budget_Obj,
00240                          <span class="keyword">const</span> Revenue_and_Expense &amp;Base_Actual, <span class="keywordtype">double</span> Actual_fac_salaries_31Aug, <span class="keywordtype">double</span> ST_int_rate_31Aug, <span class="keywordtype">double</span> Actual_enrollment,
00241                          <span class="keywordtype">double</span> Base_OpResBalance );
00242 
00243 <span class="keyword">static</span> <span class="keywordtype">void</span> Optimize_policy_ver2(
00244 <span class="comment">// output</span>
00245     Revenue_and_Expense &amp;Trial_Budget,
00246     Revenue_and_Expense &amp;Final_Budget,
00247     <span class="comment">// result of stage 1</span>
00248     <span class="keywordtype">float</span> Result_Vector_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>],
00249     <span class="keywordtype">float</span> Result_Vector_S2[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>],   <span class="comment">// result of stage 2</span>
00250 
00251 <span class="comment">// input</span>
00252     <span class="keywordtype">int</span> endStage,                                     <span class="comment">// finish in stage 1 or stage 2</span>
00253 
00254     <span class="keyword">const</span> Revenue_and_Expense &amp;Base_Budget,           <span class="comment">// Base_Budget is projected actual on 1st Aug</span>
00255     <span class="keyword">const</span> Revenue_and_Expense &amp;Base_Actual,           <span class="comment">// Base_Actual is actual at year end</span>
00256     <span class="comment">// PL_Policy_Array_S1 is slider in stage 1 optimization; [0] is target, [1] is lower bound [2] is upper bound [3] is preference (weight)</span>
00257     <span class="keyword">const</span> <span class="keywordtype">float</span> PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>][4],
00258     <span class="comment">// PL_Policy_Array_S2 is slider in stage 2 optimization; [0] is target, [1] is lower bound [2] is upper bound [3] is preference (weight)</span>
00259     <span class="keyword">const</span> <span class="keywordtype">float</span> PL_Policy_Array_S2[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>][4],
00260 
00261     <span class="keywordtype">double</span> inflation,
00262     <span class="keywordtype">double</span> Base_tuition_rate,                         <span class="comment">// Tuition rate (eg, 4,000)</span>
00263     <span class="keywordtype">double</span> Base_enrollment,                           <span class="comment">// Total number of students at the start of the year (eg 5,000)</span>
00264     <span class="keywordtype">double</span> Target_enrollment,                         <span class="comment">// Sum of enrollment targets for the coming year + number of doctoral students at start of year (eg,5,200)</span>
00265     <span class="keywordtype">double</span> Actual_enrollment,                         <span class="comment">// Actual number of student enrollments after the admissions process (eg.5,100)</span>
00266     <span class="keywordtype">double</span> Base_endowmentMV,                          <span class="comment">// Endowment plus quasi endowment market value as of August 1; smoothed (eg, 220,000)</span>
00267     <span class="keywordtype">double</span> Base_OpResBalance,                         <span class="comment">// Operating reserve balance as of August 1 (eg, 21,000)</span>
00268     <span class="keywordtype">float</span> ST_int_rate_01Aug,                          <span class="comment">// Short-term interest rate as of August 1</span>
00269     <span class="keywordtype">float</span> ST_int_rate_31Aug,                          <span class="comment">// short-term interest rate as of August 31</span>
00270     <span class="keywordtype">double</span> New_Debt_service                           <span class="comment">// Debt service projected for next year (4,500)</span>
00271     ) {
00272     <span class="keywordtype">int</span> i;
00273     Revenue_and_Expense   S1_Output_Budget, New_Actual;
00274 
00275     <span class="keywordtype">double</span> Real_Budget_Growth_Dollars;
00276     <span class="comment">// state appropriation</span>
00277     <span class="keywordtype">double</span> New_State_approp = Base_Budget.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>][3];
00278     <span class="keywordtype">double</span> Actual_fac_salaries_31Aug = 0.0f;        <span class="comment">// Total salaries of faculty sims, including new hires (assumes player changes hiring slider)</span>
00279     <span class="comment">// in spreadsheet, Bill use the formula :</span>
00280     <span class="comment">// (Sum(i) Base_Budget.Expense_Array[i][0])</span>
00281     <span class="comment">// * (1+ PL_Policy_Array_S1[REVENUE_POLICY_COUNT+PL_FACULTY_SALARY_INCREASES][0]</span>
00282     <span class="comment">//   + PL_Policy_Array_S2[PL_FACULTY_FTE][0] + 0.01 )</span>
00283     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; ++i )
00284         Actual_fac_salaries_31Aug += Base_Budget.Expense_Array[i][0];
00285     Actual_fac_salaries_31Aug *= (1.0 + PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a70">PL_FACULTY_SALARY_INCREASES</a>][0]
00286                                   + PL_Policy_Array_S2[<a class="code" href="Ofinance_8h.html#a112a76">PL_FACULTY_FTE</a>][0] + 0.01 );
00287 
00288     <span class="comment">// Create temporary results vectors to get the stage 1 trial budget</span>
00289     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; ++i )
00290         <span class="comment">// stage 1 allocations equal player input</span>
00291         Result_Vector_S1[i] = PL_Policy_Array_S1[i][0];
00292 
00293     <span class="comment">// Create temporary results vectors to get the stage 1 trial budget</span>
00294     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; ++i )
00295         <span class="comment">// stage 2 allocations all equal the planned real budget growth</span>
00296         Result_Vector_S2[i] = PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a72">PL_BUDGET_ADJUSTMENT</a>][0];
00297 
00298     <span class="comment">// instantiate the trial budget class object; calculate and write the data</span>
00299     <span class="comment">// Set Trial_Budget = New Revenue_and_Expense; // ?</span>
00300     Calc_Budget( Trial_Budget, Result_Vector_S1, Result_Vector_S2,
00301                  Base_Budget, New_State_approp, inflation, Base_tuition_rate, Target_enrollment,
00302                  Base_endowmentMV, Base_OpResBalance, ST_int_rate_01Aug, New_Debt_service );
00303 
00304     <span class="comment">// DEBUG OUTPUT</span>
00305     Write_Budget( Trial_Budget, 76, 3 ); {
00306 
00307         ColumnVector c(<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>);
00308         DiagonalMatrix Q(<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>);
00309         <a class="code" href="classMatrix.html">Matrix</a> A((<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>)*2+2,<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>);
00310         ColumnVector b((<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>)*2+2);
00311 
00312         <span class="comment">// row x column</span>
00313 
00314         ColumnVector xNames(<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>);
00315 
00316         <span class="comment">// Calculate S1 input matrices, do the S1 optimization, and update the S1 result vector</span>
00317         Calc_Matrices_S1( Trial_Budget.Surplus_Deficit, c, Q, A, b,
00318                           PL_Policy_Array_S1, Base_Budget,
00319                           Base_tuition_rate, Target_enrollment, Base_endowmentMV, inflation );
00320 
00321         quadratic_prog( c, Q, A, b, xNames, 100);
00322 
00323         <span class="comment">// Create temporary results vectors to get the Stage 1 output budget</span>
00324         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; ++i ) {
00325             Result_Vector_S1[i] = (float)xNames(i+1);   <span class="comment">// start from xNames(1)</span>
00326         }
00327 
00328         <span class="comment">// get the sum of last constraints</span>
00329         <span class="keywordtype">float</span> cSum = 0.0f;
00330         <span class="keywordflow">for</span>( i = 1; i &lt;= <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; ++i ) {
00331             cSum += xNames(i) * A((<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>)*2+1, i );
00332         }
00333         <span class="comment">// compare with b((REVENUE_POLICY_COUNT+EXPENSE_POLICY_COUNT)*2+2)</span>
00334 
00335         <span class="comment">// calc the value to minimize Qx^2 + cx</span>
00336         <span class="keywordtype">float</span> wSum = 0.0f;
00337         <span class="keywordflow">for</span>( i = 1; i &lt;= <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; ++i ) {
00338             wSum += (Q(i) * xNames(i) + c(i)) * xNames(i);
00339         }
00340 
00341         <span class="comment">// use another method to do optimization</span>
00342 
00343         <span class="keywordtype">double</span> Alt_Result_Vector_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>];
00344         <span class="keywordtype">double</span> lowLimit[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>];
00345         <span class="keywordtype">double</span> highLimit[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>];
00346         <span class="keywordtype">double</span> tolLimit[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>];
00347         <span class="keywordtype">double</span> limitCoeff[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>];
00348         <span class="keywordtype">double</span> limitSum;
00349         <span class="keywordtype">double</span> cost1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>];
00350         <span class="keywordtype">double</span> cost2[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>];
00351         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; ++i ) {
00352             lowLimit[i] = PL_Policy_Array_S1[i][1];
00353             highLimit[i] = PL_Policy_Array_S1[i][2];
00354             tolLimit[i] = 0.0005;                       <span class="comment">// except PL_ENDOWMENT_SPENDING_RATE, PL_INDIRECT_COST_RATE</span>
00355             limitCoeff[i] = A((<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>)*2+1, i+1 );
00356             cost1[i] = c(i+1);
00357             cost2[i] = Q(i+1);
00358         }
00359         limitSum = b((<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>)*2+1);
00360         tolLimit[<a class="code" href="Ofinance_8h.html#a108a67">PL_ENDOWMENT_SPENDING_RATE</a>] = 0.001;
00361         tolLimit[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>] = 0.005;
00362         <span class="comment">// give bigger error tol on surplus/deficit</span>
00363         tolLimit[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a74">PL_SURPLUS_DEFICIT</a>] = 0.001;
00364 
00365         <a class="code" href="classQuadProgramming.html">QuadProgramming</a> quadProg;
00366 
00367         <span class="keywordflow">if</span>( quadProg.<a class="code" href="classQuadProgramming.html#a2">sp_quadratic_programming</a>( <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>,
00368                                                Alt_Result_Vector_S1,
00369                                                lowLimit, highLimit, tolLimit, limitCoeff, limitSum, cost1, cost2 ) ) {
00370             <span class="comment">// calc how good confront to constraint</span>
00371 
00372             <span class="keywordtype">double</span> cSum2 = 0.0;
00373             <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; ++i )
00374                 cSum2 += limitCoeff[i] * Alt_Result_Vector_S1[i];
00375             <span class="comment">// now compare cSum2 with limitSum</span>
00376 
00377             <span class="keywordtype">double</span> wSum2 = 0.0f;
00378             <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; ++i ) {
00379                 wSum2 += (cost2[i] * Alt_Result_Vector_S1[i] + cost1[i]) * Alt_Result_Vector_S1[i];
00380             }
00381 
00382             <span class="comment">// now compare wSum2 with wSum</span>
00383             <span class="keywordflow">if</span>( wSum2 &lt; wSum ) {
00384                 <span class="comment">// better solution</span>
00385 
00386                 <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; ++i ) {
00387                     Result_Vector_S1[i] = Alt_Result_Vector_S1[i];
00388                 }
00389             }
00390         }
00391     }
00392 
00393     <span class="comment">// DEBUG OUTPUT</span>
00394     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; ++i ) {
00395         Result_Vector_S2[i] = Result_Vector_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a72">PL_BUDGET_ADJUSTMENT</a>];
00396     }
00397 
00398     <span class="comment">// Set S1_Output_Budget = new Revenue_and_Expense</span>
00399     Calc_Budget( S1_Output_Budget, Result_Vector_S1, Result_Vector_S2,
00400                  Base_Budget, New_State_approp, inflation, Base_tuition_rate, Target_enrollment,
00401                  Base_endowmentMV, Base_OpResBalance, ST_int_rate_01Aug, New_Debt_service );
00402     Write_Budget( S1_Output_Budget, 76, 8 );
00403 
00404   <span class="comment">// find Base_Budget OperatingCost</span>
00405     <span class="keywordtype">double</span> Base_Budget_OperatingCost = 0.0f;
00406     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a102a42">OPERATING_EXPENSE_ITEM_COUNT</a>; ++i )
00407         Base_Budget_OperatingCost += Base_Budget.Expense_Array[i][3];
00408 
00409   <span class="comment">// stage 1 finish</span>
00410 
00411     <span class="keywordflow">if</span>( endStage &lt;= 1 )
00412         <span class="keywordflow">return</span>;
00413 
00414   <span class="comment">// Calculate S2 input matrices, do the S2 optimization, l and update the S2 result vector</span>
00415     Real_Budget_Growth_Dollars = Result_Vector_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a72">PL_BUDGET_ADJUSTMENT</a>]
00416         * (Base_Budget_OperatingCost - Base_Budget.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][3]); {
00417 
00418         ColumnVector c(<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>);
00419         DiagonalMatrix Q(<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>);
00420         <a class="code" href="classMatrix.html">Matrix</a> A(<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>*2+2,<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>);
00421         ColumnVector b(<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>*2+2);
00422 
00423         ColumnVector xNames(<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>);
00424 
00425         <span class="comment">// Real_Budget_Growth_Dollars = (budget growth % from S1) * (total base operating expenditures - spons res)</span>
00426         Calc_Matrices_S2( Real_Budget_Growth_Dollars, c, Q, A, b,
00427                           Base_Budget, PL_Policy_Array_S2 );
00428 
00429         quadratic_prog( c, Q, A, b, xNames, 100 );
00430 
00431         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; ++i )
00432             Result_Vector_S2[i] = (float)xNames(i+1);   <span class="comment">// start from xNames(1)</span>
00433 
00434         <span class="comment">// get the sum of last constraints</span>
00435         <span class="keywordtype">float</span> cSum = 0.0f;
00436         <span class="keywordflow">for</span>( i = 1; i &lt;= <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; ++i ) {
00437             cSum += xNames(i) * A(<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>*2+1, i );
00438         }
00439         <span class="comment">// compare with b(COST_RISE_POLICY_COUNT*2+2)</span>
00440 
00441         <span class="comment">// calc the value to minimize Qx^2 + cx</span>
00442         <span class="keywordtype">float</span> wSum = 0.0f;
00443         <span class="keywordflow">for</span>( i = 1; i &lt;= <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; ++i ) {
00444             wSum += (Q(i) * xNames(i) + c(i)) * xNames(i);
00445         }
00446 
00447         <span class="comment">// use another method to do optimization</span>
00448 
00449         <span class="keywordtype">double</span> Alt_Result_Vector_S2[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>];
00450         <span class="keywordtype">double</span> lowLimit[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>];
00451         <span class="keywordtype">double</span> highLimit[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>];
00452         <span class="keywordtype">double</span> tolLimit[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>];
00453         <span class="keywordtype">double</span> limitCoeff[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>];
00454         <span class="keywordtype">double</span> limitSum;
00455         <span class="keywordtype">double</span> cost1[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>];
00456         <span class="keywordtype">double</span> cost2[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>];
00457         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; ++i ) {
00458             lowLimit[i] = PL_Policy_Array_S2[i][1];
00459             highLimit[i] = PL_Policy_Array_S2[i][2];
00460             tolLimit[i] = 0.0005;
00461             limitCoeff[i] = A(<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>*2+1, i+1 );
00462             cost1[i] = c(i+1);
00463             cost2[i] = Q(i+1);
00464         }
00465         limitSum = b(<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>*2+1);
00466 
00467         <a class="code" href="classQuadProgramming.html">QuadProgramming</a> quadProg;
00468 
00469         <span class="keywordflow">if</span>( quadProg.<a class="code" href="classQuadProgramming.html#a2">sp_quadratic_programming</a>( <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>,
00470                                                Alt_Result_Vector_S2,
00471                                                lowLimit, highLimit, tolLimit, limitCoeff, limitSum, cost1, cost2 ) ) {
00472             <span class="comment">// calc how good confront to constraint</span>
00473 
00474             <span class="keywordtype">double</span> cSum2 = 0.0;
00475             <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; ++i )
00476                 cSum2 += limitCoeff[i] * Alt_Result_Vector_S2[i];
00477             <span class="comment">// now compare cSum2 with limitSum</span>
00478 
00479             <span class="keywordtype">double</span> wSum2 = 0.0f;
00480             <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; ++i ) {
00481                 wSum2 += (cost2[i] * Alt_Result_Vector_S2[i] + cost1[i]) * Alt_Result_Vector_S2[i];
00482             }
00483 
00484             <span class="comment">// now compare cSum2 with cSum</span>
00485             <span class="keywordflow">if</span>( <a class="code" href="OLINALG_8CPP.html#a2">fabs</a>(cSum2 - limitSum) &lt; <a class="code" href="OLINALG_8CPP.html#a2">fabs</a>(cSum - limitSum) ) {
00486                 <span class="comment">// better solution</span>
00487 
00488                 <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; ++i ) {
00489                     Result_Vector_S2[i] = Alt_Result_Vector_S2[i];
00490                 }
00491             }
00492         }
00493 
00494     }
00495 
00496     <span class="comment">// Set Final_Budget = new Revenue_and_Expense</span>
00497     Calc_Budget( Final_Budget, Result_Vector_S1, Result_Vector_S2,
00498                  Base_Budget, New_State_approp, inflation, Base_tuition_rate, Target_enrollment,
00499                  Base_endowmentMV, Base_OpResBalance, ST_int_rate_01Aug, New_Debt_service );
00500 
00501     <span class="comment">// DEBUG OUTPUT</span>
00502     Write_Budget( Final_Budget, 107, 3 );
00503 
00504     <span class="comment">// Set New_Actual = New Revenue_and_Expense</span>
00505 
00506     Calc_Actual( New_Actual, Final_Budget,
00507                  Base_Actual, Actual_fac_salaries_31Aug, ST_int_rate_31Aug,
00508                  Actual_enrollment, Base_OpResBalance );
00509 
00510     <span class="comment">// DEBUG OUTPUT</span>
00511     Write_Budget( New_Actual, 107, 8 );
00512 }
00513 
00514 <span class="keyword">static</span> <span class="keywordtype">void</span> Calc_Actual( Revenue_and_Expense &amp;Actual_Obj, <span class="keyword">const</span> Revenue_and_Expense &amp;Budget_Obj,
00515                          <span class="keyword">const</span> Revenue_and_Expense &amp;Base_Actual,
00516                          <span class="keywordtype">double</span> Actual_fac_salaries_31Aug,
00517                          <span class="keywordtype">double</span> ST_int_rate_31Aug,
00518                          <span class="keywordtype">double</span> Actual_enrollment,
00519                          <span class="keywordtype">double</span> Base_OpResBalance ) {
00520     <span class="keywordtype">int</span> i, j;
00521 
00522   <span class="comment">// beware some use Budget_Obj, some use Base_Actual</span>
00523                                                   <span class="comment">// Tuition revenue</span>
00524     Actual_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>][3] = Budget_Obj.Tuition_Rate * Actual_enrollment / 1000.0;
00525     <span class="comment">// Financial Aid</span>
00526     Actual_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>][3] = Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>][3];
00527     Actual_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>][3] = 0.0f;
00528     <span class="keywordflow">for</span>( i = <a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>; i &lt; <a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>; ++i )
00529         Actual_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>][3] += Actual_Obj.Revenue_Array[i][3];
00530 
00531                                                   <span class="comment">// Direct sponsored research</span>
00532     Actual_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][1] = Base_Actual.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][1];
00533     Actual_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][2] = Base_Actual.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][1]
00534         <span class="comment">// Indirect (=0 if denominator = 0)</span>
00535         * math.safe_divide(Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][2],Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][1]);
00536     Actual_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][3] = Actual_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][1]
00537         + Actual_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][2];
00538 
00539                                                   <span class="comment">// Gifts</span>
00540     Actual_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a36">AC_GIFTS</a>][3] = Base_Actual.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a36">AC_GIFTS</a>][3];
00541     <span class="comment">// Endowment spending</span>
00542     Actual_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>][3] = Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>][3];
00543     <span class="comment">// Athletics</span>
00544     Actual_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a38">AC_INTERCOLLEGIATE_ATHLETICS</a>][3] = Base_Actual.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a38">AC_INTERCOLLEGIATE_ATHLETICS</a>][3];
00545     <span class="comment">// Other income</span>
00546     Actual_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>][3] = Base_Actual.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>][3];
00547     <span class="comment">// Int on oper res</span>
00548     Actual_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a40">AC_INTEREST_EARNED_OR_PAID</a>][3] = ST_int_rate_31Aug * (Base_OpResBalance + Base_Actual.Surplus_Deficit);
00549     <span class="comment">// State appropriation</span>
00550     Actual_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>][3] = Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>][3];
00551 
00552     <span class="comment">// Most actuals equal forecast</span>
00553     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a102a42">OPERATING_EXPENSE_ITEM_COUNT</a>; ++i ) {
00554         <span class="keywordflow">for</span>( j = 0; j &lt;= 2; ++j ) {
00555             Actual_Obj.Expense_Array[i][j] = Budget_Obj.Expense_Array[i][j];
00556         }
00557     }
00558 
00559     <span class="comment">// Now process the exceptions and "below the line" items</span>
00560     <span class="comment">// Faculy salaries</span>
00561     Actual_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>][0] = Actual_fac_salaries_31Aug;
00562     <span class="keywordflow">for</span>( j = 0; j &lt;= 2; ++j )
00563         <span class="comment">// Sponsored research</span>
00564         Actual_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][j] = Base_Actual.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][j];
00565 
00566     <span class="comment">// although in VBA from Bill, is 11 and 12</span>
00567     <span class="comment">// change the index to 11-12, as Bill may think index 10 is used to operating expense total</span>
00568     <span class="keywordflow">for</span>( j = 0; j &lt;= 2; ++j )
00569         <span class="comment">// Debt service</span>
00570         Actual_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a55">AC_SERVICE_ON_GENERAL_PLANT_DEBT</a>][j] = Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a55">AC_SERVICE_ON_GENERAL_PLANT_DEBT</a>][j];
00571     <span class="keywordflow">for</span>( j = 0; j &lt;= 2; ++j )
00572         <span class="comment">// Transfer to capital reserve</span>
00573         Actual_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>][j] = Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>][j];
00574 
00575     <span class="comment">// calc faulty+staff+other to total of each expense item</span>
00576     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; ++i ) {
00577         <span class="keywordtype">double</span> expenseItemTotal = 0.0f;
00578         <span class="keywordflow">for</span>( j = 0; j &lt;= 2; ++j ) {
00579             expenseItemTotal += Actual_Obj.Expense_Array[i][j];
00580         }
00581         Actual_Obj.Expense_Array[i][3] = expenseItemTotal;
00582     }
00583     Actual_Obj.calc_Surplus_Deficit();
00584 }
00585 
00586 <span class="keyword">static</span> <span class="keywordtype">void</span> Calc_Budget( Revenue_and_Expense &amp;Budget_Obj, <span class="keywordtype">float</span> *Policy_Vector_S1, <span class="keywordtype">float</span> *Policy_Vector_S2,
00587                          <span class="keyword">const</span> Revenue_and_Expense &amp;Base_Budget,
00588                          <span class="keywordtype">double</span> New_State_approp, <span class="keywordtype">double</span> inflation, <span class="keywordtype">double</span> Base_tuition_rate, <span class="keywordtype">double</span> Target_enrollment,
00589                          <span class="keywordtype">double</span> Base_endowmentMV, <span class="keywordtype">double</span> Base_OpResBalance, <span class="keywordtype">double</span> ST_int_rate_01Aug, <span class="keywordtype">double</span> New_Debt_service ) {
00590     <span class="keywordtype">int</span> i;
00591     <span class="comment">// Forecasts revenue and expense items for use in budgeting</span>
00592 
00593     <span class="comment">// Revenues</span>
00594     <span class="comment">// Tuition revenue</span>
00595     Budget_Obj.Tuition_Rate = (1.0 + inflation + Policy_Vector_S1[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>]) * Base_tuition_rate;
00596     Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>][3] = (Budget_Obj.Tuition_Rate / 1000.0) * Target_enrollment;
00597 
00598     <span class="comment">// Financial Aid</span>
00599     Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>][3] = (1.0 + inflation + Policy_Vector_S1[<a class="code" href="Ofinance_8h.html#a108a66">PL_FINANCIAL_AID</a>]) * Base_Budget.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>][3];
00600 
00601     <span class="comment">// calc net tuition income</span>
00602     Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>][3] = 0.0f;
00603     <span class="keywordflow">for</span>( i = <a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>; i &lt; <a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>; ++i ) {
00604         Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>][3] += Budget_Obj.Revenue_Array[i][3];
00605     }
00606 
00607     <span class="comment">// Sponsored research is calculated later</span>
00608 
00609   <span class="comment">// Gifts</span>
00610     Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a36">AC_GIFTS</a>][3] = (1.0 + inflation) * Base_Budget.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a36">AC_GIFTS</a>][3];
00611 
00612     <span class="comment">// Endowment spending (row 6)</span>
00613     Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>][3] = Policy_Vector_S1[<a class="code" href="Ofinance_8h.html#a108a67">PL_ENDOWMENT_SPENDING_RATE</a>] * Base_endowmentMV;
00614 
00615     <span class="comment">// Athletics</span>
00616     Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a38">AC_INTERCOLLEGIATE_ATHLETICS</a>][3] = (1.0 + inflation) * Base_Budget.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a38">AC_INTERCOLLEGIATE_ATHLETICS</a>][3];
00617 
00618     <span class="comment">// Other operating income</span>
00619     Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>][3] = (1.0 + inflation) * Base_Budget.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>][3];
00620 
00621     <span class="comment">// Interest on the operating reserve (adjust for current year surplus/deficit)</span>
00622     Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a40">AC_INTEREST_EARNED_OR_PAID</a>][3] = (Base_OpResBalance + Base_Budget.Surplus_Deficit) * ST_int_rate_01Aug;
00623 
00624     <span class="comment">// state appropriation</span>
00625     Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>][3] = New_State_approp;
00626 
00627     <span class="comment">// Expenses</span>
00628 
00629   <span class="comment">// Academic departments</span>
00630     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>][0] = Base_Budget.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>][0]
00631         * (1.0 + Policy_Vector_S2[<a class="code" href="Ofinance_8h.html#a112a76">PL_FACULTY_FTE</a>] + inflation
00632            <span class="comment">// Faculty salaries</span>
00633            + Policy_Vector_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a70">PL_FACULTY_SALARY_INCREASES</a>] );
00634     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>][1] = Base_Budget.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>][1]
00635         * (1.0 + Policy_Vector_S2[<a class="code" href="Ofinance_8h.html#a112a77">PL_NON_FACULTY_DEPARTMENTAL_EXPENSE</a>] + inflation
00636            <span class="comment">// Staff salaries</span>
00637            + Policy_Vector_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a71">PL_STAFF_SALARY_INCREASES</a>]);
00638     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>][2] = Base_Budget.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>][2]
00639         <span class="comment">// other salaries</span>
00640         * (1.0 + Policy_Vector_S2[<a class="code" href="Ofinance_8h.html#a112a77">PL_NON_FACULTY_DEPARTMENTAL_EXPENSE</a>] + inflation);
00641     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>][3] = Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>][0]
00642         + Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>][1]
00643         + Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>][2];
00644 
00645   <span class="comment">// Sponsered research (equal last year except for salary increases)</span>
00646     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][0] = Base_Budget.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][0]
00647         <span class="comment">// Faculty salaries</span>
00648         * (1.0 + inflation + Policy_Vector_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a70">PL_FACULTY_SALARY_INCREASES</a>]);
00649     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][1] = Base_Budget.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][1]
00650         <span class="comment">// Staff salaries</span>
00651         * (1.0 + inflation + Policy_Vector_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a71">PL_STAFF_SALARY_INCREASES</a>]);
00652     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][2] = Base_Budget.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][2]
00653         * (1.0 + inflation);                          <span class="comment">// other expense</span>
00654     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][3] = Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][0]
00655         + Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][1]
00656         + Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][2];
00657 
00658   <span class="comment">// Support Service</span>
00659     <span class="keywordflow">for</span>( i = 1+<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>; i &lt; <a class="code" href="Ofinance_8h.html#a102a42">OPERATING_EXPENSE_ITEM_COUNT</a>; ++i ) {
00660         Budget_Obj.Expense_Array[i][0] = Base_Budget.Expense_Array[i][0]
00661             * (1.0 + Policy_Vector_S2[i] + inflation
00662                <span class="comment">// Faculty salaries</span>
00663                + Policy_Vector_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a70">PL_FACULTY_SALARY_INCREASES</a>] );
00664         Budget_Obj.Expense_Array[i][1] = Base_Budget.Expense_Array[i][1]
00665             * (1.0 + Policy_Vector_S2[i] + inflation
00666                <span class="comment">// Staff salaries</span>
00667                + Policy_Vector_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a71">PL_STAFF_SALARY_INCREASES</a>]);
00668         Budget_Obj.Expense_Array[i][2] = Base_Budget.Expense_Array[i][2]
00669             * (1.0 + Policy_Vector_S2[i] + inflation);  <span class="comment">// other salaries</span>
00670         Budget_Obj.Expense_Array[i][3] = Budget_Obj.Expense_Array[i][0]
00671             + Budget_Obj.Expense_Array[i][1] + Budget_Obj.Expense_Array[i][2];
00672     }
00673 
00674     <span class="comment">// Service on general plant debt and Transfer to capital reserve</span>
00675 
00676     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a55">AC_SERVICE_ON_GENERAL_PLANT_DEBT</a>][0] = 0.0f;
00677     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a55">AC_SERVICE_ON_GENERAL_PLANT_DEBT</a>][1] = 0.0f;
00678     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a55">AC_SERVICE_ON_GENERAL_PLANT_DEBT</a>][2] = New_Debt_service;
00679     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a55">AC_SERVICE_ON_GENERAL_PLANT_DEBT</a>][3] = Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a55">AC_SERVICE_ON_GENERAL_PLANT_DEBT</a>][2];
00680 
00681     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>][0] = 0.0f;
00682     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>][1] = 0.0f;
00683     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>][2] = Base_Budget.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>][2]
00684         <span class="comment">// Other Expense</span>
00685         * (1.0 + inflation + Policy_Vector_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a73">PL_REAL_TRANSFER_TO_PLANT_GROWTH</a>]);
00686     Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>][3] = Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>][2];
00687 
00688   <span class="comment">// Sponsored research REVENUE (direct revenue = sponsored research expense;</span>
00689   <span class="comment">//    indirect revenue = smoothed adjustment based on the new indirect cost rate)</span>
00690 
00691     Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][1] = Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][3];
00692     Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][2] = Base_Budget.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][2]
00693         + 0.5 * (Budget_Obj.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][3]
00694                  * Policy_Vector_S1[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>] - Base_Budget.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][2]);
00695     Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][3] = Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][1]
00696         + Budget_Obj.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>][2];
00697 
00698   <span class="comment">// calc surplus deficit</span>
00699 
00700     Budget_Obj.calc_Surplus_Deficit();
00701 }
00702 
00703 <span class="comment">// this function original for Bill to fill fields on spreadsheet</span>
00704 <span class="keyword">static</span> <span class="keywordtype">void</span> Write_Budget( Revenue_and_Expense &amp;Trial_Budget, <span class="keywordtype">int</span>, <span class="keywordtype">int</span> ) {
00705 <span class="preprocessor">#ifdef DEBUG</span>
00706 <span class="preprocessor"></span>    <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"Revenue :"</span>);
00707 
00708     <a class="code" href="classString.html">String</a> s;
00709     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; ++i ) {
00710         s  = Trial_Budget.Revenue_Array[i][3];
00711         <span class="keywordflow">if</span>( i == <a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a> ) {
00712             s += <span class="stringliteral">"   {"</span>;
00713             s += Trial_Budget.Revenue_Array[i][1];
00714             s += <span class="stringliteral">" + "</span>;
00715             s += Trial_Budget.Revenue_Array[i][2];
00716             s += <span class="stringliteral">"}"</span>;
00717         }
00718         <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>( (<span class="keywordtype">char</span> *)s );
00719     }
00720 
00721     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"Expense :"</span>);
00722     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; ++i ) {
00723         s  = Trial_Budget.Expense_Array[i][3];
00724         s += <span class="stringliteral">"  {"</span>;
00725         s += Trial_Budget.Expense_Array[i][0];
00726         s += <span class="stringliteral">" + "</span>;
00727         s += Trial_Budget.Expense_Array[i][1];
00728         s += <span class="stringliteral">" + "</span>;
00729         s += Trial_Budget.Expense_Array[i][2];
00730         s += <span class="stringliteral">"}"</span>;
00731         <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>( (<span class="keywordtype">char</span> *)s );
00732     }
00733 
00734     s  = <span class="stringliteral">"Surplus = "</span>;
00735     s += Trial_Budget.Surplus_Deficit;
00736     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>( (<span class="keywordtype">char</span> *)s );
00737 <span class="preprocessor">#endif</span>
00738 <span class="preprocessor"></span>}
00739 
00740 <span class="comment">// dimension of c is [REVENUE_POLICY_COUNT+EXPENSE_POLICY_COUNT]</span>
00741 <span class="comment">// dimension of Q is [REVENUE_POLICY_COUNT+EXPENSE_POLICY_COUNT][REVENUE_POLICY_COUNT+EXPENSE_POLICY_COUNT]</span>
00742 <span class="comment">// dimension of A is [(REVENUE_POLICY_COUNT+EXPENSE_POLICY_COUNT)*2+2][REVENUE_POLICY_COUNT+EXPENSE_POLICY_COUNT]</span>
00743 <span class="comment">// dimension of b is [(REVENUE_POLICY_COUNT+EXPENSE_POLICY_COUNT)*2+2]</span>
00744 
00745 <span class="keyword">static</span> <span class="keywordtype">void</span> Calc_Matrices_S1( <span class="keywordtype">double</span> trial_Surplus_Deficit, ColumnVector &amp;c, DiagonalMatrix &amp;Q, <a class="code" href="classMatrix.html">Matrix</a> &amp;A, ColumnVector &amp;b,
00746                               <span class="keyword">const</span> <span class="keywordtype">float</span> PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>][4],
00747                               <span class="keyword">const</span> Revenue_and_Expense &amp;Base_Budget,
00748                               <span class="keywordtype">double</span> Base_tuition_rate,
00749                               <span class="keywordtype">double</span> Target_enrollment,
00750                               <span class="keywordtype">double</span> Base_endowmentMV,
00751                               <span class="keywordtype">double</span> inflation
00752     ) {
00753     <span class="comment">// Calculate the matrices for stage 1 optimization input</span>
00754     <span class="comment">// minimize c'x + x'Qx/2 s.t. Ax &gt;= b ( and x &gt;= 0 )</span>
00755 
00756     <span class="keywordtype">double</span> remainder, coefficients[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>];
00757     <span class="keywordtype">double</span> Base_Budget_OperatingCost[4];
00758     <span class="keywordtype">double</span> Base_Budget_TotalUseOfFund[4];
00759 
00760     <span class="keywordtype">int</span> i,j;
00761     <span class="keywordflow">for</span>( j = 0; j &lt; 4; ++j ) {
00762         Base_Budget_OperatingCost[j] = 0.0f;
00763         <span class="keywordflow">for</span>(i=0; i &lt; <a class="code" href="Ofinance_8h.html#a102a42">OPERATING_EXPENSE_ITEM_COUNT</a>; ++i )
00764             Base_Budget_OperatingCost[j] += Base_Budget.Expense_Array[i][j];
00765     }
00766     <span class="keywordflow">for</span>( j = 0; j &lt; 4; ++j ) {
00767         Base_Budget_TotalUseOfFund[j] = 0.0f;
00768         <span class="keywordflow">for</span>(i=0; i &lt; <a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; ++i )
00769             Base_Budget_TotalUseOfFund[j] += Base_Budget.Expense_Array[i][j];
00770     }
00771 
00772     <span class="comment">// initialize A to zero</span>
00773     A = 0.0;
00774 
00775     <span class="comment">// Contraints</span>
00776     <span class="comment">// Tuition rate</span>
00777     coefficients[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>] = Base_tuition_rate * Target_enrollment / 1000.0;
00778     <span class="comment">// Financial aid</span>
00779     coefficients[<a class="code" href="Ofinance_8h.html#a108a66">PL_FINANCIAL_AID</a>] = Base_Budget.Revenue_Array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>][3];
00780     <span class="comment">// Endowment spending</span>
00781     coefficients[<a class="code" href="Ofinance_8h.html#a108a67">PL_ENDOWMENT_SPENDING_RATE</a>] = Base_endowmentMV;
00782     <span class="comment">// indirect cost rate</span>
00783     coefficients[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>] = Base_Budget.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>][3] * (1.015 + inflation) / 2.0f;
00784 
00785   <span class="comment">// Approximates the salary increases to maintain linearity and allows for the smooth</span>
00786                                                   <span class="comment">// faculty salaries</span>
00787     coefficients[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a70">PL_FACULTY_SALARY_INCREASES</a>] = -Base_Budget_OperatingCost[0];
00788     <span class="comment">// staff salaries</span>
00789     coefficients[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a71">PL_STAFF_SALARY_INCREASES</a>] = -Base_Budget_OperatingCost[1];
00790     <span class="comment">// real budget growth</span>
00791     coefficients[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a72">PL_BUDGET_ADJUSTMENT</a>] = -Base_Budget_OperatingCost[3];
00792     <span class="comment">// Transfer to capital reserve</span>
00793     coefficients[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a73">PL_REAL_TRANSFER_TO_PLANT_GROWTH</a>] = -Base_Budget.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>][3];
00794     <span class="comment">// surplus/deficit</span>
00795     coefficients[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a74">PL_SURPLUS_DEFICIT</a>] = -Base_Budget_TotalUseOfFund[3] * (1.0 + inflation);
00796 
00797     <span class="comment">// object function</span>
00798     <span class="keyword">static</span> <span class="keywordtype">double</span> weightScale = 100000.0;
00799     <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; ++i ) {
00800         <span class="comment">// original design</span>
00801         <span class="comment">//c(i+1) = -PL_Policy_Array_S1[i][0] * PL_Policy_Array_S1[i][3]; // -target * weight</span>
00802         <span class="comment">//Q(i+1) = PL_Policy_Array_S1[i][3] / 2.0; // weight / 2</span>
00803 
00804         <span class="comment">// change 1</span>
00805         <span class="keywordtype">double</span> adjWeight = 1.0;
00806         <span class="keywordflow">if</span>( coefficients[i] != 0.0 ) {                <span class="comment">// avoid adjWeight to be zero, (eg. sponsored research is zero, then indirect cost rate in unconstrainted. If adjWeight is zero, optimization can't get the target value (c/-2Q))</span>
00807             <span class="comment">// order 1 : default</span>
00808             adjWeight = PL_Policy_Array_S1[i][3] * <a class="code" href="OLINALG_8CPP.html#a2">fabs</a>(coefficients[i])/weightScale;
00809             <span class="comment">// order 0</span>
00810             <span class="comment">//adjWeight = PL_Policy_Array_S1[i][3];</span>
00811             <span class="comment">// order -1</span>
00812             <span class="comment">//adjWeight = fabs(coefficients[i]) &lt; 1.0 ? PL_Policy_Array_S1[i][3]</span>
00813             <span class="comment">//  : PL_Policy_Array_S1[i][3] * weightScale / fabs(coefficients[i]);</span>
00814             <span class="comment">// order 2</span>
00815             <span class="comment">//adjWeight = PL_Policy_Array_S1[i][3] * coefficients[i] * coefficients[i] / weightScale;</span>
00816         }
00817 
00818         <span class="comment">// -target * weight</span>
00819         c(i+1) = -PL_Policy_Array_S1[i][0] * adjWeight;
00820         Q(i+1) = adjWeight / 2.0;                     <span class="comment">// weight / 2</span>
00821     }
00822 
00823     remainder = trial_Surplus_Deficit;
00824 
00825     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; ++i ) {
00826         <span class="keywordflow">if</span>( i != <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a110a74">PL_SURPLUS_DEFICIT</a> )
00827             remainder -= coefficients[i] * PL_Policy_Array_S1[i][0];
00828     }
00829 
00830     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; ++i ) {
00831         A(i+1,i+1) = 1.0;
00832         b(i+1) = PL_Policy_Array_S1[i][1];            <span class="comment">// lower bound</span>
00833         A(<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>+i+1, i+1) = -1.0f;
00834         <span class="comment">// upper bound</span>
00835         b(<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>+i+1) = -PL_Policy_Array_S1[i][2];
00836 
00837         A((<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>)*2+1, i+1) = -coefficients[i];
00838         <span class="comment">// positive budget constraint</span>
00839         b((<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>)*2+1) = remainder;
00840         A((<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>)*2+2, i+1) = coefficients[i];
00841         <span class="comment">// negative budget constraint</span>
00842         b((<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>)*2+2) = -remainder;
00843     }
00844 
00845     <span class="comment">// reverse the signs of the surplus/deficit terms</span>
00846     <span class="comment">// A((REVENUE_POLICY_COUNT+EXPENSE_POLICY_COUNT)*2, REVENUE_POLICY_COUNT+PL_SURPLUS_DEFICIT)</span>
00847     <span class="comment">// = -A((REVENUE_POLICY_COUNT+EXPENSE_POLICY_COUNT)*2, REVENUE_POLICY_COUNT+PL_SURPLUS_DEFICIT);</span>
00848     <span class="comment">// A((REVENUE_POLICY_COUNT+EXPENSE_POLICY_COUNT)*2+1, REVENUE_POLICY_COUNT+PL_SURPLUS_DEFICIT)</span>
00849     <span class="comment">// = -A((REVENUE_POLICY_COUNT+EXPENSE_POLICY_COUNT)*2+1, REVENUE_POLICY_COUNT+PL_SURPLUS_DEFICIT);</span>
00850 }
00851 
00852 <span class="comment">//      dimension of c is [COST_RISE_POLICY_COUNT]</span>
00853 <span class="comment">//      dimension of Q is [COST_RISE_POLICY_COUNT][COST_RISE_POLICY_COUNT]</span>
00854 <span class="comment">//      dimension of A is [COST_RISE_POLICY_COUNT*2+2][COST_RISE_POLICY_COUNT]</span>
00855 <span class="comment">// dimension of b is [COST_RISE_POLICY_COUNT*2+2]</span>
00856 
00857 <span class="keyword">static</span> <span class="keywordtype">void</span> Calc_Matrices_S2( <span class="keywordtype">double</span> dollar_Constraint, ColumnVector &amp;c, DiagonalMatrix &amp;Q, <a class="code" href="classMatrix.html">Matrix</a> &amp;A, ColumnVector &amp;b,
00858                               <span class="keyword">const</span> Revenue_and_Expense &amp;Base_Budget,
00859                               <span class="keyword">const</span> <span class="keywordtype">float</span> PL_Policy_Array_S2[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>][4]
00860     ) {
00861     <span class="comment">// calculate the matrices for stage 2 optimization input</span>
00862     <span class="comment">// minimize c'x + x'Qx/2 s.t. Ax &gt;= b ( and x &gt;= 0 )</span>
00863     <span class="comment">// NOTE :  the second-order effects between real budget growth and salary increments</span>
00864     <span class="comment">// and faculty research offsets are ignored to make the results easy to track.</span>
00865 
00866     <span class="keywordtype">double</span> coefficients[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>];
00867 
00868     <span class="keywordtype">int</span> i;
00869 
00870     <span class="comment">// initialize A to zero</span>
00871     A = 0.0;
00872 
00873     <span class="comment">// constraint</span>
00874 
00875     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; ++i ) {
00876         <span class="keywordflow">if</span>( i == <a class="code" href="Ofinance_8h.html#a112a76">PL_FACULTY_FTE</a> ) {
00877             <span class="comment">// faculty budget</span>
00878             coefficients[i] = Base_Budget.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>][0];
00879         }
00880         <span class="keywordflow">else</span> <span class="keywordflow">if</span>( i == <a class="code" href="Ofinance_8h.html#a112a77">PL_NON_FACULTY_DEPARTMENTAL_EXPENSE</a> ) {
00881             coefficients[i] = Base_Budget.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>][1]
00882                 <span class="comment">// nonfaculty dept'l expense</span>
00883                 + Base_Budget.Expense_Array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>][2];
00884         }
00885         <span class="keywordflow">else</span> {
00886             <a class="code" href="ALL_8H.html#a0">err_when</a>( i &gt;= <a class="code" href="Ofinance_8h.html#a102a42">OPERATING_EXPENSE_ITEM_COUNT</a> );
00887             <span class="comment">// all other expenditure line items</span>
00888             coefficients[i] = Base_Budget.Expense_Array[i][3];
00889         }
00890     }
00891 
00892     <span class="comment">// objective function</span>
00893     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; ++i ) {
00894         <span class="comment">// original design</span>
00895         <span class="comment">//c(i+1) = -PL_Policy_Array_S2[i][0] * PL_Policy_Array_S2[i][3]; // -target * weight</span>
00896         <span class="comment">//Q(i+1) = PL_Policy_Array_S2[i][3] / 2.0; // weight / 2</span>
00897 
00898         <span class="comment">// change 1</span>
00899         <span class="keywordtype">double</span> adjWeight = PL_Policy_Array_S2[i][3] * <a class="code" href="OLINALG_8CPP.html#a2">fabs</a>(coefficients[i])/100000.0;
00900         <span class="comment">// -target * weight</span>
00901         c(i+1) = -PL_Policy_Array_S2[i][0] * adjWeight;
00902         Q(i+1) = adjWeight / 2.0;                     <span class="comment">// weight / 2</span>
00903     }
00904 
00905     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; ++i ) {
00906         A(i+1,i+1) = 1.0;
00907         b(i+1) = PL_Policy_Array_S2[i][1];            <span class="comment">// lower bound</span>
00908         A(<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>+i+1,i+1) = -1.0f;
00909         <span class="comment">// upper bound</span>
00910         b(<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>+i+1) = -PL_Policy_Array_S2[i][2];
00911 
00912         A(<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>*2+1,i+1) = coefficients[i];
00913         <span class="comment">// Positive budget constraint</span>
00914         b(<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>*2+1) = dollar_Constraint;
00915         A(<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>*2+2,i+1) = -coefficients[i];
00916         <span class="comment">// Negative budget constraint</span>
00917         b(<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>*2+2) = -dollar_Constraint;
00918     }
00919 }
00920 
00921 <span class="keyword">static</span> <span class="keywordtype">void</span> quadratic_prog( ColumnVector &amp;c, DiagonalMatrix &amp;Q, <a class="code" href="classMatrix.html">Matrix</a> &amp;A, ColumnVector &amp;b, ColumnVector &amp;xNames, <span class="keywordtype">int</span> loopCountMultiplier ) {
00922     <span class="comment">// use another way to do programming</span>
00923     <a class="code" href="classLinearAlgebra.html#d0">LinearAlgebra::quadratic_prog</a>(c,Q,A,b,xNames, loopCountMultiplier);
00924     <span class="comment">// may return false</span>
00925 }
00926 
00927 <span class="comment">// get input for Optimize_policy_ver2</span>
00928 <span class="keyword">static</span> <span class="keywordtype">void</span> input_Optimize_policy_ver2(
00929     Revenue_and_Expense&amp; Base_Budget,                 <span class="comment">// Base_Budget is projected actual on 1st Aug</span>
00930     Revenue_and_Expense&amp; Base_Actual,                 <span class="comment">// Base_Actual is actual at year end</span>
00931     <span class="comment">// slider in stage 1 optimization; [0] is target, [1] is lower bound [2] is upper bound [3] is preference (weight)</span>
00932     <span class="keywordtype">float</span> PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>][4],
00933     <span class="comment">// slider in stage 2 optimization; [0] is target, [1] is lower bound [2] is upper bound [3] is preference (weight)</span>
00934     <span class="keywordtype">float</span> PL_Policy_Array_S2[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>][4],
00935     <span class="keywordtype">double</span>&amp; inflation, <span class="keywordtype">double</span>&amp; Base_tuition_rate,
00936     <span class="keywordtype">double</span>&amp; Base_enrollment, <span class="keywordtype">double</span>&amp; Target_enrollment, <span class="keywordtype">double</span>&amp; Actual_enrollment,
00937     <span class="keywordtype">double</span>&amp; Base_endowmentMV,<span class="keywordtype">double</span>&amp; Base_OpResBalance,
00938     <span class="keywordtype">float</span>&amp; ST_int_rate_01Aug, <span class="keywordtype">float</span>&amp; ST_int_rate_31Aug,
00939     <span class="keywordtype">double</span>&amp; New_Debt_service ) {
00940     <span class="comment">// allocation stage 1</span>
00941     <span class="comment">// set input parameter</span>
00942 
00943     <span class="keywordtype">int</span> i;
00944 
00945     <span class="keywordflow">if</span>( info.prerun_year &amp;&amp; info.game_year == 1 ) { <span class="comment">// initialization</span>
00946         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; ++i ) {
00947             Base_Budget.Revenue_Array[i][0] = 0.0;
00948             Base_Budget.Revenue_Array[i][1] = finance.revenue_array[i].direct;
00949             Base_Budget.Revenue_Array[i][2] = finance.revenue_array[i].indirect;
00950             Base_Budget.Revenue_Array[i][3] = finance.revenue_array[i].total;
00951         }
00952         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; ++i ) {
00953             Base_Budget.Expense_Array[i][0] = finance.expense_array[i].faculty;
00954             Base_Budget.Expense_Array[i][1] = finance.expense_array[i].staff;
00955             Base_Budget.Expense_Array[i][2] = finance.expense_array[i].other;
00956             Base_Budget.Expense_Array[i][3] = finance.expense_array[i].total;
00957         }
00958     }
00959     <span class="keywordflow">else</span> {
00960         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; ++i ) {
00961             Base_Budget.Revenue_Array[i][0] = 0.0;
00962             Base_Budget.Revenue_Array[i][1] = finance.projected_revenue_array[i].month_start.direct;
00963             Base_Budget.Revenue_Array[i][2] = finance.projected_revenue_array[i].month_start.indirect;
00964             Base_Budget.Revenue_Array[i][3] = finance.projected_revenue_array[i].month_start.total;
00965         }
00966         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; ++i ) {
00967             Base_Budget.Expense_Array[i][0] = finance.projected_expense_array[i].month_start.faculty;
00968             Base_Budget.Expense_Array[i][1] = finance.projected_expense_array[i].month_start.staff;
00969             Base_Budget.Expense_Array[i][2] = finance.projected_expense_array[i].month_start.other;
00970             Base_Budget.Expense_Array[i][3] = finance.projected_expense_array[i].month_start.total;
00971         }
00972     }
00973 
00974     <span class="keywordflow">if</span>( info.prerun_year &amp;&amp; info.game_year == 1 ) { <span class="comment">// initialization</span>
00975         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; ++i ) {
00976             Base_Actual.Revenue_Array[i][0] = 0.0;
00977             Base_Actual.Revenue_Array[i][1] = finance.revenue_array[i].direct;
00978             Base_Actual.Revenue_Array[i][2] = finance.revenue_array[i].indirect;
00979             Base_Actual.Revenue_Array[i][3] = finance.revenue_array[i].total;
00980         }
00981         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; ++i ) {
00982             Base_Actual.Expense_Array[i][0] = finance.expense_array[i].faculty;
00983             Base_Actual.Expense_Array[i][1] = finance.expense_array[i].staff;
00984             Base_Actual.Expense_Array[i][2] = finance.expense_array[i].other;
00985             Base_Actual.Expense_Array[i][3] = finance.expense_array[i].total;
00986         }
00987     }
00988     <span class="keywordflow">else</span> {
00989         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; ++i ) {
00990             Base_Actual.Revenue_Array[i][0] = 0.0;
00991             Base_Actual.Revenue_Array[i][1] = finance.projected_revenue_array[i].this_year.direct;
00992             Base_Actual.Revenue_Array[i][2] = finance.projected_revenue_array[i].this_year.indirect;
00993             Base_Actual.Revenue_Array[i][3] = finance.projected_revenue_array[i].this_year.total;
00994         }
00995         <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; ++i ) {
00996             Base_Actual.Expense_Array[i][0] = finance.projected_expense_array[i].this_year.faculty;
00997             Base_Actual.Expense_Array[i][1] = finance.projected_expense_array[i].this_year.staff;
00998             Base_Actual.Expense_Array[i][2] = finance.projected_expense_array[i].this_year.other;
00999             Base_Actual.Expense_Array[i][3] = finance.projected_expense_array[i].this_year.total;
01000         }
01001     }
01002 
01003     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>; ++i ) {
01004         <span class="comment">// [0] is target</span>
01005         PL_Policy_Array_S1[i][0] = (float)finance.revenue_policy_array[i].target_value / 100.0f;
01006         <span class="comment">// [1] is ower bound</span>
01007         PL_Policy_Array_S1[i][1] = (float)finance.revenue_policy_array[i].lower_bound / 100.0f;
01008         <span class="comment">// [2] is upper bound</span>
01009         PL_Policy_Array_S1[i][2] = (float)finance.revenue_policy_array[i].upper_bound / 100.0f;
01010         <span class="comment">// [3] is preference (weight)</span>
01011         PL_Policy_Array_S1[i][3] = (float)finance.revenue_policy_array[i].import_weight;
01012         <span class="keywordflow">if</span>( finance.revenue_policy_array[i].required_flag ) {
01013             <span class="comment">// [0] is target</span>
01014             PL_Policy_Array_S1[i][1] = PL_Policy_Array_S1[i][2] = (float)finance.revenue_policy_array[i].target_value / 100.0f;
01015             PL_Policy_Array_S1[i][3] = <a class="code" href="Ofinanc2_8h.html#a2">OPT_HIGH_WEIGHT</a> * 10;
01016         }
01017     }
01018     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; ++i ) {
01019         <span class="comment">// [0] is target</span>
01020         PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+i][0] = (float)finance.expense_policy_array[i].target_value / 100.0f;
01021         <span class="comment">// [1] is ower bound</span>
01022         PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+i][1] = (float)finance.expense_policy_array[i].lower_bound / 100.0f;
01023         <span class="comment">// [2] is upper bound</span>
01024         PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+i][2] = (float)finance.expense_policy_array[i].upper_bound / 100.0f;
01025         <span class="comment">// [3] is preference (weight)</span>
01026         PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+i][3] = (float)finance.expense_policy_array[i].import_weight;
01027         <span class="keywordflow">if</span>( finance.expense_policy_array[i].required_flag ) {
01028             <span class="comment">// [0] is target</span>
01029             PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+i][1] = PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+i][2] = (float)finance.expense_policy_array[i].target_value / 100.0f;
01030             PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+i][3] = <a class="code" href="Ofinanc2_8h.html#a2">OPT_HIGH_WEIGHT</a> * 10;
01031         }
01032     }
01033 
01034     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; ++i ) {
01035         PL_Policy_Array_S2[i][0] = (float)finance.cost_rise_policy_array[i].target_value / 100.0f;
01036         PL_Policy_Array_S2[i][1] = (float)finance.cost_rise_policy_array[i].lower_bound / 100.0f;
01037         PL_Policy_Array_S2[i][2] = (float)finance.cost_rise_policy_array[i].upper_bound / 100.0f;
01038         PL_Policy_Array_S2[i][3] = (float)finance.cost_rise_policy_array[i].import_weight;
01039         <span class="keywordflow">if</span>( finance.cost_rise_policy_array[i].required_flag ) {
01040             PL_Policy_Array_S2[i][1] = PL_Policy_Array_S2[i][2] = (float)finance.cost_rise_policy_array[i].target_value / 100.0f;
01041             PL_Policy_Array_S2[i][3] = <a class="code" href="Ofinanc2_8h.html#a2">OPT_HIGH_WEIGHT</a> * 10;
01042         }
01043     }
01044 
01045     inflation = finance.inflation_rate/100.0;
01046     Base_tuition_rate = finance.tuition_rate;
01047     <span class="comment">// initialization</span>
01048     Base_enrollment = (info.prerun_year &amp;&amp; info.game_year == 1)
01049         ? enroll_res.total_student_count
01050         : department_array.student_level_history[<a class="code" href="Ostudent_8h.html#a34a13">MAX_STUDENT_LEVEL_TOTAL</a>][HISTORY_YEAR_COUNT-1];
01051     Target_enrollment = enroll_res.target_enrollment[<a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>] + enroll_res.target_enrollment[<a class="code" href="Ostudent_8h.html#a32a4">UG_NONTRADITION</a>]
01052         + enroll_res.target_enrollment[<a class="code" href="Ostudent_8h.html#a32a5">MASTER</a>] + department_array.student_level_history[<a class="code" href="Ostudent_8h.html#a32a6">DOCTOR</a>][HISTORY_YEAR_COUNT-1];
01053     Actual_enrollment = Target_enrollment;          <span class="comment">// temp, don't know because not generate next year enrollment yet</span>
01054 
01055     <span class="comment">// Base_endowmentMV = investment_office.smoothed_endowment_value;</span>
01056     <span class="comment">// Base_endowmentMV = finance.this_year.asset_array[AC_ENDOWMENT] + finance.this_year.asset_array[AC_QUASI];</span>
01057     Base_endowmentMV = investment_office.smoothed_endowment_value + investment_office.smoothed_quasi_endowment_value;
01058 
01059     Base_OpResBalance = finance.this_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>];
01060     ST_int_rate_01Aug = (float)finance.short_term_debt_interest_history[THIS_MONTH-1] / 100.0f;
01061     ST_int_rate_31Aug = (float)finance.short_term_debt_interest_history[THIS_MONTH] / 100.0f;
01062     <span class="comment">//initialization</span>
01063     New_Debt_service = (info.prerun_year &amp;&amp; info.game_year == 1)
01064         ? finance.expense_array[<a class="code" href="Ofinance_8h.html#a104a55">AC_SERVICE_ON_GENERAL_PLANT_DEBT</a>].total
01065         : finance.projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a55">AC_SERVICE_ON_GENERAL_PLANT_DEBT</a>].next_year.total;
01066 }
01067 <span class="preprocessor">#endif</span>
01068 <span class="preprocessor"></span>
01069 <span class="comment">//---------- Begin of function Finance::init -----------//</span>
<a name="l01071"></a><a class="code" href="classFinance.html#a2">01071</a> <span class="comment">void Finance::init() {</span>
01072     memset( <span class="keyword">this</span>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classFinance.html">Finance</a>) );
01073 
01074     fiscal_year_start_month = 9;
01075     fiscal_year_end_month = 8;
01076 
01077     <span class="comment">//---- fully exogenous factors -----//</span>
01078 
01079     inflation_rate          = 0.0;                  <span class="comment">// 0222     3.0;                            // C72</span>
01080     short_term_debt_interest  = 3.0;                <span class="comment">// 0406     3.0;</span>
01081     long_term_debt_interest   = 6.0;                <span class="comment">// 0406     6.0;</span>
01082     debt_fraction_repaid_annually = 4.0;
01083     family_income_growth        = 0.0;
01084     construction_cost_growth    = 3.0;
01085 
01086     building_life_for_calc_depreciation = 50;       <span class="comment">// G80</span>
01087 
01088     <span class="comment">//--- exogenous, but may be influenced by the player ---//</span>
01089 
01090     investment_office.expected_real_annual_return_rate = 7.0f;  endowment_return = 7.0;
01091     sponsored_research_growth   = 0.0;
01092     gifts_growth            = 0.0;
01093     athletics_revenue_growth    = 0.0;              <span class="comment">// G75</span>
01094     bank_debt_interest        = 5.0;
01095     other_expense_growth        = 0.5;
01096     other_income_growth       = 0.0;
01097 
01098     <span class="comment">//--------- time variation variable 1017 --------//</span>
01099     <span class="comment">//------- initialization ("design notes 0830 section8.2)</span>
01100 
01101     <span class="keywordtype">float</span> rate = m.fmax(.01f, math.get_random_snd(.04f, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(.01f))) / 12;
01102 
01103     <span class="comment">//inflation_rate_hist.init(FA_HISTORY_YEAR, rate);</span>
01104     inflation_rate_hist.init(<a class="code" href="OHISTORY_8H.html#a1a0">FA_HISTORY_YEAR</a>, 0);   <span class="comment">//0222</span>
01105     inflation_rate = inflation_rate_hist.get_sum();
01106 
01107     <a class="code" href="ALL_8H.html#a0">err_when</a>(inflation_rate  != 0);
01108 
01109     <span class="comment">//------------------------------------------------//</span>
01110     <span class="comment">// ----- init player input for stage1       ----- //</span>
01111     <span class="comment">//------------------------------------------------//</span>
01112 
01113     <span class="keywordtype">int</span> i;
01114 
01115     <span class="comment">//--------//</span>
01116     revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>].lower_limit = -5;
01117     revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a66">PL_FINANCIAL_AID</a>].lower_limit = -5;
01118     revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a67">PL_ENDOWMENT_SPENDING_RATE</a>].lower_limit = 4;
01119     revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>].lower_limit = 20;
01120 
01121     expense_policy_array[0].lower_limit = 0.0;
01122     expense_policy_array[1].lower_limit = 0.0;
01123     expense_policy_array[2].lower_limit = -5;
01124     expense_policy_array[3].lower_limit = -5;
01125     expense_policy_array[4].lower_limit = -3;
01126 
01127     <span class="comment">//----//</span>
01128     revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>].upper_limit = 5;
01129     revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a66">PL_FINANCIAL_AID</a>].upper_limit = 5;
01130     revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a67">PL_ENDOWMENT_SPENDING_RATE</a>].upper_limit = 10;
01131     revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>].upper_limit = 70;
01132 
01133     expense_policy_array[0].upper_limit = 5.0;
01134     expense_policy_array[1].upper_limit = 5.0;
01135     expense_policy_array[2].upper_limit = 5.0;
01136     expense_policy_array[3].upper_limit = 5.0;
01137     expense_policy_array[4].upper_limit = 3;
01138 
01139     revenue_policy_array[0].max_penalty1 = 10;
01140     revenue_policy_array[1].max_penalty1 = 10;
01141     revenue_policy_array[2].max_penalty1 = 5;
01142     revenue_policy_array[3].max_penalty1 = 20;
01143 
01144     expense_policy_array[0].max_penalty1 = 20;
01145     expense_policy_array[1].max_penalty1 = 20;
01146     expense_policy_array[2].max_penalty1 = 5;
01147     expense_policy_array[3].max_penalty1 = 10;
01148     expense_policy_array[4].max_penalty1 = 20;
01149 
01150     expense_policy_array[0].max_penalty2 = 20;
01151     expense_policy_array[1].max_penalty2 = 20;
01152     expense_policy_array[2].max_penalty2 = 5;
01153     expense_policy_array[3].max_penalty2 = 10;
01154     expense_policy_array[4].max_penalty2 = 20;
01155 
01156     <span class="comment">//max_penalty_effect</span>
01157 
01158     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>; i++) {
01159         <span class="comment">//990506 revenue_policy_array[i].target_value = (revenue_policy_array[i].lower_limit+revenue_policy_array[i].upper_limit) / 2;</span>
01160 
01161         revenue_policy_array[i].lower_bound = revenue_policy_array[i].lower_limit;
01162         revenue_policy_array[i].upper_bound = revenue_policy_array[i].upper_limit;
01163         revenue_policy_array[i].import_weight = <a class="code" href="Ofinanc2_8h.html#a1">OPT_MID_WEIGHT</a>;
01164         revenue_policy_array[i].penalty_multiplier1 = 1;
01165         revenue_policy_array[i].penalty_multiplier2 = 1;
01166 
01167         set_policy_target(<span class="keyword">true</span>, i);
01168     }
01169 
01170     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; i++) {
01171         <span class="comment">// expense_policy_array[i].target_value = (expense_policy_array[i].lower_limit+expense_policy_array[i].upper_limit) / 2;</span>
01172 
01173         expense_policy_array[i].lower_bound = expense_policy_array[i].lower_limit;
01174         expense_policy_array[i].upper_bound = expense_policy_array[i].upper_limit;
01175         expense_policy_array[i].import_weight = <a class="code" href="Ofinanc2_8h.html#a1">OPT_MID_WEIGHT</a>;
01176         expense_policy_array[i].penalty_multiplier1 = 1;
01177         expense_policy_array[i].penalty_multiplier2 = 1;
01178 
01179         set_policy_target(<span class="keyword">false</span>, i);
01180     }
01181 
01182     <span class="comment">//---------//</span>
01183 
01184     revenue_policy_array[0].lower_bound = 0;        <span class="comment">// 990518; temp fix for 2.6.2 and 5.1.1</span>
01185 
01186     <span class="comment">//---------//</span>
01187     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>; i++) {
01188         revenue_policy_array[i].reset_change(<span class="keyword">true</span>);
01189         revenue_policy_array[i].bound_correction();   <span class="comment">//## chea 310899 try not using all the bound_correction</span>
01190         revenue_policy_array[i].penalty_direction = <a class="code" href="Ofinance_8h.html#a95a17">NEGATIVE</a>;
01191     }
01192 
01193     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; i++) {
01194         expense_policy_array[i].reset_change(<span class="keyword">true</span>);
01195         expense_policy_array[i].bound_correction();   <span class="comment">//## chea 310899 try not using all the bound_correction</span>
01196         expense_policy_array[i].penalty_direction = <a class="code" href="Ofinance_8h.html#a95a17">NEGATIVE</a>;
01197     }
01198 
01199     revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>].penalty_direction = <a class="code" href="Ofinance_8h.html#a95a16">POSITIVE</a>;
01200     revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>].penalty_direction = <a class="code" href="Ofinance_8h.html#a95a16">POSITIVE</a>;
01201 
01202     <span class="comment">//</span>
01203     <span class="comment">// ----- for stage2 ----- //</span>
01204     <span class="comment">//</span>
01205 
01206     cost_rise_policy_array[0].target_value = 0.0;
01207     cost_rise_policy_array[1].target_value = 0.0;
01208     cost_rise_policy_array[2].target_value = 0.0;
01209     cost_rise_policy_array[3].target_value = 0.0;
01210     cost_rise_policy_array[4].target_value = 0.0;
01211 
01212     cost_rise_policy_array[5].target_value = 0.0;
01213     cost_rise_policy_array[6].target_value = 0.0;
01214     cost_rise_policy_array[7].target_value = 0.0;
01215     cost_rise_policy_array[8].target_value = 0.0;
01216     cost_rise_policy_array[9].target_value = 0.0;
01217 
01218     cost_rise_policy_array[0].lower_bound = -5;
01219     cost_rise_policy_array[1].lower_bound = -5;
01220     cost_rise_policy_array[2].lower_bound = -5;
01221     cost_rise_policy_array[3].lower_bound = -5;
01222     cost_rise_policy_array[4].lower_bound = -5;
01223 
01224     cost_rise_policy_array[5].lower_bound = -5;
01225     cost_rise_policy_array[6].lower_bound = -5;
01226     cost_rise_policy_array[7].lower_bound = -5;
01227     cost_rise_policy_array[8].lower_bound = -5;
01228     cost_rise_policy_array[9].lower_bound = -5;
01229 
01230     cost_rise_policy_array[0].upper_bound = 5;
01231     cost_rise_policy_array[1].upper_bound = 5;
01232     cost_rise_policy_array[2].upper_bound = 5;
01233     cost_rise_policy_array[3].upper_bound = 5;
01234     cost_rise_policy_array[4].upper_bound = 5;
01235 
01236     cost_rise_policy_array[5].upper_bound = 5;
01237     cost_rise_policy_array[6].upper_bound = 5;
01238     cost_rise_policy_array[7].upper_bound = 5;
01239     cost_rise_policy_array[8].upper_bound = 5;
01240     cost_rise_policy_array[9].upper_bound = 5;
01241 
01242     cost_rise_policy_array[0].max_penalty1 = 5;
01243     cost_rise_policy_array[1].max_penalty1 = 10;
01244     cost_rise_policy_array[2].max_penalty1 = 5;
01245     cost_rise_policy_array[3].max_penalty1 = 50;
01246     cost_rise_policy_array[4].max_penalty1 = 5;
01247 
01248     cost_rise_policy_array[5].max_penalty1 = 5;
01249     cost_rise_policy_array[6].max_penalty1 = 50;
01250     cost_rise_policy_array[7].max_penalty1 = 10;
01251     cost_rise_policy_array[8].max_penalty1 = 10;
01252     cost_rise_policy_array[9].max_penalty1 = 50;
01253 
01254     cost_rise_policy_array[0].max_penalty2 = 0;
01255     cost_rise_policy_array[1].max_penalty2 = 0;
01256     cost_rise_policy_array[2].max_penalty2 = 5;
01257     cost_rise_policy_array[3].max_penalty2 = 10;
01258     cost_rise_policy_array[4].max_penalty2 = 0;
01259 
01260     cost_rise_policy_array[5].max_penalty2 = 50;
01261     cost_rise_policy_array[6].max_penalty2 = 0;
01262     cost_rise_policy_array[7].max_penalty2 = 0;
01263     cost_rise_policy_array[8].max_penalty2 = 0;
01264     cost_rise_policy_array[9].max_penalty2 = 0;
01265 
01266     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; i++) {
01267         cost_rise_policy_array[i].lower_limit = -5.0;
01268         cost_rise_policy_array[i].upper_limit = 5.0;
01269         cost_rise_policy_array[i].import_weight = <a class="code" href="Ofinanc2_8h.html#a1">OPT_MID_WEIGHT</a>;
01270         cost_rise_policy_array[i].penalty_multiplier1 = 1;
01271         cost_rise_policy_array[i].penalty_multiplier2 = 1;
01272     }
01273 
01274     <span class="comment">//---------//</span>
01275     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; i++) {
01276         cost_rise_policy_array[i].bound_correction(); <span class="comment">//## chea 310899 try not using all the bound_correction</span>
01277         cost_rise_policy_array[i].reset_change(<span class="keyword">true</span>);
01278         cost_rise_policy_array[i].penalty_direction = <a class="code" href="Ofinance_8h.html#a95a17">NEGATIVE</a>;
01279     }
01280 }
01281 
01282 <span class="comment">//---------- End of function Finance::init -----------//</span>
01283 
01284 <span class="comment">//---------- Begin of function Finance::deinit -----------//</span>
<a name="l01286"></a><a class="code" href="classFinance.html#a3">01286</a> <span class="comment">void Finance::deinit() {</span>
01287 
01288 }
01289 
01290 <span class="comment">//---------- End of function Finance::deinit -----------//</span>
01291 
01292 <span class="comment">//---------- Begin of function Finance::init_data -----------//</span>
<a name="l01300"></a><a class="code" href="classFinance.html#a6">01300</a> <span class="comment">void Finance::init_data_pre_enroll() {            // 1228</span>
01301     <a class="code" href="classPeerSchool.html">PeerSchool</a> *playerSchoolEx = school_res.player_peer_school;
01302 
01303     <span class="comment">//---------------------------------------------------//</span>
01304 
01305     tuition_rate = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m44">tuition_rate</a>;
01306 }
01307 
<a name="l01308"></a><a class="code" href="classFinance.html#a7">01308</a> <span class="keywordtype">void</span> <a class="code" href="classFinance.html#a7">Finance::init_data</a>() {
01309     <span class="keywordtype">int</span> i;
01310     <a class="code" href="classPeerSchool.html">PeerSchool</a> *playerSchoolEx = school_res.player_peer_school;
01311 
01312     <span class="comment">//-----------------------------------------------------------//</span>
01313 
01314     <span class="keywordtype">int</span> totalFacResearchExpense = 0;                <span class="comment">// monthly</span>
01315     <span class="keywordtype">int</span> d;
01316 
01317     <a class="code" href="classDepartment.html">Department</a> *dept;
01318 
01319     <span class="keywordflow">for</span> ( d=department_array.size(); d&gt;0; d-- ) {
01320         <span class="keywordflow">if</span> ( department_array.is_deleted(d) )
01321             <span class="keywordflow">continue</span>;
01322 
01323         dept = department_array[d];
01324 
01325         dept-&gt;<a class="code" href="classDepartment.html#a25">calc_research_dollar</a>();
01326 
01327         <span class="comment">//## chea 221199</span>
01328         <span class="comment">//              totalFacResearchExpense += dept-&gt;total_research_dollar;</span>
01329         totalFacResearchExpense += dept-&gt;<a class="code" href="classDepartment.html#m5">total_research_dollar</a> /1000;
01330     }
01331 
01332     <span class="keywordtype">int</span> totalResearchExpense = 0;
01333 
01334     <span class="comment">//0219      // 990421</span>
01335     totalResearchExpense = int( 12 * totalFacResearchExpense );
01336 
01337     <span class="comment">//------------ initialize balance sheet -------------//</span>
01338 
01339     memset( <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>) );
01340     memset( <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m2">liability_array</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m2">liability_array</a>) );
01341 
01342     <span class="comment">// 0305</span>
01343     <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>] = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m1">operating_reserve</a> * 1.3;
01344 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01345 <span class="preprocessor"></span>    <a class="code" href="classFinance.html#m18">this_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>]  = <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>];
01346 <span class="preprocessor">#endif</span>
01347 <span class="preprocessor"></span>    <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]       = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m2">endowment_market</a>;
01348     <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a23">AC_BUILDINGS</a>]       = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m3">buildings</a>;
01349     <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a21">AC_CAPITAL_RESERVE</a>]   = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m4">capital_reserve</a>;
01350     <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a24">AC_RESIDENCE</a>]       = 0;
01351     investment_office.smoothed_endowment_value = (float) finance.last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>];
01352 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01353 <span class="preprocessor"></span>    investment_office.smoothed_quasi_endowment_value = (float) finance.last_year.asset_array[AC_QUASI];
01354 <span class="preprocessor">#endif</span>
01355 <span class="preprocessor"></span>
01356 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01357 <span class="preprocessor"></span>    <span class="keywordtype">float</span> randomNo = (float)m.random(100);
01358     randomNo /= 4*100;                              <span class="comment">// randomNo ( 0-&gt;0.25 )</span>
01359     <span class="comment">//BUGHERE Kenneth</span>
01360     <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[AC_QUASI]         = <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]*randomNo;
01361     <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]       *= (1-randomNo);
01362 
01363     <a class="code" href="classFinance.html#m18">this_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[AC_QUASI]         = <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[AC_QUASI];
01364     <a class="code" href="classFinance.html#m18">this_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]       = <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>];
01365 
01366     endowment_quasi_ratio = randomNo;
01367 <span class="preprocessor">#endif</span>
01368 <span class="preprocessor"></span>
01369     <a class="code" href="ALL_8H.html#a0">err_when</a>(playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m5">general_plant_debt</a> &lt; 1);
01370     <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m2">liability_array</a>[<a class="code" href="Ofinance_8h.html#a99a27">AC_GENERAL_PLANT_DEBT</a>]  = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m5">general_plant_debt</a>;
01371     <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m2">liability_array</a>[<a class="code" href="Ofinance_8h.html#a99a28">AC_RESIDENCE_HALL_DEBT</a>] = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m6">residence_hall_debt</a>;
01372 
01373     <span class="comment">//------------ initialize revenue data -------------//</span>
01374 
01375     memset( <a class="code" href="classFinance.html#m3">revenue_array</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classFinance.html#m3">revenue_array</a>) );
01376     memset( <a class="code" href="classFinance.html#m4">expense_array</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classFinance.html#m4">expense_array</a>) );
01377 
01378     <span class="comment">// 0118; old: playerSchoolEx-&gt;gross_tuition_revenue;</span>
01379     <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].total    = enroll_res.total_student_count * <a class="code" href="classFinance.html#m30">tuition_rate</a> / 1000;
01380 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01381 <span class="preprocessor"></span>    <span class="comment">// 0118; old: playerSchoolEx-&gt;financial_aid;</span>
01382     <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].total         = -(enroll_res.total_aid)*0.3;
01383 <span class="preprocessor">#else</span>
01384 <span class="preprocessor"></span>    <span class="comment">// 0118; old: playerSchoolEx-&gt;financial_aid;</span>
01385     <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].total         = - enroll_res.total_aid;
01386 <span class="preprocessor">#endif</span>
01387 <span class="preprocessor"></span>    <span class="comment">// playerSchoolEx-&gt;net_tuition_revenue;</span>
01388     <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>].total      = <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].total + <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].total;
01389 
01390     <span class="comment">// 0118</span>
01391     <a class="code" href="classFinance.html#m60">revenue_policy_array</a>[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>].result_value = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m48">overhead_rate_on_sponsored_research</a>;
01392     <span class="comment">//## chea 310899 try not using all the bound_correction</span>
01393     <a class="code" href="classFinance.html#m60">revenue_policy_array</a>[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>].bound_correction();
01394 
01395     <span class="comment">//--------------------------//</span>
01396     <span class="comment">// 990527</span>
01397 
01398     <a class="code" href="structFinancePolicy.html">FinancePolicy</a>* policy;
01399 
01400     policy = &amp;<a class="code" href="classFinance.html#m60">revenue_policy_array</a>[<a class="code" href="Ofinance_8h.html#a108a67">PL_ENDOWMENT_SPENDING_RATE</a>];
01401 
01402     policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a> = policy-&gt;<a class="code" href="structFinancePolicy.html#m5">result_value</a> = 5;
01403     policy-&gt;<a class="code" href="structFinancePolicy.html#a1">bound_correction</a>();                     <span class="comment">//## chea 310899 try not using all the bound_correction</span>
01404 
01405     <span class="comment">//-------------------------//</span>
01406 
01407     <span class="comment">//playerSchoolEx-&gt;sponsored_research;</span>
01408     <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].total  = totalResearchExpense;
01409     <span class="comment">//playerSchoolEx-&gt;sponsored_research / (1+playerSchoolEx-&gt;overhead_rate_on_sponsored_research/100.0);</span>
01410     <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].direct = totalResearchExpense  / ( 1 + <a class="code" href="classFinance.html#a0">get_research_overhead_rate</a>() / 100.0);
01411     <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].indirect = totalResearchExpense - <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].direct;
01412 
01413     <span class="comment">//## chea testing....</span>
01414     <span class="comment">//  revenue_array[AC_SPONSORED_RESEARCH_REVENUE].total      = 0;    //playerSchoolEx-&gt;sponsored_research;</span>
01415     <span class="comment">//  revenue_array[AC_SPONSORED_RESEARCH_REVENUE].direct     = 0;    //playerSchoolEx-&gt;sponsored_research / (1+playerSchoolEx-&gt;overhead_rate_on_sponsored_research/100.0);</span>
01416     <span class="comment">//  revenue_array[AC_SPONSORED_RESEARCH_REVENUE].indirect   = 0;;</span>
01417 
01418     <span class="comment">// or = gifts_to_operations</span>
01419     <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a36">AC_GIFTS</a>].total               = playerSchoolEx-&gt;<a class="code" href="classSchool.html#m42">total_gifts</a>;
01420     <span class="comment">// or = endowment_spending          // Or should we use the equation in file_ex instead?</span>
01421     <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].total      = playerSchoolEx-&gt;<a class="code" href="classSchool.html#m40">raw_endowment_spending</a>;
01422 
01423     <span class="comment">//## chea begin 080699 5.2.1</span>
01424     <span class="comment">//revenue_array[AC_ENDOWMENT_SPENDING].total= last_year.asset_array[AC_ENDOWMENT] * (revenue_policy_array[PL_ENDOWMENT_SPENDING_RATE].result_value / 100);</span>
01425     <span class="comment">//  last_year.asset_array[AC_ENDOWMENT]     = ((1+inflation_rate+0.06-0.05)*revenue_array[AC_ENDOWMENT_SPENDING].total)/0.05;</span>
01426     investment_office.smoothed_endowment_value = (float) finance.last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>];
01427     <span class="comment">//## chea end 080699 5.2.1</span>
01428 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01429 <span class="preprocessor"></span>    investment_office.smoothed_quasi_endowment_value = (float) finance.last_year.asset_array[AC_QUASI];
01430 <span class="preprocessor">#endif</span>
01431 <span class="preprocessor"></span>
01432     <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a38">AC_INTERCOLLEGIATE_ATHLETICS</a>].total = playerSchoolEx-&gt;<a class="code" href="classSchool.html#m44">athletics_revenue</a>;
01433     <span class="comment">// or = playerSchoolEx-&gt;raw_other_operating_income ?</span>
01434     <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].total    = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m16">other_operating_income</a>;
01435     <span class="comment">// playerSchoolEx-&gt;interest_on_operating_reserve;</span>
01436     <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a40">AC_INTEREST_EARNED_OR_PAID</a>].total   = <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>] * <a class="code" href="classFinance.html#m36">short_term_debt_interest</a> / 100.0;
01437 
01438     <span class="keywordflow">if</span> ( player_school.is_public() )
01439         <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].total   = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m11">state_appropriations</a>;
01440     <span class="keywordflow">else</span>
01441         <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].total   = 0;
01442 
01443     <span class="comment">//---------- initialize expenditure data -----------//</span>
01444 
01445     <span class="comment">// 0118; old: playerSchoolEx-&gt;dept_expense_faculty_salaries;</span>
01446     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].faculty = <a class="code" href="classFinance.html#a38">calc_total_faculty_salary</a>();
01447 
01448     <span class="comment">// 0118</span>
01449     <span class="keywordtype">double</span> ratio = <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].faculty / playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m19">dept_expense_faculty_salaries</a>;
01450 
01451     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].staff   = ratio * playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m20">dept_expense_staff_salaries</a>;
01452     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].other   = ratio * playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m21">dept_expense_other</a>;
01453 
01454     <span class="comment">// 0118: see notes 990114, point 5 for this new ini method</span>
01455 
01456     <span class="keywordtype">double</span> directRev = <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].direct;
01457 
01458     <span class="keywordtype">double</span> tmp = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m22">sponsored_research_faculty_salaries</a>
01459         + playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m23">sponsored_research_staff_salaries</a>
01460         + playerSchoolEx-&gt;<a class="code" href="classSchool.html#m52">sponsored_research_other_expense</a>;
01461 
01462     <span class="keywordflow">if</span>(tmp==0) {                                    <span class="comment">//## chea 091199 research_expense_fac_ratio can be 0</span>
01463         <a class="code" href="classFinance.html#m57">research_expense_fac_ratio</a> = 0;
01464         <a class="code" href="classFinance.html#m58">research_expense_staff_ratio</a> = 0;
01465     }
01466     <span class="keywordflow">else</span> {
01467         <a class="code" href="classFinance.html#m57">research_expense_fac_ratio</a> = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m22">sponsored_research_faculty_salaries</a>/ tmp;
01468         <a class="code" href="classFinance.html#m58">research_expense_staff_ratio</a> = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m23">sponsored_research_staff_salaries</a>/ tmp;
01469     }
01470 
01471     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].faculty = <a class="code" href="classFinance.html#m57">research_expense_fac_ratio</a> * directRev;
01472     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].staff   = <a class="code" href="classFinance.html#m58">research_expense_staff_ratio</a> * directRev;
01473     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].other   = directRev * (1-<a class="code" href="classFinance.html#m57">research_expense_fac_ratio</a>-<a class="code" href="classFinance.html#m58">research_expense_staff_ratio</a>);
01474 
01475     <span class="comment">// new if 1005</span>
01476     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a47">AC_LIBRARIES</a>].staff   = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m25">library_staff_salaries</a>;
01477     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a47">AC_LIBRARIES</a>].other   = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m26">library_other_expense</a>;
01478     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a48">AC_IT_RESOURCES</a>].staff   = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m27">academic_it_staff_salaries</a>;
01479     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a48">AC_IT_RESOURCES</a>].other   = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m28">academic_it_other_expense</a>;
01480 
01481     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a49">AC_STUDENT_LIFE</a>].staff = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m29">student_life_staff_salaries</a>;
01482     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a49">AC_STUDENT_LIFE</a>].other = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m30">student_life_other_expense</a>;
01483 
01484     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a50">AC_ATHLETICS</a>].staff = playerSchoolEx-&gt;<a class="code" href="classSchool.html#m65">athletics_salaries</a>;
01485     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a50">AC_ATHLETICS</a>].other = playerSchoolEx-&gt;<a class="code" href="classSchool.html#m66">athletics_other_expense</a>;
01486 
01487     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a51">AC_INST_ADVANCEMENT</a>].staff = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m31">inst_advancement_staff_salaries</a>;
01488     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a51">AC_INST_ADVANCEMENT</a>].other = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m32">inst_advancement_other_expense</a>;
01489 
01490     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].staff = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m33">administration_staff_salaries</a> + playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m37">other_operating_expense_staff_salaries</a>;
01491     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].other = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m34">administration_other_expense</a> + playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m38">other_operating_expense_other_expense</a>;
01492 
01493     <span class="comment">// 0119 update ONM base on notes 0114</span>
01494 
01495     tmp = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m35">o_and_m_staff_salaries</a> + playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m36">o_and_m_other_expense</a>;
01496     <span class="keywordtype">double</span> stratio = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m35">o_and_m_staff_salaries</a> / tmp;
01497     <span class="keywordtype">float</span> tmpTotal = float(facility_office.total_normal_onm);
01498 
01499     <span class="keywordflow">if</span> ( player_school.relative_wealth == <a class="code" href="Opschool_8h.html#a60a12">WEALTH_RICH</a> )
01500         tmpTotal *= math.get_random_snd(1, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.005f));
01501     <span class="comment">//          tmpTotal *= 20;</span>
01502 
01503     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( player_school.relative_wealth == <a class="code" href="Opschool_8h.html#a60a13">WEALTH_IN_BETWEEN</a> )
01504         tmpTotal *= math.get_random_snd(0.95f, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.01f));
01505     <span class="comment">//          tmpTotal *= 10;</span>
01506 
01507     <span class="keywordflow">else</span>
01508         tmpTotal *= math.get_random_snd(0.60f, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.075f));
01509     <span class="comment">//      tmpTotal *= 1;</span>
01510 
01511     <span class="keywordtype">double</span> staffR = <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a53">AC_OPERATIONS_AND_MAINTENANCE</a>].staff = tmpTotal * stratio;
01512     <span class="keywordtype">double</span> otherR = <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a53">AC_OPERATIONS_AND_MAINTENANCE</a>].other = tmpTotal * (1-stratio);
01513 
01514     <span class="comment">// AC_ENROLLMENT_MANAGEMENT: new item see WFM notes 0918 section 10</span>
01515     <span class="keywordtype">int</span> totalTargetIntake = 0;
01516 
01517     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; i++)
01518         totalTargetIntake += enroll_res.target_student_intake[i];
01519 
01520     <span class="keywordflow">if</span> ( totalTargetIntake &lt;= 0 )                   <span class="comment">// 0118</span>
01521         totalTargetIntake = 1000;                     <span class="comment">// 1228</span>
01522 
01523     <span class="keywordtype">float</span> expensePerAdmit = 1;
01524 
01525     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a54">AC_ENROLLMENT_MANAGEMENT</a>].staff = expensePerAdmit * totalTargetIntake * math.get_random_snd(1.0f, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.1f));
01526     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a54">AC_ENROLLMENT_MANAGEMENT</a>].other = (otherR/(staffR+otherR)) * <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a54">AC_ENROLLMENT_MANAGEMENT</a>].staff;
01527 
01528     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].staff -= <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a54">AC_ENROLLMENT_MANAGEMENT</a>].staff;
01529     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].other -= <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a54">AC_ENROLLMENT_MANAGEMENT</a>].other;
01530 
01531     <span class="comment">// should we initialize this one according to the excel ex file</span>
01532     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a55">AC_SERVICE_ON_GENERAL_PLANT_DEBT</a>].other = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m40">service_on_general_plant_debt</a>;
01533     <span class="comment">//## CHEA 250899</span>
01534     <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>].other = playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m41">transfer_to_capital_reserve</a>;
01535 
01536     <span class="comment">//------- calculate the total of each expense item --------//</span>
01537     <span class="comment">// should we use the equation in file_ex for cell F31 (expense_array[AC_SPONSORED_RESEARCH])</span>
01538 
01539     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a102a43">TOTAL_EXPENSE_ITEM_COUNT</a> ; i++ ) {
01540         <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m3">total</a> = <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m0">faculty</a> + <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m1">staff</a> +
01541             <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m2">other</a>;
01542     }
01543 
01544     <span class="comment">//---------------------------------------// 1229; by WFM notes 1222</span>
01545 
01546     <span class="comment">//## chea begin "special case" when spon.=none 070699 5.1.4</span>
01547     <span class="keywordflow">if</span> ( player_school.sponsored_research_intensity &lt;= 0 ) {
01548         <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].direct=0;
01549         <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].indirect=0;
01550         <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].total=0;
01551         <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].percent=0;
01552 
01553         <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].faculty=0;
01554         <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].staff=0;
01555         <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].other=0;
01556         <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].total=0;
01557         <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].percent=0;
01558     }
01559 
01560     <span class="keywordtype">float</span> maxRate = float(<a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].total );
01561 
01562     <span class="comment">// 990527</span>
01563     maxRate = float(maxRate) *100 / float(maxRate + <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].total);
01564 
01565     <span class="comment">//## chea begin 070699 14.1.5 2nd change</span>
01566     <a class="code" href="classFinance.html#a29">calc_total_last_year</a>();                         <span class="comment">// calculate total_operating_expense for use here so no need to call at "spec1" below</span>
01567 
01568     policy = &amp;<a class="code" href="classFinance.html#m60">revenue_policy_array</a>[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>];
01569 
01570     <span class="keywordflow">if</span> ( policy-&gt;<a class="code" href="structFinancePolicy.html#m2">upper_bound</a> &gt; maxRate ) {
01571         <span class="comment">//policy-&gt;upper_bound = maxRate; //## chea fed ori.</span>
01572         policy-&gt;<a class="code" href="structFinancePolicy.html#m2">upper_bound</a> =((<a class="code" href="classFinance.html#m6">total_operating_expense</a>.<a class="code" href="structExpenseItem.html#m3">total</a>-<a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].total- <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].total)/<a class="code" href="classFinance.html#m6">total_operating_expense</a>.<a class="code" href="structExpenseItem.html#m3">total</a>)*100;
01573         policy-&gt;<a class="code" href="structFinancePolicy.html#a1">bound_correction</a>();                   <span class="comment">//## chea 310899 try not using all the bound_correction</span>
01574     }
01575     <span class="comment">//## chea end 070699 14.1.5 2nd change</span>
01576 
01577     <span class="comment">//policy-&gt;result_value = policy-&gt;target_value = ( policy-&gt;upper_bound + policy-&gt;lower_bound ) / 2;//## chea fed ori.</span>
01578     <span class="comment">//## chea 040699 1st change</span>
01579     policy-&gt;<a class="code" href="structFinancePolicy.html#m5">result_value</a> = policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a> = policy-&gt;<a class="code" href="structFinancePolicy.html#m2">upper_bound</a>;
01580 
01581     <span class="comment">// 990527 revenue_array[AC_SPONSORED_RESEARCH_REVENUE].indirect     = min(revenue_array[AC_SPONSORED_RESEARCH_REVENUE].indirect, maxRate * revenue_array[AC_SPONSORED_RESEARCH_REVENUE].direct / 100);</span>
01582     <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].indirect =  policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a> * <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].direct / 100;
01583     <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].total  = <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].indirect + <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].direct;
01584 
01585     <span class="comment">//______init Surplus or deficit-------------//</span>
01586 
01587     policy = &amp;<a class="code" href="classFinance.html#m61">expense_policy_array</a>[<a class="code" href="Ofinance_8h.html#a110a74">PL_SURPLUS_DEFICIT</a>];
01588     <span class="comment">//  policy-&gt;upper_bound =(finance.last_year.surplus_deficit/total_expense.total)*100;</span>
01589     policy-&gt;<a class="code" href="structFinancePolicy.html#a1">bound_correction</a>();                     <span class="comment">//## chea 310899 try not using all the bound_correction</span>
01590 
01591     <span class="comment">//----- Surplus or deficit = set optimization target value for surplus/deficit for the first running year based on Relative Weatlh setting ----//</span>
01592 
01593     <span class="keywordflow">switch</span>(player_school.relative_wealth) {
01594     <span class="keywordflow">case</span> <a class="code" href="Opschool_8h.html#a60a12">WEALTH_RICH</a>:
01595         policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a> = 2.0f;
01596         <span class="keywordflow">break</span>;
01597 
01598     <span class="keywordflow">case</span> <a class="code" href="Opschool_8h.html#a60a13">WEALTH_IN_BETWEEN</a>:
01599         policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a> = 0.0f;
01600         <span class="keywordflow">break</span>;
01601 
01602     <span class="keywordflow">case</span> <a class="code" href="Opschool_8h.html#a60a14">WEALTH_STRUGGLING</a>:
01603         policy-&gt;<a class="code" href="structFinancePolicy.html#m0">target_value</a> = -2.0f;
01604         <span class="keywordflow">break</span>;
01605     }
01606 
01607     <span class="comment">//--------- special case: scenario ---------//</span>
01608 
01609     <span class="keywordflow">switch</span> ( player_school.scenario_id ) {
01610     <span class="keywordflow">case</span> ( SCN_WINNING_ATHLETICS ):
01611         <a class="code" href="classFinance.html#m3">revenue_array</a>[<a class="code" href="Ofinance_8h.html#a101a38">AC_INTERCOLLEGIATE_ATHLETICS</a>].total *= 0.5;
01612         <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a50">AC_ATHLETICS</a>].staff *= 0.5;
01613         <a class="code" href="classFinance.html#m4">expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a50">AC_ATHLETICS</a>].other *= 0.5;
01614 
01615         i = <a class="code" href="Ofinance_8h.html#a104a50">AC_ATHLETICS</a>;
01616         <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m3">total</a> = <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m0">faculty</a> + <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m1">staff</a> +
01617             <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m2">other</a>;
01618         <span class="keywordflow">break</span>;
01619 
01620     <span class="keywordflow">case</span> ( SCN_LIMIT_TUITION_GROWTH ):
01621         <a class="code" href="classFinance.html#m60">revenue_policy_array</a>[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>].upper_limit = 0;
01622         <a class="code" href="classFinance.html#m60">revenue_policy_array</a>[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>].upper_bound = 0;
01623         <a class="code" href="classFinance.html#m60">revenue_policy_array</a>[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>].lower_limit = -5.0f;
01624         <a class="code" href="classFinance.html#m60">revenue_policy_array</a>[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>].lower_bound = -5.0f;
01625         <a class="code" href="classFinance.html#m60">revenue_policy_array</a>[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>].target_value = 0;
01626         <span class="comment">//## chea 310899 try not using all the bound_correction</span>
01627         <a class="code" href="classFinance.html#m60">revenue_policy_array</a>[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>].bound_correction();
01628         player_school.scenario_base = <a class="code" href="classFinance.html#m30">tuition_rate</a>;
01629         <span class="keywordflow">break</span>;
01630     }
01631 
01632     <span class="comment">//--------- calculate the total ---------//</span>
01633 
01634     <a class="code" href="classFinance.html#a29">calc_total_last_year</a>();
01635 
01636     <span class="comment">//---- input affected by other models ----//</span>
01637 
01638     <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="classFinance.html#m30">tuition_rate</a> &lt; 1000);                  <span class="comment">// this the model's main income!!!</span>
01639 
01640     <span class="comment">//---------------------------------------//</span>
01641     <span class="comment">// Section 5.3 Interest Rates "WFM notes 0919":</span>
01642     <span class="comment">// Section 8.6 of the Note of 30 August is hereby AMENDED so that</span>
01643     <span class="comment">// the short-term real interest rate for positive operating reserves ("Bank rate")</span>
01644     <span class="comment">// is subject to random variation. The figure given there (0.5%) should be used as</span>
01645     <span class="comment">// the initialization value. The borrowing rate will always be 4 percentage points</span>
01646     <span class="comment">// greater than the bank rate.</span>
01647 
01648     <span class="keywordtype">double</span> opReserve = <a class="code" href="classFinance.html#m20">last_year</a>.<a class="code" href="structYearReport.html#m1">asset_array</a>[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>];
01649     <a class="code" href="classFinance.html#m32">base_short_term_debt_interest</a> = (opReserve&gt;0) ? <a class="code" href="classFinance.html#m35">inflation_rate</a> + <a class="code" href="classFinance.html#m36">short_term_debt_interest</a> : <a class="code" href="classFinance.html#m35">inflation_rate</a> + 4.5;
01650     <a class="code" href="classFinance.html#m33">base_long_term_debt_interest</a>  = <a class="code" href="classFinance.html#m36">short_term_debt_interest</a> + math.get_random_snd(0, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.25f));
01651 
01652     <span class="comment">//---------------------------------------//</span>
01653     <span class="comment">//---------------------------------------//</span>
01654 
01655     <span class="comment">//---------// 0407</span>
01656 
01657     <span class="keywordflow">for</span> (i=department_array.department_count-1; i&gt;=0; i--) {
01658         <a class="code" href="classFinance.html#m63">hiring_policy_array</a>[i].<a class="code" href="structHiringPolicy.html#m0">upper_bound</a> = <a class="code" href="Ofinanc2_8h.html#a4">MAX_S3_SLIDER</a>;
01659         <a class="code" href="classFinance.html#m63">hiring_policy_array</a>[i].<a class="code" href="structHiringPolicy.html#m2">target_value</a> = 1;
01660         <a class="code" href="classFinance.html#m63">hiring_policy_array</a>[i].<a class="code" href="structHiringPolicy.html#m3">result_value</a> = 0;
01661         <a class="code" href="classFinance.html#m63">hiring_policy_array</a>[i].<a class="code" href="structHiringPolicy.html#m1">weight</a> = <a class="code" href="Ofinanc2_8h.html#a1">OPT_MID_WEIGHT</a>;
01662     }
01663 
01664     <span class="comment">//---------------------------------------//</span>
01665     <span class="comment">// run optimizations</span>
01666 
01667     <span class="comment">//----------------- scenario special handling --------------//</span>
01668 
01669     <span class="keywordflow">if</span>( player_school.scenario_id == <a class="code" href="Opschool_8h.html#a63a31">SCN_BALANCE_BUDGET</a> ) {
01670         <a class="code" href="classFinance.html#m61">expense_policy_array</a>[<a class="code" href="Ofinance_8h.html#a110a74">PL_SURPLUS_DEFICIT</a>].target_value =
01671             <span class="comment">// set it to the lowest</span>
01672             <a class="code" href="classFinance.html#m61">expense_policy_array</a>[<a class="code" href="Ofinance_8h.html#a110a74">PL_SURPLUS_DEFICIT</a>].lower_limit;
01673     }
01674 
01675     <span class="comment">//---------------------------------------------------//</span>
01676 
01677     finance.process_budget();
01678 
01679     department_array.salary_setting();              <span class="comment">// 990528</span>
01680     department_array.faculty_hiring();              <span class="comment">// 990528</span>
01681     <a class="code" href="classFinance.html#a38">calc_total_faculty_salary</a>();                    <span class="comment">// 990528</span>
01682 
01683     <span class="comment">//----- update projected_array's year_to_date according to ratioMonthLeft -----//</span>
01684 
01685     <span class="keywordflow">if</span> (  info.game_month &gt;= <a class="code" href="classFinance.html#m0">fiscal_year_start_month</a> )
01686         <a class="code" href="classFinance.html#m53">month_left</a> = (12 - info.game_month + <a class="code" href="classFinance.html#m0">fiscal_year_start_month</a>);
01687     <span class="keywordflow">else</span>
01688         <a class="code" href="classFinance.html#m53">month_left</a> = (- info.game_month + <a class="code" href="classFinance.html#m0">fiscal_year_start_month</a>);
01689 
01690     <span class="comment">// IMPORTANT asumption: the start date of a game is</span>
01691     <span class="comment">// equal to the start of financial year.</span>
01692     <span class="comment">//</span>
01693     <span class="comment">// prepare data for update_projected_arrays_monthly_sub() later</span>
01694     <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="classFinance.html#m53">month_left</a> != 12);
01695 
01696     <span class="keywordtype">float</span> ratioMonth = (12-<a class="code" href="classFinance.html#m53">month_left</a>) / 12.0f;
01697 
01698     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a> ; i++ ) {
01699         <a class="code" href="classFinance.html#m13">projected_revenue_array</a>[i].<a class="code" href="structRevenueItemChange.html#m5">year_to_date</a>.<a class="code" href="structRevenueItem.html#m0">direct</a> = ratioMonth * <a class="code" href="classFinance.html#m3">revenue_array</a>[i].<a class="code" href="structRevenueItem.html#m0">direct</a>;
01700         <a class="code" href="classFinance.html#m13">projected_revenue_array</a>[i].<a class="code" href="structRevenueItemChange.html#m5">year_to_date</a>.<a class="code" href="structRevenueItem.html#m1">indirect</a> = ratioMonth * <a class="code" href="classFinance.html#m3">revenue_array</a>[i].<a class="code" href="structRevenueItem.html#m1">indirect</a>;
01701         <a class="code" href="classFinance.html#m13">projected_revenue_array</a>[i].<a class="code" href="structRevenueItemChange.html#m5">year_to_date</a>.<a class="code" href="structRevenueItem.html#m2">total</a> = ratioMonth * <a class="code" href="classFinance.html#m3">revenue_array</a>[i].<a class="code" href="structRevenueItem.html#m2">total</a>;
01702 
01703         <a class="code" href="classFinance.html#m13">projected_revenue_array</a>[i].<a class="code" href="structRevenueItemChange.html#m4">last_month</a>.<a class="code" href="structRevenueItem.html#m0">direct</a> = <a class="code" href="classFinance.html#m8">budget_revenue_array</a>[i].<a class="code" href="structRevenueItem.html#m0">direct</a> / 12.0;
01704         <a class="code" href="classFinance.html#m13">projected_revenue_array</a>[i].<a class="code" href="structRevenueItemChange.html#m4">last_month</a>.<a class="code" href="structRevenueItem.html#m1">indirect</a> = <a class="code" href="classFinance.html#m8">budget_revenue_array</a>[i].<a class="code" href="structRevenueItem.html#m1">indirect</a> / 12.0;
01705         <a class="code" href="classFinance.html#m13">projected_revenue_array</a>[i].<a class="code" href="structRevenueItemChange.html#m4">last_month</a>.<a class="code" href="structRevenueItem.html#m2">total</a> = <a class="code" href="classFinance.html#m8">budget_revenue_array</a>[i].<a class="code" href="structRevenueItem.html#m2">total</a> / 12.0;
01706         <span class="comment">// 990526 990422  projected_revenue_array[i].last_month.total = revenue_array[i].total / 12.0;</span>
01707     }
01708 
01709     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a> ; i++ ) {
01710         <a class="code" href="classFinance.html#m14">projected_expense_array</a>[i].<a class="code" href="structExpenseItemChange.html#m5">year_to_date</a>.<a class="code" href="structExpenseItem.html#m0">faculty</a> = ratioMonth * <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m0">faculty</a>;
01711         <a class="code" href="classFinance.html#m14">projected_expense_array</a>[i].<a class="code" href="structExpenseItemChange.html#m5">year_to_date</a>.<a class="code" href="structExpenseItem.html#m1">staff</a> = ratioMonth * <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m1">staff</a>;
01712         <a class="code" href="classFinance.html#m14">projected_expense_array</a>[i].<a class="code" href="structExpenseItemChange.html#m5">year_to_date</a>.<a class="code" href="structExpenseItem.html#m2">other</a> = ratioMonth * <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m2">other</a>;
01713         <a class="code" href="classFinance.html#m14">projected_expense_array</a>[i].<a class="code" href="structExpenseItemChange.html#m5">year_to_date</a>.<a class="code" href="structExpenseItem.html#m3">total</a> = ratioMonth * <a class="code" href="classFinance.html#m4">expense_array</a>[i].<a class="code" href="structExpenseItem.html#m3">total</a>;
01714 
01715         <a class="code" href="classFinance.html#m14">projected_expense_array</a>[i].<a class="code" href="structExpenseItemChange.html#m4">last_month</a>.<a class="code" href="structExpenseItem.html#m0">faculty</a> = <a class="code" href="classFinance.html#m9">budget_expense_array</a>[i].<a class="code" href="structExpenseItem.html#m0">faculty</a> / 12.0;
01716         <a class="code" href="classFinance.html#m14">projected_expense_array</a>[i].<a class="code" href="structExpenseItemChange.html#m4">last_month</a>.<a class="code" href="structExpenseItem.html#m1">staff</a> = <a class="code" href="classFinance.html#m9">budget_expense_array</a>[i].<a class="code" href="structExpenseItem.html#m1">staff</a> / 12.0;
01717         <a class="code" href="classFinance.html#m14">projected_expense_array</a>[i].<a class="code" href="structExpenseItemChange.html#m4">last_month</a>.<a class="code" href="structExpenseItem.html#m2">other</a> = <a class="code" href="classFinance.html#m9">budget_expense_array</a>[i].<a class="code" href="structExpenseItem.html#m2">other</a> / 12.0;
01718         <a class="code" href="classFinance.html#m14">projected_expense_array</a>[i].<a class="code" href="structExpenseItemChange.html#m4">last_month</a>.<a class="code" href="structExpenseItem.html#m3">total</a> = <a class="code" href="classFinance.html#m9">budget_expense_array</a>[i].<a class="code" href="structExpenseItem.html#m3">total</a> / 12.0;
01719     }
01720 
01721     <span class="comment">//----------------------//</span>
01722 
01723     <span class="keyword">const</span> <span class="keywordtype">float</span> perMonth = 1.0f/12.0f;
01724 
01725     <a class="code" href="classFinance.html#m14">projected_expense_array</a>[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].last_month.faculty
01726         = perMonth * <a class="code" href="classFinance.html#m54">total_faculty_salary</a>;            <span class="comment">// 990219</span>
01727 
01728     update_external_factors_monthly();
01729     update_external_factors_yearly();
01730     update_projected_arrays_monthly_sub();          <span class="comment">// which will not call update_external_factors_monthly()</span>
01731 
01732     <span class="comment">//--------------------//</span>
01733     <span class="comment">// 0526</span>
01734 
01735 <span class="preprocessor">#ifdef DEBUG_VC</span>
01736 <span class="preprocessor"></span>
01737     <a class="code" href="classString.html">String</a> s;
01738 
01739     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"\n\n-------- START OF revenue_array --------"</span>);
01740 
01741     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a> ; i++ ) {
01742         s = m.format(<a class="code" href="classFinance.html#m3">revenue_array</a>[i].total);   <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(s);
01743     }
01744 
01745     s = m.format(<a class="code" href="classFinance.html#m5">total_revenue</a>.<a class="code" href="structRevenueItem.html#m2">total</a>);  <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(s);
01746 
01747     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"\n\n-------- START OF expense_array --------"</span>);
01748 
01749     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a> ; i++ ) {
01750         s = m.format(<a class="code" href="classFinance.html#m4">expense_array</a>[i].total);   <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(s);
01751     }
01752 
01753     s = m.format(<a class="code" href="classFinance.html#m7">total_expense</a>.<a class="code" href="structExpenseItem.html#m3">total</a>);  <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(s);
01754 
01755     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"\n\n-------- START OF budget_revenue_array --------"</span>);
01756 
01757     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a> ; i++ ) {
01758         s = m.format(<a class="code" href="classFinance.html#m8">budget_revenue_array</a>[i].total);    <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(s);
01759     }
01760 
01761     s = m.format(<a class="code" href="classFinance.html#m10">budget_total_revenue</a>.<a class="code" href="structRevenueItem.html#m2">total</a>); <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(s);
01762 
01763     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"\n\n-------- START OF budget_expense_array --------"</span>);
01764 
01765     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a> ; i++ ) {
01766         s = m.format(<a class="code" href="classFinance.html#m9">budget_expense_array</a>[i].total);    <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(s);
01767     }
01768 
01769     s = m.format(<a class="code" href="classFinance.html#m12">budget_total_expense</a>.<a class="code" href="structExpenseItem.html#m3">total</a>); <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(s);
01770 
01771     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"\n\n-------- end of Finance::init_data() --------\n\n"</span>);
01772 <span class="preprocessor">#endif</span>
01773 <span class="preprocessor"></span>}
01774 
<a name="l01775"></a><a class="code" href="classFinance.html#a8">01775</a> <span class="keywordtype">void</span> <a class="code" href="classFinance.html#a8">Finance::post_init_data</a>() {
01776     memcpy(&amp;<a class="code" href="classFinance.html#m19">next_year</a>, &amp;<a class="code" href="classFinance.html#m18">this_year</a>, <span class="keyword">sizeof</span>(<a class="code" href="structYearReport.html">YearReport</a>));
01777 }
01778 
01779 <span class="comment">//---------- End of function Finance::init_data -----------//</span>
01780 
01781 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01782 <span class="preprocessor"></span><span class="comment">// --- Begin of function Finance::calc_distance_learning_expediture --- //</span>
01783 <span class="comment">//</span>
01784 <span class="keywordtype">void</span> Finance::calc_distance_learning_expenditure() {
01785     <span class="comment">// calculate total distance learning place in the institution</span>
01786     <span class="keywordtype">int</span> totalDLPlace = 0;
01787     <span class="keywordtype">int</span> deptSize = department_array.size();
01788     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=deptSize; i&gt;0; i-- ) {
01789         <span class="keywordflow">if</span> (department_array.is_deleted(i))
01790             <span class="keywordflow">continue</span>;
01791 
01792         totalDLPlace += department_array[i]-&gt;total_distance_learning_place;
01793     }
01794 
01795     <span class="comment">// Item 8d vi)</span>
01796 
01797   <span class="comment">// calculate DL_tuition</span>
01798     <span class="keywordtype">float</span> DLTuition = (student_office.tuition_rate_history[HISTORY_YEAR_COUNT-1]/8)*library_tech_office.percent_dl_tuition/100;
01799 
01800     <span class="comment">// calculate net distance learning expense in finance</span>
01801     finance.net_distance_learning_expense.total = finance.projected_net_distance_learning_expense.this_year.total;
01802 
01803     finance.projected_net_distance_learning_expense.this_year.total =
01804         (totalDLPlace - department_array.outsourcing_credits[<a class="code" href="Ocourse_8h.html#a39a29">MAX_TEACHING_METHOD</a>])*DLTuition;
01805 
01806     finance.projected_net_distance_learning_expense.next_year.total =
01807         finance.projected_net_distance_learning_expense.this_year.total;
01808 }
01809 
01810 <span class="comment">//</span>
01811 <span class="comment">// --- End of function Finance::calc_distance_learning_expediture --- //</span>
01812 <span class="preprocessor">#endif</span>
01813 <span class="preprocessor"></span>
01814 <span class="comment">//---------- Begin of function Finance::calc_total_last_year -----------//</span>
<a name="l01818"></a><a class="code" href="classFinance.html#a29">01818</a> <span class="comment">void Finance::calc_total_last_year() {</span>
01819     <span class="comment">//------- calculate the total revenue ---------//</span>
01820 
01821     memset( &amp;total_revenue, 0, <span class="keyword">sizeof</span>(total_revenue) );
01822 
01823   <span class="comment">//------- calculate net tuition ------//</span>
01824 
01825     revenue_array[<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>].total =
01826         revenue_array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].total + revenue_array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].total;
01827 
01828   <span class="comment">//----- calculate the total of one row ------//</span>
01829   <span class="comment">// some items do not have separate values for the direct and indirect categories.</span>
01830 
01831     <span class="keywordtype">int</span> i = <a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>;
01832     revenue_array[i].total = revenue_array[i].direct + revenue_array[i].indirect;
01833 
01834     <span class="keywordflow">for</span>( i=<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a> ; i++ ) {
01835         <span class="comment">//------ calculate totals of all rows -------//</span>
01836 
01837         total_revenue.direct   += revenue_array[i].direct;
01838         total_revenue.indirect += revenue_array[i].indirect;
01839         total_revenue.total    += revenue_array[i].total;
01840     }
01841 
01842     <span class="comment">//------- calculate the total expense ---------//</span>
01843 
01844     memset( &amp;total_expense, 0, <span class="keyword">sizeof</span>(total_expense) );
01845 
01846     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a102a42">OPERATING_EXPENSE_ITEM_COUNT</a> ; i++ ) {
01847         <span class="comment">//----- calculate the total of one row ------//</span>
01848 
01849         expense_array[i].total = expense_array[i].faculty +
01850             expense_array[i].staff + expense_array[i].other;
01851 
01852         <span class="comment">//------ calculate totals of all rows -------//</span>
01853 
01854         total_expense.faculty += expense_array[i].faculty;
01855         total_expense.staff   += expense_array[i].staff;
01856         total_expense.other   += expense_array[i].other;
01857         total_expense.total   += expense_array[i].total;
01858     }
01859 
01860     <span class="comment">//------- calculate the total operating expense ---------//</span>
01861     memcpy( &amp;total_operating_expense, &amp;total_expense, <span class="keyword">sizeof</span>(total_expense) );
01862 
01863     <span class="keywordflow">for</span>( i=<a class="code" href="Ofinance_8h.html#a102a42">OPERATING_EXPENSE_ITEM_COUNT</a> ; i&lt;<a class="code" href="Ofinance_8h.html#a102a43">TOTAL_EXPENSE_ITEM_COUNT</a> ; i++ ) {
01864         <span class="comment">//----- calculate the total of one row ------//</span>
01865 
01866         expense_array[i].total = expense_array[i].faculty +
01867             expense_array[i].staff + expense_array[i].other;
01868 
01869         <span class="comment">//------ calculate totals of all rows -------//</span>
01870 
01871         total_expense.faculty += expense_array[i].faculty;
01872         total_expense.staff   += expense_array[i].staff;
01873         total_expense.other   += expense_array[i].other;
01874         total_expense.total   += expense_array[i].total;
01875     }
01876 
01877     <span class="comment">//----------------------//</span>
01878 
01879     finance.last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a25">AC_ASSET_TOTAL</a>] = 0 ;
01880     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a96a19">ASSET_ITEM_COUNT</a>-1 ; i++ ) {
01881         finance.last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a25">AC_ASSET_TOTAL</a>] += finance.last_year.asset_array[i];
01882     }
01883 
01884     finance.last_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a29">AC_LIABILITY_TOTAL</a>] = 0 ;
01885     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a98a26">LIABILITY_ITEM_COUNT</a>-1 ; i++ ) {
01886         finance.last_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a29">AC_LIABILITY_TOTAL</a>] += finance.last_year.liability_array[i];
01887     }
01888 
01889     <span class="comment">//------- calculate the total revenue AGAIN ---------//</span>
01890 
01891     memset( &amp;total_revenue, 0, <span class="keyword">sizeof</span>(total_revenue) );
01892 
01893     <span class="comment">//----- calculate the total of one row ------//</span>
01894     <span class="comment">// some items do not have separate values for the direct and indirect categories.</span>
01895     i = <a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>;
01896     revenue_array[i].total = revenue_array[i].direct + revenue_array[i].indirect;
01897 
01898     <span class="keywordflow">for</span>( i=<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a> ; i++ ) {
01899         <span class="comment">//------ calculate totals of all rows -------//</span>
01900 
01901         total_revenue.direct   += revenue_array[i].direct;
01902         total_revenue.indirect += revenue_array[i].indirect;
01903         total_revenue.total    += revenue_array[i].total;
01904     }
01905 
01906     <span class="comment">//------- calculate the total expense ---------//</span>
01907 
01908     memset( &amp;total_expense, 0, <span class="keyword">sizeof</span>(total_expense) );
01909 
01910     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a102a42">OPERATING_EXPENSE_ITEM_COUNT</a> ; i++ ) {
01911         <span class="comment">//----- calculate the total of one row ------//</span>
01912 
01913         expense_array[i].total = expense_array[i].faculty +
01914             expense_array[i].staff + expense_array[i].other;
01915 
01916         <span class="comment">//------ calculate totals of all rows -------//</span>
01917 
01918         total_expense.faculty += expense_array[i].faculty;
01919         total_expense.staff   += expense_array[i].staff;
01920         total_expense.other   += expense_array[i].other;
01921         total_expense.total   += expense_array[i].total;
01922     }
01923 
01924     <span class="comment">//------- calculate the total operating expense ---------//</span>
01925     memcpy( &amp;total_operating_expense, &amp;total_expense, <span class="keyword">sizeof</span>(total_expense) );
01926 
01927     <span class="keywordflow">for</span>( i=<a class="code" href="Ofinance_8h.html#a102a42">OPERATING_EXPENSE_ITEM_COUNT</a> ; i&lt;<a class="code" href="Ofinance_8h.html#a102a43">TOTAL_EXPENSE_ITEM_COUNT</a> ; i++ ) {
01928         <span class="comment">//----- calculate the total of one row ------//</span>
01929 
01930         expense_array[i].total = expense_array[i].faculty +
01931             expense_array[i].staff + expense_array[i].other;
01932 
01933         <span class="comment">//------ calculate totals of all rows -------//</span>
01934 
01935         total_expense.faculty += expense_array[i].faculty;
01936         total_expense.staff   += expense_array[i].staff;
01937         total_expense.other   += expense_array[i].other;
01938         total_expense.total   += expense_array[i].total;
01939     }
01940 
01941     <span class="comment">//----------------------//</span>
01942 
01943                                                   <span class="comment">// or = playerSchoolEx-&gt;surplus_or_deficit;//## chea 070699</span>
01944     last_year.surplus_deficit = total_revenue.total - total_expense.total;
01945 
01946     <span class="comment">//--- also calculate the percent of each item over the total ---//</span>
01947 
01948     calc_percent_last_year();
01949 }
01950 
01951 <span class="comment">//----------- End of function Finance::calc_total_last_year ------------//</span>
01952 
01953 <span class="comment">//---------- Begin of function Finance::apply_relative_wealth_effect -----------//</span>
01958 <span class="comment">void Finance::apply_relative_wealth_effect() {</span>
01959 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01960 <span class="preprocessor"></span>
01961 <span class="preprocessor">#else</span>
01962 <span class="preprocessor"></span>
01963     <span class="comment">//---------------------//</span>
01964     <span class="comment">// 0119 see notes 0114</span>
01965 
01966     <span class="keywordtype">float</span> map2Mean[] = {                            <span class="comment">//## chea 081099 try to pull up the surplus</span>
01967         0.40f, 0.10f, -0.20f
01968     };
01969 
01970     <span class="keywordtype">double</span> surplusRatio;
01971 
01972     <span class="keywordflow">if</span> ( player_school.relative_wealth == <a class="code" href="Opschool_8h.html#a60a12">WEALTH_RICH</a> ) {
01973         surplusRatio = 0.025f;
01974     }
01975     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( player_school.relative_wealth == <a class="code" href="Opschool_8h.html#a60a14">WEALTH_STRUGGLING</a> ) {
01976         surplusRatio = -0.025f;
01977     }
01978     <span class="keywordflow">else</span>
01979         surplusRatio = 0.0f;
01980 
01981     <span class="keywordtype">double</span> randomNum = (double) math.get_random_snd(0.0f,<a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.001f));
01982     surplusRatio += randomNum;
01983 
01984     <span class="comment">//-------------------------------//</span>
01985 
01986     <span class="keywordtype">double</span> targetSurplus = surplusRatio * total_expense.total;
01987     <span class="keywordtype">double</span> curSurplus = total_revenue.total - total_expense.total;
01988 
01989     <span class="keywordflow">if</span>( targetSurplus == curSurplus )
01990         <span class="keywordflow">return</span>;
01991 
01992     <span class="comment">//--------------------//</span>
01993 
01994     <span class="keywordflow">if</span> ( targetSurplus &gt; curSurplus ) {
01995         <span class="comment">// increase "other operating"</span>
01996 
01997         <span class="comment">// last year</span>
01998         revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].total += targetSurplus - curSurplus;
01999 
02000         <span class="comment">// this year</span>
02001         projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].this_year.total += targetSurplus - curSurplus;
02002 
02003         <span class="keywordflow">return</span>;
02004     }
02005 
02006     <span class="comment">//---------- if targetSurplus &lt; curSurplus -------------//</span>
02007 
02008     <span class="comment">// BUG: should check if targetSurplus is +/-</span>
02009 
02010     <span class="keywordtype">double</span> gap = curSurplus - targetSurplus;
02011 
02012     <span class="comment">// try to decrease "other operating" revenue</span>
02013 
02014     <a class="code" href="classPeerSchool.html">PeerSchool</a> *playerSchoolEx = school_res.player_peer_school;
02015     <span class="keywordtype">double</span> limit = 0.1 * playerSchoolEx-&gt;<a class="code" href="classSchoolEx.html#m16">other_operating_income</a>;
02016 
02017     <span class="comment">//--------- adjust last year figures ----------//</span>
02018 
02019     <span class="keywordtype">double</span> newValue = revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].total - gap;
02020 
02021     <span class="keywordflow">if</span> ( newValue &gt;= limit )                        <span class="comment">// 0.1 means 10%</span>
02022         revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].total = newValue;
02023     <span class="keywordflow">else</span> {
02024         <span class="keywordflow">if</span> ( revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].total &gt; limit ) {
02025             gap -= revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].total - limit;
02026 
02027             revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].total = limit;
02028         }
02029 
02030         <span class="comment">// try to INcrease "administrative staff and other" expenditure</span>
02031 
02032         <span class="keywordtype">double</span> tmp = expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].staff + expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].other;
02033         <span class="keywordtype">double</span> ratio = expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].staff / tmp;
02034 
02035         expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].staff += gap * ratio;
02036         expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].other += gap * (1-ratio);
02037     }
02038 
02039     <span class="comment">//--------- adjust this  year figures ----------//</span>
02040 
02041     newValue = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].this_year.total - gap;
02042 
02043     <span class="keywordflow">if</span> ( newValue &gt;= limit )                        <span class="comment">// 0.1 means 10%</span>
02044         projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].this_year.total = newValue;
02045     <span class="keywordflow">else</span> {
02046         <span class="keywordflow">if</span> ( projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].this_year.total &gt; limit ) {
02047             gap -= projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].this_year.total - limit;
02048 
02049             projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].this_year.total = limit;
02050         }
02051 
02052         <span class="keywordtype">double</span> tmp = projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].this_year.staff
02053             + projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].this_year.other;
02054 
02055         <span class="keywordtype">double</span> ratio = projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].this_year.staff / tmp;
02056 
02057         projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].this_year.staff += gap * ratio;
02058         projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a52">AC_ADMINISTRATION_N_OTHER_OPERATING_EXPENSE</a>].this_year.other += gap * (1-ratio);
02059     }
02060 <span class="preprocessor">#endif</span>
02061 <span class="preprocessor"></span>}
02062 
02063 <span class="comment">//----------- End of function Finance::apply_relative_wealth_effect ------------//</span>
02064 
02065 <span class="comment">//---------- Begin of function Finance::calc_percent_last_year -----------//</span>
02067 <span class="comment">void Finance::calc_percent_last_year() {</span>
02068     <span class="comment">//------- calculate the total revenue ---------//</span>
02069 
02070     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; i++ ) {
02071         revenue_array[i].percent = (float) 100.0 * revenue_array[i].total /
02072             total_revenue.total;
02073     }
02074 
02075     <span class="comment">//------- calculate the total expense ---------//</span>
02076     total_operating_expense.percent = 0;
02077 
02078     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a> ; i++ ) {
02079         expense_array[i].percent = (float) 100.0 * expense_array[i].total /
02080             total_expense.total;
02081 
02082         <span class="keywordflow">if</span> ( i &lt; <a class="code" href="Ofinance_8h.html#a102a42">OPERATING_EXPENSE_ITEM_COUNT</a> )
02083             total_operating_expense.percent += expense_array[i].percent;
02084     }
02085 
02086     total_revenue.percent = 100;
02087     total_expense.percent = 100;
02088 }
02089 
02090 <span class="comment">//----------- End of function Finance::calc_percent_last_year ------------//</span>
02091 
02092 <span class="comment">//------ Begin of function Finance::process_budget ------//</span>
<a name="l02096"></a><a class="code" href="classFinance.html#a9">02096</a> <span class="comment">void Finance::process_budget() {</span>
02097     <span class="comment">//---------------------------------------------------//</span>
02098     <span class="comment">//</span>
02099     <span class="comment">// Step 1: calculates the drivers of aggregate revenues</span>
02100     <span class="comment">//                    and expenditures based on policy parameters</span>
02101     <span class="comment">//                    that can be influenced by the player.</span>
02102     <span class="comment">//</span>
02103     <span class="comment">//---------------------------------------------------//</span>
02104 
02105     optimize_policy_1(<span class="keyword">true</span>);
02106 
02107     <span class="comment">//---------------------------------------------------//</span>
02108     <span class="comment">//</span>
02109     <span class="comment">// Step 2: allocates the budget adjustments among</span>
02110     <span class="comment">//                    functions and activities: e.g. faculty,</span>
02111     <span class="comment">//                    other departmental expense, libraries and</span>
02112     <span class="comment">//                    etc.</span>
02113     <span class="comment">//</span>
02114     <span class="comment">//---------------------------------------------------//</span>
02115 
02116     optimize_policy_2();
02117 
02118     <span class="comment">//---------------------------------------------------//</span>
02119     <span class="comment">//</span>
02120     <span class="comment">// Step 3: allocates faculty salary expenditure adjustments</span>
02121     <span class="comment">//                    among departments. And also determines the</span>
02122     <span class="comment">//                    number of new faculty that each department</span>
02123     <span class="comment">//                    can hire.</span>
02124     <span class="comment">//</span>
02125     <span class="comment">//---------------------------------------------------//</span>
02126 
02127     calc_budget_report();
02128 
02129     pre_optimization_stage_3(<span class="keyword">true</span>);                 <span class="comment">//true: init</span>
02130     optimize_policy_3();
02131 
02132     <span class="comment">//---------------------------------------------------//</span>
02133     <span class="comment">//</span>
02134     <span class="comment">// Step Final: calculate the player's budget</span>
02135     <span class="comment">//                                  "Year-End Financial Report"</span>
02136     <span class="comment">//</span>
02137     <span class="comment">//---------------------------------------------------//</span>
02138 
02139     <span class="comment">//990520 calc_budget_report();</span>
02140 
02141     <span class="comment">//---- scenario special handling ---------//</span>
02142 
02143     <span class="keywordflow">if</span>( player_school.scenario_id == <a class="code" href="Opschool_8h.html#a63a22">SCN_RAISE_SALARY</a> ) {
02144         player_school.scenario_faculty_salary_increase =
02145             100.0f * ( (1.0f + player_school.scenario_faculty_salary_increase / 100.0f)
02146                        *(1.0f + (float) expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a70">PL_FACULTY_SALARY_INCREASES</a>].result_value / 100.0f) - 1.0f);
02147     }
02148 
02149     <span class="comment">//---- reset user preference settings after optimization -----//</span>
02150 
02151     sys.redraw_all_flag=1;
02152 }
02153 
02154 <span class="comment">//------- End of function Finance::process_budget -------//</span>
02155 
02156 <span class="comment">//------ Begin of function Finance::set_student_policy ------//</span>
02160 <span class="comment">void Finance::set_student_policy(bool init) {</span>
02161     memset(student_policy_array, 0, <span class="keyword">sizeof</span>(student_policy_array));
02162 
02163     <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="Ofinance_8h.html#a106a58">PL_TRADITIONAL_UG</a> != <a class="code" href="Ostudent_8h.html#a32a3">UG_TRADITION</a>);
02164     <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a> != <a class="code" href="Ofinance_8h.html#a105a57">STUDENT_POLICY_COUNT</a>-1);
02165 
02166     <span class="keywordtype">int</span> i;
02167 
02168     <span class="comment">// init student_policy_array</span>
02169 
02170     <span class="comment">// assume number of continued students (enroll_res.student_count)</span>
02171     <span class="comment">// is updated (for stu dropout &amp; gradutate) in enrollment in the *end* of last trimester</span>
02172     <span class="comment">// and enrollment of new student will be ran after optimization</span>
02173     <span class="comment">//</span>
02174     <span class="comment">//</span>
02175     enroll_res.calc_student_count();                <span class="comment">// may slow down the game, but it's safe</span>
02176 
02177     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ostudent_8h.html#a0">MAX_STUDENT_LEVEL</a>; i++) {
02178         <span class="keywordflow">if</span> ( init ) {                                 <span class="comment">// 990525</span>
02179             student_policy_array[i].continue_next_year
02180                 = enroll_res.student_count[i] - enroll_res.target_student_intake[i];
02181         }
02182         <span class="keywordflow">else</span>
02183             student_policy_array[i].continue_next_year =  enroll_res.student_count[i];
02184     }
02185 
02186     <span class="comment">//0107 just for safe</span>
02187     student_policy_array[<a class="code" href="Ofinance_8h.html#a106a63">PL_TOTAL</a>].continue_next_year = 0;
02188     <span class="comment">//0107 just for safe</span>
02189     student_policy_array[<a class="code" href="Ofinance_8h.html#a106a63">PL_TOTAL</a>].estimate_next_year = 0;
02190 
02191     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ofinance_8h.html#a105a57">STUDENT_POLICY_COUNT</a>-1; i++) {
02192         <span class="comment">//student_policy_array[PL_TOTAL].last_year                              += student_policy_array[i].last_year;</span>
02193         student_policy_array[<a class="code" href="Ofinance_8h.html#a106a63">PL_TOTAL</a>].continue_next_year  += student_policy_array[i].continue_next_year; {
02194 
02195             <span class="comment">//if ( student_policy_array[i].continue_next_year != 0 ) // 0107 for student level 4: doctor always has no students</span>
02196             <span class="keywordflow">if</span> ( init ) {                               <span class="comment">// 990525</span>
02197                 student_policy_array[i].estimate_next_year
02198                     = enroll_res.target_student_intake[i] + student_policy_array[i].continue_next_year;
02199             }
02200             <span class="keywordflow">else</span> {                                      <span class="comment">// 990525</span>
02201 
02202                 <span class="comment">//## chea 201299</span>
02203                 <span class="keywordtype">int</span> newMatric = (int)((enroll_res.total_matrics[i] + enroll_res.target_student_intake[i]) / 2);
02204                 <span class="comment">//                              int newMatric = int(( enroll_res.total_matrics[i]</span>
02205                 <span class="comment">//                                      + enroll_res.target_student_intake[i] * enroll_res.cur_yield_rate[i] ) / 2);</span>
02206 
02207                 student_policy_array[i].estimate_next_year
02208                     = int( newMatric + student_policy_array[i].continue_next_year);
02209             }
02210         }
02211 
02212         student_policy_array[<a class="code" href="Ofinance_8h.html#a106a63">PL_TOTAL</a>].estimate_next_year  += student_policy_array[i].estimate_next_year;
02213     }
02214 }
02215 
02216 <span class="comment">//------ End of function Finance::set_student_policy ------//</span>
02217 
02218 <span class="comment">//------ Begin of function Finance::init_optimize_policy_1 ------//</span>
02223 <span class="comment">void Finance::init_optimize_policy_1() {</span>
02224 <span class="preprocessor">#if(GAME_VERSION&gt;=200)                          // remove stage1_revenue, stage1_expense, stage2_expense</span>
02225 <span class="preprocessor"></span>
02226     <span class="keywordtype">int</span> athleticRev = 0;
02227     <span class="keywordtype">int</span> athleticExp = 0;
02228     <span class="comment">// passed by reference</span>
02229     athletics_office.calc_adjusted_revenue_expense(athleticRev, athleticExp);
02230 
02231     <span class="keywordflow">if</span>(last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>] &lt;=0)
02232         last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>] = 1;
02233 
02234     <a class="code" href="ALL_8H.html#a0">err_when</a>(last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>] &lt;=0);
02235 
02236 <span class="preprocessor">#else                                           // remove stage1_revenue, stage1_expense, stage2_expense</span>
02237 <span class="preprocessor"></span>
02238     <span class="keywordtype">int</span> i;
02239 
02240     memset(stage1_revenue, 0, <span class="keyword">sizeof</span>(stage1_revenue));
02241 
02242     <span class="comment">//----------------------------------//</span>
02243     <span class="comment">// special case 1024</span>
02244 
02245     <span class="keywordtype">int</span> athleticRev = 0;
02246     <span class="keywordtype">int</span> athleticExp = 0;
02247     <span class="comment">// passed by reference</span>
02248     athletics_office.calc_adjusted_revenue_expense(athleticRev, athleticExp);
02249 
02250     <span class="comment">// ---------- init first column of revenue ---------- //</span>
02251     <span class="comment">//</span>
02252     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a10">S1_GROSS_TUITION_INCOME</a>].base_value      = revenue_array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].total;
02253     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a11">S1_FINANCIAL_AID</a>].base_value         = revenue_array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].total;
02254     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a12">S1_GIFTS</a>].base_value               = revenue_array[<a class="code" href="Ofinance_8h.html#a101a36">AC_GIFTS</a>].total;
02255 
02256     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a13">S1_INTERCOLLEGIATE_ATHLETICS</a>].base_value = athleticRev;
02257     <span class="comment">//stage1_revenue[S1_INTERCOLLEGIATE_ATHLETICS].base_value   = revenue_array[AC_INTERCOLLEGIATE_ATHLETICS].total;</span>
02258 
02259     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a14">S1_OTHER_OPERATING_INCOME</a>].base_value    = revenue_array[<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>].total;
02260     <span class="comment">//</span>
02261     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a15">S1_INTEREST_EARNED_OR_PAID</a>].base_value   = revenue_array[<a class="code" href="Ofinance_8h.html#a101a40">AC_INTEREST_EARNED_OR_PAID</a>].total;
02262 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
02263 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( info.prerun_year )
02264         stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a16">S1_STATE_APPROPRIATION</a>].base_value   = revenue_array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].total;
02265     <span class="keywordflow">else</span>
02266         stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a16">S1_STATE_APPROPRIATION</a>].base_value   = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].this_year.total;
02267 <span class="preprocessor">#else</span>
02268 <span class="preprocessor"></span>    stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a16">S1_STATE_APPROPRIATION</a>].base_value     = revenue_array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].total;
02269 <span class="preprocessor">#endif</span>
02270 <span class="preprocessor"></span>
02271     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a17">S1_RESEARCH_INDIRECTS</a>].base_value      = revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].direct;
02272 
02273     <span class="comment">// 1023</span>
02274     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a18">S1_ENDOWMENT_SPENDING</a>].base_value      = investment_office.smoothed_endowment_value;
02275 
02276     <span class="keywordflow">if</span>(last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>] &lt;=0)
02277         last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>] = 1;
02278 
02279     <a class="code" href="ALL_8H.html#a0">err_when</a>(last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>] &lt;=0); {
02280 
02281         <span class="comment">// ---------- init 2nd &amp; 3rd column ---------- //</span>
02282         <span class="comment">//</span>
02283         <span class="keywordtype">int</span> c92 = student_policy_array[<a class="code" href="Ofinance_8h.html#a106a63">PL_TOTAL</a>].continue_next_year;
02284         <span class="keywordtype">int</span> f92 = student_policy_array[<a class="code" href="Ofinance_8h.html#a106a63">PL_TOTAL</a>].estimate_next_year;
02285 
02286         stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a10">S1_GROSS_TUITION_INCOME</a>].adjust = (f92 - c92)*tuition_rate/1000;
02287         <span class="comment">//              stage1_revenue[S1_FINANCIAL_AID].adjust</span>
02288         <span class="comment">//                      = ( revenue_array[AC_FINANCIAL_AID].total / c92) * (f92 - c92);</span>
02289     }
02290 
02291     <span class="keywordflow">for</span> (i=<a class="code" href="Ofinanc2_8h.html#a40a10">S1_GROSS_TUITION_INCOME</a>; i&lt;=<a class="code" href="Ofinanc2_8h.html#a40a11">S1_FINANCIAL_AID</a>; i++) {
02292         <a class="code" href="structStage1Revenue.html">Stage1Revenue</a> *revPtr = &amp;(stage1_revenue[i]);
02293         revPtr-&gt;<a class="code" href="structStage1Revenue.html#m2">adjusted_base</a> = revPtr-&gt;<a class="code" href="structStage1Revenue.html#m0">base_value</a> + revPtr-&gt;<a class="code" href="structStage1Revenue.html#m1">adjust</a>;
02294     }
02295 
02296     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a17">S1_RESEARCH_INDIRECTS</a>].adjust =
02297         (inflation_rate + sponsored_research_growth) * stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a17">S1_RESEARCH_INDIRECTS</a>].base_value;
02298 
02299     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a18">S1_ENDOWMENT_SPENDING</a>].adjust  =
02300         stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a18">S1_ENDOWMENT_SPENDING</a>].base_value * (inflation_rate + investment_office.expected_real_annual_return_rate) / 100.0
02301         - revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].total;
02302 
02303     <span class="keywordflow">for</span> (i=<a class="code" href="Ofinanc2_8h.html#a40a17">S1_RESEARCH_INDIRECTS</a>; i&lt;=<a class="code" href="Ofinanc2_8h.html#a40a18">S1_ENDOWMENT_SPENDING</a>; i++) {
02304         <a class="code" href="structStage1Revenue.html">Stage1Revenue</a> *revPtr = &amp;(stage1_revenue[i]);
02305         revPtr-&gt;<a class="code" href="structStage1Revenue.html#m2">adjusted_base</a> = revPtr-&gt;<a class="code" href="structStage1Revenue.html#m0">base_value</a> + revPtr-&gt;<a class="code" href="structStage1Revenue.html#m1">adjust</a>;
02306     }
02307 
02308     <span class="comment">// ---------- init 1st column of expense---------- //</span>
02309     <span class="comment">//</span>
02310 
02311     stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a21">S1_FACULTY_SALARY_INCREASES</a>].base_value  = expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].faculty;
02312     stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a22">S1_STAFF_SALARY_INCREASES</a>].base_value    = total_operating_expense.staff - expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].staff;
02313     stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a23">S1_OTHER_COST_RISE_PROVISION</a>].base_value = total_operating_expense.other - expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].other;
02314     stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a24">S1_NET_OPERATING_BUGET_GROWTH</a>].base_value = total_operating_expense.total - expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].total;
02315 
02316     stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a25">S1_DEBT_SERVICE_GROWTH</a>].base_value =
02317         <span class="comment">//G50*(C$74+C$75)</span>
02318         last_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a27">AC_GENERAL_PLANT_DEBT</a>] * (long_term_debt_interest + debt_fraction_repaid_annually) / 100.0;
02319     stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a26">S1_REAL_TRANSFER_TO_PLANT_GROWTH</a>].base_value = expense_array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>].other;
02320 
02321     <span class="comment">// special case (last row of the table)</span>
02322     <span class="comment">//</span>
02323     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a19">S1_DIRECT_SPONSORED_RESEARCH</a>].base_value = stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a17">S1_RESEARCH_INDIRECTS</a>].adjusted_base;
02324     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a19">S1_DIRECT_SPONSORED_RESEARCH</a>].adjust   = stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a19">S1_DIRECT_SPONSORED_RESEARCH</a>].base_value * <a class="code" href="Ofinance_8cpp.html#a2">percent_spons_research_for_AY_fac</a>/100.0;
02325 <span class="preprocessor">#endif                                          // remove stage1_revenue, stage1_expense, stage2_expense</span>
02326 <span class="preprocessor"></span>}
02327 
02328 <span class="comment">//------ End of function Finance::init_optimize_policy_1 ------//</span>
02329 
02330 <span class="comment">//------ Begin of function Finance::optimize_policy_1 ------//</span>
<a name="l02335"></a><a class="code" href="classFinance.html#a11">02335</a> <span class="comment">bool Finance::optimize_policy_1(bool init) {</span>
02336 
02337     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"----------- finance.opt_policy_1(): start -----------"</span>);
02338 
02339     <span class="keywordtype">int</span> i;
02340 
02341     <span class="comment">// to calculate policy_array.result_value based on other policy_array's member vars</span>
02342 
02343 <span class="preprocessor">#ifdef DEBUG</span>
02344 <span class="preprocessor"></span>
02345     <span class="comment">// check interface bug, if any</span>
02346     <span class="keywordtype">double</span> target;
02347 
02348     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>; i++) {
02349         target = revenue_policy_array[i].target_value;
02350 
02351         <span class="comment">//              err_when(target &lt; revenue_policy_array[i].lower_bound);</span>
02352         <span class="comment">//              err_when(target &gt; revenue_policy_array[i].upper_bound);</span>
02353 
02354         <span class="keywordflow">if</span>(target &lt; revenue_policy_array[i].lower_bound)
02355             target = revenue_policy_array[i].target_value = revenue_policy_array[i].lower_bound;
02356         <span class="keywordflow">if</span> (target &gt; revenue_policy_array[i].upper_bound)
02357             target = revenue_policy_array[i].target_value = revenue_policy_array[i].upper_bound;
02358 
02359         <span class="comment">//              err_when(revenue_policy_array[i].import_weight &gt; OPT_HIGH_WEIGHT);</span>
02360         <span class="comment">//              err_when(revenue_policy_array[i].import_weight &lt; OPT_LOW_WEIGHT );</span>
02361         <span class="keywordflow">if</span> (revenue_policy_array[i].import_weight &gt; <a class="code" href="Ofinanc2_8h.html#a2">OPT_HIGH_WEIGHT</a>)
02362             revenue_policy_array[i].import_weight = <a class="code" href="Ofinanc2_8h.html#a2">OPT_HIGH_WEIGHT</a>;
02363         <span class="keywordflow">if</span> (revenue_policy_array[i].import_weight &lt; <a class="code" href="Ofinanc2_8h.html#a0">OPT_LOW_WEIGHT</a> )
02364             revenue_policy_array[i].import_weight = <a class="code" href="Ofinanc2_8h.html#a0">OPT_LOW_WEIGHT</a>;
02365     }
02366 
02367     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; i++) {
02368         target = expense_policy_array[i].target_value;
02369 
02370         <a class="code" href="ALL_8H.html#a0">err_when</a>(expense_policy_array[i].import_weight &gt; <a class="code" href="Ofinanc2_8h.html#a2">OPT_HIGH_WEIGHT</a>);
02371         <a class="code" href="ALL_8H.html#a0">err_when</a>(expense_policy_array[i].import_weight &lt; <a class="code" href="Ofinanc2_8h.html#a0">OPT_LOW_WEIGHT</a>);
02372     }
02373 <span class="preprocessor">#endif</span>
02374 <span class="preprocessor"></span>
02375     <span class="comment">//-------------------------//</span>
02376     <span class="comment">// adjust upper bound of research overhead rate</span>
02377 
02378     <a class="code" href="structFinancePolicy.html">FinancePolicy</a>* policy = &amp;revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>];
02379 
02380 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
02381 <span class="preprocessor"></span>    <span class="comment">// don't do adjustment here, moved to Finance::next_day on first day of trimester year</span>
02382 <span class="preprocessor">#else</span>
02383 <span class="preprocessor"></span>
02384     <span class="comment">//1229</span>
02385     <span class="keywordtype">float</span> maxRate = float(expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].total );
02386 
02387     <span class="comment">//990507 maxRate = float(maxRate) *100 / float(maxRate + expense_array[AC_SPONSORED_RESEARCH_EXPENSE].total);</span>
02388     maxRate = float(total_operating_expense.total - maxRate) * 100 / float(total_operating_expense.total);
02389 
02390     <a class="code" href="ALL_8H.html#a0">err_when</a>(maxRate&lt;0);
02391 
02392     <span class="keywordflow">if</span> ( policy-&gt;<a class="code" href="structFinancePolicy.html#m2">upper_bound</a> &gt; maxRate ) {
02393         policy-&gt;<a class="code" href="structFinancePolicy.html#m2">upper_bound</a> = maxRate;
02394         policy-&gt;<a class="code" href="structFinancePolicy.html#a1">bound_correction</a>();                   <span class="comment">//## chea 310899 try not using all the bound_correction</span>
02395     }
02396 <span class="preprocessor">#endif</span>
02397 <span class="preprocessor"></span>
02398 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
02399 <span class="preprocessor"></span>    <span class="keywordflow">if</span>( info.prerun_year ) {
02400         <span class="comment">// change the surplus/deficit target on prerun year</span>
02401         <span class="keywordtype">double</span> surplusRatio;
02402         <span class="keywordflow">if</span> ( player_school.relative_wealth == <a class="code" href="Opschool_8h.html#a60a12">WEALTH_RICH</a> ) {
02403             surplusRatio = 0.025f;
02404         }
02405         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( player_school.relative_wealth == <a class="code" href="Opschool_8h.html#a60a14">WEALTH_STRUGGLING</a> ) {
02406             surplusRatio = -0.025f;
02407         }
02408         <span class="keywordflow">else</span>
02409             surplusRatio = 0.0f;
02410 
02411         surplusRatio += (double) math.get_random_snd(0.0f,<a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.001f));
02412 
02413         expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a74">PL_SURPLUS_DEFICIT</a>].target_value = surplusRatio * 100.0;
02414         expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a74">PL_SURPLUS_DEFICIT</a>].required_flag = 1;
02415 
02416         <span class="comment">// force 60% indirect cost rate</span>
02417         revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>].target_value = 60.0;
02418         revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>].required_flag = 1;
02419     }
02420 <span class="preprocessor">#endif</span>
02421 <span class="preprocessor"></span>
02422     <span class="comment">//-------------------------//</span>
02423 
02424     <span class="comment">//-------------------------//</span>
02425     set_student_policy(init);                       <span class="comment">// data will be used by optimize_policy_1()</span>
02426     init_optimize_policy_1();
02427 
02428 <span class="preprocessor">#if(GAME_VERSION&gt;=200)                          // remove stage1_revenue, stage1_expense, stage2_expense</span>
02429 <span class="preprocessor"></span>
02430     <span class="comment">// 0.99-&gt;99%  //## chea 300899 put these in the opt stage 1 above</span>
02431     state_appropriation_real_growth = math.get_random_snd(.015f, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(.01f));
02432 
02433 <span class="preprocessor">#ifndef _DEBUG_STAGE1</span>
02434 <span class="preprocessor"></span>
02435     Revenue_and_Expense Base_Budget;                <span class="comment">// Base_Budget is projected actual on 1st Aug</span>
02436     Revenue_and_Expense Base_Actual;                <span class="comment">// Base_Actual is actual at year end</span>
02437     <span class="comment">// slider in stage 1 optimization; [0] is target, [1] is lower bound [2] is upper bound [3] is preference (weight)</span>
02438     <span class="keywordtype">float</span> PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>][4];
02439     <span class="comment">// slider in stage 2 optimization; [0] is target, [1] is lower bound [2] is upper bound [3] is preference (weight)</span>
02440     <span class="keywordtype">float</span> PL_Policy_Array_S2[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>][4];
02441     <span class="keywordtype">double</span> inflation, Base_tuition_rate;
02442     <span class="keywordtype">double</span> Base_enrollment, Target_enrollment, Actual_enrollment;
02443     <span class="keywordtype">double</span> Base_endowmentMV, Base_OpResBalance;
02444     <span class="keywordtype">float</span> ST_int_rate_01Aug, ST_int_rate_31Aug;
02445     <span class="keywordtype">double</span> New_Debt_service;
02446 
02447     input_Optimize_policy_ver2(
02448         Base_Budget,                                  <span class="comment">// Base_Budget is projected actual on 1st Aug</span>
02449         Base_Actual,                                  <span class="comment">// Base_Actual is actual at year end</span>
02450         PL_Policy_Array_S1,                           <span class="comment">// slider in stage 1 optimization; [0] is target, [1] is lower bound [2] is upper bound [3] is preference (weight)</span>
02451         PL_Policy_Array_S2,                           <span class="comment">// slider in stage 2 optimization; [0] is target, [1] is lower bound [2] is upper bound [3] is preference (weight)</span>
02452         inflation, Base_tuition_rate,
02453         Base_enrollment, Target_enrollment, Actual_enrollment,
02454         Base_endowmentMV, Base_OpResBalance,
02455         ST_int_rate_01Aug, ST_int_rate_31Aug,
02456         New_Debt_service );
02457 
02458 <span class="preprocessor">#else</span>
02459 <span class="preprocessor"></span>
02460     Revenue_and_Expense Base_Budget = {             <span class="comment">// Base_Budget is projected actual on 1st Aug</span>
02461         0.0, 0.0, {
02462             <span class="comment">// 10x4</span>
02463             { 0, 0, 0, 20000 },
02464             { 0, 0, 0, -3000 },
02465             { 0, 0, 0, 17000 },
02466             { 0, 3771, 2200, 5971 },
02467             { 0, 0, 0, 10000 },
02468             { 0, 0, 0, 10000 },
02469             { 0, 0, 0, 3000 },
02470             { 0, 0, 0, 12000 },
02471             { 0, 0, 0, 600 },
02472             { 0, 0, 0, 10000 }, {
02473             },
02474             <span class="comment">// 12x4</span>
02475             { 13311,    1430,     8321,     23062 },
02476             {    89,    1663,     2019,      3771 },
02477             {     0,    1622,    2019,     3641 },
02478             {     0,     234,      798,     1032 },
02479             {     0,    2921,     3225,     6146 },
02480             {     0,    3923,    1578,     5501 },
02481             {     0,    1778,    1550,     3328 },
02482             {     0,    6410,    5676,    12086 },
02483             {     0,     346,     992,     1338 },
02484             {     0,    1014,     753,     1767 },
02485             {     0,       0,    3887,     3887 },
02486             {     0,       0,    3049,     3049 },
02487         },
02488     };
02489 
02490     Revenue_and_Expense Base_Actual = {             <span class="comment">// Base_Actual is actual at year end</span>
02491         0.0, 0.0, {
02492             <span class="comment">// 10x4</span>
02493             { 0, 0, 0, 20000 },
02494             { 0, 0, 0, -3000 },
02495             { 0, 0, 0, 17000 },
02496             { 0, 3775, 2190, 5965 },
02497             { 0, 0, 0, 9928 },
02498             { 0, 0, 0, 10000 },
02499             { 0, 0, 0, 3013 },
02500             { 0, 0, 0, 12003 },
02501             { 0, 0, 0, 600 },
02502             { 0, 0, 0, 10000 }, {
02503             },
02504             <span class="comment">// 12x4</span>
02505             { 13307,    1430,     8321,     23058 },
02506             {    93,    1663,     2019,      3775 },
02507             {     0,    1600,    2100,     3700 },
02508             {     0,     230,      798,     1028 },
02509             {     0,    3000,     3225,     6225 },
02510             {     0,    3923,    1578,     5501 },
02511             {     0,    1778,    1550,     3328 },
02512             {     0,    6500,    5600,    12100 },
02513             {     0,     346,     992,     1338 },
02514             {     0,     998,     753,     1751 },
02515             {     0,       0,    3887,     3887 },
02516             {     0,       0,    3049,     3049 },
02517         },
02518     };
02519 
02520     <span class="keywordtype">float</span> PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>][4] = { {
02521         <span class="comment">// revenue</span>
02522         0.02f,   0.00f, 0.05f,  2
02523     },
02524                                                                                { 0.01f, -0.05f, 0.05f, 2 },
02525                                                                                { 0.05f,  0.04f, 0.10f, 2 },
02526                                                                                { 0.583f, 0.20f, 0.70f, 2 }, {
02527                                                                                    <span class="comment">// expense</span>
02528                                                                                    0.01f, -0.05f, 0.05f, 2
02529                                                                                },
02530                                                                                { 0.01f, -0.05f, 0.05f, 2 },
02531                                                                                { 0.02f, -0.05f, 0.05f, 2 },
02532                                                                                { 0.02f, -0.05f, 0.05f, 2 },
02533                                                                                { 0.01f, -0.03f, 0.03f, 2 },
02534     };
02535     <span class="keywordtype">float</span> PL_Policy_Array_S2[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>][4] = {
02536         { 0.01f, -0.05f, 0.05f, 2 },
02537         { 0.00f, -0.05f, 0.05f, 2 },
02538         { 0.01f, -0.05f, 0.05f, 2 },
02539         { 0.00f, -0.05f, 0.05f, 2 },
02540         { 0.01f, -0.05f, 0.05f, 2 },
02541         { 0.00f, -0.05f, 0.05f, 2 },
02542         { 0.01f, -0.05f, 0.05f, 2 },
02543         {-0.02f, -0.05f, 0.05f, 2 },
02544         { 0.00f, -0.05f, 0.05f, 2 },
02545         {-0.02f, -0.05f, 0.05f, 2 },
02546     };
02547 
02548     <span class="keywordtype">double</span> inflation = 0.0/100.0;
02549     <span class="keywordtype">double</span> Base_tuition_rate = 4000.0;
02550     <span class="keywordtype">double</span> Base_enrollment = 5000;
02551     <span class="keywordtype">double</span> Target_enrollment = 5200;
02552     <span class="keywordtype">double</span> Actual_enrollment = 5100;
02553     <span class="keywordtype">double</span> Base_endowmentMV = 220000.0;
02554     <span class="keywordtype">double</span> Base_OpResBalance = 21000.0;
02555     <span class="keywordtype">float</span> ST_int_rate_01Aug = 0.03f;
02556     <span class="keywordtype">float</span> ST_int_rate_31Aug = 0.031f;
02557     <span class="keywordtype">double</span> New_Debt_service = 4500.0;
02558 <span class="preprocessor">#endif</span>
02559 <span class="preprocessor"></span>
02560     <span class="comment">// calc Surplus_Deficit</span>
02561     Base_Budget.calc_Surplus_Deficit();
02562     Base_Actual.calc_Surplus_Deficit();
02563 
02564     <span class="comment">// output</span>
02565     Revenue_and_Expense Trial_Budget, Final_Budget;
02566     <span class="comment">// result of stage 1</span>
02567     <span class="keywordtype">float</span> Result_Vector_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>];
02568     <span class="keywordtype">float</span> Result_Vector_S2[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>]; <span class="comment">// result of stage 2</span>
02569 
02570     Optimize_policy_ver2( Trial_Budget, Final_Budget,
02571                           Result_Vector_S1, Result_Vector_S2,
02572                           1,                                            <span class="comment">// end at stage 1</span>
02573                           Base_Budget, Base_Actual,
02574                           PL_Policy_Array_S1, PL_Policy_Array_S2,
02575                           inflation, Base_tuition_rate, Base_enrollment, Target_enrollment,
02576                           Actual_enrollment, Base_endowmentMV, Base_OpResBalance, ST_int_rate_01Aug,
02577                           ST_int_rate_31Aug, New_Debt_service );
02578 
02579     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>; i++)
02580         revenue_policy_array[i].<a class="code" href="structFinancePolicy.html#m5">result_value</a> = Result_Vector_S1[i] * 100.0;
02581     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; i++)
02582         expense_policy_array[i].result_value = Result_Vector_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+i] * 100.0;
02583 
02584     <span class="comment">// ignore Trial_Budget, Final_Budget and Result_Vector_S2</span>
02585 
02586 <span class="preprocessor">#else                                           // remove stage1_revenue, stage1_expense, stage2_expense</span>
02587 <span class="preprocessor"></span>
02588     <span class="comment">//-------------------------//</span>
02589 
02590     <span class="keyword">const</span> <span class="keywordtype">short</span> nTake = <a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a> + <a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>;
02591 
02592     <span class="keywordtype">double</span> coeff  = 1.0;
02593     <span class="keywordtype">double</span> c72  = inflation_rate / 100.0;           <span class="comment">//0.03;</span>
02594 
02595     <span class="comment">//RowVector surplusCoefs(nTake);</span>
02596     <span class="comment">//ColumnVector surplusRHS(1);</span>
02597     <span class="comment">//double adjPriorBase;</span>
02598 
02599     <span class="keywordtype">double</span> priorBase;                               <span class="comment">// Reengineered matrices 990409</span>
02600     RowVector aaLast(nTake);
02601     ColumnVector bbLast(1); {
02602 
02603 <span class="preprocessor">#ifndef _DEBUG_STAGE1</span>
02604 <span class="preprocessor"></span>
02605         <span class="comment">// 990524 int e186 = (int) stage1_revenue[S1_GROSS_TUITION_INCOME].adjusted_base;       //185189;</span>
02606 
02607         <span class="keywordtype">int</span> e186 = int((1+c72) *
02608                        ( student_policy_array[<a class="code" href="Ofinance_8h.html#a106a63">PL_TOTAL</a>].estimate_next_year ) * tuition_rate/1000 );
02609 
02610         stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a10">S1_GROSS_TUITION_INCOME</a>].adjusted_base = e186;
02611 
02612         <span class="comment">// 990524 int e187 = - (int) stage1_revenue[S1_FINANCIAL_AID].adjusted_base;    //23132;                // 0407</span>
02613 
02614         <span class="keywordtype">int</span> e187 = int((1+c72) * revenue_array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].total);
02615         stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a11">S1_FINANCIAL_AID</a>].adjusted_base = e187;
02616 
02617         <span class="comment">//5400;</span>
02618         <span class="keywordtype">int</span> c189 = (int) stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a12">S1_GIFTS</a>].base_value;
02619         <span class="comment">//5756;</span>
02620         <span class="keywordtype">int</span> c190 = (int) stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a13">S1_INTERCOLLEGIATE_ATHLETICS</a>].base_value;
02621         <span class="comment">//3234;</span>
02622         <span class="keywordtype">int</span> c191 = (int) stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a14">S1_OTHER_OPERATING_INCOME</a>].base_value;
02623 
02624         <span class="comment">//4896;</span>
02625         <span class="keywordtype">int</span> c192 = (int) stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a15">S1_INTEREST_EARNED_OR_PAID</a>].base_value;
02626         <span class="comment">//26484;</span>
02627         <span class="keywordtype">int</span> e195 = (int) stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a17">S1_RESEARCH_INDIRECTS</a>].adjusted_base;
02628         <span class="comment">//345738;</span>
02629         <span class="keywordtype">int</span> e198 = (int) stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a18">S1_ENDOWMENT_SPENDING</a>].adjusted_base;
02630         <span class="comment">//80759;</span>
02631         <span class="keywordtype">int</span> c203 = (int) stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a21">S1_FACULTY_SALARY_INCREASES</a>].base_value;
02632         <span class="comment">//74929;</span>
02633         <span class="keywordtype">int</span> c204 = (int) stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a22">S1_STAFF_SALARY_INCREASES</a>].base_value;
02634 
02635         <span class="comment">//46266;</span>
02636         <span class="keywordtype">int</span> c205 = (int) stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a23">S1_OTHER_COST_RISE_PROVISION</a>].base_value;
02637         <span class="comment">//201954;</span>
02638         <span class="keywordtype">int</span> c206 = (int) stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a24">S1_NET_OPERATING_BUGET_GROWTH</a>].base_value;
02639         <span class="comment">//1920;</span>
02640         <span class="keywordtype">int</span> c207 = (int) stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a25">S1_DEBT_SERVICE_GROWTH</a>].base_value;
02641         <span class="comment">//13000;</span>
02642         <span class="keywordtype">int</span> c208 = (int) stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a26">S1_REAL_TRANSFER_TO_PLANT_GROWTH</a>].base_value;
02643 
02644         <span class="keywordtype">double</span> g74  = gifts_growth/100.0;             <span class="comment">//0.0;</span>
02645         <span class="keywordtype">double</span> g75  = athletics_revenue_growth/100.0; <span class="comment">//0.0;</span>
02646         <span class="keywordtype">double</span> g78  = other_income_growth/100.0;      <span class="comment">//0.0;</span>
02647         <span class="keywordtype">double</span> g77  = other_expense_growth/100.0;     <span class="comment">//0.005;</span>
02648 
02649         <span class="comment">// 990408 int f38               = (int) total_operating_expense.total;  //227667;</span>
02650         <span class="keywordtype">int</span> f42 = (int) total_expense.total;
02651 
02652 <span class="preprocessor">#else</span>
02653 <span class="preprocessor"></span>        <span class="comment">//temp for debug</span>
02654         <span class="keywordtype">int</span> e186 = 185189;
02655         <span class="keywordtype">int</span> e187 = -23132;
02656         <span class="keywordtype">int</span> c189 = 5400;
02657         <span class="keywordtype">int</span> c190 = 5756;
02658         <span class="keywordtype">int</span> c191 = 3234;
02659 
02660         <span class="keywordtype">int</span> c192 = 4896;
02661         <span class="keywordtype">int</span> e195 = 26484;
02662         <span class="keywordtype">int</span> e198 = 345738;
02663         <span class="keywordtype">int</span> c203 = 80759;
02664         <span class="keywordtype">int</span> c204 = 74929;
02665 
02666         <span class="keywordtype">int</span> c205 = 46266;
02667         <span class="keywordtype">int</span> c206 = 201954;
02668         <span class="keywordtype">int</span> c207 = 1920;
02669         <span class="keywordtype">int</span> c208 = 13000;
02670 
02671         <span class="keywordtype">double</span> g74  = 0.0;
02672         <span class="keywordtype">double</span> g75  = 0.0;
02673         <span class="keywordtype">double</span> g78  = 0.0;
02674         <span class="keywordtype">double</span> g77  = 0.005;
02675 
02676         <span class="keywordtype">int</span> f42   = 227667;
02677 <span class="preprocessor">#endif</span>
02678 <span class="preprocessor"></span>
02679         <span class="comment">// the following Mathematica codes (commented) are replaced by the followed hard-coded C</span>
02680         <span class="comment">/* --------------------</span>
02681 <span class="comment">           stuInc       = e186*(1+c72+x1);</span>
02682 <span class="comment">           finAid       = e187*(1+c72+x2);</span>
02683 <span class="comment">           gifts        = c189*(1+c72+g74);</span>
02684 <span class="comment">           athRev       = c190*(1+c72+g75);</span>
02685 <span class="comment">           othInc       = c191*(1+c72+g78);</span>
02686 <span class="comment">           intInc       = c192;</span>
02687 <span class="comment">           endSp                = e198*x3;</span>
02688 <span class="comment">           resInds      = e195*x4;</span>
02689 <span class="comment"></span>
02690 <span class="comment">           facSal       = c203*(1+c72+x5);</span>
02691 <span class="comment">           stafSal      = c204*(1+c72+x6);</span>
02692 <span class="comment">           othExp       = c205*(1+c72+g77);</span>
02693 <span class="comment">           netBuGr      = c206*x7;</span>
02694 <span class="comment">           debtSvc      = c207;</span>
02695 <span class="comment">           xfrPlnt      = c208*(1+c72+x8);</span>
02696 <span class="comment"></span>
02697 <span class="comment">           totRev = stuInc - finAid + gifts + athRev + othInc + intInc + resInds + endSp;</span>
02698 <span class="comment">           totExp = facSal + stafSal + othExp + netBuGr + debtSvc + xfrPlnt;</span>
02699 <span class="comment">           calcSurplus = Expand[(totRev - totExp)/adjPriorBase];</span>
02700 <span class="comment"></span>
02701 <span class="comment">           ColumnVector surplusCoefs = (Coefficient[calcSurplus,#]&amp;/@({x1,x2,x3,x4,x5,x6,x7,x8}));</span>
02702 <span class="comment">           surplusRHS = calcSurplus[[Range[24]]];</span>
02703 <span class="comment">           ColumnVector surplusCoefs = Join[-Take[surplusCoefs,nTake-1],{1}];</span>
02704 <span class="comment">           surplusRHS    += co + Drop[surplusCoefs,-1].Drop[co,-1];</span>
02705 <span class="comment">           -------------------- */</span>
02706 
02707         <span class="comment">/*      </span>
02708 <span class="comment">                adjPriorBase    = f42*(1.02+c72);                       // 990408</span>
02709 <span class="comment"></span>
02710 <span class="comment">                surplusRHS(1) =</span>
02711 <span class="comment">                1 + c189/adjPriorBase + c190/adjPriorBase + c191/adjPriorBase +</span>
02712 <span class="comment">                c192/adjPriorBase - c205/adjPriorBase + c206/adjPriorBase -  c207/adjPriorBase</span>
02713 <span class="comment">                + (c189*c72)/adjPriorBase + (c190*c72)/adjPriorBase +</span>
02714 <span class="comment">                (c191*c72)/adjPriorBase - (c203*c72)/adjPriorBase - (c204*c72)/adjPriorBase -</span>
02715 <span class="comment">                (c205*c72)/adjPriorBase - (c208*c72)/adjPriorBase</span>
02716 <span class="comment">                + (c72*e186)/adjPriorBase - (c72*e187)/adjPriorBase</span>
02717 <span class="comment">                - e195/adjPriorBase - e198/adjPriorBase +</span>
02718 <span class="comment">                (c189*g74)/adjPriorBase + (c190*g75)/adjPriorBase - (c205*g77)/adjPriorBase +</span>
02719 <span class="comment">                (c191*g78)/adjPriorBase;</span>
02720 <span class="comment"></span>
02721 <span class="comment">                double tmpArr[nTake] =</span>
02722 <span class="comment">                {</span>
02723 <span class="comment">                -(e186/adjPriorBase),</span>
02724 <span class="comment">                e187/adjPriorBase,</span>
02725 <span class="comment">                -(e198/adjPriorBase),</span>
02726 <span class="comment">                -(e195/adjPriorBase),</span>
02727 <span class="comment">                c203/adjPriorBase,</span>
02728 <span class="comment"></span>
02729 <span class="comment">                c204/adjPriorBase,</span>
02730 <span class="comment">                c206/adjPriorBase,</span>
02731 <span class="comment">                c208/adjPriorBase,</span>
02732 <span class="comment">                1</span>
02733 <span class="comment">                };</span>
02734 <span class="comment">                surplusCoefs &lt;&lt; tmpArr;</span>
02735 <span class="comment">        */</span>
02736 
02737         <span class="comment">// --------- Reengineered matrices 990409 -------------- //</span>
02738 
02739         priorBase = (c203+c204+c205+c207+c208)*(1+c72);
02740 
02741         <span class="comment">//## chea 230899</span>
02742         <span class="comment">/*</span>
02743 <span class="comment">          double tmpArr2[nTake] =</span>
02744 <span class="comment">          {</span>
02745 <span class="comment">          e186,e187,e198,e195,-c203,-c204,-c208,-c206,</span>
02746 <span class="comment">          -(c203+c204+c205+c207+c208)                                                   // 990415</span>
02747 <span class="comment">          };</span>
02748 <span class="comment">        */</span>
02749 
02750         <span class="comment">//## chea 230899</span>
02751         <span class="comment">//for cal aaLast below</span>
02752         <span class="keywordtype">double</span> temp_tar[<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>-1];
02753         <span class="keywordtype">double</span> temp_var[<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>-1];
02754         <span class="keywordtype">int</span> new_value_add = 0;
02755 
02756         <span class="comment">//c203</span>
02757         temp_var[0] = stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a21">S1_FACULTY_SALARY_INCREASES</a>].base_value;
02758         <span class="comment">//c204;</span>
02759         temp_var[1] = stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a22">S1_STAFF_SALARY_INCREASES</a>].base_value;
02760         <span class="comment">//c208;</span>
02761         temp_var[2] = stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a26">S1_REAL_TRANSFER_TO_PLANT_GROWTH</a>].base_value;
02762         <span class="comment">//c206;</span>
02763         temp_var[3] = stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a24">S1_NET_OPERATING_BUGET_GROWTH</a>].base_value;
02764 
02765         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> count=0; count&lt;<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>-1; count++) {
02766             temp_tar[count] = expense_policy_array[count].target_value / 100.0;
02767             new_value_add += (int)(temp_tar[count] * temp_var[count]);
02768         }
02769 
02770         <span class="keywordtype">double</span> tmpArr2[nTake] = {
02771             e186,e187,e198,e195,-c203,-c204,-c206,-c208,
02772             <span class="comment">// new_value_add = Take[targets,{5,8}].{c203,c204,c208,c206}</span>
02773             -((c203+c204+c205*(1+g77)+c207+c208+e195)*(1+c72)) + new_value_add
02774         };
02775 
02776         <span class="keywordflow">for</span> ( i=0; i &lt; nTake; i++ )
02777             tmpArr2[i] /= priorBase;
02778 
02779         aaLast &lt;&lt; tmpArr2;
02780         <span class="comment">//## chea 230899</span>
02781 
02782         <span class="comment">/*</span>
02783 <span class="comment">          double bbTmp = 0;</span>
02784 <span class="comment">          for ( i=0; i &lt; nTake; i++ )</span>
02785 <span class="comment">          bbTmp += tmpArr2[i];</span>
02786 <span class="comment">          bbLast(1) = ((e186+e187-c203-c204-c208 + c189+c190+c191-c205)*(1+c72)+c192-c207)/priorBase</span>
02787 <span class="comment">          - bbTmp;</span>
02788 <span class="comment">        */</span>
02789 
02790         <span class="comment">//## chea 300899 added this back into the quad.</span>
02791 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
02792 <span class="preprocessor"></span>        <span class="keywordtype">double</span> state_app;
02793         <span class="keywordflow">if</span> ( info.prerun_year )
02794             state_app = revenue_array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].total;
02795         <span class="keywordflow">else</span>
02796             state_app = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].this_year.total;
02797 <span class="preprocessor">#else</span>
02798 <span class="preprocessor"></span>        <span class="keywordtype">double</span> state_app = revenue_array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].total;
02799 <span class="preprocessor">#endif</span>
02800 <span class="preprocessor"></span>        <span class="comment">// 0.99-&gt;99%  //## chea 300899 put these in the opt stage 1 above</span>
02801         state_appropriation_real_growth = math.get_random_snd(.015f, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(.01f));
02802 
02803         bbLast(1) = ((e186+e187-c203-c204-c208 + c189*(1+g74)+c190*(1+g75)+c191*(1+g78)+state_app*(1+state_appropriation_real_growth)
02804                       -c205*(1+g77))*(1+c72)+c192-c207)/priorBase;<span class="comment">//## chea 230899</span>
02805 
02806     }
02807 
02808     <span class="comment">//--------- init local variables    -----------//</span>
02809     <span class="comment">//</span>
02810 
02811     ColumnVector targets(nTake), weights(nTake), lowerBound(nTake), upperBound(nTake);
02812 
02813     <span class="comment">// Equivalent Mathematica code:</span>
02814     <span class="comment">// targets          = co+{t1,t2,t3,t4,t5,t6,t7,t8,t9/adjPriorBase};</span>
02815     <span class="comment">// weights          = co+{w1,w2,w3,w4,w5,w6,w7,w8,w9};</span>
02816     <span class="comment">// lowerBound       = co+{f1,f2,l3,f4,f5,f6,f7,f8,f9/adjPriorBase};</span>
02817     <span class="comment">// upperBound       = co+{u1,u2,u3,u4,u5,u6,u7,u8,u9/adjPriorBase};</span>
02818 
02819     <span class="comment">//990528 float weightMultiplier[nTake] =    { 1,1,5,5,1,1,1,1,5 };                                  // 990409</span>
02820     <span class="keywordtype">float</span> weightMultiplier[nTake] = {               <span class="comment">// 2 is AC_ENDOWMENT_SPENDING</span>
02821         1,1,1,1,1,2,1,1,1
02822     };
02823 
02824     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>; i++) {
02825         targets(i+1) = revenue_policy_array[i].<a class="code" href="structFinancePolicy.html#m0">target_value</a> / 100.0;
02826         <span class="comment">//weights(i+1) = revenue_policy_array[i].import_weight;</span>
02827         weights(i+1) = revenue_policy_array[i].<a class="code" href="structFinancePolicy.html#m3">import_weight</a> * weightMultiplier[i];
02828         lowerBound(i+1) = revenue_policy_array[i].<a class="code" href="structFinancePolicy.html#m1">lower_bound</a> / 100.0;
02829         upperBound(i+1) = revenue_policy_array[i].<a class="code" href="structFinancePolicy.html#m2">upper_bound</a> / 100.0;
02830     }
02831 
02832     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; i++) {
02833         targets(<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+i+1) = expense_policy_array[i].target_value / 100.0;
02834         <span class="comment">//weights(REVENUE_POLICY_COUNT+i+1) = expense_policy_array[i].import_weight;</span>
02835         weights(<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+i+1) = expense_policy_array[i].import_weight * weightMultiplier[i+<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>];
02836         lowerBound(<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+i+1) = expense_policy_array[i].lower_bound / 100.0;
02837         upperBound(<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+i+1) = expense_policy_array[i].upper_bound / 100.0;
02838     }
02839     <span class="comment">/*</span>
02840 <span class="comment">      print_vector(targets);</span>
02841 <span class="comment">      print_vector(weights);</span>
02842 <span class="comment">      print_vector(lowerBound);</span>
02843 <span class="comment">      print_vector(upperBound);</span>
02844 <span class="comment">    */</span>
02845     <span class="comment">//if bounds are in % for surplus, then comment 3 lines below:</span>
02846     <span class="comment">/*</span>
02847 <span class="comment">      targets(nTake) /= adjPriorBase;</span>
02848 <span class="comment">      lowerBound(nTake) /= adjPriorBase;</span>
02849 <span class="comment">      upperBound(nTake) /= adjPriorBase;</span>
02850 <span class="comment">    */</span>
02851 
02852     targets += coeff;
02853     lowerBound += coeff;
02854     upperBound += coeff;
02855 
02856     <span class="comment">// 990521</span>
02857 
02858     print_vector(targets);
02859     print_vector(weights);
02860     print_vector(lowerBound);
02861     print_vector(upperBound);
02862 
02863     <span class="keywordflow">for</span> ( i=1; i&lt;=nTake; i++)
02864         weights(i) *= <a class="code" href="OLINALG_8CPP.html#a2">fabs</a>(aaLast(i));
02865 
02866     <span class="comment">//--------- create the Quadratic Program input matrices     -----------//</span>
02867     <span class="comment">//</span>
02868     DiagonalMatrix Q(nTake);  Q.set_diagonal(weights);
02869     ColumnVector c  = - (targets.t() * Q).t();
02870 
02871     DiagonalMatrix I(nTake);  I = 1;
02872     <a class="code" href="classMatrix.html">Matrix</a> A = I &amp; -I;
02873     ColumnVector b  = lowerBound &amp; -upperBound;
02874 
02875     <span class="keywordtype">double</span> temp_sum =0;
02876     <span class="keywordflow">for</span> ( i=1; i&lt;=nTake; i++)
02877         temp_sum += aaLast(i);
02878 
02879     bbLast(1) -= temp_sum;
02880 
02881     b = b &amp; bbLast &amp; -bbLast;                       <span class="comment">// Reengineered matrices 990409</span>
02882     A = A &amp; -aaLast &amp; aaLast;
02883 
02884     <span class="comment">//---------- main program --------------//</span>
02885     <span class="comment">//</span>
02886     <span class="comment">/*{</span>
02887 <span class="comment">      const int n=3,m=4;</span>
02888 <span class="comment">      Real c[n] = {0,0,0};</span>
02889 <span class="comment">      Real q[n*n] = {3,0,0,0,5,0,0,0,2};</span>
02890 <span class="comment">      Real a[m*n] = {1,1,1, 1,-1,1, 0,1,1, 0,0,1};</span>
02891 <span class="comment">      Real b[m] = {10,2.3,4,5};</span>
02892 <span class="comment"></span>
02893 <span class="comment">      Matrix Q(n,n); Q &lt;&lt; q;</span>
02894 <span class="comment">      Matrix A(m,n); A &lt;&lt; a;</span>
02895 <span class="comment">      ColumnVector C(n); C &lt;&lt; c;</span>
02896 <span class="comment">      ColumnVector B(m); B &lt;&lt; b;</span>
02897 <span class="comment">      ColumnVector XNames(n);   XNames = 0;</span>
02898 <span class="comment"></span>
02899 <span class="comment">      LinearAlgebra::quadratic_prog(C,Q,A,B,XNames);</span>
02900 <span class="comment"></span>
02901 <span class="comment">      char s[100];</span>
02902 <span class="comment">      sprintf(s, "\nxNames = %lf %lf %lf", XNames(1),XNames(2),XNames(3));</span>
02903 <span class="comment">      DEBUG_LOG(s);</span>
02904 <span class="comment"></span>
02905 <span class="comment">      //cout &lt;&lt; "\nLinAlg:\nXNames should be 3.125, 1.875, 5.0\n";</span>
02906 <span class="comment">      }*/</span>
02907 
02908     ColumnVector xNames(nTake);
02909     <span class="keywordflow">if</span> (!<a class="code" href="classLinearAlgebra.html#d0">LinearAlgebra::quadratic_prog</a>(c,Q,A,b,xNames, 100))
02910         <span class="keywordflow">return</span> <span class="keyword">false</span>;
02911     xNames -= coeff;
02912 
02913     print_vector2(xNames);
02914 
02915     <span class="comment">/*</span>
02916 <span class="comment">      xNames should be = {0.00087059,-0.000108746,0.07,0.500125,</span>
02917 <span class="comment">      0.0146203,-0.000352248,-0.000949404,-0.0000611142,-0.0011238}</span>
02918 <span class="comment">    */</span>
02919 
02920     <span class="comment">// -------------- assign the result to target "column" of array ---------------- //</span>
02921     <span class="comment">//</span>
02922     <span class="keywordtype">double</span> result;                                  <span class="comment">//, lower, upper;</span>
02923 
02924     <span class="comment">/*  //## chea 240899 this should be wrong</span>
02925 <span class="comment">        for (i=0; i&lt;REVENUE_POLICY_COUNT; i++)</span>
02926 <span class="comment">        {</span>
02927 <span class="comment">        result = xNames(i+1) * 100;</span>
02928 <span class="comment">        //990526 lower = revenue_policy_array[i].lower_bound;</span>
02929 <span class="comment">        //990526 upper = revenue_policy_array[i].upper_bound;</span>
02930 <span class="comment"></span>
02931 <span class="comment">        //990526 revenue_policy_array[i].result_value = min( max(result, lower), upper);</span>
02932 <span class="comment">        revenue_policy_array[i].result_value = result;</span>
02933 <span class="comment">        revenue_policy_array[i].bound_correction();     // chwg080399</span>
02934 <span class="comment">        }</span>
02935 <span class="comment">        for (i=0; i&lt;EXPENSE_POLICY_COUNT; i++)</span>
02936 <span class="comment">        {</span>
02937 <span class="comment">        result = xNames(i+1+REVENUE_POLICY_COUNT) * 100;</span>
02938 <span class="comment">        //990526 lower = expense_policy_array[i].lower_bound;</span>
02939 <span class="comment">        //990526 upper = expense_policy_array[i].upper_bound;</span>
02940 <span class="comment"></span>
02941 <span class="comment">        //990526 expense_policy_array[i].result_value = min( max(result, lower), upper);</span>
02942 <span class="comment">        expense_policy_array[i].result_value = result;</span>
02943 <span class="comment">        expense_policy_array[i].bound_correction();     // chwg080399</span>
02944 <span class="comment">        }</span>
02945 <span class="comment">    */</span>
02946 
02947     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>; i++) {
02948         result = xNames(i+1) * 100;
02949         revenue_policy_array[i].<a class="code" href="structFinancePolicy.html#m5">result_value</a> = result;
02950         <span class="comment">//              revenue_policy_array[i].bound_correction();     // chwg080399         //## chea 240899</span>
02951     }
02952 
02953     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>; i++) {
02954         result = xNames(i+<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+1) * 100;
02955         expense_policy_array[i].result_value = result;
02956         <span class="comment">//              expense_policy_array[i].bound_correction();     // chwg080399  //## chea 240899</span>
02957     }
02958 <span class="preprocessor">#endif                                          // remove stage1_revenue, stage1_expense, stage2_expense</span>
02959 <span class="preprocessor"></span>
02960     <span class="comment">//------- adjust budget --------------//</span>
02961 
02962     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"finance.opt_policy_1(): end"</span>);
02963 
02964     adjust_budget_1();
02965 
02966     <span class="keywordflow">return</span> <span class="keyword">true</span>;
02967 }
02968 
02969 <span class="comment">//------- End of function Finance::optimize_policy_1 -------//</span>
02970 
02971 <span class="comment">//------ Begin of function Finance::adjust_budget_1 ------//</span>
02973 <span class="comment">void Finance::adjust_budget_1() {</span>
02974 <span class="preprocessor">#if(GAME_VERSION&gt;=200)                          // remove stage1_revenue, stage1_expense, stage2_expense</span>
02975 <span class="preprocessor"></span><span class="preprocessor">#else                                           // remove stage1_revenue, stage1_expense, stage2_expense</span>
02976 <span class="preprocessor"></span>    <span class="keywordtype">int</span> i;
02977 
02978     <span class="comment">// init 4th column of revenue of the table "Strucaltural equations (used in Stage1)" in ResAlloc.ex.xls file</span>
02979     <span class="comment">//</span>
02980     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a10">S1_GROSS_TUITION_INCOME</a>].computed_growthrate =
02981         inflation_rate + revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>].result_value;
02982     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a11">S1_FINANCIAL_AID</a>].computed_growthrate =
02983         inflation_rate + revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a66">PL_FINANCIAL_AID</a>].result_value;
02984 
02985     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a12">S1_GIFTS</a>].computed_growthrate = inflation_rate + gifts_growth;
02986     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a13">S1_INTERCOLLEGIATE_ATHLETICS</a>].computed_growthrate = inflation_rate + athletics_revenue_growth;
02987 
02988     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a14">S1_OTHER_OPERATING_INCOME</a>].computed_growthrate = inflation_rate + other_income_growth;
02989 
02990     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a17">S1_RESEARCH_INDIRECTS</a>].computed_growthrate = revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>].result_value;
02991     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a18">S1_ENDOWMENT_SPENDING</a>].computed_growthrate = revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a67">PL_ENDOWMENT_SPENDING_RATE</a>].result_value;
02992     <span class="comment">//stage1_revenue[S1_STATE_APPROPRIATION].computed_growthrate = revenue_policy_array[PL_STATE_APPROPRIATION].result_value;</span>
02993 
02994     <span class="comment">// init 5th column of revenue of the table "Strucaltural equations (used in Stage1)" in ResAlloc.ex.xls file</span>
02995     <span class="comment">//</span>
02996     <span class="keywordflow">for</span> (i=0; i&lt;=<a class="code" href="Ofinanc2_8h.html#a40a11">S1_FINANCIAL_AID</a>; i++)
02997         stage1_revenue[i].new_value = stage1_revenue[i].adjusted_base * (1.0 + stage1_revenue[i].computed_growthrate/100.0);
02998     <span class="keywordflow">for</span> (i=<a class="code" href="Ofinanc2_8h.html#a40a12">S1_GIFTS</a>; i&lt;=<a class="code" href="Ofinanc2_8h.html#a40a13">S1_INTERCOLLEGIATE_ATHLETICS</a>; i++)
02999         stage1_revenue[i].new_value = stage1_revenue[i].base_value * (1.0 + inflation_rate/100.0);
03000 
03001     <a class="code" href="ALL_8H.html#a0">err_when</a>(stage1_revenue[0].new_value &lt; 0 );
03002 
03003     <span class="comment">//-----------------------------------//</span>
03004     <span class="comment">// 1027 add time_variation: by email req26.txt // Notes 0919 section5</span>
03005     <span class="comment">// 0.99-&gt;99%</span>
03006     <span class="keyword">static</span> <span class="keywordtype">float</span> other_operating_income_real_growth = math.get_random_snd(.010f, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(.0075f));
03007     <span class="keyword">static</span> <span class="keywordtype">float</span> other_operating_income_real_growth_last2 = 0;
03008 
03009     i = <a class="code" href="Ofinanc2_8h.html#a40a14">S1_OTHER_OPERATING_INCOME</a>;
03010     <span class="keywordtype">float</span> lastValue = other_operating_income_real_growth;
03011     other_operating_income_real_growth = math.time_variation(lastValue, (<span class="keywordtype">float</span>) other_operating_income_real_growth_last2, -0.4775f, -0.228f, 0.0255838f);
03012     other_operating_income_real_growth_last2 = lastValue;
03013 
03014     stage1_revenue[i].new_value = stage1_revenue[i].base_value * (1.0 + inflation_rate/100.0 + other_operating_income_real_growth);
03015 
03016     <span class="comment">//----------------------------//</span>
03017     <span class="comment">//static float state_appropriation_real_growth = math.get_random_snd(.015f, .01f);          // 0.99-&gt;99%  //## chea 300899 put these in the opt stage 1 above</span>
03018     <span class="comment">//## chea 300899 put these in the opt stage 1 above</span>
03019     <span class="keyword">static</span> <span class="keywordtype">float</span> state_appropriation_real_growth_last2 = 0;
03020 
03021     i = <a class="code" href="Ofinanc2_8h.html#a40a16">S1_STATE_APPROPRIATION</a>;
03022     lastValue = state_appropriation_real_growth;
03023     state_appropriation_real_growth = math.time_variation(lastValue, (<span class="keywordtype">float</span>) state_appropriation_real_growth_last2, 1.4482f, -0.8011f, 0.008822370f);
03024     state_appropriation_real_growth_last2 = lastValue;
03025 
03026     <span class="keywordtype">float</span> randomV = math.get_random_snd(0.0f, <a class="code" href="Opschool_8h.html#a1">PSCH_SD</a>(0.0075f));
03027 
03028     stage1_revenue[i].new_value = stage1_revenue[i].base_value * (1.0 + inflation_rate/100.0 + state_appropriation_real_growth + randomV);
03029 
03030     <span class="comment">//----------------------------//</span>
03031     <span class="keywordtype">double</span> bank_deposit_rate = inflation_rate + .01;<span class="comment">// 1021</span>
03032     <span class="keywordtype">double</span> opReserve = last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>];
03033     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a15">S1_INTEREST_EARNED_OR_PAID</a>].new_value = (opReserve &gt; 0) ? bank_deposit_rate * opReserve / 100 : 0;
03034     <span class="comment">//## chea 020999 BUGHERE computed_growthrate =48%</span>
03035     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a17">S1_RESEARCH_INDIRECTS</a>].new_value = stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a19">S1_DIRECT_SPONSORED_RESEARCH</a>].base_value*stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a17">S1_RESEARCH_INDIRECTS</a>].computed_growthrate / 100.0;
03036     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a18">S1_ENDOWMENT_SPENDING</a>].new_value = stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a18">S1_ENDOWMENT_SPENDING</a>].adjusted_base*(1.0 + stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a18">S1_ENDOWMENT_SPENDING</a>].computed_growthrate / 100.0);
03037 
03038     <span class="comment">// special update tution rate here // with bill on 980902</span>
03039     <span class="comment">// real value will be calc'ed at update_external_factors_yearly() on 1st of October</span>
03040     <span class="comment">//</span>
03041     i = <a class="code" href="Ofinanc2_8h.html#a40a10">S1_GROSS_TUITION_INCOME</a>;
03042     <span class="keywordtype">int</span> tmpTuitionRate = int( tuition_rate * (1.0 + stage1_revenue[i].computed_growthrate/100.0) );
03043     stage1_revenue[i].new_value = float(tmpTuitionRate) * student_policy_array[<a class="code" href="Ofinance_8h.html#a106a63">PL_TOTAL</a>].estimate_next_year / 1000.0f;
03044 
03045     <span class="comment">// init 4th column of expense of the table "Strucaltural equations (usedin Stage1)" in ResAlloc.ex.xls file</span>
03046     <span class="comment">//</span>
03047     stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a21">S1_FACULTY_SALARY_INCREASES</a>].computed_growthrate = expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a70">PL_FACULTY_SALARY_INCREASES</a>].result_value + inflation_rate;
03048     stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a22">S1_STAFF_SALARY_INCREASES</a>].computed_growthrate = expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a71">PL_STAFF_SALARY_INCREASES</a>].result_value + inflation_rate;
03049     stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a23">S1_OTHER_COST_RISE_PROVISION</a>].computed_growthrate = other_expense_growth + inflation_rate;
03050     stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a24">S1_NET_OPERATING_BUGET_GROWTH</a>].computed_growthrate = expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a72">PL_BUDGET_ADJUSTMENT</a>].result_value;
03051     stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a26">S1_REAL_TRANSFER_TO_PLANT_GROWTH</a>].computed_growthrate = expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a73">PL_REAL_TRANSFER_TO_PLANT_GROWTH</a>].result_value + inflation_rate;
03052 
03053     <span class="comment">// init 5th column of expense of the table "Strucaltural equations (usedin Stage1)" in ResAlloc.ex.xls file</span>
03054     <span class="comment">//</span>
03055     <span class="keywordflow">for</span> (i=<a class="code" href="Ofinanc2_8h.html#a42a21">S1_FACULTY_SALARY_INCREASES</a>; i&lt;=<a class="code" href="Ofinanc2_8h.html#a42a23">S1_OTHER_COST_RISE_PROVISION</a>; i++)
03056         stage1_expense[i].new_value = stage1_expense[i].base_value * (1+stage1_expense[i].computed_growthrate / 100);
03057     stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a24">S1_NET_OPERATING_BUGET_GROWTH</a>].new_value = stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a24">S1_NET_OPERATING_BUGET_GROWTH</a>].base_value * (stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a24">S1_NET_OPERATING_BUGET_GROWTH</a>].computed_growthrate / 100.0);
03058     stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a25">S1_DEBT_SERVICE_GROWTH</a>].new_value = stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a25">S1_DEBT_SERVICE_GROWTH</a>].base_value;
03059     stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a26">S1_REAL_TRANSFER_TO_PLANT_GROWTH</a>].new_value = stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a26">S1_REAL_TRANSFER_TO_PLANT_GROWTH</a>].base_value * (1+stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a26">S1_REAL_TRANSFER_TO_PLANT_GROWTH</a>].computed_growthrate / 100.0);
03060 
03061     <span class="comment">// special case (last row of the table)</span>
03062     <span class="comment">// stage1_revenue[S1_DIRECT_SPONSORED_RESEARCH].computed_growthrate is useless in this special case</span>
03063     <span class="comment">//</span>
03064     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a19">S1_DIRECT_SPONSORED_RESEARCH</a>].adjusted_base =
03065         expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].faculty*(1+inflation_rate/100.0 + expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a70">PL_FACULTY_SALARY_INCREASES</a>].result_value / 100.0);
03066 
03067     stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a19">S1_DIRECT_SPONSORED_RESEARCH</a>].new_value =
03068         stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a19">S1_DIRECT_SPONSORED_RESEARCH</a>].adjusted_base
03069         - stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a19">S1_DIRECT_SPONSORED_RESEARCH</a>].adjust;
03070 
03071     <span class="keywordflow">return</span>;
03072 <span class="preprocessor">#endif                                          // remove stage1_revenue, stage1_expense, stage2_expense</span>
03073 <span class="preprocessor"></span>}
03074 
03075 <span class="comment">//------- End of function Finance::adjust_budget_1 --------//</span>
03076 
03077 <span class="comment">//------ Begin of function Finance::init_optimize_policy_2 ------//</span>
03082 <span class="comment">void Finance::init_optimize_policy_2() {</span>
03083 <span class="preprocessor">#if(GAME_VERSION&gt;=200)                          // remove stage1_revenue, stage1_expense, stage2_expense</span>
03084 <span class="preprocessor"></span>
03085     <span class="comment">// temp put here</span>
03086     prior_dept_fac_exp = expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].faculty;
03087 
03088 <span class="preprocessor">#else                                           // remove stage1_revenue, stage1_expense, stage2_expense</span>
03089 <span class="preprocessor"></span>
03090     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"finance.opt_policy_2(): start"</span>);
03091 
03092     <span class="keywordtype">int</span> i,j;
03093 
03094     <span class="comment">// ---------- init first column ---------- //</span>
03095     <span class="comment">//</span>
03096     stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a28">S2_DEPARTMENTAL_FACULTY</a>].base_value = department_array.total_faculty_count;
03097 
03098     <span class="comment">// (1+C72+C116)</span>
03099     <span class="keyword">const</span> <span class="keywordtype">double</span> cons1 = (1 + inflation_rate/100.0 + expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a71">PL_STAFF_SALARY_INCREASES</a>].result_value / 100.0);
03100     <span class="comment">// (1+C72+G77)</span>
03101     <span class="keyword">const</span> <span class="keywordtype">double</span> cons2 = (1 + inflation_rate/100.0 + other_expense_growth/100.0);
03102     stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a29">S2_DEPARTMENTAL_NON_FACULTY</a>].base_value
03103         <span class="comment">//=D30*(1+C72+C116)+E30*(1+C72+G77)</span>
03104         = cons1 * expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].staff + cons2 * expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].other;
03105 
03106     <span class="comment">// from D32*cons1 + E30*cons2 up to (D38, E38)</span>
03107     <span class="comment">//</span>
03108     <span class="keywordflow">for</span> ( i=<a class="code" href="Ofinanc2_8h.html#a44a30">S2_LIBRARIES</a>, j=<a class="code" href="Ofinance_8h.html#a104a47">AC_LIBRARIES</a>;
03109           i&lt;=<a class="code" href="Ofinanc2_8h.html#a44a37">S2_ENROLLMENT_MANAGEMENT</a>;
03110           i++, j++ )
03111         stage2_expense[i].base_value = cons1 * expense_array[j].staff + cons2 * expense_array[j].other;
03112 
03113     <span class="comment">// break libit to lib and it!</span>
03114     <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="Ofinance_8h.html#a104a54">AC_ENROLLMENT_MANAGEMENT</a> != <a class="code" href="Ofinanc2_8h.html#a44a37">S2_ENROLLMENT_MANAGEMENT</a>);
03115 
03116     <span class="comment">//------- get athetics expense inputs to optimization -----//</span>
03117 
03118     <span class="keywordtype">int</span> athleticRev = 0;
03119     <span class="keywordtype">int</span> athleticExp = 0;
03120     <span class="comment">// passed by reference</span>
03121     athletics_office.calc_adjusted_revenue_expense(athleticRev, athleticExp);
03122     stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a33">S2_ATHLETICS</a>].base_value = athleticExp;
03123 
03124     <span class="comment">// ---------- init 2nd column ---------- //</span>
03125     <span class="comment">//</span>
03126 
03127     <span class="comment">// temp put here</span>
03128     prior_dept_fac_exp = expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].faculty;
03129 
03130     stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a28">S2_DEPARTMENTAL_FACULTY</a>].dept_faculty_new_price =
03131         <span class="comment">//990525        stage2_expense[S2_DEPARTMENTAL_FACULTY].base_value * avg_faculty_compensation</span>
03132         prior_dept_fac_exp
03133         * (1+inflation_rate/100.0+expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a70">PL_FACULTY_SALARY_INCREASES</a>].result_value/100.0);
03134 <span class="preprocessor">#endif                                          // remove stage1_revenue, stage1_expense, stage2_expense</span>
03135 <span class="preprocessor"></span>}
03136 
03137 <span class="comment">//------ End of function Finance::init_optimize_policy_2 ------//</span>
03138 
03139 <span class="comment">//------ Begin of function Finance::optimize_policy_2 ------//</span>
<a name="l03144"></a><a class="code" href="classFinance.html#a12">03144</a> <span class="comment">bool Finance::optimize_policy_2() {</span>
03145     <span class="comment">// to calculate FinancePolicy::result_value based on</span>
03146     <span class="comment">// other vars in the struct FinancePolicy.</span>
03147 
03148     <span class="keywordtype">int</span> i;
03149 
03150 <span class="preprocessor">#ifdef DEBUG_VC</span>
03151 <span class="preprocessor"></span>    <a class="code" href="classString.html">String</a> s;
03152 
03153     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"---- INPUT TO Finance::optimize_policy_2(): l,t,u,w ----"</span>);
03154     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; i++) {
03155         <a class="code" href="structFinancePolicy.html">FinancePolicy</a>&amp; policy = cost_rise_policy_array[i];
03156         sprintf(s, <span class="stringliteral">"%.3f, %.3f, %.3f, %.3f,"</span>,
03157                 policy.<a class="code" href="structFinancePolicy.html#m1">lower_bound</a>, policy.<a class="code" href="structFinancePolicy.html#m0">target_value</a>, policy.<a class="code" href="structFinancePolicy.html#m2">upper_bound</a>, policy.<a class="code" href="structFinancePolicy.html#m3">import_weight</a>);
03158 
03159         <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(s);
03160     }
03161 <span class="preprocessor">#endif</span>
03162 <span class="preprocessor"></span>
03163     init_optimize_policy_2();
03164 
03165 <span class="preprocessor">#if(GAME_VERSION&gt;=200)                          // remove stage1_revenue, stage1_expense, stage2_expense</span>
03166 <span class="preprocessor"></span>
03167 <span class="preprocessor">#ifndef _DEBUG_STAGE2</span>
03168 <span class="preprocessor"></span>
03169     <span class="comment">// allocation stage 1</span>
03170     <span class="comment">// set input parameter</span>
03171     Revenue_and_Expense Base_Budget;                <span class="comment">// Base_Budget is projected actual on 1st Aug</span>
03172     Revenue_and_Expense Base_Actual;                <span class="comment">// Base_Actual is actual at year end</span>
03173     <span class="comment">// slider in stage 1 optimization; [0] is target, [1] is lower bound [2] is upper bound [3] is preference (weight)</span>
03174     <span class="keywordtype">float</span> PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>][4];
03175     <span class="comment">// slider in stage 2 optimization; [0] is target, [1] is lower bound [2] is upper bound [3] is preference (weight)</span>
03176     <span class="keywordtype">float</span> PL_Policy_Array_S2[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>][4];
03177     <span class="keywordtype">double</span> inflation, Base_tuition_rate;
03178     <span class="keywordtype">double</span> Base_enrollment, Target_enrollment, Actual_enrollment;
03179     <span class="keywordtype">double</span> Base_endowmentMV, Base_OpResBalance;
03180     <span class="keywordtype">float</span> ST_int_rate_01Aug, ST_int_rate_31Aug;
03181     <span class="keywordtype">double</span> New_Debt_service;
03182 
03183     input_Optimize_policy_ver2(
03184         Base_Budget,                                  <span class="comment">// Base_Budget is projected actual on 1st Aug</span>
03185         Base_Actual,                                  <span class="comment">// Base_Actual is actual at year end</span>
03186         PL_Policy_Array_S1,                           <span class="comment">// slider in stage 1 optimization; [0] is target, [1] is lower bound [2] is upper bound [3] is preference (weight)</span>
03187         PL_Policy_Array_S2,                           <span class="comment">// slider in stage 2 optimization; [0] is target, [1] is lower bound [2] is upper bound [3] is preference (weight)</span>
03188         inflation, Base_tuition_rate,
03189         Base_enrollment, Target_enrollment, Actual_enrollment,
03190         Base_endowmentMV, Base_OpResBalance,
03191         ST_int_rate_01Aug, ST_int_rate_31Aug,
03192         New_Debt_service );
03193 
03194 <span class="preprocessor">#else</span>
03195 <span class="preprocessor"></span>
03196     Revenue_and_Expense Base_Budget = {             <span class="comment">// Base_Budget is projected actual on 1st Aug</span>
03197         0.0, 0.0, {
03198             <span class="comment">// 10x4</span>
03199             { 0, 0, 0, 20000 },
03200             { 0, 0, 0, -3000 },
03201             { 0, 0, 0, 17000 },
03202             { 0, 3771, 2200, 5971 },
03203             { 0, 0, 0, 10000 },
03204             { 0, 0, 0, 10000 },
03205             { 0, 0, 0, 3000 },
03206             { 0, 0, 0, 12000 },
03207             { 0, 0, 0, 600 },
03208             { 0, 0, 0, 10000 }, {
03209             },
03210             <span class="comment">// 12x4</span>
03211             { 13311,    1430,     8321,     23062 },
03212             {    89,    1663,     2019,      3771 },
03213             {     0,    1622,    2019,     3641 },
03214             {     0,     234,      798,     1032 },
03215             {     0,    2921,     3225,     6146 },
03216             {     0,    3923,    1578,     5501 },
03217             {     0,    1778,    1550,     3328 },
03218             {     0,    6410,    5676,    12086 },
03219             {     0,     346,     992,     1338 },
03220             {     0,    1014,     753,     1767 },
03221             {     0,       0,    3887,     3887 },
03222             {     0,       0,    3049,     3049 },
03223         },
03224     };
03225 
03226     Revenue_and_Expense Base_Actual = {             <span class="comment">// Base_Actual is actual at year end</span>
03227         0.0, 0.0, {
03228             <span class="comment">// 10x4</span>
03229             { 0, 0, 0, 20000 },
03230             { 0, 0, 0, -3000 },
03231             { 0, 0, 0, 17000 },
03232             { 0, 3775, 2190, 5965 },
03233             { 0, 0, 0, 9928 },
03234             { 0, 0, 0, 10000 },
03235             { 0, 0, 0, 3013 },
03236             { 0, 0, 0, 12003 },
03237             { 0, 0, 0, 600 },
03238             { 0, 0, 0, 10000 }, {
03239             },
03240             <span class="comment">// 12x4</span>
03241             { 13307,    1430,     8321,     23058 },
03242             {    93,    1663,     2019,      3775 },
03243             {     0,    1600,    2100,     3700 },
03244             {     0,     230,      798,     1028 },
03245             {     0,    3000,     3225,     6225 },
03246             {     0,    3923,    1578,     5501 },
03247             {     0,    1778,    1550,     3328 },
03248             {     0,    6500,    5600,    12100 },
03249             {     0,     346,     992,     1338 },
03250             {     0,     998,     753,     1751 },
03251             {     0,       0,    3887,     3887 },
03252             {     0,       0,    3049,     3049 },
03253         },
03254     };
03255 
03256     <span class="keywordtype">float</span> PL_Policy_Array_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>][4] = { {
03257         <span class="comment">// revenue</span>
03258         0.02f,   0.00f, 0.05f,  2
03259     },
03260                                                                                { 0.01f, -0.05f, 0.05f, 2 },
03261                                                                                { 0.05f,  0.04f, 0.10f, 2 },
03262                                                                                { 0.583f, 0.20f, 0.70f, 2 }, {
03263                                                                                    <span class="comment">// expense</span>
03264                                                                                    0.01f, -0.05f, 0.05f, 2
03265                                                                                },
03266                                                                                { 0.01f, -0.05f, 0.05f, 2 },
03267                                                                                { 0.02f, -0.05f, 0.05f, 2 },
03268                                                                                { 0.02f, -0.05f, 0.05f, 2 },
03269                                                                                { 0.01f, -0.03f, 0.03f, 2 },
03270     };
03271     <span class="keywordtype">float</span> PL_Policy_Array_S2[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>][4] = {
03272         { 0.01f, -0.05f, 0.05f, 2 },
03273         { 0.00f, -0.05f, 0.05f, 2 },
03274         { 0.01f, -0.05f, 0.05f, 2 },
03275         { 0.00f, -0.05f, 0.05f, 2 },
03276         { 0.01f, -0.05f, 0.05f, 2 },
03277         { 0.00f, -0.05f, 0.05f, 2 },
03278         { 0.01f, -0.05f, 0.05f, 2 },
03279         {-0.02f, -0.05f, 0.05f, 2 },
03280         { 0.00f, -0.05f, 0.05f, 2 },
03281         {-0.02f, -0.05f, 0.05f, 2 },
03282     };
03283 
03284     <span class="keywordtype">double</span> inflation = 0.0/100.0;
03285     <span class="keywordtype">double</span> Base_tuition_rate = 4000.0;
03286     <span class="keywordtype">double</span> Base_enrollment = 5000;
03287     <span class="keywordtype">double</span> Target_enrollment = 5200;
03288     <span class="keywordtype">double</span> Actual_enrollment = 5100;
03289     <span class="keywordtype">double</span> Base_endowmentMV = 220000.0;
03290     <span class="keywordtype">double</span> Base_OpResBalance = 21000.0;
03291     <span class="keywordtype">float</span> ST_int_rate_01Aug = 0.03f;
03292     <span class="keywordtype">float</span> ST_int_rate_31Aug = 0.031f;
03293     <span class="keywordtype">double</span> New_Debt_service = 4500.0;
03294 <span class="preprocessor">#endif</span>
03295 <span class="preprocessor"></span>
03296     <span class="comment">// calc Surplus_Deficit</span>
03297     Base_Budget.calc_Surplus_Deficit();
03298     Base_Actual.calc_Surplus_Deficit();
03299 
03300     <span class="comment">// output</span>
03301     Revenue_and_Expense Trial_Budget, Final_Budget;
03302     <span class="comment">// result of stage 1</span>
03303     <span class="keywordtype">float</span> Result_Vector_S1[<a class="code" href="Ofinance_8h.html#a107a64">REVENUE_POLICY_COUNT</a>+<a class="code" href="Ofinance_8h.html#a109a69">EXPENSE_POLICY_COUNT</a>];
03304     <span class="keywordtype">float</span> Result_Vector_S2[<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>]; <span class="comment">// result of stage 2</span>
03305 
03306     Optimize_policy_ver2( Trial_Budget, Final_Budget,
03307                           Result_Vector_S1, Result_Vector_S2,
03308                           2,                                            <span class="comment">// end at stage 2</span>
03309                           Base_Budget, Base_Actual,
03310                           PL_Policy_Array_S1, PL_Policy_Array_S2,
03311                           inflation, Base_tuition_rate, Base_enrollment, Target_enrollment,
03312                           Actual_enrollment, Base_endowmentMV, Base_OpResBalance, ST_int_rate_01Aug,
03313                           ST_int_rate_31Aug, New_Debt_service );
03314 
03315     <span class="comment">// ignore Result_Vector_S1</span>
03316     <span class="comment">// Result_Vector_S2</span>
03317 
03318     <span class="comment">// -------------- assign the result to array ---------------- //</span>
03319     <span class="comment">//</span>
03320     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; i++) {
03321         <span class="comment">//captial campaign</span>
03322         <span class="keywordflow">if</span> (i==<a class="code" href="Ofinance_8h.html#a112a82">PL_INST_ADVANCEMENT</a> &amp;&amp; info.game_year&lt;=chance_event.capital_campaign_end_year) {
03323 
03324             expense_array[<a class="code" href="Ofinance_8h.html#a104a51">AC_INST_ADVANCEMENT</a>].total*= chance_event.capital_campaign_lock_ins_pect;
03325             projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a51">AC_INST_ADVANCEMENT</a>].change_budget_year.total=(chance_event.capital_campaign_lock_ins_pect-1.0f);
03326             cost_rise_policy_array[<a class="code" href="Ofinance_8h.html#a112a82">PL_INST_ADVANCEMENT</a>].result_value = chance_event.capital_campaign_lock_ins_pect;
03327         }
03328         <span class="keywordflow">else</span> {
03329             cost_rise_policy_array[i].result_value = Result_Vector_S2[i] * 100.0;
03330         }
03331     }
03332 
03333     <span class="comment">// Trial_Budget, Final_Budget</span>
03334 
03335     <span class="comment">// set budget_revenue_array, and budget_expense_array</span>
03336     <span class="comment">// instead of in calc_budget_report()</span>
03337     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; ++i ) {
03338         <span class="keywordflow">if</span>( i == <a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a> ) {
03339             budget_revenue_array[i].direct = Final_Budget.Revenue_Array[i][1];
03340             budget_revenue_array[i].indirect = Final_Budget.Revenue_Array[i][2];
03341         }
03342         <span class="keywordflow">else</span> {
03343             budget_revenue_array[i].direct = 0.0f;
03344             budget_revenue_array[i].indirect = 0.0f;
03345         }
03346         budget_revenue_array[i].total = Final_Budget.Revenue_Array[i][3];
03347     }
03348     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; ++i ) {
03349         budget_expense_array[i].faculty = Final_Budget.Expense_Array[i][0];
03350         budget_expense_array[i].staff = Final_Budget.Expense_Array[i][1];
03351         budget_expense_array[i].other = Final_Budget.Expense_Array[i][2];
03352         budget_expense_array[i].total = Final_Budget.Expense_Array[i][3];
03353     }
03354 
03355 <span class="preprocessor">#else                                           // remove stage1_revenue, stage1_expense, stage2_expense</span>
03356 <span class="preprocessor"></span>
03357     <span class="comment">// to calculate FinancePolicy::result_value based on</span>
03358     <span class="comment">// other vars in the struct FinancePolicy.</span>
03359 
03360     <span class="keyword">const</span> <span class="keywordtype">short</span> nTake = <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>;
03361     RowVector surplusCoefs(nTake);
03362     ColumnVector surplusRHS(1), co(nTake);
03363     co = 1.0;
03364     <span class="keywordtype">double</span> adjPriorBase; {
03365 
03366 <span class="preprocessor">#ifndef _DEBUG_STAGE2</span>
03367 <span class="preprocessor"></span>        <span class="comment">//89735</span>
03368         <span class="keywordtype">int</span> d217 = (int) stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a28">S2_DEPARTMENTAL_FACULTY</a>].dept_faculty_new_price;
03369         <span class="comment">//39953</span>
03370         <span class="keywordtype">int</span> c218 = (int) stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a29">S2_DEPARTMENTAL_NON_FACULTY</a>].base_value;
03371         <span class="comment">//13196</span>
03372         <span class="keywordtype">int</span> c219 = (int) stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a30">S2_LIBRARIES</a>].base_value;
03373         <span class="comment">//13196</span>
03374         <span class="keywordtype">int</span> c219a = (int) stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a31">S2_IT_RESOURCES</a>].base_value;
03375         <span class="comment">//10839</span>
03376         <span class="keywordtype">int</span> c220 = (int) stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a32">S2_STUDENT_LIFE</a>].base_value;
03377 
03378         <span class="comment">//8781</span>
03379         <span class="keywordtype">int</span> c221 = (int) stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a33">S2_ATHLETICS</a>].base_value;
03380         <span class="comment">//4856</span>
03381         <span class="keywordtype">int</span> c222 = (int) stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a34">S2_INST_ADVANCEMENT</a>].base_value;
03382         <span class="comment">//25275</span>
03383         <span class="keywordtype">int</span> c223 = (int) stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a35">S2_ADMINISTRATION</a>].base_value;
03384         <span class="comment">//13927</span>
03385         <span class="keywordtype">int</span> c224 = (int) stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a36">S2_OPERATIONS_AND_MAINTENANCE</a>].base_value;
03386         <span class="comment">//8210</span>
03387         <span class="keywordtype">int</span> c225 = (int) stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a37">S2_ENROLLMENT_MANAGEMENT</a>].base_value;
03388 
03389         <span class="comment">// 990524</span>
03390         <span class="keywordtype">int</span> g206 = (int) stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a24">S1_NET_OPERATING_BUGET_GROWTH</a>].new_value;
03391 <span class="preprocessor">#else</span>
03392 <span class="preprocessor"></span>        <span class="keywordtype">int</span> d217 = 89735;
03393         <span class="keywordtype">int</span> c218 = 39953;
03394         <span class="keywordtype">int</span> c219 = 13196;
03395         <span class="keywordtype">int</span> c219a = c219;
03396         <span class="keywordtype">int</span> c220 = 10839;
03397 
03398         <span class="keywordtype">int</span> c221 = 8781;
03399         <span class="keywordtype">int</span> c222 = 4856;
03400         <span class="keywordtype">int</span> c223 = 25275;
03401         <span class="keywordtype">int</span> c224 = 13927;
03402         <span class="keywordtype">int</span> c225 = 8210;
03403 <span class="preprocessor">#endif</span>
03404 <span class="preprocessor"></span>
03405         <span class="comment">//      Elements of revenue and expense</span>
03406         <span class="comment">/*</span>
03407 <span class="comment">          deptFac                       = d217*x1;</span>
03408 <span class="comment">          otherDeptExp  = c218*x2;</span>
03409 <span class="comment">          libAndIT              = c219*x3;                      IT = 219a * x 3a</span>
03410 <span class="comment">          studLife              = c220*x4;</span>
03411 <span class="comment">          athletics             = c221*x5;</span>
03412 <span class="comment">          instAdv                       = c222*x6;</span>
03413 <span class="comment">          admin                 = c223*x7;</span>
03414 <span class="comment">          OandM                 = c224*x8;</span>
03415 <span class="comment">          otherOpExp            = c225*x9;</span>
03416 <span class="comment"></span>
03417 <span class="comment">          totalBudgetAdj        = deptFac + otherDeptExp + libAndIT + studLife + athletics +</span>
03418 <span class="comment">          instAdv + admin + OandM + otherOpExp;</span>
03419 <span class="comment"></span>
03420 <span class="comment">          surplusCoefs2 =</span>
03421 <span class="comment">          (Coefficient[totalBudgetAdj,#]&amp;/@({x1,x2,x3,x4,x5,x6,x7,x8,x9}))/adjPriorBase;</span>
03422 <span class="comment"></span>
03423 <span class="comment">          surplusRHS2 = f226/adjPriorBase + surplusCoefs2.co;</span>
03424 <span class="comment"></span>
03425 <span class="comment">        */</span>
03426 
03427         <span class="keywordtype">double</span> c72  = inflation_rate / 100.0;         <span class="comment">//0.03;</span>
03428         <span class="comment">// 990408 float f38             = (float) total_operating_expense.total;        //227667;</span>
03429         <span class="keywordtype">float</span> f42 = (float) total_expense.total;
03430 
03431         adjPriorBase  = f42*(1.02+c72);
03432 
03433         <a class="code" href="ALL_8H.html#a0">err_when</a>(adjPriorBase == 0);
03434 
03435         <span class="comment">// 990524 int f226 = (int)  -192;</span>
03436 
03437         <span class="keywordtype">double</span> tmp[nTake] = {
03438             d217/adjPriorBase, c218/adjPriorBase, c219/adjPriorBase, c219a/adjPriorBase,
03439             c220/adjPriorBase, c221/adjPriorBase, c222/adjPriorBase, c223/adjPriorBase,
03440             c224/adjPriorBase, c225/adjPriorBase
03441         };
03442         surplusCoefs &lt;&lt; tmp;
03443 
03444         surplusRHS(1) = g206/adjPriorBase + (surplusCoefs * co).AsScalar();
03445     }
03446 
03447     ColumnVector targets(nTake), weights(nTake), lowerBound(nTake), upperBound(nTake);
03448     <span class="comment">// Equivalent Mathematica code:</span>
03449     <span class="comment">// targets          = co+{t1,t2,t3,t4,t5,t6,t7,t8,t9};</span>
03450     <span class="comment">// weights          = co+{w1,w2,w3,w4,w5,w6,w7,w8,w9};</span>
03451     <span class="comment">// lowerBound       = co+{f1,f2,l3,f4,f5,f6,f7,f8,f9};</span>
03452     <span class="comment">// upperBound       = co+{u1,u2,u3,u4,u5,u6,u7,u8,u9};</span>
03453 
03454     <span class="keywordflow">for</span> (i=0; i&lt;nTake; i++) {
03455         targets(i+1) = cost_rise_policy_array[i].target_value / 100.0;
03456         weights(i+1) = cost_rise_policy_array[i].import_weight;
03457         lowerBound(i+1) = cost_rise_policy_array[i].lower_bound / 100.0;
03458         upperBound(i+1) = cost_rise_policy_array[i].upper_bound / 100.0;
03459     }
03460 
03461     targets += co;
03462     lowerBound += co;
03463     upperBound += co;
03464 
03465     <span class="comment">// 990521</span>
03466 
03467     <span class="keywordflow">for</span> (i=1; i&lt;=nTake; i++)
03468         weights(i) *= <a class="code" href="OLINALG_8CPP.html#a2">fabs</a>(surplusCoefs(i));
03469 
03470     <span class="comment">//--------- create the Quadratic Program input matrices     -----------//</span>
03471     DiagonalMatrix Q(nTake);  Q.set_diagonal(weights);
03472     ColumnVector c  = - (targets.t() * Q).t();
03473     DiagonalMatrix I(nTake);  I = 1;
03474     <a class="code" href="classMatrix.html">Matrix</a> A      = I &amp; -I;
03475     ColumnVector b  = lowerBound &amp; -upperBound;
03476 
03477     b = b &amp; surplusRHS &amp; -surplusRHS;
03478     A = A &amp; surplusCoefs &amp; -surplusCoefs;
03479 
03480     <span class="comment">//---------- main program --------------//</span>
03481     <span class="comment">//</span>
03482     ColumnVector xNames(nTake);
03483     <span class="keywordflow">if</span> (!<a class="code" href="classLinearAlgebra.html#d0">LinearAlgebra::quadratic_prog</a>(c,Q,A,b,xNames))
03484         <span class="keywordflow">return</span> <span class="keyword">false</span>;
03485     xNames -=co;
03486 
03487     xNames *= 100;
03488     print_vector2(xNames);
03489     <span class="comment">/*</span>
03490 <span class="comment">      xNames should be = {-0.00593504,-0.018642,0.0369214,-0.00505745,0.0479514,0.05,-0.0117932,</span>
03491 <span class="comment">      0.0217509,-0.00191538}</span>
03492 <span class="comment">    */</span>
03493 
03494     <span class="comment">// -------------- assign the result to array ---------------- //</span>
03495     <span class="comment">//</span>
03496     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>; i++) {
03497         <span class="comment">//captial campaign</span>
03498         <span class="keywordflow">if</span> (i==<a class="code" href="Ofinance_8h.html#a112a82">PL_INST_ADVANCEMENT</a> &amp;&amp; info.game_year&lt;=chance_event.capital_campaign_end_year) {
03499 
03500             finance.expense_array[<a class="code" href="Ofinance_8h.html#a104a51">AC_INST_ADVANCEMENT</a>].total*= chance_event.capital_campaign_lock_ins_pect;
03501             finance.projected_expense_array[<a class="code" href="Ofinance_8h.html#a104a51">AC_INST_ADVANCEMENT</a>].change_budget_year.total=(chance_event.capital_campaign_lock_ins_pect-1.0f);
03502 
03503             <span class="comment">//                  cost_rise_policy_array[PL_INST_ADVANCEMENT].result_value = chance_event.capital_campaign_lock_ins_pect;</span>
03504         }
03505         <span class="keywordflow">else</span>
03506             cost_rise_policy_array[i].result_value = xNames(i+1);
03507 
03508         <span class="comment">//              cost_rise_policy_array[i].bound_correction();   // chwg080399  //## chea240899</span>
03509     }
03510 
03511     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"finance.opt_policy_2(): end"</span>);
03512 <span class="preprocessor">#endif                                          // remove stage1_revenue, stage1_expense, stage2_expense</span>
03513 <span class="preprocessor"></span>
03514     adjust_budget_2();
03515 
03516     <span class="keywordflow">return</span> <span class="keyword">true</span>;
03517 }
03518 
03519 <span class="comment">//------- End of function Finance::optimize_policy_2 -------//</span>
03520 
03521 <span class="comment">//------ Begin of function Finance::adjust_budget_2 ------//</span>
03523 <span class="comment">void Finance::adjust_budget_2() {</span>
03524 <span class="preprocessor">#if(0)                                          // removing stage2_expense in version 2</span>
03525 <span class="preprocessor"></span><span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
03526 <span class="preprocessor"></span>
03527     <span class="keywordtype">int</span> i;
03528 
03529     <a class="code" href="ALL_8H.html#a0">err_when</a>(<a class="code" href="Ofinanc2_8h.html#a43a27">STAGE2_EXPENSE_POLICY_COUNT</a> != <a class="code" href="Ofinance_8h.html#a111a75">COST_RISE_POLICY_COUNT</a>);
03530 
03531     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="Ofinanc2_8h.html#a43a27">STAGE2_EXPENSE_POLICY_COUNT</a>; i++)
03532         stage2_expense[i].computed_growthrate = cost_rise_policy_array[i].result_value;
03533 
03534     stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a28">S2_DEPARTMENTAL_FACULTY</a>].change_value =
03535         stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a28">S2_DEPARTMENTAL_FACULTY</a>].dept_faculty_new_price
03536         *stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a28">S2_DEPARTMENTAL_FACULTY</a>].computed_growthrate / 100.0
03537         +stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a19">S1_DIRECT_SPONSORED_RESEARCH</a>].new_value;
03538 
03539     <span class="keywordflow">for</span> (i=<a class="code" href="Ofinanc2_8h.html#a44a29">S2_DEPARTMENTAL_NON_FACULTY</a>; i&lt;<a class="code" href="Ofinanc2_8h.html#a43a27">STAGE2_EXPENSE_POLICY_COUNT</a>; i++)
03540         stage2_expense[i].change_value = stage2_expense[i].base_value * stage2_expense[i].computed_growthrate / 100.0;
03541 
03542     <span class="comment">// last column</span>
03543     <span class="comment">//</span>
03544     stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a28">S2_DEPARTMENTAL_FACULTY</a>].new_value
03545         = stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a28">S2_DEPARTMENTAL_FACULTY</a>].dept_faculty_new_price
03546         + stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a28">S2_DEPARTMENTAL_FACULTY</a>].change_value
03547         - stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a19">S1_DIRECT_SPONSORED_RESEARCH</a>].new_value;
03548 
03549     <span class="keywordflow">for</span> (i=<a class="code" href="Ofinanc2_8h.html#a44a29">S2_DEPARTMENTAL_NON_FACULTY</a>; i&lt;<a class="code" href="Ofinanc2_8h.html#a43a27">STAGE2_EXPENSE_POLICY_COUNT</a>; i++)
03550         stage2_expense[i].new_value = stage2_expense[i].change_value + stage2_expense[i].base_value;
03551 
03552     <span class="keywordflow">return</span>;                                         <span class="comment">// ignore old code</span>
03553 <span class="preprocessor">#endif</span>
03554 <span class="preprocessor"></span><span class="preprocessor">#endif                                          // remove stage1_revenue, stage1_expense, stage2_expense</span>
03555 <span class="preprocessor"></span>}
03556 
03557 <span class="comment">//------- End of function Finance::adjust_budget_2 -------//</span>
03558 
03559 <span class="comment">//------ Begin of function Finance::calc_budget_report ------//</span>
<a name="l03563"></a><a class="code" href="classFinance.html#a31">03563</a> <span class="comment">void Finance::calc_budget_report() {</span>
03564     <span class="keywordtype">int</span> i,j;
03565 
03566 <span class="preprocessor">#if(GAME_VERSION&gt;=200)                          // remove stage1_revenue, stage1_expense, stage2_expense</span>
03567 <span class="preprocessor"></span>
03568     <span class="comment">// remember to set tuition_rate,</span>
03569 
03570     <span class="comment">// tuition_rate = int( tuition_rate * (1.0 + stage1_revenue[S1_GROSS_TUITION_INCOME].computed_growthrate/100.0) );  // 990609</span>
03571     <span class="comment">// resolve : stage1_revenue[S1_GROSS_TUITION_INCOME].computed_growthrate = inflation_rate + revenue_policy_array[PL_TUITION_RATE_GROWTH].result_value;</span>
03572     tuition_rate = int( tuition_rate * (1.0 + (inflation_rate + revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>].result_value)/100.0) );
03573 
03574     <span class="comment">// already set in optimize_report_2()</span>
03575     <span class="comment">// budget_revenue_array</span>
03576     <span class="comment">// budget_expense_array</span>
03577 
03578     <span class="comment">// budget_year.asset_array[AC_ENDOWMENT] = ?</span>
03579     transfer_operating_reserve = 0;
03580     transfer_capital_reserve = 0;
03581     transfer_quasi = 0;
03582 
03583     <span class="comment">// code where read finance.stage2_expense :</span>
03584     <span class="comment">// ofaci_st.cpp</span>
03585     <span class="comment">// float buget_monthly = float(finance.stage2_expense[S2_OPERATIONS_AND_MAINTENANCE].new_value / 12.0f);</span>
03586     <span class="comment">// stage2_expense[S2_OPERATIONS_AND_MAINTENANCE].new_value = (stage2_expense[S2_OPERATIONS_AND_MAINTENANCE].change_value + stage2_expense[S2_OPERATIONS_AND_MAINTENANCE].base_value );</span>
03587     <span class="comment">// stage2_expense[S2_OPERATIONS_AND_MAINTENANCE].change_value = stage2_expense[S2_OPERATIONS_AND_MAINTENANCE].base_value * stage2_expense[S2_OPERATIONS_AND_MAINTENANCE].computed_growthrate / 100.0;</span>
03588     <span class="comment">// stage2_expense[S2_OPERATIONS_AND_MAINTENANCE].base_value = cons1 * expense_array[AC_OPERATIONS_AND_MAINTENANCE].staff + cons2 * expense_array[AC_OPERATIONS_AND_MAINTENANCE].other</span>
03589     <span class="comment">// cons1 = (1 + inflation_rate/100.0 + expense_policy_array[PL_STAFF_SALARY_INCREASES].result_value / 100.0)</span>
03590     <span class="comment">// cons2 = (1 + inflation_rate/100.0 + other_expense_growth/100.0)</span>
03591     <span class="comment">// stage2_expense[S2_OPERATIONS_AND_MAINTENANCE].computed_growthrate = cost_rise_policy_array[AC_OPERATIONS_AND_MAINTENANCE].result_value;</span>
03592 
03593     <span class="comment">// ofin_s3.cpp</span>
03594     <span class="comment">//double growthRate = finance.stage2_expense[S2_DEPARTMENTAL_FACULTY].computed_growthrate / 100;            // = F203/100</span>
03595     <span class="comment">//double newValue = finance.stage2_expense[S2_DEPARTMENTAL_FACULTY].new_value;</span>
03596     <span class="comment">// stage2_expense[S2_DEPARTMENTAL_FACULTY].computed_growthrate = cost_rise_policy_array[AC_ACADEMIC_DEPARTMENTS].result_value;</span>
03597     <span class="comment">//stage2_expense[S2_DEPARTMENTAL_FACULTY].new_value</span>
03598     <span class="comment">//          = stage2_expense[S2_DEPARTMENTAL_FACULTY].dept_faculty_new_price</span>
03599     <span class="comment">//          + stage2_expense[S2_DEPARTMENTAL_FACULTY].change_value</span>
03600     <span class="comment">//          - stage1_revenue[S1_DIRECT_SPONSORED_RESEARCH].new_value;</span>
03601     <span class="comment">// stage2_expense[S2_DEPARTMENTAL_FACULTY].dept_faculty_new_price</span>
03602     <span class="comment">//          = prior_dept_fac_exp</span>
03603     <span class="comment">//          * (1+inflation_rate/100.0+expense_policy_array[PL_FACULTY_SALARY_INCREASES].result_value/100.0)</span>
03604     <span class="comment">//stage2_expense[S2_DEPARTMENTAL_FACULTY].change_value =</span>
03605     <span class="comment">//  stage2_expense[S2_DEPARTMENTAL_FACULTY].dept_faculty_new_price</span>
03606     <span class="comment">//  *stage2_expense[S2_DEPARTMENTAL_FACULTY].computed_growthrate / 100.0</span>
03607     <span class="comment">//  +stage1_revenue[S1_DIRECT_SPONSORED_RESEARCH].new_value;</span>
03608     <span class="comment">// no need find stage1_revenue[S1_DIRECT_SPONSORED_RESEARCH].new_value, will be cancel out</span>
03609 
03610     <span class="keywordtype">double</span> cons2, cons1;
03611 
03612 <span class="preprocessor">#else                                           // remove stage1_revenue, stage1_expense, stage2_expense</span>
03613 <span class="preprocessor"></span>
03614     memset( budget_revenue_array, 0, <span class="keyword">sizeof</span>(budget_revenue_array) );
03615     memset( budget_expense_array, 0, <span class="keyword">sizeof</span>(budget_expense_array) );
03616 
03617     <span class="comment">//</span>
03618     <span class="comment">// ----------- Revenue ----------- //</span>
03619     <span class="comment">//</span>
03620 
03621     <span class="comment">// 990609</span>
03622     tuition_rate = int( tuition_rate * (1.0 + stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a10">S1_GROSS_TUITION_INCOME</a>].computed_growthrate/100.0) );
03623 
03624 <span class="preprocessor">#define update_budget_revenue_array(destIndex, srcIndex) \</span>
03625 <span class="preprocessor">    budget_revenue_array[destIndex].total = stage1_revenue[srcIndex].new_value;</span>
03626 <span class="preprocessor"></span>
03627     update_budget_revenue_array(<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>, <a class="code" href="Ofinanc2_8h.html#a40a10">S1_GROSS_TUITION_INCOME</a>);
03628     update_budget_revenue_array(<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>, <a class="code" href="Ofinanc2_8h.html#a40a11">S1_FINANCIAL_AID</a>);
03629     budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>].total = budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].total + budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].total;
03630     <a class="code" href="ALL_8H.html#a0">err_when</a>(budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].total &lt;= 0);
03631 
03632     budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].direct = stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a19">S1_DIRECT_SPONSORED_RESEARCH</a>].base_value;
03633     budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].indirect
03634         = budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].direct * revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>].result_value/100.0;
03635     budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].total
03636         = budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].direct
03637         + budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].indirect;
03638 
03639     update_budget_revenue_array(<a class="code" href="Ofinance_8h.html#a101a36">AC_GIFTS</a>, <a class="code" href="Ofinanc2_8h.html#a40a12">S1_GIFTS</a>);
03640 
03641     <span class="comment">// BUGHERE_ENDOWMENT</span>
03642     <span class="comment">//  update_budget_revenue_array(AC_ENDOWMENT_SPENDING, S1_ENDOWMENT_SPENDING);</span>
03643 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
03644 <span class="preprocessor"></span>    budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].total = (last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]+last_year.asset_array[AC_QUASI])
03645         <span class="comment">// computed growth rate is the endowment spending rate</span>
03646         *stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a18">S1_ENDOWMENT_SPENDING</a>].computed_growthrate/100;
03647 <span class="preprocessor">#else</span>
03648 <span class="preprocessor"></span>    budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].total = last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]
03649         <span class="comment">// computed growth rate is the endowment spending rate</span>
03650         *stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a18">S1_ENDOWMENT_SPENDING</a>].computed_growthrate/100;
03651 <span class="preprocessor">#endif</span>
03652 <span class="preprocessor"></span>
03653     update_budget_revenue_array(<a class="code" href="Ofinance_8h.html#a101a38">AC_INTERCOLLEGIATE_ATHLETICS</a>, <a class="code" href="Ofinanc2_8h.html#a40a13">S1_INTERCOLLEGIATE_ATHLETICS</a>);
03654     update_budget_revenue_array(<a class="code" href="Ofinance_8h.html#a101a39">AC_OTHER_OPERATING_INCOME</a>, <a class="code" href="Ofinanc2_8h.html#a40a14">S1_OTHER_OPERATING_INCOME</a>);
03655 
03656     <span class="comment">//0219</span>
03657     budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a40">AC_INTEREST_EARNED_OR_PAID</a>].total = revenue_array[<a class="code" href="Ofinance_8h.html#a101a40">AC_INTEREST_EARNED_OR_PAID</a>].total;
03658 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
03659 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( info.prerun_year ) {
03660         update_budget_revenue_array(<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>, <a class="code" href="Ofinanc2_8h.html#a40a16">S1_STATE_APPROPRIATION</a>);
03661     }
03662     <span class="keywordflow">else</span>
03663         budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].total = projected_revenue_array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].this_year.total;
03664 <span class="preprocessor">#else</span>
03665 <span class="preprocessor"></span>    update_budget_revenue_array(<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>, <a class="code" href="Ofinanc2_8h.html#a40a16">S1_STATE_APPROPRIATION</a>);
03666 <span class="preprocessor">#endif</span>
03667 <span class="preprocessor"></span>
03668     <span class="comment">// -----------                                       ----------- //</span>
03669     <span class="comment">// ----------- Expenditures ----------- //</span>
03670     <span class="comment">// -----------                                       ----------- //</span>
03671 
03672     <span class="comment">// ----- 1st column ----- //</span>
03673     <span class="comment">//</span>
03674     <span class="comment">// because g227 = -d214 = -stage1_revenue[S1_DIRECT_SPONSORED_RESEARCH].adjusted</span>
03675     budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].faculty
03676         <span class="comment">//= calc_total_faculty_salary() * (1+stage2_expense[S2_DEPARTMENTAL_FACULTY].computed_growthrate / 100.0);      // 0223  // stage2_expense[S2_DEPARTMENTAL_FACULTY].new_value - stage1_revenue[S1_DIRECT_SPONSORED_RESEARCH].adjust;</span>
03677         = prior_dept_fac_exp * (1+stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a28">S2_DEPARTMENTAL_FACULTY</a>].computed_growthrate / 100.0);
03678     budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].faculty
03679         = stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a19">S1_DIRECT_SPONSORED_RESEARCH</a>].adjust;
03680 
03681     <span class="comment">//err_when(budget_expense_array[AC_ACADEMIC_DEPARTMENTS].faculty &lt; 0);              //askbill!?</span>
03682 
03683     <span class="comment">// ----- 2nd column ----- //</span>
03684     <span class="comment">//</span>
03685 
03686     <span class="comment">//## chea 010699 begin</span>
03687     <span class="comment">/*</span>
03688 <span class="comment">      budget_expense_array[AC_ACADEMIC_DEPARTMENTS].staff               //D248 = D30*G218/(D30+E30)</span>
03689 <span class="comment">      = expense_array[AC_ACADEMIC_DEPARTMENTS].staff * stage2_expense[S2_DEPARTMENTAL_NON_FACULTY].new_value</span>
03690 <span class="comment">      / ( expense_array[AC_ACADEMIC_DEPARTMENTS].staff + expense_array[AC_ACADEMIC_DEPARTMENTS].other );</span>
03691 <span class="comment"></span>
03692 <span class="comment">      budget_expense_array[AC_SPONSORED_RESEARCH_EXPENSE].staff</span>
03693 <span class="comment">      = stage1_revenue[S1_DIRECT_SPONSORED_RESEARCH].base_value * percent_of_sponsored_research_for_other_salaries/100.0;</span>
03694 <span class="comment"></span>
03695 <span class="comment">      double    cons1 = (1 + inflation_rate/100.0 + expense_policy_array[PL_STAFF_SALARY_INCREASES].result_value / 100.0);// (1+C72+C116)</span>
03696 <span class="comment">      double    cons2 = (1 + inflation_rate/100.0 + other_expense_growth/100.0);// (1+C72+G77)</span>
03697 <span class="comment"></span>
03698 <span class="comment">      for ( i=AC_LIBRARIES, j=S2_LIBRARIES;</span>
03699 <span class="comment">      j&lt;=S2_ENROLLMENT_MANAGEMENT;</span>
03700 <span class="comment">      i++, j++)</span>
03701 <span class="comment">      {</span>
03702 <span class="comment">      double base = (expense_array[i].staff * cons1 + expense_array[i].other * cons2); //C218=D30*(1+C72+C116)+E30*(1+C72+G77)</span>
03703 <span class="comment">      budget_expense_array[i].staff</span>
03704 <span class="comment">      = base ? stage2_expense[j].new_value * expense_array[i].staff * cons1 / base : 0;</span>
03705 <span class="comment">      }</span>
03706 <span class="comment">    */</span>
03707 
03708     budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].staff
03709         = stage1_revenue[<a class="code" href="Ofinanc2_8h.html#a40a19">S1_DIRECT_SPONSORED_RESEARCH</a>].base_value * <a class="code" href="Ofinance_8cpp.html#a3">percent_of_sponsored_research_for_other_salaries</a>/100.0;
03710 
03711     <span class="comment">// (1+C72+C116)</span>
03712     <span class="keywordtype">double</span>  cons1 = (1 + inflation_rate/100.0 + expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a71">PL_STAFF_SALARY_INCREASES</a>].result_value / 100.0);
03713     <span class="comment">// (1+C72+G77)</span>
03714     <span class="keywordtype">double</span>  cons2 = (1 + inflation_rate/100.0 + other_expense_growth/100.0);
03715 
03716     <span class="comment">//D30*(1+C72+C116)</span>
03717     <span class="keywordtype">double</span> newStaffExp=expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].staff*cons1;
03718     <span class="keywordtype">double</span> E218=stage2_expense[<a class="code" href="Ofinanc2_8h.html#a44a29">S2_DEPARTMENTAL_NON_FACULTY</a>].computed_growthrate / 100.0;
03719 
03720     <span class="comment">//D248=newStaffExp*(1+E218)</span>
03721     budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].staff = newStaffExp * (1+E218);
03722 
03723     <span class="keywordflow">for</span> ( i=<a class="code" href="Ofinance_8h.html#a104a47">AC_LIBRARIES</a>, j=<a class="code" href="Ofinanc2_8h.html#a44a30">S2_LIBRARIES</a>; j&lt;=<a class="code" href="Ofinanc2_8h.html#a44a37">S2_ENROLLMENT_MANAGEMENT</a>; i++,j++) {
03724 
03725         <span class="keywordtype">double</span> newStaff=expense_array[i].staff*cons1; <span class="comment">//D32*(1+C72+C116) first time loop</span>
03726 
03727         <span class="comment">//D250=newStaffExp*(1+E219)</span>
03728         budget_expense_array[i].staff = newStaff * (1+stage2_expense[j].computed_growthrate / 100.0);
03729 
03730     }
03731 
03732     <span class="comment">// ----- 3rd column ----- //</span>
03733     <span class="comment">//</span>
03734 
03735     <span class="comment">/*</span>
03736 <span class="comment">      budget_expense_array[AC_ACADEMIC_DEPARTMENTS].other               // =G218-D248</span>
03737 <span class="comment">      = stage2_expense[S2_DEPARTMENTAL_NON_FACULTY].new_value</span>
03738 <span class="comment">      - budget_expense_array[AC_ACADEMIC_DEPARTMENTS].staff;</span>
03739 <span class="comment">    */</span>
03740 
03741     <span class="comment">//E30*(1+C72+G77)</span>
03742     <span class="keywordtype">double</span> newOtherExp=expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].other*cons2;
03743     <span class="comment">//E248=newOtherExp*(1+E218)</span>
03744     budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].other=newOtherExp*(1+E218);
03745 
03746     <span class="keywordflow">for</span> ( i=<a class="code" href="Ofinance_8h.html#a104a47">AC_LIBRARIES</a>, j=<a class="code" href="Ofinanc2_8h.html#a44a30">S2_LIBRARIES</a>;j&lt;=<a class="code" href="Ofinanc2_8h.html#a44a37">S2_ENROLLMENT_MANAGEMENT</a>;i++,j++) {
03747 
03748         <span class="keywordtype">double</span> newOther=expense_array[i].other*cons2; <span class="comment">//E32*(1+C72+G77)  first time loop</span>
03749 
03750         <span class="comment">//E250=newOtherExp*(1+E219)</span>
03751         budget_expense_array[i].other=newOther*(1+stage2_expense[j].computed_growthrate / 100.0);
03752 
03753     }
03754 
03755     <span class="comment">// =F249-C249-D249</span>
03756     budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].other
03757         = budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>].direct
03758         - budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].faculty
03759         - budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a46">AC_SPONSORED_RESEARCH_EXPENSE</a>].staff;
03760 
03761     <span class="comment">/*  </span>
03762 <span class="comment">        //## chea 160899 don't know why it has been rem out</span>
03763 <span class="comment">        for ( i=AC_LIBRARIES, j=S2_LIBRARIES;</span>
03764 <span class="comment">        j&lt;=S2_ENROLLMENT_MANAGEMENT;</span>
03765 <span class="comment">        i++, j++)</span>
03766 <span class="comment">        {</span>
03767 <span class="comment">        budget_expense_array[i].other   = stage2_expense[j].new_value   - budget_expense_array[i].staff;</span>
03768 <span class="comment">        }</span>
03769 <span class="comment"></span>
03770 <span class="comment">        budget_expense_array[AC_SERVICE_ON_GENERAL_PLANT_DEBT].other</span>
03771 <span class="comment">        = stage1_expense[S1_DEBT_SERVICE_GROWTH].new_value;</span>
03772 <span class="comment">        budget_expense_array[AC_TRANSFER_TO_CAPITAL_RESERVE].other</span>
03773 <span class="comment">        = stage1_expense[S1_REAL_TRANSFER_TO_PLANT_GROWTH].new_value;</span>
03774 <span class="comment">        //## chea 160899 don't know why it has been rem out</span>
03775 <span class="comment">    */</span>
03776 
03777     <span class="comment">//## chea 240899 added back in</span>
03778     budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a55">AC_SERVICE_ON_GENERAL_PLANT_DEBT</a>].other
03779         = stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a25">S1_DEBT_SERVICE_GROWTH</a>].new_value;
03780     budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a56">AC_TRANSFER_TO_CAPITAL_RESERVE</a>].other
03781         = stage1_expense[<a class="code" href="Ofinanc2_8h.html#a42a26">S1_REAL_TRANSFER_TO_PLANT_GROWTH</a>].new_value;
03782 <span class="preprocessor">#endif                                          // remove stage1_revenue, stage1_expense, stage2_expense</span>
03783 <span class="preprocessor"></span>
03784     <span class="comment">//</span>
03785     <span class="comment">//----- complete the budget report -----//</span>
03786     <span class="comment">//</span>
03787 
03788     budget_calc_total();
03789     budget_calc_percent();
03790     <a class="code" href="ALL_8H.html#a0">err_when</a>(budget_total_expense.total&lt;=0);
03791     budget_year.surplus_deficit = budget_total_revenue.total - budget_total_expense.total;
03792 
03793     <span class="comment">//--- run the following function to make sure that the actual surplus/deficit matches the optimization result ---//</span>
03794 
03795     correct_surplus_deficit();
03796 
03797     <span class="comment">//----- balance sheet -----//</span>
03798     <span class="comment">//</span>
03799 
03800     cons2 = 1.0 + inflation_rate/100.0 + investment_office.expected_real_annual_return_rate/100.0;
03801     cons1 = 1.0 + inflation_rate/100.0 + short_term_debt_interest/100.0;
03802 
03803     budget_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>]   <span class="comment">//=D50*(1+C72+C73)+F263</span>
03804         = last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a20">AC_OPERATING_RESERVE</a>] * cons2 + budget_year.surplus_deficit;
03805 
03806 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
03807 <span class="preprocessor"></span>    <span class="keywordtype">double</span> ratio = last_year.asset_array[AC_QUASI] / (last_year.asset_array[AC_QUASI]+last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]);
03808 
03809     budget_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]           <span class="comment">//=D51*(1+C72+G72)-F241             // = D51-F241 by fred 1023</span>
03810         = last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]   + (investment_office.endowment_change_year_to_date
03811                                                    <span class="comment">// 990527</span>
03812                                                    - budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].total)*(1-ratio);
03813     + development_office.this_year.endowment;       <span class="comment">// 990608</span>
03814     budget_year.asset_array[AC_QUASI]               <span class="comment">//=D51*(1+C72+G72)-F241             // = D51-F241 by fred 1023</span>
03815         = last_year.asset_array[AC_QUASI] + (investment_office.endowment_change_year_to_date
03816                                              <span class="comment">// 990527</span>
03817                                              - budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].total)*ratio;
03818     + development_office.this_year.endowment;       <span class="comment">// 990608</span>
03819 
03820     transfer_operating_reserve = 0;
03821     transfer_capital_reserve = 0;
03822     transfer_quasi = 0;
03823 <span class="preprocessor">#else</span>
03824 <span class="preprocessor"></span>    budget_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>]           <span class="comment">//=D51*(1+C72+G72)-F241             // = D51-F241 by fred 1023</span>
03825         = last_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a22">AC_ENDOWMENT</a>] - budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a37">AC_ENDOWMENT_SPENDING</a>].total
03826         <span class="comment">// 990527</span>
03827         + investment_office.endowment_change_year_to_date;
03828     + development_office.this_year.endowment;       <span class="comment">// 990608</span>
03829 <span class="preprocessor">#endif</span>
03830 <span class="preprocessor"></span>
03831     <span class="comment">//vars not updated here</span>
03832     <span class="comment">//budget_year.asset_array[AC_BUILDINGS]</span>
03833     <span class="comment">//budget_year.asset_array[AC_CAPITAL_RESERVE]</span>
03834     <span class="comment">//budget_year.liability_array[AC_GENERAL_PLANT_DEBT]</span>
03835 
03836     <span class="comment">//budget_year.asset_array[AC_RESIDENCE]</span>
03837     <span class="comment">//budget_year.liability_array[AC_RESIDENCE_HALL_DEBT]</span>
03838 
03839     finance.budget_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a25">AC_ASSET_TOTAL</a>] = 0 ;
03840     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a96a19">ASSET_ITEM_COUNT</a>-1 ; i++ ) {
03841         finance.budget_year.asset_array[<a class="code" href="Ofinance_8h.html#a97a25">AC_ASSET_TOTAL</a>] += finance.budget_year.asset_array[i];
03842     }
03843 
03844     finance.budget_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a29">AC_LIABILITY_TOTAL</a>] = 0 ;
03845     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a98a26">LIABILITY_ITEM_COUNT</a>-1 ; i++ ) {
03846         finance.budget_year.liability_array[<a class="code" href="Ofinance_8h.html#a99a29">AC_LIABILITY_TOTAL</a>] += finance.budget_year.liability_array[i];
03847     }
03848 
03849     <span class="comment">// update budget_change w.r.t. last year</span>
03850     <span class="comment">// calculated yearly after optimization</span>
03851 
03852     <span class="comment">//</span>
03853     <span class="comment">// -------------- Step 2. -------------- change_last_year</span>
03854     <span class="comment">//</span>
03855 
03856     budget_calc_change();
03857 }
03858 
03859 <span class="comment">//------- End of function Finance::calc_budget_report -------//</span>
03860 
03861 <span class="comment">//------ Begin of function Finance::correct_surplus_deficit ------//</span>
<a name="l03863"></a><a class="code" href="classFinance.html#a14">03863</a> <span class="comment">void Finance::correct_surplus_deficit() {</span>
03864 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
03865 <span class="preprocessor"></span>    <span class="keywordflow">if</span>( 0 ) {                                       <span class="comment">// no longer need correct if use Optimize_policy_ver2</span>
03866 <span class="preprocessor">#endif</span>
03867 <span class="preprocessor"></span>
03868         <span class="comment">// fix in version 2</span>
03869         <span class="comment">// double diff = fabs(fabs(budget_total_expense.total*expense_policy_array[PL_SURPLUS_DEFICIT].result_value/100)-fabs(budget_year.surplus_deficit));</span>
03870         <span class="keywordtype">double</span> diff = <a class="code" href="OLINALG_8CPP.html#a2">fabs</a>( budget_total_expense.total*expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a74">PL_SURPLUS_DEFICIT</a>].result_value/100 - budget_year.surplus_deficit );
03871 
03872         <span class="comment">//lower rev , higher exp</span>
03873         <span class="keywordflow">if</span>((budget_total_expense.total*expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a74">PL_SURPLUS_DEFICIT</a>].result_value/100) &lt; (budget_year.surplus_deficit)) {
03874             <span class="keywordflow">if</span>( player_school.is_public() ) {           <span class="comment">// for public university, State appropriation will absorb the difference</span>
03875 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
03876 <span class="preprocessor"></span>                budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].total -= diff;
03877 <span class="preprocessor">#else</span>
03878 <span class="preprocessor"></span>                budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].total -= diff;
03879 <span class="preprocessor">#endif</span>
03880 <span class="preprocessor"></span>            }
03881             <span class="keywordflow">else</span> {
03882                 <span class="comment">//--- reduce from financial aid, but with a maximum of 50% of current financial aid amount ---//</span>
03883 
03884                 <span class="keywordtype">float</span> finAidDiff = min( diff/2, -budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].total/2 );
03885 
03886                 budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].total -= finAidDiff;
03887                 budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>].total =
03888                     budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].total + budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].total;
03889 
03890                 diff -= finAidDiff;                       <span class="comment">// the rest goes to academic expense for staff and other</span>
03891 
03892                 <span class="comment">//BUGHERE, we correct the problem in surplus/deficit by offseting the difference with academic staff and other expense. However, if the offset value is too large, it will make increase in staff and other seem very abnormal.</span>
03893 
03894                 <span class="comment">// distribute 0.3 to staff</span>
03895                 budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].staff += diff * 0.3f;
03896                 <span class="comment">// distribute 0.7 to other</span>
03897                 budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].other += diff * 0.7f;
03898             }
03899         }
03900         <span class="comment">//higher rev , lower exp</span>
03901         <span class="keywordflow">else</span> <span class="keywordflow">if</span>((budget_total_expense.total*expense_policy_array[<a class="code" href="Ofinance_8h.html#a110a74">PL_SURPLUS_DEFICIT</a>].result_value/100) &gt; (budget_year.surplus_deficit)) {
03902             <span class="keywordflow">if</span>( player_school.is_public() ) {           <span class="comment">// for public university, State appropriation will absorb the difference</span>
03903 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
03904 <span class="preprocessor"></span>                budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].total += diff;
03905 <span class="preprocessor">#else</span>
03906 <span class="preprocessor"></span>                budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a41">AC_STATE_APPROPRIATION</a>].total += diff;
03907 <span class="preprocessor">#endif</span>
03908 <span class="preprocessor"></span>            }
03909             <span class="keywordflow">else</span> {
03910                 <span class="comment">//--- reduce from financial aid, but with a maximum of 50% of current financial aid amount ---//</span>
03911 
03912                 <span class="keywordtype">float</span> finAidDiff = min( diff/2, -budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].total/2 );
03913 
03914                 budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].total += finAidDiff;
03915                 budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>].total =
03916                     budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a32">AC_GROSS_TUITION_INCOME</a>].total + budget_revenue_array[<a class="code" href="Ofinance_8h.html#a101a33">AC_FINANCIAL_AID</a>].total;
03917 
03918                 diff -= finAidDiff;                       <span class="comment">// the rest goes to academic expense for staff and other</span>
03919 
03920                 <span class="comment">// distribute 0.3 to staff</span>
03921                 budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].staff -= diff * 0.3f;
03922                 <span class="comment">// distribute 0.7 to other</span>
03923                 budget_expense_array[<a class="code" href="Ofinance_8h.html#a104a45">AC_ACADEMIC_DEPARTMENTS</a>].other -= diff * 0.7f;
03924             }
03925         }
03926 
03927         <span class="comment">/*</span>
03928 <span class="comment">          if(player_school.sponsored_research_intensity != 0)</span>
03929 <span class="comment">          diff = diff/3;        //spread over 3 items</span>
03930 <span class="comment">          else</span>
03931 <span class="comment">          diff = diff/2;        //spread over 2 items</span>
03932 <span class="comment"></span>
03933 <span class="comment">          if(player_school.sponsored_research_intensity != 0)</span>
03934 <span class="comment">          {</span>
03935 <span class="comment">          if((budget_total_expense.total*expense_policy_array[PL_SURPLUS_DEFICIT].result_value/100) &lt; (budget_year.surplus_deficit))  //lower rev , higher exp</span>
03936 <span class="comment">          {</span>
03937 <span class="comment">          budget_revenue_array[AC_GROSS_TUITION_INCOME].total -= (diff);</span>
03938 <span class="comment">          budget_revenue_array[AC_FINANCIAL_AID].total -= (diff);</span>
03939 <span class="comment">          budget_revenue_array[AC_NET_TUITION_INCOME].total =</span>
03940 <span class="comment">          budget_revenue_array[AC_GROSS_TUITION_INCOME].total + budget_revenue_array[AC_FINANCIAL_AID].total;</span>
03941 <span class="comment"></span>
03942 <span class="comment">          budget_expense_array[AC_ACADEMIC_DEPARTMENTS].other += (diff);</span>
03943 <span class="comment"></span>
03944 <span class="comment">          //                            budget_revenue_array[AC_SPONSORED_RESEARCH_REVENUE].direct += (diff);</span>
03945 <span class="comment">          //                            budget_expense_array[AC_SPONSORED_RESEARCH_EXPENSE].other += (diff);</span>
03946 <span class="comment">          }</span>
03947 <span class="comment">          else if((budget_total_expense.total*expense_policy_array[PL_SURPLUS_DEFICIT].result_value/100) &gt; (budget_year.surplus_deficit)) //higher rev , lower exp</span>
03948 <span class="comment">          {</span>
03949 <span class="comment">          budget_revenue_array[AC_GROSS_TUITION_INCOME].total += (diff);</span>
03950 <span class="comment">          budget_revenue_array[AC_FINANCIAL_AID].total += (diff);</span>
03951 <span class="comment">          budget_revenue_array[AC_NET_TUITION_INCOME].total =</span>
03952 <span class="comment">          budget_revenue_array[AC_GROSS_TUITION_INCOME].total + budget_revenue_array[AC_FINANCIAL_AID].total;</span>
03953 <span class="comment"></span>
03954 <span class="comment">          budget_expense_array[AC_ACADEMIC_DEPARTMENTS].other -= (diff);</span>
03955 <span class="comment"></span>
03956 <span class="comment">          //                            budget_revenue_array[AC_SPONSORED_RESEARCH_REVENUE].direct -= (diff);</span>
03957 <span class="comment">          //                            budget_expense_array[AC_SPONSORED_RESEARCH_EXPENSE].other -= (diff);</span>
03958 <span class="comment">          }</span>
03959 <span class="comment">          }</span>
03960 <span class="comment">          else // player_school.sponsored_research_intensity == 0</span>
03961 <span class="comment">          {</span>
03962 <span class="comment">          if((budget_total_expense.total*expense_policy_array[PL_SURPLUS_DEFICIT].result_value/100) &lt; (budget_year.surplus_deficit))  //lower rev , higher exp</span>
03963 <span class="comment">          {</span>
03964 <span class="comment">          //                    budget_revenue_array[AC_GROSS_TUITION_INCOME].total -= (diff);</span>
03965 <span class="comment">          budget_revenue_array[AC_FINANCIAL_AID].total -= (diff);</span>
03966 <span class="comment">          budget_revenue_array[AC_NET_TUITION_INCOME].total =</span>
03967 <span class="comment">          budget_revenue_array[AC_GROSS_TUITION_INCOME].total + budget_revenue_array[AC_FINANCIAL_AID].total;</span>
03968 <span class="comment"></span>
03969 <span class="comment">          budget_expense_array[AC_ACADEMIC_DEPARTMENTS].other += (diff);</span>
03970 <span class="comment">          }</span>
03971 <span class="comment">          else if((budget_total_expense.total*expense_policy_array[PL_SURPLUS_DEFICIT].result_value/100) &gt; (budget_year.surplus_deficit)) //higher rev , lower exp</span>
03972 <span class="comment">          {</span>
03973 <span class="comment">          //                    budget_revenue_array[AC_GROSS_TUITION_INCOME].total += (diff);</span>
03974 <span class="comment">          budget_revenue_array[AC_FINANCIAL_AID].total += (diff);</span>
03975 <span class="comment">          budget_revenue_array[AC_NET_TUITION_INCOME].total =</span>
03976 <span class="comment">          budget_revenue_array[AC_GROSS_TUITION_INCOME].total + budget_revenue_array[AC_FINANCIAL_AID].total;</span>
03977 <span class="comment"></span>
03978 <span class="comment">          budget_expense_array[AC_ACADEMIC_DEPARTMENTS].other -= (diff);</span>
03979 <span class="comment">          }</span>
03980 <span class="comment">          }</span>
03981 <span class="comment">        */</span>
03982 
03983 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
03984 <span class="preprocessor"></span>    }                                               <span class="comment">// end if prerun_year</span>
03985 <span class="preprocessor">#endif</span>
03986 <span class="preprocessor"></span>
03987     <span class="comment">//----------------------------//</span>
03988 
03989     budget_calc_total();
03990     budget_calc_percent();
03991     budget_year.surplus_deficit = budget_total_revenue.total - budget_total_expense.total;
03992 
03993 }
03994 
03995 <span class="comment">//------- End of function Finance::correct_surplus_deficit -------//</span>
03996 
03997 <span class="comment">//------ Begin of function Finance::budget_calc_change ------//</span>
<a name="l04001"></a><a class="code" href="classFinance.html#a35">04001</a> <span class="comment">void Finance::budget_calc_change() {</span>
04002     <a class="code" href="structRevenueItemChange.html">RevenueItemChange</a>* projRev;
04003     <a class="code" href="structExpenseItemChange.html">ExpenseItemChange</a>* projExp;
04004     <span class="keywordtype">double</span> temp;
04005 
04006     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; i++) {
04007         <span class="comment">//----- calculate change ------//</span>
04008 
04009         temp = revenue_array[i].direct;
04010         projRev = &amp;projected_revenue_array[i];
04011         projRev-&gt;<a class="code" href="structRevenueItemChange.html#m6">change_budget_year</a>.<a class="code" href="structRevenueItem.html#m0">direct</a>
04012             = calc_change( budget_revenue_array[i].direct, temp );
04013 
04014         temp = revenue_array[i].indirect;
04015         projRev = &amp;projected_revenue_array[i];
04016         projRev-&gt;<a class="code" href="structRevenueItemChange.html#m6">change_budget_year</a>.<a class="code" href="structRevenueItem.html#m1">indirect</a>
04017             = calc_change( budget_revenue_array[i].indirect, temp );
04018 
04019         temp = revenue_array[i].total;
04020         projRev = &amp;projected_revenue_array[i];
04021         projRev-&gt;<a class="code" href="structRevenueItemChange.html#m6">change_budget_year</a>.<a class="code" href="structRevenueItem.html#m2">total</a>
04022             = calc_change( budget_revenue_array[i].total, temp );
04023     }
04024 
04025     <span class="keywordflow">for</span> ( i=0; i&lt;<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; i++) {
04026         <span class="comment">//----- calculate change ------//</span>
04027 
04028         temp = expense_array[i].faculty;
04029         projExp = &amp;projected_expense_array[i];
04030         projExp-&gt;<a class="code" href="structExpenseItemChange.html#m6">change_budget_year</a>.<a class="code" href="structExpenseItem.html#m0">faculty</a>
04031             = calc_change( budget_expense_array[i].faculty, temp );
04032 
04033         temp = expense_array[i].staff;
04034         projExp = &amp;projected_expense_array[i];
04035         projExp-&gt;<a class="code" href="structExpenseItemChange.html#m6">change_budget_year</a>.<a class="code" href="structExpenseItem.html#m1">staff</a>
04036             = calc_change( budget_expense_array[i].staff, temp );
04037 
04038         temp = expense_array[i].other;
04039         projExp = &amp;projected_expense_array[i];
04040         projExp-&gt;<a class="code" href="structExpenseItemChange.html#m6">change_budget_year</a>.<a class="code" href="structExpenseItem.html#m2">other</a>
04041             = calc_change( budget_expense_array[i].other, temp );
04042 
04043         temp = expense_array[i].total;
04044         projExp = &amp;projected_expense_array[i];
04045         projExp-&gt;<a class="code" href="structExpenseItemChange.html#m6">change_budget_year</a>.<a class="code" href="structExpenseItem.html#m3">total</a>
04046             = calc_change( budget_expense_array[i].total, temp );
04047     }
04048 }
04049 
04050 <span class="comment">//------- End of function Finance::budget_calc_change -------//</span>
04051 
04052 <span class="comment">//---------- Begin of function Finance::budget_calc_total -----------//</span>
<a name="l04054"></a><a class="code" href="classFinance.html#a33">04054</a> <span class="comment">void Finance::budget_calc_total() {</span>
04055     <span class="comment">//------- calculate the total revenue ---------//</span>
04056 
04057     memset( &amp;budget_total_revenue, 0, <span class="keyword">sizeof</span>(total_revenue) );
04058 
04059     <span class="comment">//----- calculate the total of one row ------//</span>
04060     <span class="keywordtype">int</span> i = <a class="code" href="Ofinance_8h.html#a101a35">AC_SPONSORED_RESEARCH_REVENUE</a>;
04061     budget_revenue_array[i].total = budget_revenue_array[i].direct + budget_revenue_array[i].indirect;
04062 
04063     <span class="keywordflow">for</span>( i=<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a> ; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a> ; i++ ) {
04064         <span class="comment">//------ calculate totals of all rows -------//</span>
04065 
04066         budget_total_revenue.direct   += budget_revenue_array[i].direct;
04067         budget_total_revenue.indirect += budget_revenue_array[i].indirect;
04068         budget_total_revenue.total    += budget_revenue_array[i].total;
04069     }
04070 
04071     <span class="comment">//------- calculate the total expense ---------//</span>
04072 
04073     memset( &amp;budget_total_expense, 0, <span class="keyword">sizeof</span>(budget_total_expense) );
04074 
04075     <span class="comment">//## chea 250899 bughere</span>
04076     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a102a42">OPERATING_EXPENSE_ITEM_COUNT</a> ; i++ ) {
04077         <span class="comment">//----- calculate the total of one row ------//</span>
04078         budget_expense_array[i].total = budget_expense_array[i].faculty +
04079             budget_expense_array[i].staff + budget_expense_array[i].other;
04080 
04081         <span class="comment">//------ calculate totals of all rows -------//</span>
04082 
04083         budget_total_expense.faculty += budget_expense_array[i].faculty;
04084         budget_total_expense.staff   += budget_expense_array[i].staff;
04085         budget_total_expense.other   += budget_expense_array[i].other;
04086         budget_total_expense.total   += budget_expense_array[i].total;
04087     }
04088 
04089     <span class="comment">//------- calculate the total operating expense ---------//</span>
04090     memcpy( &amp;budget_total_operating_expense, &amp;budget_total_expense, <span class="keyword">sizeof</span>(budget_total_expense) );
04091 
04092     <span class="keywordflow">for</span>( i=<a class="code" href="Ofinance_8h.html#a102a42">OPERATING_EXPENSE_ITEM_COUNT</a> ; i&lt;<a class="code" href="Ofinance_8h.html#a102a43">TOTAL_EXPENSE_ITEM_COUNT</a> ; i++ ) {
04093         <span class="comment">//----- calculate the total of one row ------//</span>
04094 
04095         budget_expense_array[i].total = budget_expense_array[i].faculty +
04096             budget_expense_array[i].staff + budget_expense_array[i].other;
04097 
04098         <span class="comment">//------ calculate totals of all rows -------//</span>
04099 
04100         budget_total_expense.faculty += budget_expense_array[i].faculty;
04101         budget_total_expense.staff   += budget_expense_array[i].staff;
04102         budget_total_expense.other   += budget_expense_array[i].other;
04103         budget_total_expense.total   += budget_expense_array[i].total;
04104     }
04105 
04106     <a class="code" href="ALL_8H.html#a0">err_when</a>(budget_total_expense.total&lt;=0);        <span class="comment">//1228</span>
04107 
04108     <span class="comment">//------ update surplus / deficit -----------//</span>
04109 
04110     budget_year.surplus_deficit = budget_total_revenue.total - budget_total_expense.total;
04111 }
04112 
04113 <span class="comment">//----------- End of function Finance::budget_calc_total ------------//</span>
04114 
04115 <span class="comment">//---------- Begin of function Finance::budget_calc_percent -----------//</span>
<a name="l04117"></a><a class="code" href="classFinance.html#a34">04117</a> <span class="comment">void Finance::budget_calc_percent() {</span>
04118     <span class="comment">//------- calculate the total revenue ---------//</span>
04119 
04120     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=<a class="code" href="Ofinance_8h.html#a101a34">AC_NET_TUITION_INCOME</a>; i&lt;<a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a> ; i++ ) {
04121         budget_revenue_array[i].percent = 100.0f * budget_revenue_array[i].total /
04122             budget_total_revenue.total;
04123     }
04124 
04125     <span class="comment">//------- calculate the total expense ---------//</span>
04126 
04127     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a> ; i++ ) {
04128         budget_expense_array[i].percent = 100.0f * budget_expense_array[i].total /
04129             budget_total_expense.total;
04130     }
04131 }
04132 
04133 <span class="comment">//----------- End of function Finance::budget_calc_percent ------------//</span>
04134 
04135 <span class="comment">//------ Begin of function Finance::get_research_overhead_rate ------//</span>
<a name="l04137"></a><a class="code" href="classFinance.html#a0">04137</a> <span class="comment">float Finance::get_research_overhead_rate() {</span>
04138     <span class="keywordflow">return</span> float(revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a68">PL_INDIRECT_COST_RATE</a>].result_value);
04139 }
04140 
04141 <span class="comment">//------- End of function Finance::get_research_overhead_rate -------//</span>
04142 
04143 <span class="comment">// ##### Begin Marco ###### //</span>
04144 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
04145 <span class="preprocessor"></span><span class="comment">//------- Begin of function Finance::save_initial_value -------//</span>
04146 <span class="keywordtype">void</span> Finance::save_initial_value() {
04147     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="Ofinance_8h.html#a100a31">REVENUE_ITEM_COUNT</a>; i++)
04148         initial_revenue_array[i] = <a class="code" href="classFinance.html#m3">revenue_array</a>[i];
04149 
04150     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; <a class="code" href="Ofinance_8h.html#a103a44">EXPENSE_ITEM_COUNT</a>; j++)
04151         initial_expense_array[j] = <a class="code" href="classFinance.html#m4">expense_array</a>[j];
04152 
04153     <span class="comment">//  initial_total_revenue = total_revenue;</span>
04154     initial_total_operating_expense = <a class="code" href="classFinance.html#m6">total_operating_expense</a>;
04155     initial_total_expense = <a class="code" href="classFinance.html#m7">total_expense</a>;
04156     initial_last_year = <a class="code" href="classFinance.html#m20">last_year</a>;
04157     <span class="comment">//  initial_projected_total_expense = projected_total_expense;</span>
04158 
04159     <span class="comment">// new //</span>
04160     initial_total_revenue_total = <a class="code" href="classFinance.html#m5">total_revenue</a>.<a class="code" href="structRevenueItem.html#m2">total</a>;
04161 
04162     initial_faculty_salary_increase = <a class="code" href="classFinance.html#m61">expense_policy_array</a>[<a class="code" href="Ofinance_8h.html#a110a70">PL_FACULTY_SALARY_INCREASES</a>].result_value;
04163     initial_tuition_increase = finance.revenue_policy_array[<a class="code" href="Ofinance_8h.html#a108a65">PL_TUITION_RATE_GROWTH</a>].result_value;
04164 }
04165 
04166 <span class="comment">//------- End of function Finance::save_initial_value -------//</span>
04167 <span class="preprocessor">#endif</span>
04168 <span class="preprocessor"></span><span class="comment">// ##### End Marco ###### //</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:39 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
