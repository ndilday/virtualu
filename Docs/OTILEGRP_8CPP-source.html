<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OTILEGRP.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>OTILEGRP.CPP</h1><a href="OTILEGRP_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OTileGrp.cpp</span>
00002 <span class="comment">//Description : OTileGrp Class Definition</span>
00003 <span class="comment">/*</span>
00004 <span class="comment"> - a class to handle the containment and drawing of tiles</span>
00005 <span class="comment">*/</span>
00006 <span class="comment">//TO redo the comment and style</span>
00007 
00008 <span class="comment">// ES library header file</span>
00009 <span class="preprocessor">#include &lt;All.h&gt;</span>
00010 <span class="preprocessor">#include &lt;Color.h&gt;</span>                                <span class="comment">// for V_TRANS</span>
00011 <span class="preprocessor">#include &lt;OVgaBuf.h&gt;</span>
00012 
00013 <span class="comment">// CU header file</span>
00014 <span class="preprocessor">#include "ORect.h"</span>                                <span class="comment">// for viewport clipping coor vars</span>
00015 <span class="preprocessor">#include  "OTileGrp.h"</span>
00016 
00017 <span class="comment">//Temp</span>
00018 
00019 <span class="comment">// Declare constants for the viewport clipping</span>
00020 <span class="comment">/*#define VIEWPORT_X1 0</span>
00021 <span class="comment">#define VIEWPORT_X2 319</span>
00022 <span class="comment">#define VIEWPORT_Y1 0</span>
00023 <span class="comment">#define VIEWPORT_Y2 199</span>
00024 <span class="comment">*/</span>
00025 <span class="comment">//#define SCREEN_WIDTH 320</span>
00026 <span class="comment">//#define SCREEN_HEIGHT 200</span>
00027 
00028 <span class="comment">/*******************************************************************</span>
00029 <span class="comment"> Function:  TileGroup::TileGroup();</span>
00030 <span class="comment"> Purpose:   The TileGroup class constructor</span>
00031 <span class="comment"> Arguments: numTiles     - number of tiles (bitmaps)</span>
00032 <span class="comment">      w             - width of the tile in pixels (bytes)</span>
00033 <span class="comment">      h             - height of the tile in pixels (bytes)</span>
00034 <span class="comment"> Comments:  Will compute size of each tile in bytes, and will</span>
00035 <span class="comment">      allocate memory for the tile bitmaps</span>
00036 <span class="comment">*******************************************************************/</span>
00037 TileGroup::TileGroup(<a class="code" href="classRect.html">Rect</a>* viewPort, <span class="keywordtype">int</span> numTiles, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h) {
00038     clip = viewPort;
00039     width=w;
00040     height=h;
00041 
00042     size=w*h;                                       <span class="comment">// Calculate size of tile bitmap</span>
00043     num_tiles = numTiles;
00044 
00045     <span class="comment">// Allocate memory for tile bitmaps</span>
00046     image=<span class="keyword">new</span> <span class="keywordtype">char</span> *[num_tiles];
00047     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;num_tiles; j++)
00048         image[j]=<span class="keyword">new</span> <span class="keywordtype">char</span>[size];
00049 }
00050 
00051 TileGroup::~TileGroup() {
00052     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;num_tiles; j++) {
00053         <a class="code" href="ALL_8H.html#a8">mem_del</a>(image[j]);
00054     }
00055     <a class="code" href="ALL_8H.html#a8">mem_del</a>(image);
00056 }
00057 
00058 <span class="comment">/*******************************************************************</span>
00059 <span class="comment"> Function:  TileGroup::blit();</span>
00060 <span class="comment"> Purpose:   TileGroup class function which blits the indicated tile</span>
00061 <span class="comment">     bitmap to an offscreen buffer using the</span>
00062 <span class="comment">     "Reverse Painter's Algorithm".</span>
00063 <span class="comment">     Handles clipping and tile transparency.</span>
00064 <span class="comment"> Arguments: tileId      - index of tile bitmap to display</span>
00065 <span class="comment">     x, y          - offscreen coordinates where the tile</span>
00066 <span class="comment">         should be drawn</span>
00067 <span class="comment">     vgabuf        - pointer to offscreen buffer</span>
00068 <span class="comment"> Comments:  The destination buffer (screen) must be 320x200.</span>
00069 <span class="comment">*******************************************************************/</span>
00070 <span class="keywordtype">void</span> TileGroup::blit(<span class="keywordtype">int</span> tileId, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <a class="code" href="classVgaBuf.html">VgaBuf</a> *vgaBuf) {
00071     <span class="keywordtype">int</span> txstart=0, txend=width, tystart=0, tyend=height;
00072 
00073     <span class="comment">// Perform clipping before main loop</span>
00074     <span class="comment">// Clip tile to viewport and set boundaries to blit through</span>
00075     <span class="keywordflow">if</span> (x &lt; clip-&gt;x1)
00076         txstart = clip-&gt;x1-x;
00077 
00078     <span class="keywordflow">if</span> (y &lt; clip-&gt;y1)
00079         tystart = clip-&gt;y1-y;
00080 
00081     <span class="keywordflow">if</span> ((x+width-1) &gt; clip-&gt;x2 )
00082         txend = clip-&gt;x2-x+1;
00083 
00084     <span class="keywordflow">if</span> (( y+height-1) &gt; clip-&gt;y2 )
00085         tyend = clip-&gt;y2-y+1;
00086 
00087     <span class="comment">// Calculate tile and buffer starting offsets</span>
00088     <span class="keywordtype">int</span> toffset = (tystart*width)+txstart;
00089     <span class="keywordtype">int</span> poffset = (y+tystart)*vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a2">buf_pitch</a>()+(x+txstart);
00090 
00091     <span class="comment">// Calculate next row increments</span>
00092     <span class="keywordtype">int</span> toffinc = ((width-txend)+txstart);
00093     <span class="keywordtype">int</span> poffinc = (vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a2">buf_pitch</a>()-(txend)+txstart);
00094 
00095     <span class="comment">// Dereference one of the pointers to the tile bitmap for speed</span>
00096     <span class="keywordtype">char</span>* tileimage = image[tileId];
00097     <span class="keywordtype">char</span>* screen = vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a0">buf_ptr</a>();
00098 
00099     <span class="comment">// Now loop through and copy the tile bitmap to the vga buffer</span>
00100     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> row=0; row&lt;(tyend-tystart); row++) {
00101         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> column=0; column&lt;(txend-txstart); column++) {
00102             <span class="comment">// Get pixel from the offscreen buffer</span>
00103             <span class="keywordtype">int</span> dest_pixel=0xFF &amp; screen[poffset];
00104 
00105             <span class="comment">// *** Check if it is transparent, if so, copy</span>
00106             <span class="comment">// the tile bitmap's pixel over it</span>
00107             <span class="keywordflow">if</span> (dest_pixel == <a class="code" href="COLOR_8H.html#a27">V_TRANS</a>                   
00108                 )
00109                 screen[poffset] = tileimage[toffset];
00110             poffset++; toffset++;
00111         }
00112         <span class="comment">// Jump to start of next row</span>
00113         toffset+=toffinc;
00114         poffset+=poffinc;
00115     }
00116     <span class="keywordflow">return</span>;
00117 }
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:31 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
