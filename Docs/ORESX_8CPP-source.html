<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ORESX.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>ORESX.CPP</h1><a href="ORESX_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : ORESX.CPP</span>
00002 <span class="comment">//Description : Object of resource library with name index</span>
00003 
00004 <span class="preprocessor">#include &lt;string.h&gt;</span>
00005 
00006 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00007 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00008 <span class="preprocessor">#include &lt;<a class="code" href="ORESX_8H.html">ORESX.H</a>&gt;</span>
00009 
00010 <span class="comment">//--------- Format of RES file ------------//</span>
00011 <span class="comment">//</span>
00012 <span class="comment">// In the resource file, contain many data unit.</span>
00013 <span class="comment">//</span>
00014 <span class="comment">// &lt;int&gt;  = no. of data records in this RES file</span>
00015 <span class="comment">//</span>
00016 <span class="comment">// Index area</span>
00017 <span class="comment">// char[8] = data record name</span>
00018 <span class="comment">// &lt;long&gt;  = pointer of corresponding data unit in this file</span>
00019 <span class="comment">//   .</span>
00020 <span class="comment">//   .</span>
00021 <span class="comment">// char[9] = the last index is a virtual index which is used to calculate</span>
00022 <span class="comment">// &lt;long&gt;    the size of the last data unit</span>
00023 <span class="comment">//</span>
00024 <span class="comment">//</span>
00025 <span class="comment">// Data area</span>
00026 <span class="comment">// &lt;char..&gt;  = data</span>
00027 <span class="comment">//</span>
00028 <span class="comment">//---------------------------------------------</span>
00029 <span class="comment">//</span>
00030 <span class="comment">// size of data unit = next offset - current offset</span>
00031 <span class="comment">//</span>
00032 <span class="comment">//---------------------------------------------//</span>
00033 
00034 <span class="comment">//---------- Begin of function void ResourceIdx::init ---------//</span>
<a name="l00042"></a><a class="code" href="classResourceIdx.html#a3">00042</a> <span class="comment">void ResourceIdx::init(char* resName, int readAll, int useCommonBuf) {</span>
00043     <span class="keywordtype">long</span> dataSize;
00044 
00045     <span class="keywordflow">if</span>( init_flag )                                 <span class="comment">// if a resource is already opened, close it first</span>
00046         deinit();
00047 
00048     <span class="comment">//------------- open resource file ----------//</span>
00049 
00050     file_open( resName );
00051 
00052     <span class="comment">//------------ Init vars ---------------------//</span>
00053 
00054     read_all      = readAll;
00055     use_common_buf   = useCommonBuf;
00056     data_buf      = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00057     data_buf_size = 0;
00058 
00059     rec_count     = file_get_short();
00060     cur_rec_no    = -1;
00061 
00062     user_data_buf       = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00063     user_data_buf_size  = 0;
00064     user_start_read_pos = 0;
00065 
00066     <span class="comment">//---------- Read in record index -------------//</span>
00067 
00068     index_buf = (<a class="code" href="structResIndex.html">ResIndex</a>*) <a class="code" href="ALL_8H.html#a5">mem_add</a>( (rec_count+1) * <span class="keyword">sizeof</span>(<a class="code" href="structResIndex.html">ResIndex</a>) );
00069 
00070     <span class="comment">// rec_count+1 is the last index pointer for calculating last record size</span>
00071 
00072     file_read( index_buf, <span class="keyword">sizeof</span>(<a class="code" href="structResIndex.html">ResIndex</a>) * (rec_count+1) );
00073 
00074     <span class="comment">//---------- Read in record data -------------//</span>
00075 
00076     <span class="keywordflow">if</span>( read_all ) {
00077         dataSize = index_buf[rec_count].pointer - index_buf[0].pointer;
00078 
00079         data_buf = <a class="code" href="ALL_8H.html#a5">mem_add</a>( dataSize );
00080 
00081         file_read( data_buf, dataSize );
00082         file_close();
00083     }
00084     <span class="keywordflow">else</span> {
00085         <span class="keywordflow">if</span>( use_common_buf )
00086             data_buf = sys.common_data_buf;
00087     }
00088 
00089     init_flag = 1;
00090 }
00091 
00092 <span class="comment">//----------- End of function ResourceIdx::init ------------//</span>
00093 
00094 <span class="comment">//---------- Begin of function ResourceIdx::deinit ---------//</span>
<a name="l00096"></a><a class="code" href="classResourceIdx.html#a4">00096</a> <span class="comment">void ResourceIdx::deinit() {</span>
00097     <span class="keywordflow">if</span>( init_flag ) {
00098         <span class="keywordflow">if</span>( index_buf ) {
00099             <a class="code" href="ALL_8H.html#a8">mem_del</a>(index_buf);
00100             index_buf = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00101         }
00102 
00103         <span class="keywordflow">if</span>( data_buf &amp;&amp; data_buf != sys.common_data_buf ) {
00104             <a class="code" href="ALL_8H.html#a8">mem_del</a>(data_buf);
00105             data_buf = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00106         }
00107 
00108         <span class="keywordflow">if</span>( !read_all )
00109             file_close();
00110 
00111         init_flag=0;
00112     }
00113 }
00114 
00115 <span class="comment">//----------- End of function ResourceIdx::~ResourceIdx ------------//</span>
00116 
00117 <span class="comment">//---------- Begin of function ResourceIdx::read_into_user_buf ----------//</span>
<a name="l00131"></a><a class="code" href="classResourceIdx.html#a9">00131</a> <span class="comment">int ResourceIdx::read_into_user_buf(char* dataName, char* userBuf, int userBufSize, int userStartReadPos) {</span>
00132     <a class="code" href="ALL_8H.html#a0">err_when</a>( !init_flag || !dataName );
00133 
00134     <span class="keywordtype">int</span> indexId = get_index(dataName);
00135 
00136     <span class="keywordflow">if</span>( !indexId )
00137         <span class="keywordflow">return</span> 0;
00138 
00139     <span class="comment">//----- set the user buffer and read into the data -----//</span>
00140 
00141     set_user_buf(userBuf, userBufSize, userStartReadPos);
00142 
00143     <span class="keywordtype">int</span> rc = get_data(indexId)!=<a class="code" href="OHELP_8H.html#a0">NULL</a>;               <span class="comment">// ==NULL if actual data size &gt; buffer size</span>
00144 
00145     reset_user_buf();
00146 
00147     <span class="keywordflow">return</span> rc;
00148 }
00149 
00150 <span class="comment">//----------- End of function ResourceIdx::read_into_user_buf -------------//</span>
00151 
00152 <span class="comment">//---------- Begin of function ResourceIdx::read ----------//</span>
<a name="l00166"></a><a class="code" href="classResourceIdx.html#a8">00166</a> <span class="comment">char* ResourceIdx::read(char* dataName) {</span>
00167     <a class="code" href="ALL_8H.html#a0">err_when</a>( !init_flag || !dataName );
00168 
00169     <span class="keywordtype">int</span> indexId = get_index(dataName);
00170 
00171     <span class="keywordflow">if</span>( indexId )
00172         <span class="keywordflow">return</span> get_data(indexId);
00173     <span class="keywordflow">else</span>
00174         <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00175 }
00176 
00177 <span class="comment">//----------- End of function ResourceIdx::read -------------//</span>
00178 
00179 <span class="comment">//---------- Begin of function ResourceIdx::get_index ----------//</span>
<a name="l00189"></a><a class="code" href="classResourceIdx.html#a10">00189</a> <span class="comment">int ResourceIdx::get_index(char* dataName) {</span>
00190     <a class="code" href="ALL_8H.html#a0">err_when</a>( !init_flag || !dataName );
00191 
00192     <span class="keywordtype">int</span> i;
00193 
00194     <span class="keywordflow">for</span>( i=0 ; i&lt;rec_count ; i++ ) {
00195         <span class="keywordflow">if</span>( strcmp( index_buf[i].name, dataName ) == 0 )
00196             <span class="keywordflow">return</span> i+1;
00197     }
00198 
00199     <span class="keywordflow">return</span> 0;
00200 }
00201 
00202 <span class="comment">//----------- End of function ResourceIdx::get_index -------------//</span>
00203 
00204 <span class="comment">//---------- Begin of function ResourceIdx::get_data ----------//</span>
<a name="l00215"></a><a class="code" href="classResourceIdx.html#a11">00215</a> <span class="comment">char* ResourceIdx::get_data(int indexId) {</span>
00216     <a class="code" href="ALL_8H.html#a0">err_when</a>( !init_flag );
00217 
00218     <span class="keywordtype">unsigned</span> dataSize;
00219 
00220     <a class="code" href="ALL_8H.html#a0">err_when</a>( indexId &lt; 1 || indexId &gt; rec_count );
00221 
00222     indexId--;                                      <span class="comment">// make it start from 0, instead of starting from 1 for easy array accessing</span>
00223 
00224     <span class="comment">//------ all data pre-loaded to memory ------//</span>
00225 
00226     <span class="keywordflow">if</span>( read_all )
00227         <span class="keywordflow">return</span> data_buf + index_buf[indexId].pointer - index_buf[0].pointer;
00228 
00229     <span class="comment">//------ all data NOT pre-loaded to memory -------//</span>
00230 
00231     <span class="keywordflow">if</span>( indexId == cur_rec_no &amp;&amp; !use_common_buf )
00232         <span class="keywordflow">return</span> data_buf;
00233 
00234     dataSize = index_buf[indexId+1].pointer - index_buf[indexId].pointer;
00235 
00236     file_seek( index_buf[indexId].pointer );
00237 
00238     <span class="comment">//--- if the user has custom assigned a buffer, read into that buffer ---//</span>
00239 
00240     <span class="keywordflow">if</span>( user_data_buf ) {
00241         <span class="keywordflow">if</span>( user_start_read_pos &gt; 0 ) {
00242             file_seek(user_start_read_pos,FILE_CURRENT);<span class="comment">// skip the width and height info</span>
00243             dataSize -= user_start_read_pos;
00244         }
00245 
00246         <span class="keywordflow">if</span>( dataSize &gt; user_data_buf_size )
00247             <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00248 
00249         file_read( user_data_buf, dataSize );
00250 
00251         <span class="keywordflow">return</span> user_data_buf;
00252     }
00253     <span class="keywordflow">else</span> {
00254         <a class="code" href="ALL_8H.html#a0">err_when</a>( use_common_buf &amp;&amp; dataSize &gt; <a class="code" href="Osys_8h.html#a40a2">COMMON_DATA_BUF_SIZE</a> );
00255 
00256         <span class="keywordflow">if</span>( !use_common_buf &amp;&amp; data_buf_size &lt; dataSize )
00257             data_buf = <a class="code" href="ALL_8H.html#a7">mem_resize</a>( data_buf, dataSize );
00258 
00259         data_buf_size = dataSize;
00260 
00261         file_read( data_buf, dataSize );
00262 
00263         <span class="keywordflow">return</span> data_buf;
00264     }
00265 }
00266 
00267 <span class="comment">//----------- End of function ResourceIdx::get_data -------------//</span>
00268 
00269 <span class="comment">//---------- Begin of function ResourceIdx::get_file ----------//</span>
<a name="l00282"></a><a class="code" href="classResourceIdx.html#a13">00282</a> <span class="comment">File* ResourceIdx::get_file(char* dataName, int&amp; dataSize) {</span>
00283     <a class="code" href="ALL_8H.html#a0">err_when</a>( !init_flag || !dataName || read_all);
00284 
00285     <span class="keywordtype">int</span> i;
00286 
00287     <span class="comment">//-------- Search for data name ----------//</span>
00288 
00289     <span class="keywordflow">for</span>( i=0 ; i&lt;rec_count ; i++ ) {
00290         <span class="keywordflow">if</span>( strcmp( index_buf[i].name, dataName ) == 0 ) {
00291             file_seek( index_buf[i].pointer );
00292 
00293             dataSize = index_buf[i+1].pointer - index_buf[i].pointer;
00294 
00295             <span class="keywordflow">return</span> <span class="keyword">this</span>;
00296         }
00297     }
00298 
00299     <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00300 }
00301 
00302 <span class="comment">//----------- End of function ResourceIdx::get_file -------------//</span>
00303 
00304 <span class="comment">//---------- Begin of function ResourceIdx::get_file ----------//</span>
<a name="l00317"></a><a class="code" href="classResourceIdx.html#a14">00317</a> <span class="comment">File* ResourceIdx::get_file(int bitmapId, int&amp; dataSize) {</span>
00318     <a class="code" href="ALL_8H.html#a0">err_when</a>( !init_flag || !bitmapId || read_all );
00319 
00320     <span class="comment">//-------- Search for data name ----------//</span>
00321 
00322     file_seek( index_buf[bitmapId-1].pointer );
00323 
00324     dataSize = index_buf[bitmapId].pointer - index_buf[bitmapId-1].pointer;
00325 
00326     <span class="keywordflow">return</span> <span class="keyword">this</span>;
00327 }
00328 
00329 <span class="comment">//----------- End of function ResourceIdx::get_file -------------//</span>
00330 
00331 <span class="comment">//---------- Begin of function ResourceIdx::set_user_buf ----------//</span>
<a name="l00341"></a><a class="code" href="classResourceIdx.html#a6">00341</a> <span class="comment">void ResourceIdx::set_user_buf(char* userDataBuf, int bufSize, int userStartReadPos) {</span>
00342     user_data_buf       = userDataBuf;
00343     user_data_buf_size  = bufSize;
00344     user_start_read_pos = userStartReadPos;
00345 }
00346 
00347 <span class="comment">//----------- End of function ResourceIdx::set_user_buf -------------//</span>
00348 
00349 <span class="comment">//---------- Begin of function ResourceIdx::reset_user_buf ----------//</span>
<a name="l00353"></a><a class="code" href="classResourceIdx.html#a7">00353</a> <span class="comment">void ResourceIdx::reset_user_buf() {</span>
00354     user_data_buf      = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00355     user_data_buf_size = 0;
00356 }
00357 
00358 <span class="comment">//----------- End of function ResourceIdx::reset_user_buf -------------//</span>
00359 
00360 <span class="comment">//---------- Begin of function ResourceIdx::data_name ----------//</span>
<a name="l00361"></a><a class="code" href="classResourceIdx.html#a12">00361</a> <span class="keywordtype">char</span> *<a class="code" href="classResourceIdx.html#a12">ResourceIdx::data_name</a>(<span class="keywordtype">int</span> i) {
00362     <span class="keywordflow">if</span>( i &lt; 1 || i &gt; <a class="code" href="classResourceIdx.html#m6">rec_count</a>)
00363         <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00364 
00365     <span class="keywordflow">return</span>( <a class="code" href="classResourceIdx.html#m0">index_buf</a>[i-1].<a class="code" href="structResIndex.html#m0">name</a> );
00366 }
00367 
00368 <span class="comment">//---------- End of function ResourceIdx::data_name ----------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:18 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
