<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OROAD.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>OROAD.CPP</h1><a href="OROAD_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OROAD.CPP</span>
00002 <span class="comment">//Description : RoadRes Class Definition</span>
00003 
00004 <span class="preprocessor">#include &lt;All.h&gt;</span>
00005 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00006 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00007 <span class="preprocessor">#include &lt;OSTR.h&gt;</span>
00008 <span class="preprocessor">#include &lt;OMISC.h&gt;</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="OGAMESET_8H.html">OGAMESET.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="OWORLD_8H.html">OWORLD.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;OROAD.h&gt;</span>
00012 
00013 <span class="comment">//----------- Define constants -------------//</span>
00014 
<a name="l00015"></a><a class="code" href="OROAD_8CPP.html#a0">00015</a> <span class="preprocessor">#define ROAD_DB     "ROAD"</span>
00016 <span class="preprocessor"></span>
00017 <span class="comment">//----------- Begin of function RoadRes Constructor -----//</span>
<a name="l00019"></a><a class="code" href="classRoadRes.html#a0">00019</a> <span class="comment">RoadRes::RoadRes() {</span>
00020     init_flag=0;
00021 }
00022 
00023 <span class="comment">//------------- End of function RoadRes Constructor -----//</span>
00024 
00025 <span class="comment">//----------- Begin of function RoadRes Destructor ------//</span>
00027 <span class="comment"></span>
<a name="l00028"></a><a class="code" href="classRoadRes.html#a1">00028</a> <a class="code" href="classRoadRes.html#a1">RoadRes::~RoadRes</a>() {
00029     <a class="code" href="classRoadRes.html#a3">deinit</a>();
00030 }
00031 
00032 <span class="comment">//------------- End of function RoadRes Destructor ------//</span>
00033 
00034 <span class="comment">//----------- Begin of function RoadRes::init --------//</span>
<a name="l00036"></a><a class="code" href="classRoadRes.html#a2">00036</a> <span class="comment">void RoadRes::init() {</span>
00037     <span class="keywordflow">if</span> ( init_flag )
00038         <span class="keywordflow">return</span>;
00039 
00040     <span class="comment">//----- read info from ROAD.DBF ------//</span>
00041 
00042     load_info();
00043 
00044     <span class="comment">//---- open bitmap resource of different resolutions ----//</span>
00045 
00046     load_res( <a class="code" href="Gamedef_8h.html#a72a19">ZOOM_SMALL</a> , <span class="stringliteral">"ROAD"</span>, <span class="stringliteral">"S"</span> );
00047     load_res( <a class="code" href="Gamedef_8h.html#a72a20">ZOOM_MEDIUM</a>, <span class="stringliteral">"ROAD"</span>, <span class="stringliteral">"M"</span> );
00048     load_res( <a class="code" href="Gamedef_8h.html#a72a21">ZOOM_LARGE</a> , <span class="stringliteral">"ROAD"</span>, <span class="stringliteral">"L"</span> );
00049 
00050     <span class="comment">//----------------------------------------//</span>
00051 
00052     init_flag=1;
00053 }
00054 
00055 <span class="comment">//------------- End of function RoadRes::init --------//</span>
00056 
00057 <span class="comment">//----------- Begin of function RoadRes::deinit --------//</span>
<a name="l00059"></a><a class="code" href="classRoadRes.html#a3">00059</a> <span class="comment">void RoadRes::deinit() {</span>
00060     <span class="keywordflow">if</span>( init_flag ) {
00061         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;<a class="code" href="Gamedef_8h.html#a9">MAX_ZOOM_LEVEL</a> ; i++ )
00062             res_bitmap[i].deinit();
00063 
00064         <a class="code" href="ALL_8H.html#a8">mem_del</a>(info_array);
00065 
00066         init_flag=0;
00067     }
00068 }
00069 
00070 <span class="comment">//------------- End of function RoadRes::deinit --------//</span>
00071 
00072 <span class="comment">//----------- Begin of function RoadRes::load_info -------//</span>
00076 <span class="comment">void RoadRes::load_info() {</span>
00077     <a class="code" href="structRoadRec.html">RoadRec</a>  *roadRec;
00078     <a class="code" href="structRoadInfo.html">RoadInfo</a> *roadInfo;
00079     <span class="keywordtype">int</span>      i, j;
00080     <a class="code" href="classDatabase.html">Database</a> *dbRoad = game_set.open_db(<a class="code" href="OROAD_8CPP.html#a0">ROAD_DB</a>);
00081 
00082     road_count = (short) dbRoad-&gt;<a class="code" href="classDatabase.html#a7">rec_count</a>();
00083     info_array = (<a class="code" href="structRoadInfo.html">RoadInfo</a>*) <a class="code" href="ALL_8H.html#a5">mem_add</a>( <span class="keyword">sizeof</span>(<a class="code" href="structRoadInfo.html">RoadInfo</a>)*road_count );
00084 
00085     <span class="comment">//------ read in road bitmap info array -------//</span>
00086 
00087     memset( info_array, 0, <span class="keyword">sizeof</span>(<a class="code" href="structRoadInfo.html">RoadInfo</a>) * road_count );
00088 
00089     <span class="keywordflow">for</span>( i=0 ; i&lt;road_count ; i++ ) {
00090         roadRec  = (<a class="code" href="structRoadRec.html">RoadRec</a>*) dbRoad-&gt;<a class="code" href="classDatabase.html#a4">read</a>(i+1);
00091         roadInfo = info_array+i;
00092 
00093         <span class="keywordflow">for</span>( j=0 ; j&lt;<a class="code" href="OROAD_8H.html#a8a1">MAX_ROAD_CONNECT_TYPE</a> ; j++ ) {
00094             <span class="keywordflow">if</span>( roadRec-&gt;<a class="code" href="structRoadRec.html#m0">connect_array</a>[j]==<span class="charliteral">'1'</span> )
00095                 roadInfo-&gt;<a class="code" href="structRoadInfo.html#m0">connect_bits</a> |= 1&lt;&lt;j;
00096         }
00097 
00098         m.rtrim_fld( roadInfo-&gt;<a class="code" href="structRoadInfo.html#m1">file_name</a>, roadRec-&gt;<a class="code" href="structRoadRec.html#m1">file_name</a>, roadRec-&gt;<a class="code" href="structRoadRec.html#s1s0">FILE_NAME_LEN</a> );
00099     }
00100 }
00101 
00102 <span class="comment">//----------- End of function RoadRes::load_info -------//</span>
00103 
00104 <span class="comment">//----------- Begin of function RoadRes::load_res --------//</span>
00106 <span class="comment">void RoadRes::load_res(int zoomLevel, char* namePrefix, char* nameSuffix) {</span>
00107     <span class="comment">//------ read bitmaps into memory -----//</span>
00108 
00109     <a class="code" href="classString.html">String</a> str2;
00110 
00111     str2  = <a class="code" href="Gamedef_8h.html#a4">DIR_RES</a>;
00112     str2 += namePrefix;
00113     str2 += <span class="stringliteral">"_"</span>;
00114     str2 += nameSuffix;
00115 
00116     str2 += <span class="stringliteral">".RES"</span>;
00117 
00118     res_bitmap[zoomLevel].init( str2, 1 );          <span class="comment">// 1-read all bitmaps into memory</span>
00119 
00120     <span class="comment">//-------- set RoadInfo::bitmap_ptr[] --------//</span>
00121 
00122     <span class="keywordtype">char</span>* bmpPtr;
00123 
00124     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;road_count ; i++ ) {
00125         bmpPtr = res_bitmap[zoomLevel].read( info_array[i].file_name );
00126 
00127         info_array[i].bitmap_ptr[zoomLevel] = bmpPtr;
00128     }
00129 }
00130 
00131 <span class="comment">//------------- End of function RoadRes::load_res --------//</span>
00132 
00133 <span class="comment">//---------- Begin of function RoadRes::build_road -----------//</span>
<a name="l00140"></a><a class="code" href="classRoadRes.html#a4">00140</a> <span class="comment">void RoadRes::build_road(int xLoc1, int yLoc1, int xLoc2, int yLoc2) {</span>
00141     <span class="comment">// all road postions must be even, so they will all fit with each other</span>
00142     <a class="code" href="ALL_8H.html#a0">err_when</a>( xLoc1%<a class="code" href="OROAD_8H.html#a10a6">ROAD_WIDTH</a> != 0 || yLoc1%<a class="code" href="OROAD_8H.html#a10a7">ROAD_HEIGHT</a> != 0 ||
00143               xLoc2%<a class="code" href="OROAD_8H.html#a10a6">ROAD_WIDTH</a> != 0 || yLoc2%<a class="code" href="OROAD_8H.html#a10a7">ROAD_HEIGHT</a> != 0 );
00144 
00145     <span class="comment">//----- if the length of the road is 1, don't construct it -----//</span>
00146 
00147     <span class="keywordflow">if</span>( xLoc1==xLoc2 &amp;&amp; yLoc1==yLoc2 )
00148         <span class="keywordflow">return</span>;
00149 
00150     <span class="comment">//---- swap the starting and ending locations if they are in the wrong order ---//</span>
00151 
00152     <span class="keywordflow">if</span>( yLoc1 &gt; yLoc2 ) {
00153         <span class="keywordtype">int</span> ty = yLoc2;
00154         yLoc2  = yLoc1;
00155         yLoc1  = ty;
00156     }
00157 
00158     <span class="keywordflow">if</span>( xLoc1 &gt; xLoc2 ) {
00159         <span class="keywordtype">int</span> tx = xLoc2;
00160         xLoc2  = xLoc1;
00161         xLoc1  = tx;
00162     }
00163 
00164     <span class="comment">//---------- set the primary road id. ----------//</span>
00165 
00166     <span class="keywordtype">int</span> frontDir, backDir;
00167 
00168     <span class="keywordflow">if</span>( xLoc1==xLoc2 ) {                            <span class="comment">// vertical road (|)</span>
00169         frontDir = <a class="code" href="OROAD_8H.html#a9a2">ROAD_CONNECT_N</a>;
00170         backDir  = <a class="code" href="OROAD_8H.html#a9a4">ROAD_CONNECT_S</a>;
00171     }
00172 
00173     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( yLoc1==yLoc2 ) {                       <span class="comment">// horizontal road (-)</span>
00174         frontDir = <a class="code" href="OROAD_8H.html#a9a5">ROAD_CONNECT_W</a>;
00175         backDir  = <a class="code" href="OROAD_8H.html#a9a3">ROAD_CONNECT_E</a>;
00176     }
00177 
00178     <span class="keywordflow">else</span>
00179         <a class="code" href="ALL_8H.html#a1">err_here</a>();                                   <span class="comment">// must be one of the above cases.</span>
00180 
00181     <span class="comment">//---------------lay the new roads ---------------//</span>
00182 
00183     <a class="code" href="classLocation.html">Location</a> *locPtr;
00184     <span class="keywordtype">char</span>    connectBits;
00185     <span class="keywordtype">int</span>   roadId;
00186     <span class="keywordtype">int</span>     xLoc=xLoc1, yLoc=yLoc1;
00187     <span class="keywordtype">int</span>     loopCount=0;                            <span class="comment">// for bug detection only</span>
00188 
00189     <span class="comment">//----------- start processing -------------//</span>
00190 
00191     <span class="keywordflow">while</span>(1) {
00192         locPtr = world.get_loc(xLoc, yLoc);
00193 
00194         <span class="comment">//--- change existing roads to link with the new roads ---//</span>
00195 
00196         <span class="keywordflow">if</span>( locPtr-&gt;<a class="code" href="classLocation.html#a24">is_road</a>() )
00197             connectBits = road_res[locPtr-&gt;<a class="code" href="classLocation.html#a29">road_id</a>()]-&gt;connect_bits;
00198         <span class="keywordflow">else</span>
00199             connectBits = 0;
00200 
00201         <span class="keywordflow">if</span>( yLoc==yLoc2 &amp;&amp; yLoc1 != yLoc2 )           <span class="comment">//**BUGHERE</span>
00202             roadId = 0;
00203 
00204         <span class="keywordflow">if</span>( !(xLoc==xLoc1 &amp;&amp; yLoc==yLoc1) )           <span class="comment">// don't go further outside on the front end</span>
00205             connectBits |= (1&lt;&lt;frontDir);
00206 
00207         <span class="keywordflow">if</span>( !(xLoc==xLoc2 &amp;&amp; yLoc==yLoc2) )           <span class="comment">// don't go further outside on the back end</span>
00208             connectBits |= (1&lt;&lt;backDir);
00209 
00210         roadId = scan_road(connectBits);              <span class="comment">// check if there is a road using the connections bits</span>
00211 
00212         <span class="comment">//------- if valid road, set it now --------//</span>
00213 
00214         <span class="keywordflow">if</span>( roadId ) {
00215             locPtr-&gt;<a class="code" href="classLocation.html#a26">set_road</a>(roadId);
00216 
00217             <span class="keywordflow">if</span>( xLoc+1 &lt; <a class="code" href="Oworldmt_8h.html#a0">MAX_WORLD_X_LOC</a> )
00218                 world.get_loc( xLoc+1, yLoc )-&gt;set_road_sub();
00219 
00220             <span class="keywordflow">if</span>( yLoc+1 &lt; <a class="code" href="Oworldmt_8h.html#a1">MAX_WORLD_Y_LOC</a> )
00221                 world.get_loc( xLoc, yLoc+1 )-&gt;set_road_sub();
00222 
00223             <span class="keywordflow">if</span>( xLoc+1 &lt; <a class="code" href="Oworldmt_8h.html#a0">MAX_WORLD_X_LOC</a> &amp;&amp; yLoc+1 &lt; <a class="code" href="Oworldmt_8h.html#a1">MAX_WORLD_Y_LOC</a> )
00224                 world.get_loc( xLoc+1, yLoc+1 )-&gt;set_road_sub();
00225         }
00226 
00227         <span class="comment">//-------------------------------------------//</span>
00228 
00229         <span class="keywordflow">if</span>( xLoc1 != xLoc2 )
00230             xLoc+=<a class="code" href="OROAD_8H.html#a10a6">ROAD_WIDTH</a>;
00231 
00232         <span class="keywordflow">if</span>( yLoc1 != yLoc2 )
00233             yLoc+=<a class="code" href="OROAD_8H.html#a10a7">ROAD_HEIGHT</a>;
00234 
00235         <span class="keywordflow">if</span>( xLoc&gt;xLoc2 || yLoc&gt;yLoc2 )                <span class="comment">// all done</span>
00236             <span class="keywordflow">break</span>;
00237 
00238         ++loopCount;
00239 
00240         <a class="code" href="ALL_8H.html#a0">err_when</a>( loopCount &gt; 10000 );
00241     }
00242 
00243     <span class="comment">//------- redraw the zoom window ------//</span>
00244 
00245     sys.redraw_all_flag = 1;
00246 }
00247 
00248 <span class="comment">//---------- End of function RoadRes::build_road -----------//</span>
00249 
00250 <span class="comment">//---------- Begin of function RoadRes::scan_road -----------//</span>
00259 <span class="comment">int RoadRes::scan_road(char connectBits) {</span>
00260     <span class="keywordtype">int</span>      i;
00261     <a class="code" href="structRoadInfo.html">RoadInfo</a>* roadInfo = info_array;
00262 
00263     <span class="keywordflow">for</span>( i=0 ; i&lt;road_count ; i++, roadInfo++ ) {
00264         <span class="keywordflow">if</span>( roadInfo-&gt;<a class="code" href="structRoadInfo.html#m0">connect_bits</a> == connectBits )
00265             <span class="keywordflow">return</span> i+1;
00266     }
00267 
00268     <span class="keywordflow">return</span> 0;
00269 }
00270 
00271 <span class="comment">//---------- End of function RoadRes::scan_road -----------//</span>
00272 
00273 <span class="comment">//---------- Begin of function RoadRes::operator[] -----------//</span>
00274 
<a name="l00275"></a><a class="code" href="classRoadRes.html#a5">00275</a> <a class="code" href="structRoadInfo.html">RoadInfo</a>* <a class="code" href="classRoadRes.html#a5">RoadRes::operator[]</a>(<span class="keywordtype">int</span> roadId) {
00276     <a class="code" href="ALL_8H.html#a2">err_if</a>( roadId&lt;1 || roadId&gt;<a class="code" href="classRoadRes.html#m1">road_count</a> )
00277         <a class="code" href="ALL_8H.html#a4">err_now</a>( <span class="stringliteral">"RoadRes::operator[]"</span> );
00278 
00279     <span class="keywordflow">return</span> info_array+roadId-1;
00280 }
00281 
00282 <span class="comment">//------------ End of function RoadRes::operator[] -----------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:18 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
