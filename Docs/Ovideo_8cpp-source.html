<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Ovideo.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Ovideo.cpp</h1><a href="Ovideo_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OVIDEO.CPP</span>
00002 <span class="comment">//Description : Video for Windows playback class</span>
00003 <span class="comment">//Owner       : Gilbert</span>
00004 
00005 <span class="comment">// for some .h files to define some IIDs</span>
00006 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00007 <span class="preprocessor">#include &lt;windowsx.h&gt;</span>
00008 <span class="preprocessor">#include &lt;commdlg.h&gt;</span>
00009 <span class="preprocessor">#include &lt;string.h&gt;</span>
00010 <span class="preprocessor">#include &lt;objbase.h&gt;</span>
00011 <span class="preprocessor">#include &lt;strmif.h&gt;</span>
00012 <span class="preprocessor">#include &lt;evcode.h&gt;</span>
00013 <span class="preprocessor">#include &lt;control.h&gt;</span>
00014 
00015 <span class="preprocessor">#include &lt;amvideo.h&gt;</span>
00016 <span class="preprocessor">#include &lt;uuids.h&gt;</span>
00017 
00018 <span class="comment">//#include &lt;mmsystem.h&gt;</span>
00019 <span class="comment">//#include &lt;digitalv.h&gt;</span>
00020 
00021 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00022 <span class="preprocessor">#include &lt;<a class="code" href="OSTR_8H.html">OSTR.H</a>&gt;</span>
00023 <span class="preprocessor">#include &lt;<a class="code" href="OVIDEO_8H.html">OVIDEO.H</a>&gt;</span>
00024 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00025 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00026 
00027 <span class="comment">// --------- Define constant -------//</span>
00028 <span class="comment">// OATRUE and OAFALSE are defined in classes\base\ctlutil.h under active movie SDK</span>
<a name="l00029"></a><a class="code" href="Ovideo_8cpp.html#a0">00029</a> <span class="preprocessor">#define OATRUE -1</span>
<a name="l00030"></a><a class="code" href="Ovideo_8cpp.html#a1">00030</a> <span class="preprocessor"></span><span class="preprocessor">#define OAFALSE 0</span>
00031 <span class="preprocessor"></span>
00032 <span class="keyword">static</span> <span class="keywordtype">long</span> FAR PASCAL video_win_proc(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam);
00033 <span class="keyword">static</span> <span class="keywordtype">void</span> create_dummy_window(HINSTANCE hInstance);
00034 
<a name="l00035"></a><a class="code" href="Ovideo_8cpp.html#a2">00035</a> <span class="preprocessor">#define FULL_SCREEN_VIDEO</span>
<a name="l00036"></a><a class="code" href="Ovideo_8cpp.html#a3">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define CREATE_DUMMY_WINDOW</span>
00037 <span class="preprocessor"></span>
00038 <span class="comment">/*</span>
00039 <span class="comment">//--------- Begin of function Video::play() ----------//</span>
00046 <span class="comment">void Video::play(char* aviFileName, DWORD waitTime)</span>
00047 <span class="comment">{</span>
00048 <span class="comment">char     resultStr[101];</span>
00049 <span class="comment">String str;</span>
00050 <span class="comment"></span>
00051 <span class="comment">str  = "open ";</span>
00052 <span class="comment">str += aviFileName;</span>
00053 <span class="comment">str += " alias mov";</span>
00054 <span class="comment"></span>
00055 <span class="comment">mciSendString(str, NULL, 0, NULL);</span>
00056 <span class="comment">mciSendString("play mov fullscreen", NULL, 0, NULL);</span>
00057 <span class="comment"></span>
00058 <span class="comment">//------ wait until the whole video playback process is complete ------//</span>
00059 <span class="comment"></span>
00060 <span class="comment">while( 1 )</span>
00061 <span class="comment">{</span>
00062 <span class="comment">    mciSendString( "status mov mode", resultStr, 100, NULL );</span>
00063 <span class="comment"></span>
00064 <span class="comment">    if( strcmp(resultStr, "stopped")==0 )</span>
00065 <span class="comment">        break;</span>
00066 <span class="comment">}</span>
00067 <span class="comment"></span>
00068 <span class="comment">//-------- wait still after playing the movie ------//</span>
00069 <span class="comment"></span>
00070 <span class="comment"> DWORD curTime = m.get_time();</span>
00071 <span class="comment"></span>
00072 <span class="comment"> while( m.get_time() &lt; curTime+waitTime );</span>
00073 <span class="comment"></span>
00074 <span class="comment">//------------ close the MCI ---------------//</span>
00075 <span class="comment"></span>
00076 <span class="comment"> mciSendString("close mov"              , NULL, 0, NULL);</span>
00077 <span class="comment"> mciSendString("close avivideo", NULL, 0, NULL);</span>
00078 <span class="comment">}</span>
00079 <span class="comment">//--------- End of function Video::play() ----------//</span>
00080 <span class="comment">*/</span>
00081 
<a name="l00082"></a><a class="code" href="classVideo.html#a0">00082</a> <a class="code" href="classVideo.html#a0">Video::Video</a>() {
00083     CoInitialize(<a class="code" href="OHELP_8H.html#a0">NULL</a>);
00084     <a class="code" href="classVideo.html#m0">state</a> = <a class="code" href="OVIDEO_8H.html#a6a2">UNINITIALIZED</a>;
00085     <a class="code" href="classVideo.html#m1">pGraph</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00086     <a class="code" href="classVideo.html#m2">hGraphNotifyEvent</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00087     <a class="code" href="classVideo.html#m3">init_success</a> = 0;
00088     <a class="code" href="classVideo.html#m4">skip_on_fail_flag</a> = 0;
00089 }
00090 
<a name="l00091"></a><a class="code" href="classVideo.html#a1">00091</a> <a class="code" href="classVideo.html#a1">Video::~Video</a>() {
00092     CoUninitialize();
00093 }
00094 
<a name="l00095"></a><a class="code" href="classVideo.html#a4">00095</a> <span class="keywordtype">void</span> <a class="code" href="classVideo.html#a4">Video::set_skip_on_fail</a>() {
00096     <a class="code" href="classVideo.html#m4">skip_on_fail_flag</a> = 1;
00097 }
00098 
<a name="l00099"></a><a class="code" href="classVideo.html#a5">00099</a> <span class="keywordtype">void</span> <a class="code" href="classVideo.html#a5">Video::clear_skip_on_fail</a>() {
00100     <a class="code" href="classVideo.html#m4">skip_on_fail_flag</a> = 0;
00101 }
00102 
<a name="l00103"></a><a class="code" href="classVideo.html#a2">00103</a> <span class="keywordtype">void</span> <a class="code" href="classVideo.html#a2">Video::init</a>() {
00104     IMediaEvent *pME;
00105     HRESULT hr;
00106 
00107     <a class="code" href="classVideo.html#m3">init_success</a> = 0;
00108     <a class="code" href="classVideo.html#m5">hwnd</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00109     <span class="keywordflow">if</span>( ( hr = CoCreateInstance(CLSID_FilterGraph,  <span class="comment">// CLSID of object</span>
00110                                 <a class="code" href="OHELP_8H.html#a0">NULL</a>,                                         <span class="comment">// Outer unknown</span>
00111                                 CLSCTX_INPROC_SERVER,                         <span class="comment">// Type of server</span>
00112                                 IID_IGraphBuilder,                            <span class="comment">// Interface wanted</span>
00113                                 (<span class="keywordtype">void</span> **) &amp;<a class="code" href="classVideo.html#m1">pGraph</a>)                            <span class="comment">// Returned object</span>
00114         ) == 0 ) {
00115         <span class="comment">// We use this to find out events sent by the filtergraph</span>
00116         <span class="keywordflow">if</span>( (hr = <a class="code" href="classVideo.html#m1">pGraph</a>-&gt;QueryInterface(IID_IMediaEvent, (<span class="keywordtype">void</span> **) &amp;pME)) == 0) {
00117             <span class="keywordflow">if</span>( (hr = pME-&gt;GetEventHandle( (OAEVENT*) &amp;<a class="code" href="classVideo.html#m2">hGraphNotifyEvent</a>)) == 0) {
00118                 <a class="code" href="classVideo.html#m3">init_success</a> = 1;
00119                 <a class="code" href="classVideo.html#m0">state</a> = <a class="code" href="OVIDEO_8H.html#a6a3">STOPPED</a>;
00120             }
00121             pME-&gt;Release();
00122         }
00123     }
00124 
00125     <span class="keywordflow">if</span>( hr &amp;&amp; !<a class="code" href="classVideo.html#m4">skip_on_fail_flag</a>) {
00126         err.run(<span class="stringliteral">"video.init error %ld"</span>, hr );
00127     }
00128 }
00129 
<a name="l00130"></a><a class="code" href="classVideo.html#a3">00130</a> <span class="keywordtype">void</span> <a class="code" href="classVideo.html#a3">Video::deinit</a>() {
00131     <span class="keywordflow">if</span>( pGraph ) {
00132         <a class="code" href="classVideo.html#m1">pGraph</a>-&gt;Release();
00133         <a class="code" href="classVideo.html#m1">pGraph</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00134     }
00135     <a class="code" href="classVideo.html#m2">hGraphNotifyEvent</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00136     <a class="code" href="classVideo.html#m0">state</a> = <a class="code" href="OVIDEO_8H.html#a6a2">UNINITIALIZED</a>;
00137 }
00138 
<a name="l00139"></a><a class="code" href="classVideo.html#a6">00139</a> <span class="keywordtype">void</span> <a class="code" href="classVideo.html#a6">Video::play</a>( <span class="keywordtype">char</span> *fileName, DWORD ) {
00140     WCHAR wPath[100];
00141     HRESULT hr;
00142     IMediaControl *pMC;
00143 
00144     <span class="keywordflow">if</span>(!<a class="code" href="classVideo.html#m3">init_success</a>)
00145         <span class="keywordflow">return</span>;
00146 
00147     MultiByteToWideChar( CP_ACP, 0, fileName, -1, wPath, 100 );
00148 
00149     <span class="keywordflow">if</span>( (hr = <a class="code" href="classVideo.html#m1">pGraph</a>-&gt;RenderFile(wPath, <a class="code" href="OHELP_8H.html#a0">NULL</a>)) == 0) {
00150 
00151         <span class="comment">// use full screen video interface</span>
00152         <span class="comment">// try to change display mode</span>
00153         IVideoWindow *iVideoWindow = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00154         <span class="keywordflow">if</span>( (hr = <a class="code" href="classVideo.html#m1">pGraph</a>-&gt;QueryInterface(IID_IVideoWindow, (<span class="keywordtype">void</span> **) &amp;iVideoWindow)) == 0) {
00155 <span class="preprocessor">#ifdef CREATE_DUMMY_WINDOW</span>
00156 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(hwnd) {
00157                 HRESULT hr2 = iVideoWindow-&gt;put_MessageDrain((OAHWND) <a class="code" href="classVideo.html#m5">hwnd</a>);
00158                 hr2 = 0;
00159             }
00160 <span class="preprocessor">#endif</span>
00161 <span class="preprocessor"></span>
00162 <span class="preprocessor">#ifdef FULL_SCREEN_VIDEO</span>
00163 <span class="preprocessor"></span>            IBaseFilter *iFilter;
00164             <span class="keywordflow">if</span>( <a class="code" href="classVideo.html#m1">pGraph</a>-&gt;FindFilterByName(L<span class="stringliteral">"Video Renderer"</span>, &amp;iFilter) == 0) {
00165                 IBasicVideo *iBasicVideo;
00166                 <span class="keywordflow">if</span>( iFilter-&gt;QueryInterface(IID_IBasicVideo, (<span class="keywordtype">void</span> **)&amp;iBasicVideo) == 0) {
00167                     IFullScreenVideo *iFullScreenVideo;
00168                     IDirectDrawVideo *iDirectDrawVideo;
00169                     <span class="keywordflow">if</span>( iFilter-&gt;QueryInterface(IID_IFullScreenVideo, (<span class="keywordtype">void</span> **)&amp;iFullScreenVideo) == 0) {
00170                         iFullScreenVideo-&gt;Release();
00171                     }
00172                     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( iFilter-&gt;QueryInterface(IID_IDirectDrawVideo, (<span class="keywordtype">void</span> **)&amp;iDirectDrawVideo) == 0) {
00173                         HRESULT hr2;
00174                         hr2 = iDirectDrawVideo-&gt;UseWhenFullScreen(<a class="code" href="Ovideo_8cpp.html#a0">OATRUE</a>);
00175                         <span class="comment">// ##### begin Gilbert 26/05/2001 ######//</span>
00176                         iDirectDrawVideo-&gt;Release();
00177                         <span class="comment">// ##### end Gilbert 26/05/2001 ######//</span>
00178                     }
00179 
00180                     iBasicVideo-&gt;Release();
00181                 }
00182                 iFilter-&gt;Release();
00183             }
00184             hr=iVideoWindow-&gt;put_FullScreenMode(<a class="code" href="Ovideo_8cpp.html#a0">OATRUE</a>);
00185 <span class="preprocessor">#endif</span>
00186 <span class="preprocessor"></span>
00187             <span class="comment">/* // code to find all filter in the filter graph</span>
00188 <span class="comment">               {</span>
00189 <span class="comment">               IEnumFilters *iEnumFilters;</span>
00190 <span class="comment">               pGraph-&gt;EnumFilters(&amp;iEnumFilters);</span>
00191 <span class="comment"></span>
00192 <span class="comment">               ULONG filterCount = 16;</span>
00193 <span class="comment">               IFilter *iFilters[16];</span>
00194 <span class="comment">               iEnumFilters-&gt;Next(filterCount, iFilters, &amp;filterCount);</span>
00195 <span class="comment"></span>
00196 <span class="comment">               for( ULONG j = 0; j &lt; filterCount; ++j )</span>
00197 <span class="comment">               {</span>
00198 <span class="comment">               FILTER_INFO filterInfo;</span>
00199 <span class="comment">               iFilters[j]-&gt;QueryFilterInfo(&amp;filterInfo);</span>
00200 <span class="comment">               filterInfo.pGraph-&gt;Release();</span>
00201 <span class="comment">               iFilters[j]-&gt;Release();</span>
00202 <span class="comment">               }</span>
00203 <span class="comment"></span>
00204 <span class="comment">               iEnumFilters-&gt;Release();</span>
00205 <span class="comment">               }*/</span>
00206 
00207             iVideoWindow-&gt;HideCursor(<a class="code" href="Ovideo_8cpp.html#a0">OATRUE</a>);
00208             iVideoWindow-&gt;put_Visible( <a class="code" href="Ovideo_8cpp.html#a1">OAFALSE</a> );
00209             iVideoWindow-&gt;put_AutoShow( <a class="code" href="Ovideo_8cpp.html#a1">OAFALSE</a> );
00210             <span class="keywordtype">long</span> windowStyle;
00211             iVideoWindow-&gt;get_WindowStyle( &amp;windowStyle);
00212             windowStyle &amp;= ~WS_BORDER &amp; ~WS_CAPTION &amp; ~WS_SIZEBOX &amp; ~WS_THICKFRAME &amp;
00213                 ~WS_HSCROLL &amp; ~WS_VSCROLL &amp; ~WS_VISIBLE;
00214             iVideoWindow-&gt;put_WindowStyle( windowStyle);
00215         }
00216         <span class="keywordflow">else</span>
00217             iVideoWindow = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00218 
00219         <span class="keywordflow">if</span>( (hr = <a class="code" href="classVideo.html#m1">pGraph</a>-&gt;QueryInterface(IID_IMediaControl, (<span class="keywordtype">void</span> **) &amp;pMC)) == 0) {
00220             pMC-&gt;Run();                                 <span class="comment">// sometimes it returns 1, but still ok</span>
00221             <a class="code" href="classVideo.html#m0">state</a> = <a class="code" href="OVIDEO_8H.html#a6a5">PLAYING</a>;
00222             pMC-&gt;Release();
00223         }
00224 
00225         <span class="keywordflow">if</span>( iVideoWindow ) {
00226             iVideoWindow-&gt;put_Visible( <a class="code" href="Ovideo_8cpp.html#a1">OAFALSE</a> );
00227             <span class="keywordtype">long</span> windowStyle;
00228             iVideoWindow-&gt;get_WindowStyle( &amp;windowStyle);
00229             windowStyle &amp;= ~WS_BORDER &amp; ~WS_CAPTION &amp; ~WS_SIZEBOX &amp; ~WS_THICKFRAME &amp;
00230                 ~WS_HSCROLL &amp; ~WS_VSCROLL &amp; ~WS_VISIBLE;
00231             iVideoWindow-&gt;put_WindowStyle( windowStyle);
00232 
00233             <span class="keywordtype">long</span> maxWidth;
00234             <span class="keywordtype">long</span> maxHeight;
00235             hr=iVideoWindow-&gt;GetMaxIdealImageSize( &amp;maxWidth, &amp;maxHeight);
00236 <span class="preprocessor">#ifdef FULL_SCREEN_VIDEO</span>
00237 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00238 <span class="preprocessor"></span>            iVideoWindow-&gt;put_BorderColor( RGB(0,0,0) );
00239             iVideoWindow-&gt;put_WindowState(SW_MAXIMIZE);
00240 
00241             IBaseFilter *iFilter;
00242             <span class="keywordflow">if</span>( <a class="code" href="classVideo.html#m1">pGraph</a>-&gt;FindFilterByName(L<span class="stringliteral">"Video Renderer"</span>, &amp;iFilter) == 0) {
00243                 IBasicVideo *iBasicVideo;
00244                 <span class="keywordflow">if</span>( iFilter-&gt;QueryInterface(IID_IBasicVideo, (<span class="keywordtype">void</span> **)&amp;iBasicVideo) == 0) {
00245                     <span class="keywordtype">long</span> screenWidth;
00246                     <span class="keywordtype">long</span> screenHeight;
00247                     <span class="keywordtype">long</span> videoWidth;
00248                     <span class="keywordtype">long</span> videoHeight;
00249                     <span class="keywordflow">if</span>( iVideoWindow-&gt;get_Width(&amp;screenWidth) == 0 &amp;&amp;
00250                         iVideoWindow-&gt;get_Height(&amp;screenHeight) == 0 &amp;&amp;
00251                         iBasicVideo-&gt;GetVideoSize(&amp;videoWidth, &amp;videoHeight) == 0) {
00252                         <span class="comment">// zoom in by 2 if possible</span>
00253                         <span class="keywordflow">if</span>( screenWidth &gt;= videoWidth * 2 &amp;&amp;
00254                             screenHeight &gt;= videoHeight * 2) {
00255                             videoWidth *= 2;
00256                             videoHeight *= 2;
00257                         }
00258 
00259                         <span class="comment">// center the video client area</span>
00260                         iBasicVideo-&gt;SetDestinationPosition(
00261                             (screenWidth-videoWidth)/2, (screenHeight-videoHeight)/2,
00262                             videoWidth, videoHeight);
00263                     }
00264 
00265                     iBasicVideo-&gt;Release();
00266                 }
00267                 iFilter-&gt;Release();
00268             }
00269 <span class="preprocessor">#endif</span>
00270 <span class="preprocessor"></span>            iVideoWindow-&gt;HideCursor(<a class="code" href="Ovideo_8cpp.html#a0">OATRUE</a>);
00271             iVideoWindow-&gt;SetWindowForeground(<a class="code" href="Ovideo_8cpp.html#a0">OATRUE</a>);
00272         }
00273 
00274         <span class="keywordflow">if</span>(iVideoWindow) {
00275             iVideoWindow-&gt;Release();
00276             iVideoWindow = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00277         }
00278     }
00279 
00280     <span class="keywordflow">if</span>( hr &amp;&amp; !<a class="code" href="classVideo.html#m4">skip_on_fail_flag</a>)
00281         err.run(<span class="stringliteral">"video.play error %d"</span>, hr );
00282 }
00283 
<a name="l00284"></a><a class="code" href="classVideo.html#a7">00284</a> <span class="keywordtype">void</span> <a class="code" href="classVideo.html#a7">Video::play_until_end</a>( <span class="keywordtype">char</span> *fileName, HINSTANCE hInstance, DWORD t) {
00285     HANDLE  ahObjects[1];                           <span class="comment">// Handles that need to be waited on</span>
00286     <span class="keyword">const</span> <span class="keywordtype">int</span> cObjects = 1;                         <span class="comment">// Number of objects that we have</span>
00287 
00288     <span class="keywordflow">if</span>(!<a class="code" href="classVideo.html#m3">init_success</a>)
00289         <span class="keywordflow">return</span>;
00290 
00291     <a class="code" href="classVideo.html#m5">hwnd</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00292 <span class="preprocessor">#ifdef CREATE_DUMMY_WINDOW</span>
00293 <span class="preprocessor"></span>    create_dummy_window(hInstance);
00294 <span class="preprocessor">#endif</span>
00295 <span class="preprocessor"></span>
00296     <a class="code" href="classVideo.html#a6">play</a>(fileName, t);
00297 
00298     <span class="keywordflow">while</span>( <a class="code" href="classVideo.html#m0">state</a> == <a class="code" href="OVIDEO_8H.html#a6a5">PLAYING</a> ) {
00299         <span class="keywordflow">if</span>( (ahObjects[ 0 ] = <a class="code" href="classVideo.html#m2">hGraphNotifyEvent</a>) == <a class="code" href="OHELP_8H.html#a0">NULL</a>) {
00300             <a class="code" href="classVideo.html#m0">state</a> = <a class="code" href="OVIDEO_8H.html#a6a3">STOPPED</a>;
00301             <span class="keywordflow">break</span>;
00302         }
00303         DWORD Result = MsgWaitForMultipleObjects( cObjects, ahObjects,
00304                                                   FALSE, INFINITE, QS_ALLINPUT);
00305 
00306         <span class="comment">// Have we received an event notification</span>
00307         <span class="keywordflow">if</span>( Result &gt;= WAIT_OBJECT_0 &amp;&amp; Result &lt; (WAIT_OBJECT_0 + cObjects) ) {
00308             <span class="keywordflow">if</span>( Result == WAIT_OBJECT_0 )
00309                 on_graph_notify();
00310         }
00311         <span class="keywordflow">else</span> <span class="keywordflow">if</span>( Result == WAIT_OBJECT_0 + cObjects ) {
00312             <span class="keywordflow">if</span>( hwnd ) {
00313                 <span class="comment">// message in the message queue</span>
00314                 MSG msg;
00315                 <span class="comment">// ########## patch begin Gilbert 7/4 ########//</span>
00316                 <span class="keywordflow">while</span>( PeekMessage(&amp;msg, <a class="code" href="classVideo.html#m5">hwnd</a>, 0, 0, PM_NOREMOVE) ) {
00317                     <span class="keywordflow">if</span>( !GetMessage(&amp;msg, <a class="code" href="classVideo.html#m5">hwnd</a>, 0, 0) )
00318                         <span class="keywordflow">break</span>;
00319                     TranslateMessage(&amp;msg);
00320                     DispatchMessage(&amp;msg);
00321                 }
00322                 <span class="comment">// ########## patch end Gilbert 7/4 ########//</span>
00323             }
00324         }
00325         <span class="keywordflow">else</span> {
00326             <span class="comment">// other event to wait ...</span>
00327         }
00328     }
00329 
00330     <span class="keywordflow">if</span>( hwnd ) {
00331         <span class="comment">//PostMessage( hwnd, WM_CLOSE, 0, 0 );</span>
00332 
00333         <span class="comment">//handle outstanding message</span>
00334         <span class="comment">//MSG msg;</span>
00335         <span class="comment">//while( GetMessage(&amp;msg, hwnd, 0, ~0UL) )</span>
00336         <span class="comment">//{</span>
00337         <span class="comment">//      TranslateMessage(&amp;msg);</span>
00338         <span class="comment">//      DispatchMessage(&amp;msg);</span>
00339         <span class="comment">//}</span>
00340 
00341         DestroyWindow(<a class="code" href="classVideo.html#m5">hwnd</a>);
00342     }
00343     <a class="code" href="classVideo.html#m5">hwnd</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00344 
00345     <span class="comment">// after video end, go back to the game</span>
00346     <span class="comment">//  if( sys.init_flag &amp;&amp; sys.main_hwnd )</span>
00347     <span class="keywordflow">if</span>(sys.main_hwnd ) {
00348         ShowWindow( sys.main_hwnd, SW_RESTORE );
00349         SetFocus( sys.main_hwnd );
00350     }
00351 }
00352 
<a name="l00353"></a><a class="code" href="classVideo.html#a8">00353</a> <span class="keywordtype">void</span> <a class="code" href="classVideo.html#a8">Video::stop</a>() {
00354 
00355     HRESULT hr;
00356     IMediaControl *pMC;
00357 
00358     <span class="keywordflow">if</span>(!<a class="code" href="classVideo.html#m3">init_success</a>)
00359         <span class="keywordflow">return</span>;
00360 
00361     <span class="comment">// Obtain the interface to our filter graph</span>
00362     <span class="keywordflow">if</span>( (hr = <a class="code" href="classVideo.html#m1">pGraph</a>-&gt;QueryInterface(IID_IMediaControl, (<span class="keywordtype">void</span> **) &amp;pMC))== 0 ) {
00363         hr = pMC-&gt;Stop();
00364         pMC-&gt;Release();
00365 
00366         <span class="comment">// rewind to the beginning</span>
00367         IMediaPosition *pMP;
00368         <span class="keywordflow">if</span>( (hr=<a class="code" href="classVideo.html#m1">pGraph</a>-&gt;QueryInterface( IID_IMediaPosition, (<span class="keywordtype">void</span> **) &amp;pMP))==0) {
00369             pMP-&gt;put_CurrentPosition( 0);
00370             pMP-&gt;Release();
00371         }
00372     }
00373     <span class="comment">// force it to stop</span>
00374     <a class="code" href="classVideo.html#m0">state</a> = <a class="code" href="OVIDEO_8H.html#a6a3">STOPPED</a>;
00375 
00376     <span class="keywordflow">if</span>( hr &amp;&amp; !<a class="code" href="classVideo.html#m4">skip_on_fail_flag</a>)
00377         err.run(<span class="stringliteral">"video.stop error %d"</span>, hr );
00378 }
00379 
<a name="l00380"></a><a class="code" href="classVideo.html#a9">00380</a> <span class="keywordtype">void</span> <a class="code" href="classVideo.html#a9">Video::abort</a>() {
00381     HRESULT hr;
00382     IMediaControl *pMC;
00383 
00384     <span class="keywordflow">if</span>(!<a class="code" href="classVideo.html#m3">init_success</a>)
00385         <span class="keywordflow">return</span>;
00386 
00387     <span class="comment">// Obtain the interface to our filter graph</span>
00388     <span class="keywordflow">if</span>( (hr = <a class="code" href="classVideo.html#m1">pGraph</a>-&gt;QueryInterface(IID_IMediaControl, (<span class="keywordtype">void</span> **) &amp;pMC)) == 0) {
00389         <span class="comment">// Ask the filter graph to stop and release the interface</span>
00390         hr = pMC-&gt;Stop();
00391         pMC-&gt;Release();
00392 
00393         <span class="comment">// rewind to the beginning</span>
00394         IMediaPosition *pMP;
00395         <span class="keywordflow">if</span>( (hr=<a class="code" href="classVideo.html#m1">pGraph</a>-&gt;QueryInterface( IID_IMediaPosition, (<span class="keywordtype">void</span> **) &amp;pMP))==0) {
00396             pMP-&gt;put_CurrentPosition( 0);
00397             pMP-&gt;Release();
00398         }
00399     }
00400     <a class="code" href="classVideo.html#m0">state</a> = <a class="code" href="OVIDEO_8H.html#a6a3">STOPPED</a>;
00401 
00402     <span class="keywordflow">if</span>( hr &amp;&amp; !<a class="code" href="classVideo.html#m4">skip_on_fail_flag</a>)
00403         err.run(<span class="stringliteral">"video.abort error %d"</span>, hr);
00404 }
00405 
00406 <span class="keywordtype">void</span> Video::on_graph_notify() {
00407     IMediaEvent *pME;
00408     <span class="keywordtype">long</span> lEventCode, lParam1, lParam2;
00409     HRESULT hr;
00410 
00411     <span class="keywordflow">if</span>( (hr=<a class="code" href="classVideo.html#m1">pGraph</a>-&gt;QueryInterface(IID_IMediaEvent, (<span class="keywordtype">void</span> **) &amp;pME)) == 0) {
00412         <span class="keywordflow">if</span>( (hr=pME-&gt;GetEvent(&amp;lEventCode, &amp;lParam1, &amp;lParam2, 0)) == 0) {
00413             <span class="keywordflow">switch</span>(lEventCode) {
00414             <span class="keywordflow">case</span> EC_COMPLETE:
00415                 <a class="code" href="classVideo.html#a8">stop</a>();
00416                 <span class="keywordflow">break</span>;
00417 
00418             <span class="keywordflow">case</span> EC_USERABORT:
00419             <span class="keywordflow">case</span> EC_ERRORABORT:
00420                 <a class="code" href="classVideo.html#a9">abort</a>();
00421                 <span class="keywordflow">break</span>;
00422             }
00423         }
00424         pME-&gt;Release();
00425     }
00426 
00427     <span class="keywordflow">if</span>( hr &amp;&amp; !<a class="code" href="classVideo.html#m4">skip_on_fail_flag</a>)
00428         err.run(<span class="stringliteral">"video.on_graph_notify error %d"</span>, hr);
00429 }
00430 
00431 <span class="keyword">static</span> <span class="keywordtype">void</span> create_dummy_window(HINSTANCE hInstance) {
00432     <span class="keyword">static</span> ATOM classRegistered = 0;
00433 
00434     <span class="keywordflow">if</span>( !classRegistered ) {                        <span class="comment">// no need to register again</span>
00435         <span class="comment">//--------- register window class --------//</span>
00436 
00437         WNDCLASS    wc;
00438         ATOM        rc;
00439 
00440         wc.style          = CS_DBLCLKS;
00441         wc.lpfnWndProc    = video_win_proc;
00442         wc.cbClsExtra     = 0;
00443         wc.cbWndExtra     = 0;
00444         wc.hInstance      = hInstance;
00445         wc.hIcon          = <a class="code" href="OHELP_8H.html#a0">NULL</a>;                     <span class="comment">// LoadIcon( hInstance, MAKEINTATOM(IDI_ICON1));</span>
00446         wc.hCursor        = LoadCursor( <a class="code" href="OHELP_8H.html#a0">NULL</a>, IDC_ARROW );
00447         <span class="comment">//      #ifdef VC5</span>
00448         wc.hbrBackground  = (HBRUSH)GetStockObject(BLACK_BRUSH);
00449         <span class="comment">//      #else</span>
00450         <span class="comment">//              wc.hbrBackground  = (HBRUSH__*) GetStockObject(BLACK_BRUSH);</span>
00451         <span class="comment">//      #endif</span>
00452         wc.lpszMenuName   = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00453         wc.lpszClassName  = <span class="stringliteral">"Virtual U Video Window"</span>;
00454 
00455         rc = RegisterClass( &amp;wc );
00456 
00457         <span class="keywordflow">if</span>( rc != 0 )
00458             classRegistered = rc;
00459         <span class="keywordflow">else</span>
00460             <span class="keywordflow">return</span>;
00461     }
00462 
00463     video.hwnd = CreateWindowEx(
00464         <span class="comment">// ## begin zb 02/22/99</span>
00465 #ifdef _DEBUG
00466         <a class="code" href="OHELP_8H.html#a0">NULL</a>,
00467 #<span class="keywordflow">else</span>
00468         WS_EX_APPWINDOW | WS_EX_TOPMOST,
00469 #endif
00470         <span class="comment">// ## end zb 02/22/99</span>
00471         <span class="stringliteral">"Virtual U Video Window"</span>,
00472         <span class="stringliteral">"Virtual U"</span>,
00473         WS_POPUP,
00474         0,
00475         0,
00476         GetSystemMetrics(SM_CXSCREEN),
00477         GetSystemMetrics(SM_CYSCREEN),
00478         <a class="code" href="OHELP_8H.html#a0">NULL</a>,
00479         <a class="code" href="OHELP_8H.html#a0">NULL</a>,
00480         hInstance,
00481         <a class="code" href="OHELP_8H.html#a0">NULL</a> );
00482 
00483     <span class="keywordflow">if</span>( !video.hwnd)
00484         <span class="keywordflow">return</span>;
00485 
00486     UpdateWindow( video.hwnd );
00487     SetFocus( video.hwnd );
00488 
00489     <span class="keywordflow">return</span>;
00490 }
00491 
00492 <span class="keyword">static</span> <span class="keywordtype">long</span> FAR PASCAL video_win_proc(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam) {
00493     <span class="keywordflow">switch</span>( message ) {
00494     <span class="keywordflow">case</span> WM_CREATE:
00495         video.hwnd = hWnd;
00496         <span class="keywordflow">break</span>;
00497 
00498         <span class="comment">//case WM_SYSKEYUP:</span>
00499         <span class="comment">//      if( (wParam==27 &amp;&amp; lParam==0x80010001) || (wParam==9 &amp;&amp; lParam==0xa00f0001) )</span>
00500         <span class="comment">//              pause();</span>
00501         <span class="comment">//      break;</span>
00502 
00503     <span class="keywordflow">case</span> WM_DESTROY:
00504         video.hwnd = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00505         <span class="comment">// PostQuitMessage( 0 );</span>
00506         <span class="keywordflow">break</span>;
00507 
00508     <span class="keywordflow">case</span> WM_LBUTTONDOWN:
00509         video.stop();
00510         PostMessage(hWnd, WM_CLOSE, 0, 0);
00511         <span class="keywordflow">break</span>;
00512 
00513     <span class="keywordflow">default</span>:
00514         <span class="keywordflow">break</span>;
00515     }
00516 
00517     <span class="keywordflow">return</span> DefWindowProc(hWnd, message, wParam, lParam);
00518 }
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:35 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
