<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Ofac_rs.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Ofac_rs.cpp</h1><a href="Ofac__rs_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OFACULTY.cpp</span>
00002 <span class="comment">//Description : FACULTY Class Definition - Research!            // 990421</span>
00003 
00004 <span class="preprocessor">#include &lt;OMATH.H&gt;</span>
00005 <span class="comment">//#include &lt;OINFO.H&gt;</span>
00006 <span class="comment">//#include &lt;OPSCHOOL.H&gt;         // trimester_array</span>
00007 
00008 <span class="comment">// game logic</span>
00009 
00010 <span class="preprocessor">#include &lt;OFACULTY.H&gt;</span>
00011 <span class="preprocessor">#include &lt;OFINANCE.H&gt;</span>
00012 <span class="preprocessor">#include &lt;ODEPT.H&gt;</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="ODEPTRES_8H.html">ODEPTRES.H</a>&gt;</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="OPEERSCH_8H.html">OPEERSCH.H</a>&gt;</span>
00015 <span class="preprocessor">#include &lt;<a class="code" href="OSCHLRES_8H.html">OSCHLRES.H</a>&gt;</span>
00016 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>                             <span class="comment">//## chea begin "special case" when spon.=none 070699 5.1.4</span>
00017 
00018 <span class="keyword">static</span> <span class="keywordtype">bool</span> is_calc_ini_statistic;
00019 
00020 <span class="comment">/*</span>
00021 <span class="comment">//---------- Begin of function Faculty::think_research -----------//</span>
00025 <span class="comment">void Faculty::think_research()</span>
00026 <span class="comment">{</span>
00027 <span class="comment">  int i;</span>
00028 <span class="comment"></span>
00029 <span class="comment">  //------------------------//</span>
00030 <span class="comment">  if ( rank_level == LONG_TERM_ADJUNCT || rank_level == SHORT_TERM_ADJUNCT || ave_proj_size &lt;=0 )</span>
00031 <span class="comment">return;</span>
00032 <span class="comment"></span>
00033 <span class="comment">//------------------------//</span>
00034 <span class="comment"></span>
00035 <span class="comment">// 990414</span>
00036 <span class="comment"></span>
00037 <span class="comment">float oRate = finance.get_research_overhead_rate() / 100.0f;</span>
00038 <span class="comment">float qualityDriver = this-&gt;get_quality_driver();</span>
00039 <span class="comment">this-&gt;award_prob =</span>
00040 <span class="comment">float (0.01 + 0.005 * math.dual_response_func(1,50,100,29,33,20,76, qualityDriver) * math.safe_pow(1.0f+oRate, -1.5f) );</span>
00041 <span class="comment"></span>
00042 <span class="comment">//------------------------//</span>
00043 <span class="comment"></span>
00044 <span class="comment">Department* deptPtr = department_array[department_recno];</span>
00045 <span class="comment">DepartmentInfo* deptInfo = department_res[deptPtr-&gt;department_id];</span>
00046 <span class="comment">FacultyTemplate* templ = faculty_res.get_faculty_template(deptInfo-&gt;template_discretionary_time, rank_age_group() );</span>
00047 <span class="comment">//      PeerSchool *playerSchool = school_res.player_peer_school;</span>
00048 <span class="comment"></span>
00049 <span class="comment">//------------------------//</span>
00050 <span class="comment"></span>
00051 <span class="comment">for (i=0; i&lt;research_proposal_count; i++)</span>
00052 <span class="comment">{</span>
00053 <span class="comment">ResearchProposal* researchProposal = research_proposal_array+i;</span>
00054 <span class="comment"></span>
00055 <span class="comment">if ( researchProposal-&gt;status == RESEARCH_PROPOSED )</span>
00056 <span class="comment">{</span>
00057 <span class="comment">// 990412 if ( math.get_random_float() &lt; researchProposal-&gt;prob_proposal_funded )</span>
00058 <span class="comment">if ( math.get_random_float() &lt; award_prob )</span>
00059 <span class="comment">{</span>
00060 <span class="comment">// accepted</span>
00061 <span class="comment">researchProposal-&gt;status = RESEARCH_ACTIVE;</span>
00062 <span class="comment">researchProposal-&gt;date_to_next_status = info.game_date + (4 + m.random(MAX_ACTIVE_RESEARCH_MONTH-3)) * 30;              // draw a random number from 4 to 12 months</span>
00063 <span class="comment"></span>
00064 <span class="comment">research_month_expense += researchProposal-&gt;total_dollars / MAX_ACTIVE_RESEARCH_MONTH;</span>
00065 <span class="comment">research_month_expense_direct += int((researchProposal-&gt;total_dollars / MAX_ACTIVE_RESEARCH_MONTH ) / ( 1+researchProposal-&gt;overhead_rate));</span>
00066 <span class="comment"></span>
00067 <span class="comment">deptPtr-&gt;research_m_history[R_ACCEPT][THIS_MONTH] += (researchProposal-&gt;total_dollars / MAX_ACTIVE_RESEARCH_MONTH);</span>
00068 <span class="comment">}</span>
00069 <span class="comment">}</span>
00070 <span class="comment">else if ( researchProposal-&gt;status == RESEARCH_ACTIVE )</span>
00071 <span class="comment">{</span>
00072 <span class="comment">}</span>
00073 <span class="comment">else</span>
00074 <span class="comment">err_here();</span>
00075 <span class="comment"></span>
00076 <span class="comment">if ( info.game_date &gt;= researchProposal-&gt;date_to_next_status )          // depends on game_date</span>
00077 <span class="comment">{</span>
00078 <span class="comment">// expired: proposal rejected or research finished</span>
00079 <span class="comment"></span>
00080 <span class="comment">if ( researchProposal-&gt;status == RESEARCH_PROPOSED )</span>
00081 <span class="comment">deptPtr-&gt;research_m_history[R_REJECT][THIS_MONTH] += (researchProposal-&gt;total_dollars / MAX_ACTIVE_RESEARCH_MONTH);</span>
00082 <span class="comment">else if ( researchProposal-&gt;status = RESEARCH_ACTIVE )</span>
00083 <span class="comment">{</span>
00084 <span class="comment">research_month_expense -= researchProposal-&gt;total_dollars / MAX_ACTIVE_RESEARCH_MONTH;</span>
00085 <span class="comment">research_month_expense_direct -= int((researchProposal-&gt;total_dollars / MAX_ACTIVE_RESEARCH_MONTH ) / ( 1+researchProposal-&gt;overhead_rate));</span>
00086 <span class="comment">}</span>
00087 <span class="comment"></span>
00088 <span class="comment">for (int j=i+1; j&lt;research_proposal_count; j++)</span>
00089 <span class="comment">memcpy(research_proposal_array+j-1, research_proposal_array+j, sizeof(ResearchProposal));</span>
00090 <span class="comment"></span>
00091 <span class="comment">research_proposal_count--;</span>
00092 <span class="comment">i--;</span>
00093 <span class="comment">}</span>
00094 <span class="comment">}</span>
00095 <span class="comment"></span>
00096 <span class="comment">//------------------------//    var 24</span>
00097 <span class="comment"></span>
00098 <span class="comment">//990412</span>
00099 <span class="comment"></span>
00100 <span class="comment">Faculty* facultyPtr = this;</span>
00101 <span class="comment">int projectCount = 0;</span>
00102 <span class="comment">float prob=0;</span>
00103 <span class="comment">const float forCalcProb = (facultyPtr-&gt;ave_proj_count / facultyPtr-&gt;award_prob );</span>
00104 <span class="comment"></span>
00105 <span class="comment">float randNum = math.get_random_float();</span>
00106 <span class="comment">for ( i=0, prob=0; i&lt;=MAX_RESEARCH_PROPOSAL; i++)</span>
00107 <span class="comment">{</span>
00108 <span class="comment">//              prob += math.double_poisson(i, forCalcProb);</span>
00109 <span class="comment">if ( randNum &lt; prob )</span>
00110 <span class="comment">{</span>
00111 <span class="comment">projectCount = i;</span>
00112 <span class="comment">break;</span>
00113 <span class="comment">}</span>
00114 <span class="comment">}</span>
00115 <span class="comment"></span>
00116 <span class="comment">//----- add research proposals -----//</span>
00117 <span class="comment"></span>
00118 <span class="comment">for( ; projectCount &gt; 0 &amp;&amp; facultyPtr-&gt;research_proposal_count &lt; MAX_RESEARCH_PROPOSAL;</span>
00119 <span class="comment">projectCount--, facultyPtr-&gt;research_proposal_count++ )</span>
00120 <span class="comment">{</span>
00121 <span class="comment">ResearchProposal* researchProposal = facultyPtr-&gt;research_proposal_array + facultyPtr-&gt;research_proposal_count;</span>
00122 <span class="comment"></span>
00123 <span class="comment">int tmp = (int) max(0, facultyPtr-&gt;ave_proj_size * math.get_random_snd(1.0f, 0.05f));</span>
00124 <span class="comment"></span>
00125 <span class="comment">researchProposal-&gt;total_dollars = tmp;</span>
00126 <span class="comment"></span>
00127 <span class="comment">researchProposal-&gt;overhead_rate = oRate;</span>
00128 <span class="comment"></span>
00129 <span class="comment">researchProposal-&gt;status = RESEARCH_PROPOSED;</span>
00130 <span class="comment">researchProposal-&gt;date_to_next_status = info.game_date + (2 + m.random(5)) * 30;                // draw a random number from 2 to 6 months</span>
00131 <span class="comment"></span>
00132 <span class="comment">deptPtr-&gt;research_m_history[R_PROPOSAL][THIS_MONTH] += (researchProposal-&gt;total_dollars / MAX_ACTIVE_RESEARCH_MONTH);</span>
00133 <span class="comment">}</span>
00134 <span class="comment"></span>
00135 <span class="comment">}</span>
00136 <span class="comment">//---------- End of function Faculty::think_research -----------//</span>
00137 <span class="comment">*/</span>
00138 
00139 <span class="comment">//---------- Begin of function DepartmentArray::init_research -----------//</span>
<a name="l00143"></a><a class="code" href="classDepartmentArray.html#a19">00143</a> <span class="comment">void DepartmentArray::init_research() {</span>
00144     <span class="comment">//  return;</span>
00145     <span class="comment">//  err_here();</span>
00146 
00147     is_calc_ini_statistic = <span class="keyword">false</span>;
00148 
00149     <span class="comment">//----//</span>
00150 
00151     <span class="keywordtype">int</span> saveGameDate = info.game_date;
00152 
00153     <span class="comment">//----//            run for a year; just to generate and update research projects</span>
00154 
00155     <span class="keyword">const</span> <span class="keywordtype">int</span> oneMonth = 30;
00156     <span class="keyword">const</span> <span class="keywordtype">int</span> simMonths = 6;
00157 
00158     <span class="keywordtype">int</span> i, j, m;
00159 
00160     <span class="keywordflow">for</span> ( m=1; m&lt;=simMonths; m++ ) {
00161         <span class="keywordflow">if</span> ( m == simMonths )
00162             is_calc_ini_statistic = <span class="keyword">true</span>;
00163 
00164         info.game_date += oneMonth;
00165 
00166         <span class="keywordflow">for</span> (i=size(); i&gt;0; i--) {
00167             <span class="keywordflow">if</span> ( is_deleted(i) )
00168                 <span class="keywordflow">continue</span>;
00169 
00170             <a class="code" href="classDepartment.html">Department</a>* dPtr = department_array[i];
00171 
00172             <span class="comment">// for each faculty</span>
00173             <span class="keywordflow">for</span> ( j=dPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classDynArray.html#a28">size</a>(); j&gt;0; j-- ) {
00174                 <span class="keywordflow">if</span> ( dPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#a10">is_deleted</a>(j) )
00175                     <span class="keywordflow">continue</span>;
00176 
00177                 <a class="code" href="classFaculty.html">Faculty</a> * fPtr = dPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>[j];
00178 
00179                 fPtr-&gt;<a class="code" href="classFaculty.html#a7">init_research</a>();
00180 
00181                 <span class="comment">//## chea 301199 since I have run the preru year so this may make the date_to_next_status neg.</span>
00182                 <span class="comment">//                              if ( m == simMonths )</span>
00183                 <span class="comment">//                              {</span>
00184                 <span class="comment">//                                      for (int c=0; c&lt;fPtr-&gt;research_proposal_count; c++)</span>
00185                 <span class="comment">//                                              fPtr-&gt;research_proposal_array[c].date_to_next_status -= simMonths * oneMonth;</span>
00186                 <span class="comment">//                              }</span>
00187             }
00188         }
00189     }
00190 
00191     <a class="code" href="ALL_8H.html#a0">err_when</a>(info.game_date - oneMonth * simMonths != saveGameDate );
00192     info.game_date = saveGameDate;
00193     is_calc_ini_statistic = <span class="keyword">false</span>;                  <span class="comment">//## chea BUGHERE after init this should set to true</span>
00194     <span class="comment">//  is_calc_ini_statistic = true;   //## chea BUGHERE after init this should set to true</span>
00195 
00196 }
00197 
00198 <span class="comment">//---------- Begin of function DepartmentArray::init_research -----------//</span>
00199 
00200 <span class="comment">//---------- Begin of function Faculty::init_research -----------//</span>
<a name="l00204"></a><a class="code" href="classFaculty.html#a7">00204</a> <span class="comment">void Faculty::init_research() {</span>
00205 
00206     <span class="comment">//## chea begin "special case" when spon.=none 070699 5.1.4</span>
00207     <span class="keywordflow">if</span> ( player_school.sponsored_research_intensity &lt;= 0 )
00208         <span class="keywordflow">return</span>;
00209     <span class="comment">//## chea end "special case" when spon.=none 070699 5.1.4</span>
00210 
00211     <span class="keywordtype">int</span> i;
00212 
00213     <span class="comment">//------------------------//</span>
00214     <span class="keywordflow">if</span> ( rank_level == <a class="code" href="Ofaculty_8h.html#a27a12">LONG_TERM_ADJUNCT</a> || rank_level == <a class="code" href="Ofaculty_8h.html#a27a13">SHORT_TERM_ADJUNCT</a> || ave_proj_size &lt;=0 )
00215         <span class="keywordflow">return</span>;
00216 
00217     <span class="comment">//------------------------//</span>
00218 
00219     <span class="comment">// 990414</span>
00220 
00221     <span class="keywordtype">float</span> oRate = finance.get_research_overhead_rate() / 100.0f;
00222 
00223     <span class="keywordtype">float</span> qualityDriver = this-&gt;get_quality_driver();
00224 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00225 <span class="preprocessor"></span>    <span class="comment">// change in 18/03/2002</span>
00226     <span class="keywordtype">float</span> awardProb = 2.0f * (qualityDriver * 0.01f) / math.safe_pow( (1.0f + oRate), 3.0f );
00227     this-&gt;award_prob = m.fmin( 0.85f, m.fmax(0.10f, awardProb) );
00228 <span class="preprocessor">#else</span>
00229 <span class="preprocessor"></span>    this-&gt;award_prob =
00230 
00231         <span class="comment">//      float (0.01 + 0.005 * math.dual_response_func(1,50,100,29,33,20,76, qualityDriver) * math.safe_pow(1.0f+oRate, -1.5f) );</span>
00232         <span class="comment">//## chea 251099</span>
00233         float (0.01 + 0.5 * math.dual_response_func(1,50,100,29,33,20,76, qualityDriver)/100 * math.safe_pow(1.0f+oRate, -1.5f) );
00234 <span class="preprocessor">#endif</span>
00235 <span class="preprocessor"></span>
00236     <span class="comment">//------------------------//</span>
00237 
00238     <a class="code" href="classDepartment.html">Department</a>* deptPtr = department_array[department_recno];
00239     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a>* deptInfo = department_res[deptPtr-&gt;<a class="code" href="classGeneralDepartment.html#m2">department_id</a>];
00240     <a class="code" href="structFacultyTemplate.html">FacultyTemplate</a>* templ = faculty_res.get_faculty_template(deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m22">template_discretionary_time</a>, rank_age_group() );
00241     <span class="comment">// PeerSchool *playerSchool = school_res.player_peer_school;</span>
00242 
00243     <span class="comment">//------------------------//</span>
00244 
00245     <span class="keywordflow">for</span> (i=0; i&lt;research_proposal_count; i++) {
00246 
00247         <a class="code" href="structResearchProposal.html">ResearchProposal</a>* researchProposal = research_proposal_array+i;
00248 
00249         <span class="keywordflow">if</span> ( researchProposal-&gt;<a class="code" href="structResearchProposal.html#m2">status</a> == <a class="code" href="Ofaculty_8h.html#a31a24">RESEARCH_PROPOSED</a> ) {
00250             <span class="keywordflow">if</span> ( math.get_random_float() &lt; award_prob ) {
00251                 <span class="comment">// accepted</span>
00252                 researchProposal-&gt;<a class="code" href="structResearchProposal.html#m2">status</a> = <a class="code" href="Ofaculty_8h.html#a31a25">RESEARCH_ACTIVE</a>;
00253 
00254                 <span class="comment">// TRICK #1</span>
00255 
00256                 <span class="comment">//                              researchProposal-&gt;date_to_next_status = info.game_date + (4 + m.random(MAX_ACTIVE_RESEARCH_MONTH-3)) * 30;              // draw a random number from 4 to 12 months</span>
00257                 <span class="comment">//## chea240899 draw a random number from 0 to 6 months  //## chea 251099</span>
00258                 researchProposal-&gt;<a class="code" href="structResearchProposal.html#m3">date_to_next_status</a> = info.game_date + (m.random(6)) * 30;
00259                 <span class="comment">//                              researchProposal-&gt;date_to_next_status = info.game_date + (1) * 30;              //## chea 251099 test</span>
00260 
00261                 <span class="comment">//## chea 151199 try my cal. method 1.4.1</span>
00262                 research_month_expense += researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a>;
00263                 research_month_expense_direct += int((researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a> ) / ( 1+researchProposal-&gt;<a class="code" href="structResearchProposal.html#m1">overhead_rate</a>));
00264 
00265                 <span class="keywordflow">if</span> ( is_calc_ini_statistic ) {
00266 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00267 <span class="preprocessor"></span>                    <span class="comment">// not sure why divide after add</span>
00268                     deptPtr-&gt;<a class="code" href="classDepartment.html#m66">research_m_history</a>[<a class="code" href="Odept_8h.html#a19a15">R_ACCEPT</a>][THIS_MONTH] += (float)researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / (<a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a>*1000);
00269 <span class="preprocessor">#else</span>
00270 <span class="preprocessor"></span>                    deptPtr-&gt;<a class="code" href="classDepartment.html#m66">research_m_history</a>[<a class="code" href="Odept_8h.html#a19a15">R_ACCEPT</a>][THIS_MONTH] += (researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a>);
00271                     <span class="comment">//## chea 221199</span>
00272                     deptPtr-&gt;<a class="code" href="classDepartment.html#m66">research_m_history</a>[<a class="code" href="Odept_8h.html#a19a15">R_ACCEPT</a>][THIS_MONTH] /= 1000;
00273 <span class="preprocessor">#endif</span>
00274 <span class="preprocessor"></span>                }
00275             }
00276         }
00277         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( researchProposal-&gt;<a class="code" href="structResearchProposal.html#m2">status</a> == <a class="code" href="Ofaculty_8h.html#a31a25">RESEARCH_ACTIVE</a> ) {
00278         }
00279         <span class="keywordflow">else</span>
00280             <a class="code" href="ALL_8H.html#a1">err_here</a>();
00281 
00282         <span class="comment">// TRICK #2</span>
00283         <span class="comment">// depends on game_date  //## chea 031199</span>
00284         <span class="keywordflow">if</span> ( info.game_date&gt;= researchProposal-&gt;<a class="code" href="structResearchProposal.html#m3">date_to_next_status</a> ) {
00285             <span class="comment">// expired: proposal rejected or research finished</span>
00286 
00287             <span class="keywordflow">if</span> ( researchProposal-&gt;<a class="code" href="structResearchProposal.html#m2">status</a> == <a class="code" href="Ofaculty_8h.html#a31a24">RESEARCH_PROPOSED</a> ) {
00288                 <span class="keywordflow">if</span> ( is_calc_ini_statistic ) {
00289 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00290 <span class="preprocessor"></span>                    deptPtr-&gt;<a class="code" href="classDepartment.html#m66">research_m_history</a>[<a class="code" href="Odept_8h.html#a19a14">R_REJECT</a>][THIS_MONTH] += (float)researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / (<a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a> * 1000);
00291 <span class="preprocessor">#else</span>
00292 <span class="preprocessor"></span>                    deptPtr-&gt;<a class="code" href="classDepartment.html#m66">research_m_history</a>[<a class="code" href="Odept_8h.html#a19a14">R_REJECT</a>][THIS_MONTH] += (researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a>);
00293                     <span class="comment">//## chea 221199</span>
00294                     deptPtr-&gt;<a class="code" href="classDepartment.html#m66">research_m_history</a>[<a class="code" href="Odept_8h.html#a19a14">R_REJECT</a>][THIS_MONTH] /= 1000;
00295 <span class="preprocessor">#endif</span>
00296 <span class="preprocessor"></span>                }
00297             }
00298             <span class="comment">// fix in ver 2</span>
00299             <span class="comment">// else if ( researchProposal-&gt;status = RESEARCH_ACTIVE )</span>
00300             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( researchProposal-&gt;<a class="code" href="structResearchProposal.html#m2">status</a> == <a class="code" href="Ofaculty_8h.html#a31a25">RESEARCH_ACTIVE</a> ) {
00301                 <span class="comment">//## chea 151199 try my cal. method 1.4.1</span>
00302                 research_month_expense -= researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a>;
00303                 research_month_expense_direct -= int((researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a> ) / ( 1+researchProposal-&gt;<a class="code" href="structResearchProposal.html#m1">overhead_rate</a>));
00304 
00305             }
00306             <span class="keywordflow">else</span>
00307                 <a class="code" href="ALL_8H.html#a1">err_here</a>();
00308 
00309             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=i+1; j&lt;research_proposal_count; j++) {
00310                 memcpy(research_proposal_array+j-1, research_proposal_array+j, <span class="keyword">sizeof</span>(<a class="code" href="structResearchProposal.html">ResearchProposal</a>));
00311             }
00312             research_proposal_count--;
00313 
00314             i--;
00315         }
00316     }
00317 
00318     <span class="comment">//----------------------------------//</span>
00319 
00320     <a class="code" href="classFaculty.html">Faculty</a>* facultyPtr = <span class="keyword">this</span>;
00321     <span class="keywordtype">int</span> projectCount = 0;
00322     <span class="keywordtype">float</span> prob=0;
00323 
00324     <span class="comment">//## chea 161099</span>
00325     <span class="comment">//  const float forCalcProb = (facultyPtr-&gt;ave_proj_count / facultyPtr-&gt;award_prob ); //tryttt</span>
00326     <span class="comment">//   const float forCalcProb = (facultyPtr-&gt;ave_proj_count * deptInfo-&gt;percent_pi_faculty/100.0f / facultyPtr-&gt;award_prob );  //## chea 230899</span>
00327     <span class="comment">//tryttt</span>
00328     <span class="keyword">const</span> <span class="keywordtype">float</span> forCalcProb = (facultyPtr-&gt;<a class="code" href="classFaculty.html#m41">award_prob</a>);
00329 
00330     <span class="comment">//## chea 161099  it is impossiable to added k1 in the alg.</span>
00331     <span class="comment">//  const float forCalcProb = (k1*GCON*facultyPtr-&gt;ave_proj_count / (DCON*facultyPtr-&gt;award_prob ));  //## chea 161099</span>
00332 
00333     <span class="comment">//## 251099 use k1&amp;k2  =1</span>
00334     <span class="comment">//  const float forCalcProb = (k1*GCON*facultyPtr-&gt;ave_proj_count / (DCON*facultyPtr-&gt;award_prob ));  //## chea 161099</span>
00335     <span class="comment">// const float forCalcProb = (GCON*facultyPtr-&gt;ave_proj_count / (DCON*facultyPtr-&gt;award_prob ));  //## chea 161099</span>
00336 
00337     <span class="keywordtype">float</span> randNum = math.get_random_float();
00338     <span class="keywordflow">for</span> ( i=0, prob=0; i&lt;=<a class="code" href="Ofaculty_8h.html#a5">MAX_RESEARCH_PROPOSAL</a>; i++) {
00339         prob += math.double_poisson(i, forCalcProb);
00340 
00341         <span class="keywordflow">if</span> ( randNum &lt; prob ) {
00342             projectCount = i;
00343             <span class="keywordflow">break</span>;
00344         }
00345     }
00346 
00347     <span class="comment">//----- add research proposals -----//</span>
00348 
00349     <span class="keywordflow">for</span>( ; projectCount &gt; 0 &amp;&amp; facultyPtr-&gt;<a class="code" href="classFaculty.html#m20">research_proposal_count</a> &lt; <a class="code" href="Ofaculty_8h.html#a5">MAX_RESEARCH_PROPOSAL</a>;
00350          projectCount--, facultyPtr-&gt;<a class="code" href="classFaculty.html#m20">research_proposal_count</a>++ ) {
00351         <a class="code" href="structResearchProposal.html">ResearchProposal</a>* researchProposal = facultyPtr-&gt;<a class="code" href="classFaculty.html#m18">research_proposal_array</a> + facultyPtr-&gt;<a class="code" href="classFaculty.html#m20">research_proposal_count</a>;
00352 
00353         <span class="comment">//## chea 251099</span>
00354         <span class="comment">//              int tmp = (int) max(0.0f, facultyPtr-&gt;ave_proj_size * math.get_random_snd(1.0f, 0.05f)); //min &amp; max bug chea</span>
00355         <span class="comment">//              int tmp = (int) max(0.2f, facultyPtr-&gt;ave_proj_size * math.get_random_snd(1.0f, 0.20f)); //min &amp; max bug chea</span>
00356         <span class="comment">//              int tmp = (int) max(0.2f, facultyPtr-&gt;ave_proj_size ); //min &amp; max bug chea //for testing</span>
00357         <span class="comment">//## chea 221199</span>
00358         <span class="comment">//min &amp; max bug chea</span>
00359         <span class="keywordtype">int</span> tmp = (int) m.fmax(0.0f, facultyPtr-&gt;<a class="code" href="classFaculty.html#m43">ave_proj_size</a> * 1000 * math.get_random_snd(1.0f, 0.05f));
00360 
00361         <span class="comment">//## chea 151199 try to make the research projet non 0</span>
00362         <span class="comment">//              if(tmp &gt;=0 &amp;&amp; tmp &lt;= 1)</span>
00363         <span class="comment">//                      tmp =1;</span>
00364 
00365         <span class="comment">//## chea 191199 1.8.3</span>
00366         <span class="comment">//              if(tmp &gt;=50)</span>
00367         <span class="comment">//                      tmp = 50;</span>
00368 
00369         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> = tmp;
00370 
00371         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m1">overhead_rate</a> = oRate;
00372 
00373         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m2">status</a> = <a class="code" href="Ofaculty_8h.html#a31a24">RESEARCH_PROPOSED</a>;
00374 
00375         <span class="comment">//TRICK #3</span>
00376         <span class="comment">// draw a random number from 2 to 6 months</span>
00377         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m3">date_to_next_status</a> = info.game_date + (2 + m.random(5)) * 30;
00378         <span class="comment">//              researchProposal-&gt;date_to_next_status = info.game_date + (1) * 30;              //## chea 251099 test</span>
00379         <span class="comment">//              researchProposal-&gt;date_to_next_status = info.game_date + (m.random(7)) * 30;            //## chea 240899 draw a random number from 2 to 6 months //## chea 251099</span>
00380 
00381         <span class="keywordflow">if</span> ( is_calc_ini_statistic ) {
00382 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00383 <span class="preprocessor"></span>            deptPtr-&gt;<a class="code" href="classDepartment.html#m66">research_m_history</a>[<a class="code" href="Odept_8h.html#a19a13">R_PROPOSAL</a>][THIS_MONTH] += (float)researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / (<a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a> * 1000);
00384 <span class="preprocessor">#else</span>
00385 <span class="preprocessor"></span>            deptPtr-&gt;<a class="code" href="classDepartment.html#m66">research_m_history</a>[<a class="code" href="Odept_8h.html#a19a13">R_PROPOSAL</a>][THIS_MONTH] += (researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a>);
00386             <span class="comment">//## chea 221199</span>
00387             deptPtr-&gt;<a class="code" href="classDepartment.html#m66">research_m_history</a>[<a class="code" href="Odept_8h.html#a19a13">R_PROPOSAL</a>][THIS_MONTH] /= 1000;
00388 <span class="preprocessor">#endif</span>
00389 <span class="preprocessor"></span>        }
00390     }
00391 
00392     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> c=0; c&lt;research_proposal_count; c++)
00393         <span class="comment">//## chea 031199</span>
00394         <a class="code" href="ALL_8H.html#a0">err_when</a>( research_proposal_array[c].date_to_next_status &gt; info.game_date+30*18 );
00395 }
00396 
00397 <span class="comment">//---------- End of function Faculty::init_research -----------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:29 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
