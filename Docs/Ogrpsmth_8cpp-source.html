<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Ogrpsmth.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Ogrpsmth.cpp</h1><a href="Ogrpsmth_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OGRPHSTH.CPP</span>
00002 <span class="comment">//Description : Object GraphSpecialMonth        (Month-based)</span>
00003 <span class="comment">//Owner                 : Kevin(Ho)</span>
00004 
00005 <span class="comment">// The data is updated at 1st Sep of each year.</span>
00006 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="COLOR_8H.html">COLOR.H</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00011 <span class="preprocessor">#include &lt;OFONT.H&gt;</span>
00012 <span class="preprocessor">#include &lt;OMOUSE.H&gt;</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="OGRPSMTH_8H.html">OGRPSMTH.H</a>&gt;</span>
00014 <span class="preprocessor">#include &lt;OIFACE.H&gt;</span>
00015 <span class="preprocessor">#include &lt;math.h&gt;</span>
00016 
00017 <span class="comment">//--------- Define macro constant -----------//</span>
00018 
<a name="l00019"></a><a class="code" href="Ogrpsmth_8cpp.html#a0">00019</a> <span class="preprocessor">#define MAX_LEN_LABEL "00,000"</span>
00020 <span class="preprocessor"></span>
00021 <span class="keyword">static</span> <span class="keywordtype">int</span> default_series_color[] = {
00022     <a class="code" href="COLOR_8H.html#a21">V_BLUE</a>,
00023     <a class="code" href="COLOR_8H.html#a20">V_GREEN</a>,
00024     <a class="code" href="COLOR_8H.html#a19">V_RED</a>,
00025     <a class="code" href="COLOR_8H.html#a25">V_YELLOW</a>,
00026     <a class="code" href="COLOR_8H.html#a22">V_VIOLET</a>,
00027     <a class="code" href="COLOR_8H.html#a23">V_BROWN</a>,
00028     <a class="code" href="COLOR_8H.html#a18">V_ORANGE</a>,
00029     <a class="code" href="COLOR_8H.html#a24">V_PINK</a>,
00030     <a class="code" href="COLOR_8H.html#a15">V_BLACK</a>,
00031     <a class="code" href="COLOR_8H.html#a17">V_WHITE</a>,
00032 };                                                <span class="comment">// 10 default series colors</span>
00033 
00034 <span class="keyword">enum</span> {  <a class="code" href="Ogrpsmth_8cpp.html#a7a2">DEFAULT_SERIES_COLOR_NUM</a> = 10 };
00035 
00036 <span class="keyword">enum</span> {
00037     <a class="code" href="Ogrpsmth_8cpp.html#a8a3">LEGEND_SIZE</a> = 11,
00038     <a class="code" href="Ogrpsmth_8cpp.html#a8a4">LEGEND_X_SPACING</a> = 12,
00039     <a class="code" href="Ogrpsmth_8cpp.html#a8a5">LEGEND_Y_SPACING</a> = 2,
00040 };
00041 
00042 <span class="keyword">enum</span> {  <a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a> = 2         };
00043 
00044 <span class="comment">//-------------- Define static vars ------------//</span>
00045 
00046 <span class="comment">//static char paint_flag = 0;</span>
00047 
00048 <span class="comment">//-------- Begin of function GraphSpecialMonth::GraphSpecialMonth ----//</span>
<a name="l00050"></a><a class="code" href="classGraphSpecialMonth.html#a0">00050</a> <span class="comment">GraphSpecialMonth::GraphSpecialMonth() {</span>
00051     init_flag = 0;
00052     graph_bitmap = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00053 }
00054 
00055 <span class="comment">//---------- End of function GraphSpecialMonth::GraphSpecialMonth ----//</span>
00056 
00057 <span class="comment">//-------- Begin of function GraphSpecialMonth::~GraphSpecialMonth -----//</span>
<a name="l00059"></a><a class="code" href="classGraphSpecialMonth.html#a1">00059</a> <span class="comment">GraphSpecialMonth::~GraphSpecialMonth() {</span>
00060     deinit();
00061 }
00062 
00063 <span class="comment">//---------- End of function GraphSpecialMonth::~GraphSpecialMonth -----//</span>
00064 
00065 <span class="comment">//-------- Begin of function GraphSpecialMonth::init --------//</span>
00099 <span class="comment">void GraphSpecialMonth::init(int x1, int y1, int x2, int y2,</span>
00100                              <span class="keywordtype">int</span> seriesNum, <span class="keywordtype">int</span> *dataNum,
00101                              <span class="keywordtype">void</span> *dataArray, <span class="keywordtype">char</span> dataTypeFlag,
00102                              <span class="keywordtype">int</span> thisMonthIndicator,
00103                              <span class="keywordtype">char</span> *xLabel, <span class="keywordtype">char</span> *yLabel,
00104                              <span class="keywordtype">char</span> **legendArray, <span class="keywordtype">char</span> transparentFlag,
00105                              <span class="keywordtype">char</span> orientationFlag, <span class="keywordtype">char</span> valueFlag,
00106                              <span class="keywordtype">int</span> numFormat, <span class="keywordtype">int</span> *seriesColor, <span class="keywordtype">int</span> axisColor) {
00107     <a class="code" href="ALL_8H.html#a0">err_when</a>(seriesNum &gt; <a class="code" href="Ogrpsmth_8cpp.html#a7a2">DEFAULT_SERIES_COLOR_NUM</a> &amp;&amp; !seriesColor);
00108     <a class="code" href="ALL_8H.html#a0">err_when</a>(seriesNum &lt;= 0);
00109 
00110     graph_width = x2 - x1 - 6;
00111 
00112     <a class="code" href="ALL_8H.html#a0">err_when</a>(graph_width &lt; 0);
00113 
00114     graph_x1 = x1;
00115     graph_y1 = y1;
00116     graph_x2 = x2;
00117     graph_y2 = y2;
00118     series_num = seriesNum;
00119     data_num = dataNum;
00120     data_array = dataArray;
00121     data_type_flag = dataTypeFlag;
00122 
00123     x_label = xLabel;
00124     y_label = yLabel;
00125     legend_array = legendArray;
00126 
00127     transparent_flag = transparentFlag;
00128     orientation_flag = orientationFlag;
00129     value_flag = valueFlag;
00130     num_format = numFormat;
00131 
00132     series_color = seriesColor ? seriesColor : default_series_color;
00133     axis_color = axisColor;
00134 
00135     init_flag = 1;
00136     this_month_indicator = thisMonthIndicator;
00137     y_label_max_len = font_chartsm.text_width(<a class="code" href="Ogrpsmth_8cpp.html#a0">MAX_LEN_LABEL</a>);
00138     set_font(&amp;font_chartsm);
00139 }
00140 
00141 <span class="comment">//------------- End of function GraphSpecialMonth::init -----------//</span>
00142 
00143 <span class="comment">//-------- Begin of function GraphSpecialMonth::deinit ------------//</span>
<a name="l00145"></a><a class="code" href="classGraphSpecialMonth.html#a7">00145</a> <span class="comment">void GraphSpecialMonth::deinit() {</span>
00146     <span class="keywordflow">if</span> (graph_bitmap) {
00147         <a class="code" href="ALL_8H.html#a8">mem_del</a>(graph_bitmap);
00148         graph_bitmap = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00149     }
00150 
00151     init_flag = 0;
00152 }
00153 
00154 <span class="comment">//------------- End of function GraphSpecialMonth::deinit ---------//</span>
00155 
00156 <span class="comment">//-------- Begin of function GraphSpecialMonth::set_font ------------//</span>
<a name="l00158"></a><a class="code" href="classGraphSpecialMonth.html#a10">00158</a> <span class="comment">void GraphSpecialMonth::set_font(Font *fontPtr) {</span>
00159     <span class="keywordflow">if</span> (!init_flag)
00160         <span class="keywordflow">return</span>;
00161 
00162     font_ptr = fontPtr;
00163 
00164     calc_pos();
00165 }
00166 
00167 <span class="comment">//------------- End of function GraphSpecialMonth::set_font ---------//</span>
00168 
00169 <span class="comment">//-------- Begin of function GraphSpecialMonth::calc_pos ------------//</span>
<a name="l00174"></a><a class="code" href="classGraphSpecialMonth.html#a11">00174</a> <span class="comment">void GraphSpecialMonth::calc_pos() {</span>
00175     <span class="keywordflow">if</span> (legend_array) {
00176         <span class="keywordtype">short</span> textWidth = 0, textHeight = font_ptr-&gt;max_font_height;
00177 
00178         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00179             <span class="keywordflow">if</span> (font_ptr-&gt;text_width(legend_array[i]) &gt; textWidth)
00180                 textWidth = font_ptr-&gt;text_width(legend_array[i]);
00181         }
00182 
00183         <a class="code" href="ALL_8H.html#a0">err_when</a>(textWidth + <a class="code" href="Ogrpsmth_8cpp.html#a8a4">LEGEND_X_SPACING</a> * 2 &gt; graph_width);
00184 
00185         legend_x_num = (graph_width - <a class="code" href="Ogrpsmth_8cpp.html#a8a4">LEGEND_X_SPACING</a>*2) / (textWidth + <a class="code" href="Ogrpsmth_8cpp.html#a8a4">LEGEND_X_SPACING</a>*2);
00186         legend_y_num = (series_num / legend_x_num) + ((series_num % legend_x_num) ? 1 : 0);
00187 
00188         graph_height = graph_y2 - graph_y1 - legend_y_num * (textHeight + <a class="code" href="Ogrpsmth_8cpp.html#a8a5">LEGEND_Y_SPACING</a>) - 6;
00189 
00190         <a class="code" href="ALL_8H.html#a0">err_when</a>(graph_height &lt;= 0);
00191 
00192         legend_width = (graph_width - <a class="code" href="Ogrpsmth_8cpp.html#a8a4">LEGEND_X_SPACING</a>*2) / legend_x_num;
00193         legend_height = textHeight + <a class="code" href="Ogrpsmth_8cpp.html#a8a5">LEGEND_Y_SPACING</a>;
00194     }
00195     <span class="keywordflow">else</span> {
00196         legend_width = legend_height = legend_x_num = legend_y_num = 0;
00197         graph_height = graph_y2 - graph_y1 - 6;
00198     }
00199 
00200     <span class="keywordtype">short</span> YLabelWidth = y_label ? (orientation_flag ? font_ptr-&gt;max_font_height : font_ptr-&gt;text_width(y_label)) : -<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>;
00201     <span class="keywordtype">short</span> XLabelHeight = x_label ? (font_ptr-&gt;max_font_height) : -<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>;
00202     series_x1 = graph_x1 + 4 + <a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>*4 + YLabelWidth + y_label_max_len;
00203     series_y1 = graph_y1 + 4 + <a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>*6;
00204     series_x2 = graph_x2 - 4 - <a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>*16;
00205     series_y2 = graph_y1 + graph_height - <a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>*3 - (font_ptr-&gt;max_font_height);
00206 }
00207 
00208 <span class="comment">//------------ End of function GraphSpecialMonth::calc_pos ---------//</span>
00209 
00210 <span class="comment">//-------- Begin of function GraphSpecialMonth::paint --------------//</span>
<a name="l00212"></a><a class="code" href="classGraphSpecialMonth.html#a8">00212</a> <span class="comment">void GraphSpecialMonth::paint() {</span>
00213     <span class="keywordflow">if</span> (transparent_flag) {
00214         user_interface.brighten(graph_x1+4, graph_y1+4, graph_x2-2, graph_y2-2);
00215         <span class="keywordflow">if</span> (legend_array)
00216             draw_legend();
00217         draw_axis_label();
00218         graph_bitmap = vga_back.save_area(graph_x1+4, graph_y1+4, graph_x2-2, graph_y2-2, graph_bitmap);
00219     }
00220 
00221     <span class="comment">//  paint_flag = 1;</span>
00222     refresh();
00223 }
00224 
00225 <span class="comment">//------------- End of function GraphSpecialMonth::paint -----------//</span>
00226 
00227 <span class="comment">//-------- Begin of function GraphSpecialMonth::refresh ------------//</span>
<a name="l00229"></a><a class="code" href="classGraphSpecialMonth.html#a9">00229</a> <span class="comment">void GraphSpecialMonth::refresh() {</span>
00230     <span class="keywordflow">if</span> (transparent_flag) {
00231         user_interface.rect(graph_x1, graph_y1, graph_x2, graph_y2, 1);
00232         vga_back.rest_area(graph_bitmap, 0, 0);
00233     }
00234     <span class="keywordflow">else</span> {
00235         user_interface.bar(graph_x1, graph_y1, graph_x2, graph_y2);
00236         user_interface.panel(graph_x1+3, graph_y1+3, graph_x2-4, graph_y2-4);
00237     }
00238     <span class="keywordflow">if</span> (legend_array)
00239         draw_legend();
00240     draw_scale();
00241     draw_series();
00242 
00243     <span class="comment">//  if (!paint_flag)</span>
00244     <span class="comment">//          vga.blt_buf(graph_x1, graph_y1, graph_x2+2, graph_y2+2);</span>
00245     <span class="comment">//  else</span>
00246     <span class="comment">//          paint_flag = 0;</span>
00247 }
00248 
00249 <span class="comment">//------------- End of function GraphSpecialMonth::refresh ---------//</span>
00250 
00251 <span class="comment">//---------- Begin of function GraphSpecialMonth::draw_legend ------------//</span>
<a name="l00253"></a><a class="code" href="classGraphSpecialMonth.html#b0">00253</a> <span class="comment">void GraphSpecialMonth::draw_legend() {</span>
00254     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00255         <span class="keywordtype">short</span> legendX = graph_x1 + 4 + (i % legend_x_num) * legend_width + <a class="code" href="Ogrpsmth_8cpp.html#a8a4">LEGEND_X_SPACING</a>;
00256         <span class="keywordtype">short</span> legendY = graph_y1 + 4 + graph_height + (i / legend_x_num) * legend_height;
00257         user_interface.bar( legendX+<a class="code" href="Ogrpsmth_8cpp.html#a8a4">LEGEND_X_SPACING</a>, legendY+<a class="code" href="Ogrpsmth_8cpp.html#a8a5">LEGEND_Y_SPACING</a>,
00258                             legendX+<a class="code" href="Ogrpsmth_8cpp.html#a8a4">LEGEND_X_SPACING</a>+<a class="code" href="Ogrpsmth_8cpp.html#a8a3">LEGEND_SIZE</a>, legendY+<a class="code" href="Ogrpsmth_8cpp.html#a8a5">LEGEND_Y_SPACING</a>+<a class="code" href="Ogrpsmth_8cpp.html#a8a3">LEGEND_SIZE</a>,
00259                             series_color[i] );
00260         font_ptr-&gt;put( legendX+<a class="code" href="Ogrpsmth_8cpp.html#a8a4">LEGEND_X_SPACING</a>*2+<a class="code" href="Ogrpsmth_8cpp.html#a8a3">LEGEND_SIZE</a>, legendY+<a class="code" href="Ogrpsmth_8cpp.html#a8a5">LEGEND_Y_SPACING</a>, legend_array[i] );
00261     }
00262 }
00263 
00264 <span class="comment">//------------ End of function GraphSpecialMonth::draw_legend ------------//</span>
00265 
00266 <span class="comment">//---------- Begin of function GraphSpecialMonth::draw_axis_label --------//</span>
<a name="l00268"></a><a class="code" href="classGraphSpecialMonth.html#b1">00268</a> <span class="comment">void GraphSpecialMonth::draw_axis_label() {</span>
00269     <span class="keywordtype">short</span> textHeight = font_ptr-&gt;max_font_height;
00270 
00271     <span class="keywordflow">if</span> (x_label) {
00272         font_ptr-&gt;center_put( series_x1, series_y2+<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>*2+textHeight,
00273                               series_x2, graph_y1+graph_height-<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>, x_label );
00274     }
00275 
00276     <span class="keywordflow">if</span> (y_label) {
00277         <span class="keywordtype">short</span> textWidth = font_ptr-&gt;text_width(y_label) + 1;
00278 
00279         <span class="keywordflow">if</span> (orientation_flag) {
00280             <span class="keywordtype">short</span> *fontBuf = (<span class="keywordtype">short</span> *) sys.common_data_buf;
00281             <a class="code" href="ALL_8H.html#a0">err_when</a>(textWidth * textHeight * <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>) &gt; <a class="code" href="Osys_8h.html#a40a2">COMMON_DATA_BUF_SIZE</a>);
00282 
00283             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; textWidth * textHeight; i++)
00284                 *fontBuf++ = transparent_code_w;
00285 
00286             font_ptr-&gt;put_to_bufferW(fontBuf = (<span class="keywordtype">short</span> *) sys.common_data_buf, textWidth * <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>), 0, 0, y_label);
00287 
00288             <span class="keywordtype">short</span> xStart = graph_x1 + 4 + <a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a> * 2;
00289             <span class="keywordtype">short</span> yStart = (series_y1 + series_y2 - textWidth) / 2;
00290 
00291             <span class="keywordflow">for</span> (<span class="keywordtype">short</span> x = 0; x &lt; textHeight; x++) {
00292                 <span class="keywordflow">for</span> (<span class="keywordtype">short</span> y = textWidth - 1; y &gt;= 0; y--, fontBuf++) {
00293                     <span class="keywordflow">if</span> (*fontBuf != transparent_code_w)
00294                         *vga_back.buf_ptr(xStart+x, yStart+y) = *fontBuf;
00295                 }
00296             }
00297         }
00298         <span class="keywordflow">else</span> {
00299             font_ptr-&gt;center_put( graph_x1+4+<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>*2, series_y1,
00300                                   graph_x1+4+<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>*2+textWidth, series_y2, y_label);
00301         }
00302     }
00303 }
00304 
00305 <span class="comment">//------------ End of function GraphSpecialMonth::draw_axis_label --------//</span>
00306 
00307 <span class="comment">//---------- Begin of function GraphSpecialMonth::find_scale -------------//</span>
<a name="l00309"></a><a class="code" href="classGraphSpecialMonth.html#b2">00309</a> <span class="comment">void GraphSpecialMonth::find_scale() {</span>
00310     <span class="keywordtype">double</span> data, maxVal = 0.0,minVal = 0.0;
00311 
00312     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num * *data_num; i++) {
00313         <span class="keywordflow">switch</span> (data_type_flag) {
00314         <span class="keywordflow">case</span> DATA_DOUBLE:
00315             data = ((<span class="keywordtype">double</span>*)data_array)[i];
00316             <span class="keywordflow">break</span>;
00317         <span class="keywordflow">case</span> DATA_FLOAT:
00318             data = double(((<span class="keywordtype">float</span>*)data_array)[i]);
00319             <span class="keywordflow">break</span>;
00320         <span class="keywordflow">case</span> DATA_INT:
00321             data = double(((<span class="keywordtype">int</span>*)data_array)[i]);
00322             <span class="keywordflow">break</span>;
00323         <span class="keywordflow">case</span> DATA_LONG:
00324             data = double(((<span class="keywordtype">long</span>*)data_array)[i]);
00325             <span class="keywordflow">break</span>;
00326         }
00327         <span class="keywordflow">if</span> (data &gt; maxVal)
00328             maxVal = data;
00329         <span class="keywordflow">if</span> (data &lt; minVal)
00330             minVal = data;
00331     }
00332     <span class="keywordflow">if</span> (maxVal&gt;0)
00333         max_scale = maxVal;
00334     <span class="keywordflow">else</span>
00335         max_scale = 10;
00336 
00337     <span class="keywordflow">if</span> (minVal&lt;0)
00338         min_scale = minVal;
00339     <span class="keywordflow">else</span>
00340         min_scale = 0;
00341 
00342 }
00343 
00344 <span class="comment">//------------ End of function GraphSpecialMonth::find_scale -------------//</span>
00345 
00346 <span class="comment">//---------- Begin of function GraphSpecialMonth::draw_scale -------------//</span>
<a name="l00348"></a><a class="code" href="classGraphSpecialMonth.html#b3">00348</a> <span class="comment">void GraphSpecialMonth::draw_scale() {</span>
00349     find_scale();
00350 
00351     <span class="comment">//------ Draw y-axis -------//</span>
00352     vga_back.bar(series_x1, series_y1-<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>*2, series_x1+1, series_y2, axis_color);
00353 
00354     xAxisPos=(short)(series_y1+(series_y2-series_y1)*(max_scale)/(max_scale-min_scale));
00355 
00356     posScaleNum = (xAxisPos-series_y1-font_ptr-&gt;max_font_height) / (font_ptr-&gt;max_font_height*3/2);
00357     <span class="keywordflow">if</span> ( posScaleNum &gt; 0 )
00358         posScaleNum = short(pow(2,floor(log10(<span class="keywordtype">double</span>(posScaleNum))/log10(2.0))));
00359     <span class="keywordflow">else</span>
00360         posScaleNum = 0;
00361     negScaleNum = (series_y2-xAxisPos-font_ptr-&gt;max_font_height) / (font_ptr-&gt;max_font_height*3/2);
00362     <span class="keywordflow">if</span> ( negScaleNum &gt; 0 )
00363         negScaleNum = short(pow(2,ceil(log10(<span class="keywordtype">double</span>(negScaleNum))/log10(2.0))));
00364     <span class="keywordflow">else</span>
00365         negScaleNum = 0;
00366 
00367 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00368 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( posScaleNum + negScaleNum &lt;= 0) {
00369         posScaleNum = 1;
00370         negScaleNum = 0;
00371     }
00372 <span class="preprocessor">#endif</span>
00373 <span class="preprocessor"></span>
00374     <span class="keywordtype">short</span> posScaleStep;
00375     <span class="keywordtype">short</span> negScaleStep;
00376 
00377     <span class="keywordflow">if</span>(posScaleNum&lt;1) {
00378         posScaleStep = 0;
00379         posScaleInc = 0;
00380     }
00381     <span class="keywordflow">else</span> {
00382         posScaleStep  = (xAxisPos-series_y1) / posScaleNum;
00383         posScaleInc   = max_scale / posScaleNum;
00384 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00385 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( data_type_flag==DATA_INT || data_type_flag==DATA_LONG )
00386             posScaleInc = ceil(posScaleInc);            <span class="comment">// don't like integer type to have non-integral posScaleInc</span>
00387 <span class="preprocessor">#endif</span>
00388 <span class="preprocessor"></span>    }
00389 
00390     <span class="keywordflow">if</span>(negScaleNum&lt;1) {
00391         negScaleStep = 0;
00392         negScaleInc = 0;
00393     }
00394     <span class="keywordflow">else</span> {
00395         negScaleStep = (series_y2-xAxisPos) / negScaleNum;
00396         negScaleInc   = -min_scale / negScaleNum;
00397 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00398 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( data_type_flag==DATA_INT || data_type_flag==DATA_LONG )
00399             negScaleInc = ceil(negScaleInc);            <span class="comment">// don't like integer type to have non-integral negScaleInc</span>
00400 <span class="preprocessor">#endif</span>
00401 <span class="preprocessor"></span>    }
00402 
00403     <span class="keywordflow">if</span>(posScaleNum+negScaleNum&lt;1) {
00404         scaleStep = 0;
00405         scaleInc   = 0;
00406     }
00407     <span class="keywordflow">else</span> {
00408         scaleStep = (short)((series_y2-series_y1)/(posScaleNum+negScaleNum));
00409         scaleInc = ((max_scale-min_scale)/(posScaleNum+negScaleNum));
00410 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00411 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( data_type_flag==DATA_INT || data_type_flag==DATA_LONG )
00412             scaleInc = max(posScaleInc, negScaleInc);
00413 <span class="preprocessor">#endif</span>
00414 <span class="preprocessor"></span>    }
00415 
00416     <span class="keywordtype">double</span> scaleValue;
00417 
00418     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = -negScaleNum,ycheck=xAxisPos-i*scaleStep;
00419          ycheck&gt;graph_y1;
00420          i++,ycheck-=scaleStep) {
00421 
00422         vga_back.bar(series_x1, ycheck, series_x1+<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>*2, ycheck, axis_color);
00423 
00424         scaleValue = i*scaleInc;
00425 
00426         <span class="keywordflow">switch</span> (data_type_flag) {
00427         <span class="keywordflow">case</span> DATA_FLOAT:
00428         <span class="keywordflow">case</span> DATA_DOUBLE:
00429             font_ptr-&gt;right_put(series_x1-<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>, ycheck-font_ptr-&gt;max_font_height/2, m.format(scaleValue,num_format));
00430             <span class="keywordflow">break</span>;
00431         <span class="keywordflow">case</span> DATA_INT:
00432         <span class="keywordflow">case</span> DATA_LONG:
00433             font_ptr-&gt;right_put(series_x1-<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>, ycheck-font_ptr-&gt;max_font_height/2, m.format(<span class="keywordtype">long</span>(scaleValue),num_format));
00434         }
00435     }
00436 
00437     <span class="comment">//------ Draw x-axis -------//</span>
00438     vga_back.bar(series_x1, xAxisPos-<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>, series_x2+1, xAxisPos, axis_color);
00439 
00440     <span class="keywordtype">int</span> shown_year=48;
00441     <span class="comment">// show x-axis scale</span>
00442     <span class="keywordtype">double</span> actual_end;
00443     <span class="keywordflow">if</span> (this_month_indicator&lt;0)
00444         actual_end=((double)info.game_month-1)/12.0+info.game_year;
00445     <span class="keywordflow">else</span>
00446         actual_end=(((double)info.game_month-1)+this_month_indicator)/12.0+info.game_year;
00447 
00448     <span class="keywordtype">int</span> show_end=(int)(actual_end);
00449 
00450     <span class="keywordtype">short</span> maxLabelWidth = font_ptr-&gt;text_width(m.format(show_end, 16))+<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>*2;
00451     x_axis_step = ((float)series_x2-series_x1) / (shown_year-1);
00452 
00453     <span class="keywordtype">double</span> actual_start = actual_end-(double)(info.graph_month)/12.0;
00454     <span class="keywordtype">double</span> show_year_offset=1.0-(actual_start-(int)actual_start)-1.0/12.0;
00455     <span class="keywordtype">int</span> show_start=(int)(actual_start)+1;
00456 
00457     show_end=show_start+4;
00458 
00459     <span class="keywordtype">short</span> displayInc = 0;
00460     <span class="keywordflow">while</span> (displayInc * x_axis_step * 12.0&lt; maxLabelWidth) displayInc++;
00461 
00462     <span class="comment">//------ Draw x-axis -------//</span>
00463     <span class="keywordflow">for</span> (i = show_start; i &lt;=show_end ; i+=displayInc) {
00464         <span class="keywordtype">int</span> this_x;
00465         <span class="keywordflow">if</span>((this_x = (int)(series_x1+((double)(i-show_start)+show_year_offset)*x_axis_step*12))&lt;series_x2) {
00466             vga_back.bar(
00467                 this_x,
00468                 xAxisPos-<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>*2,
00469                 this_x+1,
00470                 xAxisPos, axis_color);
00471             font_ptr-&gt;center_put(
00472                 this_x-maxLabelWidth/2-<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>,
00473                 xAxisPos+<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>,
00474                 this_x+maxLabelWidth/2-<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>,
00475                 xAxisPos+<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>+font_ptr-&gt;max_font_height,
00476                 m.format(i, 16));
00477         }
00478     }
00479 
00480     <span class="comment">//---- Draw this year indicators ----//</span>
00481     <span class="keywordflow">if</span>((this_month_indicator&gt;=0)&amp;&amp;(this_month_indicator&lt;HISTORY_MONTH_COUNT))
00482         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=series_y1;j&lt;series_y2+<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>;j+=8)
00483             vga_back.bar(
00484                 (<span class="keywordtype">int</span>)(series_x1+(info.graph_month-this_month_indicator-1)*x_axis_step),
00485                 j,
00486                 (<span class="keywordtype">int</span>)(series_x1+(info.graph_month-this_month_indicator-1)*x_axis_step),
00487                 j+4,
00488                 axis_color);
00489 }
00490 
00491 <span class="comment">//------------ End of function GraphSpecialMonth::draw_scale -------------//</span>
00492 
00493 <span class="comment">//---------- Begin of function GraphSpecialMonth::draw_series ------------//</span>
<a name="l00495"></a><a class="code" href="classGraphSpecialMonth.html#b4">00495</a> <span class="comment">void GraphSpecialMonth::draw_series() {</span>
00496     <span class="keywordflow">switch</span> (data_type_flag) {
00497     <span class="keywordflow">case</span> DATA_FLOAT: draw_series_float(); <span class="keywordflow">break</span>;
00498     <span class="keywordflow">case</span> DATA_DOUBLE: draw_series_double(); <span class="keywordflow">break</span>;
00499     <span class="keywordflow">case</span> DATA_INT: draw_series_int(); <span class="keywordflow">break</span>;
00500     <span class="keywordflow">case</span> DATA_LONG: draw_series_long(); <span class="keywordflow">break</span>;
00501     }
00502 }
00503 
00504 <span class="comment">//------------ End of function GraphSpecialMonth::draw_series ------------//</span>
00505 
00506 <span class="comment">//---------- Begin of function GraphSpecialMonth::draw_series_float ------------//</span>
<a name="l00508"></a><a class="code" href="classGraphSpecialMonth.html#b5">00508</a> <span class="comment">void GraphSpecialMonth::draw_series_float() {</span>
00509     <span class="keywordtype">float</span> *dataArray = (<span class="keywordtype">float</span> *) data_array;
00510     <span class="keywordtype">short</span> prevX, prevY, currX, currY;
00511 
00512     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00513         dataArray-=info.graph_month;
00514         dataArray+=HISTORY_MONTH_COUNT;
00515         prevX = series_x1;
00516         prevY = xAxisPos-(short)(*dataArray * scaleStep/scaleInc) ;
00517 
00518         dataArray++;
00519         vga_back.thick_line(prevX-1, prevY, prevX+1, prevY, vga_back.translate_color(series_color[i]));
00520 
00521         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 1; j &lt; info.graph_month; j++) {
00522             currX = series_x1 + (short)(j * x_axis_step);
00523             currY = xAxisPos-(short)(*dataArray * scaleStep/scaleInc) ;
00524 
00525             vga_back.thick_line(prevX, prevY, currX, currY, vga_back.translate_color(series_color[i]));
00526 
00527             prevX = currX;
00528             prevY = currY;
00529             dataArray++;
00530         }
00531 
00532         <span class="keywordflow">if</span> (value_flag)
00533             draw_value(dataArray-1, vga_back.translate_color(series_color[i]), prevX+<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>-(int)(0.3f*x_axis_step), prevY-font_news.max_font_height/2, DATA_FLOAT);
00534     }
00535 }
00536 
00537 <span class="comment">//------------ End of function GraphSpecialMonth::draw_series_float ------------//</span>
00538 
00539 <span class="comment">//---------- Begin of function GraphSpecialMonth::draw_series_double ------------//</span>
<a name="l00541"></a><a class="code" href="classGraphSpecialMonth.html#b6">00541</a> <span class="comment">void GraphSpecialMonth::draw_series_double() {</span>
00542     <span class="keywordtype">double</span> *dataArray = (<span class="keywordtype">double</span> *) data_array;
00543     <span class="keywordtype">short</span> prevX, prevY, currX, currY;
00544 
00545     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00546         dataArray-=info.graph_month;
00547         dataArray+=HISTORY_MONTH_COUNT;
00548         prevX = series_x1;
00549         prevY = xAxisPos-(short)(*dataArray * (double)scaleStep/scaleInc);
00550 
00551         dataArray++;
00552         vga_back.thick_line(prevX-1, prevY, prevX+1, prevY, vga_back.translate_color(series_color[i]));
00553 
00554         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 1; j &lt; info.graph_month; j++) {
00555             currX = series_x1 + (short)(j * x_axis_step);
00556             currY = xAxisPos-(short)(*dataArray * (double)scaleStep/scaleInc);
00557 
00558             vga_back.thick_line(prevX, prevY, currX, currY, vga_back.translate_color(series_color[i]));
00559 
00560             prevX = currX;
00561             prevY = currY;
00562             dataArray++;
00563         }
00564 
00565         <span class="keywordflow">if</span> (value_flag)
00566             draw_value(dataArray-1, vga_back.translate_color(series_color[i]), prevX+<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>-(int)(0.3f*x_axis_step), prevY-font_news.max_font_height/2, DATA_DOUBLE);
00567     }
00568 }
00569 
00570 <span class="comment">//------------ End of function GraphSpecialMonth::draw_series_double ------------//</span>
00571 
00572 <span class="comment">//---------- Begin of function GraphSpecialMonth::draw_series_int ------------//</span>
<a name="l00574"></a><a class="code" href="classGraphSpecialMonth.html#b7">00574</a> <span class="comment">void GraphSpecialMonth::draw_series_int() {</span>
00575     <span class="keywordtype">int</span> *dataArray = (<span class="keywordtype">int</span> *) data_array;
00576     <span class="keywordtype">short</span> prevX, prevY, currX, currY;
00577 
00578     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00579         dataArray-=info.graph_month;
00580         dataArray+=HISTORY_MONTH_COUNT;
00581         prevX = series_x1;
00582         prevY = xAxisPos-(short)(*dataArray * scaleStep/scaleInc);
00583 
00584         dataArray++;
00585         vga_back.thick_line(prevX-1, prevY, prevX+1, prevY, vga_back.translate_color(series_color[i]));
00586 
00587         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 1; j &lt; info.graph_month; j++) {
00588             currX = series_x1 + (short)(j * x_axis_step);
00589             currY = (short)(xAxisPos-(int)(*dataArray * scaleStep/scaleInc));
00590 
00591             vga_back.thick_line(prevX, prevY, currX, currY, vga_back.translate_color(series_color[i]));
00592 
00593             prevX = currX;
00594             prevY = currY;
00595             dataArray++;
00596         }
00597 
00598         <span class="keywordflow">if</span> (value_flag)
00599             draw_value(dataArray-1, vga_back.translate_color(series_color[i]), prevX+<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>-(int)(0.3f*x_axis_step), prevY-font_news.max_font_height/2, DATA_INT);
00600     }
00601 }
00602 
00603 <span class="comment">//------------ End of function GraphSpecialMonth::draw_series_int ------------//</span>
00604 
00605 <span class="comment">//---------- Begin of function GraphSpecialMonth::draw_series_long ------------//</span>
<a name="l00607"></a><a class="code" href="classGraphSpecialMonth.html#b8">00607</a> <span class="comment">void GraphSpecialMonth::draw_series_long() {</span>
00608     <span class="keywordtype">long</span> *dataArray = (<span class="keywordtype">long</span> *) data_array;
00609     <span class="keywordtype">short</span> prevX, prevY, currX, currY;
00610 
00611     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00612         dataArray-=info.graph_month;
00613         dataArray+=HISTORY_MONTH_COUNT;
00614         prevX = series_x1;
00615         prevY = xAxisPos-(short)(*dataArray * scaleStep/scaleInc);
00616 
00617         dataArray++;
00618         vga_back.thick_line(prevX-1, prevY, prevX+1, prevY, vga_back.translate_color(series_color[i]));
00619 
00620         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 1; j &lt; info.graph_month; j++) {
00621             currX = series_x1 + (short)(j * x_axis_step);
00622             currY = xAxisPos-(short)(*dataArray * scaleStep/scaleInc);
00623 
00624             vga_back.thick_line(prevX, prevY, currX, currY, vga_back.translate_color(series_color[i]));
00625 
00626             prevX = currX;
00627             prevY = currY;
00628             dataArray++;
00629         }
00630 
00631         <span class="keywordflow">if</span> (value_flag)
00632             draw_value(dataArray-1, vga_back.translate_color(series_color[i]), prevX+<a class="code" href="Ogrpsmth_8cpp.html#a9a6">COMMON_OFFSET</a>-(int)(0.3f*x_axis_step), prevY-font_news.max_font_height/2, DATA_LONG);
00633     }
00634 }
00635 
00636 <span class="comment">//------------ End of function GraphSpecialMonth::draw_series_float ------------//</span>
00637 
00638 <span class="comment">//---------- Begin of function GraphSpecialMonth::draw_value -------------------//</span>
<a name="l00640"></a><a class="code" href="classGraphSpecialMonth.html#b9">00640</a> <span class="comment">void GraphSpecialMonth::draw_value(void *value, int color, short x, short y, int dataType) {</span>
00641     <span class="keywordtype">char</span> *valueString;
00642     <span class="keywordflow">switch</span> (data_type_flag) {
00643     <span class="keywordflow">case</span> DATA_FLOAT:
00644         valueString = m.format(*((<span class="keywordtype">float</span> *) value), num_format); <span class="keywordflow">break</span>;
00645     <span class="keywordflow">case</span> DATA_DOUBLE:
00646         valueString = m.format(*((<span class="keywordtype">double</span> *) value), num_format); <span class="keywordflow">break</span>;
00647     <span class="keywordflow">case</span> DATA_INT:
00648         valueString = m.format(*((<span class="keywordtype">int</span> *) value), num_format); <span class="keywordflow">break</span>;
00649     <span class="keywordflow">case</span> DATA_LONG:
00650         valueString = m.format(*((<span class="keywordtype">long</span> *) value), num_format); <span class="keywordflow">break</span>;
00651     }
00652 
00653     <span class="keywordtype">short</span> textHeight = font_news.max_font_height;
00654     <span class="keywordtype">short</span> textWidth = font_news.text_width(valueString) + 1;
00655 
00656     <span class="comment">/*</span>
00657 <span class="comment">      short *bitmap = (short *) sys.common_data_buf;</span>
00658 <span class="comment">      err_when( (2 + textWidth * textHeight) * sizeof(short) &gt; COMMON_DATA_BUF_SIZE );</span>
00659 <span class="comment">      *bitmap++ = textWidth;</span>
00660 <span class="comment">      *bitmap++ = textHeight;</span>
00661 <span class="comment"></span>
00662 <span class="comment">      short *shortPtr = bitmap;</span>
00663 <span class="comment">      for (int i = 0; i &lt; textWidth * textHeight; i++)</span>
00664 <span class="comment">      *shortPtr++ = transparent_code_w;</span>
00665 <span class="comment"></span>
00666 <span class="comment">      font_news.put_to_bufferW(bitmap, textWidth * sizeof(short), 0, 0, valueString);</span>
00667 <span class="comment"></span>
00668 <span class="comment">      shortPtr = bitmap;</span>
00669 <span class="comment">      for (i = 0; i &lt; textWidth * textHeight; i++, shortPtr++)</span>
00670 <span class="comment">      if (*shortPtr != transparent_code_w)</span>
00671 <span class="comment">      *shortPtr = color;</span>
00672 <span class="comment"></span>
00673 <span class="comment">      vga_back.put_bitmapW_trans(x, y, (short *) sys.common_data_buf);</span>
00674 <span class="comment">    */</span>
00675     font_chartsm.put(x+3,y,valueString);
00676 }
00677 
00678 <span class="comment">//---------- End of function GraphSpecialMonth::draw_value -------------------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:55 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
