<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Ofaculty.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Ofaculty.cpp</h1><a href="Ofaculty_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OFACULTY.cpp</span>
00002 <span class="comment">//Description : FACULTY Class Definition</span>
00003 
00004 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00005 <span class="preprocessor">#include &lt;OMATH.H&gt;</span>
00006 <span class="preprocessor">#include &lt;ODEPT.H&gt;</span>
00007 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00008 <span class="preprocessor">#include &lt;OCHANCE.H&gt;</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="ONAMERES_8H.html">ONAMERES.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="OFPHOTO_8H.html">OFPHOTO.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>
00012 <span class="preprocessor">#include &lt;OFACULTY.H&gt;</span>
00013 <span class="preprocessor">#include &lt;OFINANCE.H&gt;</span>
00014 <span class="preprocessor">#include &lt;OFACILIT.H&gt;</span>
00015 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>                             <span class="comment">// trimester_array</span>
00016 <span class="preprocessor">#include &lt;OLIBTECH.H&gt;</span>                             <span class="comment">// .faculty_incentive_using_it</span>
00017 <span class="preprocessor">#include &lt;<a class="code" href="ODEPTRES_8H.html">ODEPTRES.H</a>&gt;</span>
00018 <span class="preprocessor">#include &lt;<a class="code" href="OPEERSCH_8H.html">OPEERSCH.H</a>&gt;</span>
00019 <span class="preprocessor">#include &lt;<a class="code" href="OSCHLRES_8H.html">OSCHLRES.H</a>&gt;</span>
00020 
00021 <span class="comment">//-------- declare static funciton ------------//</span>
00022 
00023 <span class="keyword">static</span> <span class="keywordtype">int</span> get_discretionary_time_pref(<span class="keywordtype">char</span>* discretionaryTimePref, <span class="keywordtype">int</span> index);
00024 
00025 <span class="comment">//---------- Begin of function Faculty::init -----------//</span>
<a name="l00027"></a><a class="code" href="classFaculty.html#a6">00027</a> <span class="comment">void Faculty::init(int departmentRecno, int rankLevel, int genderEthnicGroup, int facultyAge, int startTeachingDate,</span>
00028                    <span class="keywordtype">int</span> facultySalary, <span class="keywordtype">int</span> talentTeaching, <span class="keywordtype">int</span> talentScholarship, <span class="keywordtype">int</span> talentResearch) {
00029     memset( <span class="keyword">this</span>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classFaculty.html">Faculty</a>) );
00030 
00031     <a class="code" href="ALL_8H.html#a0">err_when</a>( genderEthnicGroup &lt; 0 || genderEthnicGroup &gt;= <a class="code" href="Gamedef_8h.html#a74a26">GENDER_ETHNIC_TYPE_COUNT</a> );
00032 
00033     <span class="comment">//----------------------------------------------//</span>
00034 
00035     department_recno      = departmentRecno;
00036     rank_level          = rankLevel;
00037     gender_ethnic_group     = genderEthnicGroup;
00038 
00039 <span class="preprocessor">#ifdef DEBUG</span>
00040 <span class="preprocessor"></span>    rank_age_group(rank_level, facultyAge);
00041 <span class="preprocessor">#endif</span>
00042 <span class="preprocessor"></span>
00043     birthday            = info.game_date - int((<span class="keywordtype">float</span>)(facultyAge)*365.25) - m.random(300);
00044     salary            = facultySalary;
00045     teaching_contact_hour = <a class="code" href="Ocourse_8h.html#a4">CONTACT_HOUR_PER_COURSE</a>;<span class="comment">//0112      // starts at zero, it is set in the course matching process</span>
00046     start_teaching_date   = startTeachingDate;
00047 
00048     <span class="keywordflow">if</span> ( age() != facultyAge &amp;&amp; facultyAge == 41 )  <span class="comment">// FULL PROFESSOR_1</span>
00049         birthday -= 365;                              <span class="comment">// fix bug on fly // 1102</span>
00050 
00051   <span class="comment">//--------- init name ----------//</span>
00052 
00053     <span class="keywordtype">int</span> loopCount=0;
00054     <span class="keywordtype">int</span> curGender;
00055 
00056     <span class="keywordflow">if</span>( gender_ethnic_group == <a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a> ||
00057         gender_ethnic_group == <a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a> ) {
00058         curGender = <span class="charliteral">'M'</span>;
00059     }
00060     <span class="comment">//### fred 1023</span>
00061     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( gender_ethnic_group == <a class="code" href="Gamedef_8h.html#a75a28">NONMINORITY_FEMALE</a> ||
00062               gender_ethnic_group == <a class="code" href="Gamedef_8h.html#a75a30">MINORITY_FEMALE</a> )
00063         curGender = <span class="charliteral">'F'</span>;
00064     <span class="keywordflow">else</span>
00065         <a class="code" href="ALL_8H.html#a1">err_here</a>();
00066     <span class="comment">//### fred 1023</span>
00067 
00068 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00069 <span class="preprocessor"></span>    <span class="keywordflow">do</span> {
00070 <span class="preprocessor">#endif</span>
00071 <span class="preprocessor"></span>        <span class="keywordflow">while</span>(1) {
00072             first_name_id = m.random(name_res.first_name_count)+1;
00073 
00074             <span class="keywordflow">if</span>( name_res.first_name_array[first_name_id-1].gender == curGender )
00075                 <span class="keywordflow">break</span>;
00076             ++loopCount;
00077             <a class="code" href="ALL_8H.html#a0">err_when</a>( loopCount &gt; 1000 );
00078         }
00079 
00080         middle_name_id = m.random(name_res.middle_name_count)+1;
00081         last_name_id   = m.random(name_res.last_name_count)+1;
00082 
00083 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00084 <span class="preprocessor"></span>        <span class="comment">// skip Dick Head, also can skip combination here</span>
00085     } <span class="keywordflow">while</span>( strcmp( name_res.first_name_array[first_name_id-1].name, <span class="stringliteral">"Dick"</span>)==0
00086              &amp;&amp; strcmp( name_res.last_name_array[last_name_id-1].name, <span class="stringliteral">"Head"</span>)==0 );
00087 <span class="preprocessor">#endif</span>
00088 <span class="preprocessor"></span>
00089     <span class="comment">//---------- research proposals ----------//</span>
00090 
00091     research_proposal_count = 0;
00092     research_month_expense  = 0;
00093     research_month_expense_direct = 0;              <span class="comment">//## chea 151199 forget to init</span>
00094 
00095 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00096 <span class="preprocessor"></span>    employ_status = 4;
00097 <span class="preprocessor">#endif</span>
00098 <span class="preprocessor"></span>
00099     <span class="comment">//-------------- trimester ---------------//</span>
00100 
00101     off_duty_trimester = <a class="code" href="Gamedef_8h.html#a79a38">SUMMER</a>;                    <span class="comment">// it is default to SUMMER for all faculty</span>
00102     is_third_trimester_teaching = 0;                <span class="comment">// it is default to 0 for all faculty</span>
00103 
00104   <span class="comment">//----------------------------------------//</span>
00105     reaction_summer_teaching = 0;
00106 
00107     <span class="comment">// initial value may be larger than 100, so we clip it at 100 here</span>
00108     talent_teaching    = (float) min(100, talentTeaching);
00109     talent_scholarship = (float) min(100, talentScholarship);
00110     talent_research  = (float) min(100, talentResearch);
00111 
00112     <a class="code" href="ALL_8H.html#a0">err_when</a>(talent_teaching&lt;0 || talent_scholarship&lt;0 || talent_research&lt;0);
00113 
00114   <span class="comment">//------ pick a photo for the faculty -------//</span>
00115 
00116     init_photo();
00117     this-&gt;name();
00118 
00119   <span class="comment">//----------------------------------------//</span>
00120 
00121   <span class="comment">// 0108</span>
00122     <span class="keywordtype">int</span> checkSum = 0;
00123     <span class="keywordtype">int</span> checkSum2 = 0;
00124     <span class="keywordtype">char</span> tmplCode = <span class="charliteral">'A'</span>;
00125 
00126     <a class="code" href="structFacultyTemplate.html">FacultyTemplate</a> *facultyTemplate = faculty_res.get_faculty_template( &amp;tmplCode , rank_age_group(rank_level, age()));
00127 
00128     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> j=0 ; j&lt;<a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a> ; j++ ) {
00129         this-&gt;discretionary_hour_array[j] = <a class="code" href="Ofaculty_8h.html#a2">NORMAL_DISCRETIONARY_HOUR</a> * get_discretionary_time_pref( facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m12">discretionary_time_pref</a>, j ) / 100;
00130         checkSum += discretionary_hour_array[j];
00131 
00132         checkSum2 += get_discretionary_time_pref( facultyTemplate-&gt;<a class="code" href="structFacultyTemplate.html#m12">discretionary_time_pref</a>, j );
00133     }
00134 
00135     <a class="code" href="ALL_8H.html#a0">err_when</a>(checkSum &lt;= 0 || checkSum2 &lt; 90 || checkSum2 &gt; 105);
00136 
00137   <span class="comment">//----------------------------------------//</span>
00138 
00139     <a class="code" href="classFaculty.html">Faculty</a>* facultyPtr = <span class="keyword">this</span>;
00140     <span class="keywordtype">float</span> qualityDriver = facultyPtr-&gt;<a class="code" href="classFaculty.html#a23">get_quality_driver</a>();
00141     <span class="keywordtype">float</span> oRate = finance.get_research_overhead_rate() / 100.0f;
00142 
00143     <span class="comment">//## chea 161099</span>
00144     <span class="comment">//  facultyPtr-&gt;proj_count_mult =</span>
00145     <span class="comment">//          float (0.8 + 0.004 * math.dual_response_func(1,50,100,29,33,20,76, qualityDriver));</span>
00146     <span class="comment">//  facultyPtr-&gt;proj_size_mult =</span>
00147     <span class="comment">//          float (0.7 + 0.006 * math.dual_response_func(1,50,100,29,33,20,76, qualityDriver) * math.safe_pow(1.0f+oRate, -0.5f) );</span>
00148     <span class="comment">//  facultyPtr-&gt;award_prob =</span>
00149     <span class="comment">//          float (0.01 + 0.005 * math.dual_response_func(1,50,100,29,33,20,76, qualityDriver) * math.safe_pow(1.0f+oRate, -1.5f) );</span>
00150 
00151   <span class="comment">//## chea 161099</span>
00152   <span class="comment">//    facultyPtr-&gt;proj_count_mult =</span>
00153   <span class="comment">//            float (0.8 + 0.4 * math.dual_response_func(1,50,100,29,33,20,76, qualityDriver)/100);</span>
00154   <span class="comment">//    facultyPtr-&gt;proj_size_mult =</span>
00155   <span class="comment">//            float (0.7 + 0.6 * math.dual_response_func(1,50,100,29,33,20,76, qualityDriver)/100 * math.safe_pow(1.0f+oRate, -0.5f) );</span>
00156   <span class="comment">//    facultyPtr-&gt;award_prob =</span>
00157   <span class="comment">//            float (0.01 + 0.5 * math.dual_response_func(1,50,100,29,33,20,76, qualityDriver)/100 * math.safe_pow(1.0f+oRate, -1.5f) );</span>
00158   <span class="comment">//            float (0.01 + 0.5 * math.dual_response_func(1,50,100,29,33,20,76, qualityDriver)/100 * math.safe_pow(1.0f+oRate, -1.5f) );//## chea 031199</span>
00159 
00160   <span class="comment">//## chea 191199</span>
00161   <span class="comment">//## chea 041199 new request</span>
00162     facultyPtr-&gt;<a class="code" href="classFaculty.html#m39">proj_count_mult</a> = (0.8f + 0.4f * this-&gt;talent_research/100);
00163     facultyPtr-&gt;<a class="code" href="classFaculty.html#m40">proj_size_mult</a> = (0.7f + 0.6f * this-&gt;talent_research/100);
00164     <span class="comment">//  if(facultyPtr-&gt;talent_research &lt;= 20)</span>
00165     <span class="comment">//          facultyPtr-&gt;award_prob = 0.0f;</span>
00166     <span class="comment">//  else if(facultyPtr-&gt;talent_research &lt;= 40)</span>
00167     <span class="comment">//          facultyPtr-&gt;award_prob = 0.05f;</span>
00168     <span class="comment">//  else if(facultyPtr-&gt;talent_research &lt;= 60)</span>
00169     <span class="comment">//          facultyPtr-&gt;award_prob = 0.10f;</span>
00170     <span class="comment">//  else if(facultyPtr-&gt;talent_research &lt;= 80)</span>
00171     <span class="comment">//          facultyPtr-&gt;award_prob = 0.15f;</span>
00172     <span class="comment">//  else</span>
00173     <span class="comment">//          facultyPtr-&gt;award_prob = (facultyPtr-&gt;talent_research/100);</span>
00174 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00175 <span class="preprocessor"></span>    <span class="comment">// this-&gt;award_prob = (float)(0.01f + 0.5 * this-&gt;talent_research/100);</span>
00176     <span class="comment">// change in 18/03/2002</span>
00177     <span class="keywordtype">float</span> awardProb = 2.0f * (qualityDriver * 0.01f) / math.safe_pow( (1.0f + oRate), 3.0f );
00178     this-&gt;award_prob = m.fmin( 0.85f, m.fmax(0.10f, awardProb) );
00179 <span class="preprocessor">#else</span>
00180 <span class="preprocessor"></span>    this-&gt;award_prob = (float)(0.01f + 0.9 * this-&gt;talent_research/100);
00181 <span class="preprocessor">#endif</span>
00182 <span class="preprocessor"></span>
00183     <a class="code" href="classDepartment.html">Department</a>* deptPtr = department_array[department_recno];
00184     <span class="keywordtype">char</span> rankAgeGroup = rank_age_group(rank_level, age());
00185     deptPtr-&gt;<a class="code" href="classDepartment.html#a24">init_proj_vars</a>(<span class="keyword">this</span>);
00186 
00187     <span class="comment">//------ initialize faculty discretionary time ------//</span>
00188 
00189     <span class="comment">//  DepartmentInfo* deptInfo = department_res[deptPtr-&gt;department_id];</span>
00190 
00191     <span class="comment">//  facultyTemplate = faculty_res.get_faculty_template( deptInfo-&gt;template_discretionary_time, rankAgeGroup );</span>
00192 
00193     <span class="comment">//  for( j=0 ; j&lt;DISCRETIONARY_TYPE_COUNT ; j++ )</span>
00194     <span class="comment">//          facultyPtr-&gt;discretionary_hour_array[j] = NORMAL_DISCRETIONARY_HOUR * facultyTemplate-&gt;discretionary_time_pref[j] / 100;</span>
00195 }
00196 
00197 <span class="comment">//---------- End of function Faculty::init -----------//</span>
00198 
00199 <span class="comment">//---------- Begin of function get_discretionary_time_pref -----------//</span>
00203 <span class="comment">static int get_discretionary_time_pref(char* discretionaryTimePref, int index) {</span>
00204     <span class="keywordflow">if</span>( player_school.scenario_id == <a class="code" href="Opschool_8h.html#a63a24">SCN_TEACHING_QUALITY</a> || player_school.scenario_id == <a class="code" href="Opschool_8h.html#a63a25">SCN_RESEARCH_QUALITY</a> ) {
00205         <span class="comment">//---- create a template pref array for storing the modified values -----//</span>
00206 
00207         <span class="keywordtype">float</span> tempPref[<a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a>];     <span class="comment">// discretionary time preference // 0-100</span>
00208 
00209         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;<a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a> ; i++ ) {
00210             tempPref[i] = (float) discretionaryTimePref[i];
00211         }
00212 
00213         <span class="comment">//-------- process some special pref -----//</span>
00214 
00215         <span class="keywordflow">if</span> ( player_school.scenario_id == <a class="code" href="Opschool_8h.html#a63a24">SCN_TEACHING_QUALITY</a> ) {
00216             tempPref[<a class="code" href="Ofaculty_8h.html#a29a16">DT_OUT_OF_CLASS_STUDENT_CONTACT</a>] *= 0.333f;
00217             tempPref[<a class="code" href="Ofaculty_8h.html#a29a17">DT_EDUCATIONAL_DEVELOPMENT</a>] *= 0.333f;
00218         }
00219         <span class="keywordflow">else</span> <span class="keywordflow">if</span>( player_school.scenario_id == <a class="code" href="Opschool_8h.html#a63a25">SCN_RESEARCH_QUALITY</a> ) {
00220             tempPref[<a class="code" href="Ofaculty_8h.html#a29a18">DT_RESEARCH</a>]  *= 0.333f;
00221             tempPref[<a class="code" href="Ofaculty_8h.html#a29a19">DT_SCHOLARSHIP</a>]  *= 0.333f;
00222         }
00223 
00224         <span class="comment">//--------- renormalize ---------//</span>
00225 
00226         <span class="keywordtype">float</span> totalPref=0;
00227 
00228         <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a> ; i++ ) {
00229             totalPref += tempPref[i];
00230         }
00231 
00232         <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a> ; i++ ) {
00233             tempPref[i] = tempPref[i] * 100 / totalPref;
00234         }
00235 
00236         <span class="keywordtype">int</span> ret = (int) tempPref[index];
00237 
00238         <span class="keywordflow">if</span>( tempPref[index] - (int) tempPref[index] &gt; 0.5f )
00239             ret++;
00240 
00241         <span class="keywordflow">return</span> ret;
00242     }
00243     <span class="keywordflow">else</span> {
00244         <span class="keywordflow">return</span> discretionaryTimePref[index];
00245     }
00246 }
00247 
00248 <span class="comment">//---------- End of function get_discretionary_time_pref -----------//</span>
00249 
00250 <span class="comment">//---------- Begin of function Faculty::init_photo -----------//</span>
00252 <span class="comment">void Faculty::init_photo() {</span>
00253     <span class="comment">//------ pick a photo for the faculty -------//</span>
00254 
00255     <a class="code" href="classDepartment.html">Department</a>* deptPtr = department_array[department_recno];
00256 
00257     <span class="comment">//---- pick a photo randomly --------//</span>
00258 
00259     <span class="keywordtype">int</span> photoId = m.random(faculty_photo_res.photo_count)+1;
00260     <span class="keywordtype">int</span> tryCount=0;
00261 
00262     <span class="keywordflow">while</span>(1) {
00263         <span class="keywordflow">if</span>( ++photoId &gt; faculty_photo_res.photo_count )
00264             photoId = 1;
00265 
00266         <span class="keywordflow">if</span>( faculty_photo_res[photoId]-&gt;gender_ethnic_group != this-&gt;gender_ethnic_group )
00267             <span class="keywordflow">continue</span>;
00268 
00269         <span class="comment">//--- scan if this photo has already been used by a faculty in this department ---//</span>
00270 
00271         <span class="keywordtype">int</span> duplicatedFlag = 0;
00272 
00273         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classDynArray.html#a28">size</a>() ; i&gt;0 ; i--) {
00274             <span class="keywordflow">if</span>( deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#a10">is_deleted</a>(i) )
00275                 <span class="keywordflow">continue</span>;
00276 
00277             <span class="keywordflow">if</span>( deptPtr-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>[i]-&gt;photo_id == photoId ) {
00278                 duplicatedFlag = 1;
00279                 <span class="keywordflow">break</span>;
00280             }
00281         }
00282 
00283         <span class="comment">//--- if this photo hasn't been used in this department, then use it for this faculty ---//</span>
00284 
00285         <span class="comment">// or if the number of faculty in this department &gt; total number of available photos</span>
00286         <span class="keywordflow">if</span>( !duplicatedFlag || tryCount &gt; faculty_photo_res.photo_count ) {
00287             photo_id = photoId;
00288             <span class="keywordflow">return</span>;
00289         }
00290 
00291         ++tryCount;
00292 
00293         <a class="code" href="ALL_8H.html#a0">err_when</a>( tryCount &gt; 1000 );
00294     }
00295 }
00296 
00297 <span class="comment">//---------- End of function Faculty::init_photo -----------//</span>
00298 
00299 <span class="comment">//---------- Begin of function Faculty::next_day -----------//</span>
<a name="l00301"></a><a class="code" href="classFaculty.html#a10">00301</a> <span class="comment">void Faculty::next_day() {</span>
00302     <span class="comment">//return;           //for interface debug //BUGHER</span>
00303 
00304     <span class="comment">// start of a trimester</span>
00305     <span class="keywordflow">if</span> ( info.game_day == player_school.trimester_array[player_school.cur_trimester].start_day
00306          &amp;&amp; info.game_month == player_school.trimester_array[player_school.cur_trimester].start_month ) {
00307         update_history(UPDATE_TRIMESTER);
00308 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00309 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( think_dismiss() )
00310             <span class="keywordflow">return</span>;
00311 <span class="preprocessor">#endif</span>
00312 <span class="preprocessor"></span>    }
00313 
00314     <span class="comment">// start of a month</span>
00315     <span class="keywordflow">if</span> ( info.game_day == 1 ) {
00316         update_history(UPDATE_MONTH);
00317 
00318         sys.yield();
00319         <span class="comment">// start of a year</span>
00320         <span class="keywordflow">if</span> ( info.game_month == finance.fiscal_year_start_month )
00321             update_history(UPDATE_YEAR);
00322     }
00323 }
00324 
00325 <span class="comment">//---------- End of function Faculty::next_day -----------//</span>
00326 
00327 <span class="comment">//---------- Begin of function Faculty::next_trimester -----------//</span>
<a name="l00329"></a><a class="code" href="classFaculty.html#a11">00329</a> <span class="comment">void Faculty::next_trimester() {</span>
00330     <span class="comment">//----- reset vars -----//</span>
00331 
00332     teaching_contact_hour = 0;                      <span class="comment">// this will be calculated in couse selection model</span>
00333 
00334     <span class="comment">//----------------------//</span>
00335 
00336     <span class="keywordflow">if</span> ( think_departure() )                        <span class="comment">// run this yearly would be OK too</span>
00337         <span class="keywordflow">return</span>;
00338 
00339     think_discretionary_time();                     <span class="comment">// before promotion</span>
00340 
00341     <span class="keywordflow">if</span> ( think_promotion() )
00342         <span class="keywordflow">return</span>;
00343 }
00344 
00345 <span class="comment">//---------- End of function Faculty::next_trimester -----------//</span>
00346 
00347 <span class="comment">//---------- Begin of function Faculty::think_departure --------//</span>
00351 <span class="comment">int Faculty::think_departure() {</span>
00352 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00353 <span class="preprocessor"></span>    <span class="comment">// faculty will retire if he is old</span>
00354     <span class="keywordflow">if</span> ( age() &gt;= 72 ) {
00355         department_array[department_recno]-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#a5">del</a>(this-&gt;faculty_recno);
00356         <span class="keywordflow">return</span> 1;
00357     }
00358 <span class="preprocessor">#endif</span>
00359 <span class="preprocessor"></span>
00360     <span class="keywordtype">float</span> multiplier = 1-(satisfaction_index-50)/100.0f;
00361     <span class="keywordtype">float</span> multiplierLast = 1-(satisfaction_index_last-50)/100.0f;
00362 
00363     <span class="comment">// var 16</span>
00364     multiplier = player_school.latency_func(0.25f, multiplierLast, multiplier);
00365 
00366     <span class="comment">// departure prob</span>
00367     <span class="keywordtype">int</span> departmentId = department_array[department_recno]-&gt;<a class="code" href="classGeneralDepartment.html#m2">department_id</a>;
00368     <span class="keywordtype">float</span> departProb = department_res[departmentId]-&gt;faculty_departure_probability[rank_level][department_res.get_prob_school_type()];
00369 
00370 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00371 <span class="preprocessor"></span>    <span class="comment">// * 0.1: added on 0107 *1.25: added on 1503</span>
00372     <span class="keywordflow">if</span> ( math.get_random_float() &gt; multiplier * departProb *1.25 * 0.1)
00373         <span class="keywordflow">return</span> 0;
00374 <span class="preprocessor">#else</span>
00375 <span class="preprocessor"></span>    <span class="comment">// * 0.1: added on 0107</span>
00376     <span class="keywordflow">if</span> ( math.get_random_float() &gt; multiplier * departProb * 0.1)
00377         <span class="keywordflow">return</span> 0;
00378 <span class="preprocessor">#endif</span>
00379 <span class="preprocessor"></span>
00380     <span class="comment">//----- remove the faculty from faculty_array -----//</span>
00381     <span class="comment">//return 0;         //BUGHER</span>
00382 
00383     department_array[department_recno]-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#a5">del</a>(this-&gt;faculty_recno);
00384 
00385     <span class="keywordflow">return</span> 1;
00386 }
00387 
00388 <span class="comment">//---------- End of function Faculty::think_departure -----------//</span>
00389 
00390 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00391 <span class="preprocessor"></span><span class="comment">//---------- Begin of function Faculty::think_dismiss --------//</span>
00395 <span class="comment">int Faculty::think_dismiss() {</span>
00396     <span class="keywordflow">if</span> ( is_dismissed ) {                           <span class="comment">// check if this faculty is dismissed</span>
00397         <span class="keywordflow">if</span> ( dismiss_trimester == 1 ) {
00398             department_array[department_recno]-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#a5">del</a>(this-&gt;faculty_recno);
00399 
00400             <span class="keywordflow">return</span> 1;
00401         }
00402         <span class="keywordflow">else</span>
00403             dismiss_trimester--;
00404     }
00405 
00406     <span class="keywordflow">return</span> 0;
00407 }
00408 
00409 <span class="comment">//---------- End of function Faculty::think_dismiss -----------//</span>
00410 <span class="preprocessor">#endif</span>
00411 <span class="preprocessor"></span>
00412 <span class="comment">//---------- Begin of function Faculty::think_promotion -----------//</span>
00414 <span class="comment">int Faculty::think_promotion() {</span>
00415     <span class="comment">// var 17 in response func</span>
00416     <span class="comment">// Multiplies the promotion probabilities given in Faculaty_TransProbs of HE.GDB.init.</span>
00417 
00418     <span class="keywordtype">float</span> prob;
00419     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a> *deptInfo = department_res[department_array[department_recno]-&gt;<a class="code" href="classGeneralDepartment.html#m2">department_id</a>];
00420 
00421     <span class="keywordflow">if</span> ( rank_level == <a class="code" href="Ofaculty_8h.html#a27a10">ASSOC_PROF</a> &amp;&amp; age() &gt;= 41 )
00422         prob = deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m32">associate_professor_promotion_probability</a>[department_res.get_prob_school_type()];
00423     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( rank_level == <a class="code" href="Ofaculty_8h.html#a27a9">ASST_PROF</a> )
00424         prob = deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m33">assistant_professor_promotion_probability</a>[department_res.get_prob_school_type()];
00425     <span class="keywordflow">else</span>
00426         <span class="keywordflow">return</span> 0;
00427 
00428   <span class="comment">//--------------//</span>
00429 
00430   <span class="comment">// Enlight: don't do the amendment below as the has been programmed already.</span>
00431   <span class="comment">// May also be used in place of paragraphs 5 and 6 of Section 3.3 of Td_3.5. (It</span>
00432   <span class="comment">// accomplishes the same thing.) If so used, paragraph 5 is deleted and paragraph 6 becomes:</span>
00433   <span class="comment">// Overall merit adjustment = base increase * merit priority * this multiplier</span>
00434 
00435   <span class="comment">// The weight formulas are given in the "Implied institutional performance ratings"</span>
00436   <span class="comment">// column on the Faculty_Incentives sheet.</span>
00437   <span class="comment">// Transform the weighted average to the multiplier as follows:</span>
00438   <span class="comment">// multiplier = 1+(wgtdAve-50)/100</span>
00439 
00440     <a class="code" href="classDepartment.html">Department</a>* deptPtr = department_array[department_recno];
00441 
00442     <span class="keywordtype">float</span> multiplier = 1, sum = 0;
00443     <span class="keywordtype">float</span> weight[3];
00444     <span class="keywordtype">float</span> myTalent[3] = { talent_teaching, talent_scholarship, talent_research };
00445 
00446     weight[0] = (deptPtr-&gt;<a class="code" href="classDepartment.html#m10">priority_discretionary_hour_array</a>[0]+deptPtr-&gt;<a class="code" href="classDepartment.html#m10">priority_discretionary_hour_array</a>[1]+deptPtr-&gt;<a class="code" href="classDepartment.html#m10">priority_discretionary_hour_array</a>[2]) / 3.0f;
00447     weight[1] = deptPtr-&gt;<a class="code" href="classDepartment.html#m10">priority_discretionary_hour_array</a>[<a class="code" href="Ofaculty_8h.html#a29a19">DT_SCHOLARSHIP</a>];
00448     weight[2] = deptPtr-&gt;<a class="code" href="classDepartment.html#m10">priority_discretionary_hour_array</a>[<a class="code" href="Ofaculty_8h.html#a29a18">DT_RESEARCH</a>];
00449 
00450     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;3; i++)
00451         sum += weight[i];
00452 
00453     <span class="keywordflow">for</span> (i=0; i&lt;3; i++)
00454         weight[i] = math.safe_divide( weight[i], sum );
00455     <span class="comment">//          weight[i] /= sum;</span>
00456 
00457     <span class="keywordflow">for</span> (i=0, sum=0; i&lt;3; i++)
00458         sum += weight[i] * myTalent[i];
00459 
00460     multiplier = 1+(sum-50.0f)/100;
00461 
00462     <span class="comment">//--------------//</span>
00463 
00464     <span class="keywordflow">if</span> ( rank_level == <a class="code" href="Ofaculty_8h.html#a27a9">ASST_PROF</a> ) {
00465         <span class="keyword">const</span> <span class="keywordtype">int</span> remap[<a class="code" href="Gamedef_8h.html#a73a25">INPUT_OPTION_COUNT</a>] = { 25, 50, 74 };
00466 
00467         multiplier *= 1-(remap[player_school.faculty_promotion_difficulity]-50)/100.0f;
00468         <span class="comment">//## chea 201099</span>
00469         <span class="comment">//              multiplier = math.single_response_func(0.6f, 1.4f, 100.0f, 50.0f, multiplier);  // var 18</span>
00470         <span class="comment">// var 18</span>
00471         multiplier = math.single_response_func(0.1f, 1.9f, 100.0f, 50.0f, multiplier);
00472     }
00473 
00474     <span class="keywordflow">if</span> ( math.get_random_float() &gt; multiplier * prob )
00475         <span class="keywordflow">return</span> 0;
00476 
00477     rank_level++;
00478 
00479 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00480 <span class="preprocessor"></span>    <span class="comment">// update display_faculty_array &amp;&amp; display_faculty_count in department</span>
00481 
00482     <a class="code" href="classFaculty.html">Faculty</a>* orgPtr = <span class="keyword">this</span>;
00483 
00484     deptPtr-&gt;cur_faculty_array.linkin(orgPtr);
00485 
00486     <span class="keywordtype">int</span> arraySize = deptPtr-&gt;cur_faculty_array.size();
00487 
00488     <a class="code" href="classFaculty.html">Faculty</a>* facPtr = (<a class="code" href="classFaculty.html">Faculty</a>*) deptPtr-&gt;cur_faculty_array.get(arraySize);
00489 
00490     facPtr-&gt;employ_status = 2;                      <span class="comment">// Promotion</span>
00491 <span class="preprocessor">#endif</span>
00492 <span class="preprocessor"></span>
00493     <span class="keywordflow">return</span> 1;
00494 }
00495 
00496 <span class="comment">//---------- End of function Faculty::think_promotion -----------//</span>
00497 
00498 <span class="comment">//---------- Begin of function Faculty::think_accept_retire --------//</span>
<a name="l00502"></a><a class="code" href="classFaculty.html#a21">00502</a> <span class="comment">int Faculty::think_accept_retire(int retireOffer) {</span>
00503     <span class="keyword">const</span> <span class="keywordtype">int</span> VAR_COUNT = 2;
00504     <span class="keywordtype">float</span> input[VAR_COUNT];
00505 
00506     <a class="code" href="ALL_8H.html#a0">err_when</a>(retireOffer&lt;0);
00507 
00508 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00509 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( rank_level == <a class="code" href="Ofaculty_8h.html#a27a12">LONG_TERM_ADJUNCT</a>  )
00510         input[0] = float(retireOffer) / salary;
00511     <span class="keywordflow">else</span>
00512         input[0] = float(retireOffer) / salary * 0.5;
00513 <span class="preprocessor">#else</span>
00514 <span class="preprocessor"></span>    input[0] = float(retireOffer) / salary;
00515 <span class="preprocessor">#endif</span>
00516 <span class="preprocessor"></span>
00517     input[1] = float(100 - satisfaction_index) / 100;
00518 
00519     <span class="comment">//-------------//</span>
00520     input[0] = math.dual_response_func(0, 0.340f, 1.000f, 0.668f, 3.015f, 0.505f, 2.476f, input[0]);
00521 
00522     <span class="keywordtype">float</span> prob = 0;
00523     <span class="keywordtype">float</span> weight[VAR_COUNT] = { 0.5f, 0.5f };
00524 
00525     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;VAR_COUNT; i++)
00526         prob += weight[i] * input[i];
00527 
00528     <span class="comment">//-------------//</span>
00529 
00530     <span class="keywordflow">if</span> ( math.get_random_float() &gt; prob )
00531         <span class="keywordflow">return</span> 0;
00532 
00533     department_array[department_recno]-&gt;<a class="code" href="classDepartment.html#m0">faculty_array</a>.<a class="code" href="classFacultyArray.html#a5">del</a>(faculty_recno);
00534 
00535     <span class="keywordflow">return</span> 1;
00536 }
00537 
00538 <span class="comment">//---------- End of function Faculty::think_accept_retire -----------//</span>
00539 
00540 <span class="comment">//---------- Begin of function Faculty::think_discretionary_time -----------//</span>
00542 <span class="comment">void Faculty::think_discretionary_time() {</span>
00543     <span class="keywordtype">int</span> i;
00544 
00545     <span class="keywordtype">float</span> researchdisTimeOffset;                    <span class="comment">// 0-100</span>
00546 
00547     <span class="comment">// "Faculty incentive" worksheet in response func   // 1116</span>
00548 
00549     <a class="code" href="classDepartment.html">Department</a>* deptPtr = department_array[department_recno];
00550     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a>* deptInfo = department_res[deptPtr-&gt;<a class="code" href="classGeneralDepartment.html#m2">department_id</a>];
00551     <a class="code" href="structFacultyTemplate.html">FacultyTemplate</a>* templ = faculty_res.get_faculty_template(deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m22">template_discretionary_time</a>, rank_age_group() );
00552 
00553     researchdisTimeOffset = math.safe_divide(research_month_expense_direct, deptPtr-&gt;<a class="code" href="classDepartment.html#m7">research_dollar_norm</a>);
00554     researchdisTimeOffset = math.dual_response_func(0,10.09f, 20, 0.802f, 0.690f, 0.403f, 2.189f, researchdisTimeOffset);
00555 
00556     <a class="code" href="ALL_8H.html#a0">err_when</a>(researchdisTimeOffset &lt; 0);
00557 
00558     <span class="comment">// 99-&gt;99%</span>
00559     <span class="keywordtype">float</span> adjustedBaseDisTime[<a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a>];
00560 
00561     <span class="keywordflow">for</span> ( i=0; i &lt; <a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a>; i++ )
00562         adjustedBaseDisTime[i] = (float) get_discretionary_time_pref( templ-&gt;<a class="code" href="structFacultyTemplate.html#m12">discretionary_time_pref</a>, i);
00563 
00564     <span class="keywordtype">float</span> base = 1 + (researchdisTimeOffset/100.0f) * (1.0f-adjustedBaseDisTime[<a class="code" href="Ofaculty_8h.html#a29a18">DT_RESEARCH</a>]/100);
00565 
00566     <a class="code" href="ALL_8H.html#a0">err_when</a>(base == 0);
00567 
00568     <span class="keywordflow">for</span> ( i=0; i &lt; <a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a>; i++ )
00569         adjustedBaseDisTime[i] /= base;
00570 
00571     adjustedBaseDisTime[<a class="code" href="Ofaculty_8h.html#a29a18">DT_RESEARCH</a>] += (researchdisTimeOffset/100.0f) * (1.0f-adjustedBaseDisTime[<a class="code" href="Ofaculty_8h.html#a29a18">DT_RESEARCH</a>]/100) * 100.0f / base;
00572 
00573     <span class="comment">//----------------//</span>
00574     <span class="comment">/*</span>
00575 <span class="comment">      float total = 0;</span>
00576 <span class="comment"></span>
00577 <span class="comment">      for ( i=0; i &lt; DISCRETIONARY_TYPE_COUNT; i++ )</span>
00578 <span class="comment">      total += adjustedBaseDisTime[i];</span>
00579 <span class="comment"></span>
00580 <span class="comment">      err_when(total &lt; 96 || total &gt; 104);</span>
00581 <span class="comment">    */</span>
00582     <span class="comment">//----------------//  // column F-G</span>
00583 
00584     <span class="comment">//----//</span>
00585     <span class="comment">// 0129 scenario(4): rescale templ-&gt;discretionary_time_pref[]</span>
00586 
00587     <span class="comment">//----//</span>
00588 
00589     <span class="comment">// 99-&gt;99%</span>
00590     <span class="keywordtype">float</span> normalizedRawTimePercent[<a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a>];
00591 
00592     <span class="keyword">const</span> <span class="keywordtype">int</span> remap[<a class="code" href="Gamedef_8h.html#a73a25">INPUT_OPTION_COUNT</a>] = {25,50,75};
00593     <span class="keywordtype">int</span> ratio = remap[player_school.faculty_degree_to_which_priorities_reflected_in_promotion];
00594 
00595     i = <a class="code" href="Ofaculty_8h.html#a29a15">DT_COURSE_PREPARATION</a>;
00596     normalizedRawTimePercent[i] = (ratio*deptPtr-&gt;<a class="code" href="classDepartment.html#m13">relative_priority_discretionary_hour_array</a>[i] / 100.0f
00597                                    + talent_teaching * get_discretionary_time_pref( templ-&gt;<a class="code" href="structFacultyTemplate.html#m12">discretionary_time_pref</a>, i) / 100.0f) ;
00598 
00599     i = <a class="code" href="Ofaculty_8h.html#a29a16">DT_OUT_OF_CLASS_STUDENT_CONTACT</a>;
00600     normalizedRawTimePercent[i] = (ratio*deptPtr-&gt;<a class="code" href="classDepartment.html#m13">relative_priority_discretionary_hour_array</a>[i] / 100.0f
00601                                    + talent_teaching * get_discretionary_time_pref( templ-&gt;<a class="code" href="structFacultyTemplate.html#m12">discretionary_time_pref</a>,i) / 100.0f) ;
00602 
00603     i = <a class="code" href="Ofaculty_8h.html#a29a17">DT_EDUCATIONAL_DEVELOPMENT</a>;
00604     normalizedRawTimePercent[i] = (ratio*deptPtr-&gt;<a class="code" href="classDepartment.html#m13">relative_priority_discretionary_hour_array</a>[i] / 100.0f
00605                                    + (talent_teaching + talent_scholarship) * get_discretionary_time_pref( templ-&gt;<a class="code" href="structFacultyTemplate.html#m12">discretionary_time_pref</a>,i) / 200.0f) ;
00606 
00607     i = <a class="code" href="Ofaculty_8h.html#a29a18">DT_RESEARCH</a>;
00608     normalizedRawTimePercent[i] = (ratio*deptPtr-&gt;<a class="code" href="classDepartment.html#m13">relative_priority_discretionary_hour_array</a>[i] / 100.0f
00609                                    + talent_research * adjustedBaseDisTime[i] / 100.0f) ;
00610 
00611     i = <a class="code" href="Ofaculty_8h.html#a29a19">DT_SCHOLARSHIP</a>;
00612     normalizedRawTimePercent[i] = (ratio*deptPtr-&gt;<a class="code" href="classDepartment.html#m13">relative_priority_discretionary_hour_array</a>[i] / 100.0f
00613                                    + talent_scholarship * get_discretionary_time_pref( templ-&gt;<a class="code" href="structFacultyTemplate.html#m12">discretionary_time_pref</a>,i) / 100.0f);
00614 
00615     i = <a class="code" href="Ofaculty_8h.html#a29a20">DT_INSTITUTIONAL_AND_PUBLIC_SERVICE</a>;
00616     normalizedRawTimePercent[i] = (ratio*deptPtr-&gt;<a class="code" href="classDepartment.html#m13">relative_priority_discretionary_hour_array</a>[i] / 100.0f
00617                                    + 50 * get_discretionary_time_pref( templ-&gt;<a class="code" href="structFacultyTemplate.html#m12">discretionary_time_pref</a>, i) / 100.0f) ;
00618 
00619     <span class="keywordtype">float</span> total;
00620 
00621     <span class="keywordflow">for</span> ( total=0, i=0; i &lt; <a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a>; i++ )
00622         total += normalizedRawTimePercent[i];
00623 
00624     <a class="code" href="ALL_8H.html#a0">err_when</a>(total &lt; 0);
00625 
00626     <span class="keywordflow">for</span> ( i=0; i &lt; <a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a>; i++ )
00627         normalizedRawTimePercent[i] *= 100.0f / total;
00628 
00629     <span class="comment">//----------------//        // column H</span>
00630 
00631     <span class="keywordtype">float</span> priorPercent[<a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a>];
00632 
00633     <span class="keywordflow">for</span> ( total=0, i=0; i &lt; <a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a>; i++ ) {
00634         priorPercent[i] = this-&gt;discretionary_hour_array[i];
00635         total += priorPercent[i];
00636     }
00637 
00638     <a class="code" href="ALL_8H.html#a0">err_when</a>(total &lt; 0);
00639 
00640     <span class="keywordflow">if</span> ( total &gt; 0 )
00641         <span class="keywordflow">for</span> ( i=0; i &lt; <a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a>; i++ )
00642             priorPercent[i] *= 100.0f / total;
00643 
00644     <span class="comment">//----------------//        // column I</span>
00645 
00646     <span class="keywordtype">float</span> checkSum = 0, checkSum2;
00647 
00648     <span class="keywordflow">for</span> ( i=0; i &lt; <a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a>; i++ ) {
00649         priorPercent[i] = player_school.latency_func(0.67f, normalizedRawTimePercent[i], priorPercent[i]);
00650 
00651 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00652 <span class="preprocessor"></span>        <span class="comment">// fix in version 2, long and short term adjunct don't do research and scholarship</span>
00653         <span class="keywordflow">if</span>( (rank_level == <a class="code" href="Ofaculty_8h.html#a27a12">LONG_TERM_ADJUNCT</a> || rank_level == <a class="code" href="Ofaculty_8h.html#a27a13">SHORT_TERM_ADJUNCT</a>)
00654             &amp;&amp; (i == <a class="code" href="Ofaculty_8h.html#a29a18">DT_RESEARCH</a> || i == <a class="code" href="Ofaculty_8h.html#a29a19">DT_SCHOLARSHIP</a>) )
00655             priorPercent[i] = 0.0f;
00656 <span class="preprocessor">#endif</span>
00657 <span class="preprocessor"></span>
00658         checkSum += priorPercent[i];
00659     }
00660 
00661     <a class="code" href="ALL_8H.html#a0">err_when</a>( checkSum &lt;=0);
00662 
00663     <span class="keywordflow">for</span> ( i=0; i &lt; <a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a>; i++ ) {
00664         priorPercent[i] *= 100 / checkSum;
00665     }
00666     <span class="comment">/*</span>
00667 <span class="comment">      int check_rank_level=0;</span>
00668 <span class="comment">      check_rank_level = this-&gt;rank_level;</span>
00669 <span class="comment"></span>
00670 <span class="comment">      for ( i=0; i &lt; DISCRETIONARY_TYPE_COUNT; i++ )</span>
00671 <span class="comment">      {</span>
00672 <span class="comment">      if(check_rank_level ==3 || check_rank_level ==4)</span>
00673 <span class="comment">      priorPercent[check_rank_level] = 0.0f;</span>
00674 <span class="comment">      else</span>
00675 <span class="comment">      priorPercent[i] *= 100 / checkSum;</span>
00676 <span class="comment">      }</span>
00677 <span class="comment">    */</span>
00678     <span class="comment">//----------------//</span>
00679 
00680     checkSum = 0; checkSum2 = 0;
00681 
00682     <span class="keywordtype">int</span> check_rank_level=0;
00683 
00684     check_rank_level = this-&gt;rank_level;            <span class="comment">//## chea 221099</span>
00685 
00686     <span class="keywordflow">for</span> ( i=0; i &lt; <a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a>; i++ ) {
00687 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00688 <span class="preprocessor"></span>        <span class="comment">// 0108:  + 0.5</span>
00689         this-&gt;discretionary_hour_array[i] = (float)(total * priorPercent[i] / 100);
00690 <span class="preprocessor">#else</span>
00691 <span class="preprocessor"></span>        <span class="comment">//## chea 221099</span>
00692         <span class="keywordflow">if</span>(check_rank_level ==3 || check_rank_level ==4)
00693             <span class="comment">//## chea 221099</span>
00694             this-&gt;discretionary_hour_array[check_rank_level] = 0;
00695         <span class="keywordflow">else</span>                                          <span class="comment">//## chea 221099</span>
00696             <span class="comment">// 0108:  + 0.5</span>
00697             this-&gt;discretionary_hour_array[i] = char(total * priorPercent[i] / 100 + 0.5);
00698 <span class="preprocessor">#endif</span>
00699 <span class="preprocessor"></span>
00700         checkSum += priorPercent[i];
00701         checkSum2 += discretionary_hour_array[i];
00702     }
00703 
00704     <a class="code" href="ALL_8H.html#a0">err_when</a>(total&lt;=0 || checkSum &lt; 90 || checkSum &gt; 105);
00705     <a class="code" href="ALL_8H.html#a0">err_when</a>(checkSum2 &lt;=0);
00706 
00707     <span class="comment">//----------------//</span>
00708 
00709     <span class="keywordtype">float</span> strainPriority=0;
00710 
00711     base = 3*talent_teaching+talent_research+talent_scholarship+50;
00712 
00713     <span class="keywordflow">for</span> ( total=0, i=0; i &lt; <a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a>; i++ ) {
00714         total += 100 * talent_teaching * math.safe_pow((priorPercent[i] - adjustedBaseDisTime[i])/100.0f, 2) / base;
00715 
00716         <span class="comment">// * 10: since input is  [0,10]</span>
00717         strainPriority += math.safe_pow((deptPtr-&gt;<a class="code" href="classDepartment.html#m10">priority_discretionary_hour_array</a>[i] - deptPtr-&gt;<a class="code" href="classDepartment.html#m11">last_priority_discretionary_hour_array</a>[i]) * 10.0f, 2) / 100.0f;
00718     }
00719 
00720     <span class="comment">//----------------//</span>
00721 
00722     <span class="comment">// char pressure_to_change_teaching_load;           // =[-50,50]</span>
00723     <span class="keywordtype">float</span> strainValue = 5 - deptPtr-&gt;<a class="code" href="classDepartment.html#m12">pressure_to_change_teaching_load</a> / 10.0f;
00724 
00725     strain_priority = player_school.latency_func(0.5f, strain_priority, strainPriority);
00726 
00727     <span class="keyword">const</span> <span class="keywordtype">float</span> weight[2] = {0.4f, 0.35f};
00728 
00729     strain_on_discretionary_time =  weight[0]* total + weight[1] * strainValue + (1-weight[0]-weight[1]) * strain_priority;
00730 
00731     <span class="comment">//----------------//</span>
00732 
00733     <span class="keywordflow">for</span> ( total=0, i=0; i &lt; <a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a>; i++ ) {
00734         <span class="comment">//## 990609 BUGHERE each faculty in this department will run this and hence is WRONG!</span>
00735         deptPtr-&gt;<a class="code" href="classDepartment.html#m11">last_priority_discretionary_hour_array</a>[i] = deptPtr-&gt;<a class="code" href="classDepartment.html#m10">priority_discretionary_hour_array</a>[i];
00736     }
00737 
00738     memcpy(last_discretionary_hour_array, discretionary_hour_array, <span class="keyword">sizeof</span>(last_discretionary_hour_array));
00739 }
00740 
00741 <span class="comment">//---------- End of function Faculty::think_discretionary_time -----------//</span>
00742 
00743 <span class="comment">//---------- Begin of function Faculty::think_research -----------//</span>
00747 <span class="comment">void Faculty::think_research() {</span>
00748 
00749     <span class="comment">// 990604</span>
00750     <span class="keywordflow">if</span> ( player_school.sponsored_research_intensity &lt;= 0 ) {
00751 
00752         <a class="code" href="ALL_8H.html#a0">err_when</a>(research_proposal_count&gt;0);          <span class="comment">//5.1.4</span>
00753         <span class="keywordflow">return</span>;
00754     }
00755 
00756     <span class="keywordtype">int</span> i;
00757 
00758     <span class="comment">//------------------------//</span>
00759     <span class="keywordflow">if</span> ( rank_level == <a class="code" href="Ofaculty_8h.html#a27a12">LONG_TERM_ADJUNCT</a> || rank_level == <a class="code" href="Ofaculty_8h.html#a27a13">SHORT_TERM_ADJUNCT</a> || ave_proj_size &lt;=0 )
00760         <span class="keywordflow">return</span>;
00761 
00762     <span class="comment">//------------------------//</span>
00763 
00764     <span class="comment">// 990414</span>
00765 
00766     <span class="keywordtype">float</span> oRate = finance.get_research_overhead_rate() / 100.0f;
00767     <span class="keywordtype">float</span> qualityDriver = this-&gt;get_quality_driver();
00768     <span class="comment">//  this-&gt;award_prob =</span>
00769     <span class="comment">//## 251099</span>
00770     <span class="comment">//          float (0.01 + 0.005 * math.dual_response_func(1,50,100,29,33,20,76, qualityDriver) * math.safe_pow(1.0f+oRate, -1.5f) );</span>
00771     <span class="comment">//          float (0.01 + 0.5 * math.dual_response_func(1,50,100,29,33,20,76, qualityDriver)/100 * math.safe_pow(1.0f+oRate, -1.5f) );</span>
00772 
00773     <span class="comment">//## chea 041199 new request</span>
00774     <span class="comment">//## chea 191199</span>
00775     this-&gt;proj_count_mult = (0.8f + 0.4f * this-&gt;talent_research/100);
00776     this-&gt;proj_size_mult = (0.7f + 0.6f * this-&gt;talent_research/100);
00777 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00778 <span class="preprocessor"></span>    <span class="comment">// this-&gt;award_prob = (float)(0.01f + 0.5 * this-&gt;talent_research/100);</span>
00779     <span class="comment">// change in 18/03/2002</span>
00780     <span class="keywordtype">float</span> awardProb = 2.0f * (qualityDriver * 0.01f) / math.safe_pow( (1.0f + oRate), 3.0f );
00781     this-&gt;award_prob = m.fmin( 0.85f, m.fmax(0.10f, awardProb) );
00782 <span class="preprocessor">#else</span>
00783 <span class="preprocessor"></span>    this-&gt;award_prob = (float)(0.01f + 0.9 * this-&gt;talent_research/100);
00784 <span class="preprocessor">#endif</span>
00785 <span class="preprocessor"></span>
00786     <span class="comment">//  if(this-&gt;talent_research &lt;= 20)</span>
00787     <span class="comment">//          this-&gt;award_prob = 0.0f;</span>
00788     <span class="comment">//  else if(this-&gt;talent_research &lt;= 40)</span>
00789     <span class="comment">//          this-&gt;award_prob = 0.05f;</span>
00790     <span class="comment">//  else if(this-&gt;talent_research &lt;= 60)</span>
00791     <span class="comment">//          this-&gt;award_prob = 0.10f;</span>
00792     <span class="comment">//  else if(this-&gt;talent_research &lt;= 80)</span>
00793     <span class="comment">//          this-&gt;award_prob = 0.15f;</span>
00794     <span class="comment">//  else</span>
00795     <span class="comment">//          this-&gt;award_prob = (this-&gt;talent_research/100);</span>
00796 
00797     <span class="comment">//------------------------//</span>
00798 
00799     <a class="code" href="classDepartment.html">Department</a>* deptPtr = department_array[department_recno];
00800     <a class="code" href="structDepartmentInfo.html">DepartmentInfo</a>* deptInfo = department_res[deptPtr-&gt;<a class="code" href="classGeneralDepartment.html#m2">department_id</a>];
00801     <a class="code" href="structFacultyTemplate.html">FacultyTemplate</a>* templ = faculty_res.get_faculty_template(deptInfo-&gt;<a class="code" href="structDepartmentInfo.html#m22">template_discretionary_time</a>, rank_age_group() );
00802     <a class="code" href="classPeerSchool.html">PeerSchool</a> *playerSchool = school_res.player_peer_school;
00803 
00804     <span class="comment">//------------------------//</span>
00805 
00806     <span class="keywordflow">for</span> (i=0; i&lt;research_proposal_count; i++) {
00807         <a class="code" href="structResearchProposal.html">ResearchProposal</a>* researchProposal = research_proposal_array+i;
00808 
00809         <span class="keywordflow">if</span> ( researchProposal-&gt;<a class="code" href="structResearchProposal.html#m2">status</a> == <a class="code" href="Ofaculty_8h.html#a31a24">RESEARCH_PROPOSED</a> ) {
00810             <span class="comment">// 990412 if ( math.get_random_float() &lt; researchProposal-&gt;prob_proposal_funded )</span>
00811             <span class="keywordflow">if</span> ( math.get_random_float() &lt; award_prob ) {
00812                 <span class="comment">// accepted</span>
00813                 researchProposal-&gt;<a class="code" href="structResearchProposal.html#m2">status</a> = <a class="code" href="Ofaculty_8h.html#a31a25">RESEARCH_ACTIVE</a>;
00814 
00815                 <span class="comment">//                              info.debug_enroll++;</span>
00816 
00817                 <span class="comment">//                              researchProposal-&gt;date_to_next_status = info.game_date + (4 + m.random(MAX_ACTIVE_RESEARCH_MONTH-3)) * 30;              // draw a random number from 4 to 12 months</span>
00818                 <span class="comment">//## chea 221199 make the act pro.month=12</span>
00819                 <span class="comment">//                              researchProposal-&gt;date_to_next_status = info.game_date + (m.random(7)) * 30;            //## chea 240899 draw a random number from 0 to 6 months</span>
00820                 <span class="comment">//## chea 240899 draw a random number from 0 to 6 months</span>
00821                 researchProposal-&gt;<a class="code" href="structResearchProposal.html#m3">date_to_next_status</a> = info.game_date + (1+m.random(12)) * 30;
00822                 <span class="comment">//                              researchProposal-&gt;date_to_next_status = info.game_date + (4 + m.random(MAX_ACTIVE_RESEARCH_MONTH-3)) * 30;              //## chea 240899 draw a random number from 0 to 6 months</span>
00823                 <span class="comment">//                              researchProposal-&gt;date_to_next_status = info.game_date + (1) * 30;              //## chea 251099 test</span>
00824 
00825                 <span class="comment">//## chea 151199 try my cal. method 1.4.1</span>
00826                 research_month_expense += researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a>;
00827                 research_month_expense_direct += int((researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a> ) / ( 1+researchProposal-&gt;<a class="code" href="structResearchProposal.html#m1">overhead_rate</a>));
00828 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00829 <span class="preprocessor"></span>                deptPtr-&gt;<a class="code" href="classDepartment.html#m66">research_m_history</a>[<a class="code" href="Odept_8h.html#a19a15">R_ACCEPT</a>][THIS_MONTH] += (float)researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / (<a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a> * 1000);
00830 <span class="preprocessor">#else</span>
00831 <span class="preprocessor"></span>                <span class="comment">//##begin zhoubin 000404</span>
00832                 <span class="comment">/*</span>
00833 <span class="comment">                  deptPtr-&gt;research_m_history[R_ACCEPT][THIS_MONTH] += (researchProposal-&gt;total_dollars / MAX_ACTIVE_RESEARCH_MONTH);</span>
00834 <span class="comment">                  //## chea 221199</span>
00835 <span class="comment">                  deptPtr-&gt;research_m_history[R_ACCEPT][THIS_MONTH] /= 1000;</span>
00836 <span class="comment">                */</span>
00837                 deptPtr-&gt;<a class="code" href="classDepartment.html#m66">research_m_history</a>[<a class="code" href="Odept_8h.html#a19a15">R_ACCEPT</a>][THIS_MONTH] += (researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a> / 1000);
00838                 <span class="comment">//##end zhoubin 000404</span>
00839 <span class="preprocessor">#endif</span>
00840 <span class="preprocessor"></span>            }
00841         }
00842         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( researchProposal-&gt;<a class="code" href="structResearchProposal.html#m2">status</a> == <a class="code" href="Ofaculty_8h.html#a31a25">RESEARCH_ACTIVE</a> ) {
00843         }
00844         <span class="keywordflow">else</span>
00845             <a class="code" href="ALL_8H.html#a1">err_here</a>();
00846 
00847         <span class="comment">//## chea 081199 old alg.BEGIN here this has not consider the prerun year I will -1 year in oinfo.cpp</span>
00848         <span class="comment">// depends on game_date  //## chea 031199</span>
00849         <span class="keywordflow">if</span> ( info.game_date &gt;= researchProposal-&gt;<a class="code" href="structResearchProposal.html#m3">date_to_next_status</a>) {
00850             <span class="comment">// expired: proposal rejected or research finished</span>
00851             <span class="keywordflow">if</span> ( researchProposal-&gt;<a class="code" href="structResearchProposal.html#m2">status</a> == <a class="code" href="Ofaculty_8h.html#a31a24">RESEARCH_PROPOSED</a> ) {
00852 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00853 <span class="preprocessor"></span>                deptPtr-&gt;<a class="code" href="classDepartment.html#m66">research_m_history</a>[<a class="code" href="Odept_8h.html#a19a14">R_REJECT</a>][THIS_MONTH] += (float)researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / (<a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a> * 1000);
00854 <span class="preprocessor">#else</span>
00855 <span class="preprocessor"></span>                <span class="comment">//##begin zhoubin 000404</span>
00856                 <span class="comment">/*</span>
00857 <span class="comment">                  deptPtr-&gt;research_m_history[R_REJECT][THIS_MONTH] += (researchProposal-&gt;total_dollars / MAX_ACTIVE_RESEARCH_MONTH);</span>
00858 <span class="comment">                  //## chea 221199</span>
00859 <span class="comment">                  deptPtr-&gt;research_m_history[R_REJECT][THIS_MONTH] /= 1000;</span>
00860 <span class="comment">                */</span>
00861                 deptPtr-&gt;<a class="code" href="classDepartment.html#m66">research_m_history</a>[<a class="code" href="Odept_8h.html#a19a14">R_REJECT</a>][THIS_MONTH] += (researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a> / 1000);
00862                 <span class="comment">//##end zhoubin 000404</span>
00863 <span class="preprocessor">#endif</span>
00864 <span class="preprocessor"></span>            }
00865             <span class="comment">// fix in version 2</span>
00866             <span class="comment">// else if ( researchProposal-&gt;status = RESEARCH_ACTIVE )</span>
00867             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( researchProposal-&gt;<a class="code" href="structResearchProposal.html#m2">status</a> == <a class="code" href="Ofaculty_8h.html#a31a25">RESEARCH_ACTIVE</a> ) {
00868                 <span class="comment">//## chea 151199 try my cal. method 1.4.1</span>
00869                 research_month_expense -= researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a>;
00870                 research_month_expense_direct -= int((researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a> ) / ( 1+researchProposal-&gt;<a class="code" href="structResearchProposal.html#m1">overhead_rate</a>));
00871 
00872             }
00873 
00874             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=i+1; j&lt;research_proposal_count; j++) {
00875                 memcpy(research_proposal_array+j-1, research_proposal_array+j, <span class="keyword">sizeof</span>(<a class="code" href="structResearchProposal.html">ResearchProposal</a>));
00876             }
00877             research_proposal_count--;
00878             i--;
00879 
00880         }
00881         <span class="comment">//## chea 081199 old alg.END here this has not consider the prerun year</span>
00882     }
00883 
00884     <span class="comment">//------------------------//        var 24</span>
00885 
00886     <span class="comment">/*</span>
00887 <span class="comment">      = 0.001 * (% fac in dept who are PIs) +</span>
00888 <span class="comment">      Sqrt[expProjs/actProjs] +</span>
00889 <span class="comment">      Sqrt[fac's res. quality drivers/100] +</span>
00890 <span class="comment">      (faculty's research discretionary time, per week),</span>
00891 <span class="comment"></span>
00892 <span class="comment">      where</span>
00893 <span class="comment"></span>
00894 <span class="comment">      % faculty who are PIs is defined in C18;C22 of HE.GDB.init:Faculty_Initialization;</span>
00895 <span class="comment">      actProjs = number of active proposals and awards for this professor</span>
00896 <span class="comment">      expProjs = expected number of projects per principal investigator in this department and age/rank category: in D18:D22 of Fac_Init.</span>
00897 <span class="comment">    */</span>
00898 
00899     <span class="comment">/*</span>
00900 <span class="comment"></span>
00901 <span class="comment">      990412</span>
00902 <span class="comment"></span>
00903 <span class="comment">      6. For each faculty sim, determine the new proposals for the month (all variables refer to the current month) :</span>
00904 <span class="comment">      prob (n, ave_proj_count/ award_prob) for n = 0 to max_n</span>
00905 <span class="comment">      Number of outstanding proposals is determined according to this probability vector (many faculty will have no proposals). Then, for each proposal:</span>
00906 <span class="comment"></span>
00907 <span class="comment">      proposal_size = ave_proj_size *random_normal_deviate(1.0, 0.12) and</span>
00908 <span class="comment">      direct = project_size/(1.0+ind_cost_rate); indirect = project_size - direct; and</span>
00909 <span class="comment">      number of months remaining = 2 + rand_int[0,4]] (as now).</span>
00910 <span class="comment"></span>
00911 <span class="comment">      (The indirect cost rate is determined once and for all when the proposal is generated.)</span>
00912 <span class="comment"></span>
00913 <span class="comment">    */</span>
00914 
00915     <span class="comment">//990412</span>
00916 
00917     <a class="code" href="classFaculty.html">Faculty</a>* facultyPtr = <span class="keyword">this</span>;
00918     <span class="keywordtype">int</span> projectCount = 0;
00919     <span class="keywordtype">float</span> prob=0;
00920 
00921     <span class="comment">//  const float forCalcProb = (facultyPtr-&gt;ave_proj_count / facultyPtr-&gt;award_prob ); //tryttt</span>
00922     <span class="comment">//  const float forCalcProb = (facultyPtr-&gt;ave_proj_count * deptInfo-&gt;percent_pi_faculty/100.0f / facultyPtr-&gt;award_prob );  //## chea 230899</span>
00923     <span class="comment">//  const float forCalcProb = (facultyPtr-&gt;proj_size_mult * facultyPtr-&gt;ave_proj_count / DCON*facultyPtr-&gt;award_prob );     //## CHEA 251099 supose had k1 in there</span>
00924     <span class="comment">//  const float forCalcProb = (facultyPtr-&gt;ave_proj_count / facultyPtr-&gt;award_prob );       //## CHEA 251099 supose had k1 in there</span>
00925 
00926 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00927 <span class="preprocessor"></span>    <span class="keywordtype">float</span> normalSpaceArea = facility_office.normal_area[HISTORY_MONTH_COUNT-1];
00928     <span class="keywordtype">float</span> actualSpaceArea = facility_office.actual_area[HISTORY_MONTH_COUNT-1];
00929     <span class="keywordtype">float</span> shortFallRatio = max(0, math.safe_divide((normalSpaceArea-actualSpaceArea),normalSpaceArea));
00930 
00931     <span class="keywordtype">float</span> forCalcProb = (facultyPtr-&gt;<a class="code" href="classFaculty.html#m41">award_prob</a>);
00932 
00933     forCalcProb *= (1-shortFallRatio/0.15);
00934 <span class="preprocessor">#else</span>
00935 <span class="preprocessor"></span>    <span class="comment">//tryttt</span>
00936     <span class="keyword">const</span> <span class="keywordtype">float</span> forCalcProb = (facultyPtr-&gt;<a class="code" href="classFaculty.html#m41">award_prob</a>);
00937 <span class="preprocessor">#endif</span>
00938 <span class="preprocessor"></span>
00939     <span class="keywordtype">float</span> randNum = math.get_random_float();
00940 
00941     <span class="keywordflow">for</span> ( i=0, prob=0; i&lt;=<a class="code" href="Ofaculty_8h.html#a5">MAX_RESEARCH_PROPOSAL</a>; i++) {
00942         prob += math.double_poisson(i, forCalcProb);
00943 
00944         <span class="keywordflow">if</span> ( randNum &lt; prob ) {
00945             projectCount = i;
00946             <span class="keywordflow">break</span>;
00947         }
00948     }
00949 
00950     <span class="comment">//----- add research proposals -----//</span>
00951 
00952     <span class="keywordflow">for</span>( ; projectCount &gt; 0 &amp;&amp; facultyPtr-&gt;<a class="code" href="classFaculty.html#m20">research_proposal_count</a> &lt; <a class="code" href="Ofaculty_8h.html#a5">MAX_RESEARCH_PROPOSAL</a>;
00953          projectCount--, facultyPtr-&gt;<a class="code" href="classFaculty.html#m20">research_proposal_count</a>++ ) {
00954         <a class="code" href="structResearchProposal.html">ResearchProposal</a>* researchProposal = facultyPtr-&gt;<a class="code" href="classFaculty.html#m18">research_proposal_array</a> + facultyPtr-&gt;<a class="code" href="classFaculty.html#m20">research_proposal_count</a>;
00955 
00956         <span class="comment">//              int tmp = (int) max(0.0f, facultyPtr-&gt;ave_proj_size * math.get_random_snd(1.0f, 0.05f)); //min &amp; max bug chea</span>
00957         <span class="comment">//              int tmp = (int) max(0.2f, facultyPtr-&gt;proj_size_mult * facultyPtr-&gt;ave_proj_size * math.get_random_snd(1.0f, 0.20f)); //## chea 251099</span>
00958         <span class="comment">//## chea 221199</span>
00959         <span class="comment">//## chea 061299 test</span>
00960         <span class="comment">//              int tmp = (int) max(0.0f, facultyPtr-&gt;ave_proj_size * 1000 * math.get_random_snd(1.0f, 0.05f)); //min &amp; max bug chea</span>
00961 
00962         <span class="comment">//## chea 021299 1.8.4</span>
00963         <span class="comment">//min &amp; max bug chea</span>
00964         <span class="keywordtype">int</span> tmp = (int) m.fmax(0.0f, facultyPtr-&gt;<a class="code" href="classFaculty.html#m40">proj_size_mult</a> * facultyPtr-&gt;<a class="code" href="classFaculty.html#m43">ave_proj_size</a> * 1000 * math.get_random_snd(1.0f, 0.10f));
00965 
00966         <span class="comment">//## chea 151199 try to make the research projet non 0</span>
00967         <span class="comment">//              if(tmp &gt;=0 &amp;&amp; tmp &lt;= 1)</span>
00968         <span class="comment">//                      tmp =1;</span>
00969 
00970         <span class="comment">//## chea 191199 1.8.3</span>
00971         <span class="comment">//              if(tmp &gt;=50)</span>
00972         <span class="comment">//                      tmp = 50;</span>
00973 
00974         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> = tmp ;
00975 
00976         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m1">overhead_rate</a> = oRate;
00977 
00978         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m2">status</a> = <a class="code" href="Ofaculty_8h.html#a31a24">RESEARCH_PROPOSED</a>;
00979 
00980         <span class="comment">//    info.debug_enroll3++;</span>
00981 
00982         <span class="comment">//## chea 221199 make the pro. month=3</span>
00983         <span class="comment">//              researchProposal-&gt;date_to_next_status = info.game_date + (2 + m.random(5) ) * 30;               // draw a random number from 2 to 6 months</span>
00984         <span class="comment">// draw a random number from 1 to 3 months</span>
00985         researchProposal-&gt;<a class="code" href="structResearchProposal.html#m3">date_to_next_status</a> = info.game_date + (1 + m.random(3) ) * 30;
00986 
00987 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00988 <span class="preprocessor"></span>        deptPtr-&gt;<a class="code" href="classDepartment.html#m66">research_m_history</a>[<a class="code" href="Odept_8h.html#a19a13">R_PROPOSAL</a>][THIS_MONTH] += (float)researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / (<a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a> * 1000);
00989 <span class="preprocessor">#else</span>
00990 <span class="preprocessor"></span>        <span class="comment">//##begin zhoubin       000404</span>
00991         <span class="comment">/*</span>
00992 <span class="comment">          deptPtr-&gt;research_m_history[R_PROPOSAL][THIS_MONTH] += (researchProposal-&gt;total_dollars / MAX_ACTIVE_RESEARCH_MONTH);</span>
00993 <span class="comment">          //## chea 221199</span>
00994 <span class="comment">          deptPtr-&gt;research_m_history[R_PROPOSAL][THIS_MONTH] /= 1000;</span>
00995 <span class="comment">        */</span>
00996         deptPtr-&gt;<a class="code" href="classDepartment.html#m66">research_m_history</a>[<a class="code" href="Odept_8h.html#a19a13">R_PROPOSAL</a>][THIS_MONTH] += (researchProposal-&gt;<a class="code" href="structResearchProposal.html#m0">total_dollars</a> / <a class="code" href="Ofaculty_8h.html#a6">MAX_ACTIVE_RESEARCH_MONTH</a> /1000);
00997         <span class="comment">//##end zhoubin 000404</span>
00998 <span class="preprocessor">#endif</span>
00999 <span class="preprocessor"></span>
01000     }
01001 
01002 }
01003 
01004 <span class="comment">//---------- End of function Faculty::think_research -----------//</span>
01005 
01006 <span class="comment">//---------- Begin of function Faculty::employed_period -----------//</span>
<a name="l01008"></a><a class="code" href="classFaculty.html#a4">01008</a> <span class="comment">char* Faculty::employed_period() {</span>
01009     <span class="keyword">static</span> <a class="code" href="classString.html">String</a> str;
01010 
01011     <span class="keywordtype">int</span> yearCount  = (info.game_date-start_teaching_date) / 365;
01012     <span class="keywordtype">int</span> monthCount = ((info.game_date-start_teaching_date) % 365) / 30;
01013 
01014     <span class="comment">//-------- number of years ----------//</span>
01015 
01016     <span class="keywordflow">if</span>( yearCount &gt; 0 ) {
01017         str = yearCount;
01018 
01019         <span class="keywordflow">if</span>( yearCount &gt; 1 )
01020             str += <span class="stringliteral">" years"</span>;
01021         <span class="keywordflow">else</span>
01022             str += <span class="stringliteral">" year"</span>;
01023     }
01024     <span class="keywordflow">else</span>
01025         str = <span class="stringliteral">""</span>;
01026 
01027     str += <span class="stringliteral">" "</span>;
01028 
01029     <span class="comment">//-------- number of months ----------//</span>
01030 
01031     <span class="keywordflow">if</span>( monthCount &gt; 0 ) {
01032         str += monthCount;
01033 
01034         <span class="keywordflow">if</span>( monthCount &gt; 1 )
01035             str += <span class="stringliteral">" months"</span>;
01036         <span class="keywordflow">else</span>
01037             str += <span class="stringliteral">" month"</span>;
01038     }
01039 
01040     <span class="keywordflow">return</span> str;
01041 }
01042 
01043 <span class="comment">//---------- End of function Faculty::employed_period -----------//</span>
01044 
01045 <span class="comment">//---------- Begin of function Faculty::total_hour -----------//</span>
<a name="l01047"></a><a class="code" href="classFaculty.html#a5">01047</a> <span class="comment">float Faculty::total_hour() {</span>
01048     <span class="keywordtype">float</span> totalHour=teaching_contact_hour;
01049 
01050     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;<a class="code" href="Ofaculty_8h.html#a28a14">DISCRETIONARY_TYPE_COUNT</a> ; i++ )
01051         totalHour += discretionary_hour_array[i];
01052 
01053     <span class="keywordflow">return</span> totalHour;
01054 }
01055 
01056 <span class="comment">//---------- End of function Faculty::total_hour -----------//</span>
01057 
01058 <span class="comment">//------ Begin of function Faculty::hour_str -------//</span>
01060 <span class="comment">char* Faculty::hour_str(float hourCount) {</span>
01061     <span class="keyword">static</span> <a class="code" href="classString.html">String</a> str;
01062 
01063     str = hourCount;
01064 
01065     <span class="keywordflow">if</span>( hourCount &gt; 1 )
01066         str += <span class="stringliteral">" hours"</span>;
01067     <span class="keywordflow">else</span>
01068         str += <span class="stringliteral">" hour"</span>;
01069 
01070     <span class="keywordflow">return</span> str;
01071 }
01072 
01073 <span class="comment">//------- End of function Faculty::hour_str -------//</span>
01074 
01075 <span class="comment">//------ Begin of function Faculty::name -------//</span>
<a name="l01077"></a><a class="code" href="classFaculty.html#a0">01077</a> <span class="comment">char* Faculty::name() {</span>
01078     <span class="comment">// 990521</span>
01079 
01080     <span class="keywordflow">if</span> ( ! name_res.is_male(first_name_id) ) {      <span class="comment">// is female</span>
01081         <a class="code" href="classString.html">String</a> str = name_res.first_name_array[first_name_id-1].name;
01082 
01083         <span class="keywordflow">if</span> ( str == <span class="stringliteral">"Catherine"</span> &amp;&amp;
01084              <span class="comment">// is male</span>
01085              ( gender_ethnic_group == <a class="code" href="Gamedef_8h.html#a75a27">NONMINORITY_MALE</a> || gender_ethnic_group == <a class="code" href="Gamedef_8h.html#a75a29">MINORITY_MALE</a> ) ) {
01086             <a class="code" href="ALL_8H.html#a4">err_now</a>(<span class="stringliteral">"ofaculty.cpp: line 864: Faculty::name():"</span>);
01087             <span class="comment">//err_here();</span>
01088         }
01089     }
01090 
01091     <a class="code" href="ALL_8H.html#a2">err_if</a>( faculty_photo_res[photo_id]-&gt;gender_ethnic_group != this-&gt;gender_ethnic_group )
01092         <a class="code" href="ALL_8H.html#a1">err_here</a>();
01093 
01094     <span class="keywordflow">return</span> name_res.get_name_str( first_name_id, middle_name_id, last_name_id );
01095 }
01096 
01097 <span class="comment">//------- End of function Faculty::name -------//</span>
01098 
01099 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
01100 <span class="preprocessor"></span><span class="comment">//------ Begin of function Faculty::name -------//</span>
01102 <span class="comment">char *Faculty::name(short firstNameId, short middleNameId, short lastNameId) {</span>
01103     <span class="keywordflow">return</span> name_res.get_name_str( firstNameId, middleNameId, lastNameId );
01104 }
01105 
01106 <span class="comment">//------ End of function Faculty::name -------//</span>
01107 <span class="preprocessor">#endif</span>
01108 <span class="preprocessor"></span>
01109 <span class="comment">//------ Begin of function Faculty::get_quality_driver -------//</span>
<a name="l01111"></a><a class="code" href="classFaculty.html#a23">01111</a> <span class="comment">float Faculty::get_quality_driver() {</span>
01112     <span class="comment">// 990412</span>
01113 
01114     <span class="keywordtype">int</span> i;
01115     <span class="keyword">const</span> <span class="keywordtype">int</span> VAR_COUNT = 4;
01116     <span class="keywordtype">float</span> input[VAR_COUNT];
01117 
01118     <span class="keywordtype">float</span> qualityDriver=0;
01119     <a class="code" href="classDepartment.html">Department</a>* deptPtr = department_array[department_recno];
01120 
01121     input[0] = talent_research;
01122     input[1] = performance_research;
01123     input[2] = deptPtr-&gt;<a class="code" href="classDepartment.html#m39">p_academic_standing</a>;
01124     input[3] = school_res.player_peer_school-&gt;prestige;
01125 
01126     input[0] = math.dual_response_func(0, 48.9f, 100, 65.52f, 32.19f, 29.67f, 79.24f, input[0]);
01127     input[1] = math.dual_response_func(0, 49.3f, 100, 71.18f, 23.22f, 30.35f, 62.56f, input[1]);
01128     input[2] = math.dual_response_func(0, 49.72f, 100, 72.29f, 30.76f, 39.41f, 83.34f, input[2]);
01129     input[3] = math.dual_response_func(0, 49.8f, 100, 58.89f, 18.19f, 29.91f, 89.79f, input[3]);
01130 
01131     <span class="keyword">const</span> <span class="keywordtype">float</span> weight[VAR_COUNT] = { 0.3f, 0.3f, 0.25f, 0.15f };
01132 
01133     <span class="keywordflow">for</span> (i=0; i&lt;VAR_COUNT; i++)
01134         qualityDriver += weight[i] * input[i];
01135 
01136     <span class="keywordflow">return</span> chance_event.research_adjust_multiplier * qualityDriver;
01137 }
01138 
01139 <span class="comment">//------- End of function Faculty::get_quality_driver -------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:32 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
