<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OSPRTRES.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>OSPRTRES.CPP</h1><a href="OSPRTRES_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OSPRTRES.CPP</span>
00002 <span class="comment">//Description : Object Sprite resource</span>
00003 <span class="comment">//Owner       : Fred</span>
00004 
00005 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00006 <span class="preprocessor">#include &lt;OMISC.H&gt;</span>
00007 <span class="comment">//#include &lt;OWORLD.H&gt;</span>
00008 <span class="preprocessor">#include &lt;<a class="code" href="OGAMESET_8H.html">OGAMESET.H</a>&gt;</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="OSPRTRES_8H.html">OSPRTRES.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="OSTR_8H.html">OSTR.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00012 <span class="comment">//#include &lt;OWEATHER.H&gt;</span>
00013 
00014 <span class="comment">//-------- define file name -----------//</span>
00015 
<a name="l00016"></a><a class="code" href="OSPRTRES_8CPP.html#a0">00016</a> <span class="preprocessor">#define SPRITE_DB       "SPRITE"</span>
<a name="l00017"></a><a class="code" href="OSPRTRES_8CPP.html#a1">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define SPRITE_ACTION_DB   "SACTION"</span>
00018 <span class="preprocessor"></span><span class="comment">//#define SUB_SPRITE_DB         "SUB_SPR"</span>
00019 
00020 <span class="comment">//-------- Begin of function SpriteRes::init ---------//</span>
00021 
<a name="l00022"></a><a class="code" href="classSpriteRes.html#a1">00022</a> <span class="keywordtype">void</span> <a class="code" href="classSpriteRes.html#a1">SpriteRes::init</a>() {
00023     <a class="code" href="classSpriteRes.html#a2">deinit</a>();
00024 
00025     load_sprite_info();
00026     <span class="comment">//load_sub_sprite_info();</span>
00027 
00028     <a class="code" href="classSpriteRes.html#m0">init_flag</a>=1;
00029 }
00030 
00031 <span class="comment">//--------- End of function SpriteRes::init ----------//</span>
00032 
00033 <span class="comment">//-------- Begin of function SpriteRes::deinit ---------//</span>
00034 
<a name="l00035"></a><a class="code" href="classSpriteRes.html#a2">00035</a> <span class="keywordtype">void</span> <a class="code" href="classSpriteRes.html#a2">SpriteRes::deinit</a>() {
00036     <span class="keywordflow">if</span>( init_flag ) {
00037         <span class="keyword">delete</span>[] sprite_info_array;
00038         <span class="comment">//mem_del(sub_sprite_info_array);</span>
00039 
00040         <a class="code" href="classSpriteRes.html#m0">init_flag</a>=0;
00041     }
00042 }
00043 
00044 <span class="comment">//--------- End of function SpriteRes::deinit ----------//</span>
00045 
00046 <span class="comment">//-------- Begin of function SpriteRes::load_sprite_info ---------//</span>
00047 
00048 <span class="keywordtype">void</span> SpriteRes::load_sprite_info() {
00049     <a class="code" href="classDatabase.html">Database</a>        *dbSprite    = game_set.open_db(<a class="code" href="OSPRTRES_8CPP.html#a0">SPRITE_DB</a>);
00050     <a class="code" href="structSpriteRec.html">SpriteRec</a>       *spriteRec;
00051     <a class="code" href="classSpriteInfo.html">SpriteInfo</a>      *spriteInfo;
00052     <span class="comment">//SpriteActionRec *spriteActionRec;</span>
00053     <span class="comment">//SpriteMove      *spriteMove;</span>
00054     <span class="comment">//SpriteAttack    *spriteAttack;</span>
00055     <span class="keywordtype">int</span>           i;                                <span class="comment">//, j, actionRecno, dirId;</span>
00056 
00057     <a class="code" href="classSpriteRes.html#m1">sprite_info_count</a> = dbSprite-&gt;<a class="code" href="classDatabase.html#a7">rec_count</a>();
00058     sprite_info_array = <span class="keyword">new</span> <a class="code" href="classSpriteInfo.html">SpriteInfo</a>[<a class="code" href="classSpriteRes.html#m1">sprite_info_count</a>];
00059 
00060     memset( sprite_info_array, 0, <span class="keyword">sizeof</span>(<a class="code" href="classSpriteInfo.html">SpriteInfo</a>)*<a class="code" href="classSpriteRes.html#m1">sprite_info_count</a> );
00061 
00062     <span class="comment">//short* first_dir_recno_array = (short*) mem_add( sizeof(short) * sprite_info_count );     // allocate temporary arrays for temporary storage</span>
00063     <span class="comment">//short* dir_count_array              = (short*) mem_add( sizeof(short) * sprite_info_count );</span>
00064 
00065     <span class="comment">//------------ read in sprite info -------------//</span>
00066 
00067     <span class="keywordflow">for</span>( i=0 ; i&lt;<a class="code" href="classSpriteRes.html#m1">sprite_info_count</a> ; i++ ) {
00068         spriteRec  = (<a class="code" href="structSpriteRec.html">SpriteRec</a>*) dbSprite-&gt;<a class="code" href="classDatabase.html#a4">read</a>(i+1);
00069         spriteInfo = sprite_info_array+i;
00070 
00071         spriteInfo-&gt;<a class="code" href="classSpriteInfo.html#m1">sprite_type</a> = spriteRec-&gt;<a class="code" href="structSpriteRec.html#m0">sprite_type</a>;
00072         m.rtrim_fld( spriteInfo-&gt;<a class="code" href="classSpriteInfo.html#m0">sprite_code</a>, spriteRec-&gt;<a class="code" href="structSpriteRec.html#m1">sprite_code</a>, spriteRec-&gt;<a class="code" href="structSpriteRec.html#s7s1">CODE_LEN</a> );
00073 
00074         <span class="keywordflow">if</span>(spriteInfo-&gt;<a class="code" href="classSpriteInfo.html#m1">sprite_type</a> == <span class="charliteral">' '</span>)
00075             spriteInfo-&gt;<a class="code" href="classSpriteInfo.html#m1">sprite_type</a> = 0;
00076 
00077         spriteInfo-&gt;<a class="code" href="classSpriteInfo.html#m2">loc_width</a>  = 1;                   <span class="comment">// m.atoi(spriteRec-&gt;loc_width , spriteRec-&gt;SPRITE_PARA_LEN);</span>
00078         spriteInfo-&gt;<a class="code" href="classSpriteInfo.html#m3">loc_height</a> = 1;                   <span class="comment">// m.atoi(spriteRec-&gt;loc_height, spriteRec-&gt;SPRITE_PARA_LEN);</span>
00079 
00080         <span class="comment">//spriteInfo-&gt;frames_per_step = m.atoi(spriteRec-&gt;frames_per_step, spriteRec-&gt;SPRITE_PARA_LEN);</span>
00081 
00082         <span class="comment">//first_dir_recno_array[i] = m.atoi(spriteRec-&gt;first_move_recno, spriteRec-&gt;RECNO_LEN);</span>
00083         <span class="comment">//dir_count_array[i]             = m.atoi(spriteRec-&gt;move_count      , spriteRec-&gt;COUNT_LEN);</span>
00084     }
00085 
00086     <span class="keywordflow">return</span>;
00087 
00088     <span class="comment">/*</span>
00089 <span class="comment">      //------- read in sprite action info ---------//</span>
00090 <span class="comment"></span>
00091 <span class="comment">      Database *dbSpriteMove = game_set.open_db(SPRITE_ACTION_DB);</span>
00092 <span class="comment"></span>
00093 <span class="comment">      for( i=0 ; i&lt;sprite_info_count ; i++ )</span>
00094 <span class="comment">      {</span>
00095 <span class="comment">      spriteInfo = sprite_info_array+i;</span>
00096 <span class="comment"></span>
00097 <span class="comment">      for( j=0, actionRecno=first_dir_recno_array[i] ; j&lt;dir_count_array[i] ; j++, actionRecno++ )</span>
00098 <span class="comment">      {</span>
00099 <span class="comment">      spriteActionRec = (SpriteActionRec*) dbSpriteMove-&gt;read(actionRecno);</span>
00100 <span class="comment"></span>
00101 <span class="comment">      dirId = m.atoi(spriteActionRec-&gt;dir_id, spriteActionRec-&gt;DIR_ID_LEN);</span>
00102 <span class="comment"></span>
00103 <span class="comment">      //--------- move motion --------//</span>
00104 <span class="comment"></span>
00105 <span class="comment">      if( spriteActionRec-&gt;action[0] == 'M' )</span>
00106 <span class="comment">      {</span>
00107 <span class="comment">      spriteMove = spriteInfo-&gt;move_array+dirId;</span>
00108 <span class="comment"></span>
00109 <span class="comment">      spriteMove-&gt;first_frame_recno = m.atoi(spriteActionRec-&gt;first_frame_recno, spriteActionRec-&gt;RECNO_LEN);</span>
00110 <span class="comment">      spriteMove-&gt;frame_count           = m.atoi(spriteActionRec-&gt;frame_count, spriteActionRec-&gt;COUNT_LEN);</span>
00111 <span class="comment"></span>
00112 <span class="comment">      //--- the first movement frame is the default stop frame ---//</span>
00113 <span class="comment"></span>
00114 <span class="comment">      if( spriteInfo-&gt;stop_array[dirId].frame_recno == 0)</span>
00115 <span class="comment">      {</span>
00116 <span class="comment">      spriteInfo-&gt;stop_array[dirId].frame_recno = spriteMove-&gt;first_frame_recno;</span>
00117 <span class="comment">      spriteInfo-&gt;stop_array[dirId].frame_count = 1;</span>
00118 <span class="comment">      }</span>
00119 <span class="comment">      }</span>
00120 <span class="comment"></span>
00121 <span class="comment">      //--------- stop bitmap ---------//</span>
00122 <span class="comment"></span>
00123 <span class="comment">      else if( spriteActionRec-&gt;action[0] == 'S' )</span>
00124 <span class="comment">      {</span>
00125 <span class="comment">      spriteInfo-&gt;stop_array[dirId].frame_recno = m.atoi(spriteActionRec-&gt;first_frame_recno, spriteActionRec-&gt;RECNO_LEN);</span>
00126 <span class="comment">      spriteInfo-&gt;stop_array[dirId].frame_count = m.atoi(spriteActionRec-&gt;frame_count, spriteActionRec-&gt;COUNT_LEN);</span>
00127 <span class="comment">      }</span>
00128 <span class="comment"></span>
00129 <span class="comment">      }</span>
00130 <span class="comment">      }</span>
00131 <span class="comment"></span>
00132 <span class="comment">      //----------- delete temp arrays -------------//</span>
00133 <span class="comment"></span>
00134 <span class="comment">      //mem_del( first_dir_recno_array );</span>
00135 <span class="comment">      //mem_del( dir_count_array );</span>
00136 <span class="comment">    */</span>
00137 }
00138 
00139 <span class="comment">//-------- End of function SpriteRes::load_sprite_info ---------//</span>
00140 
00141 <span class="comment">//-------- Begin of function SpriteRes::update_speed -------//</span>
00142 
<a name="l00143"></a><a class="code" href="classSpriteRes.html#a3">00143</a> <span class="keywordtype">void</span> <a class="code" href="classSpriteRes.html#a3">SpriteRes::update_speed</a>() {
00144     <span class="comment">/*  SpriteInfo *spriteInfo;</span>
00145 <span class="comment">        //short rainScale = weather.rain_scale();</span>
00146 <span class="comment">        //short snowScale = weather.snow_scale();</span>
00147 <span class="comment">        short rainScale = 0;</span>
00148 <span class="comment">        short snowScale = 0;</span>
00149 <span class="comment">        short speedDrop;</span>
00150 <span class="comment"></span>
00151 <span class="comment">        rainScale = rainScale &gt; 7 ? 7 : rainScale;</span>
00152 <span class="comment">        snowScale = snowScale &gt; 7 ? 7 : snowScale;</span>
00153 <span class="comment"></span>
00154 <span class="comment">        for( int i=0 ; i&lt;sprite_info_count ; i++ )</span>
00155 <span class="comment">        {</span>
00156 <span class="comment">        speedDrop = 0;</span>
00157 <span class="comment">        spriteInfo = sprite_info_array+i;</span>
00158 <span class="comment"></span>
00159 <span class="comment">        if( rainScale &gt; 0 &amp;&amp; spriteInfo-&gt;max_rain_slowdown &gt; 0 )</span>
00160 <span class="comment">        {</span>
00161 <span class="comment">        speedDrop += rainScale*spriteInfo-&gt;max_rain_slowdown/8 + 1;</span>
00162 <span class="comment">        }</span>
00163 <span class="comment"></span>
00164 <span class="comment">        if( snowScale &gt; 0 &amp;&amp; spriteInfo-&gt;max_snow_slowdown &gt; 0 )</span>
00165 <span class="comment">        {</span>
00166 <span class="comment">        speedDrop += snowScale*spriteInfo-&gt;max_snow_slowdown/8 + 1;</span>
00167 <span class="comment">        }</span>
00168 <span class="comment">        spriteInfo-&gt;speed = spriteInfo-&gt;max_speed - speedDrop;</span>
00169 <span class="comment">        }</span>
00170 <span class="comment">    */</span>
00171 }
00172 
00173 <span class="comment">//-------- End of function SpriteRes::update_speed -------//</span>
00174 
00175 <span class="preprocessor">#ifdef DEBUG</span>
00176 <span class="preprocessor"></span>
00177 <span class="comment">//-------- Begin of function SpriteRes::operator[] -------//</span>
00178 
00179 <a class="code" href="classSpriteInfo.html">SpriteInfo</a>* <a class="code" href="classSpriteRes.html#a4">SpriteRes::operator[]</a>(<span class="keywordtype">int</span> recNo) {
00180     <span class="keywordflow">if</span>( recNo&lt;1 || recNo&gt;<a class="code" href="classSpriteRes.html#m1">sprite_info_count</a> )
00181         err.run( <span class="stringliteral">"SpriteRes::operator[%d]"</span>, recNo );
00182 
00183     <span class="keywordflow">return</span> sprite_info_array+recNo-1;
00184 }
00185 
00186 <span class="comment">//--------- End of function SpriteRes::operator[] --------//</span>
00187 <span class="preprocessor">#endif</span>
00188 <span class="preprocessor"></span>
00189 <span class="comment">//------- Begin of function SpriteInfo::~SpriteInfo -------//</span>
00190 
<a name="l00191"></a><a class="code" href="classSpriteInfo.html#a0">00191</a> <a class="code" href="classSpriteInfo.html#a0">SpriteInfo::~SpriteInfo</a>() {
00192     <span class="comment">// in free_bitmap_res</span>
00193     <span class="comment">/*</span>
00194 <span class="comment">      if( init_flag )</span>
00195 <span class="comment">      {</span>
00196 <span class="comment">      for( int i=0 ; i&lt;MAX_ZOOM_LEVEL ; i++ )</span>
00197 <span class="comment">      res_bitmap[i].deinit();</span>
00198 <span class="comment"></span>
00199 <span class="comment">      init_flag=0;</span>
00200 <span class="comment">      }*/</span>
00201 }
00202 
00203 <span class="comment">//--------- End of function SpriteInfo::~SpriteInfo -------//</span>
00204 
00205 <span class="comment">//------- Begin of function SpriteInfo::load_bitmap_res -------//</span>
<a name="l00207"></a><a class="code" href="classSpriteInfo.html#a1">00207</a> <span class="comment">void SpriteInfo::load_bitmap_res() {              //int zoomLevel, char* namePrefix, char* nameSuffix)</span>
00208     <span class="keywordflow">if</span>( ++loaded_count &gt; 1 )                        <span class="comment">// if bitmaps of this sprite has been loaded</span>
00209         <span class="keywordflow">return</span>;
00210 
00211     <span class="comment">//---- open bitmap resource of different resolutions ----//</span>
00212 
00213     load_bitmap_res( <a class="code" href="Gamedef_8h.html#a72a19">ZOOM_SMALL</a> , sprite_code, <span class="stringliteral">"S"</span> );
00214     load_bitmap_res( <a class="code" href="Gamedef_8h.html#a72a20">ZOOM_MEDIUM</a>, sprite_code, <span class="stringliteral">"M"</span> );
00215     load_bitmap_res( <a class="code" href="Gamedef_8h.html#a72a21">ZOOM_LARGE</a> , sprite_code, <span class="stringliteral">"L"</span> );
00216 }
00217 
00218 <span class="comment">//------------- End of function SpriteInfo::load_bitmap_res --------//</span>
00219 
00220 <span class="comment">//------- Begin of function SpriteInfo::load_bitmap_res -------//</span>
00221 <span class="keywordtype">void</span> <a class="code" href="classSpriteInfo.html#a1">SpriteInfo::load_bitmap_res</a>(<span class="keywordtype">int</span> zoomLevel, <span class="keywordtype">char</span>* namePrefix, <span class="keywordtype">char</span>* nameSuffix) {
00222     <span class="comment">//------ read bitmaps into memory -----//</span>
00223 
00224     <a class="code" href="classString.html">String</a> str2;
00225 
00226     str2  = <a class="code" href="Gamedef_8h.html#a4">DIR_RES</a>;
00227     str2 += namePrefix;
00228     str2 += <span class="stringliteral">"_"</span>;
00229     str2 += nameSuffix;
00230 
00231     str2 += <span class="stringliteral">".RES"</span>;
00232 
00233     <a class="code" href="classSpriteInfo.html#m8">res_bitmap</a>[zoomLevel].<a class="code" href="classResourceIdx.html#a3">init</a>( str2, 1 );          <span class="comment">// 1-read all bitmaps into memory</span>
00234 
00235     <span class="comment">//-------- set PlantInfo::bitmap_ptr[] --------//</span>
00236 
00237     <span class="keywordtype">char</span>* bmpPtr;
00238 
00239     bmpPtr = <a class="code" href="classSpriteInfo.html#m8">res_bitmap</a>[zoomLevel].<a class="code" href="classResourceIdx.html#a8">read</a>( <a class="code" href="classSpriteInfo.html#m0">sprite_code</a> );
00240 
00241     <a class="code" href="classSpriteInfo.html#m4">bitmap_ptr</a>[zoomLevel] = bmpPtr;
00242     <a class="code" href="classSpriteInfo.html#m5">bitmap_width</a>[<a class="code" href="Gamedef_8h.html#a9">MAX_ZOOM_LEVEL</a>] = *((<span class="keywordtype">short</span> *)bmpPtr);
00243     <a class="code" href="classSpriteInfo.html#m6">bitmap_height</a>[<a class="code" href="Gamedef_8h.html#a9">MAX_ZOOM_LEVEL</a>] = *(1 + (<span class="keywordtype">short</span> *)bmpPtr);
00244 }
00245 
00246 <span class="comment">//------------- End of function SpriteInfo::load_res --------//</span>
00247 
00248 <span class="comment">//------- Begin of function SpriteInfo::free_bitmap_res -------//</span>
00249 
<a name="l00250"></a><a class="code" href="classSpriteInfo.html#a2">00250</a> <span class="keywordtype">void</span> <a class="code" href="classSpriteInfo.html#a2">SpriteInfo::free_bitmap_res</a>() {
00251     <a class="code" href="classSpriteInfo.html#m7">loaded_count</a>--;
00252 
00253     <a class="code" href="ALL_8H.html#a0">err_when</a>( <a class="code" href="classSpriteInfo.html#m7">loaded_count</a> &lt; 0 );
00254 
00255     <span class="keywordflow">if</span>( <a class="code" href="classSpriteInfo.html#m7">loaded_count</a>==0 ) {                         <span class="comment">// if this bitmap is still needed by other sprites</span>
00256         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0 ; i&lt;<a class="code" href="Gamedef_8h.html#a9">MAX_ZOOM_LEVEL</a> ; i++ )
00257             <a class="code" href="classSpriteInfo.html#m8">res_bitmap</a>[i].<a class="code" href="classResourceIdx.html#a4">deinit</a>();
00258     }
00259 }
00260 
00261 <span class="comment">//-------- End of function SpriteInfo::free_bitmap_res -------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:24 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
