<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Oworld_z.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Oworld_z.cpp</h1><a href="Oworld__z_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename   : OWORLD_Z.CPP</span>
00002 <span class="comment">//Description: ZoomMatrix class</span>
00003 
00004 <span class="preprocessor">#include &lt;<a class="code" href="KEY_8H.html">KEY.H</a>&gt;</span>
00005 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00006 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00007 <span class="preprocessor">#include &lt;OCONFIG.H&gt;</span>
00008 <span class="preprocessor">#include &lt;OMOUSE.H&gt;</span>
00009 <span class="preprocessor">#include &lt;OMATRIX.H&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="OWORLD_8H.html">OWORLD.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;OFIRM.H&gt;</span>
00012 <span class="preprocessor">#include &lt;<a class="code" href="OFIRMRES_8H.html">OFIRMRES.H</a>&gt;</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="COLCODE_8H.html">COLCODE.H</a>&gt;</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="OLOG_8H.html">OLOG.H</a>&gt;</span>
00015 
00016 <span class="comment">//------------ Begin of function ZoomMatrix::ZoomMatrix ---------------//</span>
00017 
<a name="l00018"></a><a class="code" href="classZoomMatrix.html#a0">00018</a> <a class="code" href="classZoomMatrix.html#a0">ZoomMatrix::ZoomMatrix</a>() {
00019     next_scroll_time = 0;
00020 }
00021 
00022 <span class="comment">//------------ End of function ZoomMatrix::ZoomMatrix ---------------//</span>
00023 
00024 <span class="comment">//------------ Begin of function ZoomMatrix::draw_all ---------------//</span>
00025 
<a name="l00026"></a><a class="code" href="classZoomMatrix.html#a1">00026</a> <span class="keywordtype">void</span> <a class="code" href="classZoomMatrix.html#a1">ZoomMatrix::draw_all</a>() {
00027     <a class="code" href="classMatrix.html#a3">Matrix::draw_all</a>();
00028 }
00029 
00030 <span class="comment">//------------ End of function ZoomMatrix::draw_all ---------------//</span>
00031 
00032 <span class="comment">//------------ Begin of function ZoomMatrix::draw_update ---------------//</span>
00033 
<a name="l00034"></a><a class="code" href="classZoomMatrix.html#a2">00034</a> <span class="keywordtype">void</span> <a class="code" href="classZoomMatrix.html#a2">ZoomMatrix::draw_update</a>() {
00035     <span class="comment">//Matrix::draw_all();               //temp for debug fred 0611</span>
00036 }
00037 
00038 <span class="comment">//-------------- End of function ZoomMatrix::draw_update --------------//</span>
00039 
00040 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00041 <span class="preprocessor"></span><span class="keywordtype">void</span> ZoomMatrix::draw_text() {
00042     <span class="comment">// Matrix::draw_text();</span>
00043 
00044     <span class="keywordflow">if</span>( config.disp_building_label ) {
00045         <span class="comment">// draw text on firm</span>
00046 
00047         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> firmRecno = 1; firmRecno &lt;= firm_array.size(); ++firmRecno ) {
00048             <span class="keywordflow">if</span>( firm_array.is_deleted(firmRecno) )
00049                 <span class="keywordflow">continue</span>;
00050             <a class="code" href="classFirm.html">Firm</a> *firmPtr = firm_array[firmRecno];
00051             <span class="keywordflow">if</span>( firmPtr-&gt;name_on_map() ) {
00052                 <a class="code" href="classMatrix.html#a7">put_center_text</a>( (firmPtr-&gt;<a class="code" href="classFirm.html#m7">abs_rect</a>[<a class="code" href="classMatrix.html#m20">zoom_level</a>].x1+firmPtr-&gt;<a class="code" href="classFirm.html#m7">abs_rect</a>[<a class="code" href="classMatrix.html#m20">zoom_level</a>].x2)/2,
00053                                  (firmPtr-&gt;<a class="code" href="classFirm.html#m7">abs_rect</a>[<a class="code" href="classMatrix.html#m20">zoom_level</a>].y1+firmPtr-&gt;<a class="code" href="classFirm.html#m7">abs_rect</a>[<a class="code" href="classMatrix.html#m20">zoom_level</a>].y2)/2,
00054                                  firmPtr-&gt;name_on_map() );
00055             }
00056         }
00057     }
00058 }
00059 <span class="preprocessor">#endif</span>
00060 <span class="preprocessor"></span>
00061 <span class="comment">//------------ Begin of function ZoomMatrix::detect ---------------//</span>
00062 
<a name="l00063"></a><a class="code" href="classZoomMatrix.html#a3">00063</a> <span class="keywordtype">int</span> <a class="code" href="classZoomMatrix.html#a3">ZoomMatrix::detect</a>() {
00064     <span class="keywordflow">if</span>( detect_scroll() )
00065         <span class="keywordflow">return</span> 1;
00066 
00067     <span class="keywordflow">return</span> detect_select();                         <span class="comment">// detect selecting a firm</span>
00068 }
00069 
00070 <span class="comment">//-------------- End of function ZoomMatrix::detect ---------------//</span>
00071 
00072 <span class="comment">//--------- Begin of function ZoomMatrix::detect_scroll ---------//</span>
00077 <span class="comment">int ZoomMatrix::detect_scroll() {</span>
00078     <span class="comment">// just scrolled not too long ago, wait for a little while before next scroll.</span>
00079     <span class="keywordflow">if</span>( next_scroll_time &amp;&amp; m.get_time() &lt; next_scroll_time )
00080         <span class="keywordflow">return</span> 0;
00081 
00082     <span class="keywordtype">int</span> rc=0;
00083 
00084     <span class="comment">//----- scroll left -----//</span>
00085 
00086     <span class="keywordflow">if</span>( mouse.cur_x == mouse.bound_x1 || mouse.key_code==<a class="code" href="KEY_8H.html#a11">KEY_LEFT</a> ) {
00087         world.map_matrix.scroll(-1,0);
00088         rc = 1;
00089     }
00090 
00091     <span class="comment">//---- scroll right -----//</span>
00092 
00093     <span class="keywordflow">if</span>( mouse.cur_x == mouse.bound_x2 || mouse.key_code==<a class="code" href="KEY_8H.html#a10">KEY_RIGHT</a> ) {
00094         world.map_matrix.scroll(1,0);
00095         rc = 1;
00096     }
00097 
00098     <span class="comment">//---- scroll top -------//</span>
00099 
00100     <span class="keywordflow">if</span>( mouse.cur_y == mouse.bound_y1 || mouse.key_code==<a class="code" href="KEY_8H.html#a8">KEY_UP</a> ) {
00101         world.map_matrix.scroll(0,-1);
00102         rc = 1;
00103     }
00104 
00105     <span class="comment">//---- scroll bottom ----//</span>
00106 
00107     <span class="keywordflow">if</span>( mouse.cur_y == mouse.bound_y2 || mouse.key_code==<a class="code" href="KEY_8H.html#a9">KEY_DOWN</a> ) {
00108         world.map_matrix.scroll(0,1);
00109         rc = 1;
00110     }
00111 
00112     <span class="comment">//----- set next scroll time based on scroll_speed -----//</span>
00113     <span class="comment">//</span>
00114     <span class="comment">// slowest scroll speed: 500/1  = 500 milliseconds or 1/2 second</span>
00115     <span class="comment">// fastest scroll speed: 500/10 = 50  milliseconds or 1/20 second</span>
00116     <span class="comment">//</span>
00117     <span class="comment">//------------------------------------------------------//</span>
00118     <span class="comment">// ## chwong 1207</span>
00119     <span class="keywordflow">if</span>( rc )
00120         next_scroll_time = m.get_time() + 500/(config.scroll_speed+1);
00121 
00122     <span class="keywordflow">return</span> rc;
00123 }
00124 
00125 <span class="comment">//----------- End of function ZoomMatrix::detect_scroll -----------//</span>
00126 
00127 <span class="comment">//--------- Begin of function ZoomMatrix::detect_select ------------//</span>
00128 
00129 <span class="keywordtype">int</span> ZoomMatrix::detect_select() {
00130     <span class="keywordtype">int</span> absClickX = <a class="code" href="classMatrix.html#m7">abs_top_x</a> + (mouse.cur_x-<a class="code" href="classMatrix.html#m11">win_x1</a>);
00131     <span class="keywordtype">int</span> absClickY = <a class="code" href="classMatrix.html#m8">abs_top_y</a> + (mouse.cur_y-<a class="code" href="classMatrix.html#m12">win_y1</a>);
00132 
00133     firm_array.touched_recno = 0;
00134 
00135     <span class="comment">// ## chwg062499</span>
00136     <span class="keywordtype">int</span> i,j,dispCount = <a class="code" href="classMatrix.html#p0">disp_sort_array</a>.<a class="code" href="classDynArray.html#a28">size</a>();
00137 
00138     <span class="keywordflow">for</span>( i=dispCount ;i&gt;=1; i-- ) {
00139         <a class="code" href="structDisplaySort.html">DisplaySort</a>* displaySortPtr = (<a class="code" href="structDisplaySort.html">DisplaySort</a>*) <a class="code" href="classMatrix.html#p0">disp_sort_array</a>.<a class="code" href="classDynArray.html#a13">get</a>(i);
00140         <span class="comment">//              if(!displaySortPtr)</span>
00141         <span class="comment">//                      continue;</span>
00142 
00143         <span class="keywordflow">if</span>(displaySortPtr-&gt;<a class="code" href="structDisplaySort.html#m0">object_type</a>!=<a class="code" href="Omatrix_8h.html#a11a0">OBJECT_FIRM</a>)
00144             <span class="keywordflow">continue</span>;
00145 
00146         j=displaySortPtr-&gt;<a class="code" href="structDisplaySort.html#m1">object_recno</a>;
00147 
00148         <a class="code" href="classFirm.html">Firm</a> *firmPtr;
00149         <span class="keywordflow">if</span>( firm_array.is_deleted(j) )
00150             <span class="keywordflow">continue</span>;
00151 
00152         firmPtr = firm_array[j];
00153 
00154         <span class="comment">//------ if the mouse is over the building ------//</span>
00155         <span class="keywordflow">if</span>( firmPtr-&gt;<a class="code" href="classFirm.html#m7">abs_rect</a>[<a class="code" href="classMatrix.html#m20">zoom_level</a>].is_inside( absClickX, absClickY ) ) {
00156 
00157             <span class="comment">//------ if the pixel which is pointed by cursor of the building image is not transparent ------//</span>
00158             <a class="code" href="structFirmInfo.html">FirmInfo</a>* firmInfo = firm_res[firmPtr-&gt;<a class="code" href="classFirm.html#m1">firm_id</a>];
00159             <span class="comment">//-------- check if the firm is within the view area --------//</span>
00160             <span class="comment">//                  int bmpWidth  = firmInfo-&gt;bitmap_width[zoom_level];</span>
00161             <span class="comment">//                  int bmpHeight = firmInfo-&gt;bitmap_height[zoom_level];</span>
00162             <span class="keywordtype">char</span>* bmpPtr  = firmInfo-&gt;<a class="code" href="structFirmInfo.html#m5">bitmap_ptr</a>[<a class="code" href="classMatrix.html#m20">zoom_level</a>];
00163 
00164             <span class="comment">// - world.active_zoom_matrix-&gt;win_x1 + world.active_zoom_matrix-&gt;abs_top_x;</span>
00165             <span class="keywordtype">int</span> cur_x = absClickX - firmPtr-&gt;<a class="code" href="classFirm.html#m7">abs_rect</a>[<a class="code" href="classMatrix.html#m20">zoom_level</a>].x1;
00166             <span class="comment">// - world.active_zoom_matrix-&gt;win_y1 + world.active_zoom_matrix-&gt;abs_top_y;</span>
00167             <span class="keywordtype">int</span> cur_y = absClickY - firmPtr-&gt;<a class="code" href="classFirm.html#m7">abs_rect</a>[<a class="code" href="classMatrix.html#m20">zoom_level</a>].y1;
00168             <span class="comment">/*</span>
00169 <span class="comment">              String s=m.format(cur_x,1);</span>
00170 <span class="comment">              s+=",";</span>
00171 <span class="comment">              s+=m.format(cur_y,1);</span>
00172 <span class="comment">              s+=",";</span>
00173 <span class="comment">              s+=m.format(IMGgetTransDecompress(bmpPtr,cur_x,cur_y) ,1);</span>
00174 <span class="comment">              DEBUG_LOG(s);</span>
00175 <span class="comment">            */</span>
00176             <span class="keywordflow">if</span>(<a class="code" href="IMGFUN_8H.html#a31">IMGgetTransDecompress</a>(bmpPtr,cur_x,cur_y)==<a class="code" href="COLCODE_8H.html#a0">TRANSPARENT_CODE</a>)
00177                 <span class="keywordflow">continue</span>;
00178             <span class="comment">//------ if building is the toppest ------//</span>
00179 
00180             firm_array.touched_recno     = j;
00181             <span class="comment">// the frame id. which the building is being touched</span>
00182             firm_array.touched_frame_count = sys.frame_count;
00183 
00184             <span class="comment">//------ if the mouse clicks on the building ------//</span>
00185 
00186             <span class="keywordtype">int</span> rc=mouse.any_click( <a class="code" href="classMatrix.html#m11">win_x1</a>,<a class="code" href="classMatrix.html#m12">win_y1</a>,<a class="code" href="classMatrix.html#m13">win_x2</a>,<a class="code" href="classMatrix.html#m14">win_y2</a>, <a class="code" href="Omouse_8h.html#a28a22">LEFT_BUTTON</a> );
00187 
00188             <span class="keywordflow">if</span>( rc==1 ) {
00189                 firm_array.select_firm(j);
00190                 sys.redraw_all_flag = 1;
00191                 <span class="keywordflow">return</span> 1;
00192             }
00193 
00194             <span class="comment">//--- double-click to bring up the firm's detail report ----//</span>
00195 
00196             <span class="keywordflow">else</span> <span class="keywordflow">if</span>( rc==2 ) {
00197                 firm_array[j]-&gt;double_click_firm();
00198                 <span class="keywordflow">return</span> 1;
00199             }
00200             <span class="keywordflow">return</span> 0;
00201         }
00202     }
00203 
00204     <span class="keywordflow">return</span> 0;
00205 }
00206 
00207 <span class="comment">//---------- End of function ZoomMatrix::detect_select -----------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:37 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
