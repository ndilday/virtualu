<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ovga.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>ovga.cpp</h1><a href="ovga_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OVGA.CPP</span>
00002 <span class="comment">//Description : VGA manipulation functions (Direct Draw version)</span>
00003 
<a name="l00004"></a><a class="code" href="ovga_8cpp.html#a0">00004</a> <span class="preprocessor">#define DEBUG_LOG_LOCAL 1</span>
00005 <span class="preprocessor"></span>
00006 <span class="preprocessor">#include &lt;windowsx.h&gt;</span>
00007 
00008 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="IMGFUN_8H.html">IMGFUN.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="COLCODE_8H.html">COLCODE.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;OMOUSE.H&gt;</span>
00012 <span class="preprocessor">#include &lt;<a class="code" href="OMOUSECR_8H.html">OMOUSECR.H</a>&gt;</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="OCOLTBL_8H.html">OCOLTBL.H</a>&gt;</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="OFILE_8H.html">OFILE.H</a>&gt;</span>
00015 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00016 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00017 <span class="preprocessor">#include &lt;<a class="code" href="OLOG_8H.html">OLOG.H</a>&gt;</span>
00018 <span class="preprocessor">#include &lt;<a class="code" href="OVGALOCK_8H.html">OVGALOCK.H</a>&gt;</span>
00019 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00020 <span class="comment">//-------- Define constant --------//</span>
00021 
<a name="l00022"></a><a class="code" href="ovga_8cpp.html#a1">00022</a> <span class="preprocessor">#define UP_OPAQUE_COLOR       (VGA_GRAY+10)</span>
<a name="l00023"></a><a class="code" href="ovga_8cpp.html#a2">00023</a> <span class="preprocessor"></span><span class="preprocessor">#define DOWN_OPAQUE_COLOR     (VGA_GRAY+13)</span>
00024 <span class="preprocessor"></span>
00025 <span class="comment">//------ Define static class member vars ---------//</span>
00026 
<a name="l00027"></a><a class="code" href="classVga.html#p1">00027</a> <span class="keywordtype">char</span>    <a class="code" href="classVga.html#p1">Vga::use_back_buf</a> = 0;
<a name="l00028"></a><a class="code" href="classVga.html#p2">00028</a> <span class="keywordtype">char</span>    <a class="code" href="classVga.html#p2">Vga::opaque_flag</a>  = 0;
<a name="l00029"></a><a class="code" href="classVga.html#p0">00029</a> <a class="code" href="classVgaBuf.html">VgaBuf</a>* <a class="code" href="classVga.html#p0">Vga::active_buf</a>   = &amp;vga_front;           <span class="comment">// default: front buffer</span>
00030 <span class="comment">// ##### begin Gilbert 26/04/2001 ######//</span>
00031 <span class="comment">// static short * mouse_back_buffer_storage_bitmap;</span>
00032 <span class="comment">// ##### end Gilbert 26/04/2001 ######//</span>
00033 
<a name="l00034"></a><a class="code" href="ovga_8cpp.html#a5">00034</a> <span class="keywordtype">char</span>    <a class="code" href="ovga_8cpp.html#a5">low_video_memory_flag</a> = 0;
00035 <span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
<a name="l00036"></a><a class="code" href="ovga_8cpp.html#a6">00036</a>     <span class="keywordtype">short</span> <a class="code" href="ovga_8cpp.html#a6">transparent_code_w</a>;
00037 }
00038 
00039 <span class="comment">//-------- Begin of function Vga::Vga ----------//</span>
00040 
<a name="l00041"></a><a class="code" href="classVga.html#a0">00041</a> <a class="code" href="classVga.html#a0">Vga::Vga</a>() {
00042     memset( <span class="keyword">this</span>, 0, <span class="keyword">sizeof</span>(<a class="code" href="classVga.html">Vga</a>) );
00043     <span class="comment">// ##### begin Gilbert 26/04/2001 ######//</span>
00044     <span class="comment">// mouse_back_buffer_storage_bitmap=NULL;</span>
00045     <span class="comment">// ##### end Gilbert 26/04/2001 ######//</span>
00046     <a class="code" href="classVga.html#m3">vga_color_table</a> = <span class="keyword">new</span> <a class="code" href="classColorTable.html">ColorTable</a>;
00047     <a class="code" href="classVga.html#m8">dont_blt</a> =0;                                    <span class="comment">// ## chwg021999</span>
00048 }
00049 
00050 <span class="comment">//-------- End of function Vga::Vga ----------//</span>
00051 
00052 <span class="comment">//-------- Begin of function Vga::~Vga ----------//</span>
00053 
<a name="l00054"></a><a class="code" href="classVga.html#a1">00054</a> <a class="code" href="classVga.html#a1">Vga::~Vga</a>() {
00055     <a class="code" href="classVga.html#a5">deinit</a>();                                       <span class="comment">// 1-is final</span>
00056 
00057     <span class="keyword">delete</span> <a class="code" href="classVga.html#m3">vga_color_table</a>;
00058 
00059     <a class="code" href="ALL_8H.html#a0">err_when</a>( <a class="code" href="classVga.html#m7">back_up_pal</a> );                        <span class="comment">// this must be free up immediately after its use</span>
00060 }
00061 
00062 <span class="comment">//-------- End of function Vga::~Vga ----------//</span>
00063 
00064 <span class="comment">//-------- Begin of function Vga::init ----------//</span>
00065 
<a name="l00066"></a><a class="code" href="classVga.html#a2">00066</a> BOOL <a class="code" href="classVga.html#a2">Vga::init</a>() {
00067     <span class="keywordtype">char</span>* warnStr = <span class="stringliteral">"Warning: Due to the low memory of your display card, "</span>
00068         <span class="stringliteral">"you may experience problems when you quit the game or "</span>
00069         <span class="stringliteral">"switch tasks during the game. "</span>
00070         <span class="stringliteral">"To avoid this problem, set your Windows display "</span>
00071         <span class="stringliteral">"to 800x600 16-bit color mode before running the game."</span>;
00072 
00073     <span class="comment">//--------- Initialize DirectDraw object --------//</span>
00074 
00075     <span class="keywordflow">if</span>( !<a class="code" href="classVga.html#a3">init_dd</a>() )
00076         <span class="keywordflow">return</span> FALSE;
00077 
00078     <span class="comment">// get current display mode</span>
00079     DDSURFACEDESC2 ddsd;
00080     DDSCAPS2  ddsCaps;
00081     DWORD    dwTotal;
00082     DWORD    dwFree;
00083 
00084     memset(&amp;ddsd, 0, <span class="keyword">sizeof</span>(ddsd) );
00085     ddsd.dwSize = <span class="keyword">sizeof</span>(ddsd);
00086     ddsCaps.dwCaps = DDSCAPS_VIDEOMEMORY;
00087 
00088     <span class="keywordflow">if</span>( <a class="code" href="classVga.html#m0">dd_obj</a>-&gt;GetDisplayMode(&amp;ddsd) == DD_OK &amp;&amp;
00089         <a class="code" href="classVga.html#m0">dd_obj</a>-&gt;GetAvailableVidMem(&amp;ddsCaps, &amp;dwTotal, &amp;dwFree) == DD_OK ) {
00090         <span class="keywordflow">if</span>( dwFree &lt; (DWORD) <a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a>*<a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a>*<a class="code" href="OVGA_8H.html#a2">VGA_BPP</a>/8 &amp;&amp;
00091             !(ddsd.dwWidth==(DWORD)<a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a> &amp;&amp; ddsd.dwHeight==(DWORD)<a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a> &amp;&amp; (ddsd.ddpfPixelFormat.dwRGBBitCount == (DWORD)<a class="code" href="OVGA_8H.html#a2">VGA_BPP</a>)) ) {
00092             <span class="comment">// not enough memory except same video mode</span>
00093 
00094             ShowCursor(TRUE);
00095             <span class="comment">// approximation of video memory required, actual video memory used should be calculated from vga_(true)_front-&gt;buf_pitch()</span>
00096 
00097             <span class="comment">/*</span>
00098 <span class="comment">              extern char new_config_dat_flag;</span>
00099 <span class="comment"></span>
00100 <span class="comment">              if( new_config_dat_flag )</span>
00101 <span class="comment">              {</span>
00102 <span class="comment">              MessageBox(sys.main_hwnd, warnStr,</span>
00103 <span class="comment">              WIN_TITLE, MB_OK | MB_ICONWARNING | MB_SETFOREGROUND );</span>
00104 <span class="comment">              }</span>
00105 <span class="comment">            */</span>
00106             <a class="code" href="ovga_8cpp.html#a5">low_video_memory_flag</a> = 1;
00107 
00108             ShowCursor(FALSE);
00109         }
00110     }
00111 
00112     <span class="keywordflow">if</span>( !<a class="code" href="classVga.html#a4">set_mode</a>(<a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a>, <a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a>) )
00113         <span class="keywordflow">return</span> FALSE;
00114 
00115     <span class="keywordflow">return</span> TRUE;
00116 }
00117 
00118 <span class="comment">//-------- End of function Vga::init ----------//</span>
00119 
00120 <span class="comment">//-------- Begin of function Vga::init_dd ----------//</span>
00121 
<a name="l00122"></a><a class="code" href="classVga.html#a3">00122</a> BOOL <a class="code" href="classVga.html#a3">Vga::init_dd</a>() {
00123     <span class="keywordflow">if</span>(dd_obj)                                      <span class="comment">// the Direct Draw object has been initialized already</span>
00124         <span class="keywordflow">return</span> TRUE;
00125 
00126     <span class="comment">//--------- Create direct draw object --------//</span>
00127 
00128     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"Attempt DirectDrawCreate"</span>);
00129     LPDIRECTDRAW dd1Obj;
00130     <span class="keywordtype">int</span> rc = DirectDrawCreate( <a class="code" href="OHELP_8H.html#a0">NULL</a>, &amp;dd1Obj, <a class="code" href="OHELP_8H.html#a0">NULL</a> );
00131     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"DirectDrawCreate finish"</span>);
00132 
00133     <span class="keywordflow">if</span>( rc != DD_OK ) {
00134 <span class="preprocessor">#ifdef DEBUG</span>
00135 <span class="preprocessor"></span>        debug_msg(<span class="stringliteral">"DirectDrawCreate failed err=%d"</span>, rc);
00136 <span class="preprocessor">#endif</span>
00137 <span class="preprocessor"></span>        <span class="keywordflow">return</span> FALSE;
00138     }
00139 
00140     <span class="comment">//-------- Query DirectDraw2 interface --------//</span>
00141 
00142     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"Attempt Query DirectDraw4"</span>);
00143     rc = dd1Obj-&gt;QueryInterface(IID_IDirectDraw4, (<span class="keywordtype">void</span> **)&amp;<a class="code" href="classVga.html#m0">dd_obj</a>);
00144     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"Query DirectDraw4 finish"</span>);
00145     <span class="keywordflow">if</span>( rc != DD_OK ) {
00146 <span class="preprocessor">#ifdef DEBUG</span>
00147 <span class="preprocessor"></span>        debug_msg(<span class="stringliteral">"Query DirectDraw4 failed err=%d"</span>, rc);
00148 <span class="preprocessor">#endif</span>
00149 <span class="preprocessor"></span>        dd1Obj-&gt;Release();
00150         <span class="keywordflow">return</span> FALSE;
00151     }
00152 
00153     dd1Obj-&gt;Release();
00154 
00155     <span class="comment">//-----------------------------------------------------------//</span>
00156     <span class="comment">// Convert it to a plain window</span>
00157     <span class="comment">//-----------------------------------------------------------//</span>
00158 
00159     DWORD   dwStyle;
00160     dwStyle = GetWindowStyle(sys.main_hwnd);
00161     dwStyle |= WS_POPUP;
00162     dwStyle &amp;= ~(WS_OVERLAPPED | WS_CAPTION | WS_THICKFRAME | WS_MINIMIZEBOX);
00163     SetWindowLong(sys.main_hwnd, GWL_STYLE, dwStyle);
00164 
00165     <span class="comment">//-----------------------------------------------------------//</span>
00166     <span class="comment">// grab exclusive mode if we are going to run as fullscreen</span>
00167     <span class="comment">// otherwise grab normal mode.</span>
00168     <span class="comment">//-----------------------------------------------------------//</span>
00169 
00170     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"Attempt DirectDraw SetCooperativeLevel"</span>);
00171 
00172     <span class="keywordflow">if</span>( sys.use_true_front == 2 ) {                 <span class="comment">// window mode</span>
00173         rc = <a class="code" href="classVga.html#m0">dd_obj</a>-&gt;SetCooperativeLevel( sys.main_hwnd,
00174                                           DDSCL_NORMAL );
00175     }
00176     <span class="keywordflow">else</span> {
00177         rc = <a class="code" href="classVga.html#m0">dd_obj</a>-&gt;SetCooperativeLevel( sys.main_hwnd,
00178                                           DDSCL_EXCLUSIVE |
00179                                           DDSCL_FULLSCREEN );
00180     }
00181 
00182     <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"DirectDraw SetCooperativeLevel finish"</span>);
00183 
00184     <span class="keywordflow">if</span>( rc != DD_OK ) {
00185 <span class="preprocessor">#ifdef DEBUG</span>
00186 <span class="preprocessor"></span>        debug_msg(<span class="stringliteral">"SetCooperativeLevel failed err=%d"</span>, rc);
00187 <span class="preprocessor">#endif</span>
00188 <span class="preprocessor"></span>        <span class="keywordflow">return</span> FALSE;
00189     }
00190 
00191     <span class="keywordflow">return</span> TRUE;
00192 }
00193 
00194 <span class="comment">//-------- End of function Vga::init_dd ----------//</span>
00195 
00196 <span class="comment">//-------- Begin of function Vga::set_mode ----------//</span>
00197 
<a name="l00198"></a><a class="code" href="classVga.html#a4">00198</a> BOOL <a class="code" href="classVga.html#a4">Vga::set_mode</a>(<span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h) {
00199     HRESULT rc;
00200 
00201     <span class="keywordflow">if</span>( sys.use_true_front == 2 ) {                 <span class="comment">// window mode</span>
00202     }
00203     <span class="keywordflow">else</span> {
00204 
00205         <span class="comment">//-------------- set Direct Draw mode ---------------//</span>
00206 
00207         <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"Attempt DirectDraw SetDisplayMode"</span>);
00208         <span class="comment">// IDirectDraw2::SetDisplayMode requires 5 parameters</span>
00209         rc = <a class="code" href="classVga.html#m0">dd_obj</a>-&gt;SetDisplayMode( w, h, <a class="code" href="OVGA_8H.html#a2">VGA_BPP</a>, 0, 0);
00210         <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"DirectDraw SetDisplayMode finish"</span>);
00211 
00212         <span class="keywordflow">if</span>( rc != DD_OK ) {
00213 <span class="preprocessor">#ifdef DEBUG</span>
00214 <span class="preprocessor"></span>            debug_msg(<span class="stringliteral">"SetMode failed err=%d"</span>, rc);
00215 <span class="preprocessor">#endif</span>
00216 <span class="preprocessor"></span>            <span class="keywordflow">return</span> FALSE;
00217         }
00218     }
00219 
00220     <span class="comment">//----------- get the pixel format flag -----------//</span>
00221 
00222     DDSURFACEDESC2 ddsd;
00223     memset(&amp;ddsd, 0, <span class="keyword">sizeof</span>(ddsd) );
00224     ddsd.dwSize = <span class="keyword">sizeof</span>(ddsd);
00225 
00226     <a class="code" href="classVga.html#m5">pixel_format_flag</a> = -1;
00227 
00228     <span class="keywordflow">if</span>( <a class="code" href="classVga.html#m0">dd_obj</a>-&gt;GetDisplayMode(&amp;ddsd) == DD_OK &amp;&amp; ddsd.dwFlags &amp; DDSD_PIXELFORMAT ) {
00229         <span class="keywordflow">if</span>( ddsd.ddpfPixelFormat.dwFlags &amp; DDPF_RGB
00230             &amp;&amp; ddsd.ddpfPixelFormat.dwRGBBitCount == (DWORD)<a class="code" href="OVGA_8H.html#a2">VGA_BPP</a> ) {
00231             <span class="keywordflow">if</span>( ddsd.ddpfPixelFormat.dwRBitMask == 0x001fL
00232                 &amp;&amp; ddsd.ddpfPixelFormat.dwGBitMask == 0x001fL &lt;&lt; 5
00233                 &amp;&amp; ddsd.ddpfPixelFormat.dwBBitMask == 0x001fL &lt;&lt; 10 ) {
00234                 <a class="code" href="classVga.html#m5">pixel_format_flag</a> = <a class="code" href="IMGFUN_8H.html#a32a0">PIXFORM_RGB_555</a>;
00235             }
00236             <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ddsd.ddpfPixelFormat.dwRBitMask == 0x001fL
00237                      &amp;&amp; ddsd.ddpfPixelFormat.dwGBitMask == 0x003fL &lt;&lt; 5
00238                      &amp;&amp; ddsd.ddpfPixelFormat.dwBBitMask == 0x001fL &lt;&lt; 11 ) {
00239                 <a class="code" href="classVga.html#m5">pixel_format_flag</a> = <a class="code" href="IMGFUN_8H.html#a32a1">PIXFORM_RGB_565</a>;
00240             }
00241             <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ddsd.ddpfPixelFormat.dwBBitMask == 0x001fL
00242                      &amp;&amp; ddsd.ddpfPixelFormat.dwGBitMask == 0x001fL &lt;&lt; 5
00243                      &amp;&amp; ddsd.ddpfPixelFormat.dwRBitMask == 0x001fL &lt;&lt; 10 ) {
00244                 <a class="code" href="classVga.html#m5">pixel_format_flag</a> = <a class="code" href="IMGFUN_8H.html#a32a2">PIXFORM_BGR_555</a>;
00245             }
00246             <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ddsd.ddpfPixelFormat.dwBBitMask == 0x001fL
00247                      &amp;&amp; ddsd.ddpfPixelFormat.dwGBitMask == 0x003fL &lt;&lt; 5
00248                      &amp;&amp; ddsd.ddpfPixelFormat.dwRBitMask == 0x001fL &lt;&lt; 11 ) {
00249                 <a class="code" href="classVga.html#m5">pixel_format_flag</a> = <a class="code" href="IMGFUN_8H.html#a32a3">PIXFORM_BGR_565</a>;
00250             }
00251         }
00252 
00253         <span class="keywordflow">if</span>( sys.use_true_front == 2 ) {               <span class="comment">// window mode</span>
00254             <span class="keywordflow">if</span>( ddsd.dwWidth &lt; <a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a> || ddsd.dwHeight &lt; <a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a> ) {
00255                 MessageBox( sys.main_hwnd, <span class="stringliteral">"Desktop resolution too small"</span>,
00256                             <a class="code" href="Gamedef_8h.html#a3">WIN_TITLE</a>, MB_OK | MB_ICONWARNING | MB_SETFOREGROUND );
00257                 <span class="keywordflow">return</span> FALSE;
00258             }
00259         }
00260     }
00261 
00262     <span class="keywordflow">if</span>( <a class="code" href="classVga.html#m5">pixel_format_flag</a> == -1 ) {
00263         MessageBox(sys.main_hwnd, <span class="stringliteral">"Cannot determine the pixel format of this display mode."</span>,
00264                    <a class="code" href="Gamedef_8h.html#a3">WIN_TITLE</a>, MB_OK | MB_ICONWARNING | MB_SETFOREGROUND );
00265 
00266         <span class="keywordflow">if</span>( sys.use_true_front == 2 ) {               <span class="comment">// window mode</span>
00267             <span class="keywordflow">return</span> FALSE;                               <span class="comment">// require supported pixel format in window mode</span>
00268         }
00269 
00270         <a class="code" href="classVga.html#m5">pixel_format_flag</a> = <a class="code" href="IMGFUN_8H.html#a32a3">PIXFORM_BGR_565</a>;
00271     }
00272 
00273     <span class="comment">// assembly functions to initalize effect processing</span>
00274 
00275     <a class="code" href="IMGFUN_8H.html#a4">INITeffect</a>(<a class="code" href="classVga.html#m5">pixel_format_flag</a>);
00276     <a class="code" href="IMGFUN_8H.html#a5">INITbright</a>(<a class="code" href="classVga.html#m5">pixel_format_flag</a>);
00277 
00278     <span class="comment">//----------- display the system cursor -------------//</span>
00279 
00280     SetCursor(<a class="code" href="OHELP_8H.html#a0">NULL</a>);
00281 
00282     <span class="keywordflow">return</span> TRUE;
00283 }
00284 
00285 <span class="comment">//-------- End of function Vga::set_mode ----------//</span>
00286 
00287 <span class="comment">//-------- Begin of function Vga::deinit ----------//</span>
00288 
<a name="l00289"></a><a class="code" href="classVga.html#a5">00289</a> <span class="keywordtype">void</span> <a class="code" href="classVga.html#a5">Vga::deinit</a>() {
00290     <span class="comment">// ##### begin Gilbert 26/04/2001 ######//</span>
00291     <span class="comment">// %% Begin Ho0909</span>
00292     <span class="comment">//  if(mouse_back_buffer_storage_bitmap)</span>
00293     <span class="comment">//  {       mem_del(mouse_back_buffer_storage_bitmap);</span>
00294     <span class="comment">//          mouse_back_buffer_storage_bitmap=NULL;</span>
00295     <span class="comment">//  }</span>
00296     <span class="comment">// %% End Ho0909</span>
00297     <span class="comment">// ##### end Gilbert 26/04/2001 ######//</span>
00298 
00299     <a class="code" href="classVga.html#a10">release_pal</a>();
00300 
00301     <span class="keywordflow">if</span>( dd_obj ) {
00302         <span class="comment">//DEBUG_LOG("Attempt vga.dd_obj-&gt;RestoreDisplayMode()");</span>
00303         <span class="comment">// dd_obj-&gt;RestoreDisplayMode();</span>
00304         <span class="comment">//DEBUG_LOG("vga.dd_obj-&gt;RestoreDisplayMode() finish");</span>
00305 
00306         <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"Attempt vga.dd_obj-&gt;Release()"</span>);
00307         <a class="code" href="classVga.html#m0">dd_obj</a>-&gt;Release();
00308         <a class="code" href="OLOG_8H.html#a6">DEBUG_LOG</a>(<span class="stringliteral">"vga.dd_obj-&gt;Release() finish"</span>);
00309         <a class="code" href="classVga.html#m0">dd_obj</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00310     }
00311 
00312 }
00313 
00314 <span class="comment">//-------- End of function Vga::deinit ----------//</span>
00315 
00316 <span class="comment">//--------- Start of function Vga::load_pal ----------//</span>
00317 <span class="comment">//</span>
00318 <span class="comment">// Load the palette from a file and set it to the front buf.</span>
00319 <span class="comment">//</span>
<a name="l00320"></a><a class="code" href="classVga.html#a7">00320</a> BOOL <a class="code" href="classVga.html#a7">Vga::load_pal</a>(<span class="keywordtype">char</span>* fileName) {
00321     <span class="keywordtype">char</span> palBuf[256][3];
00322     <a class="code" href="classFile.html">File</a> palFile;
00323 
00324     palFile.<a class="code" href="classFile.html#a2">file_open</a>(fileName);
00325     palFile.<a class="code" href="classFile.html#a7">file_seek</a>(8);                           <span class="comment">// bypass the header info</span>
00326     palFile.<a class="code" href="classFile.html#a9">file_read</a>(palBuf, 256*3);
00327     palFile.<a class="code" href="classFile.html#a5">file_close</a>();
00328 
00329     <span class="comment">//--- Create a Direct Draw Palette and associate it with the front buffer ---//</span>
00330 
00331     <span class="keywordflow">if</span>( <a class="code" href="classVga.html#m1">dd_pal</a> == <a class="code" href="OHELP_8H.html#a0">NULL</a> ) {
00332         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;256; i++) {
00333             <a class="code" href="classVga.html#m2">pal_entry_buf</a>[i].peRed   = palBuf[i][0];
00334             <a class="code" href="classVga.html#m2">pal_entry_buf</a>[i].peGreen = palBuf[i][1];
00335             <a class="code" href="classVga.html#m2">pal_entry_buf</a>[i].peBlue  = palBuf[i][2];
00336         }
00337 
00338         HRESULT rc = <a class="code" href="classVga.html#m0">dd_obj</a>-&gt;CreatePalette( DDPCAPS_8BIT, <a class="code" href="classVga.html#m2">pal_entry_buf</a>, &amp;<a class="code" href="classVga.html#m1">dd_pal</a>, <a class="code" href="OHELP_8H.html#a0">NULL</a> );
00339 
00340         <span class="keywordflow">if</span>( rc != DD_OK )
00341             <span class="keywordflow">return</span> FALSE;
00342     }
00343 
00344     init_color_table();
00345     <a class="code" href="classVga.html#a8">init_gray_remap_table</a>();
00346 
00347     <span class="comment">// set global variable</span>
00348     <a class="code" href="ovga_8cpp.html#a6">transparent_code_w</a> = <a class="code" href="classVga.html#a22">translate_color</a>(<a class="code" href="COLCODE_8H.html#a0">TRANSPARENT_CODE</a>);
00349 
00350     <span class="keywordflow">return</span> TRUE;
00351 }
00352 
00353 <span class="comment">//----------- End of function Vga::load_pal ----------//</span>
00354 
00355 <span class="comment">//--------- Start of function Vga::init_color_table ----------//</span>
00356 
00357 <span class="keywordtype">void</span> Vga::init_color_table() {
00358     <span class="comment">//----- initialize interface color table -----//</span>
00359 
00360     <a class="code" href="structPalDesc.html">PalDesc</a> palDesc( (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*) <a class="code" href="classVga.html#m2">pal_entry_buf</a>, <span class="keyword">sizeof</span>(PALETTEENTRY), 256, 8);
00361     <a class="code" href="classVga.html#m3">vga_color_table</a>-&gt;<a class="code" href="classColorTable.html#a9">generate_table_fast</a>( <a class="code" href="OVGA_8H.html#a3">MAX_BRIGHTNESS_ADJUST_DEGREE</a>, palDesc, <a class="code" href="classColorTable.html#d0">ColorTable::bright_func</a> );
00362 
00363     <a class="code" href="classVga.html#m6">default_remap_table</a> = (<span class="keywordtype">short</span> *)<a class="code" href="classVga.html#m3">vga_color_table</a>-&gt;<a class="code" href="classColorTable.html#a11">get_table</a>(0);
00364 }
00365 
00366 <span class="comment">//----------- End of function Vga::init_color_table ----------//</span>
00367 
00368 <span class="comment">//--------- Start of function Vga::release_pal ----------//</span>
00369 
<a name="l00370"></a><a class="code" href="classVga.html#a10">00370</a> <span class="keywordtype">void</span> <a class="code" href="classVga.html#a10">Vga::release_pal</a>() {
00371     <span class="comment">// ##### begin Gilbert 16/9 #######//</span>
00372     <span class="keywordflow">if</span>( dd_pal ) {
00373         <span class="keywordflow">while</span>( <a class="code" href="classVga.html#m1">dd_pal</a>-&gt;Release() );
00374         <a class="code" href="classVga.html#m1">dd_pal</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00375     }
00376     <span class="comment">// ##### end Gilbert 16/9 #######//</span>
00377 }
00378 
00379 <span class="comment">//----------- End of function Vga::release_pal ----------//</span>
00380 
00381 <span class="comment">//-------- Begin of function Vga::activate_pal ----------//</span>
<a name="l00385"></a><a class="code" href="classVga.html#a9">00385</a> <span class="comment">void Vga::activate_pal(VgaBuf* vgaBufPtr) {</span>
00386     vgaBufPtr-&gt;activate_pal(dd_pal);
00387 }
00388 
00389 <span class="comment">//--------- End of function Vga::activate_pal ----------//</span>
00390 
00391 <span class="comment">//-------- Begin of function Vga::adjust_brightness ----------//</span>
<a name="l00399"></a><a class="code" href="classVga.html#a16">00399</a> <span class="comment">void Vga::adjust_brightness(int changeValue) {</span>
00400     <span class="comment">//---- find out the maximum rgb value can change without affecting the contrast ---//</span>
00401 
00402     <span class="keywordtype">int</span>          i;
00403     <span class="keywordtype">int</span>          newRed, newGreen, newBlue;
00404     PALETTEENTRY palBuf[256];
00405 
00406     <span class="comment">//------------ change palette now -------------//</span>
00407 
00408     <span class="keywordflow">for</span>( i=0 ; i&lt;256 ; i++ ) {
00409         newRed   = (int)pal_entry_buf[i].peRed   + changeValue;
00410         newGreen = (int)pal_entry_buf[i].peGreen + changeValue;
00411         newBlue  = (int)pal_entry_buf[i].peBlue  + changeValue;
00412 
00413         palBuf[i].peRed   = min(255, max(newRed,0) );
00414         palBuf[i].peGreen = min(255, max(newGreen,0) );
00415         palBuf[i].peBlue  = min(255, max(newBlue,0) );
00416     }
00417 
00418     <span class="comment">//------------ set palette ------------//</span>
00419 
00420     vga_front.<a class="code" href="classVgaBuf.html#a19">temp_unlock</a>();
00421 
00422     dd_pal-&gt;SetEntries( 0, 0, 256, palBuf );
00423 
00424     vga_front.<a class="code" href="classVgaBuf.html#a20">temp_restore_lock</a>();
00425 }
00426 
00427 <span class="comment">//--------- End of function Vga::adjust_brightness ----------//</span>
00428 
00429 <span class="comment">//--------- Begin of function Vga::blt_buf ----------//</span>
00438 <span class="comment"></span>
<a name="l00439"></a><a class="code" href="classVga.html#a19">00439</a> BOOL <a class="code" href="classVga.html#a19">Vga::blt_buf</a>(<span class="keywordtype">int</span> x1, <span class="keywordtype">int</span> y1, <span class="keywordtype">int</span> x2, <span class="keywordtype">int</span> y2, <span class="keywordtype">int</span> putBackCursor) {
00440     <span class="comment">// ## Begin chwg 021999:: do nothing while using on-line help or pop-up news.</span>
00441     <span class="keywordflow">if</span> (dont_blt) <span class="keywordflow">return</span> FALSE;
00442     <span class="keywordflow">if</span> (sys.no_true_output_flag) <span class="keywordflow">return</span> FALSE;
00443     <span class="comment">// ## End chwg 021999</span>
00444 
00445     <span class="keywordtype">int</span> restoreCursor = 0;
00446     <span class="keywordtype">short</span> mouseBackBufferStorageBitmap[2+64*64];    <span class="comment">// size for 64x64 bitmap</span>
00447 
00448     <span class="keywordflow">if</span>( putBackCursor ) {
00449         <span class="comment">// ##### begin Gilbert 24/04/2001 ######//</span>
00450         <span class="comment">// reduce save area here</span>
00451         <span class="keywordflow">if</span>( !mouse_cursor.hide_all_flag &amp;&amp; mouse_cursor.cur_icon
00452             &amp;&amp; m.is_touch(x1,y1,x2,y2, mouse_cursor.cur_x1,mouse_cursor.cur_y1,mouse_cursor.cur_x2,mouse_cursor.cur_y2) ) {
00453             mouse_cursor.hide_area_flag = 0;            <span class="comment">// do not call mouse.hide_area() which will double paint the cursor</span>
00454 
00455             mouse_cursor.hide_x1 = x1;
00456             mouse_cursor.hide_y1 = y1;
00457             mouse_cursor.hide_x2 = x2;
00458             mouse_cursor.hide_y2 = y2;
00459 
00460             <span class="comment">//-------- put mouse cursor ---------//</span>
00461             <span class="comment">// ## Begin chwg 0909:: save area</span>
00462             <span class="comment">//if(mouse_back_buffer_storage_bitmap)</span>
00463             <span class="comment">//{ mem_del(mouse_back_buffer_storage_bitmap);</span>
00464             <span class="comment">//mouse_back_buffer_storage_bitmap=NULL;</span>
00465             <span class="comment">//}</span>
00466             <span class="comment">// mouse_back_buffer_storage_bitmap=vga_back.save_area(x1, y1, x2, y2, mouse_back_buffer_storage_bitmap);</span>
00467             <span class="comment">// backup the overlap area</span>
00468             <a class="code" href="ALL_8H.html#a0">err_when</a>( <a class="code" href="classBitmapW.html#a7">BitmapW::size</a>(min(x2,mouse_cursor.cur_x2)-max(x1,mouse_cursor.cur_x1)+1,min(y2,mouse_cursor.cur_y2)-max(y1,mouse_cursor.cur_y1)) &gt; <span class="keyword">sizeof</span>(mouseBackBufferStorageBitmap) );
00469             vga_back.read_bitmapW( max(x1,mouse_cursor.cur_x1), max(y1,mouse_cursor.cur_y1),
00470                                    min(x2,mouse_cursor.cur_x2), min(y2,mouse_cursor.cur_y2), mouseBackBufferStorageBitmap );
00471             <span class="comment">// ## End chwg 0909</span>
00472             mouse_cursor.disp_back_buf(x1, y1, x2, y2);
00473             restoreCursor = 1;                          <span class="comment">// rest_area mouse_back_buffer_storage_bitmap later</span>
00474         }
00475         <span class="comment">// ##### end Gilbert 24/04/2001 ######//</span>
00476     }
00477     <span class="keywordflow">else</span> {
00478         mouse.hide_area(x1, y1, x2, y2);
00479     }
00480 
00481     <span class="comment">//--------------------------------------//</span>
00482     <span class="comment">// ###### begin Gilbert 12/9 #######//</span>
00483     <span class="comment">//  vga_front.blt_buf_fast( &amp;vga_back, x1, y1, x2, y2 );</span>
00484     <span class="comment">// use directx blt function</span>
00485     vga_front.<a class="code" href="classVgaBuf.html#a19">temp_unlock</a>();
00486     vga_back.temp_unlock();
00487     RECT rect = { x1, y1, x2+1, y2+1 };
00488     vga_front.<a class="code" href="classVgaBuf.html#m0">dd_buf</a>-&gt;BltFast( x1, y1, vga_back.dd_buf, &amp;rect, DDBLTFAST_NOCOLORKEY );
00489     vga_back.temp_restore_lock();
00490     vga_front.<a class="code" href="classVgaBuf.html#a20">temp_restore_lock</a>();
00491     <span class="comment">// ###### end Gilbert 12/10 #######//</span>
00492     <span class="comment">//--------------------------------------//</span>
00493 
00494     <span class="keywordflow">if</span>( putBackCursor ) {
00495         <span class="comment">// ##### begin Gilbert 24/04/2001 #####//</span>
00496         <span class="keywordflow">if</span>( restoreCursor ) {
00497             <span class="comment">// %% Begin Ho 0909:: restore the damaged back buffer</span>
00498             <span class="comment">// vga_back.rest_area(mouse_back_buffer_storage_bitmap,0,0);</span>
00499             <span class="comment">// %%End Ho 0909</span>
00500             vga_back.put_bitmapW( max(x1,mouse_cursor.cur_x1), max(y1,mouse_cursor.cur_y1),
00501                                   mouseBackBufferStorageBitmap );
00502             mouse_cursor.hide_area_flag = 0;            <span class="comment">// do not call mouse.show_area() which will double paint the cursor</span>
00503         }
00504         <span class="comment">// ##### end Gilbert 24/04/2001 #####//</span>
00505     }
00506     <span class="keywordflow">else</span> {
00507         mouse.show_area();
00508     }
00509     <span class="keywordflow">return</span> TRUE;
00510 }
00511 
00512 <span class="comment">//---------- End of function Vga::blt_buf ----------//</span>
00513 
00514 <span class="comment">//----------- Begin of function Vga::d3_panel_up ------------//</span>
<a name="l00522"></a><a class="code" href="classVga.html#a11">00522</a> <span class="comment">void Vga::d3_panel_up(int x1,int y1,int x2,int y2,int vgaFrontOnly,int drawBorderOnly) {</span>
00523     <a class="code" href="ALL_8H.html#a0">err_when</a>( x1&gt;x2 || y1&gt;y2 || x1&lt;0 || y1&lt;0 || x2&gt;=<a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a> || y2&gt;=<a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a> );
00524 
00525     <a class="code" href="classVgaBuf.html">VgaBuf</a>* vgaBuf;
00526 
00527     <span class="keywordflow">if</span>( vgaFrontOnly )
00528         vgaBuf = &amp;vga_front;
00529     <span class="keywordflow">else</span>
00530         vgaBuf = &amp;vga_back;
00531 
00532     <span class="keywordflow">if</span>(sys.no_true_output_flag)
00533         vgaBuf = &amp;vga_back;
00534 
00535     <span class="keywordflow">if</span>( !drawBorderOnly ) {
00536         <span class="keywordflow">if</span>( Vga::opaque_flag )
00537             vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a27">bar</a>(x1+1, y1+1, x2-1, y2-1, <a class="code" href="ovga_8cpp.html#a1">UP_OPAQUE_COLOR</a>);
00538         <span class="keywordflow">else</span>
00539             vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a46">adjust_brightness</a>(x1+1, y1+1, x2-1, y2-1, <a class="code" href="OVGA_8H.html#a6">IF_UP_BRIGHTNESS_ADJUST</a>);
00540     }
00541 
00542     mouse.hide_area( x1,y1,x2,y2 );
00543 
00544     <span class="comment">//--------- white border on top and left sides -----------//</span>
00545 
00546     <span class="comment">// top side</span>
00547     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x1+1,y1,x2,y1, <a class="code" href="OVGA_8H.html#a4">IF_LIGHT_BORDER_COLOR</a> );
00548     <span class="comment">// left side</span>
00549     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x1,y1,x1,y2  , <a class="code" href="OVGA_8H.html#a4">IF_LIGHT_BORDER_COLOR</a> );
00550 
00551     <span class="comment">//--------- black border on bottom and right sides -----------//</span>
00552 
00553     <span class="comment">// bottom side</span>
00554     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x1+1,y2,x2,y2, <a class="code" href="OVGA_8H.html#a5">IF_DARK_BORDER_COLOR</a> );
00555     <span class="comment">// right side</span>
00556     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x2,y1+1,x2,y2, <a class="code" href="OVGA_8H.html#a5">IF_DARK_BORDER_COLOR</a> );
00557 
00558     <span class="comment">//-------------------------------------------//</span>
00559 
00560     mouse.show_area();
00561 
00562     <span class="comment">//----- blt the area from the back buffer to the front buffer ------//</span>
00563 
00564     <span class="keywordflow">if</span>( !vgaFrontOnly &amp;&amp; !use_back_buf )            <span class="comment">// only blt the back to the front is the active buffer is the front</span>
00565         vga.blt_buf(x1, y1, x2, y2, 0);
00566 }
00567 
00568 <span class="comment">//------------- End of function Vga::d3_panel_up ------------//</span>
00569 
00570 <span class="comment">//----------- Begin of function Vga::d3_panel_down ------------//</span>
<a name="l00578"></a><a class="code" href="classVga.html#a12">00578</a> <span class="comment">void Vga::d3_panel_down(int x1,int y1,int x2,int y2,int vgaFrontOnly,int drawBorderOnly) {</span>
00579     <a class="code" href="ALL_8H.html#a0">err_when</a>( x1&gt;x2 || y1&gt;y2 || x1&lt;0 || y1&lt;0 || x2&gt;=<a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a> || y2&gt;=<a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a> );
00580 
00581     <a class="code" href="classVgaBuf.html">VgaBuf</a>* vgaBuf;
00582 
00583     <span class="keywordflow">if</span>( vgaFrontOnly )
00584         vgaBuf = &amp;vga_front;
00585     <span class="keywordflow">else</span>
00586         vgaBuf = &amp;vga_back;
00587 
00588     <span class="keywordflow">if</span>(sys.no_true_output_flag)
00589         vgaBuf = &amp;vga_back;
00590 
00591     <span class="keywordflow">if</span>( !drawBorderOnly ) {
00592         <span class="keywordflow">if</span>( Vga::opaque_flag )
00593             vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a27">bar</a>(x1+1, y1+1, x2-1, y2-1, <a class="code" href="ovga_8cpp.html#a2">DOWN_OPAQUE_COLOR</a>);
00594         <span class="keywordflow">else</span>
00595             vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a46">adjust_brightness</a>(x1+1, y1+1, x2-1, y2-1, <a class="code" href="OVGA_8H.html#a7">IF_DOWN_BRIGHTNESS_ADJUST</a>);
00596     }
00597 
00598     mouse.hide_area( x1,y1,x2,y2 );
00599 
00600     <span class="comment">//--------- white border on top and left sides -----------//</span>
00601 
00602     <span class="comment">// top side</span>
00603     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x1+1,y1,x2,y1, <a class="code" href="OVGA_8H.html#a5">IF_DARK_BORDER_COLOR</a> );
00604     <span class="comment">// left side</span>
00605     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x1,y1,x1,y2  , <a class="code" href="OVGA_8H.html#a5">IF_DARK_BORDER_COLOR</a> );
00606 
00607     <span class="comment">//--------- black border on bottom and right sides -----------//</span>
00608 
00609     <span class="comment">// bottom side</span>
00610     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x1+1,y2,x2,y2, <a class="code" href="OVGA_8H.html#a4">IF_LIGHT_BORDER_COLOR</a> );
00611     <span class="comment">// right side</span>
00612     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x2,y1+1,x2,y2, <a class="code" href="OVGA_8H.html#a4">IF_LIGHT_BORDER_COLOR</a> );
00613 
00614     <span class="comment">//-------------------------------------------//</span>
00615 
00616     mouse.show_area();
00617 
00618     <span class="comment">//----- blt the area from the back buffer to the front buffer ------//</span>
00619 
00620     <span class="keywordflow">if</span>( !vgaFrontOnly &amp;&amp; !use_back_buf )            <span class="comment">// only blt the back to the front is the active buffer is the front</span>
00621         vga.blt_buf(x1, y1, x2, y2, 0);
00622 }
00623 
00624 <span class="comment">//------------- End of function Vga::d3_panel_down ------------//</span>
00625 
00626 <span class="comment">//----------- Begin of function Vga::d3_panel2_up ------------//</span>
<a name="l00634"></a><a class="code" href="classVga.html#a13">00634</a> <span class="comment">void Vga::d3_panel2_up(int x1,int y1,int x2,int y2,int vgaFrontOnly,int drawBorderOnly) {</span>
00635     <a class="code" href="ALL_8H.html#a0">err_when</a>( x1&gt;x2 || y1&gt;y2 || x1&lt;0 || y1&lt;0 || x2&gt;=<a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a> || y2&gt;=<a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a> );
00636 
00637     <a class="code" href="classVgaBuf.html">VgaBuf</a>* vgaBuf;
00638 
00639     <span class="keywordflow">if</span>( vgaFrontOnly )
00640         vgaBuf = &amp;vga_front;
00641     <span class="keywordflow">else</span>
00642         vgaBuf = &amp;vga_back;
00643 
00644     <span class="keywordflow">if</span>(sys.no_true_output_flag)
00645         vgaBuf = &amp;vga_back;
00646 
00647     <span class="keywordflow">if</span>( !drawBorderOnly )
00648         vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a46">adjust_brightness</a>(x1+2, y1+2, x2-3, y2-3, <a class="code" href="OVGA_8H.html#a6">IF_UP_BRIGHTNESS_ADJUST</a>);
00649 
00650     mouse.hide_area( x1,y1,x2,y2 );
00651 
00652     <span class="comment">//--------- white border on top and left sides -----------//</span>
00653 
00654     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x1,y1,x2-3,y1+1,0x9a );
00655     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x2-2, y1, 0x9a);
00656     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x1,y1+2,x1+1,y2-3, 0x9a );    <span class="comment">// left side</span>
00657     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x1, y2-2, 0x9a);
00658 
00659     <span class="comment">//--------- black border on bottom and right sides -----------//</span>
00660 
00661     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x2-2,y1+2,x2-1,y2-1, 0x90 );  <span class="comment">// bottom side</span>
00662     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x2-1, y1+1, 0x90);
00663     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x1+2,y2-2,x2-3,y2-1, 0x90 );  <span class="comment">// right side</span>
00664     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x1+1, y2-1, 0x90);
00665 
00666     <span class="comment">//--------- junction between white and black border --------//</span>
00667     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x2-1, y1, 0x97);
00668     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x2-2, y1+1, 0x97);
00669     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x1, y2-1, 0x97);
00670     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x1+1, y2-2, 0x97);
00671 
00672     <span class="comment">//--------- gray shadow on bottom and right sides -----------//</span>
00673     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x2, y1+1, x2, y2, 0x97);
00674     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x1+1, y2, x2-1, y2, 0x97);
00675 
00676     <span class="comment">//-------------------------------------------//</span>
00677 
00678     mouse.show_area();
00679 
00680     <span class="comment">//----- blt the area from the back buffer to the front buffer ------//</span>
00681 
00682     <span class="keywordflow">if</span>( !vgaFrontOnly &amp;&amp; !use_back_buf )            <span class="comment">// only blt the back to the front is the active buffer is the front</span>
00683         vga.blt_buf(x1, y1, x2, y2, 0);
00684 }
00685 
00686 <span class="comment">//------------- End of function Vga::d3_panel_up ------------//</span>
00687 
00688 <span class="comment">//----------- Begin of function Vga::d3_panel2_down ------------//</span>
<a name="l00696"></a><a class="code" href="classVga.html#a14">00696</a> <span class="comment">void Vga::d3_panel2_down(int x1,int y1,int x2,int y2,int vgaFrontOnly,int drawBorderOnly) {</span>
00697     <a class="code" href="ALL_8H.html#a0">err_when</a>( x1&gt;x2 || y1&gt;y2 || x1&lt;0 || y1&lt;0 || x2&gt;=<a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a> || y2&gt;=<a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a> );
00698 
00699     <a class="code" href="classVgaBuf.html">VgaBuf</a>* vgaBuf;
00700 
00701     <span class="keywordflow">if</span>( vgaFrontOnly )
00702         vgaBuf = &amp;vga_front;
00703     <span class="keywordflow">else</span>
00704         vgaBuf = &amp;vga_back;
00705 
00706     <span class="keywordflow">if</span>(sys.no_true_output_flag)
00707         vgaBuf = &amp;vga_back;
00708 
00709     <span class="keywordflow">if</span>( !drawBorderOnly )
00710         vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a46">adjust_brightness</a>(x1+2, y1+2, x2-3, y2-3, <a class="code" href="OVGA_8H.html#a7">IF_DOWN_BRIGHTNESS_ADJUST</a>);
00711 
00712     mouse.hide_area( x1,y1,x2,y2 );
00713 
00714     <span class="comment">//--------- black border on top and left sides -----------//</span>
00715 
00716     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x1,y1,x2-3,y1+1,0x90 );
00717     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x2-2, y1, 0x90);
00718     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x1,y1+2,x1+1,y2-3, 0x90 );    <span class="comment">// left side</span>
00719     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x1, y2-2, 0x90);
00720 
00721     <span class="comment">//--------- while border on bottom and right sides -----------//</span>
00722 
00723     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x2-2,y1+2,x2-1,y2-1, 0x9a );  <span class="comment">// bottom side</span>
00724     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x2-1, y1+1, 0x9a);
00725     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x1+2,y2-2,x2-3,y2-1, 0x9a );  <span class="comment">// right side</span>
00726     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x1+1, y2-1, 0x9a);
00727 
00728     <span class="comment">//--------- junction between white and black border --------//</span>
00729     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x2-1, y1, 0x97);
00730     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x2-2, y1+1, 0x97);
00731     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x1, y2-1, 0x97);
00732     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a32">draw_pixel</a>(x1+1, y2-2, 0x97);
00733 
00734     <span class="comment">//--------- remove shadow, copy from back  -----------//</span>
00735     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x2, y1+1, x2, y2, 0x9c);
00736     vgaBuf-&gt;<a class="code" href="classVgaBuf.html#a28">bar_fast</a>( x1+1, y2, x2-1, y2, 0x9c);
00737 
00738     mouse.show_area();
00739 
00740     <span class="comment">//----- blt the area from the back buffer to the front buffer ------//</span>
00741 
00742     <span class="keywordflow">if</span>( !vgaFrontOnly &amp;&amp; !use_back_buf )            <span class="comment">// only blt the back to the front is the active buffer is the front</span>
00743         vga.blt_buf(x1, y1, x2, y2, 0);
00744 }
00745 
00746 <span class="comment">//------------- End of function Vga::d3_panel2_down ------------//</span>
00747 
00748 <span class="comment">//------------- Start of function Vga::separator --------------//</span>
00749 <span class="comment">//</span>
00750 <span class="comment">// Draw a VGA separator line</span>
00751 <span class="comment">//</span>
00752 <span class="comment">// Syntax : separator( x1, y1, x2, y2 )</span>
00753 <span class="comment">//</span>
00754 <span class="comment">// int x1,y1       - the top left vertex of the separator</span>
00755 <span class="comment">// int x2,y2       - the bottom right vertex of the separator</span>
00756 <span class="comment">//</span>
<a name="l00757"></a><a class="code" href="classVga.html#a15">00757</a> <span class="keywordtype">void</span> <a class="code" href="classVga.html#a15">Vga::separator</a>(<span class="keywordtype">int</span> x1, <span class="keywordtype">int</span> y1, <span class="keywordtype">int</span> x2, <span class="keywordtype">int</span> y2) {
00758     <a class="code" href="ALL_8H.html#a0">err_when</a>( x1&gt;x2 || y1&gt;y2 || x1&lt;0 || y1&lt;0 || x2&gt;=<a class="code" href="OVGA_8H.html#a0">VGA_WIDTH</a> || y2&gt;=<a class="code" href="OVGA_8H.html#a1">VGA_HEIGHT</a> );
00759 
00760     <span class="keywordflow">if</span>( y1+1==y2 ) {                                <span class="comment">// horizontal line</span>
00761         vga_front.<a class="code" href="classVgaBuf.html#a46">adjust_brightness</a>(x1, y1, x2, y1, <a class="code" href="OVGA_8H.html#a6">IF_UP_BRIGHTNESS_ADJUST</a>);
00762         vga_front.<a class="code" href="classVgaBuf.html#a46">adjust_brightness</a>(x1, y2, x2, y2, <a class="code" href="OVGA_8H.html#a7">IF_DOWN_BRIGHTNESS_ADJUST</a>);
00763     }
00764     <span class="keywordflow">else</span> {
00765         vga_front.<a class="code" href="classVgaBuf.html#a46">adjust_brightness</a>(x1, y1, x1, y2, <a class="code" href="OVGA_8H.html#a6">IF_UP_BRIGHTNESS_ADJUST</a>);
00766         vga_front.<a class="code" href="classVgaBuf.html#a46">adjust_brightness</a>(x2, y1, x2, y2, <a class="code" href="OVGA_8H.html#a7">IF_DOWN_BRIGHTNESS_ADJUST</a>);
00767     }
00768 }
00769 
00770 <span class="comment">//--------------- End of function Vga::separator --------------//</span>
00771 
00772 <span class="comment">//----------- Begin of function Vga::init_gray_remap_table ----------//</span>
<a name="l00776"></a><a class="code" href="classVga.html#a8">00776</a> <span class="comment">void Vga::init_gray_remap_table() {</span>
00777     <span class="comment">//------ create a color to gray-scale remap table ------//</span>
00778 
00779 <span class="preprocessor">#define FIRST_GRAY_COLOR   0x90</span>
00780 <span class="preprocessor"></span><span class="preprocessor">#define GRAY_SCALE_COUNT   16                   // no. of gray colors</span>
00781 <span class="preprocessor"></span>
00782     <span class="comment">// #define FIRST_GRAY_COLOR   0x96</span>
00783     <span class="comment">// #define GRAY_SCALE_COUNT   10    // no. of gray colors</span>
00784 
00785     PALETTEENTRY* palEntry = vga.pal_entry_buf;
00786     <span class="keywordtype">int</span> i, grayIndex;
00787 
00788     <span class="keywordflow">for</span>( i=0 ; i&lt;256 ; i++, palEntry++ ) {
00789         <span class="comment">//--------------------------------------------------------//</span>
00790         <span class="comment">//</span>
00791         <span class="comment">// How to calculate the gray index (0-31)</span>
00792         <span class="comment">//</span>
00793         <span class="comment">// formula is : grey = red * 0.3 + green * 0.59 + blue * 0.11</span>
00794         <span class="comment">//              the range of the result value is 0-255</span>
00795         <span class="comment">//              this value is then divided by 8 to 0-31</span>
00796         <span class="comment">//</span>
00797         <span class="comment">//--------------------------------------------------------//</span>
00798 
00799         grayIndex = ((int)palEntry-&gt;peRed * 30 + (int)palEntry-&gt;peGreen * 59 +
00800                      (int)palEntry-&gt;peBlue * 11) / 100 / (256/GRAY_SCALE_COUNT);
00801 
00802         gray_remap_table[i] = FIRST_GRAY_COLOR + grayIndex;
00803     }
00804 }
00805 
00806 <span class="comment">//--------- End of function Vga::init_gray_remap_table -----------//</span>
00807 
<a name="l00808"></a><a class="code" href="classVga.html#a23">00808</a> <span class="keywordtype">int</span> <a class="code" href="classVga.html#a23">Vga::make_pixel</a>(BYTE red, BYTE green, BYTE blue) {
00809     <span class="keywordflow">return</span> <a class="code" href="IMGFUN_8H.html#a8">IMGmakePixel</a>((blue &lt;&lt; 16) + (green &lt;&lt; 8) + red);
00810 }
00811 
<a name="l00812"></a><a class="code" href="classVga.html#a24">00812</a> <span class="keywordtype">int</span> <a class="code" href="classVga.html#a23">Vga::make_pixel</a>(<a class="code" href="structRGBColor.html">RGBColor</a> *rgb) {
00813     <span class="keywordtype">int</span> u;
00814     memcpy(&amp;u, rgb, <span class="keyword">sizeof</span>(<a class="code" href="structRGBColor.html">RGBColor</a>));
00815     <span class="keywordflow">return</span> <a class="code" href="IMGFUN_8H.html#a8">IMGmakePixel</a>(u);
00816 }
00817 
<a name="l00818"></a><a class="code" href="classVga.html#a25">00818</a> <span class="keywordtype">void</span> <a class="code" href="classVga.html#a25">Vga::decode_pixel</a>(<span class="keywordtype">int</span> p, <a class="code" href="structRGBColor.html">RGBColor</a> *rgb) {
00819     <span class="keywordtype">int</span> u = <a class="code" href="IMGFUN_8H.html#a9">IMGdecodePixel</a>(p);
00820     memcpy(rgb, &amp;u, <span class="keyword">sizeof</span>(<a class="code" href="structRGBColor.html">RGBColor</a>));
00821 }
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:33 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
