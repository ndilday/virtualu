<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Ogrphtri.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Ogrphtri.cpp</h1><a href="Ogrphtri_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Filename    : OGRPHTRI.CPP</span>
00002 <span class="comment">//Description : Object GraphTrimester   (Trimester-based)</span>
00003 <span class="comment">//Owner                 : Kevin(Ho)</span>
00004 
00005 <span class="comment">// The data is updated at 1st Sep of each year.</span>
00006 <span class="preprocessor">#include &lt;<a class="code" href="ALL_8H.html">ALL.H</a>&gt;</span>
00007 <span class="preprocessor">#include &lt;<a class="code" href="COLOR_8H.html">COLOR.H</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;OINFO.H&gt;</span>
00009 <span class="preprocessor">#include &lt;OPSCHOOL.H&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="OVGA_8H.html">OVGA.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;OSYS.H&gt;</span>
00012 <span class="preprocessor">#include &lt;OFONT.H&gt;</span>
00013 <span class="preprocessor">#include &lt;OMOUSE.H&gt;</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="OGRPHTRI_8H.html">OGRPHTRI.H</a>&gt;</span>
00015 <span class="preprocessor">#include &lt;OIFACE.H&gt;</span>
00016 <span class="preprocessor">#include &lt;math.h&gt;</span>
00017 
00018 <span class="comment">//--------- Define macro constant -----------//</span>
00019 
<a name="l00020"></a><a class="code" href="Ogrphtri_8cpp.html#a0">00020</a> <span class="preprocessor">#define MAX_LEN_LABEL "00,000"</span>
00021 <span class="preprocessor"></span>
00022 <span class="keyword">static</span> <span class="keywordtype">int</span> default_series_color[] = {
00023     <a class="code" href="COLOR_8H.html#a21">V_BLUE</a>,
00024     <a class="code" href="COLOR_8H.html#a20">V_GREEN</a>,
00025     <a class="code" href="COLOR_8H.html#a19">V_RED</a>,
00026     <a class="code" href="COLOR_8H.html#a25">V_YELLOW</a>,
00027     <a class="code" href="COLOR_8H.html#a22">V_VIOLET</a>,
00028     <a class="code" href="COLOR_8H.html#a23">V_BROWN</a>,
00029     <a class="code" href="COLOR_8H.html#a18">V_ORANGE</a>,
00030     <a class="code" href="COLOR_8H.html#a24">V_PINK</a>,
00031     <a class="code" href="COLOR_8H.html#a15">V_BLACK</a>,
00032     <a class="code" href="COLOR_8H.html#a17">V_WHITE</a>,
00033 };                                                <span class="comment">// 10 default series colors</span>
00034 
00035 <span class="keyword">enum</span> {  <a class="code" href="Ogrphtri_8cpp.html#a7a2">DEFAULT_SERIES_COLOR_NUM</a> = 10 };
00036 
00037 <span class="keyword">enum</span> {
00038     <a class="code" href="Ogrphtri_8cpp.html#a8a3">LEGEND_SIZE</a> = 11,
00039     <a class="code" href="Ogrphtri_8cpp.html#a8a4">LEGEND_X_SPACING</a> = 12,
00040     <a class="code" href="Ogrphtri_8cpp.html#a8a5">LEGEND_Y_SPACING</a> = 2,
00041 };
00042 
00043 <span class="keyword">enum</span> {  <a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a> = 2         };
00044 
00045 <span class="comment">//-------------- Define static vars ------------//</span>
00046 
00047 <span class="comment">//static char paint_flag = 0;</span>
00048 
00049 <span class="comment">//-------- Begin of function GraphTrimester::GraphTrimester ----//</span>
<a name="l00051"></a><a class="code" href="classGraphTrimester.html#a0">00051</a> <span class="comment">GraphTrimester::GraphTrimester() {</span>
00052     init_flag = 0;
00053     graph_bitmap = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00054 }
00055 
00056 <span class="comment">//---------- End of function GraphTrimester::GraphTrimester ----//</span>
00057 
00058 <span class="comment">//-------- Begin of function GraphTrimester::~GraphTrimester -----//</span>
<a name="l00060"></a><a class="code" href="classGraphTrimester.html#a1">00060</a> <span class="comment">GraphTrimester::~GraphTrimester() {</span>
00061     deinit();
00062 }
00063 
00064 <span class="comment">//---------- End of function GraphTrimester::~GraphTrimester -----//</span>
00065 
00066 <span class="comment">//-------- Begin of function GraphTrimester::init --------//</span>
00100 <span class="comment">void GraphTrimester::init(int x1, int y1, int x2, int y2,</span>
00101                           <span class="keywordtype">int</span> seriesNum, <span class="keywordtype">int</span> *dataNum,
00102                           <span class="keywordtype">void</span> *dataArray, <span class="keywordtype">char</span> dataTypeFlag,
00103                           <span class="keywordtype">int</span> thisTrimesterIndicator,
00104                           <span class="keywordtype">char</span> *xLabel, <span class="keywordtype">char</span> *yLabel,
00105                           <span class="keywordtype">char</span> **legendArray, <span class="keywordtype">char</span> transparentFlag,
00106                           <span class="keywordtype">char</span> orientationFlag, <span class="keywordtype">char</span> valueFlag,
00107                           <span class="keywordtype">int</span> numFormat, <span class="keywordtype">int</span> *seriesColor, <span class="keywordtype">int</span> axisColor) {
00108     <a class="code" href="ALL_8H.html#a0">err_when</a>(seriesNum &gt; <a class="code" href="Ogrphtri_8cpp.html#a7a2">DEFAULT_SERIES_COLOR_NUM</a> &amp;&amp; !seriesColor);
00109     <a class="code" href="ALL_8H.html#a0">err_when</a>(seriesNum &lt;= 0);
00110 
00111     graph_width = x2 - x1 - 6;
00112 
00113     <a class="code" href="ALL_8H.html#a0">err_when</a>(graph_width &lt; 0);
00114 
00115     graph_x1 = x1;
00116     graph_y1 = y1;
00117     graph_x2 = x2;
00118     graph_y2 = y2;
00119     series_num = seriesNum;
00120     data_num = dataNum;
00121     data_array = dataArray;
00122     data_type_flag = dataTypeFlag;
00123 
00124     x_label = xLabel;
00125     y_label = yLabel;
00126     legend_array = legendArray;
00127 
00128     transparent_flag = transparentFlag;
00129     orientation_flag = orientationFlag;
00130     value_flag = valueFlag;
00131     num_format = numFormat;
00132 
00133     series_color = seriesColor ? seriesColor : default_series_color;
00134     axis_color = axisColor;
00135 
00136     init_flag = 1;
00137     this_trimester_indicator = thisTrimesterIndicator;
00138     y_label_max_len = font_chartsm.text_width(<a class="code" href="Ogrphtri_8cpp.html#a0">MAX_LEN_LABEL</a>);
00139     set_font(&amp;font_chartsm);
00140 }
00141 
00142 <span class="comment">//------------- End of function GraphTrimester::init -----------//</span>
00143 
00144 <span class="comment">//-------- Begin of function GraphTrimester::deinit ------------//</span>
<a name="l00146"></a><a class="code" href="classGraphTrimester.html#a7">00146</a> <span class="comment">void GraphTrimester::deinit() {</span>
00147     <span class="keywordflow">if</span> (graph_bitmap) {
00148         <a class="code" href="ALL_8H.html#a8">mem_del</a>(graph_bitmap);
00149         graph_bitmap = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00150     }
00151 
00152     init_flag = 0;
00153 }
00154 
00155 <span class="comment">//------------- End of function GraphTrimester::deinit ---------//</span>
00156 
00157 <span class="comment">//-------- Begin of function GraphTrimester::set_font ------------//</span>
<a name="l00159"></a><a class="code" href="classGraphTrimester.html#a10">00159</a> <span class="comment">void GraphTrimester::set_font(Font *fontPtr) {</span>
00160     <span class="keywordflow">if</span> (!init_flag)
00161         <span class="keywordflow">return</span>;
00162 
00163     font_ptr = fontPtr;
00164 
00165     calc_pos();
00166 }
00167 
00168 <span class="comment">//------------- End of function GraphTrimester::set_font ---------//</span>
00169 
00170 <span class="comment">//-------- Begin of function GraphTrimester::calc_pos ------------//</span>
<a name="l00175"></a><a class="code" href="classGraphTrimester.html#a11">00175</a> <span class="comment">void GraphTrimester::calc_pos() {</span>
00176     <span class="keywordflow">if</span> (legend_array) {
00177         <span class="keywordtype">short</span> textWidth = 0, textHeight = font_ptr-&gt;max_font_height;
00178 
00179         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00180             <span class="keywordflow">if</span> (font_ptr-&gt;text_width(legend_array[i]) &gt; textWidth)
00181                 textWidth = font_ptr-&gt;text_width(legend_array[i]);
00182         }
00183 
00184         <a class="code" href="ALL_8H.html#a0">err_when</a>(textWidth + <a class="code" href="Ogrphtri_8cpp.html#a8a4">LEGEND_X_SPACING</a> * 2 &gt; graph_width);
00185 
00186         legend_x_num = (graph_width - <a class="code" href="Ogrphtri_8cpp.html#a8a4">LEGEND_X_SPACING</a>*2) / (textWidth + <a class="code" href="Ogrphtri_8cpp.html#a8a4">LEGEND_X_SPACING</a>*2);
00187         legend_y_num = (series_num / legend_x_num) + ((series_num % legend_x_num) ? 1 : 0);
00188 
00189         graph_height = graph_y2 - graph_y1 - legend_y_num * (textHeight + <a class="code" href="Ogrphtri_8cpp.html#a8a5">LEGEND_Y_SPACING</a>) - 6;
00190 
00191         <a class="code" href="ALL_8H.html#a0">err_when</a>(graph_height &lt;= 0);
00192 
00193         legend_width = (graph_width - <a class="code" href="Ogrphtri_8cpp.html#a8a4">LEGEND_X_SPACING</a>*2) / legend_x_num;
00194         legend_height = textHeight + <a class="code" href="Ogrphtri_8cpp.html#a8a5">LEGEND_Y_SPACING</a>;
00195     }
00196     <span class="keywordflow">else</span> {
00197         legend_width = legend_height = legend_x_num = legend_y_num = 0;
00198         graph_height = graph_y2 - graph_y1 - 6;
00199     }
00200 
00201     <span class="keywordtype">short</span> YLabelWidth = y_label ? (orientation_flag ? font_ptr-&gt;max_font_height : font_ptr-&gt;text_width(y_label)) : -<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>;
00202     <span class="keywordtype">short</span> XLabelHeight = x_label ? (font_ptr-&gt;max_font_height) : -<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>;
00203     series_x1 = graph_x1 + 4 + <a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>*4 + YLabelWidth + y_label_max_len;
00204     series_y1 = graph_y1 + 4 + <a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>*6;
00205     series_x2 = graph_x2 - 4 - <a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>*16;
00206     series_y2 = graph_y1 + graph_height - <a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>*3 - (font_ptr-&gt;max_font_height);
00207 }
00208 
00209 <span class="comment">//------------ End of function GraphTrimester::calc_pos ---------//</span>
00210 
00211 <span class="comment">//-------- Begin of function GraphTrimester::paint --------------//</span>
<a name="l00213"></a><a class="code" href="classGraphTrimester.html#a8">00213</a> <span class="comment">void GraphTrimester::paint() {</span>
00214     <span class="keywordflow">if</span> (transparent_flag) {
00215         user_interface.brighten(graph_x1+4, graph_y1+4, graph_x2-2, graph_y2-2);
00216         <span class="keywordflow">if</span> (legend_array)
00217             draw_legend();
00218         draw_axis_label();
00219         graph_bitmap = vga_back.save_area(graph_x1+4, graph_y1+4, graph_x2-2, graph_y2-2, graph_bitmap);
00220     }
00221 
00222     <span class="comment">//  paint_flag = 1;</span>
00223     refresh();
00224 }
00225 
00226 <span class="comment">//------------- End of function GraphTrimester::paint -----------//</span>
00227 
00228 <span class="comment">//-------- Begin of function GraphTrimester::refresh ------------//</span>
<a name="l00230"></a><a class="code" href="classGraphTrimester.html#a9">00230</a> <span class="comment">void GraphTrimester::refresh() {</span>
00231     <span class="keywordflow">if</span> (transparent_flag) {
00232         user_interface.rect(graph_x1, graph_y1, graph_x2, graph_y2, 1);
00233         vga_back.rest_area(graph_bitmap, 0, 0);
00234     }
00235     <span class="keywordflow">else</span> {
00236         user_interface.bar(graph_x1, graph_y1, graph_x2, graph_y2);
00237         user_interface.panel(graph_x1+3, graph_y1+3, graph_x2-4, graph_y2-4);
00238     }
00239     <span class="keywordflow">if</span> (legend_array)
00240         draw_legend();
00241     draw_scale();
00242     draw_series();
00243 
00244     <span class="comment">//  if (!paint_flag)</span>
00245     <span class="comment">//          vga.blt_buf(graph_x1, graph_y1, graph_x2+2, graph_y2+2);</span>
00246     <span class="comment">//  else</span>
00247     <span class="comment">//          paint_flag = 0;</span>
00248 }
00249 
00250 <span class="comment">//------------- End of function GraphTrimester::refresh ---------//</span>
00251 
00252 <span class="comment">//---------- Begin of function GraphTrimester::draw_legend ------------//</span>
<a name="l00254"></a><a class="code" href="classGraphTrimester.html#b0">00254</a> <span class="comment">void GraphTrimester::draw_legend() {</span>
00255     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00256         <span class="keywordtype">short</span> legendX = graph_x1 + 4 + (i % legend_x_num) * legend_width + <a class="code" href="Ogrphtri_8cpp.html#a8a4">LEGEND_X_SPACING</a>;
00257         <span class="keywordtype">short</span> legendY = graph_y1 + 4 + graph_height + (i / legend_x_num) * legend_height;
00258         user_interface.bar( legendX+<a class="code" href="Ogrphtri_8cpp.html#a8a4">LEGEND_X_SPACING</a>, legendY+<a class="code" href="Ogrphtri_8cpp.html#a8a5">LEGEND_Y_SPACING</a>+<a class="code" href="Ogrphtri_8cpp.html#a8a3">LEGEND_SIZE</a>/2-1,
00259                             legendX+<a class="code" href="Ogrphtri_8cpp.html#a8a4">LEGEND_X_SPACING</a>+<a class="code" href="Ogrphtri_8cpp.html#a8a3">LEGEND_SIZE</a>, legendY+<a class="code" href="Ogrphtri_8cpp.html#a8a5">LEGEND_Y_SPACING</a>+<a class="code" href="Ogrphtri_8cpp.html#a8a3">LEGEND_SIZE</a>/2+1,
00260                             series_color[i] );
00261         font_ptr-&gt;put( legendX+<a class="code" href="Ogrphtri_8cpp.html#a8a4">LEGEND_X_SPACING</a>*2+<a class="code" href="Ogrphtri_8cpp.html#a8a3">LEGEND_SIZE</a>, legendY+<a class="code" href="Ogrphtri_8cpp.html#a8a5">LEGEND_Y_SPACING</a>, legend_array[i] );
00262     }
00263 }
00264 
00265 <span class="comment">//------------ End of function GraphTrimester::draw_legend ------------//</span>
00266 
00267 <span class="comment">//---------- Begin of function GraphTrimester::draw_axis_label --------//</span>
<a name="l00269"></a><a class="code" href="classGraphTrimester.html#b1">00269</a> <span class="comment">void GraphTrimester::draw_axis_label() {</span>
00270     <span class="keywordtype">short</span> textHeight = font_ptr-&gt;max_font_height;
00271 
00272     <span class="keywordflow">if</span> (x_label) {
00273         font_ptr-&gt;center_put( series_x1, series_y2+<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>*2+textHeight,
00274                               series_x2, graph_y1+graph_height-<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>, x_label );
00275     }
00276 
00277     <span class="keywordflow">if</span> (y_label) {
00278         <span class="keywordtype">short</span> textWidth = font_ptr-&gt;text_width(y_label) + 1;
00279 
00280         <span class="keywordflow">if</span> (orientation_flag) {
00281             <span class="keywordtype">short</span> *fontBuf = (<span class="keywordtype">short</span> *) sys.common_data_buf;
00282             <a class="code" href="ALL_8H.html#a0">err_when</a>(textWidth * textHeight * <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>) &gt; <a class="code" href="Osys_8h.html#a40a2">COMMON_DATA_BUF_SIZE</a>);
00283 
00284             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; textWidth * textHeight; i++)
00285                 *fontBuf++ = transparent_code_w;
00286 
00287             font_ptr-&gt;put_to_bufferW(fontBuf = (<span class="keywordtype">short</span> *) sys.common_data_buf, textWidth * <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>), 0, 0, y_label);
00288 
00289             <span class="keywordtype">short</span> xStart = graph_x1 + 4 + <a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a> * 2;
00290             <span class="keywordtype">short</span> yStart = (series_y1 + series_y2 - textWidth) / 2;
00291 
00292             <span class="keywordflow">for</span> (<span class="keywordtype">short</span> x = 0; x &lt; textHeight; x++) {
00293                 <span class="keywordflow">for</span> (<span class="keywordtype">short</span> y = textWidth - 1; y &gt;= 0; y--, fontBuf++) {
00294                     <span class="keywordflow">if</span> (*fontBuf != transparent_code_w)
00295                         *vga_back.buf_ptr(xStart+x, yStart+y) = *fontBuf;
00296                 }
00297             }
00298         }
00299         <span class="keywordflow">else</span> {
00300             font_ptr-&gt;center_put( graph_x1+4+<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>*2, series_y1,
00301                                   graph_x1+4+<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>*2+textWidth, series_y2, y_label);
00302         }
00303     }
00304 }
00305 
00306 <span class="comment">//------------ End of function GraphTrimester::draw_axis_label --------//</span>
00307 
00308 <span class="comment">//---------- Begin of function GraphTrimester::find_scale -------------//</span>
<a name="l00310"></a><a class="code" href="classGraphTrimester.html#b2">00310</a> <span class="comment">void GraphTrimester::find_scale() {</span>
00311     <span class="keywordtype">double</span> data, maxVal = 0.0,minVal = 0.0;
00312 
00313     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num * *data_num; i++) {
00314         <span class="keywordflow">switch</span> (data_type_flag) {
00315         <span class="keywordflow">case</span> DATA_DOUBLE:
00316             data = ((<span class="keywordtype">double</span>*)data_array)[i];
00317             <span class="keywordflow">break</span>;
00318         <span class="keywordflow">case</span> DATA_FLOAT:
00319             data = double(((<span class="keywordtype">float</span>*)data_array)[i]);
00320             <span class="keywordflow">break</span>;
00321         <span class="keywordflow">case</span> DATA_INT:
00322             data = double(((<span class="keywordtype">int</span>*)data_array)[i]);
00323             <span class="keywordflow">break</span>;
00324         <span class="keywordflow">case</span> DATA_LONG:
00325             data = double(((<span class="keywordtype">long</span>*)data_array)[i]);
00326             <span class="keywordflow">break</span>;
00327         }
00328         <span class="keywordflow">if</span> (data &gt; maxVal)
00329             maxVal = data;
00330         <span class="keywordflow">if</span> (data &lt; minVal)
00331             minVal = data;
00332     }
00333     <span class="keywordflow">if</span> (maxVal&gt;0)
00334         max_scale = maxVal;
00335     <span class="keywordflow">else</span>
00336         max_scale = 10;
00337 
00338     <span class="keywordflow">if</span> (minVal&lt;0)
00339         min_scale = minVal;
00340     <span class="keywordflow">else</span>
00341         min_scale = 0;
00342 
00343 }
00344 
00345 <span class="comment">//------------ End of function GraphTrimester::find_scale -------------//</span>
00346 
00347 <span class="comment">//---------- Begin of function GraphTrimester::draw_scale -------------//</span>
<a name="l00349"></a><a class="code" href="classGraphTrimester.html#b3">00349</a> <span class="comment">void GraphTrimester::draw_scale() {</span>
00350     find_scale();
00351 
00352     <span class="comment">//------ Draw y-axis -------//</span>
00353     vga_back.bar(series_x1, series_y1-<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>*2, series_x1+1, series_y2, axis_color);
00354 
00355     xAxisPos=(short)(series_y1+(series_y2-series_y1)*(max_scale)/(max_scale-min_scale));
00356 
00357     posScaleNum = (xAxisPos-series_y1-font_ptr-&gt;max_font_height) / (font_ptr-&gt;max_font_height*3/2);
00358     <span class="keywordflow">if</span> ( posScaleNum &gt; 0 )
00359         posScaleNum = short(pow(2,floor(log10(<span class="keywordtype">double</span>(posScaleNum))/log10(2.0))));
00360     <span class="keywordflow">else</span>
00361         posScaleNum = 0;
00362     negScaleNum = (series_y2-xAxisPos-font_ptr-&gt;max_font_height) / (font_ptr-&gt;max_font_height*3/2);
00363     <span class="keywordflow">if</span> ( negScaleNum &gt; 0 )
00364         negScaleNum = short(pow(2,ceil(log10(<span class="keywordtype">double</span>(negScaleNum))/log10(2.0))));
00365     <span class="keywordflow">else</span>
00366         negScaleNum = 0;
00367 
00368 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00369 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( posScaleNum + negScaleNum &lt;= 0) {
00370         posScaleNum = 1;
00371         negScaleNum = 0;
00372     }
00373 <span class="preprocessor">#endif</span>
00374 <span class="preprocessor"></span>
00375     <span class="keywordtype">short</span> posScaleStep;
00376     <span class="keywordtype">short</span> negScaleStep;
00377 
00378     <span class="keywordflow">if</span>(posScaleNum&lt;1) {
00379         posScaleStep = 0;
00380         posScaleInc = 0;
00381     }
00382     <span class="keywordflow">else</span> {
00383         posScaleStep  = (xAxisPos-series_y1) / posScaleNum;
00384         posScaleInc   = max_scale / posScaleNum;
00385 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00386 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( data_type_flag==DATA_INT || data_type_flag==DATA_LONG )
00387             posScaleInc = ceil(posScaleInc);            <span class="comment">// don't like integer type to have non-integral posScaleInc</span>
00388 <span class="preprocessor">#endif</span>
00389 <span class="preprocessor"></span>    }
00390 
00391     <span class="keywordflow">if</span>(negScaleNum&lt;1) {
00392         negScaleStep = 0;
00393         negScaleInc = 0;
00394     }
00395     <span class="keywordflow">else</span> {
00396         negScaleStep = (series_y2-xAxisPos) / negScaleNum;
00397         negScaleInc   = -min_scale / negScaleNum;
00398 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00399 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( data_type_flag==DATA_INT || data_type_flag==DATA_LONG )
00400             negScaleInc = ceil(negScaleInc);            <span class="comment">// don't like integer type to have non-integral negScaleInc</span>
00401 <span class="preprocessor">#endif</span>
00402 <span class="preprocessor"></span>    }
00403 
00404     <span class="keywordflow">if</span>(posScaleNum+negScaleNum&lt;1) {
00405         scaleStep = 0;
00406         scaleInc   = 0;
00407     }
00408     <span class="keywordflow">else</span> {
00409         scaleStep = (short)((series_y2-series_y1)/(posScaleNum+negScaleNum));
00410         scaleInc = ((max_scale-min_scale)/(posScaleNum+negScaleNum));
00411 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00412 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( data_type_flag==DATA_INT || data_type_flag==DATA_LONG )
00413             scaleInc = max(posScaleInc, negScaleInc);
00414 <span class="preprocessor">#endif</span>
00415 <span class="preprocessor"></span>    }
00416 
00417     <span class="keywordtype">double</span> scaleValue;
00418 
00419     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = -negScaleNum,ycheck=xAxisPos-i*scaleStep;
00420          ycheck&gt;graph_y1;
00421          i++,ycheck-=scaleStep) {
00422 
00423         vga_back.bar(series_x1, ycheck, series_x1+<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>*2, ycheck, axis_color);
00424 
00425         scaleValue = i*scaleInc;
00426 
00427         <span class="keywordflow">switch</span> (data_type_flag) {
00428         <span class="keywordflow">case</span> DATA_FLOAT:
00429         <span class="keywordflow">case</span> DATA_DOUBLE:
00430             font_ptr-&gt;right_put(series_x1-<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>, ycheck-font_ptr-&gt;max_font_height/2, m.format(scaleValue,num_format));
00431             <span class="keywordflow">break</span>;
00432         <span class="keywordflow">case</span> DATA_INT:
00433         <span class="keywordflow">case</span> DATA_LONG:
00434             font_ptr-&gt;right_put(series_x1-<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>, ycheck-font_ptr-&gt;max_font_height/2, m.format(<span class="keywordtype">long</span>(scaleValue),num_format));
00435         }
00436     }
00437 
00438     <span class="comment">//------ Draw x-axis -------//</span>
00439     vga_back.bar(series_x1, xAxisPos-<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>, series_x2+1, xAxisPos, axis_color);
00440 
00441     <span class="comment">// show x-axis scale</span>
00442 
00443     <span class="comment">// At max, how much data points shown for each series</span>
00444     <span class="keywordtype">int</span> data_trimester_shown=24;
00445 
00446     <span class="comment">// The scales within how much years should be shown</span>
00447     <span class="keywordtype">int</span> scale_trimester_shown=24;
00448 
00449     <span class="keywordflow">if</span>(info.graph_trimester&lt;data_trimester_shown)
00450         data_trimester_shown=info.graph_trimester;
00451 
00452     <span class="comment">// show x-axis scale</span>
00453     <span class="keywordtype">double</span> pesudo_end,pesudo_game_day_template[4];
00454     <span class="keywordtype">double</span> printing_offset;
00455     <span class="keywordtype">int</span> start_printing_year;
00456     pesudo_game_day_template[0]=
00457         (double)player_school.trimester_array[<a class="code" href="Gamedef_8h.html#a79a37">WINTER</a>].start_month/12.0
00458         +(double)player_school.trimester_array[<a class="code" href="Gamedef_8h.html#a79a37">WINTER</a>].start_day/365.25;
00459     pesudo_game_day_template[1]=(double)player_school.trimester_array[<a class="code" href="Gamedef_8h.html#a79a38">SUMMER</a>].start_month/12.0
00460         +(double)player_school.trimester_array[<a class="code" href="Gamedef_8h.html#a79a38">SUMMER</a>].start_day/365.25;
00461     pesudo_game_day_template[2]=(double)player_school.trimester_array[<a class="code" href="Gamedef_8h.html#a79a36">AUTUMN</a>].start_month/12.0
00462         +(double)player_school.trimester_array[<a class="code" href="Gamedef_8h.html#a79a36">AUTUMN</a>].start_day/365.25;
00463     <span class="keywordtype">double</span> current_day=(double)info.game_month/12+(double)info.game_day/365.25;
00464     <span class="keywordflow">if</span>(current_day&gt;pesudo_game_day_template[2]) {
00465         pesudo_end=pesudo_game_day_template[2];
00466         start_printing_year=(int)((info.game_year)+pesudo_end+(double)this_trimester_indicator/3+1-(double)data_trimester_shown/3-1.0/12);
00467         printing_offset=2/3;
00468     }
00469     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(current_day&gt;pesudo_game_day_template[1]) {
00470         pesudo_end=pesudo_game_day_template[1];
00471         start_printing_year=(int)((info.game_year)+pesudo_end+(double)this_trimester_indicator/3+1-(double)data_trimester_shown/3-1.0/12);
00472         printing_offset=1/3;
00473     }
00474     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(current_day&gt;pesudo_game_day_template[0]) {
00475         pesudo_end=pesudo_game_day_template[0];
00476         start_printing_year=(int)((info.game_year)+pesudo_end+(double)this_trimester_indicator/3+1-(double)data_trimester_shown/3-1.0/12);
00477         printing_offset=0;
00478     }
00479     <span class="keywordflow">else</span> {
00480         pesudo_end=pesudo_game_day_template[2];
00481         start_printing_year=(int)((info.game_year-1)+pesudo_end+(double)this_trimester_indicator/3+1-(double)data_trimester_shown/3-1.0/12);
00482         printing_offset=2/3;
00483     }
00484 
00485 <span class="preprocessor">#if(GAME_VERSION&gt;=200)</span>
00486 <span class="preprocessor"></span>    printing_offset+=1.0;
00487 <span class="preprocessor">#else</span>
00488 <span class="preprocessor"></span>    printing_offset+=2.0/3;
00489 <span class="preprocessor">#endif</span>
00490 <span class="preprocessor"></span>    <span class="keywordtype">short</span> maxLabelWidth = font_ptr-&gt;text_width(m.format((<span class="keywordtype">int</span>)start_printing_year, 16))+<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>;
00491     <span class="keywordtype">double</span> scaleYearRatio =3;
00492     x_axis_step = ((float)series_x2-series_x1) / (scale_trimester_shown);
00493 
00494     <span class="keywordtype">short</span> displayInc = 1;
00495     <span class="keywordflow">while</span> (displayInc * x_axis_step &lt; maxLabelWidth ) displayInc++;
00496 
00497     <span class="comment">//  double actual_end=(double)(pesudo_game_day+this_trimester_indicator/3)+info.game_year;</span>
00498     <span class="comment">//  int show_end=(int)(actual_end);</span>
00499 
00500     <span class="comment">//  double actual_start = actual_end-(double)(info.graph_trimester)/3.0;</span>
00501     <span class="comment">//  double show_year_offset=1.0-(actual_start-(int)actual_start);</span>
00502     <span class="comment">//  int show_start=(int)(actual_start)+1;</span>
00503 
00504     <span class="comment">//  show_end=show_start+(trimester_shown/3);</span>
00505 
00506     <span class="comment">//  short displayInc = 0;</span>
00507     <span class="comment">//  while (displayInc * x_axis_step * 12.0&lt; maxLabelWidth) displayInc++;</span>
00508 
00509     <span class="comment">//------ Draw x-axis -------//</span>
00510     <span class="keywordflow">for</span> (i = 0; i &lt; scale_trimester_shown ; i += displayInc) {
00511         <span class="keywordtype">int</span> this_x;
00512         <span class="keywordflow">if</span>((this_x = (int)(series_x1+((double)(i/3+printing_offset)*x_axis_step*3)))&lt;series_x2) {
00513             vga_back.bar(
00514                 this_x,
00515                 xAxisPos-<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>*2,
00516                 this_x+1,
00517                 xAxisPos, axis_color);
00518             font_ptr-&gt;center_put(
00519                 this_x-maxLabelWidth/2-<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>,
00520                 xAxisPos+<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>,
00521                 this_x+maxLabelWidth/2-<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>,
00522                 xAxisPos+<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>+font_ptr-&gt;max_font_height,
00523                 m.format((<span class="keywordtype">int</span>)(start_printing_year+i/scaleYearRatio),16));
00524         }
00525     }
00526 
00527     <span class="comment">//---- Draw this year indicators ----//</span>
00528     <span class="keywordflow">if</span>((this_trimester_indicator&gt;=0)&amp;&amp;(this_trimester_indicator&lt;HISTORY_TRIMESTER_COUNT))
00529         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=series_y1;j&lt;series_y2+<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>;j+=8)
00530             vga_back.bar(
00531                 (<span class="keywordtype">int</span>)(series_x1+(info.graph_trimester-this_trimester_indicator-1)*x_axis_step),
00532                 j,
00533                 (<span class="keywordtype">int</span>)(series_x1+(info.graph_trimester-this_trimester_indicator-1)*x_axis_step),
00534                 j+4,
00535                 axis_color);
00536 }
00537 
00538 <span class="comment">//------------ End of function GraphTrimester::draw_scale -------------//</span>
00539 
00540 <span class="comment">//---------- Begin of function GraphTrimester::draw_series ------------//</span>
<a name="l00542"></a><a class="code" href="classGraphTrimester.html#b4">00542</a> <span class="comment">void GraphTrimester::draw_series() {</span>
00543     <span class="keywordflow">switch</span> (data_type_flag) {
00544     <span class="keywordflow">case</span> DATA_FLOAT: draw_series_float(); <span class="keywordflow">break</span>;
00545     <span class="keywordflow">case</span> DATA_DOUBLE: draw_series_double(); <span class="keywordflow">break</span>;
00546     <span class="keywordflow">case</span> DATA_INT: draw_series_int(); <span class="keywordflow">break</span>;
00547     <span class="keywordflow">case</span> DATA_LONG: draw_series_long(); <span class="keywordflow">break</span>;
00548     }
00549 }
00550 
00551 <span class="comment">//------------ End of function GraphTrimester::draw_series ------------//</span>
00552 
00553 <span class="comment">//---------- Begin of function GraphTrimester::draw_series_float ------------//</span>
<a name="l00555"></a><a class="code" href="classGraphTrimester.html#b5">00555</a> <span class="comment">void GraphTrimester::draw_series_float() {</span>
00556     <span class="keywordtype">float</span> *dataArray = (<span class="keywordtype">float</span> *) data_array;
00557     <span class="keywordtype">short</span> prevX, prevY, currX, currY;
00558 
00559     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00560         dataArray-=info.graph_trimester;
00561         dataArray+=HISTORY_TRIMESTER_COUNT;
00562         prevX = series_x1;
00563         prevY = xAxisPos-(short)(*dataArray * scaleStep/scaleInc) ;
00564 
00565         dataArray++;
00566         vga_back.thick_line(prevX-1, prevY, prevX+1, prevY, vga_back.translate_color(series_color[i]));
00567 
00568         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 1; j &lt; info.graph_trimester; j++) {
00569             currX = series_x1 + (short)(j * x_axis_step);
00570             currY = xAxisPos-(short)(*dataArray * scaleStep/scaleInc) ;
00571 
00572             vga_back.thick_line(prevX, prevY, currX, currY, vga_back.translate_color(series_color[i]));
00573 
00574             prevX = currX;
00575             prevY = currY;
00576             dataArray++;
00577         }
00578 
00579         <span class="keywordflow">if</span> (value_flag)
00580             draw_value(dataArray-1, vga_back.translate_color(series_color[i]), prevX+<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>-(int)(0.3f*x_axis_step),  prevY-(((i/2)==0)?1:0)*font_news.max_font_height, DATA_FLOAT);
00581     }
00582 }
00583 
00584 <span class="comment">//------------ End of function GraphTrimester::draw_series_float ------------//</span>
00585 
00586 <span class="comment">//---------- Begin of function GraphTrimester::draw_series_double ------------//</span>
<a name="l00588"></a><a class="code" href="classGraphTrimester.html#b6">00588</a> <span class="comment">void GraphTrimester::draw_series_double() {</span>
00589     <span class="keywordtype">double</span> *dataArray = (<span class="keywordtype">double</span> *) data_array;
00590     <span class="keywordtype">short</span> prevX, prevY, currX, currY;
00591 
00592     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00593         dataArray-=info.graph_trimester;
00594         dataArray+=HISTORY_TRIMESTER_COUNT;
00595         prevX = series_x1;
00596         prevY = xAxisPos-(short)(*dataArray * (double)scaleStep/scaleInc);
00597 
00598         dataArray++;
00599         vga_back.thick_line(prevX-1, prevY, prevX+1, prevY, vga_back.translate_color(series_color[i]));
00600 
00601         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 1; j &lt; info.graph_trimester; j++) {
00602             currX = series_x1 + (short)(j * x_axis_step);
00603             currY = xAxisPos-(short)(*dataArray * (double)scaleStep/scaleInc);
00604 
00605             vga_back.thick_line(prevX, prevY, currX, currY, vga_back.translate_color(series_color[i]));
00606 
00607             prevX = currX;
00608             prevY = currY;
00609             dataArray++;
00610         }
00611 
00612         <span class="keywordflow">if</span> (value_flag)
00613             draw_value(dataArray-1, vga_back.translate_color(series_color[i]), prevX+<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>-(int)(0.3f*x_axis_step),  prevY-(((i/2)==0)?1:0)*font_news.max_font_height, DATA_DOUBLE);
00614     }
00615 }
00616 
00617 <span class="comment">//------------ End of function GraphTrimester::draw_series_double ------------//</span>
00618 
00619 <span class="comment">//---------- Begin of function GraphTrimester::draw_series_int ------------//</span>
<a name="l00621"></a><a class="code" href="classGraphTrimester.html#b7">00621</a> <span class="comment">void GraphTrimester::draw_series_int() {</span>
00622     <span class="keywordtype">int</span> *dataArray = (<span class="keywordtype">int</span> *) data_array;
00623     <span class="keywordtype">short</span> prevX, prevY, currX, currY;
00624 
00625     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00626         dataArray-=info.graph_trimester;
00627         dataArray+=HISTORY_TRIMESTER_COUNT;
00628         prevX = series_x1;
00629         prevY = xAxisPos-(short)(*dataArray * scaleStep/scaleInc);
00630 
00631         dataArray++;
00632         vga_back.thick_line(prevX-1, prevY, prevX+1, prevY, vga_back.translate_color(series_color[i]));
00633 
00634         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 1; j &lt; info.graph_trimester; j++) {
00635             currX = series_x1 + (short)(j * x_axis_step);
00636             currY = (short)(xAxisPos-(int)(*dataArray * scaleStep/scaleInc));
00637 
00638             vga_back.thick_line(prevX, prevY, currX, currY, vga_back.translate_color(series_color[i]));
00639 
00640             prevX = currX;
00641             prevY = currY;
00642             dataArray++;
00643         }
00644 
00645         <span class="keywordflow">if</span> (value_flag)
00646             draw_value(dataArray-1, vga_back.translate_color(series_color[i]), prevX+<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>-(int)(0.3f*x_axis_step),  prevY-(((i/2)==0)?1:0)*font_news.max_font_height, DATA_INT);
00647     }
00648 }
00649 
00650 <span class="comment">//------------ End of function GraphTrimester::draw_series_int ------------//</span>
00651 
00652 <span class="comment">//---------- Begin of function GraphTrimester::draw_series_long ------------//</span>
<a name="l00654"></a><a class="code" href="classGraphTrimester.html#b8">00654</a> <span class="comment">void GraphTrimester::draw_series_long() {</span>
00655     <span class="keywordtype">long</span> *dataArray = (<span class="keywordtype">long</span> *) data_array;
00656     <span class="keywordtype">short</span> prevX, prevY, currX, currY;
00657 
00658     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; series_num; i++) {
00659         dataArray-=info.graph_trimester;
00660         dataArray+=HISTORY_TRIMESTER_COUNT;
00661         prevX = series_x1;
00662         prevY = xAxisPos-(short)(*dataArray * scaleStep/scaleInc);
00663 
00664         dataArray++;
00665         vga_back.thick_line(prevX-1, prevY, prevX+1, prevY, vga_back.translate_color(series_color[i]));
00666 
00667         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 1; j &lt; info.graph_trimester; j++) {
00668             currX = series_x1 + (short)(j * x_axis_step);
00669             currY = xAxisPos-(short)(*dataArray * scaleStep/scaleInc);
00670 
00671             vga_back.thick_line(prevX, prevY, currX, currY, vga_back.translate_color(series_color[i]));
00672 
00673             prevX = currX;
00674             prevY = currY;
00675             dataArray++;
00676         }
00677 
00678         <span class="keywordflow">if</span> (value_flag)
00679             draw_value(dataArray-1, vga_back.translate_color(series_color[i]), prevX+<a class="code" href="Ogrphtri_8cpp.html#a9a6">COMMON_OFFSET</a>-(int)(0.3f*x_axis_step),  prevY-(((i/2)==0)?1:0)*font_news.max_font_height, DATA_LONG);
00680     }
00681 }
00682 
00683 <span class="comment">//------------ End of function GraphTrimester::draw_series_float ------------//</span>
00684 
00685 <span class="comment">//---------- Begin of function GraphTrimester::draw_value -------------------//</span>
<a name="l00687"></a><a class="code" href="classGraphTrimester.html#b9">00687</a> <span class="comment">void GraphTrimester::draw_value(void *value, int color, short x, short y, int dataType) {</span>
00688     <span class="keywordtype">char</span> *valueString;
00689     <span class="keywordflow">switch</span> (data_type_flag) {
00690     <span class="keywordflow">case</span> DATA_FLOAT:
00691         valueString = m.format(*((<span class="keywordtype">float</span> *) value), num_format); <span class="keywordflow">break</span>;
00692     <span class="keywordflow">case</span> DATA_DOUBLE:
00693         valueString = m.format(*((<span class="keywordtype">double</span> *) value), num_format); <span class="keywordflow">break</span>;
00694     <span class="keywordflow">case</span> DATA_INT:
00695         valueString = m.format(*((<span class="keywordtype">int</span> *) value), num_format); <span class="keywordflow">break</span>;
00696     <span class="keywordflow">case</span> DATA_LONG:
00697         valueString = m.format(*((<span class="keywordtype">long</span> *) value), num_format); <span class="keywordflow">break</span>;
00698     }
00699 
00700     <span class="keywordtype">short</span> textHeight = font_news.max_font_height;
00701     <span class="keywordtype">short</span> textWidth = font_news.text_width(valueString) + 1;
00702 
00703     <span class="comment">/*</span>
00704 <span class="comment">      short *bitmap = (short *) sys.common_data_buf;</span>
00705 <span class="comment">      err_when( (2 + textWidth * textHeight) * sizeof(short) &gt; COMMON_DATA_BUF_SIZE );</span>
00706 <span class="comment">      *bitmap++ = textWidth;</span>
00707 <span class="comment">      *bitmap++ = textHeight;</span>
00708 <span class="comment"></span>
00709 <span class="comment">      short *shortPtr = bitmap;</span>
00710 <span class="comment">      for (int i = 0; i &lt; textWidth * textHeight; i++)</span>
00711 <span class="comment">      *shortPtr++ = transparent_code_w;</span>
00712 <span class="comment"></span>
00713 <span class="comment">      font_news.put_to_bufferW(bitmap, textWidth * sizeof(short), 0, 0, valueString);</span>
00714 <span class="comment"></span>
00715 <span class="comment">      shortPtr = bitmap;</span>
00716 <span class="comment">      for (i = 0; i &lt; textWidth * textHeight; i++, shortPtr++)</span>
00717 <span class="comment">      if (*shortPtr != transparent_code_w)</span>
00718 <span class="comment">      *shortPtr = color;</span>
00719 <span class="comment"></span>
00720 <span class="comment">      vga_back.put_bitmapW_trans(x, y, (short *) sys.common_data_buf);</span>
00721 <span class="comment">    */</span>
00722     font_chartsm.put(x+3,y,valueString);
00723 }
00724 
00725 <span class="comment">//---------- End of function GraphTrimester::draw_value -------------------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:37:52 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
