<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>OSERES.CPP Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>OSERES.CPP</h1><a href="OSERES_8CPP.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">// Filename    : OSERES.CPP</span>
00002 <span class="comment">// Description : Sound resource</span>
00003 <span class="comment">//  search a sound effect id from subject verb object</span>
00004 <span class="comment">//  pass the id to se_ctrl.request to trigger the sound effect</span>
00005 <span class="comment">// Owner       : Gilbert</span>
00006 
00007 <span class="preprocessor">#include &lt;<a class="code" href="OSERES_8H.html">OSERES.H</a>&gt;</span>
00008 <span class="preprocessor">#include &lt;<a class="code" href="OSE_8H.html">OSE.H</a>&gt;</span>
00009 <span class="preprocessor">#include &lt;<a class="code" href="OGAMESET_8H.html">OGAMESET.H</a>&gt;</span>
00010 <span class="preprocessor">#include &lt;<a class="code" href="OWORLD_8H.html">OWORLD.H</a>&gt;</span>
00011 <span class="preprocessor">#include &lt;OCONFIG.H&gt;</span>
00012 <span class="preprocessor">#include &lt;string.h&gt;</span>
00013 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00014 
00015 <span class="comment">// ---------- Define constant ----------//</span>
<a name="l00016"></a><a class="code" href="OSERES_8CPP.html#a0">00016</a> <span class="preprocessor">#define SERES_DB "SOUNDRES"</span>
<a name="l00017"></a><a class="code" href="classSERes.html#p0">00017</a> <span class="preprocessor"></span><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="classSERes.html#p0">SERes::last_select_time</a> = 0;
<a name="l00018"></a><a class="code" href="classSERes.html#p1">00018</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="classSERes.html#p1">SERes::last_command_time</a> = 0;
<a name="l00019"></a><a class="code" href="classSERes.html#p2">00019</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="classSERes.html#p2">SERes::select_sound_length</a> = 600;   <span class="comment">// time between successive select sound</span>
00020 
00021 <span class="comment">// --------- begin of function SEInfo::match ----------//</span>
<a name="l00022"></a><a class="code" href="structSEInfo.html#a0">00022</a> <span class="keywordtype">int</span> <a class="code" href="structSEInfo.html#a0">SEInfo::match</a>(<span class="keywordtype">char</span> subjectType, <span class="keywordtype">short</span> subjectId, <span class="keywordtype">char</span> *act,
00023                   <span class="keywordtype">char</span> objectType, <span class="keywordtype">short</span> objectId) {
00024     <span class="comment">// object_type == -1, match all object type</span>
00025     <span class="comment">// object_id == -1, match all object id of that type</span>
00026     <span class="keywordflow">return</span> <a class="code" href="structSEInfo.html#m0">subject_type</a> == subjectType &amp;&amp;
00027         (<a class="code" href="structSEInfo.html#m1">subject_id</a> == -1 || <a class="code" href="structSEInfo.html#m1">subject_id</a> == subjectId) &amp;&amp;
00028         strncmp(<a class="code" href="structSEInfo.html#m2">action</a>, act, <a class="code" href="structSEInfo.html#s2s0">VERB_LEN</a> )== 0 &amp;&amp;
00029         (<a class="code" href="structSEInfo.html#m3">object_type</a> == -1 || (<a class="code" href="structSEInfo.html#m3">object_type</a> == objectType &amp;&amp;
00030                                (<a class="code" href="structSEInfo.html#m4">object_id</a> == -1 || <a class="code" href="structSEInfo.html#m4">object_id</a> == objectId)));
00031 }
00032 
00033 <span class="comment">// --------- end of function SEInfo::match ----------//</span>
00034 
00035 <span class="comment">// --------- begin of function SERes::SERes ----------//</span>
<a name="l00036"></a><a class="code" href="classSERes.html#a0">00036</a> <a class="code" href="classSERes.html#a0">SERes::SERes</a>() {
00037     <a class="code" href="classSERes.html#m0">init_flag</a> = 0;
00038     <a class="code" href="classSERes.html#m2">se_array_count</a> = 0;
00039     <a class="code" href="classSERes.html#m3">se_array</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00040     <a class="code" href="classSERes.html#m4">se_index_count</a> = 0;
00041     <a class="code" href="classSERes.html#m5">se_index_array</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00042     <a class="code" href="classSERes.html#m6">type_index_count</a> = 0;
00043     <a class="code" href="classSERes.html#m7">type_index_array</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00044 }
00045 
00046 <span class="comment">// --------- end of function SERes::SERes ----------//</span>
00047 
00048 <span class="comment">// --------- begin of function SERes::~SERes ----------//</span>
<a name="l00049"></a><a class="code" href="classSERes.html#a1">00049</a> <a class="code" href="classSERes.html#a1">SERes::~SERes</a>() {
00050     <a class="code" href="classSERes.html#a4">deinit</a>();
00051 }
00052 
00053 <span class="comment">// --------- end of function SERes::~SERes ----------//</span>
00054 
00055 <span class="comment">// --------- begin of function SERes::init1 ----------//</span>
<a name="l00056"></a><a class="code" href="classSERes.html#a2">00056</a> <span class="keywordtype">void</span> <a class="code" href="classSERes.html#a2">SERes::init1</a>() {
00057     <a class="code" href="classSERes.html#a4">deinit</a>();
00058     <a class="code" href="classSERes.html#m8">seed</a> = m.get_time();
00059     load_info();
00060     sort_info();
00061     build_index();
00062     <a class="code" href="classSERes.html#m0">init_flag</a> = 1;
00063 }
00064 
00065 <span class="comment">// --------- end of function SERes::init1 ----------//</span>
00066 
00067 <span class="comment">// --------- begin of function SERes::init2 ----------//</span>
00068 <span class="comment">// called after se_ctrl is init</span>
<a name="l00069"></a><a class="code" href="classSERes.html#a3">00069</a> <span class="keywordtype">void</span> <a class="code" href="classSERes.html#a3">SERes::init2</a>(<a class="code" href="classSECtrl.html">SECtrl</a> *seCtrl) {
00070     <a class="code" href="ALL_8H.html#a0">err_when</a>( !seCtrl || !seCtrl-&gt;<a class="code" href="classSECtrl.html#m0">init_flag</a> );
00071     <a class="code" href="ALL_8H.html#a0">err_when</a>( <a class="code" href="classSERes.html#m0">init_flag</a> == 0 );
00072     <a class="code" href="classSERes.html#m1">se_output</a> = seCtrl;
00073     <span class="keywordtype">int</span> i;
00074     <a class="code" href="structSEInfo.html">SEInfo</a> *seInfo;
00075     <span class="keywordflow">for</span>(i = 0, seInfo = <a class="code" href="classSERes.html#m3">se_array</a>; i &lt; <a class="code" href="classSERes.html#m2">se_array_count</a>; ++i, ++seInfo ) {
00076         seInfo-&gt;<a class="code" href="structSEInfo.html#m7">effect_id</a> = seCtrl-&gt;<a class="code" href="classSECtrl.html#a9">search_effect_id</a>(seInfo-&gt;<a class="code" href="structSEInfo.html#m6">file_name</a>);
00077     }
00078 
00079     <a class="code" href="classSERes.html#m0">init_flag</a> = 2;
00080 }
00081 
00082 <span class="comment">// --------- end of function SERes::init2 ----------//</span>
00083 
00084 <span class="comment">// --------- begin of function SERes::deinit ----------//</span>
<a name="l00085"></a><a class="code" href="classSERes.html#a4">00085</a> <span class="keywordtype">void</span> <a class="code" href="classSERes.html#a4">SERes::deinit</a>() {
00086     <span class="keywordflow">if</span>( init_flag ) {
00087         <a class="code" href="ALL_8H.html#a8">mem_del</a>(<a class="code" href="classSERes.html#m3">se_array</a>);
00088         <a class="code" href="classSERes.html#m3">se_array</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00089         <a class="code" href="classSERes.html#m2">se_array_count</a> = 0;
00090 
00091         <a class="code" href="ALL_8H.html#a8">mem_del</a>(<a class="code" href="classSERes.html#m5">se_index_array</a>);
00092         <a class="code" href="classSERes.html#m5">se_index_array</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00093         <a class="code" href="classSERes.html#m4">se_index_count</a> = 0;
00094 
00095         <a class="code" href="ALL_8H.html#a8">mem_del</a>(<a class="code" href="classSERes.html#m7">type_index_array</a>);
00096         <a class="code" href="classSERes.html#m7">type_index_array</a> = <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00097         <a class="code" href="classSERes.html#m6">type_index_count</a> = 0;
00098 
00099         <a class="code" href="classSERes.html#m0">init_flag</a> = 0;
00100     }
00101 }
00102 
00103 <span class="comment">// --------- end of function SERes::deinit ----------//</span>
00104 
00105 <span class="comment">// --------- begin of function SERes::load_info ----------//</span>
00106 <span class="keywordtype">void</span> SERes::load_info() {
00107     <a class="code" href="structSERec.html">SERec</a> *seRec;
00108     <a class="code" href="structSEInfo.html">SEInfo</a> *seInfo;
00109     <span class="keywordtype">int</span> i;
00110     <a class="code" href="classDatabase.html">Database</a> *dbSE = game_set.open_db(<a class="code" href="OSERES_8CPP.html#a0">SERES_DB</a>);
00111 
00112     <a class="code" href="classSERes.html#m2">se_array_count</a> = dbSE-&gt;<a class="code" href="classDatabase.html#a7">rec_count</a>();
00113     <a class="code" href="classSERes.html#m3">se_array</a> = (<a class="code" href="structSEInfo.html">SEInfo</a> *)<a class="code" href="ALL_8H.html#a5">mem_add</a>(<span class="keyword">sizeof</span>(<a class="code" href="structSEInfo.html">SEInfo</a>) * <a class="code" href="classSERes.html#m2">se_array_count</a>);
00114     memset( <a class="code" href="classSERes.html#m3">se_array</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="structSEInfo.html">SEInfo</a>) * <a class="code" href="classSERes.html#m2">se_array_count</a> );
00115 
00116     <span class="keywordflow">for</span>( i = 0; i &lt; <a class="code" href="classSERes.html#m2">se_array_count</a>; ++i ) {
00117         seRec = (<a class="code" href="structSERec.html">SERec</a> *) dbSE-&gt;<a class="code" href="classDatabase.html#a4">read</a>(i+1);
00118         seInfo = <a class="code" href="classSERes.html#m3">se_array</a>+i;
00119 
00120         <span class="comment">// ------- copy subject ---------//</span>
00121         seInfo-&gt;<a class="code" href="structSEInfo.html#m0">subject_type</a> = seRec-&gt;<a class="code" href="structSERec.html#m0">subject_type</a>;
00122         seInfo-&gt;<a class="code" href="structSEInfo.html#m1">subject_id</a> = m.atoi(seRec-&gt;<a class="code" href="structSERec.html#m2">subject_id</a>, seRec-&gt;<a class="code" href="structSERec.html#s5s0">RECNO_LEN</a>);
00123 
00124         <span class="comment">// -------- copy verb ---------//</span>
00125         memcpy( seInfo-&gt;<a class="code" href="structSEInfo.html#m2">action</a>, seRec-&gt;<a class="code" href="structSERec.html#m3">action</a>, seRec-&gt;<a class="code" href="structSERec.html#s5s2">VERB_LEN</a> );
00126         seInfo-&gt;<a class="code" href="structSEInfo.html#m2">action</a>[seInfo-&gt;<a class="code" href="structSEInfo.html#s2s0">VERB_LEN</a>] = <span class="charliteral">'\0'</span>;
00127         m.rtrim( seInfo-&gt;<a class="code" href="structSEInfo.html#m2">action</a> );
00128 
00129         <span class="comment">// --------- copy object ---------//</span>
00130         <span class="keywordflow">if</span>( seRec-&gt;<a class="code" href="structSERec.html#m4">object_type</a> == <span class="charliteral">' '</span> || seRec-&gt;<a class="code" href="structSERec.html#m4">object_type</a> == <span class="charliteral">'\0'</span>) {
00131             seInfo-&gt;<a class="code" href="structSEInfo.html#m3">object_type</a> = 0;
00132             seInfo-&gt;<a class="code" href="structSEInfo.html#m4">object_id</a> = 0;
00133         }
00134         <span class="keywordflow">else</span> <span class="keywordflow">if</span>( seRec-&gt;<a class="code" href="structSERec.html#m4">object_type</a> == <span class="charliteral">'*'</span> ) {
00135             seInfo-&gt;<a class="code" href="structSEInfo.html#m3">object_type</a> = -1;                   <span class="comment">// all object</span>
00136             seInfo-&gt;<a class="code" href="structSEInfo.html#m4">object_id</a> = -1;
00137         }
00138         <span class="keywordflow">else</span> {
00139             seInfo-&gt;<a class="code" href="structSEInfo.html#m3">object_type</a> = seRec-&gt;<a class="code" href="structSERec.html#m4">object_type</a>;
00140             <span class="keywordflow">if</span>( seRec-&gt;<a class="code" href="structSERec.html#m5">object_id</a>[0] != <span class="charliteral">'*'</span> )
00141                 seInfo-&gt;<a class="code" href="structSEInfo.html#m4">object_id</a> = m.atoi(seRec-&gt;<a class="code" href="structSERec.html#m5">object_id</a>, seRec-&gt;<a class="code" href="structSERec.html#s5s0">RECNO_LEN</a>);
00142             <span class="keywordflow">else</span>
00143                 seInfo-&gt;<a class="code" href="structSEInfo.html#m4">object_id</a> = -1;                   <span class="comment">// all of the objectType</span>
00144         }
00145 
00146         <span class="comment">// -------- copy out frame ---------//</span>
00147         seInfo-&gt;<a class="code" href="structSEInfo.html#m5">out_frame</a> = m.atoi(seRec-&gt;<a class="code" href="structSERec.html#m6">out_frame</a>, seRec-&gt;<a class="code" href="structSERec.html#s5s3">OUT_FRAME_LEN</a>);
00148         <a class="code" href="ALL_8H.html#a0">err_when</a>(seInfo-&gt;<a class="code" href="structSEInfo.html#m5">out_frame</a> &lt;= 0);
00149 
00150         <span class="comment">// -------- copy file name --------//</span>
00151         memcpy(seInfo-&gt;<a class="code" href="structSEInfo.html#m6">file_name</a>, seRec-&gt;<a class="code" href="structSERec.html#m7">file_name</a>, seRec-&gt;<a class="code" href="structSERec.html#s5s4">FILE_NAME_LEN</a>);
00152         seInfo-&gt;<a class="code" href="structSEInfo.html#m6">file_name</a>[seInfo-&gt;<a class="code" href="structSEInfo.html#s2s1">FILE_NAME_LEN</a>] = <span class="charliteral">'\0'</span>;
00153         m.rtrim(seInfo-&gt;<a class="code" href="structSEInfo.html#m6">file_name</a>);
00154         seInfo-&gt;<a class="code" href="structSEInfo.html#m7">effect_id</a> = 0;
00155     }
00156 }
00157 
00158 <span class="comment">// --------- end of function SERes::load_info ----------//</span>
00159 
00160 <span class="comment">// --------- begin of function SERes::sort_info --------//</span>
00161 <span class="keyword">static</span> <span class="keywordtype">int</span> seinfo_cmp(<span class="keyword">const</span> <span class="keywordtype">void</span> *r1, <span class="keyword">const</span> <span class="keywordtype">void</span> *r2) {
00162     <span class="keywordflow">return</span> memcmp(r1, r2, <span class="keyword">sizeof</span>(<a class="code" href="structSEInfo.html">SEInfo</a>));
00163 }
00164 
00165 <span class="keywordtype">void</span> SERes::sort_info() {
00166     <span class="comment">// notice object_id -1 are put after any other object_id</span>
00167     qsort(<a class="code" href="classSERes.html#m3">se_array</a>, <a class="code" href="classSERes.html#m2">se_array_count</a>, <span class="keyword">sizeof</span>(<a class="code" href="structSEInfo.html">SEInfo</a>), seinfo_cmp);
00168 }
00169 
00170 <span class="comment">// --------- end of function SERes::sort_info --------//</span>
00171 
00172 <span class="comment">// --------- begin of function SERes::build_index -------//</span>
00173 <span class="comment">// build index on (subject_type, subject_id)</span>
00174 <span class="keywordtype">void</span> SERes::build_index() {
00175     <span class="comment">// ---------- first pass, count the size of index ---------//</span>
00176 
00177     <span class="keywordtype">int</span> i,j,k;
00178     <a class="code" href="structSEInfo.html">SEInfo</a> *seInfo;
00179     <span class="keywordtype">char</span> lastType = -1;
00180     <span class="keywordtype">short</span> lastId;
00181 
00182     <a class="code" href="classSERes.html#m6">type_index_count</a> = 0;
00183     <a class="code" href="classSERes.html#m4">se_index_count</a> = 0;
00184 
00185     <span class="keywordflow">for</span>(i = 0, seInfo = <a class="code" href="classSERes.html#m3">se_array</a>; i &lt; <a class="code" href="classSERes.html#m2">se_array_count</a>; ++i, ++seInfo) {
00186         <span class="keywordflow">if</span>( lastType != seInfo-&gt;<a class="code" href="structSEInfo.html#m0">subject_type</a>) {
00187             <a class="code" href="classSERes.html#m6">type_index_count</a>++;
00188             <a class="code" href="classSERes.html#m4">se_index_count</a>++;
00189             lastType = seInfo-&gt;<a class="code" href="structSEInfo.html#m0">subject_type</a>;
00190             lastId = seInfo-&gt;<a class="code" href="structSEInfo.html#m1">subject_id</a>;
00191         }
00192         <span class="keywordflow">else</span> <span class="keywordflow">if</span>( lastId != seInfo-&gt;<a class="code" href="structSEInfo.html#m1">subject_id</a>) {
00193             <a class="code" href="classSERes.html#m4">se_index_count</a>++;
00194             lastId = seInfo-&gt;<a class="code" href="structSEInfo.html#m1">subject_id</a>;
00195         }
00196     }
00197 
00198     <span class="comment">// --------- allocate memory for index ----------//</span>
00199 
00200     <a class="code" href="structSEInfoIndex.html">SEInfoIndex</a> *seIndex = <a class="code" href="classSERes.html#m5">se_index_array</a> = (<a class="code" href="structSEInfoIndex.html">SEInfoIndex</a> *)
00201         <a class="code" href="ALL_8H.html#a7">mem_resize</a>( se_index_array, <span class="keyword">sizeof</span>(<a class="code" href="structSEInfoIndex.html">SEInfoIndex</a>) * <a class="code" href="classSERes.html#m4">se_index_count</a>);
00202     memset( se_index_array, 0, <span class="keyword">sizeof</span>(<a class="code" href="structSEInfoIndex.html">SEInfoIndex</a>) * <a class="code" href="classSERes.html#m4">se_index_count</a>);
00203 
00204     <a class="code" href="structSETypeIndex.html">SETypeIndex</a> *typeIndex = <a class="code" href="classSERes.html#m7">type_index_array</a> = (<a class="code" href="structSETypeIndex.html">SETypeIndex</a> *)
00205         <a class="code" href="ALL_8H.html#a7">mem_resize</a>( type_index_array, <span class="keyword">sizeof</span>(<a class="code" href="structSETypeIndex.html">SETypeIndex</a>) * <a class="code" href="classSERes.html#m6">type_index_count</a>);
00206     memset( type_index_array, 0, <span class="keyword">sizeof</span>(<a class="code" href="structSETypeIndex.html">SETypeIndex</a>) * <a class="code" href="classSERes.html#m6">type_index_count</a>);
00207 
00208     <span class="comment">// ---------- pass 2, build indices -----------//</span>
00209     seIndex--;                                      <span class="comment">// move one step backward</span>
00210     typeIndex--;
00211     j = -1;
00212     k = -1;
00213     lastType = -1;
00214     <span class="keywordflow">for</span>(i = 0, seInfo = <a class="code" href="classSERes.html#m3">se_array</a>; i &lt; <a class="code" href="classSERes.html#m2">se_array_count</a>; ++i, ++seInfo) {
00215         <span class="keywordflow">if</span>( lastType != seInfo-&gt;<a class="code" href="structSEInfo.html#m0">subject_type</a>) {
00216             <span class="comment">// ----------- new (type,Id) ---------//</span>
00217             ++seIndex;
00218             ++j;
00219             seIndex-&gt;<a class="code" href="structSEInfoIndex.html#m0">subject_type</a> = seInfo-&gt;<a class="code" href="structSEInfo.html#m0">subject_type</a>;
00220             seIndex-&gt;<a class="code" href="structSEInfoIndex.html#m2">subject_id</a> = seInfo-&gt;<a class="code" href="structSEInfo.html#m1">subject_id</a>;
00221             seIndex-&gt;<a class="code" href="structSEInfoIndex.html#m3">start_rec</a> = seIndex-&gt;<a class="code" href="structSEInfoIndex.html#m4">end_rec</a> = i;
00222 
00223             <span class="comment">// ----------- new type ---------//</span>
00224             ++typeIndex;
00225             ++k;
00226             typeIndex-&gt;<a class="code" href="structSETypeIndex.html#m0">subject_type</a> = seInfo-&gt;<a class="code" href="structSEInfo.html#m0">subject_type</a>;
00227             typeIndex-&gt;<a class="code" href="structSETypeIndex.html#m2">start_rec</a> = typeIndex-&gt;<a class="code" href="structSETypeIndex.html#m3">end_rec</a> = j;
00228 
00229             lastType = seInfo-&gt;<a class="code" href="structSEInfo.html#m0">subject_type</a>;
00230             lastId = seInfo-&gt;<a class="code" href="structSEInfo.html#m1">subject_id</a>;
00231         }
00232         <span class="keywordflow">else</span> {
00233             <a class="code" href="ALL_8H.html#a0">err_when</a>(typeIndex &lt; type_index_array);     <span class="comment">// must not enter here for the first time</span>
00234 
00235             <span class="keywordflow">if</span>( lastId != seInfo-&gt;<a class="code" href="structSEInfo.html#m1">subject_id</a>) {
00236                 <span class="comment">// ----------- new (type,Id) ---------//</span>
00237                 ++seIndex;
00238                 ++j;
00239                 seIndex-&gt;<a class="code" href="structSEInfoIndex.html#m0">subject_type</a> = seInfo-&gt;<a class="code" href="structSEInfo.html#m0">subject_type</a>;
00240                 seIndex-&gt;<a class="code" href="structSEInfoIndex.html#m2">subject_id</a> = seInfo-&gt;<a class="code" href="structSEInfo.html#m1">subject_id</a>;
00241                 seIndex-&gt;<a class="code" href="structSEInfoIndex.html#m3">start_rec</a> = i;
00242                 seIndex-&gt;<a class="code" href="structSEInfoIndex.html#m4">end_rec</a> = i;
00243 
00244                 lastId = seInfo-&gt;<a class="code" href="structSEInfo.html#m1">subject_id</a>;
00245             }
00246             <span class="keywordflow">else</span> {
00247                 <a class="code" href="ALL_8H.html#a0">err_when</a>(seIndex &lt; se_index_array);
00248                 seIndex-&gt;<a class="code" href="structSEInfoIndex.html#m4">end_rec</a> = i;
00249             }
00250             typeIndex-&gt;<a class="code" href="structSETypeIndex.html#m3">end_rec</a> = j;
00251         }
00252     }
00253 }
00254 
00255 <span class="comment">// --------- end of function SERes::build_index -------//</span>
00256 
00257 <span class="comment">// --------- begin of function SERes::scan ----------//</span>
00258 <span class="comment">// search the SEInfo whose subject, action and object match</span>
00259 <span class="comment">// &lt;char&gt; subjectType        type of subject 'S'= sprite,</span>
00260 <span class="comment">//                           'U'=unit, 'R'=race, 'F'=firm, 'T'=town</span>
00261 <span class="comment">// &lt;short&gt; subjectId         sprite_id, unit_id, race_id or firm_id ...</span>
00262 <span class="comment">// &lt;char *&gt; act              name of the action, first four chars are significant</span>
00263 <span class="comment">// [char] objectType         type of object 'S'= sprite,</span>
00264 <span class="comment">//                           'U'=unit, 'R'=race, 'F'=firm, 'T'=town</span>
00265 <span class="comment">//                           default : 0 (none)</span>
00266 <span class="comment">// [short] objectId          sprite_id, unit_id, race_id or firm_id ...</span>
00267 <span class="comment">//                           default : 0 (none)</span>
00268 <span class="comment">//</span>
00269 <span class="comment">// return NULL if not found</span>
00270 <span class="comment">//</span>
<a name="l00271"></a><a class="code" href="classSERes.html#a5">00271</a> <a class="code" href="structSEInfo.html">SEInfo</a>* <a class="code" href="classSERes.html#a5">SERes::scan</a>(<span class="keywordtype">char</span> subjectType, <span class="keywordtype">short</span> subjectId, <span class="keywordtype">char</span> *act,
00272                     <span class="keywordtype">char</span> objectType, <span class="keywordtype">short</span> objectId, <span class="keywordtype">int</span> findFirst) {
00273     <a class="code" href="ALL_8H.html#a0">err_when</a>(!<a class="code" href="classSERes.html#m0">init_flag</a>);
00274 
00275     <span class="keywordtype">int</span> startRec, endRec, i;
00276     <a class="code" href="structSETypeIndex.html">SETypeIndex</a> *typeIndex;
00277     <a class="code" href="structSEInfoIndex.html">SEInfoIndex</a> *seIndex;
00278     <a class="code" href="structSEInfo.html">SEInfo</a> *seInfo;
00279 
00280   <span class="comment">// ---------- search the type_index_array ---------//</span>
00281     <span class="keywordtype">int</span> foundFlag = 0;
00282     <span class="keywordflow">for</span>( i = 0, typeIndex = type_index_array; i &lt; <a class="code" href="classSERes.html#m6">type_index_count</a>; ++i, ++typeIndex) {
00283         <span class="keywordflow">if</span>( subjectType == typeIndex-&gt;<a class="code" href="structSETypeIndex.html#m0">subject_type</a>) {
00284             startRec = typeIndex-&gt;<a class="code" href="structSETypeIndex.html#m2">start_rec</a>;
00285             endRec = typeIndex-&gt;<a class="code" href="structSETypeIndex.html#m3">end_rec</a>;
00286             foundFlag = 1;
00287             <span class="keywordflow">break</span>;
00288         }
00289     }
00290     <span class="keywordflow">if</span>( !foundFlag )
00291         <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00292 
00293   <span class="comment">// ---------- search the se_index_array ---------//</span>
00294     foundFlag = 0;
00295     <span class="keywordflow">for</span>( i = startRec, seIndex = se_index_array + startRec; i &lt;= endRec;
00296          ++i, ++seIndex) {
00297         <span class="keywordflow">if</span>( subjectId == seIndex-&gt;<a class="code" href="structSEInfoIndex.html#m2">subject_id</a> &amp;&amp; subjectType == seIndex-&gt;<a class="code" href="structSEInfoIndex.html#m0">subject_type</a>) {
00298             startRec = seIndex-&gt;<a class="code" href="structSEInfoIndex.html#m3">start_rec</a>;
00299             endRec = seIndex-&gt;<a class="code" href="structSEInfoIndex.html#m4">end_rec</a>;
00300             foundFlag = 1;
00301             <span class="keywordflow">break</span>;
00302         }
00303     }
00304     <span class="keywordflow">if</span>( !foundFlag )                                <span class="comment">// not found</span>
00305         <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00306 
00307   <span class="comment">// ----------- search the se_array ----------//</span>
00308     <span class="keywordflow">for</span>(i = startRec, seInfo = <a class="code" href="classSERes.html#m3">se_array</a> + startRec; i &lt;= endRec;
00309         ++i, ++seInfo) {
00310         <span class="keywordflow">if</span>( seInfo-&gt;<a class="code" href="structSEInfo.html#a0">match</a>(subjectType, subjectId, act, objectType, objectId) )
00311             <span class="keywordflow">break</span>;
00312     }
00313     <span class="keywordflow">if</span>( i &lt;= endRec ) {                             <span class="comment">// found</span>
00314         <span class="keywordflow">if</span>( findFirst )
00315             <span class="keywordflow">return</span> seInfo;
00316         <span class="keywordtype">int</span> found = 1;
00317         <a class="code" href="structSEInfo.html">SEInfo</a> *retSEInfo = seInfo;
00318         <span class="keywordflow">for</span>( ++i, ++seInfo ; i &lt;= endRec &amp;&amp; found &lt;= 4 &amp;&amp;
00319                  seInfo-&gt;<a class="code" href="structSEInfo.html#a0">match</a>(subjectType, subjectId, act, objectType, objectId);
00320              ++i, ++seInfo ) {
00321             ++found;
00322             <span class="keywordflow">if</span>( random(found+1) == 0)
00323                 retSEInfo = seInfo;
00324         }
00325         <span class="keywordflow">return</span> retSEInfo;
00326     }
00327     <span class="keywordflow">return</span> <a class="code" href="OHELP_8H.html#a0">NULL</a>;
00328 }
00329 
00330 <span class="comment">// --------- end of function SERes::scan ----------//</span>
00331 
00332 <span class="comment">// --------- begin of function SERes::scan_id ----------//</span>
<a name="l00333"></a><a class="code" href="classSERes.html#a6">00333</a> <span class="keywordtype">short</span> <a class="code" href="classSERes.html#a6">SERes::scan_id</a>(<span class="keywordtype">char</span> subjectType, <span class="keywordtype">short</span> subjectId, <span class="keywordtype">char</span> *act,
00334                      <span class="keywordtype">char</span> objectType, <span class="keywordtype">short</span> objectId, <span class="keywordtype">int</span> findFirst) {
00335     <a class="code" href="structSEInfo.html">SEInfo</a> *seInfo;
00336     <span class="keywordflow">if</span>( (seInfo = <a class="code" href="classSERes.html#a5">scan</a>(subjectType, subjectId, act, objectType, objectId, findFirst))
00337         != <a class="code" href="OHELP_8H.html#a0">NULL</a>)
00338         <span class="keywordflow">return</span> seInfo-&gt;<a class="code" href="structSEInfo.html#m7">effect_id</a>;
00339     <span class="keywordflow">return</span> 0;
00340 }
00341 
00342 <span class="comment">// --------- end of function SERes::scan_id ----------//</span>
00343 
00344 <span class="comment">// --------- begin of function SERes::operator[] ----------//</span>
<a name="l00345"></a><a class="code" href="classSERes.html#a7">00345</a> <a class="code" href="structSEInfo.html">SEInfo</a>* <a class="code" href="classSERes.html#a7">SERes::operator[] </a>(<span class="keywordtype">int</span> i) {
00346     <a class="code" href="ALL_8H.html#a0">err_when</a>(!<a class="code" href="classSERes.html#m0">init_flag</a> || i &lt;= 0 || i &gt; <a class="code" href="classSERes.html#m2">se_array_count</a>);
00347     <span class="keywordflow">return</span> <a class="code" href="classSERes.html#m3">se_array</a> + i - 1;
00348 }
00349 
00350 <span class="comment">// --------- end of function SERes::operator[] ----------//</span>
00351 
00352 <span class="comment">// --------- begin of function SERes::sound ----------//</span>
<a name="l00353"></a><a class="code" href="classSERes.html#a8">00353</a> <span class="keywordtype">void</span> <a class="code" href="classSERes.html#a8">SERes::sound</a>(<span class="keywordtype">short</span> xLoc, <span class="keywordtype">short</span> yLoc, <span class="keywordtype">short</span> frame,
00354                   <span class="keywordtype">char</span> subjectType,<span class="keywordtype">short</span> subjectId, <span class="keywordtype">char</span> *action, <span class="keywordtype">char</span> objectType,<span class="keywordtype">short</span> objectId) {
00355     <span class="comment">/*</span>
00356 <span class="comment">      //### begin trevor 20/8 ###//</span>
00357 <span class="comment">      if( !config.sound_effect_flag )</span>
00358 <span class="comment">      return;</span>
00359 <span class="comment">      //### end trevor 20/8 ###//</span>
00360 <span class="comment"></span>
00361 <span class="comment">      short relXLoc = xLoc - (world.zoom_matrix-&gt;top_x_loc + world.zoom_matrix-&gt;disp_x_loc/2);</span>
00362 <span class="comment">      short relYLoc = yLoc - (world.zoom_matrix-&gt;top_y_loc + world.zoom_matrix-&gt;disp_y_loc/2);</span>
00363 <span class="comment">      RelVolume relVolume( PosVolume(relXLoc, relYLoc) );</span>
00364 <span class="comment">      if( !config.pan_control )</span>
00365 <span class="comment">      relVolume.ds_pan = 0;</span>
00366 <span class="comment">      SEInfo *seInfo;</span>
00367 <span class="comment"></span>
00368 <span class="comment">      if( relVolume.rel_vol &lt; 5)</span>
00369 <span class="comment">      return;</span>
00370 <span class="comment"></span>
00371 <span class="comment">      if( (seInfo=scan(subjectType, subjectId, action, objectType, objectId))</span>
00372 <span class="comment">      != NULL &amp;&amp; frame == seInfo-&gt;out_frame)</span>
00373 <span class="comment">      {</span>
00374 <span class="comment">      se_output-&gt;request(seInfo-&gt;effect_id, relVolume );</span>
00375 <span class="comment">      }</span>
00376 <span class="comment">    */</span>
00377 }
00378 
00379 <span class="comment">// --------- end of function SERes::sound ----------//</span>
00380 
00381 <span class="comment">// --------- begin of function SERes::far_sound ----------//</span>
00382 <span class="comment">//</span>
00383 <span class="comment">// as same as far_sound, but no cut_off volume</span>
00384 <span class="comment">// usually used in acknowlege voice</span>
00385 <span class="comment">//</span>
<a name="l00386"></a><a class="code" href="classSERes.html#a9">00386</a> <span class="keywordtype">void</span> <a class="code" href="classSERes.html#a9">SERes::far_sound</a>(<span class="keywordtype">short</span> xLoc, <span class="keywordtype">short</span> yLoc, <span class="keywordtype">short</span> frame,
00387                       <span class="keywordtype">char</span> subjectType,<span class="keywordtype">short</span> subjectId, <span class="keywordtype">char</span> *action, <span class="keywordtype">char</span> objectType,<span class="keywordtype">short</span> objectId) {
00388     <span class="comment">/*</span>
00389 <span class="comment">      //### begin trevor 20/8 ###//</span>
00390 <span class="comment">      if( !config.sound_effect_flag )</span>
00391 <span class="comment">      return;</span>
00392 <span class="comment">      //### end trevor 20/8 ###//</span>
00393 <span class="comment"></span>
00394 <span class="comment">      short relXLoc = xLoc - (world.zoom_matrix-&gt;top_x_loc + world.zoom_matrix-&gt;disp_x_loc/2);</span>
00395 <span class="comment">      short relYLoc = yLoc - (world.zoom_matrix-&gt;top_y_loc + world.zoom_matrix-&gt;disp_y_loc/2);</span>
00396 <span class="comment">      RelVolume relVolume( PosVolume(relXLoc, relYLoc), 200, MAX_MAP_WIDTH );</span>
00397 <span class="comment">      if( !config.pan_control )</span>
00398 <span class="comment">      relVolume.ds_pan = 0;</span>
00399 <span class="comment">      SEInfo *seInfo;</span>
00400 <span class="comment"></span>
00401 <span class="comment">      if( relVolume.rel_vol &lt; 80)</span>
00402 <span class="comment">      relVolume.rel_vol = 80;</span>
00403 <span class="comment"></span>
00404 <span class="comment">      if( (seInfo=scan(subjectType, subjectId, action, objectType, objectId))</span>
00405 <span class="comment">      != NULL &amp;&amp; frame == seInfo-&gt;out_frame)</span>
00406 <span class="comment">      {</span>
00407 <span class="comment">      se_output-&gt;request(seInfo-&gt;effect_id, relVolume );</span>
00408 <span class="comment">      }</span>
00409 <span class="comment">    */</span>
00410 }
00411 
00412 <span class="comment">// --------- end of function SERes::far_sound ----------//</span>
00413 
00414 <span class="comment">// --------- begin of function SERes::mark_select_object_time ----------//</span>
<a name="l00415"></a><a class="code" href="classSERes.html#d0">00415</a> <span class="keywordtype">int</span> <a class="code" href="classSERes.html#d0">SERes::mark_select_object_time</a>() {            <span class="comment">// return false if this sound should be skipped due to too frequent</span>
00416     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> t = m.get_time();
00417     <span class="keywordflow">if</span>( t - <a class="code" href="classSERes.html#p0">last_select_time</a> &gt;= <a class="code" href="classSERes.html#p2">select_sound_length</a> ) {
00418         <a class="code" href="classSERes.html#p0">last_select_time</a> = t;
00419         <span class="keywordflow">return</span> 1;
00420     }
00421     <span class="keywordflow">return</span> 0;
00422 }
00423 
00424 <span class="comment">// --------- end of function SERes::mark_select_object_time ----------//</span>
00425 
00426 <span class="comment">// --------- begin of function SERes::mark_select_object_time ----------//</span>
<a name="l00427"></a><a class="code" href="classSERes.html#d1">00427</a> <span class="keywordtype">int</span> <a class="code" href="classSERes.html#d1">SERes::mark_command_time</a>() {                  <span class="comment">// return false if this sound should be skipped due to too frequent</span>
00428     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> t = m.get_time();
00429     <span class="comment">//  if( t - last_command_time &gt;= select_sound_length )</span>
00430     <span class="comment">//  {</span>
00431     <span class="comment">//          last_command_time = t;</span>
00432     <span class="comment">//          return 1;</span>
00433     <span class="comment">//  }</span>
00434     <span class="keywordflow">if</span>( t - <a class="code" href="classSERes.html#p0">last_select_time</a> &gt;= <a class="code" href="classSERes.html#p2">select_sound_length</a> ) {
00435         <a class="code" href="classSERes.html#p0">last_select_time</a> = t;
00436         <span class="keywordflow">return</span> 1;
00437     }
00438     <span class="keywordflow">return</span> 0;
00439 }
00440 
00441 <span class="comment">// --------- end of function SERes::mark_select_object_time ----------//</span>
00442 
00443 <span class="comment">//-------------- Begin Function SERes::random ---------//</span>
00444 <span class="keywordtype">unsigned</span> SERes::random(<span class="keywordtype">unsigned</span> bound) {
00445 <span class="preprocessor">#define MULTIPLIER      0x015a4e35L</span>
00446 <span class="preprocessor"></span><span class="preprocessor">#define INCREMENT       1</span>
00447 <span class="preprocessor"></span>    <a class="code" href="classSERes.html#m8">seed</a> = MULTIPLIER * <a class="code" href="classSERes.html#m8">seed</a> + INCREMENT;
00448     <span class="keywordflow">return</span> <a class="code" href="classSERes.html#m8">seed</a> % bound;
00449 }
00450 
00451 <span class="comment">//-------------- End Function SERes::random ---------//</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Aug 23 01:38:22 2002 for VirtualU by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
